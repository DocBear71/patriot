<!DOCTYPE html>
<html lang='en'>
<head>
    <title>Patriot Thanks: Add a Business</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="author" content="Edward G. McKeown">
    <meta name="date" content="2025/4/12">
    <meta name="description" content="Patriot Thanks application to find businesses that offer
                                          incentives and discounts to veterans, active duty, first
                                          responders, and their spouses.">
    <meta name="keywords" content="business, incentives, discounts, veteran discounts, military discounts,
                                       first responder discounts, veterans, active duty, first responders">
    <link href="./images/docbearlogov4.png" rel="icon" type="image/x-icon">
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="./css/normalize.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">
    <link href="./css/figures.css" rel="stylesheet">
    <link href="./css/menu-auth.css" rel="stylesheet">
    <link href="./css/forms.css" rel="stylesheet">
    <link href="./css/form-validation.css" rel="stylesheet">
    <link href="./css/layout-fix.css" rel="stylesheet">
    <script src="./js/jquery-3.7.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>
    <script src="./js/business-validator.js"></script>
    <script src="./js/reset-functionality.js"></script>
    <script src="./js/layout-manager.js"></script>
</head>
<body style="padding-top: 70px" id="page_layout">
<div id="nav-placeholder"></div>
<header>
    <br>
    <div class="left-banner">
        <a href="index.html">
            <img src="./images/docbearlogov4.png" alt="DocBear logo">
        </a>
    </div>
    <div class="right-banner">
        <h1>Patriot Thanks</h1>
        <hr>
        <h4>Add a Business</h4>
    </div>
    <div style="clear:left;"></div>
</header>
<main>
    <section class="container">
        <h2>Add a business to our database</h2>
        <p class="paragraph_style">In Patriot Thanks, you can add a business within your local
            area that offers discounts and/or incentives for "active duty, veterans, first responders, and their
            spouses." If you know of a business that offers discounts and/or incentives, Please add them here. </p>
    </section>
    <div class="left_pane">
        <form id="business-form" onsubmit="return false;">
            <fieldset>
                <legend>
                    <h3 class="caveat">Business</h3>
                </legend>
                <fieldset>
                    <legend>
                        <h2 class="caveat">Basic Info</h2>
                    </legend>
                    <br>
                    <!-- Chain-related fields -->
                    <input type="hidden" id="chain-id" name="chain_id" />
                    <label for="chain-name">Chain Name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                    <input type="text" id="chain-name" name="chain_name" readonly />
                    <br>
                    <label for="is-chain-location">Is this a Chain Location?&nbsp;&nbsp;&nbsp;</label>
                    <input type="checkbox" id="is-chain-location" name="is_chain_location" />
                    <br>
                    <br>
                    <label for="bname">Business Name</label>
                    <input type="text" id="bname" name="business-name" placeholder="Business name...">
                    <br>
                    <label for="address1">Address Line 1&nbsp;</label>
                    <input type="text" id="address1" name="address1" placeholder="Address Line 1...">
                    <br>
                    <label for="address2">Address Line 2&nbsp;&nbsp;</label>
                    <input type="text" id="address2" name="address2" placeholder="Address Line 2...">
                    <br>
                    <label for="city">City&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                    <input type="text" id="city" name="city" placeholder="Business City is...">
                    <br>
                    <label for="state">U.S. State&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                    <select name="state" id="state">
                        <option value="" selected="selected">Select a State</option>
                        <option value="AL">Alabama</option>
                        <option value="AK">Alaska</option>
                        <option value="AZ">Arizona</option>
                        <option value="AR">Arkansas</option>
                        <option value="CA">California</option>
                        <option value="CO">Colorado</option>
                        <option value="CT">Connecticut</option>
                        <option value="DE">Delaware</option>
                        <option value="DC">District Of Columbia</option>
                        <option value="FL">Florida</option>
                        <option value="GA">Georgia</option>
                        <option value="HI">Hawaii</option>
                        <option value="ID">Idaho</option>
                        <option value="IL">Illinois</option>
                        <option value="IN">Indiana</option>
                        <option value="IA">Iowa</option>
                        <option value="KS">Kansas</option>
                        <option value="KY">Kentucky</option>
                        <option value="LA">Louisiana</option>
                        <option value="ME">Maine</option>
                        <option value="MD">Maryland</option>
                        <option value="MA">Massachusetts</option>
                        <option value="MI">Michigan</option>
                        <option value="MN">Minnesota</option>
                        <option value="MS">Mississippi</option>
                        <option value="MO">Missouri</option>
                        <option value="MT">Montana</option>
                        <option value="NE">Nebraska</option>
                        <option value="NV">Nevada</option>
                        <option value="NH">New Hampshire</option>
                        <option value="NJ">New Jersey</option>
                        <option value="NM">New Mexico</option>
                        <option value="NY">New York</option>
                        <option value="NC">North Carolina</option>
                        <option value="ND">North Dakota</option>
                        <option value="OH">Ohio</option>
                        <option value="OK">Oklahoma</option>
                        <option value="OR">Oregon</option>
                        <option value="PA">Pennsylvania</option>
                        <option value="RI">Rhode Island</option>
                        <option value="SC">South Carolina</option>
                        <option value="SD">South Dakota</option>
                        <option value="TN">Tennessee</option>
                        <option value="TX">Texas</option>
                        <option value="UT">Utah</option>
                        <option value="VT">Vermont</option>
                        <option value="VA">Virginia</option>
                        <option value="WA">Washington</option>
                        <option value="WV">West Virginia</option>
                        <option value="WI">Wisconsin</option>
                        <option value="WY">Wyoming</option>
                    </select>
                    <br>
                    <label for="zip">Zip Code&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                    <input type="text" id="zip" name="zip" placeholder="Business Zip Code...">
                    <br>
                    <label for="phone">Phone #&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                    <input type="text" id="phone" name="phone-number" placeholder="Business phone number...">
                    <br>
                    <label for="type">Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                    <select name="type" id="type">
                        <option value="" selected="selected">Select a Business Type</option>
                        <option value="AUTO">Automotive</option>
                        <option value="BEAU">Beauty</option>
                        <option value="BOOK">Bookstore</option>
                        <option value="CLTH">Clothing</option>
                        <option value="CONV">Convenience Store/Gas Station</option>
                        <option value="DEPT">Department Store</option>
                        <option value="ELEC">Electronics</option>
                        <option value="ENTR">Entertainment</option>
                        <option value="FURN">Furniture</option>
                        <option value="FUEL">Fuel Station/Truck Stop</option>
                        <option value="GIFT">Gift Shop</option>
                        <option value="GROC">Grocery</option>
                        <option value="HARDW">Hardware</option>
                        <option value="HEAL">Health</option>
                        <option value="JEWL">Jewelry</option>
                        <option value="OTHER">Other</option>
                        <option value="RX">Pharmacy</option>
                        <option value="REST">Restaurant</option>
                        <option value="RETAIL">Retail</option>
                        <option value="SERV">Service</option>
                        <option value="SPEC">Specialty</option>
                        <option value="SPRT">Sporting Goods</option>
                        <option value="TECH">Technology</option>
                        <option value="TOYS">Toys</option>
                    </select>
                </fieldset>
                <br>

                <br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <input type="submit" id="submit" value="Submit Business">
            </fieldset>

            <br><br><br>
        </form>
    </div>
    <div class="right_pane">
        <fieldset>
            <legend>
                <h3 class="caveat">Business Support</h3>
            </legend>
            <?xml version="1.0" encoding="UTF-8" standalone="no"?>
            <svg viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
                <!-- Background -->
                <rect x="0" y="0" width="800" height="600" rx="20" ry="20" fill="#f8f8f8" stroke="#002868" stroke-width="8"/>

                <!-- Header Banner -->
                <rect x="20" y="20" width="760" height="100" rx="10" ry="10" fill="#002868"/>
                <text x="400" y="85" font-family="Arial, sans-serif" font-size="40" font-weight="bold" text-anchor="middle" fill="white">WE PROUDLY SUPPORT</text>

                <!-- American Flag Elements - left side -->
                <rect x="40" y="140" width="200" height="150" fill="#002868"/>

                <!-- Stars (simplified) -->
                <g fill="white">
                    <circle cx="63" cy="165" r="10"/>
                    <circle cx="103" cy="165" r="10"/>
                    <circle cx="143" cy="165" r="10"/>
                    <circle cx="183" cy="165" r="10"/>

                    <circle cx="83" cy="195" r="10"/>
                    <circle cx="123" cy="195" r="10"/>
                    <circle cx="163" cy="195" r="10"/>

                    <circle cx="63" cy="225" r="10"/>
                    <circle cx="103" cy="225" r="10"/>
                    <circle cx="143" cy="225" r="10"/>
                    <circle cx="183" cy="225" r="10"/>

                    <circle cx="83" cy="255" r="10"/>
                    <circle cx="123" cy="255" r="10"/>
                    <circle cx="163" cy="255" r="10"/>
                </g>

                <!-- Stripes -->
                <rect x="240" y="140" width="520" height="21.4" fill="#BF0A30"/>
                <rect x="240" y="161.4" width="520" height="21.4" fill="white"/>
                <rect x="240" y="182.8" width="520" height="21.4" fill="#BF0A30"/>
                <rect x="240" y="204.2" width="520" height="21.4" fill="white"/>
                <rect x="240" y="225.6" width="520" height="21.4" fill="#BF0A30"/>
                <rect x="240" y="247" width="520" height="21.4" fill="white"/>
                <rect x="240" y="268.4" width="520" height="21.6" fill="#BF0A30"/>

                <!-- Center Section -->
                <g>
                    <!-- Military Icon - Silhouette of a saluting soldier -->
                    <circle cx="200" cy="380" r="70" fill="#f0f0f0" stroke="#002868" stroke-width="3"/>
                    <path d="M180 350 v-30 h40 v10 l5 -15 h5 v35 h-10 v30 h-10 v20 h-20 v-30 h-10 z" fill="#002868"/>
                    <path d="M202 330 v-15 l8 5 v10 z" fill="#BF0A30"/>

                    <!-- Police/First Responder Icon -->
                    <circle cx="400" cy="380" r="70" fill="#f0f0f0" stroke="#002868" stroke-width="3"/>
                    <path d="M380 340 h40 l10 15 v15 h-60 v-15 z" fill="#002868"/>
                    <rect x="385" y="370" width="30" height="40" fill="#002868"/>
                    <circle cx="400" cy="330" r="15" fill="#002868"/>
                    <path d="M390 340 h20 v5 h-20 z" fill="#BF0A30"/>
                    <path d="M395 345 h10 v5 h-10 z" fill="#BF0A30"/>

                    <!-- EMT/Medical Icon -->
                    <circle cx="600" cy="380" r="70" fill="#f0f0f0" stroke="#002868" stroke-width="3"/>
                    <rect x="575" y="345" width="50" height="10" fill="#BF0A30"/>
                    <rect x="595" y="325" width="10" height="50" fill="#BF0A30"/>
                    <circle cx="600" cy="350" r="35" fill="none" stroke="#002868" stroke-width="5"/>
                </g>

                <!-- Bottom Section -->
                <rect x="20" y="480" width="760" height="100" rx="10" ry="10" fill="#002868"/>

                <!-- Using tspan to break the text into multiple lines -->
                <text x="400" y="525" font-family="Arial, sans-serif" font-size="34" font-weight="bold" text-anchor="middle" fill="white">
                    <tspan x="400" dy="0">MILITARY &amp; FIRST</tspan>
                    <tspan x="400" dy="40">RESPONDER DISCOUNT</tspan>
                </text>

                <!-- Line separators -->
                <line x1="40" y1="310" x2="760" y2="310" stroke="#002868" stroke-width="3"/>
                <line x1="40" y1="450" x2="760" y2="450" stroke="#002868" stroke-width="3"/>
            </svg>
        </fieldset>
        <br><br><br>

    </div>
</main>
<footer class="footer_style">
    <br><br>
    <p>&copy; Copyright 2024 Doc Bear Enterprises, LLC</p>
    <div class="footer-links">
        <a href="terms.html">Terms of Use</a> |
        <a href="privacy.html">Privacy Policy</a> |
        <a href="contact.html">Contact Us</a>
    </div>
    <br><br>
</footer>
<button id="emergencyResetBtn" style="position: fixed; bottom: 10px; right: 10px; z-index: 9999; background-color: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; font-weight: bold; display: none; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
    Emergency Reset
</button>
<script src="./js/bootstrap.bundle.min.js"></script>
<script>
    $(function(){
        $("#nav-placeholder").load("NavBar.html", function() {
            console.log("NavBar loaded");

            // Load terms modal script
            $.getScript("./js/terms-modal.js")
            .done(function() {
                console.log("Terms modal script loaded successfully");

                // Load login handler
                $.getScript("./js/bootstrap5-login-handler.js")
                .done(function() {
                    console.log("Login handler script loaded successfully");

                    // Check login status if function exists
                    setTimeout(function() {
                        if (typeof checkLoginStatus === 'function') {
                            checkLoginStatus();
                        }
                    }, 500);
                });
            });
        });
    });
    document.getElementById('emergencyResetBtn').addEventListener('click', function() {
        console.log("Emergency reset button clicked");
        $('.modal-backdrop').remove();
        $('body').removeClass('modal-open');
        $('body').css('padding-right', '');
        $('.modal').hide();
        $('body').css('overflow', '');
        this.style.display = 'none';
    });
    setTimeout(function() {
        const modalVisible = $('.modal').is(':visible') ||
                $('.modal-backdrop').length > 0 ||
                $('body').hasClass('modal-open');

        if (modalVisible) {
            console.log("Modal appears to be stuck - showing emergency reset button");
            document.getElementById('emergencyResetBtn').style.display = 'block';
        }
    }, 10000);
</script>
<script>
    // Script to prefill business-add form with data from a Google Maps POI
    document.addEventListener('DOMContentLoaded', function() {
        // Check if we have data to prefill the form
        const urlParams = new URLSearchParams(window.location.search);
        const hasAutoChain = urlParams.get('auto_chain') === 'true';
        const hasPrefill = urlParams.get('prefill') === 'true';

        if (urlParams.get('auto_chain') === 'true') {
            // Wait a moment for form to be ready
            setTimeout(handleAutoChainLinking, 500);
        }

        if (hasPrefill) {
            // Handle business data prefill (existing functionality)
            handleBusinessDataPrefill();
        }

        if (hasAutoChain) {
            // Handle automatic chain linking (new functionality)
            setTimeout(handleAutoChainLinking, 500);
        }

        // Setup enhanced form submission
        setupEnhancedFormSubmission();

        const shouldPrefill = urlParams.get('prefill') === 'true';

        if (shouldPrefill) {
            try {
                // Get the business data from sessionStorage
                const businessDataJson = sessionStorage.getItem('newBusinessData');
                if (!businessDataJson) {
                    console.warn("No business data found in sessionStorage");
                    return;
                }

                const businessData = JSON.parse(businessDataJson);
                console.log("Prefilling form with business data:", businessData);

                // Prefill the form fields
                const fields = {
                    'bname': businessData.name || '',
                    'address1': businessData.address1 || '',
                    'city': businessData.city || '',
                    'state': businessData.state || '',
                    'zip': businessData.zip || '',
                    'phone': businessData.phone || ''
                };

                // Set values for each field
                Object.keys(fields).forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.value = fields[fieldId];

                        // Add visual indication that this field was prefilled
                        field.classList.add('prefilled');

                        // Add a small animation to highlight the prefilled fields
                        field.style.transition = 'background-color 1s ease';
                        field.style.backgroundColor = '#f0f8ff'; // Light blue background

                        // After 1.5 seconds, fade back to normal
                        setTimeout(() => {
                            field.style.backgroundColor = '';
                        }, 1500);
                    }
                });

                // Special handling for select elements (like state)
                const stateSelect = document.getElementById('state');
                if (stateSelect && businessData.state) {
                    for (let i = 0; i < stateSelect.options.length; i++) {
                        if (stateSelect.options[i].value === businessData.state) {
                            stateSelect.selectedIndex = i;
                            break;
                        }
                    }
                }

                // Store Place ID in a hidden field if it exists
                if (businessData.placeId) {
                    let placeIdField = document.getElementById('google_place_id');

                    // Create the field if it doesn't exist
                    if (!placeIdField) {
                        placeIdField = document.createElement('input');
                        placeIdField.type = 'hidden';
                        placeIdField.id = 'google_place_id';
                        placeIdField.name = 'google_place_id';

                        // Add it to the form
                        const form = document.querySelector('form');
                        if (form) {
                            form.appendChild(placeIdField);
                        }
                    }

                    // Set the Place ID
                    if (placeIdField) {
                        placeIdField.value = businessData.placeId;
                    }
                }

                // Store lat/lng in hidden fields if they exist
                if (businessData.lat && businessData.lng) {
                    console.log(`Storing coordinates: ${businessData.lat}, ${businessData.lng}`);

                    // Create hidden field for lat
                    let latField = document.getElementById('hidden_lat');
                    if (!latField) {
                        latField = document.createElement('input');
                        latField.type = 'hidden';
                        latField.id = 'hidden_lat';
                        latField.name = 'lat';
                        document.getElementById('business-form').appendChild(latField);
                    }
                    latField.value = businessData.lat;

                    // Create hidden field for lng
                    let lngField = document.getElementById('hidden_lng');
                    if (!lngField) {
                        lngField = document.createElement('input');
                        lngField.type = 'hidden';
                        lngField.id = 'hidden_lng';
                        lngField.name = 'lng';
                        document.getElementById('business-form').appendChild(lngField);
                    }
                    lngField.value = businessData.lng;
                }

                // Add a success message
                const formContainer = document.querySelector('fieldset');
                if (formContainer) {
                    const message = document.createElement('div');
                    message.className = 'success-message';
                    message.innerHTML = `
                    <p>Information from Google Maps has been pre-filled for your convenience.
                    Please review and complete any missing information before submitting.</p>
                `;
                    message.style.backgroundColor = '#dff0d8';
                    message.style.color = '#3c763d';
                    message.style.padding = '10px';
                    message.style.marginBottom = '15px';
                    message.style.borderRadius = '4px';

                    // Insert at the top of the form
                    formContainer.insertBefore(message, formContainer.firstChild);

                    // Remove the message after 8 seconds
                    setTimeout(() => {
                        message.style.transition = 'opacity 1s ease';
                        message.style.opacity = '0';

                        // Remove from DOM after fade out
                        setTimeout(() => {
                            if (message.parentNode) {
                                message.parentNode.removeChild(message);
                            }
                        }, 1000);
                    }, 8000);
                }

                // Clear the sessionStorage data to prevent reuse
                sessionStorage.removeItem('newBusinessData');

            } catch (error) {
                console.error("Error prefilling form:", error);
            }
        }
    });

    /**
     * Handle business data prefill (enhanced version)
     */
    function handleBusinessDataPrefill() {
        console.log("üìù Handling business data prefill...");

        try {
            const businessDataStr = sessionStorage.getItem('newBusinessData');
            if (businessDataStr) {
                const businessData = JSON.parse(businessDataStr);
                console.log("‚úÖ Business data found:", businessData);

                // Fill form fields (adjust field IDs to match your form)
                const fieldMappings = {
                    'bname': businessData.name,
                    'address1': businessData.address1,
                    'city': businessData.city,
                    'state': businessData.state,
                    'zip': businessData.zip,
                    'phone': businessData.phone,
                    'lat': businessData.lat,
                    'lng': businessData.lng
                };

                // ENHANCED: Also handle chain fields if present
                if (businessData.chain_id) {
                    fieldMappings['chain-id'] = businessData.chain_id;
                    fieldMappings['chain-name'] = businessData.chain_name;
                    fieldMappings['is-chain-location'] = true; // checkbox
                }

                // Fill the form fields
                Object.entries(fieldMappings).forEach(([fieldId, value]) => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        if (field.type === 'checkbox') {
                            field.checked = !!value;
                            console.log(`Set ${fieldId} to ${field.checked}`);
                        } else {
                            field.value = value || '';
                            console.log(`Set ${fieldId} to ${value}`);
                        }
                    } else {
                        console.warn(`Field not found: ${fieldId}`);
                    }
                });

                // Clean up session storage
                sessionStorage.removeItem('newBusinessData');
            }
        } catch (error) {
            console.error("‚ùå Error handling business data prefill:", error);
        }
    }

    /**
     * Handle automatic chain linking notification and form setup
     */
    function handleAutoChainLinking() {
        console.log("üîó CHECKING FOR AUTO CHAIN LINKING...");

        try {
            const autoChainData = sessionStorage.getItem('autoChainLinking');
            if (autoChainData) {
                const chainInfo = JSON.parse(autoChainData);
                console.log("‚úÖ Auto chain linking data found:", chainInfo);

                // Set chain fields if they exist in your form
                const chainIdField = document.getElementById('chain-id');
                const chainNameField = document.getElementById('chain-name');
                const isChainLocationField = document.getElementById('is-chain-location');

                if (chainIdField) {
                    chainIdField.value = chainInfo.chainId;
                    console.log(`Set chain ID: ${chainInfo.chainId}`);
                }

                if (chainNameField) {
                    chainNameField.value = chainInfo.chainName;
                    console.log(`Set chain name: ${chainInfo.chainName}`);
                }

                if (isChainLocationField) {
                    isChainLocationField.checked = true;
                    console.log("Set as chain location: true");
                }

                // Show notification to user
                showAutoChainNotification(chainInfo);

                // Clean up session storage
                sessionStorage.removeItem('autoChainLinking');
            }
        } catch (error) {
            console.error("‚ùå Error handling auto chain linking:", error);
        }
    }

    /**
     * Show notification about auto chain linking
     */
    function showAutoChainNotification(chainInfo) {
        const notification = document.createElement('div');
        notification.className = 'auto-chain-notification';
        notification.innerHTML = `
        <div class="notification-content">
            <div class="notification-icon">üîó</div>
            <div class="notification-text">
                <strong>Chain Automatically Detected!</strong>
                <p>This business has been automatically linked to <strong>${chainInfo.chainName}</strong>.</p>
                <p>Chain-wide incentives will automatically apply to this location.</p>
                ${chainInfo.autoDetected ? '<p><em>Chain was automatically detected based on business name.</em></p>' : ''}
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="notification-close">√ó</button>
        </div>
    `;

        // Add styles if not already added
        if (!document.getElementById('auto-chain-notification-styles')) {
            const style = document.createElement('style');
            style.id = 'auto-chain-notification-styles';
            style.textContent = `
            .auto-chain-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                color: white;
                padding: 0;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                max-width: 350px;
                animation: slideInRight 0.5s ease-out;
            }

            .notification-content {
                display: flex;
                align-items: flex-start;
                padding: 16px;
                gap: 12px;
            }

            .notification-icon {
                font-size: 24px;
                flex-shrink: 0;
            }

            .notification-text {
                flex: 1;
            }

            .notification-text strong {
                display: block;
                margin-bottom: 4px;
                font-size: 16px;
            }

            .notification-text p {
                margin: 4px 0;
                font-size: 14px;
                opacity: 0.9;
            }

            .notification-close {
                background: none;
                border: none;
                color: white;
                font-size: 20px;
                cursor: pointer;
                padding: 0;
                width: 24px;
                height: 24px;
                flex-shrink: 0;
            }

            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
            document.head.appendChild(style);
        }

        // Add to page
        document.body.appendChild(notification);

        // Auto-remove after 8 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 8000);
    }

    /**
     * Setup enhanced form submission to ensure chain data is included
     */
    function setupEnhancedFormSubmission() {
        console.log("üìù Setting up enhanced form submission...");

        const form = document.getElementById('business-add-form'); // Adjust ID to match your form
        if (form) {
            form.addEventListener('submit', function(event) {
                console.log("üì§ Enhanced form submission triggered");

                // Add any additional validation or processing here
                const chainIdField = document.getElementById('chain-id');
                const isChainLocationField = document.getElementById('is-chain-location');

                if (chainIdField && chainIdField.value && isChainLocationField) {
                    // Ensure is-chain-location is checked if we have a chain ID
                    if (!isChainLocationField.checked) {
                        isChainLocationField.checked = true;
                        console.log("‚úÖ Auto-checked is-chain-location due to chain ID presence");
                    }
                }

                // Let the normal form submission proceed
                console.log("‚úÖ Enhanced form validation passed, proceeding with submission");
            });
        } else {
            console.warn("‚ö†Ô∏è Business add form not found - adjust form ID in setupEnhancedFormSubmission()");
        }
    }

    /**
     * ENHANCED: Business form submission success handler
     * Call this after successful business addition to update the database properly
     */
    function handleBusinessAddSuccess(newBusinessId, businessData) {
        console.log("üéâ Business add success - checking for chain linking...");

        // If this was a chain location, we might need to add it to the chain's locations
        if (businessData.chain_id && businessData.is_chain_location) {
            console.log(`üîó Adding business ${newBusinessId} to chain ${businessData.chain_id}`);

            // You might want to call your chains API to update the location count
            // or refresh any cached data about the chain
            updateChainLocationCount(businessData.chain_id);
        }

        // Enhanced return URL handling
        const returnUrl = sessionStorage.getItem('returnToSearch');
        if (returnUrl) {
            console.log("üîÑ Returning to search page with success notification");

            // Add success parameters to the return URL
            const url = new URL(returnUrl);
            url.searchParams.set('business_added', 'true');
            url.searchParams.set('business_name', businessData.name || 'New Business');
            url.searchParams.set('business_id', newBusinessId);

            if (businessData.chain_id) {
                url.searchParams.set('chain_linked', 'true');
                url.searchParams.set('chain_name', businessData.chain_name || 'Chain');
            }

            // Clean up session storage
            sessionStorage.removeItem('returnToSearch');

            // Redirect back
            window.location.href = url.toString();
        }
    }

    /**
     * Update chain location count (optional enhancement)
     */
    async function updateChainLocationCount(chainId) {
        try {
            const baseURL = getBaseURL();
            // This would be a new operation you could add to chains.js to refresh location counts
            await fetch(`${baseURL}/api/chains.js?operation=refresh_location_count&chain_id=${chainId}`, {
                method: 'POST'
            });
            console.log(`‚úÖ Chain location count updated for chain ${chainId}`);
        } catch (error) {
            console.warn("‚ö†Ô∏è Could not update chain location count:", error);
            // This is non-critical, so we don't fail the whole process
        }
    }

    /**
     * Get base URL helper (add this if not already present)
     */
    function getBaseURL() {
        return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? `http://${window.location.host}`
                : window.location.origin;
    }


    // Function to handle successful business addition and return to search
    function handleBusinessAddedSuccessfully(businessName, businessId) {
        // Check if we should return to search page
        const returnUrl = sessionStorage.getItem('returnToSearch');

        if (returnUrl) {
            // Clear the return URL from storage
            sessionStorage.removeItem('returnToSearch');
            sessionStorage.removeItem('newBusinessData');

            // Create success message with return info
            const successMessage = `‚úÖ Success! "${businessName}" has been added to the Patriot Thanks database.\n\nYou will now be returned to your search results.`;

            alert(successMessage);

            // Add parameters to the return URL to show success
            const returnUrlWithParams = new URL(returnUrl);
            returnUrlWithParams.searchParams.set('business_added', 'true');
            returnUrlWithParams.searchParams.set('business_name', businessName);
            returnUrlWithParams.searchParams.set('business_id', businessId);

            // Redirect back to search page
            window.location.href = returnUrlWithParams.toString();
        } else {
            // Normal success handling if not returning to search
            alert(`‚úÖ Success! "${businessName}" has been added to the Patriot Thanks database.`);
        }
    }

    /**
     * Enhanced checkForNewlyAddedBusiness function for search page
     * Add this to your business-search page to handle returns from add business
     */
    function checkForNewlyAddedBusiness() {
        // Check URL parameters for a newly added business
        const urlParams = new URLSearchParams(window.location.search);
        const newBusinessAdded = urlParams.get('business_added');
        const businessName = urlParams.get('business_name');
        const businessId = urlParams.get('business_id');

        if (newBusinessAdded === 'true' && businessName) {
            // Show enhanced success message
            showBusinessAddedSuccessMessage(businessName, businessId);

            // Clean up URL parameters
            const cleanUrl = window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);

            // If we have a business name, pre-fill search form and trigger search
            if (businessName) {
                const businessNameField = document.getElementById('bname');
                if (businessNameField) {
                    businessNameField.value = businessName;
                    validateField(businessNameField, isNotEmpty);
                }

                // Automatically trigger search after a short delay
                setTimeout(() => {
                    const searchForm = document.getElementById('business-search-form');
                    if (searchForm) {
                        const submitEvent = new Event('submit', {cancelable: true});
                        searchForm.dispatchEvent(submitEvent);
                    }
                }, 1000); // Give user time to see the success message
            }
        }
    }

    /**
     * Show enhanced success message for newly added business
     * @param {string} businessName - Name of the added business
     * @param {string} businessId - ID of the added business
     */
    function showBusinessAddedSuccessMessage(businessName, businessId) {
        // Create enhanced alert container
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success business-added-alert';
        alertDiv.role = 'alert';
        alertDiv.style.marginBottom = '20px';
        alertDiv.style.animation = 'slideInFromTop 0.6s ease-out';

        // Add alert content with enhanced messaging
        alertDiv.innerHTML = `
        <div class="success-icon">‚úÖ</div>
        <div class="success-content">
            <h4><strong>Business Successfully Added!</strong></h4>
            <p>"<strong>${businessName}</strong>" has been added to the Patriot Thanks database.</p>
            <p>Searching for this business now to show you the updated results...</p>
            <div class="success-actions">
                <button type="button" class="btn btn-sm btn-outline-success" onclick="viewBusinessDetails('${businessId}')">
                    View Business Details
                </button>
                <button type="button" class="close-success-btn" onclick="this.parentElement.parentElement.parentElement.remove()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        </div>
    `;

        // Add enhanced styles
        const style = document.createElement('style');
        style.textContent = `
        .business-added-alert {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #28a745;
            color: #155724;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
            display: flex;
            align-items: flex-start;
            gap: 15px;
            position: relative;
        }

        .success-icon {
            font-size: 24px;
            flex-shrink: 0;
            margin-top: 5px;
        }

        .success-content {
            flex: 1;
        }

        .success-content h4 {
            margin: 0 0 10px 0;
            color: #155724;
            font-size: 18px;
        }

        .success-content p {
            margin: 5px 0;
            line-height: 1.4;
        }

        .success-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .close-success-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: #155724;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .close-success-btn:hover {
            opacity: 1;
        }

        .btn-outline-success {
            color: #28a745;
            border-color: #28a745;
            background: transparent;
            padding: 5px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-outline-success:hover {
            background-color: #28a745;
            color: white;
        }

        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
    `;
        document.head.appendChild(style);

        // Insert alert at the top of the main content
        const mainContent = document.querySelector('main') || document.body;
        const firstChild = mainContent.firstElementChild;
        mainContent.insertBefore(alertDiv, firstChild);

        // Auto-remove after 10 seconds with fade out
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.style.animation = 'fadeOut 0.5s ease-in';
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 500);
            }
        }, 10000);
    }

    function handleAutoChainLinking() {
        console.log("üîó CHECKING FOR AUTO CHAIN LINKING...");

        try {
            const autoChainData = sessionStorage.getItem('autoChainLinking');
            if (autoChainData) {
                const chainInfo = JSON.parse(autoChainData);
                console.log("‚úÖ Auto chain linking data found:", chainInfo);

                // Set chain fields if they exist in your form
                const chainIdField = document.getElementById('chain-id');
                const chainNameField = document.getElementById('chain-name');
                const isChainLocationField = document.getElementById('is-chain-location');

                if (chainIdField) {
                    chainIdField.value = chainInfo.chainId;
                    console.log(`Set chain ID: ${chainInfo.chainId}`);
                }

                if (chainNameField) {
                    chainNameField.value = chainInfo.chainName;
                    console.log(`Set chain name: ${chainInfo.chainName}`);
                }

                if (isChainLocationField) {
                    isChainLocationField.checked = true;
                    console.log("Set as chain location: true");
                }

                // Show notification to user
                showAutoChainNotification(chainInfo);

                // Clean up session storage
                sessionStorage.removeItem('autoChainLinking');
            }
        } catch (error) {
            console.error("‚ùå Error handling auto chain linking:", error);
        }
    }

    /**
     * Show notification about auto chain linking
     */
    function showAutoChainNotification(chainInfo) {
        const notification = document.createElement('div');
        notification.className = 'auto-chain-notification';
        notification.innerHTML = `
        <div class="notification-content">
            <div class="notification-icon">üîó</div>
            <div class="notification-text">
                <strong>Chain Automatically Detected!</strong>
                <p>This business has been automatically linked to <strong>${chainInfo.chainName}</strong>.</p>
                <p>Chain-wide incentives will automatically apply to this location.</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="notification-close">√ó</button>
        </div>
    `;

        // Add styles
        const style = document.createElement('style');
        style.textContent = `
        .auto-chain-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 350px;
            animation: slideInRight 0.5s ease-out;
        }

        .notification-content {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            gap: 12px;
        }

        .notification-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .notification-text {
            flex: 1;
        }

        .notification-text strong {
            display: block;
            margin-bottom: 4px;
            font-size: 16px;
        }

        .notification-text p {
            margin: 4px 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    `;
        document.head.appendChild(style);

        // Add to page
        document.body.appendChild(notification);

        // Auto-remove after 8 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 8000);
    }


    // Export functions for use
    if (typeof window !== 'undefined') {
        window.handleBusinessAddedSuccessfully = handleBusinessAddedSuccessfully;
        window.checkForNewlyAddedBusiness = checkForNewlyAddedBusiness;
        window.showBusinessAddedSuccessMessage = showBusinessAddedSuccessMessage;
    }

    console.log("üìã Enhanced business add/return flow loaded!");

</script>
</body>
</html>