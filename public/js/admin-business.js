document.addEventListener("DOMContentLoaded",(function(){console.log("Admin Business Manager loaded!");let e=[],t=1,n=1,a={search:"",category:"",status:""},o=null,s="create";const i=document.getElementById("business-table-body"),d=document.getElementById("business-search"),r=document.getElementById("category-filter"),c=document.getElementById("status-filter"),l=document.getElementById("reset-filters"),u=document.getElementById("pagination-container"),m=document.getElementById("business-form"),h=document.getElementById("add-business-btn"),p=document.getElementById("save-business-btn"),g=document.getElementById("confirm-action-btn");function y(){try{const e=localStorage.getItem("patriotThanksSession");if(!e)return console.error("No session data found"),null;const t=JSON.parse(e);return t.token?t.token:(console.error("No token found in session data"),null)}catch(e){return console.error("Error retrieving auth token:",e),null}}function f(e,t){console.error("API Error:",e),401!==e.status?"function"==typeof t&&t():window.location.href="/index.html?login=required&redirect="+encodeURIComponent(window.location.pathname)}function b(){document.querySelector(".admin-container").innerHTML='\n            <div class="alert alert-danger" role="alert">\n                <h4 class="alert-heading">Access Denied</h4>\n                <p>You do not have permission to access this page. Only administrators can access the business management.</p>\n                <hr>\n                <p class="mb-0">Please <a href="/index.html">return to the homepage</a> or contact an administrator if you believe this is an error.</p>\n            </div>\n        '}async function E(){try{i&&(i.innerHTML='<tr><td colspan="7" class="text-center">Loading businesses...</td></tr>');const o="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,s=y();if(!s)return void f({status:401});let d=`operation=admin-list-businesses&page=${t}&limit=10`;a.search&&(d+=`&search=${encodeURIComponent(a.search)}`),a.category&&(d+=`&category=${encodeURIComponent(a.category)}`),a.status&&(d+=`&status=${encodeURIComponent(a.status)}`),console.log(`Fetching businesses with query: ${d}`);const r=await fetch(`${o}/api/business.js?${d}`,{method:"GET",headers:{Authorization:`Bearer ${s}`,"Cache-Control":"no-cache"}});if(!r.ok)throw r;const c=await r.json();e=c.businesses||[],n=c.totalPages||1,w(),v()}catch(t){f(t,(()=>{i&&(i.innerHTML='<tr><td colspan="7" class="text-center text-danger">Error loading businesses. Please try again later.</td></tr>'),console.warn("Using mock data for development"),e=[{_id:"1",bname:"Tech Solutions Inc.",address1:"123 Main St",city:"Cedar Rapids",state:"IA",zip:"52404",phone:"319-555-1234",type:"technology",status:"active",created_at:"2024-04-01T00:00:00.000Z"},{_id:"2",bname:"Hometown Diner",address1:"456 Oak Ave",city:"Marion",state:"IA",zip:"52302",phone:"319-555-5678",type:"food",status:"active",created_at:"2024-04-05T00:00:00.000Z"},{_id:"3",bname:"Cedar Medical Center",address1:"789 Health Blvd",city:"Cedar Rapids",state:"IA",zip:"52402",phone:"319-555-9012",type:"healthcare",status:"active",created_at:"2024-04-10T00:00:00.000Z"}],n=1,w(),v()}))}}function w(){i&&(0!==e.length?(i.innerHTML="",e.forEach((e=>{const t=e.address1&&e.city&&e.state?`${e.address1}, ${e.city}, ${e.state}`:"Location not specified",n={AUTO:"Automotive",BEAU:"Beauty",BOOK:"Bookstore",CLTH:"Clothing",CONV:"Convenience Store/Gas Station",DEPT:"Department Store",ELEC:"Electronics",ENTR:"Entertainment",FURN:"Furniture",FUEL:"Fuel Station/Truck Stop",GIFT:"Gift Shop",GROC:"Grocery",HARDW:"Hardware",HEAL:"Health",JEWL:"Jewelry",OTHER:"Other",RX:"Pharmacy",REST:"Restaurant",RETAIL:"Retail",SERV:"Service",SPEC:"Specialty",SPRT:"Sporting Goods",TECH:"Technology",TOYS:"Toys"}[a=e.type]||a;var a;const o=e.created_by?`<span data-user-id="${e.created_by}">User: ${e.created_by}</span>`:"Unknown",s=document.createElement("tr");s.innerHTML=`\n            <td>${e.bname||"N/A"}</td>\n            <td>${t}</td>\n            <td>${n}</td>\n            <td>${e.phone||"N/A"}</td>\n            <td><span class="badge ${"active"===e.status?"badge-success":"badge-secondary"}">\n                                    ${"active"===e.status?"Active":"Inactive"}\n            </span>\n            </td>\n            <td>${o}</td>\n            <td>\n                <div class="action-btns">\n                    <button class="btn btn-sm btn-info edit-business-btn" data-id="${e._id}">Edit</button>\n                    <button class="btn btn-sm btn-danger delete-business-btn" data-id="${e._id}" \n                            data-name="${e.bname||"this business"}">Delete</button>\n                </div>\n            </td>\n        `,i.appendChild(s)})),document.querySelectorAll(".edit-business-btn").forEach((t=>{t.addEventListener("click",(function(){!async function(t){try{const n=e.find((e=>e._id===t));if(!n)return void await async function(e){try{const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,n=y();if(!n)return;const a=await fetch(`${t}/api/business.js?operation=admin-get-business&businessId=${e}`,{method:"GET",headers:{Authorization:`Bearer ${n}`,"Cache-Control":"no-cache"}});if(!a.ok)throw a;const o=(await a.json()).business;if(!o)throw new Error("Business not found");T(),s="edit",document.getElementById("businessModalLabel").textContent="Edit Business",B(o),$("#businessModal").modal("show")}catch(e){f(e,(()=>{L("danger","Error loading business details. Please try again.")}))}}(t);T(),s="edit",document.getElementById("businessModalLabel").textContent="Edit Business",B(n),$("#businessModal").modal("show")}catch(e){console.error("Error editing business:",e),L("danger","Error loading business details. Please try again.")}}(this.getAttribute("data-id"))}))})),document.querySelectorAll(".delete-business-btn").forEach((e=>{e.addEventListener("click",(function(){const e=this.getAttribute("data-id"),t=this.getAttribute("data-name");document.getElementById("confirmation-message").textContent=`Are you sure you want to delete ${t}?`,o=e,$("#confirmationModal").modal("show")}))}))):i.innerHTML='<tr><td colspan="7" class="text-center">No businesses found</td></tr>')}function v(){if(!u)return;if(n<=1)return void(u.innerHTML="");let e="";e+=`\n            <li class="page-item ${1===t?"disabled":""}">\n                <a class="page-link" href="#" data-page="${t-1}" aria-label="Previous">\n                    <span aria-hidden="true">&laquo;</span>\n                </a>\n            </li>\n        `;let a=Math.max(1,t-Math.floor(2.5)),o=Math.min(n,a+5-1);o-a+1<5&&(a=Math.max(1,o-5+1)),a>1&&(e+='<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>',a>2&&(e+='<li class="page-item disabled"><a class="page-link" href="#">...</a></li>'));for(let n=a;n<=o;n++)e+=`<li class="page-item ${n===t?"active":""}"><a class="page-link" href="#" data-page="${n}">${n}</a></li>`;o<n&&(o<n-1&&(e+='<li class="page-item disabled"><a class="page-link" href="#">...</a></li>'),e+=`<li class="page-item"><a class="page-link" href="#" data-page="${n}">${n}</a></li>`),e+=`\n            <li class="page-item ${t===n?"disabled":""}">\n                <a class="page-link" href="#" data-page="${t+1}" aria-label="Next">\n                    <span aria-hidden="true">&raquo;</span>\n                </a>\n            </li>\n        `,u.innerHTML=e,document.querySelectorAll(".page-link").forEach((e=>{e.addEventListener("click",(function(e){e.preventDefault();const a=parseInt(this.getAttribute("data-page"));!isNaN(a)&&a>0&&a<=n&&(t=a,E())}))}))}function B(e){document.getElementById("business-id").value=e._id||"",document.getElementById("bname").value=e.bname||"",document.getElementById("address1").value=e.address1||"",document.getElementById("address2").value=e.address2||"",document.getElementById("city").value=e.city||"",document.getElementById("zip").value=e.zip||"",document.getElementById("phone").value=e.phone||"",I("state",e.state||""),I("type",e.type||""),I("status",e.status||"active")}function I(e,t){const n=document.getElementById(e);if(n)for(let e=0;e<n.options.length;e++)if(n.options[e].value===t){n.selectedIndex=e;break}}function T(){m.reset(),document.getElementById("business-id").value=""}function C(){return{bname:document.getElementById("bname").value,address1:document.getElementById("address1").value,address2:document.getElementById("address2").value,city:document.getElementById("city").value,state:document.getElementById("state").value,zip:document.getElementById("zip").value,phone:document.getElementById("phone").value,type:document.getElementById("type").value,status:document.getElementById("status").value}}function L(e,t){const n=document.createElement("div");n.className=`alert alert-${e} alert-dismissible fade show`,n.role="alert",n.innerHTML=`\n            ${t}\n            <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                <span aria-hidden="true">&times;</span>\n            </button>\n        `;const a=document.querySelector(".admin-container");if(a){const e=a.querySelector(".admin-header");e&&e.nextSibling?a.insertBefore(n,e.nextSibling):a.prepend(n),setTimeout((()=>{n.classList.remove("show"),setTimeout((()=>{n.remove()}),300)}),5e3)}}!async function(){await async function(){try{const e=y();if(!e)return console.error("No auth token found"),window.location.href="/index.html?login=required&redirect="+encodeURIComponent(window.location.pathname),!1;const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin;try{const n=await fetch(`${t}/api/auth.js?operation=verify-token`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Cache-Control":"no-cache"}});if(!n.ok)return 401===n.status?(window.location.href="/index.html?login=required&redirect="+encodeURIComponent(window.location.pathname),!1):confirm("API error encountered. Would you like to bypass admin verification for development purposes?")?(console.warn("DEVELOPMENT MODE: Bypassing admin verification"),!0):(b(),!1);const a=await n.json();return!(!0!==a.isAdmin&&"Admin"!==a.level&&(b(),1))}catch(e){return console.error("Error checking admin status:",e),confirm("API error encountered. Would you like to bypass admin verification for development purposes?")?(console.warn("DEVELOPMENT MODE: Bypassing admin verification"),!0):(b(),!1)}}catch(e){return console.error("Error in admin status check:",e),b(),!1}}()?(console.log("Admin access confirmed"),E(),d?.addEventListener("input",function(e){let t;return function(...n){const a=this;clearTimeout(t),t=setTimeout((()=>e.apply(a,n)),300)}}((function(){a.search=this.value,t=1,E()}))),r?.addEventListener("change",(function(){a.category=this.value,t=1,E()})),c?.addEventListener("change",(function(){a.status=this.value,t=1,E()})),l?.addEventListener("click",(function(){d.value="",r.value="",c.value="",a={search:"",category:"",status:""},t=1,E()})),h?.addEventListener("click",(function(){T(),s="create",document.getElementById("businessModalLabel").textContent="Add New Business",$("#businessModal").modal("show")})),p?.addEventListener("click",(function(){(function(){const e=[];if([{id:"bname",label:"Business Name"},{id:"address1",label:"Address 1"},{id:"city",label:"City"},{id:"state",label:"State"},{id:"zip",label:"Zip Code"},{id:"phone",label:"Phone"},{id:"type",label:"Business Type"},{id:"status",label:"Status"}].forEach((t=>{const n=document.getElementById(t.id);n&&n.value.trim()?n&&n.classList.remove("is-invalid"):(e.push(t.label),n&&n.classList.add("is-invalid"))})),e.length>0)return L("danger",`Please complete the following required fields: ${e.join(", ")}`),!1;const t=document.getElementById("zip"),n=t.value.trim();if(!/^\d{5}(-\d{4})?$/.test(n))return t.classList.add("is-invalid"),L("danger","Please enter a valid Zip Code (12345 or 12345-6789)"),!1;const a=document.getElementById("phone"),o=a.value.trim();return!!/^\d{3}-\d{3}-\d{4}$/.test(o)||(a.classList.add("is-invalid"),L("danger","Please enter a valid Phone Number in format: 123-456-7890"),!1)})()&&("create"===s?async function(){try{const e="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,t=y();if(!t)return;const n=C(),a=await fetch(`${e}/api/business.js?operation=admin-create-business`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json","Cache-Control":"no-cache"},body:JSON.stringify(n)});if(!a.ok)throw a;await a.json(),$("#businessModal").modal("hide"),L("success","Business created successfully!"),E()}catch(e){f(e,(()=>{L("danger","Error creating business. Please try again.")}))}}():async function(){try{const e="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,t=y();if(!t)return;const n=C();n.businessId=document.getElementById("business-id").value;const a=await fetch(`${e}/api/business.js?operation=admin-update-business`,{method:"PUT",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json","Cache-Control":"no-cache"},body:JSON.stringify(n)});if(!a.ok)throw a;await a.json(),$("#businessModal").modal("hide"),L("success","Business updated successfully!"),E()}catch(e){f(e,(()=>{L("danger","Error updating business. Please try again.")}))}}())})),m?.addEventListener("submit",(function(e){e.preventDefault()})),g?.addEventListener("click",(function(){o&&async function(e){try{const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,n=y();if(!n)return;const a=await fetch(`${t}/api/business.js?operation=admin-delete-business`,{method:"DELETE",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json","Cache-Control":"no-cache"},body:JSON.stringify({businessId:e})});if(!a.ok)throw a;await a.json(),$("#confirmationModal").modal("hide"),L("success","Business deleted successfully!"),E()}catch(e){f(e,(()=>{$("#confirmationModal").modal("hide"),L("danger","Error deleting business. Please try again.")}))}}(o)}))):console.error("Admin access denied")}()}));