function checkIfUserIsAdmin(){try{const e=localStorage.getItem("patriotThanksSession");if(!e)return!1;const t=JSON.parse(e);return t.user&&(!0===t.user.isAdmin||"Admin"===t.user.level)}catch(e){return console.error("Error checking admin status:",e),!1}}document.addEventListener("DOMContentLoaded",(function(){console.log("Business Update Handler Loaded!");const e=document.getElementById("business-info-section");e&&(e.style.display="none");const t=document.querySelector('.reset-button, #reset-button, button[type="reset"]');t&&t.addEventListener("click",(function(){!function(){const e=document.getElementById("business-name");e&&(e.value="",e.disabled=!1);const t=document.getElementById("address");t&&(t.value="",t.disabled=!1);const s=document.getElementById("business-search-results");s&&(s.innerHTML="");const n=document.querySelector('#business-search-form input[type="submit"]');n&&(n.disabled=!1,n.style.cursor="pointer");const o=document.getElementById("business-info-section");if(o){o.style.display="none";const e=o.querySelector(".alert.alert-info");e&&e.remove()}document.querySelectorAll("input, select, textarea").forEach((e=>{e.disabled=!1}));const i=document.getElementById("update-submit");i&&(i.style.display="block"),window.selectedBusinessData=null}()}));const s={bname:document.getElementById("bname"),address1:document.getElementById("address1"),city:document.getElementById("city"),state:document.getElementById("state"),zip:document.getElementById("zip"),phone:document.getElementById("phone"),type:document.getElementById("type"),status:document.getElementById("status")},n=document.getElementById("business-update-form");function o(e,t){const s=document.getElementById(e);s?(s.value=t||"",console.log(`Populated ${e} with:`,t)):console.warn(`Field ${e} not found.`)}function i(e,t){const s=document.getElementById(e);if(s){for(let n=0;n<s.options.length;n++)if(s.options[n].value.toLowerCase()===(t||"").toLowerCase())return s.selectedIndex=n,void console.log(`Selected ${t} in ${e}`);console.warn(`Could not find a matching option for ${t} in ${e}`)}else console.warn(`Field ${e} not found.`)}function a(e,t){const s=document.getElementById("status-message");s?(s.innerHTML=t,s.className="alert","error"===e?s.classList.add("alert-danger"):"success"===e&&s.classList.add("alert-success"),s.style.display="block",s.scrollIntoView({behavior:"smooth"}),setTimeout((()=>{s.style.display="none"}),5e3)):alert(t)}function d(e){return""!==e.trim()}function l(e){return/^\d{5}(-\d{4})?$/.test(e)}function c(e){return/^\d{3}-\d{3}-\d{4}$/.test(e)}function u(e,t){e&&(console.log(`Validating ${e.id} with value: ${e.value}`),t(e.value)?(e.classList.remove("invalid-field"),e.classList.add("valid-field"),e.setAttribute("data-valid","true"),console.log(`${e.id} is VALID`)):(e.classList.remove("valid-field"),e.classList.add("invalid-field"),e.setAttribute("data-valid","false"),console.log(`${e.id} is INVALID`)))}n?n.addEventListener("submit",(function(e){if(e.preventDefault(),(window.selectedBusinessData||{}).is_chain&&!checkIfUserIsAdmin())return void a("error","Chain businesses can only be modified by administrators.");const t=[];if(d(s.bname.value)||t.push("Business Name"),d(s.address1.value)||t.push("Address Line 1"),d(s.city.value)||t.push("City"),d(s.state.value)||t.push("State"),l(s.zip.value)||t.push("Zip Code (format: 12345 or 12345-6789)"),c(s.phone.value)||t.push("Phone Number (format: 123-456-7890)"),d(s.type.value)||t.push("Business Type"),d(s.status.value)||t.push("Status"),console.log("Invalid fields:",t),t.length>0)a("error","Please complete the following required fields: "+t.join(", "));else{const e=document.getElementById("selected-business-id").value;if(!e)return void a("error","Business ID is missing. Please select a business first.");const t=window.selectedBusinessData||{},n={businessId:e,bname:s.bname.value,address1:s.address1.value,address2:document.getElementById("address2").value||"",city:s.city.value,state:s.state.value,zip:s.zip.value,phone:s.phone.value,type:s.type.value,status:s.status.value};t.location&&t.location.coordinates&&(n.lng=t.location.coordinates[0],n.lat=t.location.coordinates[1]),console.log("Form data to submit:",n),async function(e){try{if((window.selectedBusinessData||{}).is_chain&&!checkIfUserIsAdmin())return void a("error","Chain businesses can only be modified by administrators.");const t=localStorage.getItem("patriotThanksSession");if(t){const s=JSON.parse(t);s&&s.user&&s.user._id&&(e.updated_by=s.user._id)}const s=document.getElementById("update-submit"),n=s.value;s.value="Updating...",s.disabled=!0;const o=`${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin}/api/business.js?operation=update-business`;console.log("Submitting to API at:",o);const i=function(){try{const e=localStorage.getItem("patriotThanksSession");return e&&JSON.parse(e).token||null}catch(e){return console.error("Error retrieving auth token:",e),null}}(),d={"Content-Type":"application/json; charset=utf-8"};i&&(d.Authorization=`Bearer ${i}`);const l=await fetch(o,{method:"PUT",headers:d,body:JSON.stringify(e)});if(console.log("Response status:",l.status),!l.ok){const e=await l.text();throw console.error("Error response:",e),new Error(`Failed to update business: ${l.status} ${e}`)}const c=await l.json();console.log("Success:",c),a("success","Business updated successfully!"),function(){console.log("Resetting business update form to initial state");const e=document.getElementById("business-info-section");e&&(e.style.display="none"),["bname","address1","address2","city","zip","phone"].forEach((e=>{const t=document.getElementById(e);t&&(t.value="")}));const t=document.getElementById("state");t&&(t.selectedIndex=0);const s=document.getElementById("type");s&&(s.selectedIndex=0);const n=document.getElementById("selected-business-id");n&&(n.value="");const o=document.getElementById("business-name");o&&(o.value="");const i=document.getElementById("address");i&&(i.value="");const a=document.getElementById("business-search-results");a&&(a.innerHTML=""),window.scrollTo(0,0),console.log("Business form reset completed")}(),s.value=n,s.disabled=!1}catch(e){console.error("Error:",e),a("error","Update failed: "+e.message);const t=document.getElementById("update-submit");t&&(t.value="Update Business",t.disabled=!1)}}(n)}})):console.warn("Business update form not found in the DOM"),window.selectBusinessForUpdate=function(t){if(console.log("selectBusinessForUpdate called with: ",t),window.selectedBusinessData=t,t.is_chain&&!checkIfUserIsAdmin()){e&&(e.style.display="block"),a("error","This is a chain business that can only be modified by administrators."),document.querySelectorAll("input, select, textarea").forEach((e=>{e.disabled=!0}));const s=document.getElementById("update-submit");s&&(s.style.display="none");const n=document.createElement("div");return n.className="alert alert-info",n.innerHTML="<strong>View Only:</strong> Chain businesses can only be modified by administrators.",e.prepend(n),o("bname",t.bname),o("address1",t.address1),o("address2",t.address2),o("city",t.city),o("zip",t.zip),o("phone",t.phone),i("state",t.state),i("type",t.type),i("status",t.status||"active"),void e.scrollIntoView({behavior:"smooth"})}e&&(e.style.display="block");const s=document.getElementById("selected-business-id");console.log("Business ID field exists: ",!!s),s&&(s.value=t._id||"",console.log("Setting business ID to:",t._id)),console.log("Business ID field value: ",s.value),o("bname",t.bname),o("address1",t.address1),o("address2",t.address2),o("city",t.city),o("zip",t.zip),o("phone",t.phone),i("state",t.state),i("type",t.type),i("status",t.status||"active"),e.scrollIntoView({behavior:"smooth"})},s.bname&&s.bname.addEventListener("input",(function(){u(this,d)})),s.address1&&s.address1.addEventListener("input",(function(){u(this,d)})),s.city&&s.city.addEventListener("input",(function(){u(this,d)})),s.state&&s.state.addEventListener("change",(function(){u(this,d)})),s.zip&&s.zip.addEventListener("input",(function(){u(this,l)})),s.phone&&s.phone.addEventListener("input",(function(){u(this,c)})),s.type&&s.type.addEventListener("change",(function(){u(this,d)})),s.status&&s.status.addEventListener("change",(function(){u(this,d)})),window.handleBusinessSelection=function(e){"function"==typeof window.selectBusinessForUpdate?window.selectBusinessForUpdate(e):console.error("selectBusinessForUpdate function not found")}}));