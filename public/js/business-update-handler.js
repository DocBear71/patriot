document.addEventListener("DOMContentLoaded",(function(){console.log("Business Update Handler Loaded!");const e=document.getElementById("business-info-section");e&&(e.style.display="none");const t={bname:document.getElementById("bname"),address1:document.getElementById("address1"),city:document.getElementById("city"),state:document.getElementById("state"),zip:document.getElementById("zip"),phone:document.getElementById("phone"),type:document.getElementById("type"),status:document.getElementById("status")},s=document.getElementById("business-update-form");function n(e,t){const s=document.getElementById(e);s?(s.value=t||"",console.log(`Populated ${e} with:`,t)):console.warn(`Field ${e} not found.`)}function o(e,t){const s=document.getElementById(e);if(s){for(let n=0;n<s.options.length;n++)if(s.options[n].value.toLowerCase()===(t||"").toLowerCase())return s.selectedIndex=n,void console.log(`Selected ${t} in ${e}`);console.warn(`Could not find a matching option for ${t} in ${e}`)}else console.warn(`Field ${e} not found.`)}function i(e,t){const s=document.getElementById("status-message");s?(s.innerHTML=t,s.className="alert","error"===e?s.classList.add("alert-danger"):"success"===e&&s.classList.add("alert-success"),s.style.display="block",s.scrollIntoView({behavior:"smooth"}),setTimeout((()=>{s.style.display="none"}),5e3)):alert(t)}function a(e){return""!==e.trim()}function d(e){return/^\d{5}(-\d{4})?$/.test(e)}function l(e){return/^\d{3}-\d{3}-\d{4}$/.test(e)}function u(e,t){e&&(console.log(`Validating ${e.id} with value: ${e.value}`),t(e.value)?(e.classList.remove("invalid-field"),e.classList.add("valid-field"),e.setAttribute("data-valid","true"),console.log(`${e.id} is VALID`)):(e.classList.remove("valid-field"),e.classList.add("invalid-field"),e.setAttribute("data-valid","false"),console.log(`${e.id} is INVALID`)))}s?s.addEventListener("submit",(function(e){e.preventDefault();const s=[];if(a(t.bname.value)||s.push("Business Name"),a(t.address1.value)||s.push("Address Line 1"),a(t.city.value)||s.push("City"),a(t.state.value)||s.push("State"),d(t.zip.value)||s.push("Zip Code (format: 12345 or 12345-6789)"),l(t.phone.value)||s.push("Phone Number (format: 123-456-7890)"),a(t.type.value)||s.push("Business Type"),a(t.status.value)||s.push("Status"),console.log("Invalid fields:",s),s.length>0)i("error","Please complete the following required fields: "+s.join(", "));else{const e=document.getElementById("selected-business-id").value;if(!e)return void i("error","Business ID is missing. Please select a business first.");const s=window.selectedBusinessData||{},n={businessId:e,bname:t.bname.value,address1:t.address1.value,address2:document.getElementById("address2").value||"",city:t.city.value,state:t.state.value,zip:t.zip.value,phone:t.phone.value,type:t.type.value,status:t.status.value};s.location&&s.location.coordinates&&(n.lng=s.location.coordinates[0],n.lat=s.location.coordinates[1]),console.log("Form data to submit:",n),async function(e){try{const t=localStorage.getItem("patriotThanksSession");if(t){const s=JSON.parse(t);s&&s.user&&s.user._id&&(e.updated_by=s.user._id)}const s=document.getElementById("update-submit"),n=s.value;s.value="Updating...",s.disabled=!0;const o=`${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin}/api/business.js?operation=admin-update-business`;console.log("Submitting to API at:",o);const a=function(){try{const e=localStorage.getItem("patriotThanksSession");return e&&JSON.parse(e).token||null}catch(e){return console.error("Error retrieving auth token:",e),null}}(),d={"Content-Type":"application/json; charset=utf-8"};a&&(d.Authorization=`Bearer ${a}`);const l=await fetch(o,{method:"PUT",headers:d,body:JSON.stringify(e)});if(console.log("Response status:",l.status),!l.ok){const e=await l.text();throw console.error("Error response:",e),new Error(`Failed to update business: ${l.status} ${e}`)}const u=await l.json();console.log("Success:",u),i("success","Business updated successfully!"),function(){console.log("Resetting business update form to initial state");const e=document.getElementById("business-info-section");e&&(e.style.display="none"),["bname","address1","address2","city","zip","phone"].forEach((e=>{const t=document.getElementById(e);t&&(t.value="")}));const t=document.getElementById("state");t&&(t.selectedIndex=0);const s=document.getElementById("type");s&&(s.selectedIndex=0);const n=document.getElementById("selected-business-id");n&&(n.value="");const o=document.getElementById("business-name");o&&(o.value="");const i=document.getElementById("address");i&&(i.value="");const a=document.getElementById("business-search-results");a&&(a.innerHTML=""),window.scrollTo(0,0),console.log("Business form reset completed")}(),s.value=n,s.disabled=!1}catch(e){console.error("Error:",e),i("error","Update failed: "+e.message);const t=document.getElementById("update-submit");t&&(t.value="Update Business",t.disabled=!1)}}(n)}})):console.warn("Business update form not found in the DOM"),window.selectBusinessForUpdate=function(t){console.log("selectBusinessForUpdate called with: ",t),window.selectedBusinessData=t,e&&(e.style.display="block");const s=document.getElementById("selected-business-id");console.log("Business ID field exists: ",!!s),s&&(s.value=t._id||"",console.log("Setting business ID to:",t._id)),console.log("Business ID field value: ",s.value),n("bname",t.bname),n("address1",t.address1),n("address2",t.address2),n("city",t.city),n("zip",t.zip),n("phone",t.phone),o("state",t.state),o("type",t.type),o("status",t.status||"active"),e.scrollIntoView({behavior:"smooth"})},t.bname&&t.bname.addEventListener("input",(function(){u(this,a)})),t.address1&&t.address1.addEventListener("input",(function(){u(this,a)})),t.city&&t.city.addEventListener("input",(function(){u(this,a)})),t.state&&t.state.addEventListener("change",(function(){u(this,a)})),t.zip&&t.zip.addEventListener("input",(function(){u(this,d)})),t.phone&&t.phone.addEventListener("input",(function(){u(this,l)})),t.type&&t.type.addEventListener("change",(function(){u(this,a)})),t.status&&t.status.addEventListener("change",(function(){u(this,a)})),window.handleBusinessSelection=function(e){"function"==typeof window.selectBusinessForUpdate?window.selectBusinessForUpdate(e):console.error("selectBusinessForUpdate function not found")}}));