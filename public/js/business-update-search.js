function initUpdateBusinessSearch(){console.log("Initializing update business search...");const e={businessName:document.getElementById("business-name"),address:document.getElementById("address")},s=document.getElementById("business-search-form");s?s.addEventListener("submit",(async function(s){if(s.preventDefault(),!e.businessName?.value&&!e.address?.value)return void alert("Please enter either a business name or an address to search");const t={businessName:e.businessName?.value||"",address:e.address?.value||""};console.log("Update search form data:",t),await performUpdateBusinessSearch(t)})):console.warn("Business search form not found in the DOM"),e.businessName&&e.businessName.addEventListener("input",(function(){validateUpdateField(this,isNotEmpty)})),e.address&&e.address.addEventListener("input",(function(){validateUpdateField(this,isNotEmpty)}))}async function performUpdateBusinessSearch(e){try{console.log("Performing update business search:",e),showUpdateLoadingIndicator();const s=await searchDatabaseForUpdate(e);console.log(`Found ${s.length} businesses for update`),displayUpdateSearchResults(s)}catch(e){console.error("Error in update business search:",e),hideUpdateLoadingIndicator(),showUpdateErrorMessage("Error searching for businesses: "+e.message)}}async function searchDatabaseForUpdate(e){try{const s=getUpdateBaseURL(),t=new URLSearchParams;t.append("operation","search"),e.businessName&&""!==e.businessName.trim()&&t.append("business_name",e.businessName),e.address&&""!==e.address.trim()&&t.append("address",e.address);const n=`${s}/api/business.js?${t.toString()}`;console.log("Update search API URL:",n);const a=await fetch(n,{method:"GET",headers:{"Content-Type":"application/json; charset=UTF-8"}});if(!a.ok)throw new Error(`Database search failed: ${a.status}`);const o=(await a.json()).results||[],i=o.filter((e=>!0!==e.is_chain||(console.log(`Filtering out parent chain business: ${e.bname}`),!1)));return console.log(`Filtered ${o.length} raw results to ${i.length} updatable businesses`),i}catch(e){throw console.error("Error searching database for update:",e),e}}function displayUpdateSearchResults(e){try{console.log(`Displaying ${e.length} businesses for update`),hideUpdateLoadingIndicator();const s=document.getElementById("business-search-results");if(!s)return console.error("Results container not found"),void showUpdateErrorMessage("Results container not found. Please refresh the page.");if(s.innerHTML="",0===e.length)return s.innerHTML='\n                <div class="no-results-message">\n                    <h3>No businesses found</h3>\n                    <p>No businesses match your search criteria. Please try different search terms.</p>\n                </div>\n            ',void(s.style.display="block");const t=createUpdateResultsTable(e);s.innerHTML=t,s.style.display="block",s.scrollIntoView({behavior:"smooth"}),console.log("Update search results displayed successfully")}catch(e){console.error("Error displaying update search results:",e),showUpdateErrorMessage("Error displaying search results: "+e.message)}}function createUpdateResultsTable(e){let s=`\n        <div class="update-results-container">\n            <h3>Search Results (${e.length} businesses found)</h3>\n            <div class="results-table-container">\n                <table class="results-table">\n                    <thead>\n                        <tr>\n                            <th>Business Name</th>\n                            <th>Address</th>\n                            <th>Type</th>\n                            <th>Status</th>\n                            <th>Action</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n    `;return e.forEach((e=>{let t="";e.address1&&(t=e.address1,e.address2&&(t+=", "+e.address2),e.city&&(t+=", "+e.city),e.state&&(t+=", "+e.state),e.zip&&(t+=" "+e.zip));const n=getUpdateBusinessTypeLabel(e.type),a=e.status||"active",o="active"===a?"status-active":"status-inactive",i=e.chain_id?'<span class="chain-badge-small">Chain Location</span>':"";s+=`\n            <tr class="business-result-row">\n                <td class="business-name-cell">\n                    ${e.bname} ${i}\n                </td>\n                <td class="address-cell">${t}</td>\n                <td class="type-cell">${n}</td>\n                <td class="status-cell">\n                    <span class="status-badge ${o}">${a}</span>\n                </td>\n                <td class="action-cell">\n                    <button class="select-business-btn" onclick="window.selectBusinessForUpdate('${e._id}', '${escapeHtml(e.bname)}')">\n                        Select for Update\n                    </button>\n                </td>\n            </tr>\n        `})),s+="\n                    </tbody>\n                </table>\n            </div>\n        </div>\n    ",s}function populateUpdateForm(e){console.log("Populating update form with:",e);try{window.selectedBusinessData=e;const s=document.getElementById("business-info-section");s&&(s.style.display="block");const t=document.getElementById("selected-business-id");t&&(t.value=e._id||"",console.log("Setting business ID to:",e._id)),populateUpdateField("bname",e.bname),populateUpdateField("address1",e.address1),populateUpdateField("address2",e.address2),populateUpdateField("city",e.city),populateUpdateField("zip",e.zip),populateUpdateField("phone",e.phone),populateUpdateSelectField("state",e.state),populateUpdateSelectField("type",e.type),populateUpdateSelectField("status",e.status||"active"),s&&s.scrollIntoView({behavior:"smooth"}),console.log("Update form populated successfully")}catch(e){console.error("Error populating update form:",e),alert("Error preparing update form: "+e.message)}}function populateUpdateField(e,s){const t=document.getElementById(e);t?(t.value=s||"",console.log(`Populated ${e} with:`,s)):console.warn(`Field ${e} not found.`)}function populateUpdateSelectField(e,s){const t=document.getElementById(e);if(t){for(let n=0;n<t.options.length;n++)if(t.options[n].value.toLowerCase()===(s||"").toLowerCase())return t.selectedIndex=n,void console.log(`Selected ${s} in ${e}`);console.warn(`Could not find a matching option for ${s} in ${e}`)}else console.warn(`Field ${e} not found.`)}async function fetchBusinessDetailsForUpdate(e){try{const s=`${getUpdateBaseURL()}/api/business.js?operation=get&id=${e}`;console.log("Fetching business details:",s);const t=await fetch(s);if(!t.ok)throw new Error(`Failed to fetch business details: ${t.status}`);const n=await t.json();if(n.result)return n.result;throw new Error("Business details not found")}catch(e){throw console.error("Error fetching business details:",e),e}}function getUpdateBaseURL(){return"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin}function getUpdateBusinessTypeLabel(e){return{AUTO:"Automotive",BEAU:"Beauty",BOOK:"Bookstore",CLTH:"Clothing",CONV:"Convenience Store/Gas Station",DEPT:"Department Store",ELEC:"Electronics",ENTR:"Entertainment",FURN:"Furniture",FUEL:"Fuel Station/Truck Stop",GIFT:"Gift Shop",GROC:"Grocery",HARDW:"Hardware",HEAL:"Health",JEWL:"Jewelry",OTHER:"Other",RX:"Pharmacy",REST:"Restaurant",RETAIL:"Retail",SERV:"Service",SPEC:"Specialty",SPRT:"Sporting Goods",TECH:"Technology",TOYS:"Toys"}[e]||e}function validateUpdateField(e,s){e&&(console.log(`Validating ${e.id} with value: ${e.value}`),s(e.value)?(e.classList.remove("invalid-field"),e.classList.add("valid-field"),e.setAttribute("data-valid","true"),console.log(`${e.id} is VALID`)):(e.classList.remove("valid-field"),e.classList.add("invalid-field"),e.setAttribute("data-valid","false"),console.log(`${e.id} is INVALID`)))}function isNotEmpty(e){return e&&""!==e.trim()}function escapeHtml(e){const s=document.createElement("div");return s.textContent=e,s.innerHTML}function showUpdateLoadingIndicator(e="Searching for businesses..."){const s=document.getElementById("business-search-results");s&&(s.innerHTML=`\n            <div class="update-loading-indicator">\n                <div class="loading-spinner"></div>\n                <div class="loading-text">${e}</div>\n            </div>\n        `,s.style.display="block")}function hideUpdateLoadingIndicator(){const e=document.querySelector(".update-loading-indicator");e&&e.remove()}function showUpdateErrorMessage(e){const s=document.getElementById("business-search-results");s&&(s.innerHTML=`\n            <div class="update-error-message">\n                <h3>Search Error</h3>\n                <p>${e}</p>\n                <button onclick="clearUpdateResults()" class="retry-btn">Try Again</button>\n            </div>\n        `,s.style.display="block")}function clearUpdateResults(){const e=document.getElementById("business-search-results");e&&(e.style.display="none",e.innerHTML="");const s=document.getElementById("business-name"),t=document.getElementById("address");s&&(s.value=""),t&&(t.value="")}document.addEventListener("DOMContentLoaded",(function(){console.log("Business Update Search Handler Loaded!"),initUpdateBusinessSearch()})),window.selectBusinessForUpdate=async function(e,s){console.log("Selecting business for update:",e,s);try{showUpdateLoadingIndicator("Loading business details...");const s=await fetchBusinessDetailsForUpdate(e);if(s){if(console.log("Business details fetched:",s),hideUpdateLoadingIndicator(),"function"!=typeof window.selectBusinessForUpdate)return console.error("selectBusinessForUpdate handler not found"),void alert("Error: Update handler not found. Please refresh the page.");console.log("Calling business update handler with:",s),void 0!==window.selectedBusinessData||document.getElementById("business-info-section")?populateUpdateForm(s):alert("Error: Update form not ready. Please refresh the page.")}else hideUpdateLoadingIndicator(),alert("Error: Could not load business details. Please try again.")}catch(e){console.error("Error selecting business for update:",e),hideUpdateLoadingIndicator(),alert("Error selecting business: "+e.message)}},window.performUpdateBusinessSearch=performUpdateBusinessSearch,window.displayUpdateSearchResults=displayUpdateSearchResults,window.clearUpdateResults=clearUpdateResults;