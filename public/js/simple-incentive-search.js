function initializeSimpleIncentiveSearch(){console.log("Initializing simple incentive search...");const e=document.getElementById("business-search-form");if(!e)return void console.error("Search form not found");e.onsubmit=null;const n=e.cloneNode(!0);e.parentNode.replaceChild(n,e),document.getElementById("business-search-form").addEventListener("submit",handleIncentiveSearch),console.log("Simple incentive search initialized successfully")}async function handleIncentiveSearch(e){e.preventDefault(),console.log("Simple incentive search: Form submitted");const n=document.getElementById("business-name")?.value||"",t=document.getElementById("address")?.value||"";if(!n.trim()&&!t.trim())return void alert("Please enter either a business name or an address to search");const i={businessName:n.trim(),address:t.trim()};console.log("Simple incentive search: Searching with",i);try{showIncentiveLoadingIndicator(),displayIncentiveSearchResults(await performSimpleIncentiveSearch(i))}catch(e){console.error("Simple incentive search error:",e),showIncentiveErrorMessage("Error searching for businesses: "+e.message)}}async function performSimpleIncentiveSearch(e){console.log("Performing simple incentive search...");try{const n=getIncentiveBaseURL(),t=new URLSearchParams;t.append("operation","search"),e.businessName&&t.append("business_name",e.businessName),e.address&&t.append("address",e.address);const i=`${n}/api/business.js?${t.toString()}`;console.log("Simple incentive search API URL:",i);const s=await fetch(i,{method:"GET",headers:{"Content-Type":"application/json; charset=UTF-8"}});if(!s.ok)throw new Error(`Search failed: ${s.status}`);const o=((await s.json()).results||[]).filter((e=>!0!==e.is_chain||(console.log(`Filtering out parent chain: ${e.bname}`),!1)));return console.log(`Simple incentive search: Found ${o.length} businesses`),o}catch(e){throw console.error("Simple incentive search error:",e),e}}function displayIncentiveSearchResults(e){console.log(`Displaying ${e.length} businesses in incentive search results`);const n=document.getElementById("business-search-results");if(!n)return void console.error("Results container not found");if(n.innerHTML="",0===e.length)return n.innerHTML='\n            <div class="incentive-no-results">\n                <h3>No businesses found</h3>\n                <p>No businesses match your search criteria. Please try different search terms.</p>\n            </div>\n        ',void(n.style.display="block");const t=createIncentiveResultsTable(e);n.innerHTML=t,n.style.display="block",n.scrollIntoView({behavior:"smooth"}),console.log("Incentive search results displayed successfully")}function createIncentiveResultsTable(e){let n=`\n        <div class="incentive-results-container">\n            <h3>Search Results (${e.length} found)</h3>\n            <table class="incentive-results-table">\n                <thead>\n                    <tr>\n                        <th>Business Name</th>\n                        <th>Address</th>\n                        <th>Type</th>\n                        <th>Action</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;return e.forEach((e=>{let t="";e.address1&&(t=e.address1,e.address2&&(t+=", "+e.address2),e.city&&(t+=", "+e.city),e.state&&(t+=", "+e.state),e.zip&&(t+=" "+e.zip));const i=getIncentiveBusinessTypeLabel(e.type),s=e.chain_id?'<span class="incentive-chain-badge">Chain</span>':"";let o="";const c=window.location.pathname;c.includes("incentive-view.html")?o=`\n                <button class="incentive-select-btn" onclick="selectBusinessForIncentiveView('${e._id}')">\n                    View Incentives\n                </button>\n            `:c.includes("incentive-add.html")?o=`\n                <button class="incentive-select-btn" onclick="selectBusinessForIncentiveAdd('${e._id}')">\n                    Add Incentive\n                </button>\n            `:c.includes("incentive-update.html")&&(o=`\n                <button class="incentive-select-btn" onclick="selectBusinessForIncentiveUpdate('${e._id}')">\n                    Update Incentives\n                </button>\n            `),n+=`\n            <tr class="incentive-business-row">\n                <td>${e.bname} ${s}</td>\n                <td>${t}</td>\n                <td>${i}</td>\n                <td>${o}</td>\n            </tr>\n        `})),n+="\n                </tbody>\n            </table>\n        </div>\n    ",n}function populateBusinessInfo(e){if(e){console.log("Populating business info with: ",e);try{const n=document.getElementById("business-name-display");n&&(n.textContent=e.bname||"");const t=document.getElementById("business-address-display");if(t){let n=e.address1||"";e.address2&&(n+=", "+e.address2),t.textContent=n}const i=document.getElementById("business-city-state-display");if(i){let n="";e.city&&(n+=e.city),e.state&&(n+=", "+e.state),e.zip&&(n+=" "+e.zip),i.textContent=n}const s=document.getElementById("business-phone-display");s&&(s.textContent=e.phone||"");const o=document.getElementById("business-type-display");o&&(o.textContent=getIncentiveBusinessTypeLabel(e.type)||""),console.log("Business info populated successfully")}catch(e){console.error("Error in populateBusinessInfo",e)}}else console.error("No business data provided to populateBusinessInfo")}function clearSearchResultsAndLoading(){const e=document.getElementById("business-search-results");e&&(e.style.display="none",e.innerHTML="")}async function fetchIncentiveBusinessDetails(e){const n=`${getIncentiveBaseURL()}/api/business.js?operation=get&id=${e}`;console.log("Fetching incentive business details:",n);const t=await fetch(n);if(!t.ok)throw new Error(`Failed to fetch business: ${t.status}`);return(await t.json()).result}function getIncentiveBaseURL(){return"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin}function getIncentiveBusinessTypeLabel(e){return{AUTO:"Automotive",BEAU:"Beauty",BOOK:"Bookstore",CLTH:"Clothing",CONV:"Convenience Store",DEPT:"Department Store",ELEC:"Electronics",ENTR:"Entertainment",FURN:"Furniture",FUEL:"Fuel Station",GIFT:"Gift Shop",GROC:"Grocery",HARDW:"Hardware",HEAL:"Health",JEWL:"Jewelry",OTHER:"Other",RX:"Pharmacy",REST:"Restaurant",RETAIL:"Retail",SERV:"Service",SPEC:"Specialty",SPRT:"Sporting Goods",TECH:"Technology",TOYS:"Toys"}[e]||e}function showIncentiveLoadingIndicator(e="Searching..."){const n=document.getElementById("business-search-results");n&&(n.innerHTML=`\n            <div class="incentive-loading">\n                <div class="incentive-spinner"></div>\n                <div class="incentive-loading-text">${e}</div>\n            </div>\n        `,n.style.display="block")}function hideIncentiveLoadingIndicator(){console.log("Hiding incentive loading indicator")}function showIncentiveErrorMessage(e){const n=document.getElementById("business-search-results");n&&(n.innerHTML=`\n            <div class="incentive-error">\n                <h3>Error</h3>\n                <p>${e}</p>\n                <button onclick="clearIncentiveResults()">Try Again</button>\n            </div>\n        `,n.style.display="block")}function clearIncentiveResults(){const e=document.getElementById("business-search-results");e&&(e.innerHTML="",e.style.display="none");const n=document.getElementById("business-name"),t=document.getElementById("address");n&&(n.value=""),t&&(t.value="")}function fetchBothLocalAndChainIncentives(e,n,t,i){console.log(`Fetching both local and chain incentives for ${t}`);const s=getIncentiveBaseURL(),o=fetch(`${s}/api/combined-api.js?operation=incentives&business_id=${e}`).then((e=>e.json())).catch((e=>(console.error("Error fetching local incentives:",e),{results:[]}))),c=fetch(`${s}/api/chains.js?operation=get_incentives&chain_id=${n}`).then((e=>e.json())).catch((e=>(console.error("Error fetching chain incentives:",e),{incentives:[]})));Promise.all([o,c]).then((([e,n])=>{console.log("Local incentives data:",e),console.log("Chain incentives data:",n),displayCombinedIncentives(e.results||[],n.incentives||[],t,i)})).catch((e=>{console.error("Error fetching combined incentives:",e),i.innerHTML=`<p class="error">Error loading incentives: ${e.message}</p>`}))}function fetchLocalIncentivesOnly(e,n,t){console.log(`Fetching local incentives only for ${n}`);const i=getIncentiveBaseURL();fetch(`${i}/api/combined-api.js?operation=incentives&business_id=${e}`).then((e=>e.json())).then((e=>{console.log("Local incentives data:",e),displayLocalIncentivesOnly(e.results||[],n,t)})).catch((e=>{console.error("Error fetching local incentives:",e),t.innerHTML=`<p class="error">Error loading incentives: ${e.message}</p>`}))}function displayCombinedIncentives(e,n,t,i){console.log(`Displaying combined incentives for ${t}`);let s=`\n        <fieldset id="incentives-section">\n            <legend>\n                <h3 class="caveat">Step 3: View Incentives for ${t}</h3>\n            </legend>\n    `;const o=e&&e.length>0,c=n&&n.length>0;o||c?(s+='\n            <table class="results-table">\n                <thead>\n                    <tr>\n                        <th>Available</th>\n                        <th>Type</th>\n                        <th>Amount</th>\n                        <th>Information</th>\n                        <th>Scope</th>\n                        <th>Date Added</th>\n                    </tr>\n                </thead>\n                <tbody>\n        ',o&&e.forEach((e=>{s+=formatIncentiveRow(e,!1)})),c&&n.forEach((e=>{if(e.is_active){const n={is_available:e.is_active,type:e.type,amount:e.amount,information:e.information,other_description:e.other_description,created_at:e.created_at||(new Date).toISOString(),is_chain_wide:!0};s+=formatIncentiveRow(n,!0)}})),s+="\n                </tbody>\n            </table>\n        "):s+="<p>No incentives found for this business.</p>",s+="</fieldset>",i.innerHTML=s;const a=document.getElementById("incentives-section");a&&a.scrollIntoView({behavior:"smooth"})}function displayLocalIncentivesOnly(e,n,t){console.log(`Displaying local incentives only for ${n}`);let i=`\n        <fieldset id="incentives-section">\n            <legend>\n                <h3 class="caveat">Step 3: View Incentives for ${n}</h3>\n            </legend>\n    `;e&&0!==e.length?(i+='\n            <table class="results-table">\n                <thead>\n                    <tr>\n                        <th>Available</th>\n                        <th>Type</th>\n                        <th>Amount</th>\n                        <th>Information</th>\n                        <th>Date Added</th>\n                    </tr>\n                </thead>\n                <tbody>\n        ',e.forEach((e=>{i+=formatIncentiveRowSimple(e)})),i+="\n                </tbody>\n            </table>\n        "):i+="<p>No incentives found for this business.</p>",i+="</fieldset>",t.innerHTML=i;const s=document.getElementById("incentives-section");s&&s.scrollIntoView({behavior:"smooth"})}function formatIncentiveRow(e,n){const t=new Date(e.created_at).toLocaleDateString(),i=e.is_available?"Yes":"No",s=getIncentiveTypeLabel(e.type),o=e.other_description?`<br><em>(${e.other_description})</em>`:"";let c="N/A";e.is_available&&(c="dollar"===e.discount_type?`$${e.amount.toFixed(2)}`:`${e.amount}%`);const a=n?'<span class="chain-badge">Chain-wide</span>':'<span class="location-badge">Location only</span>';return`\n        <tr>\n            <td>${i}</td>\n            <td>${s}${o}</td>\n            <td>${c}</td>\n            <td>${e.information||""}</td>\n            <td>${a}</td>\n            <td>${t}</td>\n        </tr>\n    `}function formatIncentiveRowSimple(e){const n=new Date(e.created_at).toLocaleDateString(),t=e.is_available?"Yes":"No",i=getIncentiveTypeLabel(e.type),s=e.other_description?`<br><em>(${e.other_description})</em>`:"";let o="N/A";return e.is_available&&(o="dollar"===e.discount_type?`$${e.amount.toFixed(2)}`:`${e.amount}%`),`\n        <tr>\n            <td>${t}</td>\n            <td>${i}${s}</td>\n            <td>${o}</td>\n            <td>${e.information||""}</td>\n            <td>${n}</td>\n        </tr>\n    `}function getIncentiveTypeLabel(e){return{VT:"Veteran",AD:"Active Duty",FR:"First Responder",SP:"Spouse",OT:"Other"}[e]||e}document.addEventListener("DOMContentLoaded",(function(){console.log("Simple Incentive Search Handler Loaded!"),setTimeout((function(){initializeSimpleIncentiveSearch()}),200)})),window.selectBusinessForIncentiveView=async function(e){console.log("Selecting business for incentive view:",e);try{showIncentiveLoadingIndicator("Loading business details...");const n=await fetchIncentiveBusinessDetails(e);n?(console.log("Business details loaded for incentive view"),clearSearchResultsAndLoading(),"function"==typeof window.viewBusinessIncentives&&window.viewBusinessIncentives(n)):(hideIncentiveLoadingIndicator(),alert("Error: Could not load business details."))}catch(e){console.error("Error selecting business for incentive view:",e),hideIncentiveLoadingIndicator(),alert("Error: "+e.message)}},window.selectBusinessForIncentiveAdd=async function(e){console.log("Selecting business for incentive add:",e);try{showIncentiveLoadingIndicator("Loading business details...");const n=await fetchIncentiveBusinessDetails(e);n?(console.log("Business details loaded for incentive add"),clearSearchResultsAndLoading(),window.populateBusinessInfo=populateBusinessInfo,"function"==typeof window.selectBusinessForIncentive&&window.selectBusinessForIncentive(n)):(hideIncentiveLoadingIndicator(),alert("Error: Could not load business details."))}catch(e){console.error("Error selecting business for incentive add:",e),hideIncentiveLoadingIndicator(),alert("Error: "+e.message)}},window.selectBusinessForIncentiveUpdate=async function(e){console.log("Selecting business for incentive update:",e);try{showIncentiveLoadingIndicator("Loading business details...");const n=await fetchIncentiveBusinessDetails(e);n?(console.log("Business details loaded for incentive update"),clearSearchResultsAndLoading(),window.populateBusinessInfo=populateBusinessInfo,"function"==typeof window.selectBusinessForIncentives?window.selectBusinessForIncentives(n):"function"==typeof window.selectBusinessForIncentive&&window.selectBusinessForIncentive(n)):(hideIncentiveLoadingIndicator(),alert("Error: Could not load business details."))}catch(e){console.error("Error selecting business for incentive update:",e),hideIncentiveLoadingIndicator(),alert("Error: "+e.message)}},window.enhancedFetchIncentives=function(e,n,t){console.log("Enhanced fetchIncentives called for:",n,"ID:",e);let i=document.getElementById("incentives-container");if(!i){console.log("Creating incentives container"),i=document.createElement("div"),i.id="incentives-container";const e=document.getElementById("business-info-section");if(e&&e.parentNode)e.parentNode.insertBefore(i,e.nextSibling);else{const e=document.querySelector("main");e?e.appendChild(i):document.body.appendChild(i)}}i.innerHTML="<p>Loading incentives...</p>",console.log(`Fetching incentives for business ID: ${e}`);const s=!(!t||!t.chain_id),o=s?t.chain_id:null;getIncentiveBaseURL(),s&&o?(console.log(`This is a chain location. Chain ID: ${o}`),fetchBothLocalAndChainIncentives(e,o,n,i)):fetchLocalIncentivesOnly(e,n,i)},"function"==typeof window.fetchIncentives&&(window.originalFetchIncentives=window.fetchIncentives),window.fetchIncentives=window.enhancedFetchIncentives;