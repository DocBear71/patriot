let map=null,mapInitialized=!1,markers=[],infoWindow=null,bounds=null,pendingBusinessesToDisplay=[];document.addEventListener("DOMContentLoaded",(function(){let e;console.log("Business search with Google Maps loaded!");let n,s,t=[];const o={businessName:document.getElementById("business-name"),address:document.getElementById("address")},i=document.getElementById("business-search-form");function r(n){return mapInitialized&&e?(console.log("Displaying businesses on map:",n.length),Array.isArray(n)&&0!==n.length?(l(),s=new google.maps.LatLngBounds,void n.forEach(((o,i)=>{!function(n,o,i){if(!n||!n.address1)return void console.error("Invalid business data for geocoding",n);const r=`${n.address1}, ${n.city}, ${n.state} ${n.zip}`,l=new google.maps.Geocoder;setTimeout((()=>{l.geocode({address:r},(function(l,d){if(d===google.maps.GeocoderStatus.OK){if(l[0]){const r=l[0].geometry.location;!function(n,s){const o=new google.maps.Marker({position:s,map:e,title:n.bname,animation:google.maps.Animation.DROP,icon:{url:"https://maps.google.com/mapfiles/ms/icons/red-dot.png",scaledSize:new google.maps.Size(32,32)}});o.business=n,o.addListener("click",(function(){a(this)})),t.push(o)}(n,r),s.extend(r),o===i-1&&(e.fitBounds(s),1===i&&e.setZoom(15),i>=1&&function(n,s){console.log("Searching for nearby businesses near",n.lat(),n.lng());const o="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:"https://patriotthanks.vercel.app";fetch(`${o}/api/business.js?operation=search&type=${s}`).then((e=>{if(!e.ok)throw new Error(`Failed to fetch nearby businesses: ${e.status}`);return e.json()})).then((s=>{if(!s.results||0===s.results.length)return void console.log("No additional nearby businesses found");console.log(`Found ${s.results.length} potential nearby businesses`);const o=t.map((e=>e.business._id)),i=s.results.filter((e=>!o.includes(e._id)));console.log(`${i.length} new businesses to add to map`),i.forEach(((s,o)=>{setTimeout((()=>{!function(n,s){if(!n||!n.address1)return;const o=`${n.address1}, ${n.city}, ${n.state} ${n.zip}`;(new google.maps.Geocoder).geocode({address:o},(function(o,i){if(i===google.maps.GeocoderStatus.OK&&o[0]){const i=o[0].geometry.location;if(google.maps.geometry.spherical.computeDistanceBetween(s,i)<=2e4){const s=new google.maps.Marker({position:i,map:e,title:n.bname,animation:google.maps.Animation.DROP,icon:{url:"https://maps.google.com/mapfiles/ms/icons/blue-dot.png",scaledSize:new google.maps.Size(32,32)}});s.business=n,s.isNearby=!0,s.addListener("click",(function(){a(this)})),t.push(s)}}}))}(s,n)}),200*o)}))})).catch((e=>{console.error("Error searching for nearby businesses:",e)}))}(r,n.type))}}else console.error("Geocode failed for address "+r+": "+d)}))}),200*o)}(o,i,n.length)}))):(console.log("No businesses to display on map"),e.setCenter({lat:39.8283,lng:-98.5795}),void e.setZoom(4))):(console.log("Map not initialized yet. Storing businesses for later display."),void(pendingBusinessesToDisplay=n))}function a(s){if(!s||!s.business)return void console.error("Invalid marker for info window",s);const t=s.business,o=t.address2?`${t.address1}<br>${t.address2}<br>${t.city}, ${t.state} ${t.zip}`:`${t.address1}<br>${t.city}, ${t.state} ${t.zip}`,i=d(t.type),r=t.phone?`<p><strong>Phone:</strong> ${t.phone}</p>`:"",a=`\n            <div class="info-window">\n                <h3>${t.bname}</h3>\n                <p><strong>Address:</strong><br>${o}</p>\n                ${r}\n                <p><strong>Type:</strong> ${i}</p>\n                <div id="info-window-incentives-${t._id}">\n                    <p><strong>Incentives:</strong> <em>Loading...</em></p>\n                </div>\n                <div class="info-window-actions">\n                    <button class="view-details-btn" \n                            onclick="window.viewBusinessDetails('${t._id}')">\n                        View Details\n                    </button>\n                </div>\n            </div>\n        `;n.setContent(a),n.open(e,s),function(e){if(!e)return void console.error("No business ID provided for fetching incentives");const n="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:"https://patriotthanks.vercel.app";fetch(`${n}/api/incentives.js?business_id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to fetch incentives: ${e.status}`);return e.json()})).then((n=>{const s=document.getElementById(`info-window-incentives-${e}`);if(!s)return void console.error(`Could not find incentives div for business ${e}`);if(!n.results||0===n.results.length)return void(s.innerHTML="<p><strong>Incentives:</strong> No incentives found</p>");let t='<p><strong>Incentives:</strong></p><ul class="incentives-list">';n.results.forEach((e=>{if(e.is_available){const n=c(e.type),s=e.other_description?` (${e.other_description})`:"";t+=`\n                            <li>\n                                <strong>${n}${s}:</strong> ${e.amount}%\n                                ${e.information?` - ${e.information}`:""}\n                            </li>\n                        `}})),t+="</ul>",s.innerHTML='<p><strong>Incentives:</strong></p><ul class="incentives-list"></ul>'===t?"<p><strong>Incentives:</strong> No active incentives found</p>":t})).catch((n=>{console.error(`Error fetching incentives for info window: ${n}`);const s=document.getElementById(`info-window-incentives-${e}`);s&&(s.innerHTML="<p><strong>Incentives:</strong> Error loading incentives</p>")}))}(t._id)}function l(){t?(t.forEach((e=>{e&&e.setMap(null)})),t=[]):t=[]}function d(e){return{REST:"Restaurant",GROC:"Grocery",DEPT:"Department Store",CLTH:"Clothing",ELEC:"Electronics",HARDW:"Hardware",FURN:"Furniture",AUTO:"Automotive",SERV:"Service",ENTR:"Entertainment",SPRT:"Sporting Goods",TOYS:"Toys",HEAL:"Health",BEAU:"Beauty",JEWL:"Jewelry",BOOK:"Bookstore",GIFT:"Gift Shop",SPEC:"Specialty",RX:"Pharmacy",RETAIL:"Retail",TECH:"Technology",OTHER:"Other"}[e]||e}function c(e){return{VT:"Veteran",AD:"Active Duty",FR:"First Responder",SP:"Spouse",OT:"Other"}[e]||e}function u(e){console.log("Handling business selection with fallback: ",e);try{const n=document.getElementById("business-info-section");if(!n)return void console.error("business-info-section not found");document.getElementById("selected-business-id")&&(selectedBusinessId=e._id||""),function(e){if(e)try{const n=document.getElementById("bname");n&&(n.value=e.bname||"");const s=document.getElementById("address1");s&&(s.value=e.address1||"");const t=document.getElementById("address2");t&&(t.value=e.address2||"");const o=document.getElementById("city");o&&(o.value=e.city||"");const i=document.getElementById("zip");i&&(i.value=e.zip||"");const r=document.getElementById("phone");r&&(r.value=e.phone||"");const a=document.getElementById("state");if(a){const n=e.state||"";for(let e=0;e<a.options.length;e++)if(a.options[e].value===n){a.selectedIndex=e;break}}const l=document.getElementById("type");if(l){const n=e.type||"";for(let e=0;e<l.options.length;e++)if(l.options[e].value===n){l.selectedIndex=e;break}}console.log("Business info populated successfully")}catch(e){console.error("Error in populateBusinessInfo: "+e)}else console.error("No business data provided to populateBusinessInfo")}(e);const s=document.getElementById("incentive-section");s&&(s.style.display="block"),n.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error in handleBusinessSection: "+e),alert("There was an error selecting the business: "+e.message)}}function p(e){return""!==e.trim()}function m(e,n){console.log(`Validating ${e.id} with value: ${e.value}`),n(e.value)?(e.classList.remove("invalid-field"),e.classList.add("valid-field"),e.setAttribute("data-valid","true"),console.log(`${e.id} is VALID`)):(e.classList.remove("valid-field"),e.classList.add("invalid-field"),e.setAttribute("data-valid","false"),console.log(`${e.id} is INVALID`))}i?i.addEventListener("submit",(function(e){if(e.preventDefault(),p(o.businessName.value)||p(o.address.value)){const e={businessName:o.businessName.value,address:o.address.value};console.log("Form data to submit:",e),mapInitialized||console.warn("Map not initialized yet. Will display businesses after map loads."),l();const n=document.getElementById("initial-map-message");n&&n.remove(),async function(e){try{const n={};e.businessName&&""!==e.businessName.trim()&&(n.business_name=e.businessName),e.address&&""!==e.address.trim()&&(n.address=e.address);const s=new URLSearchParams(n).toString(),t=`${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:"https://patriotthanks.vercel.app"}/api/business.js?operation=search&${s}`;console.log("submitting search to API at: ",t);const o=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json; charset=UTF-8"}});if(console.log("response status: ",o.status),!o.ok){const e=await o.text();throw console.error("Error response: ",e),new Error(`Failed to retrieve data from MongoDB: ${o.status} ${e}`)}const i=await o.json();if(console.log("Search results:",i),!i||!i.results)throw console.error("Invalid response format - missing results property"),new Error("Invalid response format from server");if(document.getElementById("search_table"))!function(e){try{const n=document.getElementById("business_search"),s=document.getElementById("search_table");if(!n||!s)return console.error("Required elements not found in the DOM"),void alert("There was an error displaying search results. Please try again later.");let t=n.querySelector("tbody");if(!t)return console.error("Table body not found within business_search table"),void alert("There was an error displaying search results. Please try again later.");t.innerHTML="",Array.isArray(e)||(console.error("businesses is not an array:",e),e=[]),s.style.display="block";const o=s.querySelector("h5");if(o&&(o.style.display="none"),0===e.length)return t.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria.</td></tr>',void s.scrollIntoView({behavior:"smooth"});e.forEach((e=>{if(!e)return;const n=e.address2?`${e.address1}<br>${e.address2}<br>${e.city}, ${e.state} ${e.zip}`:`${e.address1}<br>${e.city}, ${e.state} ${e.zip}`,s=d(e.type),o=document.createElement("tr"),i=`<button class="view-map-btn" onclick="focusOnMapMarker('${e._id}')">View on Map</button>`;o.innerHTML=`\n                    <th class="left_table" data-business-id="${e._id}">${e.bname}</th>\n                    <th class="left_table">${n}</th>\n                    <th class="left_table">${s}</th>\n                    <th class="right_table" id="incentives-for-${e._id}">Loading incentives...</th>\n                    <th class="center_table">${i}</th>\n                `,t.appendChild(o),function(e){if(!e)return void console.error("No business ID provided for fetching incentives");const n=`${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:"https://patriotthanks.vercel.app"}/api/incentives.js?business_id=${e}`;console.log("Fetching incentives from: ",n),fetch(n).then((e=>{if(!e.ok)throw new Error(`Failed to fetch incentives: ${e.status} ${e.statusText}`);return e.json()})).then((n=>{console.log(`Incentives data for business ${e}:`,n);const s=document.getElementById(`incentives-for-${e}`);if(!s)return void console.error(`Could not find cell for incentives-for-${e}`);if(!n.results||0===n.results.length)return void(s.innerHTML="No incentives found");let t="";n.results.forEach((e=>{if(e.is_available){const n=c(e.type),s=e.other_description?` (${e.other_description})`:"";t+=`\n                            <div class="incentive-item">\n                                <strong>${n}${s}:</strong> ${e.amount}%\n                                <div class="incentive-info">${e.information||""}</div>\n                            </div>\n                        `}})),s.innerHTML=""===t?"No active incentives found":t})).catch((n=>{console.error(`Error fetching incentives for business ${e}:`,n);const s=document.getElementById(`incentives-for-${e}`);s&&(s.innerHTML="Error loading incentives")}))}(e._id)})),s.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error displaying search results: ",e),alert("There was an error displaying the search results: "+e.message)}}(i.results),r(i.results);else{let e=document.getElementById("business-search-results");if(!e){e=document.createElement("div"),e.id="business-search-results";const n=document.querySelector("fieldset");if(n)n.parentNode.insertBefore(e,n.nextSibling);else{const n=document.querySelector("main");n?n.appendChild(e):document.body.appendChild(e)}console.log("Created business-search-results container")}!function(e,n){try{if(n.innerHTML="",Array.isArray(e)||(console.error("businesses is not an array:",e),e=[]),0===e.length)return n.innerHTML='<div class="error">No businesses found matching your search criteria.</div>',void n.scrollIntoView({behavior:"smooth"});const s=document.createElement("table");s.className="results-table";const t={name:"Business Name",address:"Address",city:"City",state:"State",zip:"Zip",action:"Action"},o=document.createElement("thead");o.innerHTML=`\n            <tr>\n                <th>${t.name}</th>\n                <th>${t.address}</th>\n                <th>${t.city}</th>\n                <th>${t.state}</th>\n                <th>${t.zip}</th>\n                <th>${t.action}</th>\n            </tr>\n        `,s.appendChild(o);const i=document.createElement("tbody");if(e.forEach((e=>{if(!e)return;const n=document.createElement("tr");n.innerHTML=`\n                <td data-title="${t.name}">${e.bname}</td>\n                <td data-title="${t.address}">${e.address1}${e.address2?"<br>"+e.address2:""}</td>\n                <td data-title="${t.city}">${e.city}</td>\n                <td data-title="${t.state}">${e.state}</td>\n                <td data-title="${t.zip}">${e.zip}</td>\n                <td data-title="${t.action}"><button class="select-business" data-business-id="${e._id}">Select</button></td>\n            `,i.appendChild(n)})),s.appendChild(i),n.appendChild(s),!document.getElementById("responsive-table-css")){const e=document.createElement("style");e.id="responsive-table-css",e.textContent="\n                /* Base table styles */\n                .results-table {\n                    width: 90%;\n                    margin: 20px auto;\n                    border-collapse: collapse;\n                    text-align: left;\n                }\n                \n                .results-table th, .results-table td {\n                    border: 1px solid #ddd;\n                    padding: 8px;\n                }\n                \n                .results-table th {\n                    background-color: #f2f2f2;\n                    font-weight: bold;\n                    text-align: center;\n                }\n                \n                .results-table tr:nth-child(even) {\n                    background-color: #f9f9f9;\n                }\n                \n                .results-table tr:hover {\n                    background-color: #f1f1f1;\n                }\n                \n                /* Responsive table for small screens */\n                @media only screen and (max-width: 767px) {\n                    .results-table {\n                        width: 100%;\n                        margin: 10px 0;\n                    }\n                    \n                    .results-table, .results-table thead, .results-table tbody, .results-table tr {\n                        display: block;\n                    }\n                    \n                    .results-table thead {\n                        display: none;\n                    }\n                    \n                    .results-table tr {\n                        border: 1px solid #ccc;\n                        margin-bottom: 15px;\n                        padding: 8px;\n                        background-color: #f9f9f9;\n                    }\n                    \n                    .results-table td {\n                        display: block;\n                        border: none;\n                        border-bottom: 1px solid #eee;\n                        padding: 8px;\n                        margin-bottom: 6px;\n                        text-align: left;\n                        position: relative;\n                    }\n                    \n                    .results-table td::before {\n                        content: attr(data-title);\n                        display: block;\n                        font-weight: bold;\n                        margin-bottom: 6px;\n                        color: #333;\n                    }\n                    \n                    /* Ensure buttons are properly displayed */\n                    .select-business {\n                        margin: 8px 0;\n                        display: inline-block;\n                    }\n                }\n            ",document.head.appendChild(e)}document.querySelectorAll(".select-business").forEach((n=>{n.addEventListener("click",(function(){const n=this.getAttribute("data-business-id");if(!n)return void console.error("No business ID found on button");const s=e.find((e=>e._id===n));if(!s)return void console.error("Could not find business with ID: "+n);console.log("Selected business: ",s);const t=window.location.pathname;console.log("Current page: ",t),t.includes("incentive-update.html")?(console.log("On incentive-update page"),"function"==typeof window.selectBusinessForIncentive?window.selectBusinessForIncentive(s):"function"==typeof window.selectBusinessForIncentives?window.selectBusinessForIncentives(s):(console.error("selectBusinessForIncentive(s) not found, falling back"),u(s))):t.includes("business-update.html")?(console.log("On business-update page"),"function"==typeof window.selectBusinessForUpdate?window.selectBusinessForUpdate(s):(console.error("selectBusinessForUpdate not found, falling back"),u(s))):t.includes("incentive-add.html")?(console.log("On incentive-add page"),"function"==typeof window.selectBusinessForIncentive?window.selectBusinessForIncentive(s):u(s)):t.includes("incentive-view.html")||t.endsWith("business-search.html")?(console.log("On incentive-view page"),"function"==typeof window.viewBusinessIncentives?window.viewBusinessIncentives(s):u(s)):(console.error("Using fallback business selection handler"),u(s))}))})),n.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error displaying business search results: "+e);const n=document.getElementById("business-search-results");n?(n.innerHTML=`<div class="error">Error displaying search results: ${e.message}</div>`,n.scrollIntoView({behavior:"smooth"})):alert("Error displaying search results: "+e.message)}}(i.results,e)}}catch(e){let n;if(console.error("Error: ",e),document.getElementById("search_table"))n=document.getElementById("search_table");else if(n=document.getElementById("business-search-results"),!n){n=document.createElement("div"),n.id="business-search-results";const e=document.querySelector("fieldset");e?e.parentNode.insertBefore(n,e.nextSibling):document.body.appendChild(n)}n.innerHTML=`<div class="error">Search failed: ${e.message}</div>`,n.style.display="block",n.scrollIntoView({behavior:"smooth"})}}(e)}else alert("Please enter either a business name or address to search")})):console.warn("Business search form not found in the DOM"),window.viewBusinessDetails=function(e){console.log("View details for business:",e),alert("This feature is coming soon: View details for "+e)},window.initGoogleMap=function(){console.log("Google Maps API loaded, initializing map"),function(){console.log("Initializing Google Map");try{const t=document.getElementById("map");if(!t)return void console.error("Map container not found in the DOM");e=new google.maps.Map(t,{center:{lat:39.8283,lng:-98.5795},zoom:4,mapTypeId:google.maps.MapTypeId.ROADMAP}),n=new google.maps.InfoWindow,s=new google.maps.LatLngBounds;const o=document.createElement("div");o.id="initial-map-message",o.innerHTML="Search for businesses to see them on the map",o.style.position="absolute",o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.background="white",o.style.padding="10px",o.style.borderRadius="5px",o.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)",o.style.zIndex="1",t.appendChild(o);const i=document.getElementById("reset-map");i&&i.addEventListener("click",(function(){mapInitialized&&e?(e.setCenter({lat:39.8283,lng:-98.5795}),e.setZoom(4),n&&n.close()):console.error("Cannot reset map view - map not initialized")})),mapInitialized=!0,console.log("Google Map successfully initialized"),pendingBusinessesToDisplay.length>0&&(console.log("Processing pending businesses to display on map"),r(pendingBusinessesToDisplay),pendingBusinessesToDisplay=[])}catch(e){console.error("Error initializing Google Map:",e),mapInitialized=!1}}()},window.focusOnMapMarker=function(n){if(console.log("Attempting to focus on business ID:",n),!mapInitialized||!e)return console.error("Map not initialized yet - cannot focus on marker"),void alert("Map is still loading. Please try again in a moment.");if(console.log("Current markers:",t.length),!t||0===t.length)return console.warn("No markers available yet."),void alert("No businesses are currently displayed on the map.");const s=t.find((e=>e.business&&e.business._id===n));s?(e.setCenter(s.getPosition()),e.setZoom(16),a(s),document.getElementById("map").scrollIntoView({behavior:"smooth"}),console.log("Successfully focused on marker for business:",n)):(console.warn(`No marker found for business ID: ${n}`),alert("This business could not be located on the map. It may not have a complete address."),document.getElementById("map").scrollIntoView({behavior:"smooth"}))},o.businessName&&o.businessName.addEventListener("input",(function(){m(this,p)})),o.address&&o.address.addEventListener("input",(function(){m(this,p)}))}));