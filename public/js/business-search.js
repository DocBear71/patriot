let map=null,mapInitialized=!1,markers=[],infoWindow=null,bounds=null,pendingBusinessesToDisplay=[];document.addEventListener("DOMContentLoaded",(function(){let e;console.log("Business search with Google Maps loaded!");let n,t,s=[];const o={businessName:document.getElementById("business-name"),address:document.getElementById("address")},i=document.getElementById("business-search-form");function a(n){return mapInitialized&&e?(console.log("Displaying businesses on map:",n.length),Array.isArray(n)&&0!==n.length?(u(),t=new google.maps.LatLngBounds,void n.forEach(((o,i)=>{!function(n,o,i){if(!n||!n.address1)return void console.error("Invalid business data for geocoding",n);const a=`${n.address1}, ${n.city}, ${n.state} ${n.zip}`,l=new google.maps.Geocoder;setTimeout((()=>{l.geocode({address:a},(function(l,c){if(c===google.maps.GeocoderStatus.OK){if(l[0]){const a=l[0].geometry.location;r(n,a),t.extend(a),o===i-1&&(e.fitBounds(t),1===i&&e.setZoom(15),i>=1&&function(e,n){console.log("Searching for nearby businesses near",e.lat(),e.lng());const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:"https://patriotthanks.vercel.app";fetch(`${t}/api/business.js?operation=search&type=${n}`).then((e=>{if(!e.ok)throw new Error(`Failed to fetch nearby businesses: ${e.status}`);return e.json()})).then((n=>{if(!n.results||0===n.results.length)return void console.log("No additional nearby businesses found");console.log(`Found ${n.results.length} potential nearby businesses`);const t=s.map((e=>e.business._id)),o=n.results.filter((e=>!t.includes(e._id)));console.log(`${o.length} new businesses to add to map`),o.forEach(((n,t)=>{setTimeout((()=>{!function(e,n){if(!e||!e.address1)return;const t=`${e.address1}, ${e.city}, ${e.state} ${e.zip}`;(new google.maps.Geocoder).geocode({address:t},(function(t,s){if(s===google.maps.GeocoderStatus.OK&&t[0]){const s=t[0].geometry.location;google.maps.geometry.spherical.computeDistanceBetween(n,s)<=2e4&&(e.isNearby=!0,r(e,s))}}))}(n,e)}),200*t)}))})).catch((e=>{console.error("Error searching for nearby businesses:",e)}))}(a,n.type))}}else console.error("Geocode failed for address "+a+": "+c)}))}),200*o)}(o,i,n.length)}))):(console.log("No businesses to display on map"),e.setCenter({lat:39.8283,lng:-98.5795}),void e.setZoom(4))):(console.log("Map not initialized yet. Storing businesses for later display."),void(pendingBusinessesToDisplay=n))}async function r(n,t){try{const{AdvancedMarkerElement:o}=await google.maps.importLibrary("marker"),i={lat:t.lat(),lng:t.lng()},a=!0===n.isNearby,r=a?"#4285F4":"#EA4335",l={AUTO:'<i class="fa fa-car" aria-hidden="true"></i>',BEAU:'<i class="fa fa-scissors" aria-hidden="true"></i>',BOOK:'<i class="fa fa-book" aria-hidden="true"></i>',CLTH:'<i class="fa fa-shopping-bag" aria-hidden="true"></i>',CONV:'<i class="fa fa-shopping-basket" aria-hidden="true"></i>',DEPT:'<i class="fa fa-building" aria-hidden="true"></i>',ELEC:'<i class="fa fa-laptop" aria-hidden="true"></i>',ENTR:'<i class="fa fa-film" aria-hidden="true"></i>',FURN:'<i class="fa fa-bed" aria-hidden="true"></i>',FUEL:'<i class="fa fa-gas-pump" aria-hidden="true"></i>',GIFT:'<i class="fa fa-gift" aria-hidden="true"></i>',GROC:'<i class="fa fa-shopping-cart" aria-hidden="true"></i>',HARDW:'<i class="fa fa-hammer" aria-hidden="true"></i>',HEAL:'<i class="fa fa-heartbeat" aria-hidden="true"></i>',JEWL:'<i class="fa fa-gem" aria-hidden="true"></i>',OTHER:'<i class="fa fa-store" aria-hidden="true"></i>',RX:'<i class="fa fa-prescription-bottle" aria-hidden="true"></i>',REST:'<i class="fa fa-utensils" aria-hidden="true"></i>',RETAIL:'<i class="fa fa-shopping-bag" aria-hidden="true"></i>',SERV:'<i class="fa fa-concierge-bell" aria-hidden="true"></i>',SPEC:'<i class="fa fa-star" aria-hidden="true"></i>',SPRT:'<i class="fa fa-futbol" aria-hidden="true"></i>',TECH:'<i class="fa fa-microchip" aria-hidden="true"></i>',TOYS:'<i class="fa fa-gamepad" aria-hidden="true"></i>'}[n.type]||'<i class="fa fa-store" aria-hidden="true"></i>',c=document.createElement("div");c.className="custom-marker",c.style.cursor="pointer",c.style.zIndex="1000",n.image_url?c.innerHTML=`\n                <div class="marker-container">\n                    <div class="marker-pin" style="background-color: ${r};">\n                        <div class="marker-image-container">\n                            <img src="${n.image_url}" alt="${n.bname}" class="marker-image">\n                        </div>\n                    </div>\n                    <div class="marker-shadow"></div>\n                </div>\n            `:c.innerHTML=`\n                <div class="marker-container">\n                    <div class="marker-pin" style="background-color: ${r};">\n                        <div class="marker-icon">\n                            ${l}\n                        </div>\n                    </div>\n                    <div class="marker-shadow"></div>\n                </div>\n            `;const u=new o({position:i,map:e,title:n.bname,content:c,collisionBehavior:a?"OPTIONAL_AND_HIDES_LOWER_PRIORITY":"REQUIRED"});return u.business=n,u.isNearby=a,c.addEventListener("click",(function(e){console.log("Marker element clicked:",n.bname),e.stopPropagation(),d(u)})),u.addEventListener("gmp-click",(function(e){console.log("Marker gmp-click triggered:",n.bname),d(u)})),s.push(u),console.log(`Added advanced marker for ${n.bname}`),u}catch(e){return console.error("Error creating advanced marker:",e),null}}async function l(e){if(!e||!e.placeId)return console.log("No place ID for business:",e?e.bname:"unknown"),null;try{const{Place:n}=await google.maps.importLibrary("places"),t=new n({id:e.placeId});if(await t.fetchFields({fields:["photos","displayName"]}),t.photos&&t.photos.length>0){const n=t.photos[0].getUrl({maxWidth:100,maxHeight:100});return console.log(`Fetched photo for ${e.bname}`),n}return console.log(`No photos available for ${e.bname}`),null}catch(e){return console.error("Error fetching place photos:",e),null}}function c(e,n){if(!e||!e.content)return;const t=e.business;if(!t)return;const s=!0===t.isNearby?"#4285F4":"#EA4335",o=document.createElement("div");o.className="custom-marker",o.style.cursor="pointer",o.style.zIndex="1000",o.innerHTML=`\n        <div class="marker-container">\n            <div class="marker-pin" style="background-color: ${s};">\n                <div class="marker-image-container">\n                    <img src="${n}" alt="${t.bname}" class="marker-image">\n                </div>\n            </div>\n            <div class="marker-shadow"></div>\n        </div>\n    `,e.content=o,o.addEventListener("click",(function(n){console.log("Updated marker element clicked:",t.bname),n.stopPropagation(),d(e)}))}function d(t){if(console.log("showInfoWindow called with marker:",t),!t||!t.business)return void console.error("Invalid marker for info window",t);const s=t.business;console.log("Business data for info window:",s);const o=s.address2?`${s.address1}<br>${s.address2}<br>${s.city}, ${s.state} ${s.zip}`:`${s.address1}<br>${s.city}, ${s.state} ${s.zip}`,i=p(s.type),a=s.phone?`<p><strong>Phone:</strong> ${s.phone}</p>`:"",r=`\n    <div class="info-window">\n        <h3>${s.bname}</h3>\n        <p><strong>Address:</strong><br>${o}</p>\n        ${a}\n        <p><strong>Type:</strong> ${i}</p>\n        <div id="info-window-incentives-${s._id}">\n            <p><strong>Incentives:</strong> <em>Loading...</em></p>\n        </div>\n        <div class="info-window-actions">\n            <button class="view-details-btn" \n                    onclick="window.viewBusinessDetails('${s._id}')">\n                View Details\n            </button>\n        </div>\n    </div>\n    `;n||(n=new google.maps.InfoWindow),n.setContent(r),n.open({map:e,anchor:t,shouldFocus:!1}),console.log("Opened info window for marker using anchor method"),function(e){if(!e)return void console.error("No business ID provided for fetching incentives");const n="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:"https://patriotthanks.vercel.app";fetch(`${n}/api/incentives.js?business_id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to fetch incentives: ${e.status}`);return e.json()})).then((n=>{const t=document.getElementById(`info-window-incentives-${e}`);if(!t)return void console.error(`Could not find incentives div for business ${e}`);if(!n.results||0===n.results.length)return void(t.innerHTML="<p><strong>Incentives:</strong> No incentives found</p>");let s='<p><strong>Incentives:</strong></p><ul class="incentives-list">';n.results.forEach((e=>{if(e.is_available){const n=m(e.type),t=e.other_description?` (${e.other_description})`:"";s+=`\n                            <li>\n                                <strong>${n}${t}:</strong> ${e.amount}%\n                                ${e.information?` - ${e.information}`:""}\n                            </li>\n                        `}})),s+="</ul>",t.innerHTML='<p><strong>Incentives:</strong></p><ul class="incentives-list"></ul>'===s?"<p><strong>Incentives:</strong> No active incentives found</p>":s})).catch((n=>{console.error(`Error fetching incentives for info window: ${n}`);const t=document.getElementById(`info-window-incentives-${e}`);t&&(t.innerHTML="<p><strong>Incentives:</strong> Error loading incentives</p>")}))}(s._id)}function u(){s?(s.forEach((e=>{e&&(e.map=null)})),s=[]):s=[]}function p(e){return{AUTO:"Automotive",BEAU:"Beauty",BOOK:"Bookstore",CLTH:"Clothing",CONV:"Convenience Store/Gas Station",DEPT:"Department Store",ELEC:"Electronics",ENTR:"Entertainment",FURN:"Furniture",FUEL:"Fuel Station/Truck Stop",GIFT:"Gift Shop",GROC:"Grocery",HARDW:"Hardware",HEAL:"Health",JEWL:"Jewelry",OTHER:"Other",RX:"Pharmacy",REST:"Restaurant",RETAIL:"Retail",SERV:"Service",SPEC:"Specialty",SPRT:"Sporting Goods",TECH:"Technology",TOYS:"Toys"}[e]||e}function m(e){return{VT:"Veteran",AD:"Active Duty",FR:"First Responder",SP:"Spouse",OT:"Other"}[e]||e}function g(e){console.log("Handling business selection with fallback: ",e);try{const n=document.getElementById("business-info-section");if(!n)return void console.error("business-info-section not found");document.getElementById("selected-business-id")&&(selectedBusinessId=e._id||""),function(e){if(e)try{const n=document.getElementById("bname");n&&(n.value=e.bname||"");const t=document.getElementById("address1");t&&(t.value=e.address1||"");const s=document.getElementById("address2");s&&(s.value=e.address2||"");const o=document.getElementById("city");o&&(o.value=e.city||"");const i=document.getElementById("zip");i&&(i.value=e.zip||"");const a=document.getElementById("phone");a&&(a.value=e.phone||"");const r=document.getElementById("state");if(r){const n=e.state||"";for(let e=0;e<r.options.length;e++)if(r.options[e].value===n){r.selectedIndex=e;break}}const l=document.getElementById("type");if(l){const n=e.type||"";for(let e=0;e<l.options.length;e++)if(l.options[e].value===n){l.selectedIndex=e;break}}console.log("Business info populated successfully")}catch(e){console.error("Error in populateBusinessInfo: "+e)}else console.error("No business data provided to populateBusinessInfo")}(e);const t=document.getElementById("incentive-section");t&&(t.style.display="block"),n.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error in handleBusinessSection: "+e),alert("There was an error selecting the business: "+e.message)}}function f(e){return""!==e.trim()}function h(e,n){console.log(`Validating ${e.id} with value: ${e.value}`),n(e.value)?(e.classList.remove("invalid-field"),e.classList.add("valid-field"),e.setAttribute("data-valid","true"),console.log(`${e.id} is VALID`)):(e.classList.remove("valid-field"),e.classList.add("invalid-field"),e.setAttribute("data-valid","false"),console.log(`${e.id} is INVALID`))}function b(e,n){if(!e.addressComponents)return"";const t=e.addressComponents.find((e=>e.types.includes(n)));return t?t.shortText:""}i?i.addEventListener("submit",(function(e){if(e.preventDefault(),f(o.businessName.value)||f(o.address.value)){const e={businessName:o.businessName.value,address:o.address.value};console.log("Form data to submit:",e),mapInitialized||console.warn("Map not initialized yet. Will display businesses after map loads."),u();const n=document.getElementById("initial-map-message");n&&n.remove(),async function(e){try{const n={};e.businessName&&""!==e.businessName.trim()&&(n.business_name=e.businessName),e.address&&""!==e.address.trim()&&(n.address=e.address);const t=new URLSearchParams(n).toString(),s=`${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:"https://patriotthanks.vercel.app"}/api/business.js?operation=search&${t}`;console.log("submitting search to API at: ",s);const o=await fetch(s,{method:"GET",headers:{"Content-Type":"application/json; charset=UTF-8"}});if(console.log("response status: ",o.status),!o.ok){const e=await o.text();throw console.error("Error response: ",e),new Error(`Failed to retrieve data from MongoDB: ${o.status} ${e}`)}const i=await o.json();if(console.log("Search results:",i),!i||!i.results)throw console.error("Invalid response format - missing results property"),new Error("Invalid response format from server");if(document.getElementById("search_table"))!function(e){try{const n=document.getElementById("business_search"),t=document.getElementById("search_table");if(!n||!t)return console.error("Required elements not found in the DOM"),void alert("There was an error displaying search results. Please try again later.");let s=n.querySelector("tbody");if(!s)return console.error("Table body not found within business_search table"),void alert("There was an error displaying search results. Please try again later.");s.innerHTML="",Array.isArray(e)||(console.error("businesses is not an array:",e),e=[]),t.style.display="block";const o=t.querySelector("h5");if(o&&(o.style.display="none"),0===e.length)return s.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria.</td></tr>',void t.scrollIntoView({behavior:"smooth"});e.forEach((e=>{if(!e)return;const n=e.address2?`${e.address1}<br>${e.address2}<br>${e.city}, ${e.state} ${e.zip}`:`${e.address1}<br>${e.city}, ${e.state} ${e.zip}`,t=p(e.type),o=document.createElement("tr"),i=`<button class="view-map-btn" onclick="focusOnMapMarker('${e._id}')">View on Map</button>`;o.innerHTML=`\n                    <th class="left_table" data-business-id="${e._id}">${e.bname}</th>\n                    <th class="left_table">${n}</th>\n                    <th class="left_table">${t}</th>\n                    <th class="right_table" id="incentives-for-${e._id}">Loading incentives...</th>\n                    <th class="center_table">${i}</th>\n                `,s.appendChild(o),function(e){if(!e)return void console.error("No business ID provided for fetching incentives");const n=`${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:"https://patriotthanks.vercel.app"}/api/incentives.js?business_id=${e}`;console.log("Fetching incentives from: ",n),fetch(n).then((e=>{if(!e.ok)throw new Error(`Failed to fetch incentives: ${e.status} ${e.statusText}`);return e.json()})).then((n=>{console.log(`Incentives data for business ${e}:`,n);const t=document.getElementById(`incentives-for-${e}`);if(!t)return void console.error(`Could not find cell for incentives-for-${e}`);if(!n.results||0===n.results.length)return void(t.innerHTML="No incentives found");let s="";n.results.forEach((e=>{if(e.is_available){const n=m(e.type),t=e.other_description?` (${e.other_description})`:"";s+=`\n                            <div class="incentive-item">\n                                <strong>${n}${t}:</strong> ${e.amount}%\n                                <div class="incentive-info">${e.information||""}</div>\n                            </div>\n                        `}})),t.innerHTML=""===s?"No active incentives found":s})).catch((n=>{console.error(`Error fetching incentives for business ${e}:`,n);const t=document.getElementById(`incentives-for-${e}`);t&&(t.innerHTML="Error loading incentives")}))}(e._id)})),t.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error displaying search results: ",e),alert("There was an error displaying the search results: "+e.message)}}(i.results),a(i.results);else{let e=document.getElementById("business-search-results");if(!e){e=document.createElement("div"),e.id="business-search-results";const n=document.querySelector("fieldset");if(n)n.parentNode.insertBefore(e,n.nextSibling);else{const n=document.querySelector("main");n?n.appendChild(e):document.body.appendChild(e)}console.log("Created business-search-results container")}!function(e,n){try{if(n.innerHTML="",Array.isArray(e)||(console.error("businesses is not an array:",e),e=[]),0===e.length)return n.innerHTML='<div class="error">No businesses found matching your search criteria.</div>',void n.scrollIntoView({behavior:"smooth"});const t=document.createElement("table");t.className="results-table";const s={name:"Business Name",address:"Address",city:"City",state:"State",zip:"Zip",action:"Action"},o=document.createElement("thead");o.innerHTML=`\n            <tr>\n                <th>${s.name}</th>\n                <th>${s.address}</th>\n                <th>${s.city}</th>\n                <th>${s.state}</th>\n                <th>${s.zip}</th>\n                <th>${s.action}</th>\n            </tr>\n        `,t.appendChild(o);const i=document.createElement("tbody");if(e.forEach((e=>{if(!e)return;const n=document.createElement("tr");n.innerHTML=`\n                <td data-title="${s.name}">${e.bname}</td>\n                <td data-title="${s.address}">${e.address1}${e.address2?"<br>"+e.address2:""}</td>\n                <td data-title="${s.city}">${e.city}</td>\n                <td data-title="${s.state}">${e.state}</td>\n                <td data-title="${s.zip}">${e.zip}</td>\n                <td data-title="${s.action}"><button class="select-business" data-business-id="${e._id}">Select</button></td>\n            `,i.appendChild(n)})),t.appendChild(i),n.appendChild(t),!document.getElementById("responsive-table-css")){const e=document.createElement("style");e.id="responsive-table-css",e.textContent="\n                /* Base table styles */\n                .results-table {\n                    width: 90%;\n                    margin: 20px auto;\n                    border-collapse: collapse;\n                    text-align: left;\n                }\n                \n                .results-table th, .results-table td {\n                    border: 1px solid #ddd;\n                    padding: 8px;\n                }\n                \n                .results-table th {\n                    background-color: #f2f2f2;\n                    font-weight: bold;\n                    text-align: center;\n                }\n                \n                .results-table tr:nth-child(even) {\n                    background-color: #f9f9f9;\n                }\n                \n                .results-table tr:hover {\n                    background-color: #f1f1f1;\n                }\n                \n                /* Responsive table for small screens */\n                @media only screen and (max-width: 767px) {\n                    .results-table {\n                        width: 100%;\n                        margin: 10px 0;\n                    }\n                    \n                    .results-table, .results-table thead, .results-table tbody, .results-table tr {\n                        display: block;\n                    }\n                    \n                    .results-table thead {\n                        display: none;\n                    }\n                    \n                    .results-table tr {\n                        border: 1px solid #ccc;\n                        margin-bottom: 15px;\n                        padding: 8px;\n                        background-color: #f9f9f9;\n                    }\n                    \n                    .results-table td {\n                        display: block;\n                        border: none;\n                        border-bottom: 1px solid #eee;\n                        padding: 8px;\n                        margin-bottom: 6px;\n                        text-align: left;\n                        position: relative;\n                    }\n                    \n                    .results-table td::before {\n                        content: attr(data-title);\n                        display: block;\n                        font-weight: bold;\n                        margin-bottom: 6px;\n                        color: #333;\n                    }\n                    \n                    /* Ensure buttons are properly displayed */\n                    .select-business {\n                        margin: 8px 0;\n                        display: inline-block;\n                    }\n                }\n            ",document.head.appendChild(e)}document.querySelectorAll(".select-business").forEach((n=>{n.addEventListener("click",(function(){const n=this.getAttribute("data-business-id");if(!n)return void console.error("No business ID found on button");const t=e.find((e=>e._id===n));if(!t)return void console.error("Could not find business with ID: "+n);console.log("Selected business: ",t);const s=window.location.pathname;console.log("Current page: ",s),s.includes("incentive-update.html")?(console.log("On incentive-update page"),"function"==typeof window.selectBusinessForIncentive?window.selectBusinessForIncentive(t):"function"==typeof window.selectBusinessForIncentives?window.selectBusinessForIncentives(t):(console.error("selectBusinessForIncentive(s) not found, falling back"),g(t))):s.includes("business-update.html")?(console.log("On business-update page"),"function"==typeof window.selectBusinessForUpdate?window.selectBusinessForUpdate(t):(console.error("selectBusinessForUpdate not found, falling back"),g(t))):s.includes("incentive-add.html")?(console.log("On incentive-add page"),"function"==typeof window.selectBusinessForIncentive?window.selectBusinessForIncentive(t):g(t)):s.includes("incentive-view.html")||s.endsWith("business-search.html")?(console.log("On incentive-view page"),"function"==typeof window.viewBusinessIncentives?window.viewBusinessIncentives(t):g(t)):(console.error("Using fallback business selection handler"),g(t))}))})),n.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error displaying business search results: "+e);const n=document.getElementById("business-search-results");n?(n.innerHTML=`<div class="error">Error displaying search results: ${e.message}</div>`,n.scrollIntoView({behavior:"smooth"})):alert("Error displaying search results: "+e.message)}}(i.results,e)}}catch(e){let n;if(console.error("Error: ",e),document.getElementById("search_table"))n=document.getElementById("search_table");else if(n=document.getElementById("business-search-results"),!n){n=document.createElement("div"),n.id="business-search-results";const e=document.querySelector("fieldset");e?e.parentNode.insertBefore(n,e.nextSibling):document.body.appendChild(n)}n.innerHTML=`<div class="error">Search failed: ${e.message}</div>`,n.style.display="block",n.scrollIntoView({behavior:"smooth"})}}(e)}else alert("Please enter either a business name or address to search")})):console.warn("Business search form not found in the DOM"),e.addListener("click",(function(n){if(n.placeId){const t=n.latLng,o=15,i=Math.pow(2,e.getZoom()),a=e.getProjection(),r=e.getBounds();if(!a||!r)return;const l=r.getNorthEast(),c=r.getSouthWest(),u=(a.fromLatLngToPoint(l).x-a.fromLatLngToPoint(c).x)/(l.lng()-c.lng());for(const e of s){if(!e.position)continue;const s="function"==typeof e.position.lat?e.position.lat():e.position.lat,a="function"==typeof e.position.lng?e.position.lng():e.position.lng,r=t.lat(),l=t.lng(),c=Math.abs(s-r)*u*111e3/(i*Math.cos(s*Math.PI/180)),p=Math.abs(a-l)*u;if(Math.sqrt(Math.pow(c,2)+Math.pow(p,2))<o)return console.log("Preventing POI click near our marker"),n.stop(),void setTimeout((()=>{d(e)}),10)}}})),setTimeout((()=>{!async function(){if(s&&0!==s.length){console.log("Enhancing markers with images...");for(const e of s){if(!e.business)continue;if(e.business.image_url)continue;const n=await l(e.business);n&&(e.business.image_url=n,c(e,n))}}}()}),1e3),window.testAdvancedMarker=function(){console.log("Creating test advanced marker");const n=e.getCenter();(async()=>{try{const{AdvancedMarkerElement:e}=await google.maps.importLibrary("marker"),t={_id:"test123",bname:"Test Advanced Business",address1:"123 Test Street",city:"Test City",state:"TS",zip:"12345",type:"TEST",phone:"555-TEST"},s=await r(t,{lat:()=>n.lat(),lng:()=>n.lng()});console.log("Test marker added at center:",n.lat(),n.lng()),s&&setTimeout((()=>{d(s)}),500)}catch(e){console.error("Error creating test advanced marker:",e),alert("Error creating test marker: "+e.message)}})()},window.viewBusinessDetails=function(e){console.log("View details for business:",e),alert("This feature is coming soon: View details for "+e)},window.initGoogleMap=async function(){console.log("initGoogleMap called - initializing Google Map");try{const s=document.getElementById("map");if(!s)return void console.error("Map container not found in the DOM");const o="ebe8ec43a7bc252d";console.log("Using Map ID:",o);const{Map:i}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:r}=await google.maps.importLibrary("marker");e=new i(s,{center:{lat:39.8283,lng:-98.5795},zoom:4,mapId:o,clickableIcons:!1}),n=new google.maps.InfoWindow,t=new google.maps.LatLngBounds;const l=document.createElement("div");l.id="initial-map-message",l.innerHTML="Search for businesses to see them on the map",l.style.position="absolute",l.style.top="50%",l.style.left="50%",l.style.transform="translate(-50%, -50%)",l.style.background="white",l.style.padding="10px",l.style.borderRadius="5px",l.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)",l.style.zIndex="1",s.appendChild(l),await async function(){const{Place:t}=await google.maps.importLibrary("places");e.addListener("click",(async function(s){if(s.placeId){s.stop(),console.log("POI clicked, placeId:",s.placeId);try{const o=new t({id:s.placeId});await o.fetchFields({fields:["displayName","formattedAddress","location","types","businessStatus","nationalPhoneNumber"]}),console.log("Place details:",o),function(t,s){const o=`\n        <div class="info-window">\n            <h3>${t.displayName||"Unnamed Place"}</h3>\n            <p><strong>Address:</strong><br>${t.formattedAddress||"Address not available"}</p>\n            ${t.nationalPhoneNumber?`<p><strong>Phone:</strong> ${t.nationalPhoneNumber}</p>`:""}\n            <p><strong>Type:</strong> ${function(e){if(!e||!e.length)return"Unknown";const n={restaurant:"Restaurant",food:"Food",store:"Store",establishment:"Business",point_of_interest:"Point of Interest",gas_station:"Gas Station",lodging:"Lodging",cafe:"Cafe",bar:"Bar"};for(const t of e)if(n[t])return n[t];return e[0].replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase()))}(t.types)}</p>\n            <div class="info-window-actions">\n                <button class="add-business-btn" \n                        onclick="window.addBusinessToDatabase('${t.id}')">\n                    Add to Patriot Thanks\n                </button>\n            </div>\n        </div>\n    `;n.setContent(o),n.setPosition(s),n.open(e)}(o,s.latLng)}catch(e){console.error("Error fetching place details:",e)}}})),console.log("Map click handler set up for POIs using new Place API")}();const c=document.getElementById("reset-map");c&&c.addEventListener("click",(function(){mapInitialized&&e?(e.setCenter({lat:39.8283,lng:-98.5795}),e.setZoom(4),n&&n.close()):console.error("Cannot reset map view - map not initialized")})),mapInitialized=!0,console.log("Google Map successfully initialized with Map ID:",o),console.log("Advanced Markers and Place API enabled"),pendingBusinessesToDisplay.length>0&&(console.log("Processing pending businesses to display on map"),a(pendingBusinessesToDisplay),pendingBusinessesToDisplay=[])}catch(e){console.error("Error initializing Google Map:",e),mapInitialized=!1}},window.focusOnMapMarker=function(n){if(console.log("Attempting to focus on business ID:",n),!mapInitialized||!e)return console.error("Map not initialized yet - cannot focus on marker"),void alert("Map is still loading. Please try again in a moment.");if(console.log("Current markers:",s.length),!s||0===s.length)return console.warn("No markers available yet."),void alert("No businesses are currently displayed on the map.");const t=s.find((e=>e.business&&e.business._id===n));if(t){const s=t.position;e.setCenter(s),e.setZoom(16),d(t),document.getElementById("map").scrollIntoView({behavior:"smooth"}),console.log("Successfully focused on marker for business:",n)}else console.warn(`No marker found for business ID: ${n}`),alert("This business could not be located on the map. It may not have a complete address."),document.getElementById("map").scrollIntoView({behavior:"smooth"})},o.businessName&&o.businessName.addEventListener("input",(function(){h(this,f)})),o.address&&o.address.addEventListener("input",(function(){h(this,f)})),window.addBusinessToDatabase=async function(e){console.log("Adding place to database:",e);try{const{Place:n}=await google.maps.importLibrary("places"),t=new n({id:e});await t.fetchFields({fields:["displayName","formattedAddress","addressComponents","location","nationalPhoneNumber"]});const s={name:t.displayName||"",address1:b(t,"street_number")+" "+b(t,"route"),city:b(t,"locality"),state:b(t,"administrative_area_level_1"),zip:b(t,"postal_code"),phone:t.nationalPhoneNumber||"",lat:t.location?.lat||0,lng:t.location?.lng||0,placeId:t.id};sessionStorage.setItem("newBusinessData",JSON.stringify(s)),window.location.href="business-add.html?prefill=true"}catch(e){console.error("Error fetching place details for addition:",e),alert("Sorry, we couldn't retrieve the details for this business. Please try again or add it manually.")}},document.addEventListener("DOMContentLoaded",(function(){const e="ebe8ec43a7bc252d";console.log("Loading Google Maps with Map ID:",e);const n=document.createElement("script");n.src=`https://maps.googleapis.com/maps/api/js?key=AIzaSyCHKhYZwQR37M_0QctXUQe6VFRFrlhaYj8&map_ids=${e}&libraries=places,geometry,marker&callback=initGoogleMap&loading=async`,n.async=!0,n.defer=!0,n.onerror=function(){console.error("Google Maps API failed to load. Check your API key."),alert("Error loading Google Maps. Please try again later.")},document.head.appendChild(n)}))}));