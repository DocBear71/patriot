function debugMapState(){if(console.log("==== MAP DEBUGGING INFO ===="),console.log("Map initialized:",mapInitialized),console.log("Map object exists:",!!map),map)try{const e=map.getCenter();console.log("Map center:",e?`${e.lat()}, ${e.lng()}`:"undefined"),console.log("Map zoom:",map.getZoom()),console.log("Map type:",map.getMapTypeId()),console.log("Map ID:",map.getMapId())}catch(e){console.error("Error getting map properties:",e)}if(console.log("Markers count:",markers?markers.length:0),markers&&markers.length>0&&(console.log("Markers summary:"),markers.forEach(((e,n)=>{try{let o;e.getPosition?o=e.getPosition():e.position&&(o=e.position);const t=o?"function"==typeof o.lat?`${o.lat()}, ${o.lng()}`:`${o.lat}, ${o.lng}`:"unknown";console.log(`  Marker #${n}: Business: ${e.business?e.business.bname:"unknown"}, Position: ${t}`)}catch(e){console.error(`  Error getting marker #${n} info:`,e)}}))),console.log("Bounds:",bounds?"exists":"not created"),bounds)try{const e=bounds.getNorthEast(),n=bounds.getSouthWest();if(console.log("  NE:",e?`${e.lat()}, ${e.lng()}`:"undefined"),console.log("  SW:",n?`${n.lat()}, ${n.lng()}`:"undefined"),console.log("  Empty:",bounds.isEmpty()),e&&n){const o=isNaN(e.lat())||isNaN(e.lng())||isNaN(n.lat())||isNaN(n.lng());console.log("  Has NaN coordinates:",o)}}catch(e){console.error("  Error getting bounds info:",e)}console.log("Map container:",document.getElementById("map")?"found":"not found");const e=document.getElementById("map");e&&(console.log("  Display:",window.getComputedStyle(e).display),console.log("  Dimensions:",`${e.offsetWidth} × ${e.offsetHeight}`),console.log("  Position:",e.style.position),console.log("  Visibility:",window.getComputedStyle(e).visibility),console.log("  Z-index:",window.getComputedStyle(e).zIndex)),console.log("Google Maps libraries:"),console.log("  maps:",!!google.maps),console.log("  places:",!!google.maps.places),console.log("  geometry:",!!google.maps.geometry),console.log("  marker:",!!google.maps.marker),console.log("Google Maps API Key:",getGoogleMapsApiKey()?"found":"not found"),console.log("==== END DEBUGGING INFO ====")}function isValidPosition(e){if(!e)return console.warn("Position is null or undefined"),!1;let n,o;if(e instanceof google.maps.LatLng)try{n=e.lat(),o=e.lng()}catch(e){return console.warn("Error getting lat/lng from LatLng:",e),!1}else if("function"==typeof e.lat&&"function"==typeof e.lng)try{n=e.lat(),o=e.lng()}catch(e){return console.warn("Error calling lat/lng functions:",e),!1}else{if(void 0===e.lat||void 0===e.lng)return console.warn("Position does not have lat/lng properties"),!1;n=parseFloat(e.lat),o=parseFloat(e.lng)}return isNaN(n)||isNaN(o)?(console.warn("Position has NaN coordinates:",n,o),!1):isFinite(n)&&isFinite(o)?!(Math.abs(n)>90||Math.abs(o)>180)||(console.warn("Position coordinates out of range:",n,o),!1):(console.warn("Position has non-finite coordinates:",n,o),!1)}function createSafeLatLng(e){if(!e)return null;try{if(e instanceof google.maps.LatLng)return isValidPosition(e)?e:null;let n,o;if("function"==typeof e.lat&&"function"==typeof e.lng)n=e.lat(),o=e.lng();else if(void 0!==e.lat&&void 0!==e.lng)n=parseFloat(e.lat),o=parseFloat(e.lng);else if(void 0!==e.latitude&&void 0!==e.longitude)n=parseFloat(e.latitude),o=parseFloat(e.longitude);else{if(!(Array.isArray(e)&&e.length>=2))return console.warn("Position format not recognized:",e),null;n=parseFloat(e[0]),o=parseFloat(e[1])}return isNaN(n)||isNaN(o)||!isFinite(n)||!isFinite(o)?(console.warn("Invalid coordinates:",n,o),null):Math.abs(n)>90||Math.abs(o)>180?(console.warn("Coordinates out of range:",n,o),null):new google.maps.LatLng(n,o)}catch(e){return console.error("Error creating LatLng:",e),null}}function safelyFitBounds(e,n,o=11){if(!e||!n)return!1;try{const o=n.getNorthEast(),t=n.getSouthWest();return!o||!t||isNaN(o.lat())||isNaN(o.lng())||isNaN(t.lat())||isNaN(t.lng())?(console.warn("Invalid bounds for fitBounds:",n),!1):n.isEmpty()?(console.warn("Empty bounds, not fitting"),!1):(e.fitBounds(n),!0)}catch(n){console.error("Error fitting bounds:",n);try{void 0!==o&&e.setZoom(o)}catch(e){console.error("Error setting fallback zoom:",e)}return!1}}function safelySetCenter(e,n,o){if(!e)return!1;try{const t=createSafeLatLng(n);return!!t&&(e.setCenter(t),void 0!==o&&e.setZoom(o),!0)}catch(e){return console.error("Error setting map center:",e),!1}}function createNewBounds(){return new google.maps.LatLngBounds}function safeResetMapView(){if(mapInitialized&&map)try{safelySetCenter(map,CONFIG.defaultCenter,CONFIG.defaultZoom),infoWindow&&infoWindow.close()}catch(e){console.error("Error resetting map view:",e)}else console.error("Cannot reset map view - map not initialized")}const CONFIG={mapId:"ebe8ec43a7bc252d",defaultCenter:{lat:39.8283,lng:-98.5795},defaultZoom:4,markerColors:{primary:"#EA4335",nearby:"#4285F4"},geocodeDelay:200,imageLoadDelay:1e3,maxNearbyDistance:2e4};let map=null,mapInitialized=!1,markers=[],infoWindow=null,bounds=null,pendingBusinessesToDisplay=[];const placeCache=new Map;function clearMarkers(){markers?(markers.forEach((e=>{e&&(e.map=null)})),markers=[]):markers=[]}let googleMapsInitializing=!1,googleMapsInitialized=!1;function ensureGoogleMapsInitialized(){return googleMapsInitialized||googleMapsInitializing?(console.log("Google Maps already initialized or initializing"),Promise.resolve()):new Promise(((e,n)=>{try{if(googleMapsInitializing=!0,console.log("Starting Google Maps initialization"),window.google&&window.google.maps)return console.log("Google Maps API is already loaded, just initializing map"),initGoogleMap(),googleMapsInitialized=!0,googleMapsInitializing=!1,void e();const o=window.appConfig?.googleMapsApiKey||"AIzaSyCHKhYZwQR37M_0QctXUQe6VFRFrlhaYj8",t=window.appConfig?.googleMapsMapId||"ebe8ec43a7bc252d";window.initGoogleMapCallback=function(){console.log("Google Maps callback executed"),initGoogleMap(),googleMapsInitialized=!0,googleMapsInitializing=!1,e()};const s=document.createElement("script");s.src=`https://maps.googleapis.com/maps/api/js?key=${o}&map_ids=${t}&libraries=places,geometry,marker&callback=initGoogleMapCallback&loading=async&v=weekly`,s.async=!0,s.defer=!0,s.onerror=function(e){console.error("Google Maps API failed to load:",e),googleMapsInitializing=!1,n(e)},document.head.appendChild(s)}catch(e){googleMapsInitializing=!1,console.error("Error initializing Google Maps:",e),n(e)}}))}async function showPlaceInfoWindow(e,n){try{const o=e.displayName||e.name||"Unnamed Place";let t=null;try{t=await findMatchingChainForPlaceResult(o)}catch(e){console.error("Error checking chain match:",e)}const s={_id:"google_"+(e.place_id||e.id),bname:o,address1:e.formattedAddress||e.formatted_address||"Address not available",city:"",state:"",zip:"",phone:e.nationalPhoneNumber||e.formatted_phone_number||"",isGooglePlace:!0,placeId:e.place_id||e.id,lat:n.lat(),lng:n.lng()};t&&(console.log(`Place "${o}" matches chain: ${t.bname}`),s.chain_id=t._id,s.chain_name=t.bname,s.isChainLocation=!0),showInfoWindow({business:s,position:n})}catch(o){console.error("Error in showPlaceInfoWindow:",o),new google.maps.InfoWindow({content:`<div class="info-window">\n                        <h3>${e.displayName||e.name||"Unnamed Place"}</h3>\n                        <p><strong>Address:</strong><br>${e.formattedAddress||e.formatted_address||"Address not available"}</p>\n                        <p><strong>Status:</strong> Not in database</p>\n                      </div>`,position:n}).open(map)}}async function findMatchingChainForPlaceResult(e){try{if(!e)return console.warn("Empty place name provided for chain matching"),null;console.log("Checking if place matches a chain:",e);const n=getBaseURL();try{const o=await fetch(`${n}/api/business.js?operation=find_matching_chain&place_name=${encodeURIComponent(e)}`);if(404===o.status)return console.log("No matching chains found for",e),findMatchingChainLocally(e);if(!o.ok)return console.error("Error searching for matching chains:",o.status),findMatchingChainLocally(e);const t=await o.json();return t.success&&t.chain?(console.log("Found matching chain for place:",t.chain.bname),t.chain):findMatchingChainLocally(e)}catch(n){return console.error("Error with chain matching API, falling back to local matching:",n),findMatchingChainLocally(e)}}catch(e){return console.error("Error finding matching chain:",e),null}}function getStreetNumberAndName(e){if(!e)return"";const n=normalizeAddress(e),o=n.match(/(\d+)\s+([a-z]+(?:\s+[a-z]+)*)/i);return o&&o.length>=3?`${o[1]} ${o[2].split(" ")[0]}`:n}function normalizeAddress(e){return e?e.toLowerCase().replace(/\bst\b/g,"street").replace(/\be\b/g,"east").replace(/\bw\b/g,"west").replace(/\bn\b/g,"north").replace(/\bs\b/g,"south").replace(/\bave\b/g,"avenue").replace(/\bblvd\b/g,"boulevard").replace(/\brd\b/g,"road").replace(/\bdr\b/g,"drive").replace(/\bln\b/g,"lane").replace(/\bct\b/g,"court").replace(/\bpkwy\b/g,"parkway").replace(/\bpl\b/g,"place").replace(/\bapt\b/g,"").replace(/\bste\b/g,"").replace(/\bunit\b/g,"").replace(/\b#\d+\b/g,"").replace(/[^a-z0-9\s]/g,"").replace(/\s+/g," ").trim():""}function findMatchingDatabaseBusiness(e,n){if(!e||!Array.isArray(n)||0===n.length)return null;const o=normalizeAddress(e.address1||""),t=(e.bname||"").toLowerCase(),s=getStreetNumberAndName(e.address1||"");console.log(`Finding database match for place: ${e.bname}, address: ${e.address1}`),console.log(`Normalized place address: ${o}`),console.log(`Street number and name: ${s}`);let a=null,i=0;for(const r of n){if(!r||!r.bname)continue;const n=t===(r.bname||"").toLowerCase(),l=normalizeAddress(r.address1||""),c=o&&l&&o===l,d=getStreetNumberAndName(r.address1||""),p=s&&d&&s===d;console.log(`Comparing with DB business: ${r.bname}, address: ${r.address1}`),console.log(`Normalized DB address: ${l}`),console.log(`Street number and name: ${d}`),console.log(`Name match: ${n}, Address match: ${c}, Street match: ${p}`);const g=e.city&&r.city&&(e.city.toLowerCase()===r.city.toLowerCase()||"new"===e.city.toLowerCase()&&r.city.toLowerCase().startsWith("new"));let u=!1;if(e.lat&&e.lng&&r.location&&r.location.coordinates&&r.location.coordinates.length>=2){const n=Math.sqrt(Math.pow(e.lat-r.location.coordinates[1],2)+Math.pow(e.lng-r.location.coordinates[0],2));u=n<.001,console.log(`Coordinates match: ${u} (distance: ${n})`)}let m=0;n&&(m+=50),c&&(m+=40),p&&(m+=30),g&&(m+=20),u&&(m+=10),console.log(`Match score: ${m}`),m>i&&(a=r,i=m)}return i>=70?(console.log(`Found matching database business: ${a._id} with score ${i}`),a):(console.log("No matching database business found"),null)}function findMatchingChainLocally(e){if(!e)return null;const n=e.toLowerCase().replace(/^the\s+/,"").replace(/\s+inc\.?$/,"").replace(/\s+corp\.?$/,"").trim(),o=n.includes("lowes")||n.includes("lowe's")||n.includes("lowes home")||n.includes("lowe's home");console.log(`Normalized place name: "${n}", isLowes: ${o}`);const t=[{_id:"681fe0e67d92c3d3e1e2a3da",bname:"The Home Depot",normalizedName:"home depot",type:"HARDW",is_chain:!0},{_id:"walmart_chain_id",bname:"Walmart",normalizedName:"walmart",type:"RETAIL",is_chain:!0},{_id:"lowes_chain_id",bname:"Lowe's Home Improvement",normalizedName:"lowes home improvement",type:"HARDW",is_chain:!0}];for(const s of t){if(o&&s.normalizedName.includes("lowes"))return console.log(`Local chain match found: "${e}" matches "${s.bname}" (via Lowe's special handling)`),s;if(n.includes(s.normalizedName)||s.normalizedName.includes(n))return console.log(`Local chain match found: "${e}" matches "${s.bname}"`),s}return null}function getUserLocation(){return new Promise(((e,n)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition((n=>{const o={lat:n.coords.latitude,lng:n.coords.longitude};console.log("Got user location:",o),e(o)}),(e=>{console.warn("Error getting location:",e),n(e)}),{enableHighAccuracy:!0,timeout:5e3,maximumAge:0}):(console.warn("Geolocation not supported by this browser"),n(new Error("Geolocation not supported")))}))}function addCustomMarkerStyles(){if(!document.getElementById("custom-marker-css")){const e=document.createElement("style");e.id="custom-marker-css",e.textContent='\n            .custom-marker {\n                cursor: pointer;\n            }\n            \n            .marker-container {\n                position: relative;\n                width: 32px;\n                height: 40px;\n            }\n            \n            .marker-pin {\n                width: 32px;\n                height: 40px;\n                border-radius: 50% 50% 50% 0;\n                background-color: #EA4335;\n                transform: rotate(-45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n                position: absolute;\n                top: 0;\n                left: 0;\n            }\n            \n            .marker-pin.nearby {\n                background-color: #4285F4;\n            }\n            \n            .marker-icon {\n                transform: rotate(45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                width: 20px;\n                height: 20px;\n            }\n            \n            /* Critical fix - ensure Font Awesome icons are visible */\n            .marker-icon i.fas,\n            .marker-icon i.fa,\n            .marker-icon i.far,\n            .marker-icon i.fab {\n                display: inline-block !important;\n                font-size: 14px !important;\n                color: white !important;\n                line-height: 1 !important;\n                width: auto !important;\n                height: auto !important;\n                vertical-align: middle !important;\n            }\n            \n            /* Fallback icon content for missing Font Awesome */\n            .marker-icon i.fas.fa-store-alt:after {\n                content: "🏪";\n                font-family: sans-serif;\n                font-size: 14px;\n            }\n            \n            .marker-icon i.fas.fa-shopping-cart:after {\n                content: "🛒";\n                font-family: sans-serif;\n                font-size: 14px;\n            }\n            \n            .marker-shadow {\n                background-color: rgba(0, 0, 0, 0.2);\n                border-radius: 50%;\n                height: 14px;\n                width: 14px;\n                position: absolute;\n                bottom: -3px;\n                left: 9px;\n                filter: blur(2px);\n                z-index: -1;\n            }\n            \n            /* Info window action button styling */\n            .info-window-actions {\n                margin-top: 12px;\n                padding-top: 8px;\n                border-top: 1px solid #eee;\n                text-align: right;\n            }\n            \n            .info-window-actions .add-business-btn,\n            .info-window-actions .view-details-btn {\n                margin-top: 8px;\n                font-weight: bold;\n                text-transform: uppercase;\n                font-size: 12px;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                transition: background-color 0.2s ease;\n                border: none;\n                color: white;\n                letter-spacing: 0.5px;\n                display: inline-block;\n            }\n            \n            .info-window-actions .add-business-btn {\n                background-color: #EA4335;\n            }\n            \n            .info-window-actions .add-business-btn:hover {\n                background-color: #D32F2F;\n            }\n            \n            .info-window-actions .view-details-btn {\n                background-color: #4285F4;\n            }\n            \n            .info-window-actions .view-details-btn:hover {\n                background-color: #2A75F3;\n            }\n        ',document.head.appendChild(e)}}function getPlaceTypeLabel(e){if(!e||!e.length)return"Unknown";const n={restaurant:"Restaurant",food:"Food",store:"Store",establishment:"Business",point_of_interest:"Point of Interest",gas_station:"Gas Station",lodging:"Lodging",cafe:"Cafe",bar:"Bar"};for(const o of e)if(n[o])return n[o];return e[0].replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase()))}function finishAddingBusiness(e){sessionStorage.setItem("newBusinessData",JSON.stringify(e)),console.log("Storing business data in sessionStorage:",e),window.location.href="business-add.html?prefill=true"}function getAddressComponentFromPlace(e,n){if(!e.addressComponents)return"";const o=e.addressComponents.find((e=>e.types.includes(n)));return o?o.shortText:""}function getBusinessTypeLabel(e){return{AUTO:"Automotive",BEAU:"Beauty",BOOK:"Bookstore",CLTH:"Clothing",CONV:"Convenience Store/Gas Station",DEPT:"Department Store",ELEC:"Electronics",ENTR:"Entertainment",FURN:"Furniture",FUEL:"Fuel Station/Truck Stop",GIFT:"Gift Shop",GROC:"Grocery",HARDW:"Hardware",HEAL:"Health",JEWL:"Jewelry",OTHER:"Other",RX:"Pharmacy",REST:"Restaurant",RETAIL:"Retail",SERV:"Service",SPEC:"Specialty",SPRT:"Sporting Goods",TECH:"Technology",TOYS:"Toys"}[e]||e}function fetchBusinessIncentives(e,n=null){if(!e)return void console.error("No business ID provided for fetching incentives");let o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${e}`;n&&(o+=`&chain_id=${n}`),console.log("Fetching incentives from: ",o),fetch(o).then((e=>{if(!e.ok)throw new Error(`Failed to fetch incentives: ${e.status} ${e.statusText}`);return e.json()})).then((n=>{console.log(`Incentives data for business ${e}:`,n);const o=document.getElementById(`incentives-for-${e}`);if(!o)return void console.error(`Could not find cell for incentives-for-${e}`);if(!n.results||0===n.results.length)return void(o.innerHTML="No incentives found");let t="";n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"",s=e.is_chain_wide?'<span class="chain-badge small">Chain-wide</span>':"";t+=`\n            <div class="incentive-item">\n              <strong>${n}${o}:</strong> ${e.amount}% ${s}\n              <div class="incentive-info">${e.information||""}</div>\n            </div>\n          `}})),o.innerHTML=""===t?"No active incentives found":t})).catch((n=>{console.error(`Error fetching incentives for business ${e}:`,n);const o=document.getElementById(`incentives-for-${e}`);o&&(o.innerHTML="Error loading incentives")}))}function fetchChainIncentivesForPlacesResult(e,n){if(!e||!n)return void console.error("Missing place ID or chain ID for fetching chain incentives");const o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${n}`;console.log("Fetching chain incentives for Places result: ",o),fetch(o).then((e=>{if(!e.ok)throw new Error(`Failed to fetch chain incentives: ${e.status}`);return e.json()})).then((n=>{console.log(`Chain incentives data for place ${e}:`,n);const o=document.getElementById(`info-window-incentives-${e}`);if(!o)return void console.error(`Could not find incentives div for place ${e}`);if(!n.results||0===n.results.length)return void(o.innerHTML="<p><strong>Incentives:</strong> No chain incentives available</p>");let t='<p><strong>Incentives:</strong></p><ul class="incentives-list">';n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"";t+=`\n                        <li>\n                            <strong>${n}${o}:</strong> ${e.amount}% \n                            <span class="chain-badge small">Chain-wide</span>\n                            ${e.information?`<div>${e.information}</div>`:""}\n                        </li>\n                    `}})),t+="</ul>",o.innerHTML='<p><strong>Incentives:</strong></p><ul class="incentives-list"></ul>'===t?"<p><strong>Incentives:</strong> No active chain incentives found</p>":t})).catch((n=>{console.error(`Error fetching chain incentives for place ${e}:`,n);const o=document.getElementById(`info-window-incentives-${e}`);o&&(o.innerHTML="<p><strong>Incentives:</strong> Error loading incentives</p>")}))}function displaySearchResults(e){try{const n=document.getElementById("business_search"),o=document.getElementById("search_table");if(!n||!o)return console.error("Required elements not found in the DOM"),void alert("There was an error displaying search results. Please try again later.");let t=n.querySelector("tbody");if(!t)return console.error("Table body not found within business_search table"),void alert("There was an error displaying search results. Please try again later.");t.innerHTML="",Array.isArray(e)||(console.error("businesses is not an array:",e),e=[]),o.style.display="block";const s=o.querySelector("h5");if(s&&(s.style.display="none"),0===e.length)return t.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria.</td></tr>',void o.scrollIntoView({behavior:"smooth"});const a=e.filter((e=>!e.isGooglePlace)),i=e.filter((e=>e.isGooglePlace&&e.chain_id)),r=e.filter((e=>e.isGooglePlace&&!e.chain_id));console.log(`Businesses to display: ${a.length} from database, ${i.length} chain-matched Places, ${r.length} regular Places`),a.forEach((e=>{addBusinessRow(e,t,!1)})),i.forEach((e=>{addBusinessRow(e,t,!0)})),r.forEach((e=>{addBusinessRow(e,t,!0)})),o.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error displaying search results: ",e),alert("There was an error displaying the search results: "+e.message)}}function addBusinessRow(e,n,o){if(!e)return;const t=e.address2?`${e.address1}<br>${e.address2}<br>${e.city}, ${e.state} ${e.zip}`:`${e.address1}<br>${e.city}, ${e.state} ${e.zip}`,s=getBusinessTypeLabel(e.type),a=!!e.chain_id,i=!!e.is_chain,r=!!e.isGooglePlace;let l,c="";i?c='<span class="chain-badge">National Chain</span>':a?c='<span class="chain-badge">Chain Location</span>':o&&e.chain_name&&(c=`<span class="chain-badge">Potential ${e.chain_name||"Chain"} Location</span>`),l=i?checkIfUserIsAdmin()?`<button class="admin-action-btn" onclick="handleChainBusinessAction('${e._id}', true)">Admin: Edit Chain</button>`:`<button class="view-chain-btn" onclick="viewChainDetails('${e._id}')">View Chain Info</button>`:r?a?`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${e.place_data?.place_id||e.placeId||""}', '${e.chain_id||""}')">Add Chain Location</button>`:`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${e.place_data?.place_id||e.placeId||""}')">Add to Database</button>`:`<button class="view-map-btn" onclick="focusOnMapMarker('${e._id}')">View on Map</button>`;const d=document.createElement("tr");d.innerHTML=`\n      <th class="left_table" data-business-id="${e._id}">\n        ${e.bname} ${c}\n      </th>\n      <th class="left_table">${t}</th>\n      <th class="left_table">${s}</th>\n      <th class="right_table" id="incentives-for-${e._id}">\n        ${o&&!a?"Not in database yet":"Loading incentives..."}\n      </th>\n      <th class="center_table">${l}</th>\n    `,n.appendChild(d),o&&a?fetchChainIncentivesForPlacesResult(e._id,e.chain_id):r||fetchBusinessIncentives(e._id,e.chain_id)}function displayBusinessSearchResults(e,n){try{if(n.innerHTML="",Array.isArray(e)||(console.error("businesses is not an array:",e),e=[]),0===e.length)return n.innerHTML='<div class="error">No businesses found matching your search criteria.</div>',void n.scrollIntoView({behavior:"smooth"});const o=document.createElement("table");o.className="results-table";const t={name:"Business Name",address:"Address",city:"City",state:"State",zip:"Zip",action:"Action"},s=document.createElement("thead");s.innerHTML=`\n      <tr>\n        <th>${t.name}</th>\n        <th>${t.address}</th>\n        <th>${t.city}</th>\n        <th>${t.state}</th>\n        <th>${t.zip}</th>\n        <th>${t.action}</th>\n      </tr>\n    `,o.appendChild(s);const a=document.createElement("tbody");e.forEach((e=>{if(!e)return;const n=document.createElement("tr"),o=!!e.chain_id,s=!!e.is_chain;let i,r="";s?r='<span class="chain-badge">National Chain</span>':o&&(r='<span class="chain-badge">Chain Location</span>'),i=s?checkIfUserIsAdmin()?`<button class="select-business admin-only" data-business-id="${e._id}">Admin: Edit Chain</button>`:`<button class="view-chain-button" data-business-id="${e._id}">View Chain Info</button>`:`<button class="select-business" data-business-id="${e._id}">Select</button>`,n.innerHTML=`\n        <td data-title="${t.name}">${e.bname}</td>\n        <td data-title="${t.address}">${e.address1}${e.address2?"<br>"+e.address2:""}</td>\n        <td data-title="${t.city}">${e.city}</td>\n        <td data-title="${t.state}">${e.state}</td>\n        <td data-title="${t.zip}">${e.zip}</td>\n        <td data-title="${t.action}"><button class="select-business" data-business-id="${e._id}">Select</button></td>\n      `,a.appendChild(n)})),o.appendChild(a),n.appendChild(o),setupBusinessSelectionButtons(n,e),n.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error displaying business search results: "+e);const n=document.getElementById("business-search-results");n?(n.innerHTML=`<div class="error">Error displaying search results: ${e.message}</div>`,n.scrollIntoView({behavior:"smooth"})):alert("Error displaying search results: "+e.message)}}function setupBusinessSelectionButtons(e,n){e.querySelectorAll(".select-business").forEach((e=>{e.addEventListener("click",(function(){const e=this.getAttribute("data-business-id");if(!e)return void console.error("No business ID found on button");const o=n.find((n=>n._id===e));o?(console.log("Selected business: ",o),handleBusinessSelectionByPage(window.location.pathname,o)):console.error("Could not find business with ID: "+e)}))})),e.querySelectorAll(".view-chain-button").forEach((e=>{e.addEventListener("click",(function(){const e=this.getAttribute("data-business-id");if(!e)return;const o=n.find((n=>n._id===e));o&&showChainInfoDialog(o)}))}))}function checkIfUserIsAdmin(){try{const e=localStorage.getItem("patriotThanksSession");if(!e)return!1;const n=JSON.parse(e);return n.user&&(!0===n.user.isAdmin||"Admin"===n.user.level)}catch(e){return console.error("Error checking admin status:",e),!1}}function addChainBadgeStyles(){if(!document.getElementById("chain-badge-css")){const e=document.createElement("style");e.id="chain-badge-css",e.textContent="\n            .chain-badge {\n                display: inline-block;\n                background-color: #4285F4;\n                color: white;\n                padding: 2px 6px;\n                border-radius: 4px;\n                font-size: 0.8em;\n                margin-left: 5px;\n                font-weight: normal;\n            }\n\n            .chain-badge.small {\n                font-size: 0.7em;\n                padding: 1px 4px;\n            }\n            \n            .admin-action-btn {\n                background-color: #673AB7;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .view-chain-btn {\n                background-color: #2196F3;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .add-to-db-btn {\n                background-color: #4CAF50;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .view-map-btn {\n                background-color: #FF9800;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n        ",document.head.appendChild(e)}}function handleBusinessSelectionByPage(e,n){e.includes("incentive-update.html")?(console.log("On incentive-update page"),"function"==typeof window.selectBusinessForIncentive?window.selectBusinessForIncentive(n):"function"==typeof window.selectBusinessForIncentives?window.selectBusinessForIncentives(n):(console.error("selectBusinessForIncentive(s) not found, falling back"),handleBusinessSelection(n))):e.includes("business-update.html")?(console.log("On business-update page"),"function"==typeof window.selectBusinessForUpdate?window.selectBusinessForUpdate(n):(console.error("selectBusinessForUpdate not found, falling back"),handleBusinessSelection(n))):e.includes("incentive-add.html")?(console.log("On incentive-add page"),"function"==typeof window.selectBusinessForIncentive?window.selectBusinessForIncentive(n):handleBusinessSelection(n)):e.includes("incentive-view.html")||e.endsWith("business-search.html")?(console.log("On incentive-view page"),"function"==typeof window.viewBusinessIncentives?window.viewBusinessIncentives(n):handleBusinessSelection(n)):(console.error("Using fallback business selection handler"),handleBusinessSelection(n))}function addResponsiveTableStyles(){if(!document.getElementById("responsive-table-css")){const e=document.createElement("style");e.id="responsive-table-css",e.textContent="\n      /* Base table styles */\n      .results-table {\n        width: 90%;\n        margin: 20px auto;\n        border-collapse: collapse;\n        text-align: left;\n      }\n      \n      .results-table th, .results-table td {\n        border: 1px solid #ddd;\n        padding: 8px;\n      }\n      \n      .results-table th {\n        background-color: #f2f2f2;\n        font-weight: bold;\n        text-align: center;\n      }\n      \n      .results-table tr:nth-child(even) {\n        background-color: #f9f9f9;\n      }\n      \n      .results-table tr:hover {\n        background-color: #f1f1f1;\n      }\n      \n      /* Responsive table for small screens */\n      @media only screen and (max-width: 767px) {\n        .results-table {\n          width: 100%;\n          margin: 10px 0;\n        }\n        \n        .results-table, .results-table thead, .results-table tbody, .results-table tr {\n          display: block;\n        }\n        \n        .results-table thead {\n          display: none;\n        }\n        \n        .results-table tr {\n          border: 1px solid #ccc;\n          margin-bottom: 15px;\n          padding: 8px;\n          background-color: #f9f9f9;\n        }\n        \n        .results-table td {\n          display: block;\n          border: none;\n          border-bottom: 1px solid #eee;\n          padding: 8px;\n          margin-bottom: 6px;\n          text-align: left;\n          position: relative;\n        }\n        \n        .results-table td::before {\n          content: attr(data-title);\n          display: block;\n          font-weight: bold;\n          margin-bottom: 6px;\n          color: #333;\n        }\n        \n        /* Ensure buttons are properly displayed */\n        .select-business {\n          margin: 8px 0;\n          display: inline-block;\n          color: #fff;\n          background-color: #00f;\n          border-radius: 5px;\n          \n        }\n      }\n    ",document.head.appendChild(e)}}function handleBusinessSelection(e){console.log("Handling business selection with fallback: ",e);try{const n=document.getElementById("business-info-section");if(!n)return void console.error("business-info-section not found");document.getElementById("selected-business-id")&&(selectedBusinessId=e._id||""),populateBusinessInfo(e);const o=document.getElementById("incentive-section");o&&(o.style.display="block"),n.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error in handleBusinessSection: "+e),alert("There was an error selecting the business: "+e.message)}}function populateBusinessInfo(e){if(e)try{const n=document.getElementById("bname");n&&(n.value=e.bname||"");const o=document.getElementById("address1");o&&(o.value=e.address1||"");const t=document.getElementById("address2");t&&(t.value=e.address2||"");const s=document.getElementById("city");s&&(s.value=e.city||"");const a=document.getElementById("zip");a&&(a.value=e.zip||"");const i=document.getElementById("phone");i&&(i.value=e.phone||"");const r=document.getElementById("state");if(r){const n=e.state||"";for(let e=0;e<r.options.length;e++)if(r.options[e].value===n){r.selectedIndex=e;break}}const l=document.getElementById("type");if(l){const n=e.type||"";for(let e=0;e<l.options.length;e++)if(l.options[e].value===n){l.selectedIndex=e;break}}console.log("Business info populated successfully")}catch(e){console.error("Error in populateBusinessInfo: "+e)}else console.error("No business data provided to populateBusinessInfo")}function isNotEmpty(e){return""!==e.trim()}function validateField(e,n){console.log(`Validating ${e.id} with value: ${e.value}`),n(e.value)?(e.classList.remove("invalid-field"),e.classList.add("valid-field"),e.setAttribute("data-valid","true"),console.log(`${e.id} is VALID`)):(e.classList.remove("valid-field"),e.classList.add("invalid-field"),e.setAttribute("data-valid","false"),console.log(`${e.id} is INVALID`))}function initBusinessSearch(){console.log("Business search initialization...");const e={businessName:document.getElementById("business-name"),address:document.getElementById("address"),useMyLocation:document.getElementById("use-my-location")},n=document.getElementById("business-search-form");n?n.addEventListener("submit",(function(n){if(n.preventDefault(),!e.businessName?.value&&!e.address?.value&&!e.useMyLocation?.checked)return void alert("Please enter either a business name, an address, or use your current location to search");const o={businessName:e.businessName?.value||"",address:e.address?.value||""};console.log("Form data to submit:",o),mapInitialized||console.warn("Map not initialized yet. Will display businesses after map loads."),clearMarkers();const t=document.getElementById("initial-map-message");t&&t.remove(),retrieveFromMongoDB(o)})):console.warn("Business search form not found in the DOM"),e.businessName&&e.businessName.addEventListener("input",(function(){validateField(this,isNotEmpty)})),e.address&&e.address.addEventListener("input",(function(){validateField(this,isNotEmpty)})),e.useMyLocation&&e.useMyLocation.addEventListener("change",(function(){const n=document.getElementById("location-status");this.checked?(e.address&&(e.address.disabled=!0,e.address.placeholder="Using your current location..."),n&&(n.textContent="Location will be used when you search",n.style.display="block",n.style.color="#666")):(e.address&&(e.address.disabled=!1,e.address.placeholder="Address, City, State, or Zip"),n&&(n.style.display="none"))})),addRefreshButton()}function addRefreshButton(){const e=document.getElementById("business-search-form");if(!e)return;if(document.getElementById("refresh-search-btn"))return;const n=document.createElement("button");n.id="refresh-search-btn",n.type="button",n.className="refresh-btn",n.innerHTML='<i class="fas fa-sync-alt"></i> Refresh Results',n.style.marginLeft="10px",n.style.backgroundColor="#28a745",n.style.color="white",n.style.border="none",n.style.borderRadius="4px",n.style.padding="8px 12px",n.style.cursor="pointer",n.addEventListener("click",(function(){const e=document.getElementById("business-name")?.value||"",n=document.getElementById("address")?.value||"",o=(document.getElementById("use-my-location"),{businessName:e,address:n});clearMarkers();const t=document.getElementById("initial-map-message");t&&t.remove(),this.innerHTML='<i class="fas fa-sync-alt fa-spin"></i> Refreshing...',retrieveFromMongoDB(o),setTimeout((()=>{this.innerHTML='<i class="fas fa-sync-alt"></i> Refresh Results'}),1e3)}));const o=e.querySelector('input[type="submit"]');o&&o.parentNode?o.parentNode.insertBefore(n,o.nextSibling):e.appendChild(n)}function checkForNewlyAddedBusiness(){const e=new URLSearchParams(window.location.search),n=e.get("business_added"),o=e.get("business_name");if("true"===n&&o){showNewBusinessAlert(o);const e=document.getElementById("business-name");e&&(e.value=o,validateField(e,isNotEmpty)),setTimeout((()=>{const e=document.getElementById("business-search-form");if(e){const n=new Event("submit",{cancelable:!0});e.dispatchEvent(n)}}),500)}}function showNewBusinessAlert(e){const n=document.createElement("div");n.className="alert alert-success",n.role="alert",n.style.marginBottom="20px",n.style.animation="fadeIn 0.5s",n.innerHTML=`\n        <strong>Success!</strong> "${e}" has been added to the database. \n        Searching for this business now...\n        <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n            <span aria-hidden="true">&times;</span>\n        </button>\n    `,n.style.backgroundColor="#d4edda",n.style.border="1px solid #c3e6cb",n.style.color="#155724",n.style.borderRadius="4px",n.style.padding="12px 20px";const o=n.querySelector(".close");o&&(o.style.float="right",o.style.fontSize="20px",o.style.fontWeight="bold",o.style.lineHeight="20px",o.style.color="#155724",o.style.opacity="0.5",o.style.cursor="pointer",o.addEventListener("click",(function(){n.remove()})));const t=document.createElement("style");t.textContent="\n        @keyframes fadeIn {\n            from { opacity: 0; transform: translateY(-10px); }\n            to { opacity: 1; transform: translateY(0); }\n        }\n    ",document.head.appendChild(t);const s=document.querySelector("main")||document.body;s.insertBefore(n,s.firstChild),setTimeout((()=>{n.parentNode&&(n.style.animation="fadeOut 0.5s",setTimeout((()=>n.remove()),500))}),8e3)}async function getPlaceDetailsServerSide(e){try{console.log(`Getting place details via server: ${e}`);const n=`${getBaseURL()}/api/places/details/${e}`,o=await fetch(n);if(!o.ok){const e=await o.json();throw new Error(e.message||`Place details failed: ${o.status}`)}const t=await o.json();if(!t.success||!t.place)throw new Error("Place details returned no results");return t.place}catch(e){return console.error("Error getting place details:",e),null}}async function geocodeAddressClientSide(e){try{if(console.log(`Geocoding address client-side: ${e}`),!e)return console.error("No address provided for geocoding"),null;window.google&&window.google.maps||await new Promise(((e,n)=>{const o=setInterval((()=>{window.google&&window.google.maps&&(clearInterval(o),e())}),200);setTimeout((()=>{clearInterval(o),n(new Error("Google Maps API failed to load"))}),1e4)}));const n=new google.maps.Geocoder;return new Promise(((o,t)=>{n.geocode({address:e},(function(e,n){if(n===google.maps.GeocoderStatus.OK&&e[0]){const n=e[0].geometry.location,t={lat:n.lat(),lng:n.lng()};console.log("Client-side geocoding result:",t),o(t)}else console.error("Client-side geocoding failed:",n),t(new Error(`Client-side geocoding failed: ${n}`))}))}))}catch(e){return console.error("Error in client-side geocoding:",e),null}}async function searchPlacesClientSide(e,n,o=5e4){return window.google&&window.google.maps||await new Promise(((e,n)=>{const o=setInterval((()=>{window.google&&window.google.maps&&(clearInterval(o),e())}),200);setTimeout((()=>{clearInterval(o),n(new Error("Google Maps API failed to load"))}),1e4)})),new Promise(((t,s)=>{try{console.log("Using client-side Places API search:",e);let a=document.getElementById("map");a||(console.error("Map element not found, creating temporary map div"),a=document.createElement("div"),a.id="temp-map-div",a.style.display="none",document.body.appendChild(a),map||(map=new google.maps.Map(a,{center:{lat:n.latitude||n.lat||0,lng:n.longitude||n.lng||0},zoom:10})));const i=new google.maps.LatLng(parseFloat(n.latitude)||parseFloat(n.lat)||0,parseFloat(n.longitude)||parseFloat(n.lng)||0),r=new google.maps.places.PlacesService(map),l={query:e,location:i,radius:o};r.textSearch(l,((e,n)=>{if(n===google.maps.places.PlacesServiceStatus.OK&&e&&e.length>0){console.log(`Found ${e.length} places via client-side API`);const n=e.map((e=>e.geometry&&e.geometry.location?{id:e.place_id,place_id:e.place_id,name:e.name,displayName:e.name,formatted_address:e.formatted_address,formattedAddress:e.formatted_address,location:{lat:e.geometry.location.lat(),lng:e.geometry.location.lng()},geometry:{location:e.geometry.location},types:e.types,business_status:e.business_status}:(console.warn("Place missing geometry or location:",e),null))).filter((e=>null!==e));"temp-map-div"===a.id&&document.body.removeChild(a),t(n)}else console.error("Places search failed:",n),"temp-map-div"===a.id&&document.body.removeChild(a),n===google.maps.places.PlacesServiceStatus.ZERO_RESULTS?t([]):s(new Error(`Places search failed: ${n}`))}))}catch(e){console.error("Error in client-side places search:",e),s(e)}}))}function geocodeBusinessAddress(e,n,o){if(!e)return void console.error("Invalid business data for geocoding");if(!(e.address1&&e.city&&e.state&&e.zip)){if(console.error("Incomplete address data for geocoding business:",e.bname||"Unknown"),e.is_chain){console.log("Chain business without address, using default center"),e.lat=CONFIG.defaultCenter.lat,e.lng=CONFIG.defaultCenter.lng;const n=new google.maps.LatLng(e.lat,e.lng);return addAdvancedMarker(e,n),void bounds.extend(n)}return}const t=`${e.address1}, ${e.city}, ${e.state} ${e.zip}`;setTimeout((async()=>{try{(new google.maps.Geocoder).geocode({address:t},(function(s,a){if(a===google.maps.GeocoderStatus.OK){if(s[0]){const t=s[0].geometry.location;if(e.lat=t.lat(),e.lng=t.lng(),addAdvancedMarker(e,t),bounds&&t&&bounds.extend(t),n===o-1){if(bounds&&!bounds.isEmpty())try{map.fitBounds(bounds)}catch(e){console.error("Error fitting bounds:",e),map.setCenter(t),map.setZoom(15)}else map.setCenter(t),map.setZoom(15);1===o&&map.setZoom(15),o>=1&&searchNearbyBusinesses(t,e.type)}}}else console.error("Geocode failed for address "+t+": "+a)}))}catch(e){console.error("Error in geocodeBusinessAddress:",e)}}),n*CONFIG.geocodeDelay)}async function retrieveFromMongoDB(e){try{const n=document.getElementById("business-search-results")||document.getElementById("search_table");n&&(n.innerHTML='<div class="loading-indicator">Searching for businesses...</div>',n.style.display="block");let o=null;if(document.getElementById("use-my-location")&&document.getElementById("use-my-location").checked)try{console.log("Getting user's location for search..."),o=await getUserLocation(),console.log("User location for search:",o)}catch(e){return console.error("Error getting user location:",e),void alert("Unable to get your current location. Please try entering an address instead.")}else if(e.address&&""!==e.address.trim())try{console.log("Geocoding address for search:",e.address);const n=await geocodeAddressClientSide(e.address);if(n&&n.lat&&n.lng)o=n,console.log("Successfully geocoded address to:",o),window.currentSearchLocation=o;else{console.warn("Client-side geocoding failed, trying server-side");const n=`${getBaseURL()}/api/geocode?address=${encodeURIComponent(e.address)}`,t=await fetch(n),s=await t.json();if(!s.success||!s.location)return console.warn("Both client and server geocoding failed"),void alert("We couldn't recognize that address. Please try a more specific address.");o=s.location,console.log("Server-side geocoded location:",o),window.currentSearchLocation=o}}catch(e){return console.error("Error geocoding address:",e),void alert("We had a problem finding that address. Please try a more specific address.")}const t={};e.businessName&&""!==e.businessName.trim()&&(t.business_name=e.businessName),e.address&&""!==e.address.trim()&&(t.address=e.address),o&&o.lat&&o.lng&&(t.lat=o.lat,t.lng=o.lng,t.radius=25),t.ts=(new Date).getTime();const s=new URLSearchParams(t).toString(),a=`${getBaseURL()}/api/business.js?operation=search&${s}`;console.log("Submitting search to API at: ",a);const i=await fetch(a,{method:"GET",headers:{"Content-Type":"application/json; charset=UTF-8","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}});if(console.log("Response status: ",i.status),!i.ok){const e=await i.text();throw console.error("Error response: ",e),new Error(`Failed to retrieve data from MongoDB: ${i.status} ${e}`)}const r=await i.json();if(console.log("Search results from database:",r),clearMarkers(),bounds=new google.maps.LatLngBounds,r.results&&0!==r.results.length){if(o){const e=new google.maps.LatLng(o.lat,o.lng);map.setCenter(e),map.setZoom(11),bounds.extend(e)}if(displayBusinessesOnMap(r.results),document.getElementById("search_table"))displaySearchResults(r.results);else{const e=document.getElementById("business-search-results");e&&displayBusinessSearchResults(r.results,e)}if(o&&o.lat&&o.lng){const e=new google.maps.LatLng(o.lat,o.lng);r.results.length>0&&searchNearbyBusinesses(e,r.results[0].type)}}else console.log("No results in our database, searching Google Places..."),await searchGooglePlaces(e,o)}catch(e){console.error("Search error: ",e);const n=document.getElementById("business-search-results")||document.getElementById("search_table");n?(n.innerHTML=`<div class="error-message">Error searching for businesses: ${e.message}</div>`,n.style.display="block"):alert(`Error searching for businesses: ${e.message}`)}}async function searchGooglePlaces(e,n=null){try{console.log("Searching Google Places for:",e),n&&console.log("Using provided search location:",n);const o=document.getElementById("map");o&&(o.style.display="block",o.style.height="500px");let t="";e.businessName&&(t+=e.businessName),e.address&&(t+=" "+e.address),t=t.trim();const s=document.createElement("div");s.id="map-loading",s.className="loading-indicator",s.innerHTML="Searching for businesses...",o.appendChild(s);let a=null;n?(a=new google.maps.LatLng(n.lat||n.latitude,n.lng||n.longitude),bounds.extend(a),map.setCenter(a),map.setZoom(12)):(a=new google.maps.LatLng(CONFIG.defaultCenter.lat,CONFIG.defaultCenter.lng),bounds.extend(a),console.log("Using default US center for search"));try{if(google.maps.places.Place){console.log("Using newer Places API for search");const e=window.appConfig?.googleMapsApiKey,n={textQuery:t,locationBias:{circle:{center:{latitude:a.lat(),longitude:a.lng()},radius:4e4}}};try{const o=await fetch("https://places.googleapis.com/v1/places:searchText",{method:"POST",headers:{"Content-Type":"application/json","X-Goog-Api-Key":e,"X-Goog-FieldMask":"places.id,places.displayName,places.formattedAddress,places.location,places.types"},body:JSON.stringify(n)}),t=document.getElementById("map-loading");t&&t.remove();const s=await o.json();if(s.places&&s.places.length>0){console.log("Found places via newer Places API:",s.places.length),processPlacesResults(s.places,a);const e=s.places.map((e=>{const n=e.displayName?.text||("string"==typeof e.displayName?e.displayName:"Unknown Business"),o={lat:e.location.latitude,lng:e.location.longitude},t=new google.maps.LatLng(o.lat,o.lng),s=google.maps.geometry.spherical.computeDistanceBetween(a,t);return{_id:"google_"+e.id,bname:n,address1:e.formattedAddress||"",city:"",state:"",zip:"",isGooglePlace:!0,placeId:e.id,lat:o.lat,lng:o.lng,distance:s}}));findChainMatchesForResults(e).then((()=>{e.sort(((e,n)=>e.distance-n.distance)),displaySearchResults(e),bounds&&!bounds.isEmpty()&&map.fitBounds(bounds)}))}else console.log("No places found via newer Places API"),showErrorMessage("No businesses found matching your search criteria.")}catch(e){console.error("Error with newer Places API, falling back to legacy API:",e),fallbackToLegacyPlacesApi(t,a)}}else fallbackToLegacyPlacesApi(t,a)}catch(e){console.error("Error searching places:",e);const n=document.getElementById("map-loading");n&&n.remove(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}catch(e){console.error("Error in searchGooglePlaces:",e),showErrorMessage(`Error searching for businesses: ${e.message}`)}}function fallbackToLegacyPlacesApi(e,n){console.log("Using legacy Places API for search");try{const o=new google.maps.places.PlacesService(map),t={query:e,location:n,radius:4e4};o.textSearch(t,((e,o)=>{const t=document.getElementById("map-loading");if(t&&t.remove(),o===google.maps.places.PlacesServiceStatus.OK&&e&&e.length>0){console.log("Found places via legacy Places API:",e.length);const o=e.map((e=>{const o=e.formatted_address?e.formatted_address.split(","):[];let t="",s="",a="",i="";if(o.length>=1&&(t=o[0].trim()),o.length>=2&&(s=o[1].trim()),o.length>=3){const e=o[2].trim().split(" ");e.length>=1&&(a=e[0].trim()),e.length>=2&&(i=e[1].trim())}const r=e.geometry.location,l=google.maps.geometry.spherical.computeDistanceBetween(n,r),c={_id:"google_"+e.place_id,bname:e.name,address1:t,city:s,state:a,zip:i,formattedAddress:e.formatted_address,type:mapGooglePlaceTypeToBusinessType(e.types),phone:e.formatted_phone_number||"",isGooglePlace:!0,placeId:e.place_id,lat:e.geometry.location.lat(),lng:e.geometry.location.lng(),distance:l};return addAdvancedMarker(c,r),bounds.extend(r),c}));findChainMatchesForResults(o).then((()=>{o.sort(((e,n)=>e.distance-n.distance)),displaySearchResults(o),bounds&&!bounds.isEmpty()&&map.fitBounds(bounds)}))}else console.log("No places found via legacy Places API:",o),showErrorMessage("No businesses found matching your search criteria.")}))}catch(e){console.error("Error using legacy Places API:",e),showErrorMessage(`Error searching for businesses: ${e.message}`)}}function displayBusinessesOnMap(e){if(!map)return businessesToDisplayOnMap=e,void console.log("Map not ready, storing businesses for later display");console.log("Displaying businesses on map:",e.length),clearMarkers(),bounds||(bounds=new google.maps.LatLngBounds),e.forEach((e=>{try{if(!e)return void console.error("Invalid business data");let n=null;if(!e.isGooglePlace&&e.location&&e.location.coordinates){const o=e.location.coordinates;console.log("Database business coordinates:",o),Array.isArray(o)&&o.length>=2&&(n={lat:parseFloat(o[1]),lng:parseFloat(o[0])},console.log(`Creating marker for ${e.bname} at [${n.lat}, ${n.lng}]`))}else if(!e.isGooglePlace&&e.lat&&e.lng)n={lat:parseFloat(e.lat),lng:parseFloat(e.lng)},console.log(`Creating marker for ${e.bname} at [${n.lat}, ${n.lng}]`);else if(e.isGooglePlace)if(e.lat&&e.lng)n={lat:parseFloat(e.lat),lng:parseFloat(e.lng)},console.log(`Creating marker for ${e.bname} at [${n.lat}, ${n.lng}]`);else if(e.geometry&&e.geometry.location){const o=e.geometry.location;n="function"==typeof o.lat?{lat:o.lat(),lng:o.lng()}:o,console.log(`Creating marker for ${e.bname} at [${n.lat}, ${n.lng}]`)}if(!n||isNaN(n.lat)||isNaN(n.lng))return void console.warn(`Skipping business ${e.bname} - invalid coordinates`);if(addAdvancedMarker(e,n,e.isNearby||!1,e.isGooglePlace||!1)){const e=new google.maps.LatLng(n.lat,n.lng);bounds.extend(e)}}catch(n){console.error("Error adding business to map:",n,e)}})),setTimeout((()=>{updateMapBounds()}),500)}function updateMapBounds(){if(map&&bounds)try{bounds.isEmpty()?window.currentSearchLocation&&(console.log("Centering on search location:",window.currentSearchLocation),map.setCenter(new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng)),map.setZoom(11)):(console.log("Fitting map to bounds"),map.fitBounds(bounds),google.maps.event.addListenerOnce(map,"bounds_changed",(function(){map.getZoom()>15&&map.setZoom(15),map.getZoom()<4&&map.setZoom(4)})))}catch(e){console.error("Error updating map bounds:",e)}}function mapGooglePlaceTypeToBusinessType(e){return e&&Array.isArray(e)?e.includes("restaurant")||e.includes("meal_takeaway")||e.includes("cafe")||e.includes("bakery")||e.includes("bar")?"REST":e.includes("grocery_or_supermarket")||e.includes("supermarket")?"GROC":e.includes("gas_station")?"FUEL":e.includes("hardware_store")?"HARDW":e.includes("department_store")?"DEPT":e.includes("convenience_store")?"CONV":e.includes("clothing_store")||e.includes("shoe_store")?"CLTH":e.includes("electronics_store")?"ELEC":e.includes("computer_store")?"TECH":e.includes("furniture_store")?"FURN":e.includes("store")?"RETAIL":e.includes("drugstore")||e.includes("pharmacy")?"RX":e.includes("car_dealer")||e.includes("car_repair")||e.includes("car_wash")?"AUTO":e.includes("beauty_salon")||e.includes("hair_care")||e.includes("spa")?"BEAU":e.includes("book_store")||e.includes("library")?"BOOK":e.includes("movie_theater")||e.includes("amusement_park")||e.includes("aquarium")||e.includes("art_gallery")||e.includes("museum")||e.includes("zoo")?"ENTR":e.includes("sporting_goods_store")||e.includes("gym")?"SPRT":e.includes("jewelry_store")?"JEWL":e.includes("home_goods_store")||e.includes("gift_shop")?"GIFT":e.includes("health")||e.includes("doctor")||e.includes("dentist")||e.includes("hospital")?"HEAL":e.includes("point_of_interest")?"SPEC":e.includes("establishment")?"SERV":"OTHER":"OTHER"}async function findChainMatchesForResults(e){const n=e.map((e=>findMatchingChainForPlaceResult(e.bname).then((n=>{if(n){console.log(`Found matching chain for place: ${e.bname}`);const o=e.address1,t=e.city,s=e.state,a=e.zip,i=e.phone,r=e.formattedAddress;e.chain_id=n._id,e.chain_name=n.bname,e.is_from_places_api=!0,e.address1=o,e.city=t,e.state=s,e.zip=a,e.phone=i,e.formattedAddress=r,console.log(`Nearby place "${e.bname}" matches chain: ${n.bname}`)}return e})).catch((n=>(console.error(`Error matching chain for ${e.bname}:`,n),e)))));return await Promise.all(n),e}async function getChainDetails(e){if(!e)return null;const n=getBaseURL();try{const o=await fetch(`${n}/api/business.js?operation=get&id=${e}`);if(!o.ok)throw new Error(`Failed to get chain details: ${o.status}`);const t=await o.json();return t.result?t.result:null}catch(e){return console.error("Error getting chain details:",e),null}}async function searchPlacesWithTextSearch(e,n,o){try{const t=getGoogleMapsApiKey();if(!t)throw console.error("No Google Maps API key found"),new Error("Google Maps API key is missing");const s={textQuery:e||"businesses"};n&&(s.locationBias={circle:{center:{latitude:n.latitude,longitude:n.longitude},radius:o}}),console.log("Making Places API request with:",{query:s.textQuery,location:n?`${n.latitude},${n.longitude}`:"not provided",radius:o});const a=await fetch("https://places.googleapis.com/v1/places:searchText",{method:"POST",headers:{"Content-Type":"application/json","X-Goog-Api-Key":t,"X-Goog-FieldMask":"places.id,places.displayName,places.formattedAddress,places.location,places.types,places.primaryType,places.nationalPhoneNumber"},body:JSON.stringify(s)}),i=await a.json();if(i.error)throw console.error("Places API error:",i.error),new Error(`Places API error: ${i.error.message}`);return console.log("Places API response:",i),i.places||[]}catch(e){throw console.error("Error in searchPlacesWithTextSearch:",e),e}}function showErrorMessage(e,n){const o=n||document.getElementById("search_table");if(o){o.style.display="block";const n=o.querySelector("tbody");n?n.innerHTML=`<tr><td colspan="5" class="text-center error-message">${e}</td></tr>`:o.innerHTML=`<div class="error-message">${e}</div>`,o.scrollIntoView({behavior:"smooth"})}else alert(e)}function showChainInfoDialog(e){try{console.log("Showing chain info dialog for:",e.bname);const n=`\n            <div class="modal fade" id="chainInfoModal" tabindex="-1" role="dialog" aria-labelledby="chainInfoModalLabel" aria-hidden="true">\n                <div class="modal-dialog modal-lg" role="document">\n                    <div class="modal-content">\n                        <div class="modal-header">\n                            <h5 class="modal-title" id="chainInfoModalLabel">Chain Information: ${e.bname}</h5>\n                            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">\n                                <span aria-hidden="true">&times;</span>\n                            </button>\n                        </div>\n                        <div class="modal-body">\n                            <div class="alert alert-info">\n                                <p><strong>${e.bname}</strong> is a national chain business in the Patriot Thanks database.</p>\n                                <p>Chain businesses can only be modified by administrators, but chain incentives apply to all locations nationwide.</p>\n                            </div>\n                            <div class="business-details">\n                                <p><strong>Business Type:</strong> ${getBusinessTypeLabel(e.type)}</p>\n                                <p>Chain incentives will be displayed for businesses that match this chain, even if they are not in the database.</p>\n                            </div>\n                            <div class="chain-incentives">\n                                <h4>Chain Incentives</h4>\n                                <div class="loading-incentives">Loading chain incentives...</div>\n                            </div>\n                        </div>\n                        <div class="modal-footer">\n                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `,o=document.getElementById("chainInfoModal");o&&o.remove();const t=document.createElement("div");t.innerHTML=n,document.body.appendChild(t.firstChild);const s=document.getElementById("chainInfoModal");if("undefined"!=typeof bootstrap&&bootstrap.Modal)new bootstrap.Modal(s).show();else try{if("undefined"!=typeof $&&$.fn.modal)$(s).modal("show");else{s.style.display="block",s.classList.add("show");const e=document.createElement("div");e.className="modal-backdrop show",document.body.appendChild(e),s.querySelectorAll('[data-bs-dismiss="modal"]').forEach((n=>{n.addEventListener("click",(function(){s.style.display="none",s.classList.remove("show"),document.body.removeChild(e)}))}))}}catch(n){console.error("Error showing modal with jQuery fallback:",n),alert(`Chain Information: ${e.bname} is a national chain business that can only be modified by administrators.`)}fetchChainIncentives(e._id)}catch(n){console.error("Error in showChainInfoDialog:",n),alert(`Chain Information: ${e.bname} is a national chain business that can only be modified by administrators.`)}}function fetchChainIncentives(e){const n=getBaseURL();fetch(`${n}/api/combined-api.js?operation=incentives&business_id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to fetch incentives: ${e.status}`);return e.json()})).then((e=>{const n=document.querySelector(".chain-incentives");if(!n)return;const o=n.querySelector(".loading-incentives");if(o&&o.remove(),!e.results||0===e.results.length)return void(n.innerHTML+='<div class="alert alert-warning">No chain-wide incentives found.</div>');let t='<div class="list-group">';e.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"";let s=e.amount+"%";"dollar"===e.discount_type&&(s="$"+e.amount.toFixed(2)),t+=`\n                        <div class="list-group-item">\n                            <div class="d-flex w-100 justify-content-between">\n                                <h5 class="mb-1">${n}${o}</h5>\n                                <span class="badge bg-primary">${s}</span>\n                            </div>\n                            <p class="mb-1">${e.information||"No additional information available."}</p>\n                        </div>\n                    `}})),t+="</div>",n.innerHTML+=t})).catch((e=>{console.error("Error fetching chain incentives:",e);const n=document.querySelector(".chain-incentives");n&&(n.innerHTML+=`<div class="alert alert-danger">Error loading chain incentives: ${e.message}</div>`)}))}function processPlaceResults(e,n){if(!e||0===e.length)return console.log("No places to process"),[];const o=new google.maps.LatLng(n.latitude,n.longitude);bounds=new google.maps.LatLngBounds,bounds.extend(o);const t=[];return e.forEach(((e,n)=>{try{if(!e.geometry||!e.geometry.location)return void console.warn("Place missing location data:",e);const n=e.formatted_address?e.formatted_address.split(","):[];let s="",a="",i="",r="";if(n.length>=1&&(s=n[0].trim()),n.length>=2&&(a=n[1].trim()),n.length>=3){const e=n[2].trim().split(" ");e.length>=1&&(i=e[0].trim()),e.length>=2&&(r=e[1].trim())}let l,c="OTHER";if(e.types&&(e.types.includes("restaurant")?c="REST":e.types.includes("store")?c="RETAIL":e.types.includes("hardware_store")?c="HARDW":e.types.includes("gas_station")?c="FUEL":e.types.includes("grocery_or_supermarket")?c="GROC":e.types.includes("electronics_store")?c="ELEC":e.types.includes("department_store")&&(c="DEPT")),e.geometry&&e.geometry.location)l="function"==typeof e.geometry.location.lat?e.geometry.location:new google.maps.LatLng(e.geometry.location.lat,e.geometry.location.lng);else{if(!e.location||"number"!=typeof e.location.lat)return void console.warn("Could not determine location for place:",e);l=new google.maps.LatLng(e.location.lat,e.location.lng)}const d=google.maps.geometry.spherical.computeDistanceBetween(o,l);if(markers.some((n=>!!n.business&&(n.business.placeId===e.place_id||n.business.placeId===e.id||n.business._id==="google_"+e.place_id||n.business._id==="google_"+e.id))))return void console.log("Skipping duplicate place:",e.name);const p={_id:"google_"+(e.place_id||e.id),bname:e.name||e.displayName||"Unknown Business",address1:s,city:a,state:i,zip:r,type:c,phone:e.formatted_phone_number||e.nationalPhoneNumber||"",isGooglePlace:!0,placeId:e.place_id||e.id,lat:l.lat(),lng:l.lng(),distance:d};addAdvancedMarker(p,l),bounds.extend(l),t.push(p)}catch(n){console.error("Error processing place:",n,e)}})),console.log("Processed",t.length,"places into business objects"),t}function ensureMapVisibility(){const e=document.getElementById("map");e&&(e.style.display="block",e.style.height="500px",console.log("Map container dimensions:",e.offsetWidth,"x",e.offsetHeight),mapInitialized&&map&&(google.maps.event.trigger(map,"resize"),markers.length>0&&(bounds||(bounds=new google.maps.LatLngBounds),markers.forEach((e=>{e&&e.position&&bounds.extend(e.position)})),bounds.isEmpty()?1===markers.length&&markers[0].position&&(map.setCenter(markers[0].position),map.setZoom(15),console.log("Centered on single marker")):(map.fitBounds(bounds),console.log("Fitted map to bounds for",markers.length,"markers")))))}function showGooglePlaceInfoWindow(e,n){console.log("Showing Google Place info window for",e.bname),infoWindow||(infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1}));const o=e.address2?`${e.address1}<br>${e.address2}<br>${e.city}, ${e.state} ${e.zip}`:`${e.address1}<br>${e.city}, ${e.state} ${e.zip}`,t=getBusinessTypeLabel(e.type),s=e.distance?`<p><strong>Distance:</strong> ${(e.distance/1609.34).toFixed(1)} miles</p>`:"",a=`\n    <div class="info-window">\n        <h3>${e.bname}</h3>\n        <p><strong>Address:</strong><br>${o}</p>\n        ${e.phone?`<p><strong>Phone:</strong> ${e.phone}</p>`:""}\n        ${s}\n        <p><strong>Type:</strong> ${t}</p>\n        <p><strong>Status:</strong> This business is not yet in the Patriot Thanks database.</p>\n        <div class="info-window-actions">\n            <button class="add-business-btn" \n                    onclick="window.addBusinessToDatabase('${e.placeId}')">\n                Add to Patriot Thanks\n            </button>\n        </div>\n    </div>\n    `;infoWindow.setContent(a),applyInfoWindowScrollableStyles(),n.lat&&"function"==typeof n.lat?infoWindow.setPosition(n):infoWindow.setPosition(new google.maps.LatLng(n.lat,n.lng)),infoWindow.open(map),google.maps.event.addListener(infoWindow,"domready",(function(){console.log("Google Place info window DOM ready, forcing scrollable behavior");const e=document.querySelector(".gm-style-iw");if(e){const n=e.querySelector(".gm-style-iw-d");n&&(n.style.overflow="auto",n.style.maxHeight="350px")}})),console.log("Opened Google Place info window")}async function initAdvancedMarkers(){try{if(addCustomMarkerStyles(),!document.querySelector('link[href*="font-awesome"]')){console.warn("Font Awesome might not be loaded - adding fallback");const e=document.createElement("link");e.rel="stylesheet",e.href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css",document.head.appendChild(e)}return await google.maps.importLibrary("marker"),console.log("Advanced marker library loaded successfully"),!0}catch(e){return console.error("Error initializing advanced markers:",e),!1}}function addInitialMapMessage(e){const n=document.createElement("div");n.id="initial-map-message",n.innerHTML="Search for businesses to see them on the map",n.style.position="absolute",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.background="white",n.style.padding="10px",n.style.borderRadius="5px",n.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)",n.style.zIndex="1",e.appendChild(n)}function setupResetMapButton(){const e=document.getElementById("reset-map");e&&e.addEventListener("click",resetMapView)}function resetMapView(){mapInitialized&&map?(map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom),infoWindow&&infoWindow.close()):console.error("Cannot reset map view - map not initialized")}async function setupMapClickHandler(){if(map){console.log("Setting up map click handler");try{const{Place:e}=await google.maps.importLibrary("places");map.addListener("click",(async function(n){if(console.log("Map clicked",n),n.placeId){n.stop(),console.log("POI clicked, placeId:",n.placeId);try{const o=markers.find((e=>e.business&&(e.business.placeId===n.placeId||e.business._id==="google_"+n.placeId)));if(o)return console.log("Found existing marker for clicked place"),void showInfoWindow(o);const t=new e({id:n.placeId});await t.fetchFields({fields:["displayName","formattedAddress","location","types","businessStatus","nationalPhoneNumber"]}),console.log("Place details:",t);const s=t.displayName||"";let a=null;try{a=await findMatchingChainForPlaceResult(s)}catch(e){console.error("Error checking for chain match:",e)}const i={_id:"google_"+t.id,bname:s,address1:t.formattedAddress||"",city:"",state:"",zip:"",isGooglePlace:!0,placeId:t.id,lat:t.location?.lat||0,lng:t.location?.lng||0};if(a&&(console.log(`POI "${s}" matches chain: ${a.bname}`),i.chain_id=a._id,i.chain_name=a.bname,i.isChainLocation=!0),t.location&&window.currentSearchLocation){const e=google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(t.location.lat,t.location.lng),new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng));i.distance=e}showInfoWindow({business:i,position:t.location?new google.maps.LatLng(t.location.lat,t.location.lng):n.latLng})}catch(e){console.error("Error fetching place details:",e),alert("Error loading place details. Please try again.")}}})),console.log("Map click handler set up")}catch(e){console.error("Error setting up map click handler:",e)}}else console.error("Map not initialized in setupMapClickHandler")}function setupMarkerClickPriority(){map?(console.log("Setting up marker click priority"),google.maps.event.addListener(map,"click",(function(e){if(e.placeId){const n=e.latLng,o=20,t=map.getProjection();if(!t)return;const s=Math.pow(2,map.getZoom()),a=t.fromLatLngToPoint(n);for(const n of markers){if(!n.position)continue;const i=n.position,r=t.fromLatLngToPoint(i);if(Math.sqrt(Math.pow((a.x-r.x)*s,2)+Math.pow((a.y-r.y)*s,2))<=o)return console.log("Preventing POI click, using our marker instead"),e.stop(),void setTimeout((()=>{showInfoWindow(n)}),10)}}}),{passive:!1})):console.error("Map not initialized, cannot set up click priority")}function initAdditionalMapFeatures(){console.log("Initializing additional map features"),addCustomMarkerStyleFixes(),setupMarkerClickPriority(),customizeInfoWindows()}function addCustomMarkerStyleFixes(){if(!document.getElementById("marker-style-fixes")){const e=document.createElement("style");e.id="marker-style-fixes",e.textContent="\n            /* Ensure icon is properly displayed inside marker */\n            .marker-icon {\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                width: 20px;\n                height: 20px;\n                color: #333;\n            }\n            \n            /* Fix for Font Awesome icons inside markers */\n            .marker-icon i {\n                font-size: 12px !important;\n                color: #333 !important;\n            }\n            \n            /* Info window action button specific styling */\n            .info-window-actions .view-details-btn {\n                margin-top: 8px;\n            }\n        ",document.head.appendChild(e)}}function applyInfoWindowScrollableStyles(){if(!document.getElementById("info-window-scrollable-styles")){const e=document.createElement("style");e.id="info-window-scrollable-styles",e.textContent="\n            /* Info window structure */\n            .gm-style .gm-style-iw-c {\n                padding: 0 !important;\n                border-radius: 8px !important;\n                box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n                max-width: 330px !important;\n                max-height: 400px !important;\n                overflow: hidden !important;\n            }\n            \n            .gm-style .gm-style-iw-d {\n                overflow: auto !important;\n                max-height: 350px !important;\n                padding-right: 8px !important; /* Allow space for scrollbar */\n            }\n            \n            /* Custom info window styles */\n            .info-window {\n                padding: 12px;\n                max-width: 300px;\n            }\n            \n            .info-window h3 {\n                margin-top: 0;\n                margin-bottom: 10px;\n                color: #212121;\n                font-size: 16px;\n                line-height: 1.3;\n            }\n            \n            .info-window p {\n                margin: 6px 0;\n                font-size: 14px;\n                line-height: 1.4;\n            }\n            \n            .info-window-actions {\n                margin-top: 12px;\n                padding-top: 8px;\n                border-top: 1px solid #eee;\n                text-align: right;\n            }\n            \n            .add-business-btn {\n                background-color: #EA4335;\n                color: white;\n                border: none;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                margin-top: 5px;\n                font-size: 13px;\n                font-weight: 500;\n            }\n            \n            .add-business-btn:hover {\n                background-color: #D32F2F;\n            }\n            \n            .view-details-btn {\n                background-color: #4285F4;\n                color: white;\n                border: none;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                margin-top: 5px;\n                font-size: 13px;\n                font-weight: 500;\n            }\n            \n            .view-details-btn:hover {\n                background-color: #2A75F3;\n            }\n            \n            /* Incentives list */\n            .incentives-list {\n                margin: 8px 0;\n                padding-left: 20px;\n            }\n            \n            .incentives-list li {\n                margin-bottom: 6px;\n            }\n            \n            /* Custom scrollbar styles */\n            .gm-style .gm-style-iw-d::-webkit-scrollbar {\n                width: 6px;\n                height: 6px;\n            }\n            \n            .gm-style .gm-style-iw-d::-webkit-scrollbar-track {\n                background: #f1f1f1;\n                border-radius: 3px;\n            }\n            \n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb {\n                background: #c1c1c1;\n                border-radius: 3px;\n            }\n            \n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb:hover {\n                background: #a8a8a8;\n            }\n            \n            /* Close button adjustment */\n            .gm-ui-hover-effect {\n                top: 2px !important;\n                right: 2px !important;\n            }\n        ",document.head.appendChild(e)}}function customizeInfoWindows(){applyInfoWindowScrollableStyles();const e=document.createElement("style");e.textContent="\n        /* Make close button more visible */\n        .gm-ui-hover-effect {\n            opacity: 0.8 !important;\n            width: 24px !important;\n            height: 24px !important;\n            right: 2px !important;\n            top: 2px !important;\n        }\n        \n        .gm-ui-hover-effect span {\n            width: 16px !important;\n            height: 16px !important;\n        }\n        \n        .gm-ui-hover-effect:hover {\n            opacity: 1 !important;\n        }\n    ",document.head.appendChild(e)}async function handleBusinessSearch(e,n){console.log("Business search API hit:",e.method),console.log("Query parameters:",e.query);try{try{await connect,console.log("Database connection established")}catch(e){return console.error("Database connection error:",e),n.status(500).json({message:"Database connection error",error:e.message})}const o={},t=e.query.business_name||e.query.businessName||"",s=e.query.address||"";if(console.log("Business name value:",t),console.log("Address value:",s),t&&""!==t.trim()){const e=new RegExp(t.trim().replace(/\s+/g,".*"),"i");o.bname=e}if(s&&""!==s.trim()){const e={$regex:s.trim(),$options:"i"};o.$or=[{address1:e},{address2:e},{city:e},{state:e},{zip:e}]}let a=null;if(e.query.lat&&e.query.lng){const n=parseFloat(e.query.lat),t=parseFloat(e.query.lng),s=parseInt(e.query.radius)||25;a={lat:n,lng:t};const i=1609.34*s;o.location={$near:{$geometry:{type:"Point",coordinates:[t,n]},$maxDistance:i}},console.log(`Performing location-based search at [${n},${t}] with radius ${s} miles`)}console.log("MongoDB Query:",JSON.stringify(o,null,2));let i=await Business.find(o).lean();if(console.log("Found",i.length,"matching businesses in database"),t&&""!==t.trim()&&i.length<2){const n=new RegExp(t.trim(),"i"),o=await Business.find({is_chain:!0,bname:n}).lean();if(console.log(`Found ${o.length} chain businesses matching "${t}"`),o.length>0)for(const n of o){let o={chain_id:n._id};if(a){const n=1609.34*(parseInt(e.query.radius)||25);o.location={$near:{$geometry:{type:"Point",coordinates:[a.lng,a.lat]},$maxDistance:n}}}const t=await Business.find(o).lean();console.log(`Found ${t.length} locations for chain ${n.bname}`);for(const e of t)i.some((n=>n._id.toString()===e._id.toString()))||(e.chain_info={name:n.bname,id:n._id},i.push(e))}}return n.status(200).json({message:"Search successful",results:i})}catch(e){return console.error("Search error:",e),n.status(500).json({message:"Server error during search: "+e.message})}}function similarity(e,n){if(!e||!n)return 0;const o=e.length>n.length?e:n,t=e.length>n.length?n:e;return 0===o.length?1:(o.length-editDistance(o,t))/parseFloat(o.length)}function editDistance(e,n){e=e.toLowerCase(),n=n.toLowerCase();const o=[];for(let t=0;t<=e.length;t++){let s=t;for(let a=0;a<=n.length;a++)if(0===t)o[a]=a;else if(a>0){let i=o[a-1];e.charAt(t-1)!==n.charAt(a-1)&&(i=Math.min(Math.min(i,s),o[a])+1),o[a-1]=s,s=i}t>0&&(o[n.length]=s)}return o[n.length]}function createEnhancedInfoWindow(){const e=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1});return google.maps.event.addListener(e,"domready",(function(){console.log("Info window DOM ready, applying styles"),setTimeout((()=>{const e=document.querySelectorAll(".info-window-scrollable");e.length>0&&(console.log("Found scrollable elements, adjusting height"),e.forEach((e=>{const n=e.querySelector(".incentives-list");n&&n.offsetHeight>150&&(console.log("Large content detected, ensuring scrollable"),e.style.overflowY="auto")})))}),100)})),e}function createMarker(e,n,o=!1,t=!1){console.log(`Creating marker for ${e.bname} at [${n.lat}, ${n.lng}]`);try{try{if(void 0===google.maps.marker||void 0===google.maps.marker.AdvancedMarkerElement)throw new Error("Advanced Markers API not available");const t=document.createElement("div");t.className="custom-marker";const s=o?"nearby":"primary",a=o?CONFIG.markerColors.nearby:CONFIG.markerColors.primary,i=getBusinessTypeTextIcon(e.type||"store");t.innerHTML=`\n                <div class="marker-container">\n                    <div class="marker-pin ${s}" style="background-color: ${a};">\n                        <div class="marker-icon">\n                            ${i}\n                        </div>\n                    </div>\n                    <div class="marker-shadow"></div>\n                </div>\n            `;const r=new google.maps.marker.AdvancedMarkerElement({position:n,map,title:e.bname||"Business",content:t});return r.business=e,r.isNearby=o,r.position=n,t.addEventListener("click",(function(){showInfoWindow(r)})),r}catch(e){console.log("Advanced marker creation failed, falling back to standard marker:",e)}const t=new google.maps.Marker({position:n,map,title:e.bname||"Business",icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:o?CONFIG.markerColors.nearby:CONFIG.markerColors.primary,fillOpacity:1,strokeWeight:1,strokeColor:"#FFFFFF",scale:10}});return t.business=e,t.isNearby=o,t.addListener("click",(function(){showInfoWindow(t)})),t}catch(e){return console.error("Error creating marker:",e),null}}function positionInfoWindowAtMarker(e,n){const o=document.getElementById("map");if(!o||!map)return void console.error("Map container or map not found");let t;if(e.getPosition)t=e.getPosition();else{if(!e.position)return void console.error("Could not determine marker position");t=e.position}const s=map.getProjection();if(!s){const e=o.getBoundingClientRect();return n.style.top=e.height/2-150+"px",void(n.style.left=e.width/2-150+"px")}try{const e=s.fromLatLngToPoint(t),o=map.getDiv().getBoundingClientRect(),a=s.fromLatLngToPoint(map.getBounds().getNorthEast()),i=s.fromLatLngToPoint(map.getBounds().getSouthWest()),r=Math.pow(2,map.getZoom()),l=(e.x-i.x)*r,c=(e.y-a.y)*r;n.style.top=c-20+"px",n.style.left=l+20+"px";const d=n.getBoundingClientRect(),p=d.width||300,g=d.height||300;l+p+30>o.width&&(n.style.left=l-p-20+"px"),c+g+20>o.height&&(n.style.top=o.height-g-20+"px"),parseInt(n.style.top)<10&&(n.style.top="10px"),parseInt(n.style.left)<10&&(n.style.left="10px")}catch(e){console.error("Error positioning info window:",e),n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)"}}function fetchBusinessIncentivesForInfoWindow(e){if(!e)return void console.error("No business ID provided for fetching incentives");const n=document.getElementById(`info-window-incentives-${e}`);if(!n)return void console.error(`Could not find incentives div for business ${e}`);const o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${e}`;console.log("Fetching incentives from:",o),fetch(o).then((e=>{if(!e.ok)throw new Error(`Failed to fetch incentives: ${e.status}`);return e.json()})).then((o=>{if(console.log(`Incentives data for business ${e}:`,o),!o.results||0===o.results.length)return void(n.innerHTML="<p><strong>Incentives:</strong> No incentives found</p>");let t='<p><strong>Incentives:</strong></p><ul class="incentives-list">';o.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"",s=e.is_chain_wide?'<span class="chain-badge small">Chain-wide</span>':"";t+=`\n                        <li>\n                            <strong>${n}${o}:</strong> ${e.amount}% ${s}\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </li>\n                    `}})),t+="</ul>",n.innerHTML='<p><strong>Incentives:</strong></p><ul class="incentives-list"></ul>'===t?"<p><strong>Incentives:</strong> No active incentives found</p>":t})).catch((e=>{console.error(`Error fetching incentives: ${e}`),n.innerHTML="<p><strong>Incentives:</strong> Error loading incentives</p>"}))}function fetchChainIncentivesForInfoWindow(e,n){if(!n)return void console.error("No chain ID provided for fetching incentives");const o=document.getElementById(`info-window-incentives-${e}`);if(!o)return void console.error(`Could not find incentives div for place ${e}`);const t=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${n}`;console.log("Fetching chain incentives from:",t),fetch(t).then((e=>{if(!e.ok)throw new Error(`Failed to fetch chain incentives: ${e.status}`);return e.json()})).then((n=>{if(console.log(`Chain incentives data for place ${e}:`,n),!n.results||0===n.results.length)return void(o.innerHTML="<p><strong>Chain Incentives:</strong> No incentives found</p>");let t='<p><strong>Chain Incentives:</strong></p><ul class="incentives-list">';n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"",s='<span class="chain-badge small">Chain-wide</span>';t+=`\n                        <li>\n                            <strong>${n}${o}:</strong> ${e.amount}% ${s}\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </li>\n                    `}})),t+="</ul>",t+=`\n                <div class="chain-location-message" style="margin-top: 10px; font-style: italic; color: #666;">\n                    This location matches ${n.chain_info?n.chain_info.bname:"a chain"} in our database.\n                    Chain-wide incentives apply to all locations.\n                </div>\n            `,o.innerHTML=t})).catch((e=>{console.error(`Error fetching chain incentives: ${e}`),o.innerHTML="<p><strong>Chain Incentives:</strong> Error loading incentives</p>"}))}function getIncentiveTypeLabel(e){return{VT:"Veteran",AD:"Active Duty",FR:"First Responder",SP:"Spouse",OT:"Other"}[e]||e}function getBaseURL(){return"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:window.location.origin}function createFallbackMarker(e,n){try{let o;if(n.lat&&"function"==typeof n.lat)o={lat:n.lat(),lng:n.lng()};else if("number"==typeof n.lat)o=n;else{if(!e.lat||!e.lng)return console.error("Invalid location for fallback marker:",n),null;o={lat:e.lat,lng:e.lng}}const t=String(e.bname||"Business"),s=!0===e.isNearby,a=s?CONFIG.markerColors.nearby:CONFIG.markerColors.primary,i=new google.maps.Marker({position:new google.maps.LatLng(o.lat,o.lng),map,title:t,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:a,fillOpacity:1,strokeWeight:1,strokeColor:"#FFFFFF",scale:10},animation:google.maps.Animation.DROP});return i.business=e,i.isNearby=s,i.position=o,i.addListener("click",(function(){showInfoWindow(i)})),markers.push(i),console.log(`Added fallback marker for ${t}`),i}catch(e){return console.error("Error creating fallback marker:",e),null}}function fallbackCreateStandardMarker(e){if(!e||!e.lat||!e.lng)return console.error("Invalid business data for fallback marker:",e),null;console.log(`Creating fallback standard marker for ${e.bname}`);const n={lat:e.lat,lng:e.lng},o=!0===e.isNearby?CONFIG.markerColors.nearby:CONFIG.markerColors.primary,t=new google.maps.Marker({position:n,map,title:e.bname,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:o,fillOpacity:1,strokeWeight:1,strokeColor:"#FFFFFF",scale:10},animation:google.maps.Animation.DROP});return t.business=e,t.addListener("click",(function(){console.log(`Fallback marker clicked for: ${e.bname}`),showInfoWindow(t)})),markers.push(t),console.log(`Successfully added fallback marker for ${e.bname} - Markers count: ${markers.length}`),t}function getBusinessTypeIconHTML(e){return{AUTO:'<i class="fas fa-car" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',BEAU:'<i class="fas fa-spa" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',BOOK:'<i class="fas fa-book" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',CLTH:'<i class="fas fa-tshirt" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',CONV:'<i class="fas fa-store" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',DEPT:'<i class="fas fa-shopping-bag" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',ELEC:'<i class="fas fa-bolt" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',ENTR:'<i class="fas fa-film" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',FURN:'<i class="fas fa-couch" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',FUEL:'<i class="fas fa-gas-pump" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',GIFT:'<i class="fas fa-gift" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',GROC:'<i class="fas fa-shopping-cart" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',HARDW:'<i class="fas fa-hammer" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',HEAL:'<i class="fas fa-heartbeat" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',JEWL:'<i class="fas fa-gem" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',OTHER:'<i class="fas fa-store-alt" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',RX:'<i class="fas fa-prescription-bottle-alt" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',REST:'<i class="fas fa-utensils" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',RETAIL:'<i class="fas fa-shopping-basket" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',SERV:'<i class="fas fa-concierge-bell" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',SPEC:'<i class="fas fa-star" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',SPRT:'<i class="fas fa-football-ball" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',TECH:'<i class="fas fa-laptop" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>',TOYS:'<i class="fas fa-gamepad" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>'}[e]||'<i class="fas fa-store" aria-hidden="true" style="color: white !important; display: inline-block !important;"></i>'}function getBusinessTypeIcon(e){const n={AUTO:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/car_repair-71.png",BEAU:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/spa-71.png",BOOK:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/shopping-71.png",CLTH:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/shopping-71.png",CONV:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/convenience-71.png",DEPT:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/shopping-71.png",ELEC:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/electronics-71.png",ENTR:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/movies-71.png",FURN:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/shopping-71.png",FUEL:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/gas_station-71.png",GIFT:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/shopping-71.png",GROC:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/supermarket-71.png",HARDW:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/hardware-71.png",HEAL:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png",JEWL:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/shopping-71.png",OTHER:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png",RX:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/pharmacy-71.png",REST:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/restaurant-71.png",RETAIL:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/shopping-71.png",SERV:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png",SPEC:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/shopping-71.png",SPRT:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/sports-71.png",TECH:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/electronics-71.png",TOYS:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/shopping-71.png"};return n[e]?n[e]:getDefaultBusinessIcon()}function getDefaultBusinessIcon(){return"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png"}async function isAddressInDatabase(e){try{if(!(e&&e.address1&&e.city&&e.state&&e.zip))return console.log("Can't check database: incomplete address information",e),!1;const n=`${e.address1}, ${e.city}, ${e.state} ${e.zip}`.toLowerCase();console.log("Checking if address exists in database:",n);const o=getBaseURL(),t=new URLSearchParams({address:n,exact:"true"}).toString(),s=await fetch(`${o}/api/business.js?operation=search&${t}`);if(!s.ok)return console.warn("Error checking address in database:",s.status),!1;const a=await s.json(),i=a.results&&a.results.length>0;return console.log(`Address exists in database: ${i}`),i}catch(e){return console.error("Error checking if address is in database:",e),!1}}async function isPlaceAlreadyInDatabase(e){if(!e)return!1;try{const n=getBaseURL(),o=await fetch(`${n}/api/business.js?operation=check_place_exists&place_id=${e}`);return o.ok?!0===(await o.json()).exists:(console.warn("Error checking if place exists:",o.status),!1)}catch(e){return console.error("Error checking if place exists:",e),!1}}function searchNearbyBusinesses(e,n){if(!e)return void console.error("No location provided for nearby business search");let o,t;"function"==typeof e.lat?(o=e.lat(),t=e.lng()):(o=e.lat,t=e.lng),console.log(`Searching for nearby businesses near ${o} ${t}`),isNaN(o)||isNaN(t)?console.warn("Invalid coordinates for nearby search:",o,t):(searchNearbyBusinessesInDatabase(o,t,n),searchNearbyBusinessesWithPlaces(o,t,n))}function filterBusinessesBySearchLocation(e){if(!window.currentSearchLocation)return e;const n=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng);return e.filter((e=>{if(!e.lat||!e.lng)return!1;const o=new google.maps.LatLng(e.lat,e.lng),t=google.maps.geometry.spherical.computeDistanceBetween(n,o)/1609.34,s=t<=50;return s||console.log(`Filtering out distant business: ${e.bname} - ${t.toFixed(1)} miles from search location`),s}))}function searchNearbyBusinessesInDatabase(e,n,o){const t=getBaseURL();fetch(`${t}/api/business.js?operation=search&type=${o}&lat=${e}&lng=${n}&radius=25`).then((e=>{if(!e.ok)throw new Error(`Failed to fetch nearby businesses: ${e.status}`);return e.json()})).then((o=>{if(!o.results||0===o.results.length)return void console.log("No additional nearby businesses found in database");console.log(`Found ${o.results.length} potential nearby businesses in database`);const t=markers.map((e=>e.business?._id)).filter((e=>e)),s=o.results.filter((e=>!t.includes(e._id)));console.log(`${s.length} new businesses to add to map from database`),s.forEach((o=>{if(o.isNearby=!0,o.lat&&o.lng){const t=new google.maps.LatLng(o.lat,o.lng),s=google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(e,n),t);s<8e4?(addAdvancedMarker(o,t),bounds&&bounds.extend(t)):console.log(`Skipping distant business: ${o.bname} (${s/1609} miles)`)}})),s.length>0&&bounds&&!bounds.isEmpty()&&map.fitBounds(bounds)})).catch((e=>{console.error("Error searching for nearby businesses in database:",e)}))}function convertBusinessTypeToPlacesType(e){return{REST:"restaurant",GROC:"grocery_or_supermarket",FUEL:"gas_station",HARDW:"hardware_store",DEPT:"department_store",CONV:"convenience_store",CLTH:"clothing_store",ELEC:"electronics_store",FURN:"furniture_store",RETAIL:"store",RX:"pharmacy",AUTO:"car_dealer",BEAU:"beauty_salon",BOOK:"book_store",ENTR:"movie_theater",SPRT:"sporting_goods",GIFT:"home_goods_store",HEAL:"drugstore",JEWL:"jewelry_store",SERV:"establishment",SPEC:"store",TECH:"electronics_store",TOYS:"shopping_mall",OTHER:"establishment"}[e]||"establishment"}function getGoogleMapsApiKey(){if(window.appConfig&&window.appConfig.googleMapsApiKey)return window.appConfig.googleMapsApiKey;const e=document.querySelector('meta[name="google-maps-api-key"]');if(e)return e.content;if("undefined"!=typeof GOOGLE_MAPS_API_KEY)return GOOGLE_MAPS_API_KEY;const n=document.querySelectorAll('script[src*="maps.googleapis.com"]');for(const e of n){const n=e.getAttribute("src").match(/[?&]key=([^&]+)/);if(n&&n[1])return n[1]}return console.error("Could not find Google Maps API key"),""}function geocodeNearbyBusiness(e,n){if(!e||!e.address1)return;const o=`${e.address1}, ${e.city}, ${e.state} ${e.zip}`;(new google.maps.Geocoder).geocode({address:o},(function(o,t){if(t===google.maps.GeocoderStatus.OK&&o[0]){const t=o[0].geometry.location,s=google.maps.geometry.spherical.computeDistanceBetween(n,t);s<=CONFIG.maxNearbyDistance&&(e.isNearby=!0,e.lat=t.lat(),e.lng=t.lng(),e.distance=s,addAdvancedMarker(e,t))}}))}function initGoogleMap(){console.log("Initializing Google Map");try{const e=document.getElementById("map");if(!e)return void console.error("Map container not found in the DOM");console.log("Map container dimensions:",e.offsetWidth,"x",e.offsetHeight),map?console.log("Map already exists, skipping initialization"):(map=new google.maps.Map(e,{center:CONFIG.defaultCenter,zoom:CONFIG.defaultZoom,mapId:CONFIG.mapId||"ebe8ec43a7bc252d",clickableIcons:!0}),console.log("Map object created:",!!map),bounds=new google.maps.LatLngBounds,addInitialMapMessage(e),setupResetMapButton(),mapInitialized=!0,console.log("Google Map successfully initialized"),pendingBusinessesToDisplay.length>0&&(console.log("Processing pending businesses to display on map"),displayBusinessesOnMap(pendingBusinessesToDisplay),pendingBusinessesToDisplay=[]),setupMapClickHandler(),setupMarkerClickPriority(),initAdditionalMapFeatures(),map.addListener("click",(function(e){e.placeId||closeInfoWindow()})))}catch(e){console.error("Error initializing Google Map:",e),mapInitialized=!1;const n=document.getElementById("map");n&&(n.innerHTML=`\n                <div style="text-align: center; padding: 20px;">\n                    <p>Sorry, we couldn't load the map. Please try refreshing the page.</p>\n                    <p>Error: ${e.message}</p>\n                </div>\n            `)}}async function createAdvancedMarker(e,n,o=!1){try{const t="string"==typeof e.bname?e.bname:e.text&&"string"==typeof e.text?e.text:e.displayName&&"string"==typeof e.displayName?e.displayName:"Business";let s;console.log(`Creating marker for ${t} at ${n.lat}, ${n.lng}`),s=n instanceof google.maps.LatLng?n:new google.maps.LatLng(parseFloat(n.lat),parseFloat(n.lng));const a=o?CONFIG.markerColors.nearby:CONFIG.markerColors.primary;if(google.maps.marker&&google.maps.marker.AdvancedMarkerElement){await google.maps.importLibrary("marker");const n=document.createElement("div");n.className="custom-marker",n.innerHTML=`\n                <div class="marker-container">\n                    <div class="marker-pin ${o?"nearby":""}" style="background-color: ${a};">\n                        <div class="marker-icon">\n                            ${getBusinessTypeTextIcon(e.type||"OTHER")}\n                        </div>\n                    </div>\n                    <div class="marker-shadow"></div>\n                </div>\n            `;const i=new google.maps.marker.AdvancedMarkerElement({position:s,map,title:t,content:n});return i.business=e,i.isNearby=o,n.addEventListener("click",(function(){showInfoWindow(i)})),i}{console.log("Using fallback standard marker for business:",t);const n=new google.maps.Marker({position:s,map,title:t,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:a,fillOpacity:1,strokeWeight:1,strokeColor:"#FFFFFF",scale:10},animation:google.maps.Animation.DROP});return n.business=e,n.isNearby=o,n.addListener("click",(function(){showInfoWindow(n)})),n}}catch(t){console.error("Error creating marker:",t);try{console.log("Using basic fallback marker for business:","string"==typeof e.bname?e.bname:e.text&&"string"==typeof e.text?e.text:"Business");const t=new google.maps.Marker({position:new google.maps.LatLng(parseFloat(n.lat),parseFloat(n.lng)),map,title:"string"==typeof e.bname?e.bname:e.text&&"string"==typeof e.text?e.text:"Business"});return t.business=e,t.isNearby=o,t.addListener("click",(function(){showInfoWindow(t)})),t}catch(e){return console.error("Error creating basic fallback marker:",e),null}}}function addAdvancedMarker(e,n,o=!1,t=!1){try{if(!e)return console.error("Invalid business data for marker"),null;let t;if(n instanceof google.maps.LatLng)t=n;else{if(!n||!n.lat&&!n.latitude)return console.error("Invalid position for marker:",n),null;{const e=n.lat||n.latitude,o=n.lng||n.longitude,s="function"==typeof e?e():parseFloat(e),a="function"==typeof o?o():parseFloat(o);if(isNaN(s)||isNaN(a))return console.error("Invalid coordinates for marker:",e,o),null;t={lat:s,lng:a}}}return createAdvancedMarker(e,t,o).then((e=>{if(e&&(markers.push(e),bounds))try{const n=e.getPosition?e.getPosition():new google.maps.LatLng(t.lat,t.lng);bounds.extend(n)}catch(e){console.error("Error extending bounds:",e)}})).catch((e=>{console.error("Error creating marker:",e)})),{business:e,position:t,isNearby:o}}catch(e){return console.error("Error in addAdvancedMarker:",e),null}}function processPlacesResults(e,n){e&&0!==e.length?(console.log("Processing places results:",e.length,"places found"),e.forEach((async e=>{try{if(!e.location)return void console.warn("Place missing location data:",e.displayName||e.text||"Unknown place");const o=e.displayName||(e.text?"string"==typeof e.text?e.text:e.text.text:"Unknown Business"),t=e.location.latitude||e.location.lat,s=e.location.longitude||e.location.lng,a=new google.maps.LatLng(t,s),i=google.maps.geometry.spherical.computeDistanceBetween(n,a);if(i>8e4)return void console.log(`Skipping distant place: ${o} (${i/1609} miles)`);if(markers.some((n=>n.business?.placeId===e.id)))return void console.log(`Place already on map: ${o}`);const r=await findMatchingChainForPlaceResult(o),l={_id:"google_"+e.id,bname:o,address1:e.formattedAddress||"",city:"",state:"",zip:"",isGooglePlace:!0,isNearby:!0,placeId:e.id,lat:t,lng:s,distance:i};r&&(console.log(`Nearby place "${o}" matches chain: ${r.bname}`),l.chain_id=r._id,l.chain_name=r.bname,l.isChainLocation=!0),addAdvancedMarker(l,a,!0),bounds&&bounds.extend(a)}catch(e){console.error("Error processing place:",e)}})),setTimeout((()=>{if(bounds&&!bounds.isEmpty()){const e=map.getZoom();map.fitBounds(bounds),setTimeout((()=>{map.getZoom()<10&&e>10&&map.setZoom(10)}),100)}}),500)):console.log("No places to process")}function showInfoWindow(e){if(console.log("showInfoWindow called with marker:",e),!e||!e.business)return void console.error("Invalid marker or missing business data");const n=e.business;console.log("Business data for info window:",n);let o=document.getElementById("info-window");o||(o=document.createElement("div"),o.id="info-window",o.className="custom-info-window",document.body.appendChild(o),o.style.position="absolute",o.style.zIndex="9999",o.style.backgroundColor="white",o.style.boxShadow="0 2px 10px rgba(0,0,0,0.3)",o.style.borderRadius="8px",o.style.padding="12px",o.style.maxWidth="300px",o.style.display="none");const t=!0===n.isGooglePlace,s=!!n.chain_id;let a="";n.distance&&(a=`<div class="business-distance">Distance: ${"number"==typeof n.distance?(n.distance/1609.34).toFixed(1):n.distance} miles</div>`);const i=n.address1?`<div class="business-address">Address: ${n.address1} ${n.city||""}</div>`:"",r=n.type?`<div class="business-type">Type: ${formatBusinessType(n.type)}</div>`:"",l=s?`<span class="chain-badge">${n.chain_name||"Chain Location"}</span>`:"";let c="";c=t?s?`\n                <button class="add-business-btn" \n                        onclick="window.addBusinessToDatabase('${n.placeId}', '${n.chain_id}')">\n                    Add to Database\n                </button>\n            `:`\n                <button class="add-business-btn" \n                        onclick="window.addBusinessToDatabase('${n.placeId}')">\n                    Add to Patriot Thanks\n                </button>\n            `:`\n            <button class="view-details-btn" \n                    onclick="window.viewBusinessDetails('${n._id}')">\n                View Details\n            </button>\n        `;const d=`\n        <div class="info-window-close" onclick="closeInfoWindow()">×</div>\n        <div class="info-window-title">${n.bname} ${l}</div>\n        ${i}\n        ${a}\n        ${r}\n        <div id="info-window-incentives-${n._id||n.placeId}" class="info-window-incentives">\n            <div class="loading-indicator">Loading incentives...</div>\n        </div>\n        <div class="info-window-actions">\n            ${c}\n        </div>\n    `;let p;o.innerHTML=d;try{e.getPosition&&"function"==typeof e.getPosition?p=e.getPosition():e.position&&(e.position instanceof google.maps.LatLng?p=e.position:void 0!==e.position.lat&&void 0!==e.position.lng&&(p=new google.maps.LatLng("function"==typeof e.position.lat?e.position.lat():e.position.lat,"function"==typeof e.position.lng?e.position.lng():e.position.lng)))}catch(e){console.error("Error getting marker position:",e)}if(p){const e=map.getProjection(),n=map.getDiv().getBoundingClientRect();if(e)try{const t=Math.pow(2,map.getZoom()),s=e.fromLatLngToPoint(p),a=e.fromLatLngToPoint(map.getBounds().getNorthEast()),i=e.fromLatLngToPoint(map.getBounds().getSouthWest()),r=Math.floor((s.x-i.x)*t),l=Math.floor((s.y-a.y)*t);o.style.left=r+20+"px",o.style.top=l-20+"px";const c=300,d=300;r+c+30>n.width&&(o.style.left=r-c-20+"px"),l+d>n.height&&(o.style.top=n.height-d-20+"px"),parseFloat(o.style.top)<10&&(o.style.top="10px")}catch(e){console.error("Error positioning info window:",e),o.style.left="50%",o.style.top="50%",o.style.transform="translate(-50%, -50%)"}else o.style.left="50%",o.style.top="50%",o.style.transform="translate(-50%, -50%)"}else o.style.left="50%",o.style.top="50%",o.style.transform="translate(-50%, -50%)";if(o.style.display="block",console.log("Info window opened for business:",n.bname),t&&s)fetchChainIncentivesForInfoWindow(n.placeId,n.chain_id);else if(t){const e=document.getElementById(`info-window-incentives-${n._id||n.placeId}`);e&&(e.innerHTML='\n                <div class="no-incentives-message">\n                    This business is not yet in the Patriot Thanks database.\n                </div>\n            ')}else fetchBusinessIncentivesForInfoWindow(n._id)}function closeInfoWindow(){const e=document.getElementById("info-window");e&&(e.style.display="none")}function formatBusinessType(e){return{AUTO:"Automotive",BEAU:"Beauty",BOOK:"Bookstore",CLTH:"Clothing",CONV:"Convenience Store/Gas Station",DEPT:"Department Store",ELEC:"Electronics",ENTR:"Entertainment",FURN:"Furniture",FUEL:"Fuel Station/Truck Stop",GIFT:"Gift Shop",GROC:"Grocery",HARDW:"Hardware",HEAL:"Health",JEWL:"Jewelry",OTHER:"Other",RX:"Pharmacy",REST:"Restaurant",RETAIL:"Retail",SERV:"Service",SPEC:"Specialty",SPRT:"Sporting Goods",TECH:"Technology",TOYS:"Toys"}[e]||e}function addInfoWindowStyles(){if(!document.getElementById("info-window-styles")){const e=document.createElement("style");e.id="info-window-styles",e.textContent="\n            .custom-info-window {\n                position: absolute;\n                z-index: 9999;\n                background: white;\n                border-radius: 8px;\n                box-shadow: 0 2px 10px rgba(0,0,0,0.3);\n                padding: 12px;\n                max-width: 300px;\n                font-family: Arial, sans-serif;\n            }\n            \n            .info-window-close {\n                position: absolute;\n                top: 5px;\n                right: 10px;\n                font-size: 20px;\n                font-weight: bold;\n                cursor: pointer;\n                color: #666;\n                width: 20px;\n                height: 20px;\n                text-align: center;\n                line-height: 20px;\n            }\n            \n            .info-window-title {\n                font-size: 16px;\n                font-weight: bold;\n                margin-bottom: 8px;\n                padding-right: 25px;\n            }\n            \n            .chain-badge {\n                display: inline-block;\n                background-color: #4285F4;\n                color: white;\n                padding: 2px 6px;\n                border-radius: 4px;\n                font-size: 0.8em;\n                margin-left: 5px;\n                font-weight: normal;\n            }\n            \n            .business-address,\n            .business-distance,\n            .business-type {\n                margin: 6px 0;\n            }\n            \n            .info-window-incentives {\n                margin: 10px 0;\n            }\n            \n            .loading-indicator {\n                color: #666;\n                font-style: italic;\n            }\n            \n            .incentives-list {\n                margin: 8px 0;\n                padding-left: 20px;\n            }\n            \n            .info-window-actions {\n                margin-top: 12px;\n                padding-top: 8px;\n                border-top: 1px solid #eee;\n                text-align: right;\n            }\n            \n            .add-business-btn,\n            .view-details-btn {\n                border: none;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                color: white;\n                font-weight: bold;\n            }\n            \n            .add-business-btn {\n                background-color: #EA4335;\n            }\n            \n            .view-details-btn {\n                background-color: #4285F4;\n            }\n        ",document.head.appendChild(e)}}async function searchNearbyBusinessesWithPlaces(e,n,o){if(isNaN(e)||isNaN(n))console.warn("Invalid coordinates for nearby search:",e,n);else try{console.log(`Searching for nearby businesses near [${e}, ${n}] of type ${o}`);const t=getPlacesSearchTermForBusinessType(o),s=new google.maps.LatLng(e,n);if(google.maps.places.Place){console.log("Using newer Places API for nearby search");const{Place:o,PlacesService:a}=await google.maps.importLibrary("places"),i={textQuery:t,locationBias:{circle:{center:{latitude:e,longitude:n},radius:1e4}}};try{const e=window.appConfig?.googleMapsApiKey,n=await fetch("https://places.googleapis.com/v1/places:searchText",{method:"POST",headers:{"Content-Type":"application/json","X-Goog-Api-Key":e,"X-Goog-FieldMask":"places.id,places.displayName,places.formattedAddress,places.location,places.primaryType"},body:JSON.stringify(i)}),o=await n.json();o.places&&o.places.length>0?(console.log(`Found ${o.places.length} nearby places via Places API`),processPlacesResults(o.places,s)):console.log("No nearby places found")}catch(e){console.error("Error with newer Places API, falling back to legacy API:",e),fallbackToLegacyPlacesApi(s,t)}}else fallbackToLegacyPlacesApi(s,t)}catch(e){console.error("Error searching for nearby places:",e)}}function processLegacyPlacesResults(e,n){e.forEach((async e=>{try{if(!e.geometry||!e.geometry.location)return void console.warn("Place missing geometry:",e.name);const o=google.maps.geometry.spherical.computeDistanceBetween(n,e.geometry.location);if(o>8e4)return void console.log(`Skipping distant place: ${e.name} (${o/1609} miles)`);let t="",s="",a="",i="";if(e.vicinity){const n=e.vicinity.split(",");if(n.length>=1&&(t=n[0].trim()),n.length>=2){const e=n[1].trim().split(" ");s=e[0],e.length>1&&(a=e[e.length-2],i=e[e.length-1])}}const r=await findMatchingChainForPlaceResult(e.name),l={_id:"google_"+e.place_id,bname:e.name,address1:t,city:s,state:a,zip:i,formattedAddress:e.vicinity||e.formatted_address,type:mapGooglePlaceTypeToBusinessType(e.types),phone:e.formatted_phone_number||"",isGooglePlace:!0,isNearby:!0,placeId:e.place_id,lat:e.geometry.location.lat(),lng:e.geometry.location.lng(),distance:o};r&&(console.log(`Nearby place "${e.name}" matches chain: ${r.bname}`),l.chain_id=r._id,l.chain_name=r.bname,l.isChainLocation=!0),addAdvancedMarker(l,e.geometry.location,!0),bounds&&bounds.extend(e.geometry.location)}catch(e){console.error("Error processing legacy place:",e)}})),bounds&&!bounds.isEmpty()&&map.fitBounds(bounds)}function getPlacesSearchTermForBusinessType(e){return{REST:"restaurants",GROC:"grocery stores",FUEL:"gas stations",HARDW:"hardware stores",DEPT:"department stores",CONV:"convenience stores",CLTH:"clothing stores",ELEC:"electronics stores",FURN:"furniture stores",RETAIL:"retail stores",RX:"pharmacies",AUTO:"car dealerships",BEAU:"beauty salons",BOOK:"bookstores",ENTR:"movie theaters",SPRT:"sporting goods",GIFT:"gift shops",HEAL:"health stores",JEWL:"jewelry stores",SERV:"services",TECH:"technology stores",TOYS:"toy stores"}[e]||"businesses"}function getBusinessTypeTextIcon(e){return`<span style="font-size: 14px; color: white;">${{AUTO:"🚗",BEAU:"💇",BOOK:"📚",CLTH:"👕",CONV:"🏪",DEPT:"🛍️",ELEC:"⚡",ENTR:"🎬",FURN:"🪑",FUEL:"⛽",GIFT:"🎁",GROC:"🛒",HARDW:"🔨",HEAL:"❤️",JEWL:"💎",OTHER:"🏬",RX:"💊",REST:"🍽️",RETAIL:"🛍️",SERV:"🔧",SPEC:"⭐",SPRT:"🏈",TECH:"💻",TOYS:"🎮"}[e]||"🏬"}</span>`}window.viewBusinessDetails=function(e){console.log("View details for business:",e),alert("This feature is coming soon: View details for "+e)},window.addBusinessToDatabase=async function(e){console.log("Adding place to database:",e);try{const{Place:n}=await google.maps.importLibrary("places"),o=new n({id:e});await o.fetchFields({fields:["displayName","formattedAddress","addressComponents","location","nationalPhoneNumber"]});const t={name:o.displayName||"",address1:getAddressComponentFromPlace(o,"street_number")+" "+getAddressComponentFromPlace(o,"route"),city:getAddressComponentFromPlace(o,"locality"),state:getAddressComponentFromPlace(o,"administrative_area_level_1"),zip:getAddressComponentFromPlace(o,"postal_code"),phone:o.nationalPhoneNumber||"",placeId:o.id,lat:o.location?.lat||0,lng:o.location?.lng||0,location:{type:"Point",coordinates:[o.location?.lng||0,o.location?.lat||0]}};console.log(`Place coordinates: ${t.lat}, ${t.lng}`),sessionStorage.setItem("newBusinessData",JSON.stringify(t)),window.location.href="business-add.html?prefill=true"}catch(e){console.error("Error fetching place details for addition:",e),alert("Sorry, we couldn't retrieve the details for this business. Please try again or add it manually.")}},window.addBusinessToDatabase=async function(e,n=null){console.log("Adding place to database:",e,"Chain ID:",n);try{const o=new google.maps.places.PlacesService(map),t={placeId:e,fields:["name","formatted_address","formatted_phone_number","geometry","address_components"]};o.getDetails(t,(async(e,o)=>{if(o!==google.maps.places.PlacesServiceStatus.OK||!e)return console.error("Error fetching place details:",o),void alert("Sorry, we couldn't retrieve the details for this business. Please try again or add it manually.");console.log("Place details retrieved:",e);const t={};if(e.address_components)for(const n of e.address_components)for(const e of n.types)t[e]=n.short_name;const s={name:e.name||"",address1:(t.street_number||"")+" "+(t.route||""),city:t.locality||"",state:t.administrative_area_level_1||"",zip:t.postal_code||"",phone:e.formatted_phone_number||"",placeId:e.place_id,formattedAddress:e.formatted_address,lat:e.geometry?.location.lat()||0,lng:e.geometry?.location.lng()||0,location:{type:"Point",coordinates:[e.geometry?.location.lng()||0,e.geometry?.location.lat()||0]}};n&&(s.chain_id=n,alert("This business will be added as a location of "+(s.chain_name||"the chain")+". Chain-wide incentives already apply to this location.")),sessionStorage.setItem("newBusinessData",JSON.stringify(s)),window.location.href="business-add.html?prefill=true"}))}catch(e){console.error("Error in addBusinessToDatabase:",e),alert("Sorry, we couldn't add this business to the database. Please try again or add it manually.")}},window.addBusinessToDatabase=async function(e,n=null){console.log("Adding place to database:",e,"Chain ID:",n);try{const o=new google.maps.places.PlacesService(map),t={placeId:e,fields:["name","formatted_address","formatted_phone_number","geometry","address_components"]};o.getDetails(t,(async(e,o)=>{if(o!==google.maps.places.PlacesServiceStatus.OK||!e)return console.error("Error fetching place details:",o),void alert("Sorry, we couldn't retrieve the details for this business. Please try again or add it manually.");console.log("Place details retrieved:",e);const t={};if(e.address_components)for(const n of e.address_components)for(const e of n.types)t[e]=n.short_name;const s={name:e.name||"",address1:(t.street_number||"")+" "+(t.route||""),city:t.locality||"",state:t.administrative_area_level_1||"",zip:t.postal_code||"",phone:e.formatted_phone_number||"",placeId:e.place_id,formattedAddress:e.formatted_address,lat:e.geometry?.location.lat()||0,lng:e.geometry?.location.lng()||0,location:{type:"Point",coordinates:[e.geometry?.location.lng()||0,e.geometry?.location.lat()||0]}};if(n){s.chain_id=n;try{const e=await getChainDetails(n);e&&e.bname&&(s.chain_name=e.bname)}catch(e){console.error("Error getting chain details:",e)}}sessionStorage.setItem("newBusinessData",JSON.stringify(s)),console.log("Storing business data in sessionStorage:",s),window.location.href="business-add.html?prefill=true"}))}catch(e){console.error("Error in addBusinessToDatabase:",e),alert("Sorry, we couldn't add this business to the database. Please try again or add it manually.")}},window.handleChainBusinessAction=function(e,n){n?window.location.href=`manage-chains.html?chain_id=${e}`:viewChainDetails(e)},window.viewChainDetails=function(e){const n=getBaseURL();fetch(`${n}/api/business.js?operation=get&id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to fetch chain details: ${e.status}`);return e.json()})).then((e=>{if(!e.result)throw new Error("Chain not found");showChainInfoDialog(e.result)})).catch((e=>{console.error("Error fetching chain details:",e),alert(`Error: ${e.message}`)}))},window.addGooglePlaceToDatabase=async function(e){console.log("Adding place to database:",e);try{const{Place:n}=await google.maps.importLibrary("places"),o=new n({id:e});await o.fetchFields({fields:["displayName","formattedAddress","addressComponents","location","nationalPhoneNumber"]});const t={name:o.displayName||"",address1:getAddressComponentFromPlace(o,"street_number")+" "+getAddressComponentFromPlace(o,"route"),city:getAddressComponentFromPlace(o,"locality"),state:getAddressComponentFromPlace(o,"administrative_area_level_1"),zip:getAddressComponentFromPlace(o,"postal_code"),phone:o.nationalPhoneNumber||"",placeId:o.id,lat:o.location?.lat||0,lng:o.location?.lng||0,location:{type:"Point",coordinates:[o.location?.lng||0,o.location?.lat||0]}};console.log(`Place coordinates: ${t.lat}, ${t.lng}`),sessionStorage.setItem("newBusinessData",JSON.stringify(t)),window.location.href="business-add.html?prefill=true"}catch(e){console.error("Error fetching place details for addition:",e),alert("Sorry, we couldn't retrieve the details for this business. Please try again or add it manually.")}},window.initGoogleMap=function(){console.log("Global initGoogleMap function called");try{const e=document.getElementById("map");if(!e)return void console.error("Map container not found in the DOM");console.log("Map container dimensions:",e.offsetWidth,"x",e.offsetHeight),map?console.log("Map already exists, skipping initialization"):(map=new google.maps.Map(e,{center:CONFIG.defaultCenter,zoom:CONFIG.defaultZoom,mapId:CONFIG.mapId||"ebe8ec43a7bc252d",clickableIcons:!0}),console.log("Map object created:",!!map),infoWindow=new google.maps.InfoWindow,bounds=new google.maps.LatLngBounds,addInitialMapMessage(e),setupResetMapButton(),mapInitialized=!0,console.log("Google Map successfully initialized"),pendingBusinessesToDisplay.length>0&&(console.log("Processing pending businesses to display on map"),displayBusinessesOnMap(pendingBusinessesToDisplay),pendingBusinessesToDisplay=[]),setupMapClickHandler(),setupMarkerClickPriority(),initAdditionalMapFeatures())}catch(e){console.error("Error initializing Google Map:",e),mapInitialized=!1;const n=document.getElementById("map");n&&(n.innerHTML=`\n                <div style="text-align: center; padding: 20px;">\n                    <p>Sorry, we couldn't load the map. Please try refreshing the page.</p>\n                    <p>Error: ${e.message}</p>\n                </div>\n            `)}},window.focusOnMapMarker=function(e){if(console.log("focusOnMapMarker called for business ID:",e),!mapInitialized||!map)return console.error("Map not initialized yet - cannot focus on marker"),void alert("Map is still loading. Please try again in a moment.");if(!markers||0===markers.length)return console.warn("No markers available yet."),void alert("No businesses are currently displayed on the map.");const n=markers.find((n=>n.business&&n.business._id===e));if(n)try{let o;if(n.getPosition)o=n.getPosition();else if(n.position)o="function"==typeof n.position.lat?n.position:new google.maps.LatLng(parseFloat(n.position.lat),parseFloat(n.position.lng));else{if(!(n.business&&n.business.lat&&n.business.lng))return console.error("Could not determine marker position"),void alert("Could not focus on this business on the map.");o=new google.maps.LatLng(parseFloat(n.business.lat),parseFloat(n.business.lng))}if(isNaN(o.lat())||isNaN(o.lng()))return console.error("Invalid marker position coordinates:",o),void alert("This business has invalid map coordinates.");map.setCenter(o),map.setZoom(16),n.business.isGooglePlace?showGooglePlaceInfoWindow(n.business,o):showInfoWindow(n),document.getElementById("map").scrollIntoView({behavior:"smooth"}),console.log("Successfully focused on marker for business:",e)}catch(e){console.error("Error focusing on marker:",e),alert("There was an error focusing on this business on the map.")}else console.warn(`No marker found for business ID: ${e}`),alert("This business could not be located on the map. It may not have a complete address."),document.getElementById("map").scrollIntoView({behavior:"smooth"})},window.focusOnMapMarker=function(e){if(console.log("focusOnMapMarker called for business ID:",e),!mapInitialized||!map)return console.error("Map not initialized yet - cannot focus on marker"),void alert("Map is still loading. Please try again in a moment.");if(!markers||0===markers.length)return console.warn("No markers available yet."),void alert("No businesses are currently displayed on the map.");const n=markers.find((n=>n.business&&n.business._id===e));if(n)try{let o;if(n.getPosition&&"function"==typeof n.getPosition)o=n.getPosition();else if(n.position)o=n.position instanceof google.maps.LatLng?n.position:new google.maps.LatLng("function"==typeof n.position.lat?n.position.lat():n.position.lat,"function"==typeof n.position.lng?n.position.lng():n.position.lng);else{if(!(n.business&&n.business.lat&&n.business.lng))return console.error("Could not determine marker position"),void alert("This business could not be located on the map.");o=new google.maps.LatLng(parseFloat(n.business.lat),parseFloat(n.business.lng))}map.setCenter(o),map.setZoom(16),showInfoWindow(n),document.getElementById("map").scrollIntoView({behavior:"smooth"}),console.log("Successfully focused on marker for business:",e)}catch(e){console.error("Error focusing on marker:",e),alert("There was an error focusing on this business on the map.")}else console.warn(`No marker found for business ID: ${e}`),alert("This business could not be located on the map. It may not have a complete address."),document.getElementById("map").scrollIntoView({behavior:"smooth"})},document.addEventListener("DOMContentLoaded",(function(){addInfoWindowStyles()})),window.focusOnMapMarker=function(e){if(console.log("focusOnMapMarker called for business ID:",e),!mapInitialized||!map)return console.error("Map not initialized yet - cannot focus on marker"),void alert("Map is still loading. Please try again in a moment.");if(!markers||0===markers.length)return console.warn("No markers available yet."),void alert("No businesses are currently displayed on the map.");const n=markers.find((n=>n.business&&n.business._id===e));if(n){let o;o=n instanceof google.maps.marker.AdvancedMarkerElement?n.position:n.getPosition(),map.setCenter(o),map.setZoom(16),n.business.isGooglePlace?showGooglePlaceInfoWindow(n.business,o):showInfoWindow(n),document.getElementById("map").scrollIntoView({behavior:"smooth"}),console.log("Successfully focused on marker for business:",e)}else console.warn(`No marker found for business ID: ${e}`),alert("This business could not be located on the map. It may not have a complete address."),document.getElementById("map").scrollIntoView({behavior:"smooth"})},document.addEventListener("DOMContentLoaded",(function(){console.log("DOM loaded, initializing business search..."),addCustomMarkerStyles(),addChainBadgeStyles(),initBusinessSearch(),checkForNewlyAddedBusiness(),window.google&&window.google.maps?(console.log("Google Maps already loaded, initializing map"),initGoogleMap()):console.log("Google Maps not yet loaded, will be initialized via callback")}));