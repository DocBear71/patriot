const CONFIG={mapId:"ebe8ec43a7bc252d",defaultCenter:{lat:39.8283,lng:-98.5795},defaultZoom:4,markerColors:{primary:"#EA4335",nearby:"#4285F4"},geocodeDelay:200,imageLoadDelay:1e3,maxNearbyDistance:2e4};let map=null,mapInitialized=!1,markers=[],infoWindow=null,bounds=null,pendingBusinessesToDisplay=[];const placeCache=new Map;function clearMarkers(){markers?(markers.forEach((e=>{e&&(e.map=null)})),markers=[]):markers=[]}function showPlaceInfoWindow(e,n){const s=`\n    <div class="info-window">\n      <h3>${e.displayName||"Unnamed Place"}</h3>\n      <p><strong>Address:</strong><br>${e.formattedAddress||"Address not available"}</p>\n      ${e.nationalPhoneNumber?`<p><strong>Phone:</strong> ${e.nationalPhoneNumber}</p>`:""}\n      <p><strong>Type:</strong> ${getPlaceTypeLabel(e.types)}</p>\n      <div class="info-window-actions">\n        <button class="add-business-btn" \n                onclick="window.addBusinessToDatabase('${e.id}')">\n          Add to Patriot Thanks\n        </button>\n      </div>\n    </div>\n  `;infoWindow.setContent(s),infoWindow.setPosition(n),infoWindow.open(map)}function getPlaceTypeLabel(e){if(!e||!e.length)return"Unknown";const n={restaurant:"Restaurant",food:"Food",store:"Store",establishment:"Business",point_of_interest:"Point of Interest",gas_station:"Gas Station",lodging:"Lodging",cafe:"Cafe",bar:"Bar"};for(const s of e)if(n[s])return n[s];return e[0].replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase()))}function getAddressComponentFromPlace(e,n){if(!e.addressComponents)return"";const s=e.addressComponents.find((e=>e.types.includes(n)));return s?s.shortText:""}function getBusinessTypeLabel(e){return{AUTO:"Automotive",BEAU:"Beauty",BOOK:"Bookstore",CLTH:"Clothing",CONV:"Convenience Store/Gas Station",DEPT:"Department Store",ELEC:"Electronics",ENTR:"Entertainment",FURN:"Furniture",FUEL:"Fuel Station/Truck Stop",GIFT:"Gift Shop",GROC:"Grocery",HARDW:"Hardware",HEAL:"Health",JEWL:"Jewelry",OTHER:"Other",RX:"Pharmacy",REST:"Restaurant",RETAIL:"Retail",SERV:"Service",SPEC:"Specialty",SPRT:"Sporting Goods",TECH:"Technology",TOYS:"Toys"}[e]||e}function getIncentiveTypeLabel(e){return{VT:"Veteran",AD:"Active Duty",FR:"First Responder",SP:"Spouse",OT:"Other"}[e]||e}function fetchBusinessIncentivesForInfoWindow(e){if(!e)return void console.error("No business ID provided for fetching incentives");const n=getBaseURL();fetch(`${n}/api/incentives.js?business_id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to fetch incentives: ${e.status}`);return e.json()})).then((n=>{const s=document.getElementById(`info-window-incentives-${e}`);if(!s)return void console.error(`Could not find incentives div for business ${e}`);if(!n.results||0===n.results.length)return void(s.innerHTML="<p><strong>Incentives:</strong> No incentives found</p>");let t='<p><strong>Incentives:</strong></p><ul class="incentives-list">';n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),s=e.other_description?` (${e.other_description})`:"";t+=`\n            <li>\n              <strong>${n}${s}:</strong> ${e.amount}%\n              ${e.information?` - ${e.information}`:""}\n            </li>\n          `}})),t+="</ul>",s.innerHTML='<p><strong>Incentives:</strong></p><ul class="incentives-list"></ul>'===t?"<p><strong>Incentives:</strong> No active incentives found</p>":t})).catch((n=>{console.error(`Error fetching incentives for info window: ${n}`);const s=document.getElementById(`info-window-incentives-${e}`);s&&(s.innerHTML="<p><strong>Incentives:</strong> Error loading incentives</p>")}))}function fetchBusinessIncentives(e){if(!e)return void console.error("No business ID provided for fetching incentives");const n=`${getBaseURL()}/api/incentives.js?business_id=${e}`;console.log("Fetching incentives from: ",n),fetch(n).then((e=>{if(!e.ok)throw new Error(`Failed to fetch incentives: ${e.status} ${e.statusText}`);return e.json()})).then((n=>{console.log(`Incentives data for business ${e}:`,n);const s=document.getElementById(`incentives-for-${e}`);if(!s)return void console.error(`Could not find cell for incentives-for-${e}`);if(!n.results||0===n.results.length)return void(s.innerHTML="No incentives found");let t="";n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),s=e.other_description?` (${e.other_description})`:"";t+=`\n            <div class="incentive-item">\n              <strong>${n}${s}:</strong> ${e.amount}%\n              <div class="incentive-info">${e.information||""}</div>\n            </div>\n          `}})),s.innerHTML=""===t?"No active incentives found":t})).catch((n=>{console.error(`Error fetching incentives for business ${e}:`,n);const s=document.getElementById(`incentives-for-${e}`);s&&(s.innerHTML="Error loading incentives")}))}function displaySearchResults(e){try{const n=document.getElementById("business_search"),s=document.getElementById("search_table");if(!n||!s)return console.error("Required elements not found in the DOM"),void alert("There was an error displaying search results. Please try again later.");let t=n.querySelector("tbody");if(!t)return console.error("Table body not found within business_search table"),void alert("There was an error displaying search results. Please try again later.");t.innerHTML="",Array.isArray(e)||(console.error("businesses is not an array:",e),e=[]),s.style.display="block";const o=s.querySelector("h5");if(o&&(o.style.display="none"),0===e.length)return t.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria.</td></tr>',void s.scrollIntoView({behavior:"smooth"});e.forEach((e=>{if(!e)return;const n=e.address2?`${e.address1}<br>${e.address2}<br>${e.city}, ${e.state} ${e.zip}`:`${e.address1}<br>${e.city}, ${e.state} ${e.zip}`,s=getBusinessTypeLabel(e.type),o=document.createElement("tr"),i=`<button class="view-map-btn" onclick="focusOnMapMarker('${e._id}')">View on Map</button>`;o.innerHTML=`\n        <th class="left_table" data-business-id="${e._id}">${e.bname}</th>\n        <th class="left_table">${n}</th>\n        <th class="left_table">${s}</th>\n        <th class="right_table" id="incentives-for-${e._id}">Loading incentives...</th>\n        <th class="center_table">${i}</th>\n      `,t.appendChild(o),fetchBusinessIncentives(e._id)})),s.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error displaying search results: ",e),alert("There was an error displaying the search results: "+e.message)}}function displayBusinessSearchResults(e,n){try{if(n.innerHTML="",Array.isArray(e)||(console.error("businesses is not an array:",e),e=[]),0===e.length)return n.innerHTML='<div class="error">No businesses found matching your search criteria.</div>',void n.scrollIntoView({behavior:"smooth"});const s=document.createElement("table");s.className="results-table";const t={name:"Business Name",address:"Address",city:"City",state:"State",zip:"Zip",action:"Action"},o=document.createElement("thead");o.innerHTML=`\n      <tr>\n        <th>${t.name}</th>\n        <th>${t.address}</th>\n        <th>${t.city}</th>\n        <th>${t.state}</th>\n        <th>${t.zip}</th>\n        <th>${t.action}</th>\n      </tr>\n    `,s.appendChild(o);const i=document.createElement("tbody");e.forEach((e=>{if(!e)return;const n=document.createElement("tr");n.innerHTML=`\n        <td data-title="${t.name}">${e.bname}</td>\n        <td data-title="${t.address}">${e.address1}${e.address2?"<br>"+e.address2:""}</td>\n        <td data-title="${t.city}">${e.city}</td>\n        <td data-title="${t.state}">${e.state}</td>\n        <td data-title="${t.zip}">${e.zip}</td>\n        <td data-title="${t.action}"><button class="select-business" data-business-id="${e._id}">Select</button></td>\n      `,i.appendChild(n)})),s.appendChild(i),n.appendChild(s),addResponsiveTableStyles(),document.querySelectorAll(".select-business").forEach((n=>{n.addEventListener("click",(function(){const n=this.getAttribute("data-business-id");if(!n)return void console.error("No business ID found on button");const s=e.find((e=>e._id===n));if(!s)return void console.error("Could not find business with ID: "+n);console.log("Selected business: ",s);const t=window.location.pathname;console.log("Current page: ",t),handleBusinessSelectionByPage(t,s)}))})),n.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error displaying business search results: "+e);const n=document.getElementById("business-search-results");n?(n.innerHTML=`<div class="error">Error displaying search results: ${e.message}</div>`,n.scrollIntoView({behavior:"smooth"})):alert("Error displaying search results: "+e.message)}}function handleBusinessSelectionByPage(e,n){e.includes("incentive-update.html")?(console.log("On incentive-update page"),"function"==typeof window.selectBusinessForIncentive?window.selectBusinessForIncentive(n):"function"==typeof window.selectBusinessForIncentives?window.selectBusinessForIncentives(n):(console.error("selectBusinessForIncentive(s) not found, falling back"),handleBusinessSelection(n))):e.includes("business-update.html")?(console.log("On business-update page"),"function"==typeof window.selectBusinessForUpdate?window.selectBusinessForUpdate(n):(console.error("selectBusinessForUpdate not found, falling back"),handleBusinessSelection(n))):e.includes("incentive-add.html")?(console.log("On incentive-add page"),"function"==typeof window.selectBusinessForIncentive?window.selectBusinessForIncentive(n):handleBusinessSelection(n)):e.includes("incentive-view.html")||e.endsWith("business-search.html")?(console.log("On incentive-view page"),"function"==typeof window.viewBusinessIncentives?window.viewBusinessIncentives(n):handleBusinessSelection(n)):(console.error("Using fallback business selection handler"),handleBusinessSelection(n))}function addResponsiveTableStyles(){if(!document.getElementById("responsive-table-css")){const e=document.createElement("style");e.id="responsive-table-css",e.textContent="\n      /* Base table styles */\n      .results-table {\n        width: 90%;\n        margin: 20px auto;\n        border-collapse: collapse;\n        text-align: left;\n      }\n      \n      .results-table th, .results-table td {\n        border: 1px solid #ddd;\n        padding: 8px;\n      }\n      \n      .results-table th {\n        background-color: #f2f2f2;\n        font-weight: bold;\n        text-align: center;\n      }\n      \n      .results-table tr:nth-child(even) {\n        background-color: #f9f9f9;\n      }\n      \n      .results-table tr:hover {\n        background-color: #f1f1f1;\n      }\n      \n      /* Responsive table for small screens */\n      @media only screen and (max-width: 767px) {\n        .results-table {\n          width: 100%;\n          margin: 10px 0;\n        }\n        \n        .results-table, .results-table thead, .results-table tbody, .results-table tr {\n          display: block;\n        }\n        \n        .results-table thead {\n          display: none;\n        }\n        \n        .results-table tr {\n          border: 1px solid #ccc;\n          margin-bottom: 15px;\n          padding: 8px;\n          background-color: #f9f9f9;\n        }\n        \n        .results-table td {\n          display: block;\n          border: none;\n          border-bottom: 1px solid #eee;\n          padding: 8px;\n          margin-bottom: 6px;\n          text-align: left;\n          position: relative;\n        }\n        \n        .results-table td::before {\n          content: attr(data-title);\n          display: block;\n          font-weight: bold;\n          margin-bottom: 6px;\n          color: #333;\n        }\n        \n        /* Ensure buttons are properly displayed */\n        .select-business {\n          margin: 8px 0;\n          display: inline-block;\n        }\n      }\n    ",document.head.appendChild(e)}}function handleBusinessSelection(e){console.log("Handling business selection with fallback: ",e);try{const n=document.getElementById("business-info-section");if(!n)return void console.error("business-info-section not found");document.getElementById("selected-business-id")&&(selectedBusinessId=e._id||""),populateBusinessInfo(e);const s=document.getElementById("incentive-section");s&&(s.style.display="block"),n.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error in handleBusinessSection: "+e),alert("There was an error selecting the business: "+e.message)}}function populateBusinessInfo(e){if(e)try{const n=document.getElementById("bname");n&&(n.value=e.bname||"");const s=document.getElementById("address1");s&&(s.value=e.address1||"");const t=document.getElementById("address2");t&&(t.value=e.address2||"");const o=document.getElementById("city");o&&(o.value=e.city||"");const i=document.getElementById("zip");i&&(i.value=e.zip||"");const a=document.getElementById("phone");a&&(a.value=e.phone||"");const r=document.getElementById("state");if(r){const n=e.state||"";for(let e=0;e<r.options.length;e++)if(r.options[e].value===n){r.selectedIndex=e;break}}const l=document.getElementById("type");if(l){const n=e.type||"";for(let e=0;e<l.options.length;e++)if(l.options[e].value===n){l.selectedIndex=e;break}}console.log("Business info populated successfully")}catch(e){console.error("Error in populateBusinessInfo: "+e)}else console.error("No business data provided to populateBusinessInfo")}function isNotEmpty(e){return""!==e.trim()}function validateField(e,n){console.log(`Validating ${e.id} with value: ${e.value}`),n(e.value)?(e.classList.remove("invalid-field"),e.classList.add("valid-field"),e.setAttribute("data-valid","true"),console.log(`${e.id} is VALID`)):(e.classList.remove("valid-field"),e.classList.add("invalid-field"),e.setAttribute("data-valid","false"),console.log(`${e.id} is INVALID`))}function getBaseURL(){return"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:"https://patriotthanks.vercel.app"}function initBusinessSearch(){console.log("Business search with Google Maps loaded!");const e={businessName:document.getElementById("business-name"),address:document.getElementById("address")},n=document.getElementById("business-search-form");n?n.addEventListener("submit",(function(n){if(n.preventDefault(),isNotEmpty(e.businessName.value)||isNotEmpty(e.address.value)){const n={businessName:e.businessName.value,address:e.address.value};console.log("Form data to submit:",n),mapInitialized||console.warn("Map not initialized yet. Will display businesses after map loads."),clearMarkers();const s=document.getElementById("initial-map-message");s&&s.remove(),retrieveFromMongoDB(n)}else alert("Please enter either a business name or address to search")})):console.warn("Business search form not found in the DOM"),e.businessName&&e.businessName.addEventListener("input",(function(){validateField(this,isNotEmpty)})),e.address&&e.address.addEventListener("input",(function(){validateField(this,isNotEmpty)}))}async function retrieveFromMongoDB(e){try{const n={};e.businessName&&""!==e.businessName.trim()&&(n.business_name=e.businessName),e.address&&""!==e.address.trim()&&(n.address=e.address);const s=new URLSearchParams(n).toString(),t=`${getBaseURL()}/api/business.js?operation=search&${s}`;console.log("Submitting search to API at: ",t);const o=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json; charset=UTF-8"}});if(console.log("Response status: ",o.status),!o.ok){const e=await o.text();throw console.error("Error response: ",e),new Error(`Failed to retrieve data from MongoDB: ${o.status} ${e}`)}const i=await o.json();if(console.log("Search results:",i),!i||!i.results)throw console.error("Invalid response format - missing results property"),new Error("Invalid response format from server");if(document.getElementById("search_table"))displaySearchResults(i.results),displayBusinessesOnMap(i.results);else{let e=document.getElementById("business-search-results");if(!e){e=document.createElement("div"),e.id="business-search-results";const n=document.querySelector("fieldset");if(n)n.parentNode.insertBefore(e,n.nextSibling);else{const n=document.querySelector("main");n?n.appendChild(e):document.body.appendChild(e)}console.log("Created business-search-results container")}displayBusinessSearchResults(i.results,e)}}catch(e){let n;if(console.error("Error: ",e),document.getElementById("search_table"))n=document.getElementById("search_table");else if(n=document.getElementById("business-search-results"),!n){n=document.createElement("div"),n.id="business-search-results";const e=document.querySelector("fieldset");e?e.parentNode.insertBefore(n,e.nextSibling):document.body.appendChild(n)}n.innerHTML=`<div class="error">Search failed: ${e.message}</div>`,n.style.display="block",n.scrollIntoView({behavior:"smooth"})}}function addInitialMapMessage(e){const n=document.createElement("div");n.id="initial-map-message",n.innerHTML="Search for businesses to see them on the map",n.style.position="absolute",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.background="white",n.style.padding="10px",n.style.borderRadius="5px",n.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)",n.style.zIndex="1",e.appendChild(n)}function setupResetMapButton(){const e=document.getElementById("reset-map");e&&e.addEventListener("click",resetMapView)}function resetMapView(){mapInitialized&&map?(map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom),infoWindow&&infoWindow.close()):console.error("Cannot reset map view - map not initialized")}async function setupMapClickHandler(){if(map){console.log("Setting up map click handler");try{const{Place:e}=await google.maps.importLibrary("places");map.addListener("click",(async function(n){if(console.log("Map clicked",n),n.placeId){n.stop(),console.log("POI clicked, placeId:",n.placeId);try{const s=new e({id:n.placeId});await s.fetchFields({fields:["displayName","formattedAddress","location","types","businessStatus","nationalPhoneNumber"]}),console.log("Place details:",s),showPlaceInfoWindow(s,n.latLng)}catch(e){console.error("Error fetching place details:",e)}}})),console.log("Map click handler set up")}catch(e){console.error("Error setting up map click handler:",e)}}else console.error("Map not initialized in setupMapClickHandler")}function setupMarkerClickPriority(){map?(console.log("Setting up marker click priority"),map.addListener("click",(function(e){if(e.placeId){const n=e.latLng,s=15,t=Math.pow(2,map.getZoom()),o=map.getProjection(),i=map.getBounds();if(!o||!i)return;const a=i.getNorthEast(),r=i.getSouthWest(),l=(o.fromLatLngToPoint(a).x-o.fromLatLngToPoint(r).x)/(a.lng()-r.lng());for(const o of markers){if(!o.position)continue;const i="function"==typeof o.position.lat?o.position.lat():o.position.lat,a="function"==typeof o.position.lng?o.position.lng():o.position.lng,r=n.lat(),c=n.lng(),d=Math.abs(i-r)*l*111e3/(t*Math.cos(i*Math.PI/180)),u=Math.abs(a-c)*l;if(Math.sqrt(Math.pow(d,2)+Math.pow(u,2))<s)return console.log("Preventing POI click near our marker"),e.stop(),void setTimeout((()=>{showInfoWindow(o)}),10)}}})),console.log("Marker click priority setup complete")):console.error("Map not initialized, cannot set up click priority")}function initImageLoading(){if(!mapInitialized||0===markers.length)return console.log("Map not initialized or no markers, delaying image loading"),void setTimeout(initImageLoading,CONFIG.imageLoadDelay);console.log("Starting image loading for markers"),enhanceMarkersWithImages()}function displayBusinessesOnMap(e){return mapInitialized&&map?(console.log("Displaying businesses on map:",e.length),Array.isArray(e)&&0!==e.length?(clearMarkers(),bounds=new google.maps.LatLngBounds,void e.forEach(((n,s)=>{geocodeBusinessAddress(n,s,e.length)}))):(console.log("No businesses to display on map"),map.setCenter(CONFIG.defaultCenter),void map.setZoom(CONFIG.defaultZoom))):(console.log("Map not initialized yet. Storing businesses for later display."),void(pendingBusinessesToDisplay=e))}async function enhanceMarkersWithImages(){if(markers&&0!==markers.length){console.log("Enhancing markers with images...");for(const e of markers){if(!e.business)continue;if(e.business.image_url)continue;const n=await fetchPlacePhotosForBusiness(e.business);n&&(e.business.image_url=n,updateMarkerWithImage(e,n))}}}function geocodeBusinessAddress(e,n,s){if(!e||!e.address1)return void console.error("Invalid business data for geocoding",e);const t=`${e.address1}, ${e.city}, ${e.state} ${e.zip}`,o=new google.maps.Geocoder;setTimeout((()=>{o.geocode({address:t},(function(o,i){if(i===google.maps.GeocoderStatus.OK){if(o[0]){const t=o[0].geometry.location;addAdvancedMarker(e,t),bounds.extend(t),n===s-1&&(map.fitBounds(bounds),1===s&&map.setZoom(15),s>=1&&searchNearbyBusinesses(t,e.type))}}else console.error("Geocode failed for address "+t+": "+i)}))}),n*CONFIG.geocodeDelay)}async function addAdvancedMarker(e,n){try{const{AdvancedMarkerElement:s}=await google.maps.importLibrary("marker"),t={lat:n.lat(),lng:n.lng()},o=!0===e.isNearby,i=o?CONFIG.markerColors.nearby:CONFIG.markerColors.primary,a=getBusinessTypeIcon(e.type),r=document.createElement("div");r.className="custom-marker",r.style.cursor="pointer",r.style.zIndex="1000",e.image_url?r.innerHTML=`\n        <div class="marker-container">\n          <div class="marker-pin" style="background-color: ${i};">\n            <div class="marker-image-container">\n              <img src="${e.image_url}" alt="${e.bname}" class="marker-image">\n            </div>\n          </div>\n          <div class="marker-shadow"></div>\n        </div>\n      `:r.innerHTML=`\n        <div class="marker-container">\n          <div class="marker-pin" style="background-color: ${i};">\n            <div class="marker-icon">\n              ${a}\n            </div>\n          </div>\n          <div class="marker-shadow"></div>\n        </div>\n      `;const l=new s({position:t,map,title:e.bname,content:r,collisionBehavior:o?"OPTIONAL_AND_HIDES_LOWER_PRIORITY":"REQUIRED"});return l.business=e,l.isNearby=o,r.addEventListener("click",(function(n){console.log("Marker element clicked:",e.bname),n.stopPropagation(),showInfoWindow(l)})),markers.push(l),console.log(`Added advanced marker for ${e.bname}`),l}catch(e){return console.error("Error creating advanced marker:",e),null}}function getBusinessTypeIcon(e){return{AUTO:'<i class="fa fa-car" aria-hidden="true"></i>',BEAU:'<i class="fa fa-scissors" aria-hidden="true"></i>',BOOK:'<i class="fa fa-book" aria-hidden="true"></i>',CLTH:'<i class="fa fa-shopping-bag" aria-hidden="true"></i>',CONV:'<i class="fa fa-shopping-basket" aria-hidden="true"></i>',DEPT:'<i class="fa fa-building" aria-hidden="true"></i>',ELEC:'<i class="fa fa-laptop" aria-hidden="true"></i>',ENTR:'<i class="fa fa-film" aria-hidden="true"></i>',FURN:'<i class="fa fa-bed" aria-hidden="true"></i>',FUEL:'<i class="fa fa-gas-pump" aria-hidden="true"></i>',GIFT:'<i class="fa fa-gift" aria-hidden="true"></i>',GROC:'<i class="fa fa-shopping-cart" aria-hidden="true"></i>',HARDW:'<i class="fa fa-hammer" aria-hidden="true"></i>',HEAL:'<i class="fa fa-heartbeat" aria-hidden="true"></i>',JEWL:'<i class="fa fa-gem" aria-hidden="true"></i>',OTHER:'<i class="fa fa-store" aria-hidden="true"></i>',RX:'<i class="fa fa-prescription-bottle" aria-hidden="true"></i>',REST:'<i class="fa fa-utensils" aria-hidden="true"></i>',RETAIL:'<i class="fa fa-shopping-bag" aria-hidden="true"></i>',SERV:'<i class="fa fa-concierge-bell" aria-hidden="true"></i>',SPEC:'<i class="fa fa-star" aria-hidden="true"></i>',SPRT:'<i class="fa fa-futbol" aria-hidden="true"></i>',TECH:'<i class="fa fa-microchip" aria-hidden="true"></i>',TOYS:'<i class="fa fa-gamepad" aria-hidden="true"></i>'}[e]||'<i class="fa fa-store" aria-hidden="true"></i>'}async function fetchPlacePhotosForBusiness(e){if(!e)return console.log("No business data provided"),null;try{const n=e._id||e.bname+e.address1;if(placeCache.has(n))return placeCache.get(n);let s=e.placeId;if(s||(s=await findPlaceIdBySearch(e),s&&(e.placeId=s,console.log(`Found place ID for ${e.bname}: ${s}`))),!s)return console.log(`No place ID found for ${e.bname}`),null;const{Place:t}=await google.maps.importLibrary("places");console.log(`Fetching photos for ${e.bname} with place ID: ${s}`);const o=new t({id:s});if(await o.fetchFields({fields:["photos","displayName"]}),o.photos&&o.photos.length>0){console.log(`Found ${o.photos.length} photos for ${e.bname}`);const s=o.photos[0].getUrl({maxWidth:100,maxHeight:100});return console.log(`Got photo URL for ${e.bname}`),placeCache.set(n,s),s}return console.log(`No photos found for ${e.bname}`),null}catch(n){return console.error(`Error fetching photos for ${e?e.bname:"unknown"}:`,n),null}}async function findPlaceIdBySearch(e){if(!e||!e.bname)return null;try{const{PlacesService:n}=await google.maps.importLibrary("places"),s=new google.maps.places.PlacesService(map),t=`${e.bname} ${e.address1} ${e.city} ${e.state} ${e.zip}`;return new Promise(((n,o)=>{s.textSearch({query:t,fields:["place_id"]},((s,o)=>{o===google.maps.places.PlacesServiceStatus.OK&&s&&s.length>0?(console.log(`Found place for ${e.bname}:`,s[0].place_id),n(s[0].place_id)):(console.log(`No place found for query: ${t}`),n(null))}))}))}catch(e){return console.error("Error finding place ID:",e),null}}function updateMarkerWithImage(e,n){if(!e||!e.content)return;const s=e.business;if(!s)return;const t=!0===s.isNearby?CONFIG.markerColors.nearby:CONFIG.markerColors.primary,o=document.createElement("div");o.className="custom-marker",o.style.cursor="pointer",o.style.zIndex="1000",o.innerHTML=`\n    <div class="marker-container">\n      <div class="marker-pin" style="background-color: ${t};">\n        <div class="marker-image-container">\n          <img src="${n}" alt="${s.bname}" class="marker-image">\n        </div>\n      </div>\n      <div class="marker-shadow"></div>\n    </div>\n  `,e.content=o,o.addEventListener("click",(function(n){console.log("Updated marker element clicked:",s.bname),n.stopPropagation(),showInfoWindow(e)}))}function showInfoWindow(e){if(console.log("showInfoWindow called with marker:",e),!e||!e.business)return void console.error("Invalid marker for info window",e);const n=e.business;console.log("Business data for info window:",n);const s=n.address2?`${n.address1}<br>${n.address2}<br>${n.city}, ${n.state} ${n.zip}`:`${n.address1}<br>${n.city}, ${n.state} ${n.zip}`,t=getBusinessTypeLabel(n.type),o=n.phone?`<p><strong>Phone:</strong> ${n.phone}</p>`:"",i=`\n    <div class="info-window">\n      <h3>${n.bname}</h3>\n      <p><strong>Address:</strong><br>${s}</p>\n      ${o}\n      <p><strong>Type:</strong> ${t}</p>\n      <div id="info-window-incentives-${n._id}">\n        <p><strong>Incentives:</strong> <em>Loading...</em></p>\n      </div>\n      <div class="info-window-actions">\n        <button class="view-details-btn" \n                onclick="window.viewBusinessDetails('${n._id}')">\n          View Details\n        </button>\n      </div>\n    </div>\n  `;infoWindow||(infoWindow=new google.maps.InfoWindow),infoWindow.setContent(i),infoWindow.open({map,anchor:e,shouldFocus:!1}),console.log("Opened info window for marker using anchor method"),fetchBusinessIncentivesForInfoWindow(n._id)}function searchNearbyBusinesses(e,n){console.log("Searching for nearby businesses near",e.lat(),e.lng());const s=getBaseURL();fetch(`${s}/api/business.js?operation=search&type=${n}`).then((e=>{if(!e.ok)throw new Error(`Failed to fetch nearby businesses: ${e.status}`);return e.json()})).then((n=>{if(!n.results||0===n.results.length)return void console.log("No additional nearby businesses found");console.log(`Found ${n.results.length} potential nearby businesses`);const s=markers.map((e=>e.business._id)),t=n.results.filter((e=>!s.includes(e._id)));console.log(`${t.length} new businesses to add to map`),t.forEach(((n,s)=>{setTimeout((()=>{geocodeNearbyBusiness(n,e)}),s*CONFIG.geocodeDelay)}))})).catch((e=>{console.error("Error searching for nearby businesses:",e)}))}function geocodeNearbyBusiness(e,n){if(!e||!e.address1)return;const s=`${e.address1}, ${e.city}, ${e.state} ${e.zip}`;(new google.maps.Geocoder).geocode({address:s},(function(s,t){if(t===google.maps.GeocoderStatus.OK&&s[0]){const t=s[0].geometry.location;google.maps.geometry.spherical.computeDistanceBetween(n,t)<=CONFIG.maxNearbyDistance&&(e.isNearby=!0,addAdvancedMarker(e,t))}}))}window.viewBusinessDetails=function(e){console.log("View details for business:",e),alert("This feature is coming soon: View details for "+e)},window.addBusinessToDatabase=async function(e){console.log("Adding place to database:",e);try{const{Place:n}=await google.maps.importLibrary("places"),s=new n({id:e});await s.fetchFields({fields:["displayName","formattedAddress","addressComponents","location","nationalPhoneNumber"]});const t={name:s.displayName||"",address1:getAddressComponentFromPlace(s,"street_number")+" "+getAddressComponentFromPlace(s,"route"),city:getAddressComponentFromPlace(s,"locality"),state:getAddressComponentFromPlace(s,"administrative_area_level_1"),zip:getAddressComponentFromPlace(s,"postal_code"),phone:s.nationalPhoneNumber||"",lat:s.location?.lat||0,lng:s.location?.lng||0,placeId:s.id};sessionStorage.setItem("newBusinessData",JSON.stringify(t)),window.location.href="business-add.html?prefill=true"}catch(e){console.error("Error fetching place details for addition:",e),alert("Sorry, we couldn't retrieve the details for this business. Please try again or add it manually.")}},window.initGoogleMap=async function(){console.log("Global initGoogleMap function called");try{const e=document.getElementById("map");if(!e)return void console.error("Map container not found in the DOM");const{Map:n}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:s}=await google.maps.importLibrary("marker");map=new n(e,{center:CONFIG.defaultCenter,zoom:CONFIG.defaultZoom,mapId:CONFIG.mapId,clickableIcons:!1}),infoWindow=new google.maps.InfoWindow,bounds=new google.maps.LatLngBounds,addInitialMapMessage(e),setupResetMapButton(),mapInitialized=!0,console.log("Google Map successfully initialized with Map ID:",CONFIG.mapId),pendingBusinessesToDisplay.length>0&&(console.log("Processing pending businesses to display on map"),displayBusinessesOnMap(pendingBusinessesToDisplay),pendingBusinessesToDisplay=[]),await setupMapClickHandler(),setupMarkerClickPriority(),setTimeout((()=>initImageLoading()),1500)}catch(e){console.error("Error initializing Google Map:",e),mapInitialized=!1;const n=document.getElementById("map");n&&(n.innerHTML=`\n        <div style="text-align: center; padding: 20px;">\n          <p>Sorry, we couldn't load the map. Please try refreshing the page.</p>\n          <p>Error: ${e.message}</p>\n        </div>\n      `)}},window.focusOnMapMarker=function(e){if(console.log("focusOnMapMarker called for business ID:",e),!mapInitialized||!map)return console.error("Map not initialized yet - cannot focus on marker"),void alert("Map is still loading. Please try again in a moment.");if(!markers||0===markers.length)return console.warn("No markers available yet."),void alert("No businesses are currently displayed on the map.");const n=markers.find((n=>n.business&&n.business._id===e));n?(map.setCenter(n.position),map.setZoom(16),showInfoWindow(n),document.getElementById("map").scrollIntoView({behavior:"smooth"}),console.log("Successfully focused on marker for business:",e)):(console.warn(`No marker found for business ID: ${e}`),alert("This business could not be located on the map. It may not have a complete address."),document.getElementById("map").scrollIntoView({behavior:"smooth"}))},document.addEventListener("DOMContentLoaded",(function(){initBusinessSearch()}));