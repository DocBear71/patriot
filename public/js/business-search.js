const CONFIG={mapId:"ebe8ec43a7bc252d",defaultCenter:{lat:39.8283,lng:-98.5795},defaultZoom:4,markerColors:{primary:"#EA4335",nearby:"#4285F4"},geocodeDelay:200,imageLoadDelay:1e3,maxNearbyDistance:2e4};let map=null,mapInitialized=!1,markers=[],infoWindow=null,bounds=null,pendingBusinessesToDisplay=[];const placeCache=new Map;function clearMarkers(){markers?(markers.forEach((e=>{e&&(e.map=null)})),markers=[]):markers=[]}function showPlaceInfoWindow(e,n){infoWindow||(infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1}));const t=getPlaceTypeLabel(e.types),s=`\n    <div class="info-window-wrapper">\n      <div class="info-window-header">\n        <h3>${e.displayName||"Unnamed Place"}</h3>\n      </div>\n      <div class="info-window-content">\n        <div class="info-window-scrollable">\n          <p><strong>Address:</strong><br>${e.formattedAddress||"Address not available"}</p>\n          ${e.nationalPhoneNumber?`<p><strong>Phone:</strong> ${e.nationalPhoneNumber}</p>`:""}\n          <p><strong>Type:</strong> ${t}</p>\n          <p>This business is not yet in the Patriot Thanks database.</p>\n        </div>\n      </div>\n      <div class="info-window-footer">\n        <button class="view-details-btn" \n                onclick="window.addBusinessToDatabase('${e.id}')">\n          Add to Patriot Thanks\n        </button>\n      </div>\n    </div>\n  `;infoWindow.setContent(s),infoWindow.setPosition(n),infoWindow.open(map),applyInfoWindowScrollableStyles()}function getUserLocation(){return new Promise(((e,n)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition((n=>{const t={lat:n.coords.latitude,lng:n.coords.longitude};console.log("Got user location:",t),e(t)}),(e=>{console.warn("Error getting location:",e),n(e)}),{enableHighAccuracy:!0,timeout:5e3,maximumAge:0}):(console.warn("Geolocation not supported by this browser"),n(new Error("Geolocation not supported")))}))}async function reverseGeocode(e){try{const n=new google.maps.Geocoder;return new Promise(((t,s)=>{n.geocode({location:e},((e,n)=>{n===google.maps.GeocoderStatus.OK?e[0]?(console.log("Reverse geocoded address:",e[0].formatted_address),t(e[0].formatted_address)):s(new Error("No results found")):s(new Error(`Geocoder failed due to: ${n}`))}))}))}catch(e){return console.error("Error reverse geocoding:",e),null}}function addCustomMarkerStyles(){if(!document.getElementById("custom-marker-css")){const e=document.createElement("style");e.id="custom-marker-css",e.textContent="\n            .custom-marker {\n                cursor: pointer;\n            }\n            .marker-pin {\n                width: 32px;\n                height: 40px;\n                border-radius: 50% 50% 50% 0;\n                background-color: #EA4335;\n                transform: rotate(-45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n            }\n            .marker-icon {\n                transform: rotate(45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                width: 24px;\n                height: 24px;\n            }\n            .info-window {\n                padding: 10px;\n                max-width: 300px;\n            }\n            .info-window h3 {\n                margin-top: 0;\n                margin-bottom: 10px;\n                color: #212121;\n            }\n            .add-business-btn {\n                background-color: #EA4335;\n                color: white;\n                border: none;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                margin-top: 10px;\n            }\n            .add-business-btn:hover {\n                background-color: #D32F2F;\n            }\n        ",document.head.appendChild(e)}}function getPlaceTypeLabel(e){if(!e||!e.length)return"Unknown";const n={restaurant:"Restaurant",food:"Food",store:"Store",establishment:"Business",point_of_interest:"Point of Interest",gas_station:"Gas Station",lodging:"Lodging",cafe:"Cafe",bar:"Bar"};for(const t of e)if(n[t])return n[t];return e[0].replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase()))}function getAddressComponentFromPlace(e,n){if(!e.addressComponents)return"";const t=e.addressComponents.find((e=>e.types.includes(n)));return t?t.shortText:""}function getBusinessTypeLabel(e){return{AUTO:"Automotive",BEAU:"Beauty",BOOK:"Bookstore",CLTH:"Clothing",CONV:"Convenience Store/Gas Station",DEPT:"Department Store",ELEC:"Electronics",ENTR:"Entertainment",FURN:"Furniture",FUEL:"Fuel Station/Truck Stop",GIFT:"Gift Shop",GROC:"Grocery",HARDW:"Hardware",HEAL:"Health",JEWL:"Jewelry",OTHER:"Other",RX:"Pharmacy",REST:"Restaurant",RETAIL:"Retail",SERV:"Service",SPEC:"Specialty",SPRT:"Sporting Goods",TECH:"Technology",TOYS:"Toys"}[e]||e}function getIncentiveTypeLabel(e){return{VT:"Veteran",AD:"Active Duty",FR:"First Responder",SP:"Spouse",OT:"Other"}[e]||e}function fetchBusinessIncentivesForInfoWindow(e){if(!e)return void console.error("No business ID provided for fetching incentives");const n=getBaseURL();fetch(`${n}/api/incentives.js?business_id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to fetch incentives: ${e.status}`);return e.json()})).then((n=>{const t=document.getElementById(`info-window-incentives-${e}`);if(!t)return void console.error(`Could not find incentives div for business ${e}`);if(!n.results||0===n.results.length)return void(t.innerHTML="<p><strong>Incentives:</strong> No incentives found</p>");let s='<p><strong>Incentives:</strong></p><ul class="incentives-list">';n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),t=e.other_description?` (${e.other_description})`:"";s+=`\n            <li>\n              <strong>${n}${t}:</strong> ${e.amount}%\n              ${e.information?` - ${e.information}`:""}\n            </li>\n          `}})),s+="</ul>",t.innerHTML='<p><strong>Incentives:</strong></p><ul class="incentives-list"></ul>'===s?"<p><strong>Incentives:</strong> No active incentives found</p>":s})).catch((n=>{console.error(`Error fetching incentives for info window: ${n}`);const t=document.getElementById(`info-window-incentives-${e}`);t&&(t.innerHTML="<p><strong>Incentives:</strong> Error loading incentives</p>")}))}function fetchBusinessIncentives(e){if(!e)return void console.error("No business ID provided for fetching incentives");const n=`${getBaseURL()}/api/incentives.js?business_id=${e}`;console.log("Fetching incentives from: ",n),fetch(n).then((e=>{if(!e.ok)throw new Error(`Failed to fetch incentives: ${e.status} ${e.statusText}`);return e.json()})).then((n=>{console.log(`Incentives data for business ${e}:`,n);const t=document.getElementById(`incentives-for-${e}`);if(!t)return void console.error(`Could not find cell for incentives-for-${e}`);if(!n.results||0===n.results.length)return void(t.innerHTML="No incentives found");let s="";n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),t=e.other_description?` (${e.other_description})`:"";s+=`\n            <div class="incentive-item">\n              <strong>${n}${t}:</strong> ${e.amount}%\n              <div class="incentive-info">${e.information||""}</div>\n            </div>\n          `}})),t.innerHTML=""===s?"No active incentives found":s})).catch((n=>{console.error(`Error fetching incentives for business ${e}:`,n);const t=document.getElementById(`incentives-for-${e}`);t&&(t.innerHTML="Error loading incentives")}))}function displaySearchResults(e){try{const n=document.getElementById("business_search"),t=document.getElementById("search_table");if(!n||!t)return console.error("Required elements not found in the DOM"),void alert("There was an error displaying search results. Please try again later.");let s=n.querySelector("tbody");if(!s)return console.error("Table body not found within business_search table"),void alert("There was an error displaying search results. Please try again later.");s.innerHTML="",Array.isArray(e)||(console.error("businesses is not an array:",e),e=[]),t.style.display="block";const o=t.querySelector("h5");if(o&&(o.style.display="none"),0===e.length)return s.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria.</td></tr>',void t.scrollIntoView({behavior:"smooth"});e.forEach((e=>{if(!e)return;const n=e.address2?`${e.address1}<br>${e.address2}<br>${e.city}, ${e.state} ${e.zip}`:`${e.address1}<br>${e.city}, ${e.state} ${e.zip}`,t=getBusinessTypeLabel(e.type),o=document.createElement("tr"),i=`<button class="view-map-btn" onclick="focusOnMapMarker('${e._id}')">View on Map</button>`;o.innerHTML=`\n        <th class="left_table" data-business-id="${e._id}">${e.bname}</th>\n        <th class="left_table">${n}</th>\n        <th class="left_table">${t}</th>\n        <th class="right_table" id="incentives-for-${e._id}">Loading incentives...</th>\n        <th class="center_table">${i}</th>\n      `,s.appendChild(o),fetchBusinessIncentives(e._id)})),t.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error displaying search results: ",e),alert("There was an error displaying the search results: "+e.message)}}function displayBusinessSearchResults(e,n){try{if(n.innerHTML="",Array.isArray(e)||(console.error("businesses is not an array:",e),e=[]),0===e.length)return n.innerHTML='<div class="error">No businesses found matching your search criteria.</div>',void n.scrollIntoView({behavior:"smooth"});const t=document.createElement("table");t.className="results-table";const s={name:"Business Name",address:"Address",city:"City",state:"State",zip:"Zip",action:"Action"},o=document.createElement("thead");o.innerHTML=`\n      <tr>\n        <th>${s.name}</th>\n        <th>${s.address}</th>\n        <th>${s.city}</th>\n        <th>${s.state}</th>\n        <th>${s.zip}</th>\n        <th>${s.action}</th>\n      </tr>\n    `,t.appendChild(o);const i=document.createElement("tbody");e.forEach((e=>{if(!e)return;const n=document.createElement("tr");n.innerHTML=`\n        <td data-title="${s.name}">${e.bname}</td>\n        <td data-title="${s.address}">${e.address1}${e.address2?"<br>"+e.address2:""}</td>\n        <td data-title="${s.city}">${e.city}</td>\n        <td data-title="${s.state}">${e.state}</td>\n        <td data-title="${s.zip}">${e.zip}</td>\n        <td data-title="${s.action}"><button class="select-business" data-business-id="${e._id}">Select</button></td>\n      `,i.appendChild(n)})),t.appendChild(i),n.appendChild(t),addResponsiveTableStyles(),document.querySelectorAll(".select-business").forEach((n=>{n.addEventListener("click",(function(){const n=this.getAttribute("data-business-id");if(!n)return void console.error("No business ID found on button");const t=e.find((e=>e._id===n));if(!t)return void console.error("Could not find business with ID: "+n);console.log("Selected business: ",t);const s=window.location.pathname;console.log("Current page: ",s),handleBusinessSelectionByPage(s,t)}))})),n.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error displaying business search results: "+e);const n=document.getElementById("business-search-results");n?(n.innerHTML=`<div class="error">Error displaying search results: ${e.message}</div>`,n.scrollIntoView({behavior:"smooth"})):alert("Error displaying search results: "+e.message)}}function handleBusinessSelectionByPage(e,n){e.includes("incentive-update.html")?(console.log("On incentive-update page"),"function"==typeof window.selectBusinessForIncentive?window.selectBusinessForIncentive(n):"function"==typeof window.selectBusinessForIncentives?window.selectBusinessForIncentives(n):(console.error("selectBusinessForIncentive(s) not found, falling back"),handleBusinessSelection(n))):e.includes("business-update.html")?(console.log("On business-update page"),"function"==typeof window.selectBusinessForUpdate?window.selectBusinessForUpdate(n):(console.error("selectBusinessForUpdate not found, falling back"),handleBusinessSelection(n))):e.includes("incentive-add.html")?(console.log("On incentive-add page"),"function"==typeof window.selectBusinessForIncentive?window.selectBusinessForIncentive(n):handleBusinessSelection(n)):e.includes("incentive-view.html")||e.endsWith("business-search.html")?(console.log("On incentive-view page"),"function"==typeof window.viewBusinessIncentives?window.viewBusinessIncentives(n):handleBusinessSelection(n)):(console.error("Using fallback business selection handler"),handleBusinessSelection(n))}function addResponsiveTableStyles(){if(!document.getElementById("responsive-table-css")){const e=document.createElement("style");e.id="responsive-table-css",e.textContent="\n      /* Base table styles */\n      .results-table {\n        width: 90%;\n        margin: 20px auto;\n        border-collapse: collapse;\n        text-align: left;\n      }\n      \n      .results-table th, .results-table td {\n        border: 1px solid #ddd;\n        padding: 8px;\n      }\n      \n      .results-table th {\n        background-color: #f2f2f2;\n        font-weight: bold;\n        text-align: center;\n      }\n      \n      .results-table tr:nth-child(even) {\n        background-color: #f9f9f9;\n      }\n      \n      .results-table tr:hover {\n        background-color: #f1f1f1;\n      }\n      \n      /* Responsive table for small screens */\n      @media only screen and (max-width: 767px) {\n        .results-table {\n          width: 100%;\n          margin: 10px 0;\n        }\n        \n        .results-table, .results-table thead, .results-table tbody, .results-table tr {\n          display: block;\n        }\n        \n        .results-table thead {\n          display: none;\n        }\n        \n        .results-table tr {\n          border: 1px solid #ccc;\n          margin-bottom: 15px;\n          padding: 8px;\n          background-color: #f9f9f9;\n        }\n        \n        .results-table td {\n          display: block;\n          border: none;\n          border-bottom: 1px solid #eee;\n          padding: 8px;\n          margin-bottom: 6px;\n          text-align: left;\n          position: relative;\n        }\n        \n        .results-table td::before {\n          content: attr(data-title);\n          display: block;\n          font-weight: bold;\n          margin-bottom: 6px;\n          color: #333;\n        }\n        \n        /* Ensure buttons are properly displayed */\n        .select-business {\n          margin: 8px 0;\n          display: inline-block;\n        }\n      }\n    ",document.head.appendChild(e)}}function handleBusinessSelection(e){console.log("Handling business selection with fallback: ",e);try{const n=document.getElementById("business-info-section");if(!n)return void console.error("business-info-section not found");document.getElementById("selected-business-id")&&(selectedBusinessId=e._id||""),populateBusinessInfo(e);const t=document.getElementById("incentive-section");t&&(t.style.display="block"),n.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error in handleBusinessSection: "+e),alert("There was an error selecting the business: "+e.message)}}function populateBusinessInfo(e){if(e)try{const n=document.getElementById("bname");n&&(n.value=e.bname||"");const t=document.getElementById("address1");t&&(t.value=e.address1||"");const s=document.getElementById("address2");s&&(s.value=e.address2||"");const o=document.getElementById("city");o&&(o.value=e.city||"");const i=document.getElementById("zip");i&&(i.value=e.zip||"");const a=document.getElementById("phone");a&&(a.value=e.phone||"");const r=document.getElementById("state");if(r){const n=e.state||"";for(let e=0;e<r.options.length;e++)if(r.options[e].value===n){r.selectedIndex=e;break}}const l=document.getElementById("type");if(l){const n=e.type||"";for(let e=0;e<l.options.length;e++)if(l.options[e].value===n){l.selectedIndex=e;break}}console.log("Business info populated successfully")}catch(e){console.error("Error in populateBusinessInfo: "+e)}else console.error("No business data provided to populateBusinessInfo")}function isNotEmpty(e){return""!==e.trim()}function validateField(e,n){console.log(`Validating ${e.id} with value: ${e.value}`),n(e.value)?(e.classList.remove("invalid-field"),e.classList.add("valid-field"),e.setAttribute("data-valid","true"),console.log(`${e.id} is VALID`)):(e.classList.remove("valid-field"),e.classList.add("invalid-field"),e.setAttribute("data-valid","false"),console.log(`${e.id} is INVALID`))}function getBaseURL(){return"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:window.location.origin}function initBusinessSearch(){console.log("Business search with Google Maps loaded!");const e={businessName:document.getElementById("business-name"),address:document.getElementById("address"),useMyLocation:document.getElementById("use-my-location")},n=document.getElementById("business-search-form");n?n.addEventListener("submit",(function(n){if(n.preventDefault(),isNotEmpty(e.businessName.value)||isNotEmpty(e.address.value)){const n={businessName:e.businessName.value,address:e.address.value};console.log("Form data to submit:",n),mapInitialized||console.warn("Map not initialized yet. Will display businesses after map loads."),clearMarkers();const t=document.getElementById("initial-map-message");t&&t.remove(),retrieveFromMongoDB(n)}else alert("Please enter either a business name or address to search")})):console.warn("Business search form not found in the DOM"),e.businessName&&e.businessName.addEventListener("input",(function(){validateField(this,isNotEmpty)})),e.address&&e.address.addEventListener("input",(function(){validateField(this,isNotEmpty)})),e.useMyLocation&&e.useMyLocation.addEventListener("change",(function(){const n=document.getElementById("location-status");this.checked?(e.address&&(e.address.disabled=!0,e.address.placeholder="Using your current location..."),n&&(n.textContent="Location will be used when you search",n.style.display="block",n.style.color="#666")):(e.address&&(e.address.disabled=!1,e.address.placeholder="Address, City, State, or Zip"),n&&(n.style.display="none"))}))}async function retrieveFromMongoDB(e){try{const n=document.getElementById("business-search-results")||document.getElementById("search_table");n&&(n.innerHTML='<div class="loading">Searching for businesses...</div>',n.style.display="block");const t={};e.businessName&&""!==e.businessName.trim()&&(t.business_name=e.businessName),e.address&&""!==e.address.trim()&&(t.address=e.address);const s=new URLSearchParams(t).toString(),o=`${getBaseURL()}/api/business.js?operation=search&${s}`;console.log("Submitting search to API at: ",o);const i=await fetch(o,{method:"GET",headers:{"Content-Type":"application/json; charset=UTF-8"}});if(console.log("Response status: ",i.status),!i.ok){const e=await i.text();throw console.error("Error response: ",e),new Error(`Failed to retrieve data from MongoDB: ${i.status} ${e}`)}const a=await i.json();if(console.log("Search results:",a),a.results&&0!==a.results.length)if(document.getElementById("search_table"))displaySearchResults(a.results),displayBusinessesOnMap(a.results);else{let e=document.getElementById("business-search-results");displayBusinessSearchResults(a.results,e)}else console.log("No results in our database, searching Google Places..."),await searchGooglePlaces(e)}catch(e){console.error("Error: ",e)}}async function searchGooglePlaces(e){try{console.log("Searching Google Places for:",e);const n=document.getElementById("map");n&&(n.style.display="block",n.style.height="400px",console.log("Map container style:",n.style.display,n.style.height)),mapInitialized&&map&&(console.log("Triggering map resize event"),google.maps.event.trigger(map,"resize"));const t=document.getElementById("initial-map-message");t&&t.remove(),clearMarkers();let s="";e.businessName&&(s+=e.businessName),e.address&&(s+=" "+e.address),s=s.trim(),console.log("Place search query:",s);const{SearchBox:o}=await google.maps.importLibrary("places"),i=document.createElement("div");i.id="map-loading",i.innerHTML="Searching for businesses...",i.style.position="absolute",i.style.top="50%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",i.style.backgroundColor="white",i.style.padding="10px",i.style.borderRadius="5px",i.style.zIndex="1000",n.appendChild(i),(new google.maps.Geocoder).geocode({address:s},(async function(n,t){if(t===google.maps.GeocoderStatus.OK){console.log("Geocode results:",n),bounds=new google.maps.LatLngBounds;try{for(const t of n){const n={location:t.geometry.location,radius:"1000",query:e.businessName||""},{Place:s}=await google.maps.importLibrary("places");new google.maps.places.PlacesService(map).textSearch(n,((e,n)=>{const t=document.getElementById("map-loading");if(t&&t.remove(),n===google.maps.places.PlacesServiceStatus.OK&&e&&e.length>0)console.log("Places search results:",e),displayGoogleSearchResults(e.map((e=>{let n="",t="",s="",o="";if(e.formatted_address){const i=e.formatted_address.split(",");if(i.length>=1&&(n=i[0].trim()),i.length>=2&&(t=i[1].trim()),i.length>=3){const e=i[2].trim().split(" ");e.length>=1&&(s=e[0].trim()),e.length>=2&&(o=e[1].trim())}}let i="OTHER";e.types&&(e.types.includes("restaurant")?i="REST":e.types.includes("store")?i="RETAIL":e.types.includes("hardware_store")&&(i="HARDW"));const a={_id:"google_"+e.place_id,bname:e.name,address1:n,city:t,state:s,zip:o,type:i,phone:e.formatted_phone_number||"",isGooglePlace:!0,placeId:e.place_id,lat:e.geometry.location.lat(),lng:e.geometry.location.lng()},r={lat:e.geometry.location.lat(),lng:e.geometry.location.lng()};return addAdvancedMarker(a,r)&&bounds.extend(r),a}))),markers.length>0&&(console.log("Fitting map to bounds with",markers.length,"markers"),map.fitBounds(bounds),1===markers.length&&setTimeout((()=>{map.setZoom(15)}),100)),setTimeout(debugMapState,500);else{console.log("No places found or error:",n);const e=document.getElementById("search_table");if(e){const n=e.querySelector("tbody");n&&(n.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria in our database or Google Maps.</td></tr>'),e.style.display="block",e.scrollIntoView({behavior:"smooth"})}}}))}}catch(e){console.error("Error searching for places:",e);const n=document.getElementById("map-loading");n&&n.remove();const t=document.getElementById("search_table");if(t){const e=t.querySelector("tbody");e&&(e.innerHTML='<tr><td colspan="5" class="text-center">Error searching for businesses. Please try again.</td></tr>'),t.style.display="block",t.scrollIntoView({behavior:"smooth"})}}}else{console.error("Geocoding failed:",t);const e=document.getElementById("map-loading");e&&e.remove();const n=document.getElementById("search_table");if(n){const e=n.querySelector("tbody");e&&(e.innerHTML='<tr><td colspan="5" class="text-center">Could not find the location. Please try a different search.</td></tr>'),n.style.display="block",n.scrollIntoView({behavior:"smooth"})}}}))}catch(e){console.error("Error in searchGooglePlaces:",e);const n=document.getElementById("map-loading");n&&n.remove();const t=document.getElementById("search_table");if(t){const n=t.querySelector("tbody");n&&(n.innerHTML=`<tr><td colspan="5" class="text-center">Error: ${e.message}</td></tr>`),t.style.display="block",t.scrollIntoView({behavior:"smooth"})}}}function ensureMapVisibility(){const e=document.getElementById("map");e&&(e.style.display="block",e.style.height="400px",console.log("Map container dimensions:",e.offsetWidth,"x",e.offsetHeight),mapInitialized&&map&&(google.maps.event.trigger(map,"resize"),markers.length>0&&(bounds||(bounds=new google.maps.LatLngBounds),markers.forEach((e=>{e&&e.position&&bounds.extend(e.position)})),bounds.isEmpty()?1===markers.length&&markers[0].position&&(map.setCenter(markers[0].position),map.setZoom(15),console.log("Centered on single marker")):(map.fitBounds(bounds),console.log("Fitted map to bounds for",markers.length,"markers")))))}function displayGoogleSearchResults(e){const n=document.getElementById("business_search"),t=document.getElementById("search_table");if(!n||!t)return void console.error("Required elements not found in the DOM");let s=n.querySelector("tbody");if(!s)return void console.error("Table body not found within business_search table");if(s.innerHTML="",!Array.isArray(e)||0===e.length)return s.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria.</td></tr>',t.style.display="block",void t.scrollIntoView({behavior:"smooth"});t.style.display="block";const o=t.querySelector("h5");o&&(o.style.display="none"),e.forEach((e=>{if(!e)return;const n=e.address1?`${e.address1}<br>${e.city}, ${e.state} ${e.zip}`:"Address information not available",t=getBusinessTypeLabel(e.type),o=document.createElement("tr"),i=`<button class="view-map-btn" onclick="focusOnMapMarker('${e._id}')">View on Map</button>`,a=e.isGooglePlace?`<button class="add-to-db-btn" onclick="addGooglePlaceToDatabase('${e.placeId}')">Add to Patriot Thanks</button>`:"";o.innerHTML=`\n            <th class="left_table" data-business-id="${e._id}">${e.bname}</th>\n            <th class="left_table">${n}</th>\n            <th class="left_table">${t}</th>\n            <th class="right_table">${e.isGooglePlace?"Not in database yet":"Loading incentives..."}</th>\n            <th class="center_table">${i} ${a}</th>\n        `,s.appendChild(o),e.isGooglePlace||fetchBusinessIncentives(e._id)})),t.scrollIntoView({behavior:"smooth"})}function addInitialMapMessage(e){const n=document.createElement("div");n.id="initial-map-message",n.innerHTML="Search for businesses to see them on the map",n.style.position="absolute",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.background="white",n.style.padding="10px",n.style.borderRadius="5px",n.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)",n.style.zIndex="1",e.appendChild(n)}function setupResetMapButton(){const e=document.getElementById("reset-map");e&&e.addEventListener("click",resetMapView)}function resetMapView(){mapInitialized&&map?(map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom),infoWindow&&infoWindow.close()):console.error("Cannot reset map view - map not initialized")}async function setupMapClickHandler(){if(map){console.log("Setting up map click handler");try{const{Place:e}=await google.maps.importLibrary("places");map.addListener("click",(async function(n){if(console.log("Map clicked",n),n.placeId){n.stop(),console.log("POI clicked, placeId:",n.placeId);try{const t=new e({id:n.placeId});await t.fetchFields({fields:["displayName","formattedAddress","location","types","businessStatus","nationalPhoneNumber"]}),console.log("Place details:",t),showPlaceInfoWindow(t,n.latLng)}catch(e){console.error("Error fetching place details:",e),alert("Error loading place details. Please try again.")}}})),console.log("Map click handler set up")}catch(e){console.error("Error setting up map click handler:",e)}}else console.error("Map not initialized in setupMapClickHandler")}function setupMarkerClickPriority(){map?(console.log("Setting up marker click priority"),google.maps.event.addListener(map,"click",(function(e){if(e.placeId){const n=e.latLng,t=20,s=map.getProjection();if(!s)return;const o=Math.pow(2,map.getZoom()),i=s.fromLatLngToPoint(n);for(const n of markers){if(!n.position)continue;const a=n.position,r=s.fromLatLngToPoint(a);if(Math.sqrt(Math.pow((i.x-r.x)*o,2)+Math.pow((i.y-r.y)*o,2))<=t)return console.log("Preventing POI click, using our marker instead"),e.stop(),void setTimeout((()=>{showInfoWindow(n)}),10)}}}),{passive:!1})):console.error("Map not initialized, cannot set up click priority")}function initAdditionalMapFeatures(){console.log("Initializing additional map features"),addCustomMarkerStyleFixes(),setupMarkerClickPriority(),customizeInfoWindows()}function addCustomMarkerStyleFixes(){if(!document.getElementById("marker-style-fixes")){const e=document.createElement("style");e.id="marker-style-fixes",e.textContent="\n            /* Ensure icon is properly displayed inside marker */\n            .marker-icon {\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                width: 20px;\n                height: 20px;\n                color: #333;\n            }\n            \n            /* Fix for Font Awesome icons inside markers */\n            .marker-icon i {\n                font-size: 12px !important;\n                color: #333 !important;\n            }\n            \n            /* Info window action button specific styling */\n            .info-window-actions .view-details-btn {\n                margin-top: 8px;\n            }\n        ",document.head.appendChild(e)}}function customizeInfoWindows(){applyInfoWindowScrollableStyles();const e=document.createElement("style");e.textContent="\n        /* Make close button more visible */\n        .gm-ui-hover-effect {\n            opacity: 0.8 !important;\n            width: 24px !important;\n            height: 24px !important;\n            right: 2px !important;\n            top: 2px !important;\n        }\n        \n        .gm-ui-hover-effect span {\n            width: 16px !important;\n            height: 16px !important;\n        }\n        \n        .gm-ui-hover-effect:hover {\n            opacity: 1 !important;\n        }\n    ",document.head.appendChild(e)}function createEnhancedInfoWindow(){const e=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1});return google.maps.event.addListener(e,"domready",(function(){console.log("Info window DOM ready, applying styles"),setTimeout((()=>{const e=document.querySelectorAll(".info-window-scrollable");e.length>0&&(console.log("Found scrollable elements, adjusting height"),e.forEach((e=>{const n=e.querySelector(".incentives-list");n&&n.offsetHeight>150&&(console.log("Large content detected, ensuring scrollable"),e.style.overflowY="auto")})))}),100)})),e}function displayBusinessesOnMap(e){return mapInitialized&&map?(console.log("Displaying businesses on map:",e.length),Array.isArray(e)&&0!==e.length?(clearMarkers(),bounds=new google.maps.LatLngBounds,e.forEach(((n,t)=>{geocodeBusinessAddress(n,t,e.length)})),ensureMapVisibility(),void(e.some((e=>e.lat&&e.lng||e.location&&e.location.coordinates&&2===e.location.coordinates.length))&&(document.getElementById("map-container").style.display="block"))):(console.log("No businesses to display on map"),map.setCenter(CONFIG.defaultCenter),void map.setZoom(CONFIG.defaultZoom))):(console.log("Map not initialized yet. Storing businesses for later display."),void(pendingBusinessesToDisplay=e))}async function enhanceMarkersWithImages(){if(markers&&0!==markers.length){console.log("Enhancing markers with images...");for(const e of markers){if(!e.business)continue;if(e.business.image_url)continue;const n=await fetchPlacePhotosForBusiness(e.business);n&&(e.business.image_url=n,updateMarkerWithImage(e,n))}}}function geocodeBusinessAddress(e,n,t){if(!e||!e.address1)return void console.error("Invalid business data for geocoding",e);const s=`${e.address1}, ${e.city}, ${e.state} ${e.zip}`,o=new google.maps.Geocoder;setTimeout((()=>{o.geocode({address:s},(function(o,i){if(i===google.maps.GeocoderStatus.OK){if(o[0]){const s=o[0].geometry.location;addAdvancedMarker(e,s),bounds.extend(s),n===t-1&&(map.fitBounds(bounds),1===t&&map.setZoom(15),t>=1&&searchNearbyBusinesses(s,e.type))}}else console.error("Geocode failed for address "+s+": "+i)}))}),n*CONFIG.geocodeDelay)}async function addAdvancedMarker(e,n){try{let t;if(console.log("Adding marker for business:",e.bname),n&&"function"==typeof n.lat&&"function"==typeof n.lng)t={lat:n.lat(),lng:n.lng()};else if(n&&"number"==typeof n.lat&&"number"==typeof n.lng)t=n;else{if(!e.lat||!e.lng)return console.error("Invalid location for marker:",n),console.error("Business data:",e),null;t={lat:e.lat,lng:e.lng}}console.log("Creating marker at position:",t);const s=!0===e.isNearby,o=new google.maps.Marker({position:t,map,title:e.bname,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:s?CONFIG.markerColors.nearby:CONFIG.markerColors.primary,fillOpacity:1,strokeWeight:1,strokeColor:"#FFFFFF",scale:10},animation:google.maps.Animation.DROP,zIndex:s?1:2});return o.business=e,o.position=t,o.addListener("click",(function(){console.log("Marker clicked for:",e.bname),showInfoWindow(o)})),markers.push(o),console.log("Successfully added marker for",e.bname,"- Markers count:",markers.length),o}catch(e){return console.error("Error creating marker:",e),null}}function getBusinessTypeIconHTML(e){return{AUTO:'<i class="fas fa-car" style="transform: rotate(-45deg);"></i>',BEAU:'<i class="fas fa-spa" style="transform: rotate(-45deg);"></i>',BOOK:'<i class="fas fa-book" style="transform: rotate(-45deg);"></i>',CLTH:'<i class="fas fa-tshirt" style="transform: rotate(-45deg);"></i>',CONV:'<i class="fas fa-store" style="transform: rotate(-45deg);"></i>',DEPT:'<i class="fas fa-shopping-bag" style="transform: rotate(-45deg);"></i>',ELEC:'<i class="fas fa-bolt" style="transform: rotate(-45deg);"></i>',ENTR:'<i class="fas fa-film" style="transform: rotate(-45deg);"></i>',FURN:'<i class="fas fa-couch" style="transform: rotate(-45deg);"></i>',FUEL:'<i class="fas fa-gas-pump" style="transform: rotate(-45deg);"></i>',GIFT:'<i class="fas fa-gift" style="transform: rotate(-45deg);"></i>',GROC:'<i class="fas fa-shopping-cart" style="transform: rotate(-45deg);"></i>',HARDW:'<i class="fas fa-hammer" style="transform: rotate(-45deg);"></i>',HEAL:'<i class="fas fa-heartbeat" style="transform: rotate(-45deg);"></i>',JEWL:'<i class="fas fa-gem" style="transform: rotate(-45deg);"></i>',OTHER:'<i class="fas fa-store-alt" style="transform: rotate(-45deg);"></i>',RX:'<i class="fas fa-prescription-bottle-alt" style="transform: rotate(-45deg);"></i>',REST:'<i class="fas fa-utensils" style="transform: rotate(-45deg);"></i>',RETAIL:'<i class="fas fa-shopping-basket" style="transform: rotate(-45deg);"></i>',SERV:'<i class="fas fa-concierge-bell" style="transform: rotate(-45deg);"></i>',SPEC:'<i class="fas fa-star" style="transform: rotate(-45deg);"></i>',SPRT:'<i class="fas fa-football-ball" style="transform: rotate(-45deg);"></i>',TECH:'<i class="fas fa-laptop" style="transform: rotate(-45deg);"></i>',TOYS:'<i class="fas fa-gamepad" style="transform: rotate(-45deg);"></i>'}[e]||'<i class="fas fa-store" style="transform: rotate(-45deg);"></i>'}function getBusinessTypeSVGIcon(e){return{AUTO:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path fill="#EA4335" d="M5,11L6.5,6.5H17.5L19,11M17.5,16A1.5,1.5 0 0,1 16,14.5A1.5,1.5 0 0,1 17.5,13A1.5,1.5 0 0,1 19,14.5A1.5,1.5 0 0,1 17.5,16M6.5,16A1.5,1.5 0 0,1 5,14.5A1.5,1.5 0 0,1 6.5,13A1.5,1.5 0 0,1 8,14.5A1.5,1.5 0 0,1 6.5,16M18.92,6C18.72,5.42 18.16,5 17.5,5H6.5C5.84,5 5.28,5.42 5.08,6L3,12V20A1,1 0 0,0 4,21H5A1,1 0 0,0 6,20V19H18V20A1,1 0 0,0 19,21H20A1,1 0 0,0 21,20V12L18.92,6Z"/></svg>',BEAU:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path fill="#4285F4" d="M15.5,9.63C15.31,6.84 14.18,4.12 12.06,2C9.92,4.14 8.74,6.86 8.5,9.63C9.79,10.31 10.97,11.19 12,12.26C13.03,11.2 14.21,10.32 15.5,9.63M12,15.45C9.85,12.17 6.18,10 2,10C2,20 11.32,21.89 12,22C12.68,21.88 22,20 22,10C17.82,10 14.15,12.17 12,15.45Z"/></svg>',REST:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path fill="#FBC02D" d="M8.1,13.34L3.91,9.16C2.35,7.59 2.35,5.06 3.91,3.5L10.93,10.5L8.1,13.34M14.88,11.53L13.41,13L20.29,19.88L18.88,21.29L12,14.41L5.12,21.29L3.71,19.88L13.47,10.12C12.76,8.59 13.26,6.44 14.85,4.85C16.76,2.93 19.5,2.57 20.96,4.03C22.43,5.5 22.07,8.24 20.15,10.15C18.56,11.74 16.41,12.24 14.88,11.53Z"/></svg>',GROC:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path fill="#0F9D58" d="M7,18A2,2 0 0,1 5,20A2,2 0 0,1 3,18A2,2 0 0,1 5,16A2,2 0 0,1 7,18M17,18A2,2 0 0,1 15,20A2,2 0 0,1 13,18A2,2 0 0,1 15,16A2,2 0 0,1 17,18M7.17,14.75L7.2,14.63L8.1,13H15.55C16.3,13 16.96,12.59 17.3,11.97L21.16,4.96L19.42,4H19.41L18.31,6L15.55,11H8.53L8.4,10.73L6.16,6L5.21,4L4.27,2H1V4H3L6.6,11.59L5.25,14.04C5.09,14.32 5,14.65 5,15A2,2 0 0,0 7,17H19V15H7.42C7.29,15 7.17,14.89 7.17,14.75Z"/></svg>',OTHER:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path fill="#616161" d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,7V9H16V13C16,14.1 15.1,15 14,15H12V17H8V13H12V11H8V7H12Z"/></svg>'}[e]||'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path fill="#616161" d="M12,7V3H2V21H22V7H12M10,19H4V17H10V19M10,15H4V13H10V15M10,11H4V9H10V11M10,7H4V5H10V7M20,19H12V5H20V19M18,11H14V13H18V11M18,7H14V9H18V7M18,15H14V17H18V15Z"/></svg>'}async function fetchPlacePhotosForBusiness(e){if(!e)return console.log("No business data provided"),getDefaultBusinessIcon();try{const n=e._id||e.bname+e.address1;if(placeCache.has(n))return placeCache.get(n);const t=getBusinessTypeIcon(e.type);return placeCache.set(n,t),t}catch(e){return console.error(`Error getting business icon: ${e.message}`),getDefaultBusinessIcon()}}function getBusinessTypeIcon(e){const n={AUTO:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/car_repair-71.png",BEAU:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/spa-71.png",BOOK:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/shopping-71.png",CLTH:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/shopping-71.png",CONV:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/convenience-71.png",DEPT:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/shopping-71.png",ELEC:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/electronics-71.png",ENTR:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/movies-71.png",FURN:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/shopping-71.png",FUEL:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/gas_station-71.png",GIFT:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/shopping-71.png",GROC:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/supermarket-71.png",HARDW:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/hardware-71.png",HEAL:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png",JEWL:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/shopping-71.png",OTHER:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png",RX:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/pharmacy-71.png",REST:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/restaurant-71.png",RETAIL:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/shopping-71.png",SERV:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png",SPEC:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/shopping-71.png",SPRT:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/sports-71.png",TECH:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/electronics-71.png",TOYS:"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/shopping-71.png"};return n[e]?n[e]:getDefaultBusinessIcon()}function getDefaultBusinessIcon(){return"https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/generic_business-71.png"}function updateMarkerWithImage(e,n){if(!e||!e.content)return;const t=e.business;if(!t)return;const s=!0===t.isNearby?CONFIG.markerColors.nearby:CONFIG.markerColors.primary,o=document.createElement("div");o.className="custom-marker",o.style.cursor="pointer",o.style.zIndex="1000",o.innerHTML=`\n    <div class="marker-container">\n      <div class="marker-pin" style="background-color: ${s};">\n        <div class="marker-image-container">\n          <img src="${n}" alt="${t.bname}" class="marker-image">\n        </div>\n      </div>\n      <div class="marker-shadow"></div>\n    </div>\n  `,e.content=o,o.addEventListener("click",(function(n){console.log("Updated marker element clicked:",t.bname),n.stopPropagation(),showInfoWindow(e)}))}function showInfoWindow(e){if(console.log("showInfoWindow called with marker:",e),!e||!e.business)return void console.error("Invalid marker for info window",e);const n=e.business;console.log("Business data for info window:",n);const t=n.address2?`${n.address1}<br>${n.address2}<br>${n.city}, ${n.state} ${n.zip}`:`${n.address1}<br>${n.city}, ${n.state} ${n.zip}`,s=getBusinessTypeLabel(n.type),o=n.phone?`<p><strong>Phone:</strong> ${n.phone}</p>`:"",i=n._id&&n._id.toString().startsWith("google_"),a=i?'<div class="info-window-incentives">\n             <p><strong>Incentives:</strong> <em>Not in database yet</em></p>\n           </div>':`<div id="info-window-incentives-${n._id}">\n             <p><strong>Incentives:</strong> <em>Loading...</em></p>\n           </div>`,r=i?`<button class="add-to-db-btn" \n                onclick="window.addBusinessToDatabase('${n.placeId}')">\n             Add to Patriot Thanks\n           </button>`:`<button class="view-details-btn" \n                onclick="window.viewBusinessDetails('${n._id}')">\n             View Details\n           </button>`,l=`\n    <div class="info-window-wrapper">\n      <div class="info-window-header">\n        <h3>${n.bname}</h3>\n      </div>\n      <div class="info-window-content">\n        <div class="info-window-scrollable">\n          <p><strong>Address:</strong><br>${t}</p>\n          ${o}\n          <p><strong>Type:</strong> ${s}</p>\n          ${a}\n        </div>\n      </div>\n      <div class="info-window-footer">\n        ${r}\n      </div>\n    </div>\n    `;infoWindow||(infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1})),infoWindow.setContent(l),infoWindow.open(map,e),console.log("Opened info window for marker"),applyInfoWindowScrollableStyles(),i||fetchBusinessIncentivesForInfoWindow(n._id)}function applyInfoWindowScrollableStyles(){if(!document.getElementById("info-window-scrollable-styles")){const e=document.createElement("style");e.id="info-window-scrollable-styles",e.textContent="\n            /* Info window structure */\n            .info-window-wrapper {\n                width: 300px;\n                max-width: 300px;\n                display: flex;\n                flex-direction: column;\n            }\n            \n            .info-window-header {\n                padding: 8px 12px;\n                border-bottom: 1px solid #eee;\n                background-color: #f8f8f8;\n            }\n            \n            .info-window-header h3 {\n                margin: 0;\n                font-size: 16px;\n                color: #333;\n                word-break: break-word;\n            }\n            \n            .info-window-content {\n                max-height: 200px;\n                overflow: hidden;\n                position: relative;\n            }\n            \n            .info-window-scrollable {\n                padding: 10px 12px;\n                overflow-y: auto;\n                max-height: 200px;\n                scrollbar-width: thin;\n                scrollbar-color: #ddd #f8f8f8;\n            }\n            \n            .info-window-scrollable::-webkit-scrollbar {\n                width: 8px;\n            }\n            \n            .info-window-scrollable::-webkit-scrollbar-track {\n                background: #f8f8f8;\n            }\n            \n            .info-window-scrollable::-webkit-scrollbar-thumb {\n                background-color: #ddd;\n                border-radius: 4px;\n                border: 2px solid #f8f8f8;\n            }\n            \n            .info-window-footer {\n                padding: 8px 12px;\n                border-top: 1px solid #eee;\n                background-color: #f8f8f8;\n                display: flex;\n                justify-content: flex-end;\n            }\n            \n            /* Incentives list */\n            .incentives-list {\n                margin: 8px 0;\n                padding-left: 20px;\n            }\n            \n            .incentives-list li {\n                margin-bottom: 6px;\n            }\n            \n            /* Override Google's default styles */\n            .gm-style .gm-style-iw-c {\n                padding: 0 !important;\n                border-radius: 8px !important;\n                box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n            }\n            \n            .gm-style .gm-style-iw-d {\n                overflow: hidden !important;\n                padding: 0 !important;\n            }\n            \n            /* Ensure the info window size is consistent */\n            .gm-style-iw.gm-style-iw-c {\n                max-width: 320px !important;\n            }\n        ",document.head.appendChild(e)}}function searchNearbyBusinesses(e,n){console.log("Searching for nearby businesses near",e.lat(),e.lng());const t=getBaseURL();fetch(`${t}/api/business.js?operation=search&type=${n}`).then((e=>{if(!e.ok)throw new Error(`Failed to fetch nearby businesses: ${e.status}`);return e.json()})).then((n=>{if(!n.results||0===n.results.length)return void console.log("No additional nearby businesses found");console.log(`Found ${n.results.length} potential nearby businesses`);const t=markers.map((e=>e.business._id)),s=n.results.filter((e=>!t.includes(e._id)));console.log(`${s.length} new businesses to add to map`),s.forEach(((n,t)=>{setTimeout((()=>{geocodeNearbyBusiness(n,e)}),t*CONFIG.geocodeDelay)}))})).catch((e=>{console.error("Error searching for nearby businesses:",e)}))}function debugMapState(){console.log("==== MAP DEBUGGING INFO ===="),console.log("Map initialized:",mapInitialized),console.log("Map object exists:",!!map),map&&(console.log("Map center:",map.getCenter().toString()),console.log("Map zoom:",map.getZoom())),console.log("Markers count:",markers.length),markers.length>0&&(console.log("First marker position:",markers[0].position),console.log("First marker business:",markers[0].business)),console.log("Bounds empty:",bounds?bounds.isEmpty():"no bounds"),console.log("Map container:",document.getElementById("map")),document.getElementById("map")&&(console.log("Map container display:",window.getComputedStyle(document.getElementById("map")).display),console.log("Map container dimensions:",document.getElementById("map").offsetWidth,"Ã—",document.getElementById("map").offsetHeight)),console.log("==== END DEBUGGING INFO ====")}function geocodeNearbyBusiness(e,n){if(!e||!e.address1)return;const t=`${e.address1}, ${e.city}, ${e.state} ${e.zip}`;(new google.maps.Geocoder).geocode({address:t},(function(t,s){if(s===google.maps.GeocoderStatus.OK&&t[0]){const s=t[0].geometry.location;google.maps.geometry.spherical.computeDistanceBetween(n,s)<=CONFIG.maxNearbyDistance&&(e.isNearby=!0,addAdvancedMarker(e,s))}}))}window.viewBusinessDetails=function(e){console.log("View details for business:",e),alert("This feature is coming soon: View details for "+e)},window.addBusinessToDatabase=async function(e){console.log("Adding place to database:",e);try{const{Place:n}=await google.maps.importLibrary("places"),t=new n({id:e});await t.fetchFields({fields:["displayName","formattedAddress","addressComponents","location","nationalPhoneNumber"]});const s={name:t.displayName||"",address1:getAddressComponentFromPlace(t,"street_number")+" "+getAddressComponentFromPlace(t,"route"),city:getAddressComponentFromPlace(t,"locality"),state:getAddressComponentFromPlace(t,"administrative_area_level_1"),zip:getAddressComponentFromPlace(t,"postal_code"),phone:t.nationalPhoneNumber||"",placeId:t.id,lat:t.location?.lat||0,lng:t.location?.lng||0,location:{type:"Point",coordinates:[t.location?.lng||0,t.location?.lat||0]}};console.log(`Place coordinates: ${s.lat}, ${s.lng}`),sessionStorage.setItem("newBusinessData",JSON.stringify(s)),window.location.href="business-add.html?prefill=true"}catch(e){console.error("Error fetching place details for addition:",e),alert("Sorry, we couldn't retrieve the details for this business. Please try again or add it manually.")}},window.addGooglePlaceToDatabase=function(e){window.addBusinessToDatabase(e)},window.initGoogleMap=async function(){console.log("Global initGoogleMap function called"),console.log("Map container exists:",!!document.getElementById("map"));try{const e=document.getElementById("map");if(!e)return void console.error("Map container not found in the DOM");console.log("Map container dimensions:",e.offsetWidth,"x",e.offsetHeight);const{Map:n}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:t}=await google.maps.importLibrary("marker");map=new n(e,{center:CONFIG.defaultCenter,zoom:CONFIG.defaultZoom,mapId:CONFIG.mapId,clickableIcons:!0}),console.log("Map object created:",!!map),infoWindow=new google.maps.InfoWindow,bounds=new google.maps.LatLngBounds,addInitialMapMessage(e),setupResetMapButton(),mapInitialized=!0,console.log("Google Map successfully initialized with Map ID:",CONFIG.mapId),pendingBusinessesToDisplay.length>0&&(console.log("Processing pending businesses to display on map"),displayBusinessesOnMap(pendingBusinessesToDisplay),pendingBusinessesToDisplay=[]),await setupMapClickHandler(),setupMarkerClickPriority(),initAdditionalMapFeatures(),setTimeout((()=>{map&&(console.log("Forcing map refresh"),google.maps.event.trigger(map,"resize"),bounds&&!bounds.isEmpty()&&map.fitBounds(bounds))}),500)}catch(e){console.error("Error initializing Google Map:",e),mapInitialized=!1;const n=document.getElementById("map");n&&(n.innerHTML=`\n                <div style="text-align: center; padding: 20px;">\n                    <p>Sorry, we couldn't load the map. Please try refreshing the page.</p>\n                    <p>Error: ${e.message}</p>\n                </div>\n            `)}},window.focusOnMapMarker=function(e){if(console.log("focusOnMapMarker called for business ID:",e),!mapInitialized||!map)return console.error("Map not initialized yet - cannot focus on marker"),void alert("Map is still loading. Please try again in a moment.");if(!markers||0===markers.length)return console.warn("No markers available yet."),void alert("No businesses are currently displayed on the map.");const n=markers.find((n=>n.business&&n.business._id===e));n?(map.setCenter(n.position),map.setZoom(16),showInfoWindow(n),document.getElementById("map").scrollIntoView({behavior:"smooth"}),console.log("Successfully focused on marker for business:",e)):(console.warn(`No marker found for business ID: ${e}`),alert("This business could not be located on the map. It may not have a complete address."),document.getElementById("map").scrollIntoView({behavior:"smooth"}))};const originalInitGoogleMap=window.initGoogleMap;window.initGoogleMap=async function(){console.log("initGoogleMap called");try{const e=document.getElementById("map");if(!e)return void console.error("Map container not found in the DOM");console.log("Map container dimensions:",e.offsetWidth,"x",e.offsetHeight);const{Map:n}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:t}=await google.maps.importLibrary("marker");map=new n(e,{center:CONFIG.defaultCenter,zoom:CONFIG.defaultZoom,mapId:CONFIG.mapId}),console.log("Map created successfully"),infoWindow=new google.maps.InfoWindow,bounds=new google.maps.LatLngBounds;const s=document.createElement("div");s.id="initial-map-message",s.innerHTML="Search for businesses to see them on the map",s.style.position="absolute",s.style.top="50%",s.style.left="50%",s.style.transform="translate(-50%, -50%)",s.style.background="white",s.style.padding="10px",s.style.borderRadius="5px",s.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)",s.style.zIndex="1",e.appendChild(s),mapInitialized=!0,console.log("Map initialization complete"),pendingBusinessesToDisplay.length>0&&(console.log("Processing pending businesses:",pendingBusinessesToDisplay.length),displayBusinessesOnMap(pendingBusinessesToDisplay),pendingBusinessesToDisplay=[]),map.addListener("click",(function(e){console.log("Map clicked at",e.latLng.lat(),e.latLng.lng())}))}catch(e){console.error("Error initializing Google Map:",e),mapInitialized=!1;const n=document.getElementById("map");n&&(n.innerHTML=`\n                <div style="text-align: center; padding: 20px;">\n                    <p>Sorry, we couldn't load the map. Please try refreshing the page.</p>\n                    <p>Error: ${e.message}</p>\n                </div>\n            `)}},document.addEventListener("DOMContentLoaded",(function(){initBusinessSearch(),addCustomMarkerStyles()}));