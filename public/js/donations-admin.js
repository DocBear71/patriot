document.addEventListener("DOMContentLoaded",(function(){const t=document.getElementById("admin-dashboard"),e=document.getElementById("unauthorized-message");let n=!1,a=!1,o=null,d=1,i=1,r="",s="",c="";function l(){t.style.display="none",e.style.display="block"}function m(){if(!n||!a)return;const t=document.getElementById("donations-table-body");t.innerHTML='\n            <tr class="loading-row">\n                <td colspan="8" class="text-center py-4">\n                    <div class="d-flex justify-content-center">\n                        <div class="spinner-border text-primary" role="status">\n                            <span class="visually-hidden">Loading...</span>\n                        </div>\n                    </div>\n                </td>\n            </tr>\n        ';let e=`operation=list&page=${d}&limit=10`;if(r&&(e+=`&search=${encodeURIComponent(r)}`),s&&(e+=`&status=${encodeURIComponent(s)}`),c){const t=y(c);t.startDate&&(e+=`&startDate=${encodeURIComponent(t.startDate)}`),t.endDate&&(e+=`&endDate=${encodeURIComponent(t.endDate)}`)}fetch(`/api/donations.js?${e}`,{method:"GET",headers:{Authorization:`Bearer ${o}`}}).then((t=>t.json())).then((t=>{d=t.page,i=t.totalPages,document.getElementById("current-page").textContent=d,document.getElementById("total-pages").textContent=i,document.getElementById("prev-page").disabled=d<=1,document.getElementById("next-page").disabled=d>=i;const e=10*(d-1)+1,n=Math.min(e+t.donations.length-1,t.total);document.querySelector(".showing-text").textContent=`Showing ${e} to ${n} of ${t.total} entries`,function(t){const e=document.getElementById("donations-table-body");t&&0!==t.length?(e.innerHTML=t.map((t=>{const e=new Date(t.created_at),n=e.toLocaleDateString()+" "+e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});let a="";switch(t.status){case"completed":a='<span class="badge bg-success">Completed</span>';break;case"pending":a='<span class="badge bg-warning text-dark">Pending</span>';break;case"failed":a='<span class="badge bg-danger">Failed</span>';break;default:a=`<span class="badge bg-secondary">${t.status}</span>`}const o=t.recurring?'<span class="badge bg-info"><i class="bi bi-arrow-repeat"></i> Monthly</span>':'<span class="badge bg-light text-dark">One-time</span>';let d="";switch(t.paymentMethod){case"paypal":d='<i class="bi bi-paypal"></i> PayPal';break;case"card":d='<i class="bi bi-credit-card"></i> Card';break;default:d=t.paymentMethod}let i=`\n                <button class="btn btn-sm btn-outline-primary view-details" data-id="${t._id}">\n                    <i class="bi bi-eye"></i>\n                </button>\n            `;"completed"===t.status&&(i+=`\n                    <button class="btn btn-sm btn-outline-secondary ms-1 send-receipt" data-id="${t._id}">\n                        <i class="bi bi-envelope"></i>\n                    </button>\n                `),t.recurring&&(i+=`\n                    <button class="btn btn-sm btn-outline-danger ms-1 cancel-recurring" data-id="${t._id}">\n                        <i class="bi bi-x-circle"></i>\n                    </button>\n                `);const r=t.anonymous?"<em>Anonymous</em>":t.name;return`\n                <tr data-id="${t._id}">\n                    <td>${n}</td>\n                    <td>${r}</td>\n                    <td>${t.email}</td>\n                    <td>${g(t.amount)}</td>\n                    <td>${d}</td>\n                    <td>${a}</td>\n                    <td>${o}</td>\n                    <td>${i}</td>\n                </tr>\n            `})).join(""),document.querySelectorAll(".view-details").forEach((t=>{t.addEventListener("click",(function(){var t;t=this.getAttribute("data-id"),fetch(`/api/donations.js?operation=get&id=${t}`,{method:"GET",headers:{Authorization:`Bearer ${o}`}}).then((t=>t.json())).then((t=>{const e=t.donation;document.getElementById("detail-id").textContent=e._id,document.getElementById("detail-date").textContent=new Date(e.created_at).toLocaleString(),document.getElementById("detail-amount").textContent=g(e.amount),document.getElementById("detail-name").textContent=e.anonymous?"Anonymous":e.name,document.getElementById("detail-email").textContent=e.email,document.getElementById("detail-recurring").textContent=e.recurring?"Yes (Monthly)":"No",document.getElementById("detail-payment").textContent=e.paymentMethod,document.getElementById("detail-status").textContent=e.status,document.getElementById("detail-transaction").textContent=e.transactionId||"N/A",document.getElementById("detail-payment-id").textContent=e.paymentId||"N/A";const n=document.getElementById("message-section");e.message?(n.style.display="block",document.getElementById("detail-message").textContent=e.message):n.style.display="none",new bootstrap.Modal(document.getElementById("donation-details-modal")).show()})).catch((t=>{console.error("Error loading donation details:",t),alert("Error loading donation details. Please try again.")}))}))})),document.querySelectorAll(".send-receipt").forEach((t=>{t.addEventListener("click",(function(){u(this.getAttribute("data-id"))}))})),document.querySelectorAll(".cancel-recurring").forEach((t=>{t.addEventListener("click",(function(){var t;t=this.getAttribute("data-id"),confirm("Are you sure you want to cancel this recurring donation? This action cannot be undone.")&&fetch("/api/donations.js?operation=cancel-recurring",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({donationId:t})}).then((t=>t.json())).then((t=>{t.message&&(alert(t.message),m())})).catch((t=>{console.error("Error canceling recurring donation:",t),alert("Error canceling recurring donation. Please try again.")}))}))}))):e.innerHTML='\n                <tr class="no-data-row">\n                    <td colspan="8" class="text-center py-4">No donation data available</td>\n                </tr>\n            '}(t.donations)})).catch((e=>{console.error("Error loading donations:",e),t.innerHTML='\n                <tr class="error-row">\n                    <td colspan="8" class="text-center py-4 text-danger">\n                        <i class="bi bi-exclamation-triangle-fill me-2"></i>\n                        Error loading donations. Please try again.\n                    </td>\n                </tr>\n            '}))}function u(t){fetch("/api/donations.js?operation=send-receipt",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({donationId:t})}).then((t=>t.json())).then((t=>{t.success?alert("Receipt sent successfully."):alert(`Failed to send receipt: ${t.message}`)})).catch((t=>{console.error("Error sending receipt:",t),alert("Error sending receipt. Please try again.")}))}function g(t){return"$"+parseFloat(t).toFixed(2).replace(/\d(?=(\d{3})+\.)/g,"$&,")}function y(t){const e=new Date,n={startDate:null,endDate:null};switch(t){case"today":n.startDate=new Date(e.getFullYear(),e.getMonth(),e.getDate()).toISOString(),n.endDate=e.toISOString();break;case"week":const t=e.getDay(),a=new Date(e);a.setDate(e.getDate()-t),a.setHours(0,0,0,0),n.startDate=a.toISOString(),n.endDate=e.toISOString();break;case"month":n.startDate=new Date(e.getFullYear(),e.getMonth(),1).toISOString(),n.endDate=e.toISOString();break;case"year":n.startDate=new Date(e.getFullYear(),0,1).toISOString(),n.endDate=e.toISOString()}return n}o=localStorage.getItem("userToken"),o?fetch("/api/auth.js?operation=verify-token",{method:"GET",headers:{Authorization:`Bearer ${o}`}}).then((t=>t.json())).then((d=>{d.isValid&&d.isAdmin?(n=!0,a=!0,e.style.display="none",t.style.display="block",n&&a&&fetch("/api/donations.js?operation=stats",{method:"GET",headers:{Authorization:`Bearer ${o}`}}).then((t=>t.json())).then((t=>{var e;document.getElementById("total-donations").textContent=t.totalDonations,document.getElementById("total-amount").textContent=g(t.totalAmount),document.getElementById("month-amount").textContent=g(t.thisMonthAmount),document.getElementById("month-count").textContent=`${t.thisMonthDonations} donations`,document.getElementById("recurring-count").textContent=t.recurringDonations,document.getElementById("donation-growth").innerHTML=(e=t.growthPercentage)>0?`<i class="bi bi-arrow-up-circle-fill text-success"></i> ${e.toFixed(1)}%`:e<0?`<i class="bi bi-arrow-down-circle-fill text-danger"></i> ${Math.abs(e).toFixed(1)}%`:'<i class="bi bi-dash-circle-fill text-secondary"></i> 0%',t.monthlyData&&window.donationChart&&function(t){if(!window.donationChart||!t)return;const e=t.map((t=>`${t.month} ${t.year}`)),n=t.map((t=>t.amount)),a=t.map((t=>t.count));window.donationChart.data.labels=e,window.donationChart.data.datasets[0].data=n,window.donationChart.data.datasets[1].data=a,window.donationChart.update()}(t.monthlyData)})).catch((t=>{console.error("Error loading donation stats:",t)})),m()):l()})).catch((t=>{console.error("Authentication error:",t),l()})):l(),document.getElementById("prev-page").addEventListener("click",(()=>{d>1&&(d--,m())})),document.getElementById("next-page").addEventListener("click",(()=>{d<i&&(d++,m())})),document.getElementById("search-btn").addEventListener("click",(()=>{r=document.getElementById("search-donations").value,d=1,m()})),document.getElementById("search-donations").addEventListener("keypress",(t=>{"Enter"===t.key&&(r=t.target.value,d=1,m())})),document.getElementById("filter-status").addEventListener("change",(t=>{s=t.target.value,d=1,m()})),document.getElementById("filter-date").addEventListener("change",(t=>{c=t.target.value,d=1,m()})),document.getElementById("export-donations").addEventListener("click",(function(){let t="operation=export&format=csv";if(r&&(t+=`&search=${encodeURIComponent(r)}`),s&&(t+=`&status=${encodeURIComponent(s)}`),c){const e=y(c);e.startDate&&(t+=`&startDate=${encodeURIComponent(e.startDate)}`),e.endDate&&(t+=`&endDate=${encodeURIComponent(e.endDate)}`)}const e=`/api/donations.js?${t}`,n=document.createElement("a");n.href=e,n.setAttribute("download",`donations-export-${(new Date).toISOString().slice(0,10)}.csv`),document.body.appendChild(n),n.setAttribute("data-token",o),n.click(),document.body.removeChild(n)})),document.getElementById("send-receipt").addEventListener("click",(function(){const t=document.getElementById("detail-id").textContent;t&&u(t)})),"undefined"!=typeof Chart?function(){const t=document.getElementById("donations-chart");t&&(window.donationChart=new Chart(t,{type:"bar",data:{labels:["Jan","Feb","Mar","Apr","May","Jun"],datasets:[{label:"Donation Amount ($)",data:[0,0,0,0,0,0],backgroundColor:"rgba(75, 192, 192, 0.2)",borderColor:"rgba(75, 192, 192, 1)",borderWidth:1},{label:"Number of Donations",data:[0,0,0,0,0,0],backgroundColor:"rgba(54, 162, 235, 0.2)",borderColor:"rgba(54, 162, 235, 1)",borderWidth:1,yAxisID:"y-axis-2"}]},options:{responsive:!0,scales:{y:{beginAtZero:!0,title:{display:!0,text:"Amount ($)"}},"y-axis-2":{beginAtZero:!0,position:"right",grid:{drawOnChartArea:!1},title:{display:!0,text:"Count"}}}}}))}():console.warn("Chart.js not loaded")}));