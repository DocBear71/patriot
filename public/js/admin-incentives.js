document.addEventListener("DOMContentLoaded",(function(){console.log("Admin Incentive Manager loaded!");let e=[],t=[],n=1,i=1,o={search:"",business:"",type:"",availability:""},a=null,s="create";const c=document.getElementById("incentive-table-body"),d=document.getElementById("incentive-search"),l=document.getElementById("business-filter"),r=document.getElementById("type-filter"),u=document.getElementById("availability-filter"),m=document.getElementById("reset-filters"),h=document.getElementById("pagination-container"),v=document.getElementById("incentive-form"),p=document.getElementById("add-incentive-btn"),f=document.getElementById("save-incentive-btn"),y=document.getElementById("confirm-action-btn"),g=document.getElementById("business-id"),b=document.getElementById("other-type-container"),E=document.getElementById("type");function w(){try{const e=localStorage.getItem("patriotThanksSession");if(!e)return console.error("No session data found"),null;const t=JSON.parse(e);return t.token?t.token:(console.error("No token found in session data"),null)}catch(e){return console.error("Error retrieving auth token:",e),null}}function I(e,t){console.error("API Error:",e),401!==e.status?"function"==typeof t&&t():window.location.href="/index.html?login=required&redirect="+encodeURIComponent(window.location.pathname)}function B(){const e=document.querySelector(".admin-container");e&&(e.innerHTML='\n                <div class="alert alert-danger" role="alert">\n                    <h4 class="alert-heading">Access Denied</h4>\n                    <p>You do not have permission to access this page. Only administrators can access the incentive management.</p>\n                    <hr>\n                    <p class="mb-0">Please <a href="/index.html">return to the homepage</a> or contact an administrator if you believe this is an error.</p>\n                </div>\n            ')}async function k(){try{c&&(c.innerHTML='<tr><td colspan="8" class="text-center">Loading incentives...</td></tr>');const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,a=w();if(!a)return void I({status:401});let s=`operation=admin-list-incentives&page=${n}&limit=10`;o.search&&(s+=`&search=${encodeURIComponent(o.search)}`),o.business&&(s+=`&business_id=${encodeURIComponent(o.business)}`),o.type&&(s+=`&type=${encodeURIComponent(o.type)}`),o.availability&&(s+=`&is_available=${encodeURIComponent(o.availability)}`),console.log(`Fetching incentives with query: ${s}`);const d=await fetch(`${t}/api/combined-api/admin-incentives.js?${s}`,{method:"GET",headers:{Authorization:`Bearer ${a}`,"Cache-Control":"no-cache"}});if(!d.ok)throw d;const l=await d.json();console.log("Incentives data from API:",l),e=l.incentives||l.results||[],i=l.totalPages||Math.ceil((l.total||0)/10)||1,totalItems=l.total||0,function(e){const t=document.querySelector(".admin-header h2");if(t){const n=t.textContent.split(" ").slice(0,2).join(" ");t.innerHTML=`${n} <span class="badge badge-info">${e} total</span>`}}(totalItems),T(),L()}catch(t){I(t,(()=>{c&&(c.innerHTML='<tr><td colspan="8" class="text-center text-danger">Error loading incentives. Please try again later.</td></tr>'),console.warn("Using mock data for development"),e=[{_id:"1",business_id:"1",businessName:"Tech Solutions Inc.",type:"VT",is_available:!0,amount:10,information:"Veterans get 10% off all services.",created_at:"2025-04-01T00:00:00.000Z"},{_id:"2",business_id:"2",businessName:"Hometown Diner",type:"AD",is_available:!0,amount:15,information:"Active duty military receive 15% discount.",created_at:"2025-04-05T00:00:00.000Z"},{_id:"3",business_id:"3",businessName:"Cedar Medical Center",type:"FR",is_available:!0,amount:20,information:"First responders receive 20% off select services.",created_at:"2025-04-10T00:00:00.000Z"},{_id:"4",business_id:"4",businessName:"Local Gym",type:"OT",is_available:!1,amount:0,information:"No incentives available at this business.",other_description:"Previously offered military discounts",created_at:"2025-04-15T00:00:00.000Z"}],i=1,T(),L()}))}}function _(){if(l)for(;l.options.length>1;)l.remove(1);if(g)for(;g.options.length>1;)g.remove(1);t.forEach((e=>{if(l){const t=document.createElement("option");t.value=e._id,t.textContent=e.bname,l.appendChild(t)}if(g){const t=document.createElement("option");t.value=e._id,t.textContent=e.bname,g.appendChild(t)}}))}function T(){c&&(0!==e.length?(c.innerHTML="",e.forEach((e=>{const n=new Date(e.created_at).toLocaleDateString();let i=e.businessName||"Unknown Business",o="Location not specified";if(e.business_id){const n=t.find((t=>t._id===e.business_id));n&&(i&&"Unknown Business"!==i||(i=n.bname),n.address1&&n.city&&n.state&&(o=`${n.address1}, ${n.city}, ${n.state}`))}const a={VT:"Veteran",AD:"Active Duty",FR:"First Responder",SP:"Spouse",OT:"Other"}[s=e.type]||s;var s;const d="OT"===e.type&&e.other_description?`<br><em>(${e.other_description})</em>`:"",l=e.is_available?"Yes":"No",r=e.is_available?"text-success":"text-danger",u=e.is_available?`${e.amount}%`:"N/A",m=document.createElement("tr");m.innerHTML=`\n            <td>${i}</td>\n            <td>${o}</td>\n            <td>${a}${d}</td>\n            <td class="${r}">${l}</td>\n            <td>${u}</td>\n            <td>${e.information||"No information available"}</td>\n            <td>${n}</td>\n            <td>\n                <div class="action-btns">\n                    <button class="btn btn-sm btn-info edit-incentive-btn" data-id="${e._id}">Edit</button>\n                    <button class="btn btn-sm btn-danger delete-incentive-btn" data-id="${e._id}" data-business="${i}">Delete</button>\n                </div>\n            </td>\n        `,c.appendChild(m)})),document.querySelectorAll(".edit-incentive-btn").forEach((t=>{t.addEventListener("click",(function(){!function(t){try{const n=e.find((e=>e._id===t));if(!n)return void async function(e){try{const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,n=w();if(!n)return;const i=await fetch(`${t}/api/combined-api/admin-incentives.js?operation=get&incentiveId=${e}`,{method:"GET",headers:{Authorization:`Bearer ${n}`,"Cache-Control":"no-cache"}});if(!i.ok)throw i;const o=await i.json(),a=o.incentive||o.result;if(!a)throw new Error("Incentive not found");M(),s="edit";const c=document.getElementById("incentiveModalLabel");c&&(c.textContent="Edit Incentive"),C(a),$("#incentiveModal").modal("show")}catch(e){I(e,(()=>{S("danger","Error loading incentive details. Please try again.")}))}}(t);M(),s="edit";const i=document.getElementById("incentiveModalLabel");i&&(i.textContent="Edit Incentive"),C(n),$("#incentiveModal").modal("show")}catch(e){console.error("Error editing incentive:",e),S("danger","Error loading incentive details. Please try again.")}}(this.getAttribute("data-id"))}))})),document.querySelectorAll(".delete-incentive-btn").forEach((e=>{e.addEventListener("click",(function(){const e=this.getAttribute("data-id"),t=this.getAttribute("data-business"),n=document.getElementById("confirmation-message");n&&(n.textContent=`Are you sure you want to delete this incentive for ${t}?`),a=e,$("#confirmationModal").modal("show")}))}))):c.innerHTML='<tr><td colspan="8" class="text-center">No incentives found</td></tr>')}function L(){if(!h)return;if(i<=1)return void(h.innerHTML="");let e="";e+=`\n            <li class="page-item ${1===n?"disabled":""}">\n                <a class="page-link" href="#" data-page="${n-1}" aria-label="Previous">\n                    <span aria-hidden="true">&laquo;</span>\n                </a>\n            </li>\n        `;let t=Math.max(1,n-Math.floor(2.5)),o=Math.min(i,t+5-1);o-t+1<5&&(t=Math.max(1,o-5+1)),t>1&&(e+='<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>',t>2&&(e+='<li class="page-item disabled"><a class="page-link" href="#">...</a></li>'));for(let i=t;i<=o;i++)e+=`<li class="page-item ${i===n?"active":""}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;o<i&&(o<i-1&&(e+='<li class="page-item disabled"><a class="page-link" href="#">...</a></li>'),e+=`<li class="page-item"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`),e+=`\n            <li class="page-item ${n===i?"disabled":""}">\n                <a class="page-link" href="#" data-page="${n+1}" aria-label="Next">\n                    <span aria-hidden="true">&raquo;</span>\n                </a>\n            </li>\n        `,h.innerHTML=e,document.querySelectorAll(".page-link").forEach((e=>{e.addEventListener("click",(function(e){e.preventDefault();const t=parseInt(this.getAttribute("data-page"));!isNaN(t)&&t>0&&t<=i&&(n=t,k())}))}))}function C(e){if(!e)return;const t=document.getElementById("incentive-id");t&&(t.value=e._id||"");const n=document.getElementById("business-id");n&&A(n,e.business_id||"");const i=document.getElementById("incentive-available"),o=document.getElementById("incentive-not-available");if(i&&o){e.is_available?(i.checked=!0,o.checked=!1):(i.checked=!1,o.checked=!0);const t=new Event("change");(e.is_available?i:o).dispatchEvent(t)}const a=document.getElementById("type");if(a&&(A(a,e.type||""),"OT"===e.type)){const t=document.getElementById("other-type-container"),n=document.getElementById("other-description");t&&(t.style.display="block"),n&&(n.value=e.other_description||"")}const s=document.getElementById("amount");s&&(s.value=e.amount||0);const c=document.getElementById("information");c&&(c.value=e.information||"")}function A(e,t){if(e)for(let n=0;n<e.options.length;n++)if(e.options[n].value===t)return void(e.selectedIndex=n)}function M(){if(!v)return;v.reset();const e=document.getElementById("incentive-id");e&&(e.value="");const t=document.getElementById("other-type-container");t&&(t.style.display="none");const n=document.getElementById("information");n&&(n.value=""),document.querySelectorAll("#incentive-form input, #incentive-form select, #incentive-form textarea").forEach((e=>{e.disabled=!1,e.classList.remove("disabled-field")}))}function N(){const e=document.getElementById("business-id"),t=e?e.value:"",n=document.querySelector('input[name="is_available"]:checked'),i=!!n&&"true"===n.value,o=document.getElementById("type"),a=o?o.value:"",s=document.getElementById("amount"),c=s&&parseFloat(s.value)||0,d=document.getElementById("information"),l=d?d.value:"";let r="";if("OT"===a){const e=document.getElementById("other-description");r=e?e.value:""}const u={business_id:t,is_available:i,type:a,amount:c,information:l};return"OT"===a&&r&&(u.other_description=r),u}function S(e,t){const n=document.createElement("div");n.className=`alert alert-${e} alert-dismissible fade show`,n.role="alert",n.innerHTML=`\n            ${t}\n            <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                <span aria-hidden="true">&times;</span>\n            </button>\n        `;const i=document.querySelector(".admin-container");if(i){const e=i.querySelector(".admin-header");e&&e.nextSibling?i.insertBefore(n,e.nextSibling):i.prepend(n),setTimeout((()=>{n.classList.remove("show"),setTimeout((()=>{n.remove()}),300)}),5e3)}}!async function(){await async function(){try{const e=w();if(!e)return console.error("No auth token found"),window.location.href="/index.html?login=required&redirect="+encodeURIComponent(window.location.pathname),!1;const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin;try{const n=await fetch(`${t}/api/auth.js?operation=verify-token`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Cache-Control":"no-cache"}});if(!n.ok)return 401===n.status?(window.location.href="/index.html?login=required&redirect="+encodeURIComponent(window.location.pathname),!1):confirm("API error encountered. Would you like to bypass admin verification for development purposes?")?(console.warn("DEVELOPMENT MODE: Bypassing admin verification"),!0):(B(),!1);const i=await n.json();return!(!0!==i.isAdmin&&"Admin"!==i.level&&(B(),1))}catch(e){return console.error("Error checking admin status:",e),confirm("API error encountered. Would you like to bypass admin verification for development purposes?")?(console.warn("DEVELOPMENT MODE: Bypassing admin verification"),!0):(B(),!1)}}catch(e){return console.error("Error in admin status check:",e),B(),!1}}()?(console.log("Admin access confirmed"),k(),async function(){try{const e="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,n=w();if(!n)return void I({status:401});const i=await fetch(`${e}/api/business.js?operation=admin-list-businesses&limit=100`,{method:"GET",headers:{Authorization:`Bearer ${n}`,"Cache-Control":"no-cache"}});if(!i.ok)throw i;const o=await i.json();t=o.businesses||[],_()}catch(e){I(e,(()=>{console.warn("Using mock business data for development"),t=[{_id:"1",bname:"Tech Solutions Inc."},{_id:"2",bname:"Hometown Diner"},{_id:"3",bname:"Cedar Medical Center"},{_id:"4",bname:"Local Gym"}],_()}))}}(),function(){E&&b&&E.addEventListener("change",(function(){"OT"===this.value?b.style.display="block":b.style.display="none"}));const e=document.getElementById("incentive-available"),t=document.getElementById("incentive-not-available");if(e&&t){const c=[document.getElementById("type"),document.getElementById("amount"),document.getElementById("information")];function i(){const t=e.checked;if(c.forEach((e=>{e&&(e.disabled=!t,t?e.classList.remove("disabled-field"):e.classList.add("disabled-field"))})),b&&document.getElementById("other-description")){const e=document.getElementById("other-description");e.disabled=!t,t?"OT"===document.getElementById("type").value&&(b.style.display="block",e.classList.remove("disabled-field")):(b.style.display="none",e.classList.add("disabled-field"))}t?c[2]&&(c[2].value=""):(c.forEach((e=>{e&&("SELECT"===e.tagName?e.selectedIndex=0:"TEXTAREA"===e.tagName?e.value="No incentives available at this business.":"number"===e.type&&(e.value="0"))})),document.getElementById("other-description")&&(document.getElementById("other-description").value=""))}e.addEventListener("change",i),t.addEventListener("change",i)}d&&d.addEventListener("input",function(e){let t;return function(...n){const i=this;clearTimeout(t),t=setTimeout((()=>e.apply(i,n)),300)}}((function(){o.search=this.value,n=1,k()}))),l&&l.addEventListener("change",(function(){o.business=this.value,n=1,k()})),r&&r.addEventListener("change",(function(){o.type=this.value,n=1,k()})),u&&u.addEventListener("change",(function(){o.availability=this.value,n=1,k()})),m&&m.addEventListener("click",(function(){d&&(d.value=""),l&&(l.value=""),r&&(r.value=""),u&&(u.value=""),o={search:"",business:"",type:"",availability:""},n=1,k()})),p&&p.addEventListener("click",(function(){M(),s="create",document.getElementById("incentiveModalLabel").textContent="Add New Incentive",$("#incentiveModal").modal("show")})),f&&f.addEventListener("click",(function(){(function(){const e=document.getElementById("business-id"),t=e?e.value:"",n=null!==document.querySelector('input[name="is_available"]:checked'),i="true"===document.querySelector('input[name="is_available"]:checked')?.value,o=document.getElementById("type"),a=o?o.value:"",s=document.getElementById("amount"),c=s?s.value:"",d=document.getElementById("information"),l=d?d.value:"",r=[];if(t||r.push("Please select a business"),n||r.push("Please specify if incentive is available"),i&&(a||r.push("Please select an incentive type"),(""===c||isNaN(parseFloat(c)))&&r.push("Please enter a valid incentive amount"),l||r.push("Please provide incentive information"),"OT"===a)){const e=document.getElementById("other-description");e&&e.value||r.push('Please provide a description for the "Other" incentive type')}return!(r.length>0&&(S("danger","Form validation failed:<br>"+r.join("<br>")),1))})()&&("create"===s?async function(){try{const e="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,t=w();if(!t)return;const n=N(),i=await fetch(`${e}/api/combined-api/incentives.js`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json","Cache-Control":"no-cache"},body:JSON.stringify(n)});if(!i.ok)throw i;await i.json(),$("#incentiveModal").modal("hide"),S("success","Incentive created successfully!"),k()}catch(e){I(e,(()=>{S("danger","Error creating incentive. Please try again.")}))}}():async function(){try{const e="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,t=w();if(!t)return;const n=N();n.incentiveId=document.getElementById("incentive-id").value;const i=await fetch(`${e}/api/combined-api/admin-incentives.js?operation=update`,{method:"PUT",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json","Cache-Control":"no-cache"},body:JSON.stringify(n)});if(!i.ok)throw i;await i.json(),$("#incentiveModal").modal("hide"),S("success","Incentive updated successfully!"),k()}catch(e){I(e,(()=>{S("danger","Error updating incentive. Please try again.")}))}}())})),v&&v.addEventListener("submit",(function(e){e.preventDefault()})),y&&y.addEventListener("click",(function(){a&&async function(e){try{const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,n=w();if(!n)return;const i=await fetch(`${t}/api/combined-api/admin-incentives.js?operation=delete`,{method:"DELETE",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json","Cache-Control":"no-cache"},body:JSON.stringify({incentiveId:e})});if(!i.ok)throw i;await i.json(),$("#confirmationModal").modal("hide"),S("success","Incentive deleted successfully!"),k()}catch(e){I(e,(()=>{$("#confirmationModal").modal("hide"),S("danger","Error deleting incentive. Please try again.")}))}}(a)}))}()):console.error("Admin access denied")}()}));