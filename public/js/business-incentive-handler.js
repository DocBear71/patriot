document.addEventListener("DOMContentLoaded",(function(){console.log("Business Incentive Handler Loaded!");const e=document.getElementById("business-info-section");e&&(e.style.display="none");const n=document.getElementById("incentive-section");n&&(n.style.display="none");const t=document.getElementById("incentiveType"),o=document.getElementById("otherTypeContainer");t&&o&&t.addEventListener("change",(function(){"OT"===this.value?o.style.display="block":o.style.display="none"}));const i=document.getElementById("incentiveAvailable"),s=document.getElementById("incentiveNotAvailable"),l=[document.getElementById("incentiveType"),document.getElementById("incentiveAmount"),document.getElementById("incentiveInfo")];function c(){const e=i.checked;if(l.forEach((n=>{n&&(n.disabled=!e,e?n.classList.remove("disabled-field"):n.classList.add("disabled-field"))})),o&&document.getElementById("otherTypeDescription")){const n=document.getElementById("otherTypeDescription");n.disabled=!e,e?"OT"===document.getElementById("incentiveType").value&&(o.style.display="block",n.classList.remove("disabled-field")):(o.style.display="none",n.classList.add("disabled-field"))}e||(l.forEach((e=>{e&&("SELECT"===e.tagName?e.selectedIndex=0:"TEXTAREA"===e.tagName?e.value="No incentives available at this business.":"number"===e.type&&(e.value="0"))})),document.getElementById("otherTypeDescription")&&(document.getElementById("otherTypeDescription").value=""))}i.addEventListener("change",c),s.addEventListener("change",c);const d=document.getElementById("incentive-form");function a(e,n){const t=document.getElementById(e);t?(t.value=n||"",console.log(`populated ${e} with:`,n)):console.warn(`Field ${e} not found.`)}function r(e,n){const t=document.getElementById(e);if(t){for(let o=0;o<t.options.length;o++)if(t.options[o].value===n)return t.selectedIndex=o,void console.log(`Selected ${n} in ${e}`);if("state"===e&&n){const e={alabama:"AL",alaska:"AK",arizona:"AZ",arkansas:"AR",california:"CA",colorado:"CO",connecticut:"CT",delaware:"DE",florida:"FL",georgia:"GA",hawaii:"HI",idaho:"ID",illinois:"IL",indiana:"IN",iowa:"IA",kansas:"KS",kentucky:"KY",louisiana:"LA",maine:"ME",maryland:"MD",massachusetts:"MA",michigan:"MI",minnesota:"MN",mississippi:"MS",missouri:"MO",montana:"MT",nebraska:"NE",nevada:"NV","new hampshire":"NH","new jersey":"NJ","new mexico":"NM","new york":"NY","north carolina":"NC","north dakota":"ND",ohio:"OH",oklahoma:"OK",oregon:"OR",pennsylvania:"PA","rhode island":"RI","south carolina":"SC","south dakota":"SD",tennessee:"TN",texas:"TX",utah:"UT",vermont:"VT",virginia:"VA",washington:"WA","west virginia":"WV",wisconsin:"WI",wyoming:"WY"},o={};for(const[n,t]of Object.entries(e))o[t.toLowerCase()]=n;const i=n.toLowerCase();if(e[i]){const o=e[i];for(let e=0;e<t.options.length;e++)if(t.options[e].value.toLowerCase()===o.toLowerCase())return t.selectedIndex=e,void console.log(`Selected state by abbreviation: ${o} for ${n}`)}else if(2===i.length&&o[i]){const e=o[i];for(let o=0;o<t.options.length;o++)if(t.options[o].text.toLowerCase().includes(e))return t.selectedIndex=o,void console.log(`Selected state by full name: ${e} for ${n}`)}for(let e=0;e<t.options.length;e++){const o=t.options[e].text.toLowerCase(),s=t.options[e].value.toLowerCase();if(o.includes(i)||i.includes(o)||s.includes(i)||i.includes(s))return t.selectedIndex=e,void console.log(`Fuzzy matched state: ${t.options[e].text} for ${n}`)}}if("type"===e&&n){const e={REST:"Restaurant",GROC:"Grocery",DEPT:"Department Store",CLTH:"Clothing",ELEC:"Electronics",HARDW:"Hardware",FURN:"Furniture",AUTO:"Automotive",SERV:"Service",ENTR:"Entertainment",SPRT:"Sporting Goods",TOYS:"Toys",HEAL:"Health",BEAU:"Beauty",JEWL:"Jewelry",BOOK:"Bookstore",GIFT:"Gift Shop",SPEC:"Specialty",RX:"Pharmacy",RETAIL:"Retail",TECH:"Technology",OTHER:"Other"}[n.toLowerCase()];if(e)for(let n=0;n<t.options.length;n++)if(t.options[n].value===e)return t.selectedIndex=n,void console.log(`Selected business type: ${e}`)}console.warn(`Could not find a matching option for ${n} in ${e}`)}else console.warn(`Field ${e} not found.`)}function u(e){console.log("adding Incentive: ",e);const n=localStorage.getItem("patriotThanksSession");if(n){const t=JSON.parse(n);t&&t.user&&t.user._id&&(e.created_by=t.user._id)}const t=document.querySelector('#incentive-form input[type="submit"]');let o="Submit Incentive";t&&(o=t.value,t.value="Submitting...",t.disabled=!0);const i="https://patriotthanks.vercel.app/api/incentives.js";console.log("Attempting to submit to: ",i),fetch(i,{method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8"},body:JSON.stringify(e)}).then((e=>(console.log("response status:",e.status),console.log("response Headers:",[...e.headers.entries()]),e.ok?e.json():e.text().then((n=>{throw console.log("Error response body: ",n),new Error(`Server responded with status ${e.status}`)}))))).then((e=>{console.log("Incentive added successfully: ",e),alert("Incentive added successfully!"),function(){const e=document.getElementById("incentive-form");if(e){e.reset();const n=document.getElementById("selected-business-id");n&&(n.value=""),document.querySelectorAll('input[name="incentiveAvailable"]').forEach((e=>{e.checked=!1}));const t=document.getElementById("incentiveType");t&&(t.selectedIndex=0);const o=document.getElementById("otherTypeContainer");o&&(o.style.display="none");const i=document.getElementById("otherTypeDescription");i&&(i.value="");const s=document.getElementById("incentiveAmount");s&&(s.value="");const l=document.getElementById("incentiveInfo");l&&(l.value="");const c=document.getElementById("business-info-section");c&&(c.style.display="none");const d=document.getElementById("incentive-section");d&&(d.style.display="none");const a=document.getElementById("business-search-results");a&&(a.innerHTML="");const r=document.getElementById("business-name");r&&(r.value="");const u=document.getElementById("address");u&&(u.value="")}console.log("Incentive form has been reset")}()})).catch((e=>{console.error("Error adding incentive: ",e),alert(`Error adding incentive: ${e.message}`)})).finally((()=>{t&&(t.value=o,t.disabled=!1)}))}d&&d.addEventListener("submit",(function(e){e.preventDefault();const n=document.getElementById("selected-business-id"),t=n?n.value:"",o=document.querySelector('input[name="incentiveAvailable"]:checked'),i=o?o.value:null;if(!t)return void alert("Please select a business first");if(null===i)return void alert("Please specify if an incentive is available");const s=document.getElementById("incentiveType"),l=s?s.value:"",c=document.getElementById("incentiveAmount"),d=c?c.value:"",a=document.getElementById("incentiveInfo"),r=a?a.value:"";if(!("true"!==i||l&&d&&d))return void alert("Please provide incentive type, amount, and information");const m={business_id:t,is_available:"true"===i,type:l,amount:d,information:r};if("OT"===l){const e=document.getElementById("otherTypeDescription")?.value||"";if(!e)return void alert('Please provide a description for the "Other" incentive type');m.other_description=e}u(m)})),window.selectBusinessForIncentive=function(t){console.log("selectedBusinessForIncentive called with: ",t),e&&(e.style.display="block");const o=document.getElementById("selected-business-id");o&&(o.value=t._id||""),a("bname",t.bname),a("address1",t.address1),a("address2",t.address2),a("city",t.city),a("zip",t.zip),a("phone",t.phone),r("state",t.state),r("type",t.type),document.querySelectorAll("#business-info-section input, #business-info-section select").forEach((e=>{"select"===e.tagName.toLowerCase()?e.disabled=!0:e.setAttribute("readonly",!0)})),n&&(n.style.display="block"),n&&n.scrollIntoView({behavior:"smooth"})};const m=document.createElement("style");function v(e){return e&&""!==e.trim()}function y(e){return!isNaN(e)&&e>0}function f(e,n){return console.log(`Validating ${e.id} with value: ${e.value}`),n(e.value)?(e.classList.remove("invalid-field"),e.classList.add("valid-field"),e.setAttribute("data-valid","true"),console.log(`${e.id} is VALID`),!0):(e.classList.remove("valid-field"),e.classList.add("invalid-field"),e.setAttribute("data-valid","false"),console.log(`${e.id} is INVALID`),!1)}m.textContent="\n        .disabled-field {\n            background-color: #f0f0f0;\n            color: #888;\n            cursor: not-allowed;\n        }\n        textarea.disabled-field {\n            resize: none;\n        }\n    ",document.head.appendChild(m);const p=document.getElementById("incentiveType"),g=document.getElementById("incentiveAmount"),h=document.getElementById("incentiveInfo"),E=document.getElementById("otherTypeDescription");if(p&&p.addEventListener("change",(function(){f(this,v)})),g&&g.addEventListener("input",(function(){f(this,y)})),h&&h.addEventListener("input",(function(){f(this,v)})),E&&E.addEventListener("input",(function(){"OT"===p.value&&f(this,v)})),d){const e=d.cloneNode(!0);d.parentNode.replaceChild(e,d),e.addEventListener("submit",(function(e){if(e.preventDefault(),!function(){const e=document.getElementById("incentiveAvailable").checked;let n=!0;const t=document.getElementById("selected-business-id");if(!t||!t.value)return n=!1,alert("Please select a business first"),!1;if(!document.querySelector('input[name="incentiveAvailable"]:checked'))return n=!1,alert("Please specify if an incentive is available"),!1;if(e){const e=document.getElementById("incentiveType"),t=document.getElementById("incentiveAmount"),o=document.getElementById("incentiveInfo");f(e,v)||(n=!1),f(t,y)||(n=!1),f(o,v)||(n=!1),"OT"===e.value&&(f(document.getElementById("otherTypeDescription"),v)||(n=!1))}return n}())return;const n=document.getElementById("selected-business-id"),t=n?n.value:"",o=document.getElementById("incentiveAvailable").checked,i=document.getElementById("incentiveType"),s=i?i.value:"",l=document.getElementById("incentiveAmount"),c=l?l.value:"",d=document.getElementById("incentiveInfo"),a={business_id:t,is_available:o,type:s,amount:c,information:d?d.value:""};if("OT"===s){const e=document.getElementById("otherTypeDescription")?.value||"";a.other_description=e}u(a)}))}function a(e,n){const t=document.getElementById(e);t?(t.value=n||"",console.log(`Populated ${e} with:`,n)):console.warn(`Field ${e} not found.`)}m.textContent+="\n            .valid-field {\n                border: 1px solid green !important;\n                background-color: #f0fff0 !important;\n            }\n            \n            .invalid-field {\n                border: 1px solid red !important;\n                background-color: #fff0f0 !important;\n            }\n            \n            .required-indicator {\n                color: red;\n                font-weight: bold;\n            }\n            \n            .form-explanation {\n                margin-bottom: 15px;\n                font-style: italic;\n            }\n            ",document.head.appendChild(m),function(){["incentiveType","incentiveAmount","incentiveInfo"].forEach((e=>{if(document.getElementById(e)){const n=document.querySelector(`label[for="${e}"]`);if(n&&!n.innerHTML.includes("*")){const e=document.createElement("span");e.className="required-indicator",e.textContent=" *",e.style.color="red",n.appendChild(e)}}})),document.querySelectorAll('label[for="incentiveAvailable"], label[for="incentiveNotAvailable"]').forEach((e=>{if(!e.innerHTML.includes("*")){const n=document.createElement("span");n.className="required-indicator",n.textContent=" *",n.style.color="red",e.appendChild(n)}}));const e=document.getElementById("incentive-form");if(e){const n=document.createElement("div");n.className="form-explanation",n.innerHTML="<p>Fields marked with an asterisk (*) are required.</p>",e.insertBefore(n,e.firstChild)}}(),console.log("Adding extra debugging for business selection"),console.log("Does selectBusinessForIncentive exist?","function"==typeof window.selectBusinessForIncentive),window.debugSelectBusiness=function(e){console.log("Debug Select Business called with:",e);const n=document.getElementById("business-info-section"),t=document.getElementById("incentive-section");n?(console.log("Found business-info-section, setting display to block"),n.style.display="block"):console.error("Could not find business-info-section element"),t?(console.log("Found incentive-section, setting display to block"),t.style.display="block"):console.error("Could not find incentive-section element");const o=document.getElementById("selected-business-id");o&&(o.value=e._id||"",console.log("Set business ID to:",o.value)),a("bname",e.bname),a("address1",e.address1),a("address2",e.address2||""),a("city",e.city),a("state",e.state),a("zip",e.zip),a("phone",e.phone),a("type",e.type),n.scrollIntoView({behavior:"smooth"})};const I=window.selectBusinessForIncentive;window.selectBusinessForIncentive=function(e){console.log("Overridden selectBusinessForIncentive called with:",e),"function"==typeof I&&I(e),window.debugSelectBusiness(e)}}));