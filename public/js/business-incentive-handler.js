function enhancedSelectBusinessForIncentive(e){console.log("Enhanced selectBusinessForIncentive called with:",e);const n=!0===e.is_chain,t=checkIfUserIsAdmin();if(n&&!t)return void showChainParentWarning(e);window.selectedBusinessData=e;const i=document.getElementById("business-info-section");if(!i)return void console.error("business-info-section not found in the DOM");i.style.display="block";const o=document.getElementById("selected-business-id");o&&(o.value=e._id||""),populateBusinessInfo(e),displayChainInfo(e);const s=document.getElementById("incentive-section");s&&(s.style.display="block"),s&&s.scrollIntoView({behavior:"smooth"})}function displayChainInfo(e){if(e&&(e.chain_id||e.is_chain)){let n=document.getElementById("chain-info-banner");if(!n){n=document.createElement("div"),n.id="chain-info-banner",n.className="chain-business-warning";const e=document.getElementById("business-info-section");e&&e.insertBefore(n,e.firstChild)}e.is_chain?n.innerHTML=`\n                <p><strong>${e.bname}</strong> is a national chain parent business.</p>\n                <p>Chain-wide incentives added here will apply to all locations nationwide.</p>\n                <p><strong>Note:</strong> Only administrators can add chain-wide incentives.</p>\n            `:e.chain_id&&(n.innerHTML=`\n                <p><strong>${e.bname}</strong> is part of the <strong>${e.chain_name||"chain"}</strong> chain.</p>\n                <p>Incentives added here will only apply to this specific location.</p>\n                <p>Chain-wide incentives can only be managed by administrators.</p>\n            `)}}function checkIfUserIsAdmin(){try{if(void 0!==window.chainHandler&&"function"==typeof window.chainHandler.checkIfUserIsAdmin)return window.chainHandler.checkIfUserIsAdmin();const e=localStorage.getItem("patriotThanksSession");if(!e)return!1;const n=JSON.parse(e);return n.user&&(!0===n.user.isAdmin||"Admin"===n.user.level)}catch(e){return console.error("Error checking admin status:",e),!1}}function showChainParentWarning(e){if(void 0!==window.chainHandler&&"function"==typeof window.chainHandler.showChainParentWarning)return window.chainHandler.showChainParentWarning(e);alert(`${e.bname} is a national chain business. Chain businesses can only be modified by administrators. Please select a specific location instead.`)}function addChainStyles(){if(!document.getElementById("chain-incentive-styles")){const e=document.createElement("style");e.id="chain-incentive-styles",e.textContent="\n            .chain-business-warning {\n                background-color: #FFF3CD;\n                color: #856404;\n                border: 1px solid #FFEEBA;\n                padding: 10px;\n                margin-bottom: 15px;\n                border-radius: 4px;\n            }\n            \n            .chain-badge {\n                background-color: #4285F4;\n                color: white;\n                border-radius: 4px;\n                padding: 3px 6px;\n                font-size: 12px;\n                display: inline-block;\n                margin-left: 5px;\n                font-weight: normal;\n            }\n        ",document.head.appendChild(e)}}document.addEventListener("DOMContentLoaded",(function(){console.log("Business Incentive Handler Loaded!");const e=document.getElementById("business-info-section");e&&(e.style.display="none");const n=document.getElementById("incentive-section");n&&(n.style.display="none");const t=document.getElementById("incentiveType"),i=document.getElementById("otherTypeContainer");t&&i&&t.addEventListener("change",(function(){"OT"===this.value?i.style.display="block":i.style.display="none"}));const o=document.getElementById("incentiveAvailable"),s=document.getElementById("incentiveNotAvailable"),c=[document.getElementById("incentiveType"),document.getElementById("incentiveAmount"),document.getElementById("incentiveInfo")];function l(){const e=o.checked;if(c.forEach((n=>{n&&(n.disabled=!e,e?n.classList.remove("disabled-field"):n.classList.add("disabled-field"))})),i&&document.getElementById("otherTypeDescription")){const n=document.getElementById("otherTypeDescription");n.disabled=!e,e?"OT"===document.getElementById("incentiveType").value&&(i.style.display="block",n.classList.remove("disabled-field")):(i.style.display="none",n.classList.add("disabled-field"))}e||(c.forEach((e=>{e&&("SELECT"===e.tagName?e.selectedIndex=0:"TEXTAREA"===e.tagName?e.value="No incentives available at this business.":"number"===e.type&&(e.value="0"))})),document.getElementById("otherTypeDescription")&&(document.getElementById("otherTypeDescription").value=""))}o.addEventListener("change",l),s.addEventListener("change",l);const a=document.getElementById("incentive-form");function d(e,n){const t=document.getElementById(e);if(t){for(let i=0;i<t.options.length;i++)if(t.options[i].value===n)return t.selectedIndex=i,void console.log(`Selected ${n} in ${e}`);if("state"===e&&n){const e={alabama:"AL",alaska:"AK",arizona:"AZ",arkansas:"AR",california:"CA",colorado:"CO",connecticut:"CT",delaware:"DE",florida:"FL",georgia:"GA",hawaii:"HI",idaho:"ID",illinois:"IL",indiana:"IN",iowa:"IA",kansas:"KS",kentucky:"KY",louisiana:"LA",maine:"ME",maryland:"MD",massachusetts:"MA",michigan:"MI",minnesota:"MN",mississippi:"MS",missouri:"MO",montana:"MT",nebraska:"NE",nevada:"NV","new hampshire":"NH","new jersey":"NJ","new mexico":"NM","new york":"NY","north carolina":"NC","north dakota":"ND",ohio:"OH",oklahoma:"OK",oregon:"OR",pennsylvania:"PA","rhode island":"RI","south carolina":"SC","south dakota":"SD",tennessee:"TN",texas:"TX",utah:"UT",vermont:"VT",virginia:"VA",washington:"WA","west virginia":"WV",wisconsin:"WI",wyoming:"WY"},i={};for(const[n,t]of Object.entries(e))i[t.toLowerCase()]=n;const o=n.toLowerCase();if(e[o]){const i=e[o];for(let e=0;e<t.options.length;e++)if(t.options[e].value.toLowerCase()===i.toLowerCase())return t.selectedIndex=e,void console.log(`Selected state by abbreviation: ${i} for ${n}`)}else if(2===o.length&&i[o]){const e=i[o];for(let i=0;i<t.options.length;i++)if(t.options[i].text.toLowerCase().includes(e))return t.selectedIndex=i,void console.log(`Selected state by full name: ${e} for ${n}`)}for(let e=0;e<t.options.length;e++){const i=t.options[e].text.toLowerCase(),s=t.options[e].value.toLowerCase();if(i.includes(o)||o.includes(i)||s.includes(o)||o.includes(s))return t.selectedIndex=e,void console.log(`Fuzzy matched state: ${t.options[e].text} for ${n}`)}}if("type"===e&&n){const e={AUTO:"Automotive",BEAU:"Beauty",BOOK:"Bookstore",CLTH:"Clothing",CONV:"Convenience Store/Gas Station",DEPT:"Department Store",ELEC:"Electronics",ENTR:"Entertainment",FURN:"Furniture",FUEL:"Fuel Station/Truck Stop",GIFT:"Gift Shop",GROC:"Grocery",HARDW:"Hardware",HEAL:"Health",HOTEL:"Hotel/Motel",JEWL:"Jewelry",OTHER:"Other",RX:"Pharmacy",REST:"Restaurant",RETAIL:"Retail",SERV:"Service",SPEC:"Specialty",SPRT:"Sporting Goods",TECH:"Technology",TOYS:"Toys"}[n.toLowerCase()];if(e)for(let n=0;n<t.options.length;n++)if(t.options[n].value===e)return t.selectedIndex=n,void console.log(`Selected business type: ${e}`)}console.warn(`Could not find a matching option for ${n} in ${e}`)}else console.warn(`Field ${e} not found.`)}function r(e){console.log("adding Incentive: ",e);const n=localStorage.getItem("patriotThanksSession");if(n){const t=JSON.parse(n);t&&t.user&&t.user._id&&(e.created_by=t.user._id)}const t=document.querySelector('#incentive-form input[type="submit"]');let i="Submit Incentive";t&&(i=t.value,t.value="Submitting...",t.disabled=!0);const o=`${window.location.origin}/api/combined-api.js?operation=incentives`;console.log("Attempting to submit to: ",o),fetch(o,{method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8"},body:JSON.stringify(e)}).then((e=>(console.log("response status:",e.status),console.log("response Headers:",[...e.headers.entries()]),e.ok?e.json():e.text().then((n=>{throw console.log("Error response body: ",n),new Error(`Server responded with status ${e.status}`)}))))).then((e=>{console.log("Incentive added successfully: ",e),alert("Incentive added successfully!"),function(){const e=document.getElementById("incentive-form");if(e){e.reset();const n=document.getElementById("selected-business-id");n&&(n.value=""),document.querySelectorAll('input[name="incentiveAvailable"]').forEach((e=>{e.checked=!1}));const t=document.getElementById("incentiveType");t&&(t.selectedIndex=0);const i=document.getElementById("otherTypeContainer");i&&(i.style.display="none");const o=document.getElementById("otherTypeDescription");o&&(o.value="");const s=document.getElementById("incentiveAmount");s&&(s.value="");const c=document.getElementById("incentiveInfo");c&&(c.value="");const l=document.getElementById("business-info-section");l&&(l.style.display="none");const a=document.getElementById("incentive-section");a&&(a.style.display="none");const d=document.getElementById("business-search-results");d&&(d.innerHTML="");const r=document.getElementById("business-name");r&&(r.value="");const u=document.getElementById("address");u&&(u.value="")}console.log("Incentive form has been reset")}()})).catch((e=>{console.error("Error adding incentive: ",e),alert(`Error adding incentive: ${e.message}`)})).finally((()=>{t&&(t.value=i,t.disabled=!1)}))}a&&a.addEventListener("submit",(function(e){e.preventDefault();const n=document.getElementById("selected-business-id"),t=n?n.value:"",i=document.querySelector('input[name="incentiveAvailable"]:checked'),o=i?i.value:null;if(!t)return void alert("Please select a business first");if(null===o)return void alert("Please specify if an incentive is available");const s=document.getElementById("incentiveType"),c=s?s.value:"",l=document.getElementById("incentiveAmount"),a=l?l.value:"",d=document.getElementById("incentiveInfo"),u=d?d.value:"";if(!("true"!==o||c&&a&&a))return void alert("Please provide incentive type, amount, and information");const m={business_id:t,is_available:"true"===o,type:c,amount:a,information:u};if("OT"===c){const e=document.getElementById("otherTypeDescription")?.value||"";if(!e)return void alert('Please provide a description for the "Other" incentive type');m.other_description=e}r(m)})),window.selectBusinessForIncentive=function(t){console.log("selectedBusinessForIncentive called with: ",t),e&&(e.style.display="block");const i=document.getElementById("selected-business-id");i&&(i.value=t._id||""),I("bname",t.bname),I("address1",t.address1),I("address2",t.address2),I("city",t.city),I("zip",t.zip),I("phone",t.phone),d("state",t.state),d("type",t.type),document.querySelectorAll("#business-info-section input, #business-info-section select").forEach((e=>{"select"===e.tagName.toLowerCase()?e.disabled=!0:e.setAttribute("readonly",!0)})),n&&(n.style.display="block"),n&&n.scrollIntoView({behavior:"smooth"})};const u=document.createElement("style");function m(e){return e&&""!==e.trim()}function f(e){return!isNaN(e)&&e>0}function v(e,n){return console.log(`Validating ${e.id} with value: ${e.value}`),n(e.value)?(e.classList.remove("invalid-field"),e.classList.add("valid-field"),e.setAttribute("data-valid","true"),console.log(`${e.id} is VALID`),!0):(e.classList.remove("valid-field"),e.classList.add("invalid-field"),e.setAttribute("data-valid","false"),console.log(`${e.id} is INVALID`),!1)}u.textContent="\n        .disabled-field {\n            background-color: #f0f0f0;\n            color: #888;\n            cursor: not-allowed;\n        }\n        textarea.disabled-field {\n            resize: none;\n        }\n    ",document.head.appendChild(u);const y=document.getElementById("incentiveType"),p=document.getElementById("incentiveAmount"),g=document.getElementById("incentiveInfo"),h=document.getElementById("otherTypeDescription");if(y&&y.addEventListener("change",(function(){v(this,m)})),p&&p.addEventListener("input",(function(){v(this,f)})),g&&g.addEventListener("input",(function(){v(this,m)})),h&&h.addEventListener("input",(function(){"OT"===y.value&&v(this,m)})),a){const e=a.cloneNode(!0);a.parentNode.replaceChild(e,a),e.addEventListener("submit",(function(e){if(e.preventDefault(),!function(){const e=document.getElementById("incentiveAvailable").checked;let n=!0;const t=document.getElementById("selected-business-id");if(!t||!t.value)return n=!1,alert("Please select a business first"),!1;if(!document.querySelector('input[name="incentiveAvailable"]:checked'))return n=!1,alert("Please specify if an incentive is available"),!1;if(e){const e=document.getElementById("incentiveType"),t=document.getElementById("incentiveAmount"),i=document.getElementById("incentiveInfo");v(e,m)||(n=!1),v(t,f)||(n=!1),v(i,m)||(n=!1),"OT"===e.value&&(v(document.getElementById("otherTypeDescription"),m)||(n=!1))}return n}())return;const n=document.getElementById("selected-business-id"),t=n?n.value:"",i=document.getElementById("incentiveAvailable").checked,o=document.getElementById("incentiveType"),s=o?o.value:"",c=document.getElementById("incentiveAmount"),l=c?c.value:"",a=document.getElementById("incentiveInfo"),d={business_id:t,is_available:i,type:s,amount:l,information:a?a.value:""};if("OT"===s){const e=document.getElementById("otherTypeDescription")?.value||"";d.other_description=e}r(d)}))}function I(e,n){const t=document.getElementById(e);t?(t.value=n||"",console.log(`Populated ${e} with:`,n)):console.warn(`Field ${e} not found.`)}u.textContent+="\n            .valid-field {\n                border: 1px solid green !important;\n                background-color: #f0fff0 !important;\n            }\n            \n            .invalid-field {\n                border: 1px solid red !important;\n                background-color: #fff0f0 !important;\n            }\n            \n            .required-indicator {\n                color: red;\n                font-weight: bold;\n            }\n            \n            .form-explanation {\n                margin-bottom: 15px;\n                font-style: italic;\n            }\n            ",document.head.appendChild(u),function(){["incentiveType","incentiveAmount","incentiveInfo"].forEach((e=>{if(document.getElementById(e)){const n=document.querySelector(`label[for="${e}"]`);if(n&&!n.innerHTML.includes("*")){const e=document.createElement("span");e.className="required-indicator",e.textContent=" *",e.style.color="red",n.appendChild(e)}}})),document.querySelectorAll('label[for="incentiveAvailable"], label[for="incentiveNotAvailable"]').forEach((e=>{if(!e.innerHTML.includes("*")){const n=document.createElement("span");n.className="required-indicator",n.textContent=" *",n.style.color="red",e.appendChild(n)}}));const e=document.getElementById("incentive-form");if(e){const n=document.createElement("div");n.className="form-explanation",n.innerHTML="<p>Fields marked with an asterisk (*) are required.</p>",e.insertBefore(n,e.firstChild)}}(),console.log("Adding extra debugging for business selection"),console.log("Does selectBusinessForIncentive exist?","function"==typeof window.selectBusinessForIncentive),window.debugSelectBusiness=function(e){console.log("Debug Select Business called with:",e);const n=document.getElementById("business-info-section"),t=document.getElementById("incentive-section");n?(console.log("Found business-info-section, setting display to block"),n.style.display="block"):console.error("Could not find business-info-section element"),t?(console.log("Found incentive-section, setting display to block"),t.style.display="block"):console.error("Could not find incentive-section element");const i=document.getElementById("selected-business-id");i&&(i.value=e._id||"",console.log("Set business ID to:",i.value)),I("bname",e.bname),I("address1",e.address1),I("address2",e.address2||""),I("city",e.city),I("state",e.state),I("zip",e.zip),I("phone",e.phone),I("type",e.type),n.scrollIntoView({behavior:"smooth"})};const b=window.selectBusinessForIncentive;window.selectBusinessForIncentive=function(e){console.log("Overridden selectBusinessForIncentive called with:",e),"function"==typeof b&&b(e),window.debugSelectBusiness(e)}})),document.addEventListener("DOMContentLoaded",(function(){console.log("Installing business-incentive-handler enhancements"),addChainStyles(),"function"==typeof window.selectBusinessForIncentive&&(console.log("Overriding selectBusinessForIncentive function"),window.originalSelectBusinessForIncentive=window.selectBusinessForIncentive,window.selectBusinessForIncentive=enhancedSelectBusinessForIncentive)}));