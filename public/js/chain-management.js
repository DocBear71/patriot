document.addEventListener("DOMContentLoaded",(function(){initChainManagement()}));let currentChainId=null,allChains=[],currentPage=1,chainsPerPage=10,filteredChains=[];function initChainManagement(){console.log("Initializing chain management page"),checkAdminStatus().then((e=>{e?(setupEventListeners(),setupBackToTopButton(),loadExistingChains(),setupSearchFunctionality(),setupPaginationKeyboardSupport(),setupModals()):console.error("Admin access denied")}))}function setupBackToTopButton(){const e=document.getElementById("backToTopBtn");e&&(window.addEventListener("scroll",(function(){window.pageYOffset>300?e.classList.add("show"):e.classList.remove("show")})),e.addEventListener("click",(function(){window.scrollTo({top:0,behavior:"smooth"})})))}function loadChainSummary(){if(!document.getElementById("summary-content"))return;const e=getBaseURL();fetch(`${e}/api/chains.js?operation=summary`).then((e=>{if(!e.ok)throw new Error(`Failed to load chain summary: ${e.status}`);return e.json()})).then((e=>{displayChainSummary(e)})).catch((e=>{console.error("Error loading chain summary:",e),allChains&&allChains.length>0?calculateSummaryFromChains():displaySummaryError()}))}function displayChainSummary(e){const n=document.getElementById("summary-content");if(!n)return;const t=e.total_chains||0,i=e.total_locations||0,a=e.total_incentives||0,o=e.active_chains_with_incentives||0;n.innerHTML=`\n        <div class="summary-stats">\n            <div class="stat-card chains">\n                <span class="stat-number">${t.toLocaleString()}</span>\n                <div class="stat-label">Total Chains</div>\n            </div>\n            <div class="stat-card locations">\n                <span class="stat-number">${i.toLocaleString()}</span>\n                <div class="stat-label">Chain Locations</div>\n            </div>\n            <div class="stat-card incentives">\n                <span class="stat-number">${a.toLocaleString()}</span>\n                <div class="stat-label">Total Incentives</div>\n            </div>\n            <div class="stat-card active-chains">\n                <span class="stat-number">${o.toLocaleString()}</span>\n                <div class="stat-label">Chains with Incentives</div>\n            </div>\n        </div>\n    `}function calculateSummaryFromChains(){const e=document.getElementById("summary-content");if(!e||!allChains)return;let n=allChains.length,t=0,i=0,a=0;allChains.forEach((e=>{t+=e.location_count||0,i+=e.incentive_count||0,e.incentive_count>0&&a++})),e.innerHTML=`\n        <div class="summary-stats">\n            <div class="stat-card chains">\n                <span class="stat-number">${n.toLocaleString()}</span>\n                <div class="stat-label">Total Chains</div>\n            </div>\n            <div class="stat-card locations">\n                <span class="stat-number">${t.toLocaleString()}</span>\n                <div class="stat-label">Chain Locations</div>\n            </div>\n            <div class="stat-card incentives">\n                <span class="stat-number">${i.toLocaleString()}</span>\n                <div class="stat-label">Total Incentives</div>\n            </div>\n            <div class="stat-card active-chains">\n                <span class="stat-number">${a.toLocaleString()}</span>\n                <div class="stat-label">Chains with Incentives</div>\n            </div>\n        </div>\n        <p style="text-align: center; margin-top: 15px; font-size: 0.85rem; color: #6c757d;">\n            <em>Statistics calculated from current page data</em>\n        </p>\n    `}function displaySummaryError(){const e=document.getElementById("summary-content");e&&(e.innerHTML='\n        <div class="summary-error">\n            <strong>Unable to load chain statistics</strong><br>\n            <small>The summary will be available once chain data loads successfully.</small>\n        </div>\n    ')}function refreshChainSummary(){loadChainSummary()}function loadExistingChains(){const e=document.getElementById("chains-list");if(!e)return;const n=getBaseURL();e.innerHTML='\n        <div class="text-center py-3">\n            <div class="spinner-border text-primary" role="status">\n                <span class="sr-only">Loading...</span>\n            </div>\n            <p>Loading chains...</p>\n        </div>\n    ',fetch(`${n}/api/chains.js?operation=list`).then((e=>{if(!e.ok)throw new Error(`Failed to load chains: ${e.status}`);return e.json()})).then((n=>{if(!n.chains||0===n.chains.length)return e.innerHTML='<p class="text-center py-3">No chains found. Create a new chain above.</p>',hidePagination(),void loadChainSummary();allChains=n.chains.sort(((e,n)=>e.chain_name.localeCompare(n.chain_name))),filteredChains=[...allChains],currentPage=1,displayChainsPage(),updatePagination(),loadChainSummary()})).catch((n=>{console.error("Error loading chains:",n),e.innerHTML=`\n                <div class="alert alert-danger" role="alert">\n                    Error loading chains: ${n.message}\n                </div>\n            `,hidePagination(),displaySummaryError()}))}function setupModals(){document.querySelectorAll('[data-bs-dismiss="modal"]').forEach((e=>{e.addEventListener("click",(function(){const e=this.closest(".modal");e&&ModalHelper.hide(e.id)}))}))}const ModalHelper={getInstance:function(e){const n=document.getElementById(e);if(!n)return null;try{return bootstrap.Modal.getInstance(n)}catch(n){return console.warn(`Could not get modal instance for ${e}:`,n),null}},createInstance:function(e){const n=document.getElementById(e);if(!n)return null;try{return new bootstrap.Modal(n)}catch(n){return console.warn(`Could not create modal instance for ${e}:`,n),null}},show:function(e){let n=this.getInstance(e);n||(n=this.createInstance(e)),n?n.show():console.error(`Could not show modal: ${e}`)},hide:function(e){const n=this.getInstance(e);if(n)n.hide();else{const n=document.getElementById(e);n&&($(n).removeClass("show"),$(n).css("display","none"),$(n).attr("aria-hidden","true"),$(n).removeAttr("aria-modal"),$(".modal-backdrop").remove(),$("body").removeClass("modal-open"),$("body").css("overflow",""),$("body").css("padding-right",""))}}};async function checkAdminStatus(){try{const e=getAuthToken();if(!e)return console.error("No auth token found"),window.location.href="/index.html?login=required&redirect="+encodeURIComponent(window.location.pathname),!1;const n="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin;try{const t=await fetch(`${n}/api/auth.js?operation=verify-token`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Cache-Control":"no-cache"}});if(!t.ok)return 401===t.status?(window.location.href="/index.html?login=required&redirect="+encodeURIComponent(window.location.pathname),!1):confirm("API error encountered. Would you like to bypass admin verification for development purposes?")?(console.warn("DEVELOPMENT MODE: Bypassing admin verification"),!0):(showAccessDenied(),!1);const i=await t.json(),a=!0===i.isAdmin||"Admin"===i.level;return a||showAccessDenied(),a}catch(e){return console.error("Error checking admin status:",e),confirm("API error encountered. Would you like to bypass admin verification for development purposes?")?(console.warn("DEVELOPMENT MODE: Bypassing admin verification"),!0):(showAccessDenied(),!1)}}catch(e){return console.error("Error in admin status check:",e),showAccessDenied(),!1}}function showAccessDenied(){document.querySelector("main").innerHTML='\n        <div class="container">\n            <div class="alert alert-danger" role="alert">\n                <h4 class="alert-heading">Access Denied</h4>\n                <p>You do not have permission to access this page. Only administrators can manage business chains.</p>\n                <hr>\n                <p class="mb-0">Please <a href="/index.html">return to the homepage</a> or contact an administrator if you believe this is an error.</p>\n            </div>\n        </div>\n    '}function setupEventListeners(){const e=document.getElementById("create-chain-form");e&&e.addEventListener("submit",(function(e){e.preventDefault(),createNewChain()}));const n=document.getElementById("update-chain-form");n&&n.addEventListener("submit",(function(e){e.preventDefault(),updateChain()}));const t=document.getElementById("delete-chain-btn");t&&t.addEventListener("click",(function(){confirmDeleteChain()}));const i=document.getElementById("add-location-btn");i&&i.addEventListener("click",(function(){openAddLocationModal()}));const a=document.getElementById("manage-incentives-btn");a&&a.addEventListener("click",(function(){openManageIncentivesModal()}));const o=document.getElementById("add-chain-incentive-form");o&&!o.hasAttribute("data-event-bound")&&(o.setAttribute("data-event-bound","true"),o.addEventListener("submit",(function(e){e.preventDefault(),addChainIncentive(e)})));const s=document.querySelectorAll('[data-bs-dismiss="modal"]');s.length>0&&s.forEach((e=>{e.addEventListener("click",(function(){const e=this.closest(".modal").id;$(`#${e}`).modal("hide"),$("body").removeClass("modal-open"),$(".modal-backdrop").remove()}))}));const r=document.getElementById("discount-type");r&&(r.addEventListener("change",(function(){updateDiscountTypeUI(this.value)})),updateDiscountTypeUI(r.value));const c=document.getElementById("edit-chain-incentive-form");c&&!c.hasAttribute("data-event-bound")&&(c.setAttribute("data-event-bound","true"),c.addEventListener("submit",(function(e){e.preventDefault(),updateChainIncentive(e)})));const d=document.getElementById("edit-discount-type");d&&d.addEventListener("change",(function(){updateEditDiscountTypeUI(this.value)}));const l=document.getElementById("search-business");l&&l.addEventListener("input",debounce((function(){this.value.length>=2&&searchBusinesses(this.value)}),500));const u=document.getElementById("incentive-type");u&&u.addEventListener("change",(function(){handleIncentiveTypeChange(this.value,!1)}));const h=document.getElementById("edit-incentive-type");h&&h.addEventListener("change",(function(){handleIncentiveTypeChange(this.value,!0)}));const m=document.getElementById("search-chain");m&&m.addEventListener("input",debounce((function(){filterChains(this.value)}),300))}function handleIncentiveTypeChange(e,n){const t=n?"edit-":"",i=document.getElementById(t+"other-description-group"),a=document.getElementById(t+"discount-type"),o=document.getElementById(t+"incentive-amount"),s=document.getElementById(t+"incentive-info");i&&(i.style.display="OT"===e?"block":"none"),"NC"===e?(a&&(a.value="percentage",a.disabled=!0),o&&(o.value="0",o.disabled=!0),s&&(s.value="No chainwide incentives available, check your local location for available discounts and/or incentives",s.disabled=!0),n?updateEditDiscountTypeUI("percentage"):updateDiscountTypeUI("percentage")):(a&&(a.disabled=!1),o&&(o.disabled=!1,"NC"!==e&&(o.value="")),s&&(s.disabled=!1,"NC"!==e&&(s.value="")))}function updateDiscountTypeUI(e){const n=document.getElementById("amount-label"),t=document.getElementById("amount-prefix"),i=document.getElementById("incentive-amount"),a=document.getElementById("amount-help");n&&t&&i&&a&&("dollar"===e?(n.textContent="Amount ($):",t.textContent="$",i.setAttribute("max","1000"),i.setAttribute("step","0.01"),i.setAttribute("min","0.01"),a.textContent="Enter the dollar discount amount (e.g., 0.05 for $0.05 off per gallon)"):(n.textContent="Amount (%):",t.textContent="%",i.setAttribute("max","100"),i.setAttribute("step",".01"),i.setAttribute("min",".01"),a.textContent="Enter the discount percentage (0.01-100)"),i.value="")}function displayChainsPage(){const e=document.getElementById("chains-list");if(!e)return;const n=(currentPage-1)*chainsPerPage,t=n+chainsPerPage,i=filteredChains.slice(n,t);if(0===i.length)return void(e.innerHTML='<p class="text-center py-3">No chains found.</p>');let a="";i.forEach((e=>{const n=getBusinessTypeLabel(e.business_type);a+=`\n            <div class="card mb-2 chain-item" data-chain-id="${e._id}" data-chain-name="${e.chain_name}">\n                <div class="card-body d-flex justify-content-between align-items-center py-2">\n                    <div class="text-left">\n                        <h4 class="mb-0 text-left">${e.chain_name}</h4>\n                        <small class="text-left">${n}</small>\n                    </div>\n                    <div>\n                        <small>${e.location_count||0} locations | ${e.incentive_count||0} incentives</small>\n                        <button class="btn btn-sm btn-primary btn-action view-chain-btn"\n                                data-chain-id="${e._id}">\n                            View Details\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `})),e.innerHTML=a,document.querySelectorAll(".view-chain-btn").forEach((e=>{e.addEventListener("click",(function(){viewChainDetails(this.getAttribute("data-chain-id"))}))}))}function updateEditDiscountTypeUI(e){const n=document.getElementById("edit-amount-label"),t=document.getElementById("edit-amount-prefix"),i=document.getElementById("edit-incentive-amount"),a=document.getElementById("edit-amount-help");n&&t&&i&&a&&("dollar"===e?(n.textContent="Amount ($):",t.textContent="$",i.setAttribute("max","1000"),i.setAttribute("step","0.01"),i.setAttribute("min","0.01"),a.textContent="Enter the dollar discount amount (e.g., 0.05 for $0.05 off per gallon)"):(n.textContent="Amount (%):",t.textContent="%",i.setAttribute("max","100"),i.setAttribute("step","0.01"),i.setAttribute("min","0.01"),a.textContent="Enter the discount percentage (0.01-100)"))}function openEditChainIncentiveModal(e,n){e&&n?(document.getElementById("edit-incentive-id").value=e,document.getElementById("edit-incentive-type").value=n.type||"",document.getElementById("edit-other-description").value=n.other_description||"",document.getElementById("edit-discount-type").value=n.discount_type||"percentage",document.getElementById("edit-incentive-amount").value=n.amount||"",document.getElementById("edit-incentive-info").value=n.information||"",document.getElementById("edit-incentive-active").checked=!1!==n.is_active,handleIncentiveTypeChange(n.type||"",!0),updateEditDiscountTypeUI(n.discount_type||"percentage"),ModalHelper.show("edit-chain-incentive-modal")):console.error("Invalid incentive data for editing")}function updateChainIncentive(e){e.preventDefault();const n=currentChainId,t=document.getElementById("edit-incentive-id").value;if(!n||!t)return void alert("Missing chain or incentive information.");const i=document.getElementById("edit-incentive-type").value,a=document.getElementById("edit-other-description").value.trim(),o=document.getElementById("edit-incentive-amount").value,s=document.getElementById("edit-incentive-info").value.trim(),r=document.getElementById("edit-discount-type").value,c=document.getElementById("edit-incentive-active").checked;if(!i||!r)return void alert("Please fill in all required fields.");if("OT"===i&&!a)return void alert('Please provide a description for the "Other" incentive type.');let d;if("NC"===i)d=0;else{if(!o)return void alert("Please enter a discount amount.");if(d=parseFloat(o),isNaN(d)||d<=0)return void alert("Please enter a valid amount greater than 0.");if("percentage"===r){if(d>100)return void alert("Percentage discount cannot exceed 100%.");if(d<.01)return void alert("Percentage discount must be at least 0.01%.")}else if("dollar"===r){if(d>1e3)return void alert("Dollar discount cannot exceed $1000.");if(d<.01)return void alert("Dollar discount must be at least $0.01.")}}const l=getBaseURL(),u={chain_id:n,incentive_id:t,type:i,amount:d,information:s,discount_type:r,is_active:c};"OT"===i&&(u.other_description=a),fetch(`${l}/api/chains.js?operation=update_incentive`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${getAuthToken()}`},body:JSON.stringify(u)}).then((e=>{if(!e.ok)throw new Error(`Failed to update incentive: ${e.status}`);return e.json()})).then((e=>{alert("Incentive updated successfully!"),ModalHelper.hide("edit-chain-incentive-modal"),document.getElementById("manage-incentives-modal").classList.contains("show")&&loadModalChainIncentives(n),viewChainDetails(n),refreshChainSummary()})).catch((e=>{console.error("Error updating incentive:",e),alert(`Error updating incentive: ${e.message}`)}))}function updatePagination(){const e=document.getElementById("pagination-container"),n=document.getElementById("paginationInfo"),t=document.getElementById("pageJumpInput");if(!e)return;const i=Math.ceil(filteredChains.length/chainsPerPage);if(i<=1)return void(e.style.display="none");e.style.display="block";const a=(currentPage-1)*chainsPerPage+1,o=Math.min(currentPage*chainsPerPage,filteredChains.length);n.textContent=`Page ${currentPage} of ${i} (${a}-${o} of ${filteredChains.length} chains)`,t&&(t.max=i,t.placeholder=`1-${i}`),updatePaginationButtons(i),updatePageNumbers(i)}function updatePaginationButtons(e){const n=document.getElementById("firstPageBtn"),t=document.getElementById("prevPageBtn"),i=document.getElementById("prevTenBtn"),a=document.getElementById("nextPageBtn"),o=document.getElementById("nextTenBtn"),s=document.getElementById("lastPageBtn");n&&(n.disabled=1===currentPage),t&&(t.disabled=1===currentPage),i&&(i.disabled=currentPage<=10),s&&(s.disabled=currentPage===e),a&&(a.disabled=currentPage===e),o&&(o.disabled=currentPage>e-10)}function updatePageNumbers(e){const n=document.getElementById("pageNumbers");if(!n)return;if(e<=1||e>20)return void(n.style.display="none");n.style.display="flex";let t="",i=Math.max(1,currentPage-2),a=Math.min(e,currentPage+2);a-i<4&&(1===i?a=Math.min(e,i+4):a===e&&(i=Math.max(1,a-4))),i>1&&(t+='<button class="pagination-btn" onclick="jumpToPage(1)">1</button>',i>2&&(t+='<span class="pagination-separator">...</span>'));for(let e=i;e<=a;e++)t+=`<button class="pagination-btn ${e===currentPage?"active":""}" onclick="jumpToPage(${e})">${e}</button>`;a<e&&(a<e-1&&(t+='<span class="pagination-separator">...</span>'),t+=`<button class="pagination-btn" onclick="jumpToPage(${e})">${e}</button>`),n.innerHTML=t}function changePage(e){const n=Math.ceil(filteredChains.length/chainsPerPage);let t=currentPage+e;t<1&&(t=1),t>n&&(t=n),t!==currentPage&&(currentPage=t,displayChainsPage(),updatePagination(),document.getElementById("chains-list").scrollIntoView({behavior:"smooth",block:"start"}))}function jumpToPage(e){const n=Math.ceil(filteredChains.length/chainsPerPage);e<1&&(e=1),e>n&&(e=n),e!==currentPage&&(currentPage=e,displayChainsPage(),updatePagination(),document.getElementById("chains-list").scrollIntoView({behavior:"smooth",block:"start"}))}function jumpToLastPage(){jumpToPage(Math.ceil(filteredChains.length/chainsPerPage))}function jumpToInputPage(){const e=document.getElementById("pageJumpInput");if(!e)return;const n=parseInt(e.value);if(isNaN(n))return void alert("Please enter a valid page number.");const t=Math.ceil(filteredChains.length/chainsPerPage);n<1||n>t?alert(`Please enter a page number between 1 and ${t}.`):(jumpToPage(n),e.value="")}function changeItemsPerPage(){const e=document.getElementById("chainsPerPageSelect");if(!e)return;const n=parseInt(e.value);if(isNaN(n))return;const t=(currentPage-1)*chainsPerPage,i=Math.floor(t/n)+1;chainsPerPage=n,currentPage=i,displayChainsPage(),updatePagination()}function setupPaginationKeyboardSupport(){const e=document.getElementById("pageJumpInput");e&&e.addEventListener("keypress",(function(e){"Enter"===e.key&&jumpToInputPage()}))}function hidePagination(){const e=document.getElementById("pagination-container");e&&(e.style.display="none")}function createNewChain(){const e=document.getElementById("chain-name").value.trim(),n=document.getElementById("chain-type").value,t=document.getElementById("universal-incentives").checked;if(!e||!n)return void alert("Please fill in all required fields.");const i=getBaseURL(),a={chain_name:e,business_type:n,universal_incentives:t};fetch(`${i}/api/chains.js?operation=create`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${getAuthToken()}`},body:JSON.stringify(a)}).then((e=>e.ok?e.json():e.text().then((n=>{throw console.error("API Error Response:",n),new Error(`Failed to create chain: ${e.status}`)})))).then((e=>{alert("Chain created successfully!"),document.getElementById("create-chain-form").reset(),loadExistingChains()})).then((e=>{alert("Chain created successfully!"),document.getElementById("create-chain-form").reset(),loadExistingChains()})).catch((e=>{console.error("Error creating chain:",e),alert(`Error creating chain: ${e.message}`)}))}function viewChainDetails(e){if(!e)return;currentChainId=e;const n=getBaseURL();fetch(`${n}/api/chains.js?operation=get&id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to load chain details: ${e.status}`);return e.json()})).then((n=>{if(!n.chain)return void alert("Chain not found.");const t=n.chain;document.getElementById("selected-chain-id").value=t._id,document.getElementById("selected-chain-name").textContent=t.chain_name,document.getElementById("update-chain-name").value=t.chain_name,document.getElementById("update-chain-type").value=t.business_type,document.getElementById("update-universal-incentives").checked=!0===t.universal_incentives,document.getElementById("chain-details").style.display="block",loadChainIncentivesFromEmbedded(t.incentives||[]),loadChainLocations(e),document.getElementById("chain-details").scrollIntoView({behavior:"smooth"})})).catch((e=>{console.error("Error loading chain details:",e),alert(`Error loading chain details: ${e.message}`)}))}function loadChainIncentivesFromEmbedded(e){const n=document.getElementById("chain-incentives");if(!n)return;if(!e||0===e.length)return void(n.innerHTML="<p>No incentives found for this chain.</p>");let t='<div class="list-group">';e.forEach((e=>{if(!1!==e.is_active){const n=getIncentiveTypeLabel(e.type),i=e.other_description?` (${e.other_description})`:"",a=formatDiscountAmount(e.amount,e.discount_type,e.type),o=!1===e.is_active?'<span class="badge badge-secondary">Inactive</span>':"";t+=`\n                <div class="list-group-item d-flex justify-content-between align-items-center">\n                    <div>\n                        <strong>${n}${i}:</strong> ${a} ${o}\n                        <div><small>${e.information||""}</small></div>\n                    </div>\n                    <div>\n                        <button class="btn btn-sm btn-primary btn-action" \n                                onclick="editChainIncentiveFromMain('${e._id}')">\n                            <i class="bi bi-pencil"></i> Edit\n                        </button>\n                        <button class="btn btn-sm btn-danger" \n                                onclick="deleteChainIncentive('${e._id}')">\n                            <i class="bi bi-trash"></i> Remove\n                        </button>\n                    </div>\n                </div>\n            `}})),t+="</div>",n.innerHTML=t}function loadChainIncentives(e){if(!e)return;const n=document.getElementById("chain-incentives");if(!n)return;n.innerHTML='<p class="text-center">Loading incentives...</p>';const t=getBaseURL();fetch(`${t}/api/combined-api.js?operation=incentives&business_id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to load incentives: ${e.status}`);return e.json()})).then((e=>{if(!e.results||0===e.results.length)return void(n.innerHTML="<p>No incentives found for this chain.</p>");let t='<div class="list-group">';e.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),i=e.other_description?` (${e.other_description})`:"";t+=`\n                        <div class="list-group-item d-flex justify-content-between align-items-center">\n                            <div>\n                                <strong>${n}${i}:</strong> ${e.amount}%\n                                <div><small>${e.information||""}</small></div>\n                            </div>\n                            <div>\n                                <button class="btn btn-sm btn-danger" onclick="deleteIncentive('${e._id}')">\n                                    <i class="fas fa-trash"></i> Remove\n                                </button>\n                            </div>\n                        </div>\n                    `}})),t+="</div>",n.innerHTML=t})).catch((e=>{console.error("Error loading incentives:",e),n.innerHTML=`\n                <div class="alert alert-danger" role="alert">\n                    Error loading incentives: ${e.message}\n                </div>\n            `}))}function updateChain(){const e=document.getElementById("selected-chain-id").value;if(!e)return void alert("No chain selected.");const n=document.getElementById("update-chain-name").value.trim(),t=document.getElementById("update-chain-type").value,i=document.getElementById("update-universal-incentives").checked;if(!n||!t)return void alert("Please fill in all required fields.");const a=getBaseURL(),o={_id:e,chain_name:n,business_type:t,universal_incentives:i};fetch(`${a}/api/chains.js?operation=update`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${getAuthToken()}`},body:JSON.stringify(o)}).then((e=>{if(!e.ok)throw new Error(`Failed to update chain: ${e.status}`);return e.json()})).then((e=>{alert("Chain updated successfully!"),document.getElementById("selected-chain-name").textContent=n,loadExistingChains()})).then((e=>{alert("Chain updated successfully!"),document.getElementById("selected-chain-name").textContent=n,loadExistingChains()})).catch((e=>{console.error("Error updating chain:",e),alert(`Error updating chain: ${e.message}`)}))}function deleteChain(e){if(!e)return;const n=getBaseURL();fetch(`${n}/api/chains.js?operation=delete`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${getAuthToken()}`},body:JSON.stringify({_id:e})}).then((e=>{if(!e.ok)throw new Error(`Failed to delete chain: ${e.status}`);return e.json()})).then((e=>{alert("Chain deleted successfully!"),document.getElementById("chain-details").style.display="none",currentChainId=null,loadExistingChains()})).then((e=>{alert("Chain deleted successfully!"),document.getElementById("chain-details").style.display="none",currentChainId=null,loadExistingChains()})).catch((e=>{console.error("Error deleting chain:",e),alert(`Error deleting chain: ${e.message}`)}))}function loadChainLocations(e){if(!e)return;const n=document.getElementById("chain-locations");if(!n)return;n.innerHTML='<p class="text-center">Loading locations...</p>';const t=getBaseURL();fetch(`${t}/api/chains.js?operation=get_locations&chain_id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to load locations: ${e.status}`);return e.json()})).then((e=>{if(!e.locations||0===e.locations.length)return void(n.innerHTML="<p>No locations found for this chain.</p>");let t="";e.locations.forEach((e=>{const n=e.address2?`${e.address1}, ${e.address2}, ${e.city}, ${e.state} ${e.zip}`:`${e.address1}, ${e.city}, ${e.state} ${e.zip}`;t+=`\n                    <div class="location-item d-flex justify-content-between align-items-center">\n                        <div>\n                            <strong>${e.bname}</strong>\n                            <div><small>${n}</small></div>\n                        </div>\n                        <div>\n                            <button class="btn btn-sm btn-danger" onclick="removeLocationFromChain('${e._id}')">\n                                <i class="fas fa-unlink"></i> Remove\n                            </button>\n                        </div>\n                    </div>\n                `})),n.innerHTML=t})).catch((e=>{console.error("Error loading locations:",e),n.innerHTML=`\n                <div class="alert alert-danger" role="alert">\n                    Error loading locations: ${e.message}\n                </div>\n            `}))}function addLocationToChain(e){if(!e)return;const n=currentChainId;if(!n)return void alert("No chain selected.");const t=getBaseURL();fetch(`${t}/api/chains.js?operation=add_location`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${getAuthToken()}`},body:JSON.stringify({business_id:e,chain_id:n})}).then((e=>{if(!e.ok)throw new Error(`Failed to add location to chain: ${e.status}`);return e.json()})).then((e=>{alert("Location added to chain successfully!"),ModalHelper.hide("add-location-modal"),loadChainLocations(n)})).catch((e=>{console.error("Error adding location to chain:",e),alert(`Error adding location to chain: ${e.message}`)}))}function removeLocationFromChain(e){if(!e)return;if(!confirm("Are you sure you want to remove this location from the chain?"))return;const n=getBaseURL();fetch(`${n}/api/chains.js?operation=remove_location`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${getAuthToken()}`},body:JSON.stringify({business_id:e})}).then((e=>{if(!e.ok)throw new Error(`Failed to remove location from chain: ${e.status}`);return e.json()})).then((e=>{alert("Location removed from chain successfully!"),loadChainLocations(currentChainId)})).catch((e=>{console.error("Error removing location from chain:",e),alert(`Error removing location from chain: ${e.message}`)}))}function confirmDeleteChain(){const e=document.getElementById("selected-chain-id").value;if(!e)return void alert("No chain selected.");const n=document.getElementById("selected-chain-name").textContent;confirm(`Are you sure you want to delete the chain "${n}"? This will remove all chain associations but will not delete individual locations.`)&&deleteChain(e)}function openAddLocationModal(){currentChainId?(document.getElementById("business-search-results").innerHTML='<p class="text-center">Search for a business to add as a location</p>',document.getElementById("search-business").value="",$("#add-location-modal").modal("show")):alert("No chain selected.")}function searchBusinesses(e){if(!e)return;const n=document.getElementById("business-search-results");if(!n)return;n.innerHTML='<p class="text-center">Searching...</p>';const t=getBaseURL();fetch(`${t}/api/business.js?operation=search&business_name=${encodeURIComponent(e)}`).then((e=>{if(!e.ok)throw new Error(`Failed to search businesses: ${e.status}`);return e.json()})).then((e=>{if(!e.results||0===e.results.length)return void(n.innerHTML='<p class="text-center">No businesses found matching your search.</p>');const t=e.results.filter((e=>!e.is_chain));if(0===t.length)return void(n.innerHTML='<p class="text-center">No eligible businesses found. Businesses that are already chains cannot be added as locations.</p>');let i='<div class="list-group">';t.forEach((e=>{const n=e.address2?`${e.address1}, ${e.address2}, ${e.city}, ${e.state} ${e.zip}`:`${e.address1}, ${e.city}, ${e.state} ${e.zip}`,t=!!e.chain_id;i+=`\n                    <div class="list-group-item d-flex justify-content-between align-items-center">\n                        <div>\n                            <strong>${e.bname}</strong>\n                            <div><small>${n}</small></div>\n                            ${t?'<span class="badge badge-warning">Already in another chain</span>':""}\n                        </div>\n                        <div>\n                            <button class="btn btn-sm btn-success" \n                                    onclick="addLocationToChain('${e._id}')"\n                                    ${t?"disabled":""}>\n                                Add to Chain\n                            </button>\n                        </div>\n                    </div>\n                `})),i+="</div>",n.innerHTML=i})).catch((e=>{console.error("Error searching businesses:",e),n.innerHTML=`\n                <div class="alert alert-danger" role="alert">\n                    Error searching businesses: ${e.message}\n                </div>\n            `}))}function openManageIncentivesModal(){const e=currentChainId;if(!e)return void alert("No chain selected.");loadModalChainIncentives(e),document.getElementById("add-chain-incentive-form").reset(),document.getElementById("other-description-group").style.display="none";const n=document.getElementById("discount-type");n&&(n.value="percentage",updateDiscountTypeUI("percentage")),ModalHelper.show("manage-incentives-modal")}function loadModalChainIncentives(e){if(!e)return;const n=document.getElementById("modal-chain-incentives");if(!n)return;n.innerHTML='<p class="text-center">Loading incentives...</p>';const t=getBaseURL();fetch(`${t}/api/chains.js?operation=get_incentives&chain_id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to load incentives: ${e.status}`);return e.json()})).then((e=>{if(!e.incentives||0===e.incentives.length)return void(n.innerHTML="<p>No incentives found for this chain.</p>");let t='<div class="list-group">';e.incentives.forEach((e=>{const n=getIncentiveTypeLabel(e.type),i=e.other_description?` (${e.other_description})`:"",a=formatDiscountAmount(e.amount,e.discount_type,e.type),o=!1===e.is_active?'<span class="badge badge-secondary">Inactive</span>':"",s=JSON.stringify(e).replace(/"/g,"&quot;");t+=`\n                    <div class="list-group-item d-flex justify-content-between align-items-center">\n                        <div>\n                            <strong>${n}${i}:</strong> ${a} ${o}\n                            <div><small>${e.information||""}</small></div>\n                        </div>\n                        <div>\n                            <button class="btn btn-sm btn-primary btn-action" \n                                    onclick="editChainIncentiveFromModal('${e._id}', '${s}')">\n                                <i class="bi bi-pencil"></i> Edit\n                            </button>\n                            <button class="btn btn-sm btn-danger" \n                                    onclick="deleteChainIncentive('${e._id}', true)">\n                                <i class="bi bi-trash"></i> Remove\n                            </button>\n                        </div>\n                    </div>\n                `})),t+="</div>",n.innerHTML=t})).catch((e=>{console.error("Error loading incentives:",e),n.innerHTML=`\n                <div class="alert alert-danger" role="alert">\n                    Error loading incentives: ${e.message}\n                </div>\n            `}))}function formatDiscountAmount(e,n,t){return"NC"===t?"See local location":"dollar"===n?`$${parseFloat(e).toFixed(2)} off`:`${parseFloat(e)}%`}function editChainIncentiveFromMain(e){const n=getBaseURL();fetch(`${n}/api/chains.js?operation=get&id=${currentChainId}`).then((e=>e.json())).then((n=>{if(n.chain&&n.chain.incentives){const t=n.chain.incentives.find((n=>n._id==e));t?openEditChainIncentiveModal(e,t):alert("Incentive not found.")}})).catch((e=>{console.error("Error loading incentive for edit:",e),alert("Error loading incentive data.")}))}function editChainIncentiveFromModal(e,n){try{openEditChainIncentiveModal(e,JSON.parse(n.replace(/&quot;/g,'"')))}catch(e){console.error("Error parsing incentive data:",e),alert("Error loading incentive data for editing.")}}function addChainIncentive(e){e.preventDefault();const n=currentChainId;if(!n)return void alert("No chain selected.");const t=document.getElementById("incentive-type").value,i=document.getElementById("other-description").value.trim(),a=document.getElementById("incentive-amount").value,o=document.getElementById("incentive-info").value.trim(),s=document.getElementById("discount-type").value;if(!t||!s)return void alert("Please fill in all required fields.");if("OT"===t&&!i)return void alert('Please provide a description for the "Other" incentive type.');let r;if("NC"===t)r=0;else{if(!a)return void alert("Please enter a discount amount.");if(r=parseFloat(a),isNaN(r)||r<=0)return void alert("Please enter a valid amount greater than 0.");if("percentage"===s){if(r>100)return void alert("Percentage discount cannot exceed 100%.");if(r<.01)return void alert("Percentage discount must be at least 0.01%.")}else if("dollar"===s){if(r>1e3)return void alert("Dollar discount cannot exceed $1000.");if(r<.01)return void alert("Dollar discount must be at least $0.01.")}}const c=getBaseURL(),d={chain_id:n,type:t,amount:r,information:o,discount_type:s};"OT"===t&&(d.other_description=i),fetch(`${c}/api/chains.js?operation=add_incentive`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${getAuthToken()}`},body:JSON.stringify(d)}).then((e=>{if(!e.ok)throw new Error(`Failed to add incentive: ${e.status}`);return e.json()})).then((e=>{alert("Incentive added successfully!"),document.getElementById("add-chain-incentive-form").reset(),updateDiscountTypeUI("percentage"),ModalHelper.hide("manage-incentives-modal"),viewChainDetails(n),refreshChainSummary()})).catch((e=>{console.error("Error adding incentive:",e),alert(`Error adding incentive: ${e.message}`)}))}function deleteChainIncentive(e,n=!1){if(!e)return;if(!confirm("Are you sure you want to delete this incentive?"))return;const t=getBaseURL();fetch(`${t}/api/chains.js?operation=remove_incentive`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${getAuthToken()}`},body:JSON.stringify({chain_id:currentChainId,incentive_id:e})}).then((e=>{if(!e.ok)throw new Error(`Failed to delete incentive: ${e.status}`);return e.json()})).then((e=>{alert("Incentive deleted successfully!"),n&&loadModalChainIncentives(currentChainId),viewChainDetails(currentChainId)})).catch((e=>{console.error("Error deleting incentive:",e),alert(`Error deleting incentive: ${e.message}`)}))}function deleteIncentive(e,n=!1){if(!e)return;if(!confirm("Are you sure you want to delete this incentive?"))return;const t=getBaseURL();fetch(`${t}/api/combined-api.js?operation=incentives&id=${e}&operation=delete`,{method:"POST"}).then((e=>{if(!e.ok)throw new Error(`Failed to delete incentive: ${e.status}`);return e.json()})).then((e=>{alert("Incentive deleted successfully!"),n&&loadModalChainIncentives(currentChainId),loadChainIncentives(currentChainId)})).catch((e=>{console.error("Error deleting incentive:",e),alert(`Error deleting incentive: ${e.message}`)}))}function filterChains(e){filteredChains=e.trim()?allChains.filter((n=>n.chain_name.toLowerCase().includes(e.toLowerCase())||getBusinessTypeLabel(n.business_type).toLowerCase().includes(e.toLowerCase()))):[...allChains],currentPage=1,displayChainsPage(),updatePagination()}function setupSearchFunctionality(){}function getBaseURL(){return"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin}function getBusinessTypeLabel(e){return{AUTO:"Automotive",BEAU:"Beauty",BOOK:"Bookstore",CLTH:"Clothing",CONV:"Convenience Store/Gas Station",DEPT:"Department Store",ELEC:"Electronics",ENTR:"Entertainment",FURN:"Furniture",FUEL:"Fuel Station/Truck Stop",GIFT:"Gift Shop",GROC:"Grocery",HARDW:"Hardware",HEAL:"Health",HOTEL:"Hotel/Motel",JEWL:"Jewelry",OTHER:"Other",RX:"Pharmacy",REST:"Restaurant",RETAIL:"Retail",SERV:"Service",SPEC:"Specialty",SPRT:"Sporting Goods",TECH:"Technology",TOYS:"Toys"}[e]||e}function getIncentiveTypeLabel(e){return{VT:"Veteran",AD:"Active-Duty",FR:"First Responder",SP:"Spouse",NC:"No Chainwide Incentives",OT:"Other"}[e]||e}function debounce(e,n){let t;return function(...i){const a=this;clearTimeout(t),t=setTimeout((()=>e.apply(a,i)),n)}}