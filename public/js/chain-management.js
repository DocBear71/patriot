document.addEventListener("DOMContentLoaded",(function(){initChainManagement()}));let currentChainId=null;function initChainManagement(){console.log("Initializing chain management page"),checkAdminStatus().then((e=>{e?(setupEventListeners(),loadExistingChains(),setupSearchFunctionality(),setupModals()):console.error("Admin access denied")}))}function setupModals(){document.querySelectorAll('[data-bs-dismiss="modal"]').forEach((e=>{e.addEventListener("click",(function(){const e=this.closest(".modal");e&&ModalHelper.hide(e.id)}))}));const e=document.getElementById("add-chain-incentive-form");e&&e.addEventListener("submit",(function(e){e.preventDefault(),addChainIncentive(e)}))}const ModalHelper={getInstance:function(e){const n=document.getElementById(e);if(!n)return null;try{return bootstrap.Modal.getInstance(n)}catch(n){return console.warn(`Could not get modal instance for ${e}:`,n),null}},createInstance:function(e){const n=document.getElementById(e);if(!n)return null;try{return new bootstrap.Modal(n)}catch(n){return console.warn(`Could not create modal instance for ${e}:`,n),null}},show:function(e){let n=this.getInstance(e);n||(n=this.createInstance(e)),n?n.show():console.error(`Could not show modal: ${e}`)},hide:function(e){const n=this.getInstance(e);if(n)n.hide();else{const n=document.getElementById(e);n&&($(n).removeClass("show"),$(n).css("display","none"),$(n).attr("aria-hidden","true"),$(n).removeAttr("aria-modal"),$(".modal-backdrop").remove(),$("body").removeClass("modal-open"),$("body").css("overflow",""),$("body").css("padding-right",""))}}};async function checkAdminStatus(){try{const e=getAuthToken();if(!e)return console.error("No auth token found"),window.location.href="/index.html?login=required&redirect="+encodeURIComponent(window.location.pathname),!1;const n="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin;try{const t=await fetch(`${n}/api/auth.js?operation=verify-token`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Cache-Control":"no-cache"}});if(!t.ok)return 401===t.status?(window.location.href="/index.html?login=required&redirect="+encodeURIComponent(window.location.pathname),!1):confirm("API error encountered. Would you like to bypass admin verification for development purposes?")?(console.warn("DEVELOPMENT MODE: Bypassing admin verification"),!0):(showAccessDenied(),!1);const i=await t.json(),o=!0===i.isAdmin||"Admin"===i.level;return o||showAccessDenied(),o}catch(e){return console.error("Error checking admin status:",e),confirm("API error encountered. Would you like to bypass admin verification for development purposes?")?(console.warn("DEVELOPMENT MODE: Bypassing admin verification"),!0):(showAccessDenied(),!1)}}catch(e){return console.error("Error in admin status check:",e),showAccessDenied(),!1}}function showAccessDenied(){document.querySelector("main").innerHTML='\n        <div class="container">\n            <div class="alert alert-danger" role="alert">\n                <h4 class="alert-heading">Access Denied</h4>\n                <p>You do not have permission to access this page. Only administrators can manage business chains.</p>\n                <hr>\n                <p class="mb-0">Please <a href="/index.html">return to the homepage</a> or contact an administrator if you believe this is an error.</p>\n            </div>\n        </div>\n    '}function setupEventListeners(){const e=document.getElementById("create-chain-form");e&&e.addEventListener("submit",(function(e){e.preventDefault(),createNewChain()}));const n=document.getElementById("update-chain-form");n&&n.addEventListener("submit",(function(e){e.preventDefault(),updateChain()}));const t=document.getElementById("delete-chain-btn");t&&t.addEventListener("click",(function(){confirmDeleteChain()}));const i=document.getElementById("add-location-btn");i&&i.addEventListener("click",(function(){openAddLocationModal()}));const o=document.getElementById("manage-incentives-btn");o&&o.addEventListener("click",(function(){openManageIncentivesModal()})),document.getElementById("add-chain-incentive-form").hasAttribute("data-event-bound")||(document.getElementById("add-chain-incentive-form").setAttribute("data-event-bound","true"),document.getElementById("add-chain-incentive-form").addEventListener("submit",(function(e){e.preventDefault(),addChainIncentive(e)})));const a=document.querySelectorAll('[data-bs-dismiss="modal"]');a.length>0&&a.forEach((e=>{e.addEventListener("click",(function(){const e=this.closest(".modal").id;$(`#${e}`).modal("hide"),$("body").removeClass("modal-open"),$(".modal-backdrop").remove()}))}));const s=document.getElementById("incentive-type");s&&s.addEventListener("change",(function(){const e=document.getElementById("other-description-group");"OT"===this.value?e.style.display="block":e.style.display="none"}));const r=document.getElementById("search-business");r&&r.addEventListener("input",debounce((function(){this.value.length>=2&&searchBusinesses(this.value)}),500));const c=document.getElementById("search-chain");c&&c.addEventListener("input",debounce((function(){filterChains(this.value)}),300))}function loadExistingChains(){const e=document.getElementById("chains-list");if(!e)return;const n=getBaseURL();fetch(`${n}/api/chains.js?operation=list`).then((e=>{if(!e.ok)throw new Error(`Failed to load chains: ${e.status}`);return e.json()})).then((n=>{if(!n.chains||0===n.chains.length)return void(e.innerHTML='<p class="text-center py-3">No chains found. Create a new chain above.</p>');n.chains.sort(((e,n)=>e.chain_name.localeCompare(n.chain_name)));let t="";n.chains.forEach((e=>{const n=getBusinessTypeLabel(e.business_type);t+=`\n                    <div class="card mb-2 chain-item" data-chain-id="${e._id}" data-chain-name="${e.chain_name}">\n                        <div class="card-body d-flex justify-content-between align-items-center py-2">\n                            <div class="text-left">\n                                <h4 class="mb-0 text-left">${e.chain_name}</h4>\n                                <small class="text-left">${n}</small>\n                            </div>\n                            <div>\n                                <small>${e.location_count||0} locations | ${e.incentive_count||0} incentives</small>\n                                <button class="btn btn-sm btn-primary btn-action view-chain-btn"\n                                        data-chain-id="${e._id}">\n                                    View Details\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                `})),e.innerHTML=t,document.querySelectorAll(".view-chain-btn").forEach((e=>{e.addEventListener("click",(function(){viewChainDetails(this.getAttribute("data-chain-id"))}))}))})).catch((n=>{console.error("Error loading chains:",n),e.innerHTML=`\n                <div class="alert alert-danger" role="alert">\n                    Error loading chains: ${n.message}\n                </div>\n            `}))}function createNewChain(){const e=document.getElementById("chain-name").value.trim(),n=document.getElementById("chain-type").value,t=document.getElementById("universal-incentives").checked;if(!e||!n)return void alert("Please fill in all required fields.");const i=getBaseURL(),o={chain_name:e,business_type:n,universal_incentives:t};fetch(`${i}/api/chains.js?operation=create`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${getAuthToken()}`},body:JSON.stringify(o)}).then((e=>e.ok?e.json():e.text().then((n=>{throw console.error("API Error Response:",n),new Error(`Failed to create chain: ${e.status}`)})))).then((e=>{alert("Chain created successfully!"),document.getElementById("create-chain-form").reset(),loadExistingChains(),e.chain&&e.chain._id&&viewChainDetails(e.chain._id)})).catch((e=>{console.error("Error creating chain:",e),alert(`Error creating chain: ${e.message}`)}))}function viewChainDetails(e){if(!e)return;currentChainId=e;const n=getBaseURL();fetch(`${n}/api/chains.js?operation=get&id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to load chain details: ${e.status}`);return e.json()})).then((n=>{if(!n.chain)return void alert("Chain not found.");const t=n.chain;document.getElementById("selected-chain-id").value=t._id,document.getElementById("selected-chain-name").textContent=t.chain_name,document.getElementById("update-chain-name").value=t.chain_name,document.getElementById("update-chain-type").value=t.business_type,document.getElementById("update-universal-incentives").checked=!0===t.universal_incentives,document.getElementById("chain-details").style.display="block",loadChainIncentivesFromEmbedded(t.incentives||[]),loadChainLocations(e),document.getElementById("chain-details").scrollIntoView({behavior:"smooth"})})).catch((e=>{console.error("Error loading chain details:",e),alert(`Error loading chain details: ${e.message}`)}))}function loadChainIncentivesFromEmbedded(e){const n=document.getElementById("chain-incentives");if(!n)return;if(!e||0===e.length)return void(n.innerHTML="<p>No incentives found for this chain.</p>");let t='<div class="list-group">';e.forEach((e=>{if(e.is_active){const n=getIncentiveTypeLabel(e.type),i=e.other_description?` (${e.other_description})`:"";t+=`\n                <div class="list-group-item d-flex justify-content-between align-items-center">\n                    <div>\n                        <strong>${n}${i}:</strong> ${e.amount}%\n                        <div><small>${e.information||""}</small></div>\n                    </div>\n                    <div>\n                        <button class="btn btn-sm btn-danger" onclick="deleteChainIncentive('${e._id}')">\n                            <i class="fas fa-trash"></i> Remove\n                        </button>\n                    </div>\n                </div>\n            `}})),t+="</div>",n.innerHTML=t}function loadChainIncentives(e){if(!e)return;const n=document.getElementById("chain-incentives");if(!n)return;n.innerHTML='<p class="text-center">Loading incentives...</p>';const t=getBaseURL();fetch(`${t}/api/combined-api.js?operation=incentives&business_id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to load incentives: ${e.status}`);return e.json()})).then((e=>{if(!e.results||0===e.results.length)return void(n.innerHTML="<p>No incentives found for this chain.</p>");let t='<div class="list-group">';e.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),i=e.other_description?` (${e.other_description})`:"";t+=`\n                        <div class="list-group-item d-flex justify-content-between align-items-center">\n                            <div>\n                                <strong>${n}${i}:</strong> ${e.amount}%\n                                <div><small>${e.information||""}</small></div>\n                            </div>\n                            <div>\n                                <button class="btn btn-sm btn-danger" onclick="deleteIncentive('${e._id}')">\n                                    <i class="fas fa-trash"></i> Remove\n                                </button>\n                            </div>\n                        </div>\n                    `}})),t+="</div>",n.innerHTML=t})).catch((e=>{console.error("Error loading incentives:",e),n.innerHTML=`\n                <div class="alert alert-danger" role="alert">\n                    Error loading incentives: ${e.message}\n                </div>\n            `}))}function updateChain(){const e=document.getElementById("selected-chain-id").value;if(!e)return void alert("No chain selected.");const n=document.getElementById("update-chain-name").value.trim(),t=document.getElementById("update-chain-type").value,i=document.getElementById("update-universal-incentives").checked;if(!n||!t)return void alert("Please fill in all required fields.");const o=getBaseURL(),a={_id:e,chain_name:n,business_type:t,universal_incentives:i};fetch(`${o}/api/chains.js?operation=update`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${getAuthToken()}`},body:JSON.stringify(a)}).then((e=>{if(!e.ok)throw new Error(`Failed to update chain: ${e.status}`);return e.json()})).then((e=>{alert("Chain updated successfully!"),document.getElementById("selected-chain-name").textContent=n,loadExistingChains()})).catch((e=>{console.error("Error updating chain:",e),alert(`Error updating chain: ${e.message}`)}))}function deleteChain(e){if(!e)return;const n=getBaseURL();fetch(`${n}/api/chains.js?operation=delete`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${getAuthToken()}`},body:JSON.stringify({_id:e})}).then((e=>{if(!e.ok)throw new Error(`Failed to delete chain: ${e.status}`);return e.json()})).then((e=>{alert("Chain deleted successfully!"),document.getElementById("chain-details").style.display="none",currentChainId=null,loadExistingChains()})).catch((e=>{console.error("Error deleting chain:",e),alert(`Error deleting chain: ${e.message}`)}))}function loadChainLocations(e){if(!e)return;const n=document.getElementById("chain-locations");if(!n)return;n.innerHTML='<p class="text-center">Loading locations...</p>';const t=getBaseURL();fetch(`${t}/api/chains.js?operation=get_locations&chain_id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to load locations: ${e.status}`);return e.json()})).then((e=>{if(!e.locations||0===e.locations.length)return void(n.innerHTML="<p>No locations found for this chain.</p>");let t="";e.locations.forEach((e=>{const n=e.address2?`${e.address1}, ${e.address2}, ${e.city}, ${e.state} ${e.zip}`:`${e.address1}, ${e.city}, ${e.state} ${e.zip}`;t+=`\n                    <div class="location-item d-flex justify-content-between align-items-center">\n                        <div>\n                            <strong>${e.bname}</strong>\n                            <div><small>${n}</small></div>\n                        </div>\n                        <div>\n                            <button class="btn btn-sm btn-danger" onclick="removeLocationFromChain('${e._id}')">\n                                <i class="fas fa-unlink"></i> Remove\n                            </button>\n                        </div>\n                    </div>\n                `})),n.innerHTML=t})).catch((e=>{console.error("Error loading locations:",e),n.innerHTML=`\n                <div class="alert alert-danger" role="alert">\n                    Error loading locations: ${e.message}\n                </div>\n            `}))}function addLocationToChain(e){if(!e)return;const n=currentChainId;if(!n)return void alert("No chain selected.");const t=getBaseURL();fetch(`${t}/api/chains.js?operation=add_location`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${getAuthToken()}`},body:JSON.stringify({business_id:e,chain_id:n})}).then((e=>{if(!e.ok)throw new Error(`Failed to add location to chain: ${e.status}`);return e.json()})).then((e=>{alert("Location added to chain successfully!"),ModalHelper.hide("add-location-modal"),loadChainLocations(n)})).catch((e=>{console.error("Error adding location to chain:",e),alert(`Error adding location to chain: ${e.message}`)}))}function removeLocationFromChain(e){if(!e)return;if(!confirm("Are you sure you want to remove this location from the chain?"))return;const n=getBaseURL();fetch(`${n}/api/chains.js?operation=remove_location`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${getAuthToken()}`},body:JSON.stringify({business_id:e})}).then((e=>{if(!e.ok)throw new Error(`Failed to remove location from chain: ${e.status}`);return e.json()})).then((e=>{alert("Location removed from chain successfully!"),loadChainLocations(currentChainId)})).catch((e=>{console.error("Error removing location from chain:",e),alert(`Error removing location from chain: ${e.message}`)}))}function confirmDeleteChain(){const e=document.getElementById("selected-chain-id").value;if(!e)return void alert("No chain selected.");const n=document.getElementById("selected-chain-name").textContent;confirm(`Are you sure you want to delete the chain "${n}"? This will remove all chain associations but will not delete individual locations.`)&&deleteChain(e)}function openAddLocationModal(){currentChainId?(document.getElementById("business-search-results").innerHTML='<p class="text-center">Search for a business to add as a location</p>',document.getElementById("search-business").value="",$("#add-location-modal").modal("show")):alert("No chain selected.")}function searchBusinesses(e){if(!e)return;const n=document.getElementById("business-search-results");if(!n)return;n.innerHTML='<p class="text-center">Searching...</p>';const t=getBaseURL();fetch(`${t}/api/business.js?operation=search&business_name=${encodeURIComponent(e)}`).then((e=>{if(!e.ok)throw new Error(`Failed to search businesses: ${e.status}`);return e.json()})).then((e=>{if(!e.results||0===e.results.length)return void(n.innerHTML='<p class="text-center">No businesses found matching your search.</p>');const t=e.results.filter((e=>!e.is_chain));if(0===t.length)return void(n.innerHTML='<p class="text-center">No eligible businesses found. Businesses that are already chains cannot be added as locations.</p>');let i='<div class="list-group">';t.forEach((e=>{const n=e.address2?`${e.address1}, ${e.address2}, ${e.city}, ${e.state} ${e.zip}`:`${e.address1}, ${e.city}, ${e.state} ${e.zip}`,t=!!e.chain_id;i+=`\n                    <div class="list-group-item d-flex justify-content-between align-items-center">\n                        <div>\n                            <strong>${e.bname}</strong>\n                            <div><small>${n}</small></div>\n                            ${t?'<span class="badge badge-warning">Already in another chain</span>':""}\n                        </div>\n                        <div>\n                            <button class="btn btn-sm btn-success" \n                                    onclick="addLocationToChain('${e._id}')"\n                                    ${t?"disabled":""}>\n                                Add to Chain\n                            </button>\n                        </div>\n                    </div>\n                `})),i+="</div>",n.innerHTML=i})).catch((e=>{console.error("Error searching businesses:",e),n.innerHTML=`\n                <div class="alert alert-danger" role="alert">\n                    Error searching businesses: ${e.message}\n                </div>\n            `}))}function openManageIncentivesModal(){currentChainId?(loadModalChainIncentives(currentChainId),document.getElementById("add-chain-incentive-form").reset(),document.getElementById("other-description-group").style.display="none",ModalHelper.show("manage-incentives-modal")):alert("No chain selected.")}function loadModalChainIncentives(e){if(!e)return;const n=document.getElementById("modal-chain-incentives");if(!n)return;n.innerHTML='<p class="text-center">Loading incentives...</p>';const t=getBaseURL();fetch(`${t}/api/chains.js?operation=get_incentives&chain_id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to load incentives: ${e.status}`);return e.json()})).then((e=>{if(!e.incentives||0===e.incentives.length)return void(n.innerHTML="<p>No incentives found for this chain.</p>");let t='<div class="list-group">';e.incentives.forEach((e=>{const n=getIncentiveTypeLabel(e.type),i=e.other_description?` (${e.other_description})`:"";t+=`\n                    <div class="list-group-item d-flex justify-content-between align-items-center">\n                        <div>\n                            <strong>${n}${i}:</strong> ${e.amount}%\n                            <div><small>${e.information||""}</small></div>\n                        </div>\n                        <div>\n                            <button class="btn btn-sm btn-danger" onclick="deleteChainIncentive('${e._id}', true)">\n                                <i class="fas fa-trash"></i> Remove\n                            </button>\n                        </div>\n                    </div>\n                `})),t+="</div>",n.innerHTML=t})).catch((e=>{console.error("Error loading incentives:",e),n.innerHTML=`\n                <div class="alert alert-danger" role="alert">\n                    Error loading incentives: ${e.message}\n                </div>\n            `}))}function addChainIncentive(e){(e=e||window.event)&&e.preventDefault();const n=currentChainId;if(!n)return void alert("No chain selected.");const t=document.getElementById("incentive-type").value,i=document.getElementById("other-description").value.trim(),o=document.getElementById("incentive-amount").value,a=document.getElementById("incentive-info").value.trim();if(!t||!o)return void alert("Please fill in all required fields.");if("OT"===t&&!i)return void alert('Please provide a description for the "Other" incentive type.');const s=getBaseURL(),r={chain_id:n,type:t,amount:o,information:a};"OT"===t&&(r.other_description=i),fetch(`${s}/api/chains.js?operation=add_incentive`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${getAuthToken()}`},body:JSON.stringify(r)}).then((e=>{if(!e.ok)throw new Error(`Failed to add incentive: ${e.status}`);return e.json()})).then((e=>{alert("Incentive added successfully!"),document.getElementById("add-chain-incentive-form").reset(),ModalHelper.hide("manage-incentives-modal"),viewChainDetails(n)})).catch((e=>{console.error("Error adding incentive:",e),alert(`Error adding incentive: ${e.message}`)}))}function deleteChainIncentive(e,n=!1){if(!e)return;if(!confirm("Are you sure you want to delete this incentive?"))return;const t=getBaseURL();fetch(`${t}/api/chains.js?operation=remove_incentive`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${getAuthToken()}`},body:JSON.stringify({chain_id:currentChainId,incentive_id:e})}).then((e=>{if(!e.ok)throw new Error(`Failed to delete incentive: ${e.status}`);return e.json()})).then((e=>{alert("Incentive deleted successfully!"),n&&loadModalChainIncentives(currentChainId),viewChainDetails(currentChainId)})).catch((e=>{console.error("Error deleting incentive:",e),alert(`Error deleting incentive: ${e.message}`)}))}function deleteIncentive(e,n=!1){if(!e)return;if(!confirm("Are you sure you want to delete this incentive?"))return;const t=getBaseURL();fetch(`${t}/api/combined-api.js?operation=incentives&id=${e}&operation=delete`,{method:"POST"}).then((e=>{if(!e.ok)throw new Error(`Failed to delete incentive: ${e.status}`);return e.json()})).then((e=>{alert("Incentive deleted successfully!"),n&&loadModalChainIncentives(currentChainId),loadChainIncentives(currentChainId)})).catch((e=>{console.error("Error deleting incentive:",e),alert(`Error deleting incentive: ${e.message}`)}))}function filterChains(e){document.querySelectorAll(".chain-item").forEach((n=>{n.getAttribute("data-chain-name").toLowerCase().includes(e.toLowerCase())?n.style.display="block":n.style.display="none"}))}function setupSearchFunctionality(){}function getBaseURL(){return"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin}function getBusinessTypeLabel(e){return{AUTO:"Automotive",BEAU:"Beauty",BOOK:"Bookstore",CLTH:"Clothing",CONV:"Convenience Store/Gas Station",DEPT:"Department Store",ELEC:"Electronics",ENTR:"Entertainment",FURN:"Furniture",FUEL:"Fuel Station/Truck Stop",GIFT:"Gift Shop",GROC:"Grocery",HARDW:"Hardware",HEAL:"Health",JEWL:"Jewelry",OTHER:"Other",RX:"Pharmacy",REST:"Restaurant",RETAIL:"Retail",SERV:"Service",SPEC:"Specialty",SPRT:"Sporting Goods",TECH:"Technology",TOYS:"Toys"}[e]||e}function getIncentiveTypeLabel(e){return{VT:"Veteran",AD:"Active Duty",FR:"First Responder",SP:"Spouse",OT:"Other"}[e]||e}function debounce(e,n){let t;return function(...i){const o=this;clearTimeout(t),t=setTimeout((()=>e.apply(o,i)),n)}}