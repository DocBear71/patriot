$((function(){console.log("Fixed terms modal implementation starting initialization"),window.showEmergencyButton=function(){console.log("Showing emergency button");let e=document.getElementById("emergencyResetBtn");e?e.style.display="block":(e=document.createElement("button"),e.id="emergencyResetBtn",e.innerHTML="Emergency Reset",e.style.position="fixed",e.style.bottom="10px",e.style.right="10px",e.style.zIndex="9999",e.style.backgroundColor="#dc3545",e.style.color="white",e.style.border="none",e.style.padding="8px 15px",e.style.borderRadius="4px",e.style.fontWeight="bold",e.style.cursor="pointer",e.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",e.addEventListener("click",(function(){console.log("Emergency reset button clicked"),"function"==typeof emergencyModalReset?emergencyModalReset():hideFixedModal(),this.style.display="none"})),document.body.appendChild(e))},window.emergencyModalReset=function(){console.log("Emergency modal reset called"),"function"==typeof hideFixedModal?hideFixedModal():($(".modal-backdrop").remove(),$("#termsUpdateModal").removeClass("show"),$("#termsUpdateModal").css("display","none"),$("body").removeClass("modal-open"),$("body").css("padding-right",""),$("body").css("overflow",""));const e=document.getElementById("emergencyResetBtn");return e&&(e.style.display="none"),!0},function e(){const o=document.getElementById("termsUpdateModal"),t=document.getElementById("termsSummary");if(!o||!t)return console.log("Terms modal not found yet, will retry in 300ms"),void setTimeout(e,300);console.log("Terms modal found in DOM, proceeding with initialization"),t.scrollHeight<=10&&(console.log("Terms summary has no height, forcing content"),function(){if($(t).css({"max-height":"300px",height:"300px","min-height":"300px","overflow-y":"scroll",display:"block",visibility:"visible"}),t.scrollHeight<=10||""===t.innerHTML.trim()){console.log("Forcing content into terms summary"),""===t.innerHTML.trim()&&(t.innerHTML='\n              <h4>Summary of Key Terms</h4>\n              <p><strong>Effective Date:</strong> May 14, 2025</p>\n              <h5>1. ACCEPTANCE OF TERMS</h5>\n              <p>By accessing or using Patriot Thanks, you agree to be bound by these Terms of Use.</p>\n              <h5>2. INTELLECTUAL PROPERTY RIGHTS</h5>\n              <p>All content is owned by Doc Bear Enterprises, LLC and protected by copyright and other laws.</p>\n              <h5>3. USER RESPONSIBILITIES</h5>\n              <p>Users are responsible for maintaining the confidentiality of their account information.</p>\n              <h5>4. DATA COLLECTION AND PRIVACY</h5>\n              <p>We collect certain personal information to provide our services.</p>\n              <h5>5. LIMITATION OF LIABILITY</h5>\n              <p>Patriot Thanks and its owners will not be liable for any indirect, incidental, special, or consequential damages.</p>\n              <div id="termsScrollTarget">\n                <p>Thank you for reviewing our Terms of Use summary. Please check the box below to indicate your acceptance.</p>\n              </div>\n            ');const e=t.closest(".modal-body");e&&$(e).css({"max-height":"70vh","overflow-y":"auto",display:"block",visibility:"visible"});const o=t.closest(".modal-content");o&&$(o).css({display:"block",visibility:"visible"});const n=t.closest(".modal-dialog");n&&$(n).css({display:"block",visibility:"visible",margin:"30px auto"}),setTimeout((function(){console.log("After forcing content - height:",t.clientHeight,"scroll height:",t.scrollHeight),t.scrollHeight<=10&&(console.error("Failed to force content dimensions - activating emergency mode"),showEmergencyButton(),console.log("Attempting to fetch terms content from terms.html"),$.get("terms.html",(function(e){const o=document.createElement("div");o.innerHTML=e;const n=o.querySelector(".terms-content")||o.querySelector("#terms-content")||o.querySelector("main");if(n){console.log("Found terms content in terms.html, extracting summary");let e="";const o=n.querySelectorAll("h2, h3, h4, h5");let s=0;o.forEach((function(o){if(s<5){let t=o.nextElementSibling;t&&"P"===t.tagName&&(e+=`<h5>${o.textContent}</h5>`,e+=`<p>${t.textContent.substring(0,100)}...</p>`,s++)}})),e?(t.innerHTML=`\n                <h4>Summary of Key Terms</h4>\n                <p><strong>Effective Date:</strong> May 14, 2025</p>\n                ${e}\n                <div id="termsScrollTarget">\n                  <p>Thank you for reviewing our Terms of Use summary. Please check the box below to indicate your acceptance.</p>\n                </div>\n              `,$(t).css({"max-height":"300px",height:"300px","min-height":"300px","overflow-y":"scroll",display:"block",visibility:"visible"}),console.log("Terms content inserted from terms.html"),setTimeout((function(){console.log("After terms insertion - height:",t.clientHeight,"scroll height:",t.scrollHeight)}),300)):console.error("Could not extract terms content from terms.html")}else console.error("Could not find terms content in terms.html")})).fail((function(){console.error("Failed to fetch terms.html")})))}),300)}}()),function(){let e=document.getElementById("termsSummary"),o=document.getElementById("acceptUpdatedTerms"),t=document.getElementById("confirmUpdatedTerms"),n=document.getElementById("rejectUpdatedTerms");function s(){console.log("Showing fixed terms modal"),function(){if(console.log("Setting up fixed scroll tracking"),!e||!o)return void console.error("Required elements not found for scroll tracking");let n=!1,s=Date.now();const i=5e3,l=document.getElementById("scrollMessage");$(e).off("scroll"),$(e).on("scroll",(function(){const t=e.scrollTop+e.clientHeight,r=e.scrollHeight,c=Date.now()-s,a=t/r*100;if(console.log(`Scroll position: ${t}/${r} (${a.toFixed(2)}%)`),a>=80&&c>=i)console.log("User has scrolled to near bottom of terms"),n=!0,o.disabled=!1,console.log("Terms checkbox enabled"),l&&(l.style.display="block",l.innerHTML='<i class="fa fa-check-circle"></i> Thank you for reviewing the terms. Please check the box below to confirm your acceptance.',l.style.color="green");else if(a>=80&&c<i){const e=Math.ceil((i-c)/1e3);l&&(l.style.display="block",l.innerHTML=`Please continue reviewing for ${e} more seconds.`,l.style.color="#f57c00")}else a>=50&&l&&(l.style.display="block",l.innerHTML="Continue scrolling to review all terms.",l.style.color="#2196F3")})),$(o).off("change"),$(o).on("change",(function(){if(!n&&this.checked)return alert("Please read the terms summary by scrolling to the bottom before accepting."),void(this.checked=!1);t&&(t.disabled=!this.checked,console.log("Terms confirm button "+(this.checked?"enabled":"disabled")))})),setTimeout((function(){e.scrollTop=1,$(e).trigger("scroll"),e.scrollHeight<=e.clientHeight&&(console.log("Terms content fits without scrolling - enabling checkbox"),o.disabled=!1,l&&(l.style.display="block",l.innerHTML='<i class="fa fa-check-circle"></i> Thank you for reviewing the terms. Please check the box below to confirm your acceptance.',l.style.color="green"),n=!0)}),800)}(),console.log("Setting up modal buttons"),t&&n?($(t).off("click"),$(n).off("click"),$(t).on("click",(function(e){e.preventDefault(),e.stopPropagation(),console.log("Confirm button clicked");const o=localStorage.getItem("patriotThanksSession");if(!o)return console.error("No session found"),void r();try{!function(e){console.log("Handling terms acceptance");const o=e.user._id;e.user.termsAccepted=!0,e.user.termsAcceptedDate=(new Date).toISOString(),e.user.termsVersion="May 14, 2025",localStorage.setItem("patriotThanksSession",JSON.stringify(e)),r();const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin;fetch(`${t}/api/auth.js?operation=update-terms-acceptance`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e.token},body:JSON.stringify({userId:o,termsAccepted:!0,termsAcceptedDate:(new Date).toISOString(),termsVersion:"May 14, 2025"})}).then((e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()})).then((e=>{console.log("Terms acceptance updated on server successfully")})).catch((e=>{console.error("Error updating terms on server:",e)}))}(JSON.parse(o))}catch(e){console.error("Error parsing session data:",e),r()}})),$(n).on("click",(function(e){e.preventDefault(),e.stopPropagation(),console.log("Reject button clicked"),confirm("If you do not accept the updated terms, you will be logged out and unable to use the service. Continue?")&&("function"==typeof logoutUser?logoutUser():(console.error("Logout function not available"),localStorage.removeItem("patriotThanksSession"),localStorage.removeItem("isLoggedIn")),r())})),$(".modal .close").off("click"),$(".modal .close").on("click",(function(e){e.preventDefault(),e.stopPropagation(),console.log("Close button clicked"),r()}))):console.error("Button elements not found");const s=$("#termsUpdateModal");try{s.modal({backdrop:"static",keyboard:!1,show:!0}),setTimeout((function(){s.is(":visible")&&s.hasClass("show")?(console.log("Modal is visible, checking container dimensions"),l()):(console.log("Bootstrap modal failed to show - using direct DOM manipulation"),i())}),300)}catch(e){console.error("Error showing Bootstrap modal:",e),i()}}function i(){console.log("Showing modal using direct DOM manipulation");const e=$("#termsUpdateModal"),o=$("body");0===$(".modal-backdrop").length&&o.append('<div class="modal-backdrop show" style="opacity: 0.5;"></div>'),e.addClass("show"),e.css("display","block"),e.attr("aria-hidden","false"),e.attr("aria-modal","true"),e.css("z-index","1050"),e.css("padding-right","17px"),o.addClass("modal-open"),o.css("padding-right","17px"),o.css("overflow","hidden"),setTimeout(l,300)}function l(){if(console.log("Checking modal dimensions"),!e)return void console.error("Terms summary element not available for dimension check");const o=e.clientHeight,t=e.scrollHeight;console.log("Terms summary height:",o),console.log("Terms summary scroll height:",t),(0===o||0===t||t<=10)&&(console.log("Invalid dimensions detected - applying fixes"),$(e).css({"max-height":"300px",height:"300px","min-height":"300px","overflow-y":"scroll",display:"block",visibility:"visible"}),$(".modal-content").css({display:"block",visibility:"visible"}),$(".modal-dialog").css({display:"block",visibility:"visible"}),setTimeout((function(){const o=e.clientHeight,t=e.scrollHeight;console.log("Updated terms summary height:",o),console.log("Updated terms summary scroll height:",t),(0===o||0===t||t<=10)&&(console.error("Dimension fix failed - showing emergency button"),showEmergencyButton())}),300))}function r(){console.log("Hiding fixed modal");try{$("#termsUpdateModal").modal("hide")}catch(e){console.error("Error hiding Bootstrap modal:",e)}try{$(".modal-backdrop").remove();const e=$("#termsUpdateModal");e.removeClass("show"),e.css("display","none"),e.attr("aria-hidden","true"),e.removeAttr("aria-modal"),$("body").removeClass("modal-open"),$("body").css("padding-right",""),$("body").css("overflow",""),console.log("Modal hidden successfully")}catch(e){console.error("Error in direct modal manipulation:",e)}}console.log("Modal elements initialized:","termsSummary:",!!e,"termsCheckbox:",!!o,"confirmButton:",!!t,"rejectButton:",!!n),window.originalCheckTermsVersion=window.checkTermsVersion,window.checkTermsVersion=function(e){if(console.log("Fixed terms version check called"),!e||!e.user)return;e.user.termsAccepted&&"May 14, 2025"===e.user.termsVersion||(console.log("User needs to accept new terms - using fixed implementation"),$(".modal-backdrop").remove(),$("body").removeClass("modal-open"),$("body").css("padding-right",""),s())},window.showFixedTermsModal=s,window.hideFixedModal=r}()}()}));