$((function(){function e(){return console.log("Initializing modal elements"),termsSummary=document.getElementById("termsSummary"),termsCheckbox=document.getElementById("acceptUpdatedTerms"),confirmButton=document.getElementById("confirmUpdatedTerms"),rejectButton=document.getElementById("rejectUpdatedTerms"),termsSummary&&termsCheckbox&&confirmButton&&rejectButton?(console.log("Modal elements initialized successfully"),!0):(console.error("Failed to initialize modal elements"),!1)}function o(){!function(){if(console.log("Setting up fixed scroll tracking"),!termsSummary||!termsCheckbox)return void console.error("Required elements not found for scroll tracking");let e=!1,o=Date.now();const t=5e3,n=document.getElementById("scrollMessage");$(termsSummary).off("scroll"),$(termsSummary).on("scroll",(function(){const s=termsSummary.scrollTop+termsSummary.clientHeight,r=termsSummary.scrollHeight,l=Date.now()-o,i=s/r*100;if(console.log(`Scroll position: ${s}/${r} (${i.toFixed(2)}%)`),i>=80&&l>=t)console.log("User has scrolled to near bottom of terms"),e=!0,termsCheckbox.disabled=!1,console.log("Terms checkbox enabled"),n&&(n.style.display="block",n.innerHTML='<i class="fa fa-check-circle"></i> Thank you for reviewing the terms. Please check the box below to confirm your acceptance.',n.style.color="green");else if(i>=80&&l<t){const e=Math.ceil((t-l)/1e3);n&&(n.style.display="block",n.innerHTML=`Please continue reviewing for ${e} more seconds.`,n.style.color="#f57c00")}else i>=50&&n&&(n.style.display="block",n.innerHTML="Continue scrolling to review all terms.",n.style.color="#2196F3")})),$(termsCheckbox).off("change"),$(termsCheckbox).on("change",(function(){if(!e&&this.checked)return alert("Please read the terms summary by scrolling to the bottom before accepting."),void(this.checked=!1);confirmButton&&(confirmButton.disabled=!this.checked,console.log("Terms confirm button "+(this.checked?"enabled":"disabled")))})),setTimeout((function(){$(termsSummary).trigger("scroll")}),500)}(),console.log("Setting up modal buttons"),confirmButton&&rejectButton?($(confirmButton).off("click"),$(rejectButton).off("click"),$(confirmButton).on("click",(function(e){e.preventDefault(),e.stopPropagation(),console.log("Confirm button clicked");const o=localStorage.getItem("patriotThanksSession");if(!o)return console.error("No session found"),void s();try{!function(e){console.log("Handling terms acceptance");const o=e.user._id;e.user.termsAccepted=!0,e.user.termsAcceptedDate=(new Date).toISOString(),e.user.termsVersion="May 14, 2025",localStorage.setItem("patriotThanksSession",JSON.stringify(e)),s();const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin;fetch(`${t}/api/auth.js?operation=update-terms-acceptance`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e.token},body:JSON.stringify({userId:o,termsAccepted:!0,termsAcceptedDate:(new Date).toISOString(),termsVersion:"May 14, 2025"})}).then((e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()})).then((e=>{console.log("Terms acceptance updated on server successfully")})).catch((e=>{console.error("Error updating terms on server:",e)}))}(JSON.parse(o))}catch(e){console.error("Error parsing session data:",e),s()}})),$(rejectButton).on("click",(function(e){e.preventDefault(),e.stopPropagation(),console.log("Reject button clicked"),confirm("If you do not accept the updated terms, you will be logged out and unable to use the service. Continue?")&&("function"==typeof logoutUser?logoutUser():(console.error("Logout function not available"),localStorage.removeItem("patriotThanksSession"),localStorage.removeItem("isLoggedIn")),s())})),$(".modal .close").off("click"),$(".modal .close").on("click",(function(e){e.preventDefault(),e.stopPropagation(),console.log("Close button clicked"),s()}))):console.error("Button elements not found");const e=$("#termsUpdateModal");try{e.modal({backdrop:"static",keyboard:!1,show:!0}),setTimeout((function(){e.is(":visible")&&e.hasClass("show")?(console.log("Modal is visible, checking container dimensions"),n()):(console.log("Bootstrap modal failed to show - using direct DOM manipulation"),t())}),300)}catch(e){console.error("Error showing Bootstrap modal:",e),t()}}function t(){console.log("Showing modal using direct DOM manipulation");const e=$("#termsUpdateModal"),o=$("body");0===$(".modal-backdrop").length&&o.append('<div class="modal-backdrop show" style="opacity: 0.5;"></div>'),e.addClass("show"),e.css("display","block"),e.attr("aria-hidden","false"),e.attr("aria-modal","true"),e.css("z-index","1050"),e.css("padding-right","17px"),o.addClass("modal-open"),o.css("padding-right","17px"),o.css("overflow","hidden"),setTimeout(n,300)}function n(){if(console.log("Checking modal dimensions"),!termsSummary)return void console.error("Terms summary element not available for dimension check");const e=termsSummary.clientHeight,o=termsSummary.scrollHeight;console.log("Terms summary height:",e),console.log("Terms summary scroll height:",o),0!==e&&0!==o||(console.log("Invalid dimensions detected - applying fixes"),$(termsSummary).css({"max-height":"300px",height:"300px","overflow-y":"scroll",display:"block",visibility:"visible"}),$(".modal-content").css({display:"block",visibility:"visible"}),$(".modal-dialog").css({display:"block",visibility:"visible"}),setTimeout((function(){const e=termsSummary.clientHeight,o=termsSummary.scrollHeight;console.log("Updated terms summary height:",e),console.log("Updated terms summary scroll height:",o),0!==e&&0!==o||(console.error("Dimension fix failed - showing emergency button"),showEmergencyButton())}),300))}function s(){console.log("Hiding fixed modal");try{$("#termsUpdateModal").modal("hide")}catch(e){console.error("Error hiding Bootstrap modal:",e)}try{$(".modal-backdrop").remove();const e=$("#termsUpdateModal");e.removeClass("show"),e.css("display","none"),e.attr("aria-hidden","true"),e.removeAttr("aria-modal"),$("body").removeClass("modal-open"),$("body").css("padding-right",""),$("body").css("overflow",""),console.log("Modal hidden successfully")}catch(e){console.error("Error in direct modal manipulation:",e)}}console.log("Fixed terms modal implementation starting initialization"),window.showEmergencyButton=function(){console.log("Showing emergency button");let e=document.getElementById("emergencyResetBtn");e?e.style.display="block":(e=document.createElement("button"),e.id="emergencyResetBtn",e.innerHTML="Emergency Reset",e.style.position="fixed",e.style.bottom="10px",e.style.right="10px",e.style.zIndex="9999",e.style.backgroundColor="#dc3545",e.style.color="white",e.style.border="none",e.style.padding="8px 15px",e.style.borderRadius="4px",e.style.fontWeight="bold",e.style.cursor="pointer",e.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",e.addEventListener("click",(function(){console.log("Emergency reset button clicked"),"function"==typeof emergencyModalReset?emergencyModalReset():s(),this.style.display="none"})),document.body.appendChild(e))},window.emergencyModalReset=function(){console.log("Emergency modal reset called"),s();const e=document.getElementById("emergencyResetBtn");return e&&(e.style.display="none"),!0},$(document).ready((function(){console.log("Fixed terms modal ready")})),function t(){const n=document.getElementById("termsUpdateModal"),s=document.getElementById("termsSummary");if(!n||!s)return console.log("Terms modal not found yet, will retry in 300ms"),void setTimeout(t,300);console.log("Terms modal found in DOM, proceeding with initialization"),function(){let t=document.getElementById("termsSummary"),n=document.getElementById("acceptUpdatedTerms"),s=document.getElementById("confirmUpdatedTerms"),r=document.getElementById("rejectUpdatedTerms");console.log("Modal elements initialized:","termsSummary:",!!t,"termsCheckbox:",!!n,"confirmButton:",!!s,"rejectButton:",!!r),window.originalCheckTermsVersion=window.checkTermsVersion,window.checkTermsVersion=function(t){if(console.log("Fixed terms version check called"),!t||!t.user)return;t.user.termsAccepted&&"May 14, 2025"===t.user.termsVersion||(console.log("User needs to accept new terms - using fixed implementation"),$(".modal-backdrop").remove(),$("body").removeClass("modal-open"),$("body").css("padding-right",""),function(){console.log("Showing fixed terms modal");if(document.getElementById("termsUpdateModal"))return e()?void o():(console.error("Modal element initialization failed"),void setTimeout((function(){e()?o():(console.error("Modal initialization failed after retry"),showEmergencyButton())}),500));console.error("Terms modal element not found")}())}}()}()}));