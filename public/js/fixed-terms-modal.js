$((function(){console.log("Bootstrap 5 Terms Modal script initialized"),function e(){const o=document.getElementById("termsUpdateModal"),t=document.getElementById("termsSummary");if(!o||!t)return console.log("Terms modal not found yet, will retry in 300ms"),void setTimeout(e,300);console.log("Terms modal found in DOM, proceeding with initialization"),function(){let e=document.getElementById("termsSummary"),o=document.getElementById("acceptUpdatedTerms"),t=document.getElementById("confirmUpdatedTerms"),n=document.getElementById("rejectUpdatedTerms"),i=document.getElementById("scrollMessage");console.log("Modal elements initialized:","termsSummary:",!!e,"termsCheckbox:",!!o,"confirmButton:",!!t,"rejectButton:",!!n),console.log("Replacing terms summary with custom implementation");const s=document.createElement("div");function r(){let s;console.log("Showing Bootstrap 5 modal"),function(){console.log("Setting up scroll tracking for Bootstrap 5");let n=!1,s=Date.now();const r=5e3;$(e).off("scroll"),e.addEventListener("scroll",(function(){const t=e.scrollTop+e.clientHeight,l=e.scrollHeight,a=Date.now()-s,c=t/l*100;if(console.log(`Scroll position: ${t}/${l} (${c.toFixed(2)}%)`),c>=80&&a>=r)console.log("User has scrolled to near bottom of terms"),n=!0,o.disabled=!1,console.log("Terms checkbox enabled"),i&&(i.style.display="block",i.innerHTML='<i class="fa fa-check-circle"></i> Thank you for reviewing the terms. Please check the box below to confirm your acceptance.',i.style.color="green");else if(c>=80&&a<r){const e=Math.ceil((r-a)/1e3);i&&(i.style.display="block",i.innerHTML=`Please continue reviewing for ${e} more seconds.`,i.style.color="#f57c00")}else c>=50&&i&&(i.style.display="block",i.innerHTML="Continue scrolling to review all terms.",i.style.color="#2196F3")})),o.addEventListener("change",(function(){if(!n&&this.checked)return alert("Please read the terms summary by scrolling to the bottom before accepting."),void(this.checked=!1);t.disabled=!this.checked,console.log("Terms confirm button "+(this.checked?"enabled":"disabled"))})),setTimeout((function(){e.scrollTop=1;const t=document.createEvent("Event");t.initEvent("scroll",!0,!0),e.dispatchEvent(t),e.scrollHeight<=e.clientHeight&&(console.log("Terms content fits without scrolling - enabling checkbox"),o.disabled=!1,i&&(i.style.display="block",i.innerHTML='<i class="fa fa-check-circle"></i> Thank you for reviewing the terms. Please check the box below to confirm your acceptance.',i.style.color="green"),n=!0)}),800)}(),function(){if(console.log("Setting up modal buttons (Bootstrap 5)"),!t||!n)return void console.error("Button elements not found");t.addEventListener("click",(function(e){e.preventDefault(),e.stopPropagation(),console.log("Confirm button clicked");const o=localStorage.getItem("patriotThanksSession");if(!o)return console.error("No session found"),void d();try{c(JSON.parse(o))}catch(e){console.error("Error parsing session data:",e),d()}})),n.addEventListener("click",(function(e){e.preventDefault(),e.stopPropagation(),console.log("Reject button clicked"),confirm("If you do not accept the updated terms, you will be logged out and unable to use the service. Continue?")&&("function"==typeof logoutUser?logoutUser():(console.error("Logout function not available"),localStorage.removeItem("patriotThanksSession"),localStorage.removeItem("isLoggedIn")),d())}));const e=document.querySelector("#termsUpdateModal .btn-close")||document.querySelector("#termsUpdateModal .close");e&&e.addEventListener("click",(function(e){e.preventDefault(),e.stopPropagation(),console.log("Close button clicked"),d()})),document.addEventListener("keydown",(function(e){"Escape"===e.key&&(console.log("Escape key pressed, attempting to close modal"),d())}))}();try{const e=document.getElementById("termsUpdateModal");s=new bootstrap.Modal(e,{backdrop:"static",keyboard:!1}),s.show(),setTimeout((function(){e.classList.contains("show")?(console.log("Modal is visible, checking container dimensions"),a()):(console.log("Bootstrap 5 modal failed to show - using direct DOM manipulation"),l())}),300)}catch(e){console.error("Error showing Bootstrap 5 modal:",e),l()}}function l(){console.log("Showing modal using direct DOM manipulation (Bootstrap 5 compatible)");const e=document.getElementById("termsUpdateModal");if(e.classList.add("show"),e.style.display="block",e.setAttribute("aria-modal","true"),e.removeAttribute("aria-hidden"),0===document.getElementsByClassName("modal-backdrop").length){const e=document.createElement("div");e.classList.add("modal-backdrop","fade","show"),document.body.appendChild(e)}document.body.classList.add("modal-open"),setTimeout(a,300)}function a(){console.log("Checking modal dimensions (Bootstrap 5)");const o=e.clientHeight,t=e.scrollHeight;if(console.log("Terms summary height:",o),console.log("Terms summary scroll height:",t),o<50||t<50){console.log("Invalid dimensions detected - applying additional fixes"),e.style.cssText="\n          max-height: 300px !important;\n          height: 300px !important;\n          min-height: 300px !important;\n          overflow-y: scroll !important;\n          display: block !important;\n          visibility: visible !important;\n          background-color: #f9f9f9 !important;\n          border: 1px solid #ddd !important;\n          padding: 15px !important;\n          margin: 10px 0 !important;\n        ";const o=document.querySelector(".modal-content");o&&(o.style.cssText="\n            display: block !important;\n            visibility: visible !important;\n          ");const t=document.querySelector(".modal-dialog");t&&(t.style.cssText="\n            display: block !important;\n            visibility: visible !important;\n          ")}}function c(e){console.log("Handling terms acceptance");const o=e.user._id;e.user.termsAccepted=!0,e.user.termsAcceptedDate=(new Date).toISOString(),e.user.termsVersion="May 14, 2025",localStorage.setItem("patriotThanksSession",JSON.stringify(e)),d();const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin;fetch(`${t}/api/auth.js?operation=update-terms-acceptance`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e.token},body:JSON.stringify({userId:o,termsAccepted:!0,termsAcceptedDate:(new Date).toISOString(),termsVersion:"May 14, 2025"})}).then((e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()})).then((e=>{console.log("Terms acceptance updated on server successfully")})).catch((e=>{console.error("Error updating terms on server:",e)}))}function d(){console.log("Hiding Bootstrap 5 modal");try{const e=document.getElementById("termsUpdateModal"),o=bootstrap.Modal.getInstance(e);o?o.hide():$(e).modal("hide")}catch(e){console.error("Error hiding Bootstrap 5 modal:",e);try{const e=document.getElementById("termsUpdateModal");e.classList.remove("show"),e.style.display="none",e.setAttribute("aria-hidden","true"),e.removeAttribute("aria-modal");const o=document.querySelector(".modal-backdrop");o&&o.parentNode.removeChild(o),document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.paddingRight="",console.log("Modal hidden using direct DOM manipulation")}catch(e){console.error("Failed to hide modal via DOM manipulation:",e)}}}s.id="forced-terms-summary",s.setAttribute("style","max-height: 300px !important; height: 300px !important; min-height: 300px !important; overflow-y: scroll !important; display: block !important; visibility: visible !important; background-color: #f9f9f9 !important; border: 1px solid #ddd !important; padding: 15px !important; margin: 10px 0 !important;"),s.innerHTML='\n      <h4 style="color: #333; margin-bottom: 15px;">Summary of Key Terms</h4>\n      <p><strong>Effective Date:</strong> May 14, 2025</p>\n      \n      <h5 style="color: #555; margin-top: 15px; font-weight: bold;">1. ACCEPTANCE OF TERMS</h5>\n      <p style="margin-bottom: 12px;">By accessing or using Patriot Thanks, you agree to be bound by these Terms of Use. If you do not agree to these terms, you must discontinue use immediately.</p>\n      \n      <h5 style="color: #555; margin-top: 15px; font-weight: bold;">2. INTELLECTUAL PROPERTY RIGHTS</h5>\n      <p style="margin-bottom: 12px;">All content, features, and functionality on Patriot Thanks are owned by Doc Bear Enterprises, LLC and are protected by copyright, trademark, and other intellectual property laws.</p>\n      \n      <h5 style="color: #555; margin-top: 15px; font-weight: bold;">3. USER RESPONSIBILITIES</h5>\n      <p style="margin-bottom: 12px;">Users are responsible for maintaining the confidentiality of their account information and for all activities that occur under their account. Users must not engage in any prohibited activities as outlined in the full Terms of Use.</p>\n      \n      <h5 style="color: #555; margin-top: 15px; font-weight: bold;">4. DATA COLLECTION AND PRIVACY</h5>\n      <p style="margin-bottom: 12px;">We collect certain personal information to provide our services. Your use of Patriot Thanks is also governed by our Privacy Policy, which describes how we collect, use, and protect your personal information.</p>\n      \n      <h5 style="color: #555; margin-top: 15px; font-weight: bold;">5. LIMITATION OF LIABILITY</h5>\n      <p style="margin-bottom: 12px;">Patriot Thanks and its owners will not be liable for any indirect, incidental, special, consequential, or punitive damages resulting from your use of the service.</p>\n      \n      <div id="termsScrollTarget" style="padding-top: 15px; margin-top: 15px; border-top: 1px dashed #ddd; text-align: center; font-weight: bold;">\n        <p>Thank you for reviewing our Terms of Use summary. Please check the box below to indicate your acceptance.</p>\n      </div>\n    ',e.parentNode.replaceChild(s,e),e=s,window.originalCheckTermsVersion=window.checkTermsVersion,window.checkTermsVersion=function(e){if(console.log("Bootstrap 5 terms version check called"),!e||!e.user)return;e.user.termsAccepted&&"May 14, 2025"===e.user.termsVersion||(console.log("User needs to accept new terms - using Bootstrap 5 implementation"),$(".modal-backdrop").remove(),$("body").removeClass("modal-open"),$("body").css("padding-right",""),r())},window.showBootstrap5Modal=r,window.hideModal=d,window.handleTermsAcceptance=c,window.showEmergencyButton=function(){console.log("Showing emergency button");let e=document.getElementById("emergencyResetBtn");e?e.style.display="block":(e=document.createElement("button"),e.id="emergencyResetBtn",e.innerHTML="Emergency Reset",e.style.position="fixed",e.style.bottom="10px",e.style.right="10px",e.style.zIndex="9999",e.style.backgroundColor="#dc3545",e.style.color="white",e.style.border="none",e.style.padding="8px 15px",e.style.borderRadius="4px",e.style.fontWeight="bold",e.style.cursor="pointer",e.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",e.addEventListener("click",(function(){console.log("Emergency reset button clicked"),d(),this.style.display="none"})),document.body.appendChild(e))},window.emergencyModalReset=function(){console.log("Emergency modal reset called"),d();const e=document.getElementById("emergencyResetBtn");return e&&(e.style.display="none"),!0},"function"==typeof checkLoginStatus&&setTimeout(checkLoginStatus,500)}()}()}));