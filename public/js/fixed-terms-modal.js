$((function(){console.log("Initializing fixed terms modal implementation");let e=null,o=null,t=null,n=null;function s(){return console.log("Initializing modal elements"),e=document.getElementById("termsSummary"),o=document.getElementById("acceptUpdatedTerms"),t=document.getElementById("confirmUpdatedTerms"),n=document.getElementById("rejectUpdatedTerms"),e&&o&&t&&n?(console.log("Modal elements initialized successfully"),!0):(console.error("Failed to initialize modal elements"),!1)}function l(){!function(){if(console.log("Setting up fixed scroll tracking"),!e||!o)return void console.error("Required elements not found for scroll tracking");let n=!1,s=Date.now();const l=5e3,i=document.getElementById("scrollMessage");$(e).off("scroll"),$(e).on("scroll",(function(){const t=e.scrollTop+e.clientHeight,r=e.scrollHeight,c=Date.now()-s,a=t/r*100;if(console.log(`Scroll position: ${t}/${r} (${a.toFixed(2)}%)`),a>=80&&c>=l)console.log("User has scrolled to near bottom of terms"),n=!0,o.disabled=!1,console.log("Terms checkbox enabled"),i&&(i.style.display="block",i.innerHTML='<i class="fa fa-check-circle"></i> Thank you for reviewing the terms. Please check the box below to confirm your acceptance.',i.style.color="green");else if(a>=80&&c<l){const e=Math.ceil((l-c)/1e3);i&&(i.style.display="block",i.innerHTML=`Please continue reviewing for ${e} more seconds.`,i.style.color="#f57c00")}else a>=50&&i&&(i.style.display="block",i.innerHTML="Continue scrolling to review all terms.",i.style.color="#2196F3")})),$(o).off("change"),$(o).on("change",(function(){if(!n&&this.checked)return alert("Please read the terms summary by scrolling to the bottom before accepting."),void(this.checked=!1);t&&(t.disabled=!this.checked,console.log("Terms confirm button "+(this.checked?"enabled":"disabled")))})),setTimeout((function(){$(e).trigger("scroll")}),500)}(),console.log("Setting up modal buttons"),t&&n?($(t).off("click"),$(n).off("click"),$(t).on("click",(function(e){e.preventDefault(),e.stopPropagation(),console.log("Confirm button clicked");const o=localStorage.getItem("patriotThanksSession");if(!o)return console.error("No session found"),void c();try{!function(e){console.log("Handling terms acceptance");const o=e.user._id;e.user.termsAccepted=!0,e.user.termsAcceptedDate=(new Date).toISOString(),e.user.termsVersion="May 14, 2025",localStorage.setItem("patriotThanksSession",JSON.stringify(e)),c();const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin;fetch(`${t}/api/auth.js?operation=update-terms-acceptance`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e.token},body:JSON.stringify({userId:o,termsAccepted:!0,termsAcceptedDate:(new Date).toISOString(),termsVersion:"May 14, 2025"})}).then((e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()})).then((e=>{console.log("Terms acceptance updated on server successfully")})).catch((e=>{console.error("Error updating terms on server:",e)}))}(JSON.parse(o))}catch(e){console.error("Error parsing session data:",e),c()}})),$(n).on("click",(function(e){e.preventDefault(),e.stopPropagation(),console.log("Reject button clicked"),confirm("If you do not accept the updated terms, you will be logged out and unable to use the service. Continue?")&&("function"==typeof logoutUser?logoutUser():(console.error("Logout function not available"),localStorage.removeItem("patriotThanksSession"),localStorage.removeItem("isLoggedIn")),c())})),$(".modal .close").off("click"),$(".modal .close").on("click",(function(e){e.preventDefault(),e.stopPropagation(),console.log("Close button clicked"),c()}))):console.error("Button elements not found");const s=$("#termsUpdateModal");try{s.modal({backdrop:"static",keyboard:!1,show:!0}),setTimeout((function(){s.is(":visible")&&s.hasClass("show")?(console.log("Modal is visible, checking container dimensions"),r()):(console.log("Bootstrap modal failed to show - using direct DOM manipulation"),i())}),300)}catch(e){console.error("Error showing Bootstrap modal:",e),i()}}function i(){console.log("Showing modal using direct DOM manipulation");const e=$("#termsUpdateModal"),o=$("body");0===$(".modal-backdrop").length&&o.append('<div class="modal-backdrop show" style="opacity: 0.5;"></div>'),e.addClass("show"),e.css("display","block"),e.attr("aria-hidden","false"),e.attr("aria-modal","true"),e.css("z-index","1050"),e.css("padding-right","17px"),o.addClass("modal-open"),o.css("padding-right","17px"),o.css("overflow","hidden"),setTimeout(r,300)}function r(){if(console.log("Checking modal dimensions"),!e)return void console.error("Terms summary element not available for dimension check");const o=e.clientHeight,t=e.scrollHeight;console.log("Terms summary height:",o),console.log("Terms summary scroll height:",t),0!==o&&0!==t||(console.log("Invalid dimensions detected - applying fixes"),$(e).css({"max-height":"300px",height:"300px","overflow-y":"scroll",display:"block",visibility:"visible"}),$(".modal-content").css({display:"block",visibility:"visible"}),$(".modal-dialog").css({display:"block",visibility:"visible"}),setTimeout((function(){const o=e.clientHeight,t=e.scrollHeight;console.log("Updated terms summary height:",o),console.log("Updated terms summary scroll height:",t),0!==o&&0!==t||(console.error("Dimension fix failed - showing emergency button"),showEmergencyButton())}),300))}function c(){console.log("Hiding fixed modal");try{$("#termsUpdateModal").modal("hide")}catch(e){console.error("Error hiding Bootstrap modal:",e)}try{$(".modal-backdrop").remove();const e=$("#termsUpdateModal");e.removeClass("show"),e.css("display","none"),e.attr("aria-hidden","true"),e.removeAttr("aria-modal"),$("body").removeClass("modal-open"),$("body").css("padding-right",""),$("body").css("overflow",""),console.log("Modal hidden successfully")}catch(e){console.error("Error in direct modal manipulation:",e)}}window.originalCheckTermsVersion=window.checkTermsVersion,window.checkTermsVersion=function(e){console.log("Fixed terms version check called"),e&&e.user&&(e.user.termsAccepted&&"May 14, 2025"===e.user.termsVersion||(console.log("User needs to accept new terms - using fixed implementation"),$(".modal-backdrop").remove(),$("body").removeClass("modal-open"),$("body").css("padding-right",""),function(){if(console.log("Showing fixed terms modal"),document.getElementById("termsUpdateModal"))return s()?void l():(console.error("Modal element initialization failed"),void setTimeout((function(){s()?l():(console.error("Modal initialization failed after retry"),showEmergencyButton())}),500));console.error("Terms modal element not found")}()))},window.showEmergencyButton=function(){console.log("Showing emergency button");let e=document.getElementById("emergencyResetBtn");e?e.style.display="block":(e=document.createElement("button"),e.id="emergencyResetBtn",e.innerHTML="Emergency Reset",e.style.position="fixed",e.style.bottom="10px",e.style.right="10px",e.style.zIndex="9999",e.style.backgroundColor="#dc3545",e.style.color="white",e.style.border="none",e.style.padding="8px 15px",e.style.borderRadius="4px",e.style.fontWeight="bold",e.style.cursor="pointer",e.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",e.addEventListener("click",(function(){console.log("Emergency reset button clicked"),"function"==typeof emergencyModalReset?emergencyModalReset():c(),this.style.display="none"})),document.body.appendChild(e))},window.emergencyModalReset=function(){console.log("Emergency modal reset called"),c();const e=document.getElementById("emergencyResetBtn");return e&&(e.style.display="none"),!0},$(document).ready((function(){console.log("Fixed terms modal ready")}))}));