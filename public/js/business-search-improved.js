const CONFIG={mapId:"ebe8ec43a7bc252d",defaultCenter:{lat:39.8283,lng:-98.5795},defaultZoom:4,markerColors:{primary:"#EA4335",nearby:"#4285F4"},geocodeDelay:200,imageLoadDelay:1e3,maxNearbyDistance:2e4,debugMode:!1};let map=null,mapInitialized=!1,markers=[],infoWindow=null,bounds=null,pendingBusinessesToDisplay=[],currentSearchLocation=null;const placeCache=new Map;function clearMarkers(){markers?(markers.forEach((n=>{n&&(n.map=null)})),markers=[]):markers=[]}function debugMapState(){if(console.log("==== MAP DEBUGGING INFO ===="),console.log("Map initialized:",mapInitialized),console.log("Map object exists:",!!map),map)try{const n=map.getCenter();console.log("Map center:",n?`${n.lat()}, ${n.lng()}`:"undefined"),console.log("Map zoom:",map.getZoom()),console.log("Map type:",map.getMapTypeId()),console.log("Map ID:",map.getMapId())}catch(n){console.error("Error getting map properties:",n)}if(console.log("Markers count:",markers?markers.length:0),markers&&markers.length>0&&(console.log("Markers summary:"),markers.forEach(((n,e)=>{try{let o;n.getPosition?o=n.getPosition():n.position&&(o=n.position);const t=o?"function"==typeof o.lat?`${o.lat()}, ${o.lng()}`:`${o.lat}, ${o.lng}`:"unknown";console.log(`  Marker #${e}: Business: ${n.business?n.business.bname:"unknown"}, Position: ${t}`)}catch(n){console.error(`  Error getting marker #${e} info:`,n)}}))),console.log("Bounds:",bounds?"exists":"not created"),bounds)try{const n=bounds.getNorthEast(),e=bounds.getSouthWest();if(console.log("  NE:",n?`${n.lat()}, ${n.lng()}`:"undefined"),console.log("  SW:",e?`${e.lat()}, ${e.lng()}`:"undefined"),console.log("  Empty:",bounds.isEmpty()),n&&e){const o=isNaN(n.lat())||isNaN(n.lng())||isNaN(e.lat())||isNaN(e.lng());console.log("  Has NaN coordinates:",o)}}catch(n){console.error("  Error getting bounds info:",n)}console.log("Map container:",document.getElementById("map")?"found":"not found");const n=document.getElementById("map");n&&(console.log("  Display:",window.getComputedStyle(n).display),console.log("  Dimensions:",`${n.offsetWidth} Ã— ${n.offsetHeight}`),console.log("  Position:",n.style.position),console.log("  Visibility:",window.getComputedStyle(n).visibility),console.log("  Z-index:",window.getComputedStyle(n).zIndex)),console.log("Google Maps libraries:"),console.log("  maps:",!!google.maps),console.log("  places:",!!google.maps.places),console.log("  geometry:",!!google.maps.geometry),console.log("  marker:",!!google.maps.marker),console.log("Google Maps API Key:",getGoogleMapsApiKey()?"found":"not found"),console.log("Current search location:",currentSearchLocation?`${currentSearchLocation.lat}, ${currentSearchLocation.lng}`:"none"),console.log("==== END DEBUGGING INFO ====")}function isValidPosition(n){if(!n)return console.warn("Position is null or undefined"),!1;let e,o;if(n instanceof google.maps.LatLng)try{e=n.lat(),o=n.lng()}catch(n){return console.warn("Error getting lat/lng from LatLng:",n),!1}else if("function"==typeof n.lat&&"function"==typeof n.lng)try{e=n.lat(),o=n.lng()}catch(n){return console.warn("Error calling lat/lng functions:",n),!1}else{if(void 0===n.lat||void 0===n.lng)return console.warn("Position does not have lat/lng properties"),!1;e=parseFloat(n.lat),o=parseFloat(n.lng)}return isNaN(e)||isNaN(o)?(console.warn("Position has NaN coordinates:",e,o),!1):isFinite(e)&&isFinite(o)?!(Math.abs(e)>90||Math.abs(o)>180)||(console.warn("Position coordinates out of range:",e,o),!1):(console.warn("Position has non-finite coordinates:",e,o),!1)}function createSafeLatLng(n){if(!n)return null;try{if(n instanceof google.maps.LatLng)return isValidPosition(n)?n:null;let e,o;if("function"==typeof n.lat&&"function"==typeof n.lng)e=n.lat(),o=n.lng();else if(void 0!==n.lat&&void 0!==n.lng)e=parseFloat(n.lat),o=parseFloat(n.lng);else if(void 0!==n.latitude&&void 0!==n.longitude)e=parseFloat(n.latitude),o=parseFloat(n.longitude);else{if(!(Array.isArray(n)&&n.length>=2))return console.warn("Position format not recognized:",n),null;e=parseFloat(n[0]),o=parseFloat(n[1])}return isNaN(e)||isNaN(o)||!isFinite(e)||!isFinite(o)?(console.warn("Invalid coordinates:",e,o),null):Math.abs(e)>90||Math.abs(o)>180?(console.warn("Coordinates out of range:",e,o),null):new google.maps.LatLng(e,o)}catch(n){return console.error("Error creating LatLng:",n),null}}function safelySetCenter(n,e,o){if(!n)return!1;try{const t=createSafeLatLng(e);return!!t&&(n.setCenter(t),void 0!==o&&n.setZoom(o),!0)}catch(n){return console.error("Error setting map center:",n),!1}}function safelyFitBounds(n,e,o=11){if(!n||!e)return!1;try{const o=e.getNorthEast(),t=e.getSouthWest();return!o||!t||isNaN(o.lat())||isNaN(o.lng())||isNaN(t.lat())||isNaN(t.lng())?(console.warn("Invalid bounds for fitBounds:",e),!1):e.isEmpty()?(console.warn("Empty bounds, not fitting"),!1):(n.fitBounds(e),google.maps.event.addListenerOnce(n,"bounds_changed",(function(){const e=n.getZoom();e>16?n.setZoom(16):e<4&&n.setZoom(4)})),!0)}catch(e){console.error("Error fitting bounds:",e);try{void 0!==o&&n.setZoom(o)}catch(n){console.error("Error setting fallback zoom:",n)}return!1}}function createNewBounds(){return new google.maps.LatLngBounds}let googleMapsInitializing=!1,googleMapsInitialized=!1;function ensureGoogleMapsInitialized(){return googleMapsInitialized||googleMapsInitializing?(console.log("Google Maps already initialized or initializing"),Promise.resolve()):new Promise(((n,e)=>{try{if(googleMapsInitializing=!0,console.log("Starting Google Maps initialization"),window.google&&window.google.maps)return console.log("Google Maps API is already loaded, just initializing map"),initGoogleMap(),googleMapsInitialized=!0,googleMapsInitializing=!1,void n();const o=window.appConfig?.googleMapsApiKey||getGoogleMapsApiKey(),t=window.appConfig?.googleMapsMapId||CONFIG.mapId;window.initGoogleMapCallback=function(){console.log("Google Maps callback executed"),initGoogleMap(),googleMapsInitialized=!0,googleMapsInitializing=!1,n()};const i=document.createElement("script");i.src=`https://maps.googleapis.com/maps/api/js?key=${o}&map_ids=${t}&libraries=places,geometry,marker&callback=initGoogleMapCallback&loading=async&v=weekly`,i.async=!0,i.defer=!0,i.onerror=function(n){console.error("Google Maps API failed to load:",n),googleMapsInitializing=!1,e(n)},document.head.appendChild(i)}catch(n){googleMapsInitializing=!1,console.error("Error initializing Google Maps:",n),e(n)}}))}function addCustomMarkerStyles(){if(!document.getElementById("custom-marker-css")){const n=document.createElement("style");n.id="custom-marker-css",n.textContent='\n            .custom-marker {\n                cursor: pointer;\n            }\n            \n            .marker-container {\n                position: relative;\n                width: 32px;\n                height: 40px;\n            }\n            \n            .marker-pin {\n                width: 32px;\n                height: 40px;\n                border-radius: 50% 50% 50% 0;\n                background-color: #EA4335;\n                transform: rotate(-45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n                position: absolute;\n                top: 0;\n                left: 0;\n            }\n            \n            .marker-pin.nearby {\n                background-color: #4285F4;\n            }\n            \n            .marker-icon {\n                transform: rotate(45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                width: 20px;\n                height: 20px;\n            }\n            \n            /* Critical fix - ensure Font Awesome icons are visible */\n            .marker-icon i.fas,\n            .marker-icon i.fa,\n            .marker-icon i.far,\n            .marker-icon i.fab {\n                display: inline-block !important;\n                font-size: 14px !important;\n                color: white !important;\n                line-height: 1 !important;\n                width: auto !important;\n                height: auto !important;\n                vertical-align: middle !important;\n            }\n            \n            /* Fallback icon content for missing Font Awesome */\n            .marker-icon i.fas.fa-store-alt:after {\n                content: "ðŸª";\n                font-family: sans-serif;\n                font-size: 14px;\n            }\n            \n            .marker-icon i.fas.fa-shopping-cart:after {\n                content: "ðŸ›’";\n                font-family: sans-serif;\n                font-size: 14px;\n            }\n            \n            .marker-shadow {\n                background-color: rgba(0, 0, 0, 0.2);\n                border-radius: 50%;\n                height: 14px;\n                width: 14px;\n                position: absolute;\n                bottom: -3px;\n                left: 9px;\n                filter: blur(2px);\n                z-index: -1;\n            }\n            \n            /* Info window action button styling */\n            .info-window-actions {\n                margin-top: 12px;\n                padding-top: 8px;\n                border-top: 1px solid #eee;\n                text-align: right;\n            }\n            \n            .info-window-actions .add-business-btn,\n            .info-window-actions .view-details-btn {\n                margin-top: 8px;\n                font-weight: bold;\n                text-transform: uppercase;\n                font-size: 12px;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                transition: background-color 0.2s ease;\n                border: none;\n                color: white;\n                letter-spacing: 0.5px;\n                display: inline-block;\n            }\n            \n            .info-window-actions .add-business-btn {\n                background-color: #EA4335;\n            }\n            \n            .info-window-actions .add-business-btn:hover {\n                background-color: #D32F2F;\n            }\n            \n            .info-window-actions .view-details-btn {\n                background-color: #4285F4;\n            }\n            \n            .info-window-actions .view-details-btn:hover {\n                background-color: #2A75F3;\n            }\n        ',document.head.appendChild(n)}}function addChainBadgeStyles(){if(!document.getElementById("chain-badge-css")){const n=document.createElement("style");n.id="chain-badge-css",n.textContent="\n            .chain-badge {\n                display: inline-block;\n                background-color: #4285F4;\n                color: white;\n                padding: 2px 6px;\n                border-radius: 4px;\n                font-size: 0.8em;\n                margin-left: 5px;\n                font-weight: normal;\n            }\n\n            .chain-badge.small {\n                font-size: 0.7em;\n                padding: 1px 4px;\n            }\n            \n            .admin-action-btn {\n                background-color: #673AB7;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .view-chain-btn {\n                background-color: #2196F3;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .add-to-db-btn {\n                background-color: #4CAF50;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .view-map-btn {\n                background-color: #FF9800;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n        ",document.head.appendChild(n)}}function getUserLocation(){return new Promise(((n,e)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition((e=>{const o={lat:e.coords.latitude,lng:e.coords.longitude};console.log("Got user location:",o),n(o)}),(n=>{console.warn("Error getting location:",n),e(n)}),{enableHighAccuracy:!0,timeout:5e3,maximumAge:0}):(console.warn("Geolocation not supported by this browser"),e(new Error("Geolocation not supported")))}))}async function getChainDetails(n){if(!n)return null;const e=getBaseURL();try{const o=await fetch(`${e}/api/business.js?operation=get&id=${n}`);if(!o.ok)throw new Error(`Failed to get chain details: ${o.status}`);const t=await o.json();return t.result?t.result:null}catch(n){return console.error("Error getting chain details:",n),null}}function getAddressComponent(n,e){if(!n||!Array.isArray(n))return"";const o=n.find((n=>n.types&&n.types.includes(e)));return o&&(o.shortText||o.short_name)||""}function getAddressComponentFromPlace(n,e){if(!n.addressComponents)return"";const o=n.addressComponents.find((n=>n.types.includes(e)));return o?o.shortText:""}function getBusinessTypeLabel(n){return{AUTO:"Automotive",BEAU:"Beauty",BOOK:"Bookstore",CLTH:"Clothing",CONV:"Convenience Store/Gas Station",DEPT:"Department Store",ELEC:"Electronics",ENTR:"Entertainment",FURN:"Furniture",FUEL:"Fuel Station/Truck Stop",GIFT:"Gift Shop",GROC:"Grocery",HARDW:"Hardware",HEAL:"Health",JEWL:"Jewelry",OTHER:"Other",RX:"Pharmacy",REST:"Restaurant",RETAIL:"Retail",SERV:"Service",SPEC:"Specialty",SPRT:"Sporting Goods",TECH:"Technology",TOYS:"Toys"}[n]||n}function getIncentiveTypeLabel(n){return{VT:"Veteran",AD:"Active Duty",FR:"First Responder",SP:"Spouse",OT:"Other"}[n]||n}function getBaseURL(){return"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:window.location.origin}function initBusinessSearch(){console.log("Business search initialization...");const n={businessName:document.getElementById("business-name"),address:document.getElementById("address"),useMyLocation:document.getElementById("use-my-location")},e=document.getElementById("business-search-form");e?e.addEventListener("submit",(function(e){if(e.preventDefault(),!n.businessName?.value&&!n.address?.value&&!n.useMyLocation?.checked)return void alert("Please enter either a business name, an address, or use your current location to search");const o={businessName:n.businessName?.value||"",address:n.address?.value||"",useMyLocation:n.useMyLocation?.checked||!1};if(console.log("Form data to submit:",o),mapInitialized){clearMarkers();const n=document.getElementById("initial-map-message");n&&n.remove(),retrieveFromMongoDB(o)}else console.warn("Map not initialized yet. Will initialize and display businesses after map loads."),ensureGoogleMapsInitialized().then((()=>{clearMarkers(),retrieveFromMongoDB(o)})).catch((n=>{console.error("Failed to initialize Google Maps:",n),alert("There was a problem loading the map. Please try refreshing the page.")}))})):console.warn("Business search form not found in the DOM"),n.businessName&&n.businessName.addEventListener("input",(function(){validateField(this,isNotEmpty)})),n.address&&n.address.addEventListener("input",(function(){validateField(this,isNotEmpty)})),n.useMyLocation&&n.useMyLocation.addEventListener("change",(function(){const e=document.getElementById("location-status");this.checked?(n.address&&(n.address.disabled=!0,n.address.placeholder="Using your current location..."),e&&(e.textContent="Location will be used when you search",e.style.display="block",e.style.color="#666")):(n.address&&(n.address.disabled=!1,n.address.placeholder="Address, City, State, or Zip"),e&&(e.style.display="none"))})),addRefreshButton(),checkForNewlyAddedBusiness()}function addRefreshButton(){const n=document.getElementById("business-search-form");if(!n)return;if(document.getElementById("refresh-search-btn"))return;const e=document.createElement("button");e.id="refresh-search-btn",e.type="button",e.className="refresh-btn",e.innerHTML='<i class="fas fa-sync-alt"></i> Refresh Results',e.style.marginLeft="10px",e.style.backgroundColor="#28a745",e.style.color="white",e.style.border="none",e.style.borderRadius="4px",e.style.padding="8px 12px",e.style.cursor="pointer",e.addEventListener("click",(function(){const n={businessName:document.getElementById("business-name")?.value||"",address:document.getElementById("address")?.value||"",useMyLocation:document.getElementById("use-my-location")?.checked||!1};clearMarkers();const e=document.getElementById("initial-map-message");e&&e.remove(),this.innerHTML='<i class="fas fa-sync-alt fa-spin"></i> Refreshing...',retrieveFromMongoDB(n,!0),setTimeout((()=>{this.innerHTML='<i class="fas fa-sync-alt"></i> Refresh Results'}),1e3)}));const o=n.querySelector('input[type="submit"]');o&&o.parentNode?o.parentNode.insertBefore(e,o.nextSibling):n.appendChild(e)}function checkForNewlyAddedBusiness(){const n=new URLSearchParams(window.location.search),e=n.get("business_added"),o=n.get("business_name");if("true"===e&&o){showNewBusinessAlert(o);const n=document.getElementById("business-name");n&&(n.value=o,validateField(n,isNotEmpty)),setTimeout((()=>{const n=document.getElementById("business-search-form");if(n){const e=new Event("submit",{cancelable:!0});n.dispatchEvent(e)}}),500)}}function showNewBusinessAlert(n){const e=document.createElement("div");e.className="alert alert-success",e.role="alert",e.style.marginBottom="20px",e.style.animation="fadeIn 0.5s",e.innerHTML=`\n        <strong>Success!</strong> "${n}" has been added to the database. \n        Searching for this business now...\n        <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n            <span aria-hidden="true">&times;</span>\n        </button>\n    `,e.style.backgroundColor="#d4edda",e.style.border="1px solid #c3e6cb",e.style.color="#155724",e.style.borderRadius="4px",e.style.padding="12px 20px";const o=e.querySelector(".close");o&&(o.style.float="right",o.style.fontSize="20px",o.style.fontWeight="bold",o.style.lineHeight="20px",o.style.color="#155724",o.style.opacity="0.5",o.style.cursor="pointer",o.addEventListener("click",(function(){e.remove()})));const t=document.createElement("style");t.textContent="\n        @keyframes fadeIn {\n            from { opacity: 0; transform: translateY(-10px); }\n            to { opacity: 1; transform: translateY(0); }\n        }\n        @keyframes fadeOut {\n            from { opacity: 1; transform: translateY(0); }\n            to { opacity: 0; transform: translateY(-10px); }\n        }\n    ",document.head.appendChild(t);const i=document.querySelector("main")||document.body;i.insertBefore(e,i.firstChild),setTimeout((()=>{e.parentNode&&(e.style.animation="fadeOut 0.5s",setTimeout((()=>e.remove()),500))}),8e3)}async function retrieveFromMongoDB(n,e=!1){try{console.log("Starting search with form data:",n);const o=document.getElementById("business-search-results")||document.getElementById("search_table");o&&(o.innerHTML='<div class="loading-indicator">Searching for businesses...</div>',o.style.display="block");let t=null;if(n.useMyLocation)try{console.log("Getting user's location for search..."),t=await getUserLocation(),console.log("User location for search:",t),window.currentSearchLocation=t}catch(n){return console.error("Error getting user location:",n),void alert("Unable to get your current location. Please try entering an address instead.")}else if(n.address&&""!==n.address.trim())try{console.log("Geocoding address for search:",n.address);const e=await geocodeAddressClientSide(n.address);if(!(e&&e.lat&&e.lng))throw console.warn("Client-side geocoding failed"),new Error(`Geocoding failed for address: ${n.address}`);if(t=e,console.log("Successfully geocoded address to:",t),window.currentSearchLocation=t,map&&t){const n=new google.maps.LatLng(t.lat,t.lng);map.setCenter(n),map.setZoom(11)}}catch(n){return console.error("Error geocoding address:",n),void alert("We couldn't recognize that address. Please try a more specific address.")}const i={};n.businessName&&""!==n.businessName.trim()&&(i.business_name=n.businessName),n.address&&""!==n.address.trim()&&!t&&(i.address=n.address),t&&t.lat&&t.lng?(i.lat=t.lat,i.lng=t.lng,i.radius=25,console.log("Using geocoded search location:",t),console.log("NOT sending address parameter to avoid server confusion")):n.address&&""!==n.address.trim()&&console.log("Using address-only search (no geocoding):",n.address),e&&(i.ts=(new Date).getTime());const s=new URLSearchParams(i).toString(),a=`${getBaseURL()}/api/business.js?operation=search&${s}`;console.log("Fixed API call:",a);const r=await fetch(a,{method:"GET",headers:{"Content-Type":"application/json; charset=UTF-8","Cache-Control":e?"no-cache, no-store, must-revalidate":"default",Pragma:e?"no-cache":"default",Expires:e?"0":"default"}});if(console.log("Response status:",r.status),!r.ok){const n=await r.text();throw console.error("Error response:",n),new Error(`Failed to retrieve data: ${r.status} ${n}`)}const l=await r.json();console.log("Search results from database:",l),clearMarkers(),bounds=new google.maps.LatLngBounds;let c=[],d=[];if(l.results&&l.results.length>0&&l.results.forEach((n=>{const e=getBusinessLocation(n);if(!e||!t)return void d.push(n);const o=new google.maps.LatLng(e.lat,e.lng),i=new google.maps.LatLng(t.lat,t.lng),s=621371e-9*google.maps.geometry.spherical.computeDistanceBetween(o,i);s<=50?(c.push(n),console.log(`Found nearby business: ${n.bname} (${s.toFixed(1)} miles)`)):(d.push(n),console.log(`Found distant business: ${n.bname} (${s.toFixed(1)} miles)`))})),console.log(`Found ${c.length} nearby and ${d.length} distant businesses in database`),0===c.length&&n.businessName&&t){console.log("No nearby businesses in database, searching Google Places for:",n.businessName);try{const e=await searchGooglePlacesForBusiness(n.businessName,t);if(e&&e.length>0){console.log(`Found ${e.length} businesses via Google Places`);const n=[...e,...d];if(displayBusinessesOnMap(n),document.getElementById("search_table"))displaySearchResults(n);else{const e=document.getElementById("business-search-results");e&&displayBusinessSearchResults(n,e)}}else console.log("No businesses found via Google Places either"),showNoResultsMessage()}catch(n){console.error("Error searching Google Places:",n),d.length>0?(displayBusinessesOnMap(d),displaySearchResults(d)):showNoResultsMessage()}}else{const n=[...c,...d];if(displayBusinessesOnMap(n),document.getElementById("search_table"))displaySearchResults(n);else{const e=document.getElementById("business-search-results");e&&displayBusinessSearchResults(n,e)}if(t&&n.length>0){searchNearbyBusinesses(new google.maps.LatLng(t.lat,t.lng),n[0].type||"OTHER")}}}catch(n){console.error("Search error:",n),showErrorMessage(`Error searching for businesses: ${n.message}`)}}async function searchGooglePlacesForBusiness(n,e){try{console.log("Searching Google Places (new API) for:",n,"near",e);const{Place:o,SearchNearbyRequest:t}=await google.maps.importLibrary("places"),i=new google.maps.LatLng(e.lat,e.lng),s={textQuery:n,locationBias:{center:i,radius:4e4},maxResultCount:20,fields:["id","displayName","formattedAddress","location","types","nationalPhoneNumber","internationalPhoneNumber"]};console.log("New Places API request:",s);const{places:a}=await o.searchByText(s);if(!a||0===a.length)return console.log("No businesses found via new Places API"),[];console.log("Found businesses via new Places API:",a.length);const r=a.filter((e=>{const o=e.displayName.toLowerCase();return o.includes("pro desk")||o.includes("garden center")||o.includes("rental center")||o.includes("tool rental")||o.includes("customer service")?(console.log("Filtering out department:",e.displayName),!1):!(o.includes(" - ")&&!o.toLowerCase().startsWith(n.toLowerCase())&&(console.log("Filtering out formatted result:",e.displayName),1))}));console.log(`Filtered to ${r.length} main store results`);const l=r.map((async n=>{const o=n.formattedAddress?n.formattedAddress.split(","):[];let t="",s="",a="",r="";if(o.length>=1&&(t=o[0].trim()),o.length>=2&&(s=o[1].trim()),o.length>=3){const n=o[2].trim().match(/^([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/);n&&(a=n[1],r=n[2])}const l=n.location,c=google.maps.geometry.spherical.computeDistanceBetween(i,l);let d=0,p=0;if(n.location)try{d="function"==typeof n.location.lat?n.location.lat():n.location.lat||0,p="function"==typeof n.location.lng?n.location.lng():n.location.lng||0}catch(n){console.warn("Error extracting coordinates from new Places API:",n),d=e.lat,p=e.lng}const g={_id:"google_"+n.id,bname:n.displayName,address1:t,city:s,state:a,zip:r,formattedAddress:n.formattedAddress,type:mapGooglePlaceTypeToBusinessType(n.types),phone:n.nationalPhoneNumber||n.internationalPhoneNumber||"",isGooglePlace:!0,placeId:n.id,lat:d,lng:p,distance:c};try{const e=await findMatchingChainForPlaceResult(n.displayName);e?(console.log(`Found chain match for "${n.displayName}": ${e.bname}`),g.chain_id=e._id,g.chain_name=e.bname,g.isChainLocation=!0):console.log(`No chain match found for: ${n.displayName}`)}catch(n){console.warn("Error checking for chain match:",n)}return g})),c=await Promise.all(l);return c.sort(((n,e)=>n.distance-e.distance)),console.log("Final processed businesses with new API:",c.map((n=>({name:n.bname,placeId:n.placeId,isChain:!!n.chain_id,chainName:n.chain_name})))),c}catch(o){return console.error("Error in new Places API search:",o),console.warn("Falling back to deprecated PlacesService API"),await searchGooglePlacesForBusinessLegacy(n,e)}}async function searchGooglePlacesForBusinessLegacy(n,e){return new Promise(((o,t)=>{try{if(console.log("Using legacy PlacesService as fallback"),!map)return void t(new Error("Map not initialized"));const i=new google.maps.LatLng(e.lat,e.lng),s=new google.maps.places.PlacesService(map),a={query:n,location:i,radius:4e4};s.textSearch(a,(async(n,e)=>{if(e===google.maps.places.PlacesServiceStatus.OK&&n&&n.length>0){const e=n.filter((n=>{const e=n.name.toLowerCase();return!e.includes("pro desk")&&!e.includes("garden center")&&!e.includes("rental center")})),t=await Promise.all(e.map((async n=>{const e={_id:"google_"+n.place_id,bname:n.name,isGooglePlace:!0,placeId:n.place_id,lat:n.geometry.location.lat(),lng:n.geometry.location.lng()},o=await findMatchingChainForPlaceResult(n.name);return o&&(e.chain_id=o._id,e.chain_name=o.bname,e.isChainLocation=!0),e})));o(t)}else console.log("Legacy API also found no results"),o([])}))}catch(n){t(n)}}))}function showNoResultsMessage(){const n=document.getElementById("business-search-results")||document.getElementById("search_table");n&&(n.innerHTML='<div class="error-message">No businesses found matching your search criteria in this area.</div>',n.style.display="block")}function displayBusinessesOnMap(n){if(!map)return console.log("Map not ready, storing businesses for later display"),void(pendingBusinessesToDisplay=n);console.log("Displaying businesses on map:",n.length),clearMarkers(),bounds=new google.maps.LatLngBounds;let e=0,o=0;n.forEach((n=>{try{let t,i;if(console.log("Processing business for map:",n.bname),n.location&&n.location.coordinates&&Array.isArray(n.location.coordinates)&&n.location.coordinates.length>=2)i=n.location.coordinates[0],t=n.location.coordinates[1];else{if(void 0===n.lat||void 0===n.lng)return void console.warn(`Business ${n.bname} missing coordinates`);t=parseFloat(n.lat),i=parseFloat(n.lng)}if(isNaN(t)||isNaN(i))return void console.warn(`Invalid coordinates for ${n.bname}:`,t,i);if(n.lat=t,n.lng=i,createBusinessMarker(n)){if(e++,window.currentSearchLocation){const e=new google.maps.LatLng(t,i),s=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng),a=google.maps.geometry.spherical.computeDistanceBetween(e,s);a<=80467?(o++,console.log(`${n.bname} is ${(621371e-9*a).toFixed(1)} miles from search location`)):console.log(`${n.bname} is ${(621371e-9*a).toFixed(1)} miles from search location (distant)`)}const s=new google.maps.LatLng(t,i);bounds.extend(s)}}catch(e){console.error(`Error adding business ${n.bname} to map:`,e)}})),console.log(`Added ${e} valid markers to the map (${o} nearby)`),setTimeout((()=>{try{if(window.currentSearchLocation&&o>0){console.log("Centering map on search location with nearby businesses");const n=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng);map.setCenter(n),map.setZoom(12)}else if(window.currentSearchLocation&&e>0){console.log("Centering map on search location (distant businesses only)");const n=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng);map.setCenter(n),map.setZoom(10)}else e>0&&bounds&&!bounds.isEmpty()?(console.log("No search location, fitting map to business bounds"),safelyFitBounds(map,bounds)):(console.log("Using default map center"),map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom))}catch(n){console.error("Error updating map view:",n)}}),200)}async function geocodeAddressClientSide(n){return new Promise(((e,o)=>{try{if(console.log(`Geocoding address client-side: ${n}`),!n)return console.error("No address provided for geocoding"),void o(new Error("No address provided"));if(!window.google||!window.google.maps)return void o(new Error("Google Maps API not loaded"));(new google.maps.Geocoder).geocode({address:n},(function(n,t){if(t===google.maps.GeocoderStatus.OK&&n&&n.length>0){const o=n[0].geometry.location,t={lat:o.lat(),lng:o.lng(),formattedAddress:n[0].formatted_address};console.log("Client-side geocoding result:",t),e(t)}else console.error("Client-side geocoding failed:",t),o(new Error(`Geocoding failed: ${t}`))}))}catch(n){console.error("Error in client-side geocoding:",n),o(n)}}))}async function searchGooglePlacesForSpecificBusiness(n,e){try{console.log("Searching specifically for:",n);const o=document.getElementById("map");o&&(o.style.display="block",o.style.height="500px");const t=document.createElement("div");t.id="map-loading",t.className="loading-indicator",t.innerHTML="Searching for businesses...",o.appendChild(t);const i=new google.maps.LatLng(e.lat,e.lng);map.setCenter(i),map.setZoom(11);const s=new google.maps.places.PlacesService(map),a={query:n,location:i,radius:5e4};s.textSearch(a,((o,t)=>{const i=document.getElementById("map-loading");if(i&&i.remove(),t===google.maps.places.PlacesServiceStatus.OK&&o&&o.length>0){console.log("Found specific businesses:",o.length);const n=o.map((n=>({_id:"google_"+n.place_id,bname:n.name,address1:n.formatted_address||"",city:"",state:"",zip:"",isGooglePlace:!0,placeId:n.place_id,lat:n.geometry.location.lat(),lng:n.geometry.location.lng()})));n.forEach((n=>{createBusinessMarker(n)})),displaySearchResults(n)}else console.log("No specific businesses found:",t),searchGooglePlaces({businessName:n},e)}))}catch(o){console.error("Error in specific business search:",o),searchGooglePlaces({businessName:n},e)}}async function searchGooglePlaces(n,e=null){try{console.log("Searching Google Places for:",n);const o=document.getElementById("map");o&&(o.style.display="block",o.style.height="500px"),clearMarkers(),bounds=new google.maps.LatLngBounds;let t="";n.businessName&&(t+=n.businessName),n.address&&(t+=" "+n.address),t=t.trim();const i=document.createElement("div");let s;i.id="map-loading",i.className="loading-indicator",i.innerHTML="Searching for businesses...",o.appendChild(i),e?(s=new google.maps.LatLng(e.lat,e.lng),bounds.extend(s),map.setCenter(s),map.setZoom(12)):(s=new google.maps.LatLng(CONFIG.defaultCenter.lat,CONFIG.defaultCenter.lng),bounds.extend(s),console.log("Using default US center for search"));try{const n=new google.maps.places.PlacesService(map),e={query:t,location:s,radius:4e4};n.textSearch(e,((n,e)=>{const o=document.getElementById("map-loading");if(o&&o.remove(),e===google.maps.places.PlacesServiceStatus.OK&&n&&n.length>0){console.log("Found places via Places API:",n.length);const e=n.map((n=>{const e=n.formatted_address?n.formatted_address.split(","):[];let o="",t="",i="",a="";if(e.length>=1&&(o=e[0].trim()),e.length>=2&&(t=e[1].trim()),e.length>=3){const n=e[2].trim().split(" ");n.length>=1&&(i=n[0].trim()),n.length>=2&&(a=n[1].trim())}const r=n.geometry.location,l=google.maps.geometry.spherical.computeDistanceBetween(s,r),c={_id:"google_"+n.place_id,bname:n.name,address1:o,city:t,state:i,zip:a,formattedAddress:n.formatted_address,type:mapGooglePlaceTypeToBusinessType(n.types),phone:n.formatted_phone_number||"",isGooglePlace:!0,placeId:n.place_id,lat:n.geometry.location.lat(),lng:n.geometry.location.lng(),distance:l};return createBusinessMarker(c),bounds.extend(r),c}));findChainMatchesForResults(e).then((()=>{e.sort(((n,e)=>n.distance-e.distance)),displaySearchResults(e),bounds&&!bounds.isEmpty()&&safelyFitBounds(map,bounds)}))}else console.log("No places found via Places API:",e),showErrorMessage("No businesses found matching your search criteria.")}))}catch(n){console.error("Error searching places:",n);const e=document.getElementById("map-loading");e&&e.remove(),showErrorMessage(`Error searching for businesses: ${n.message}`)}}catch(n){console.error("Error in searchGooglePlaces:",n),showErrorMessage(`Error searching for businesses: ${n.message}`)}}function applyMapHeightFix(){if(!document.getElementById("map-height-fix")){const n=document.createElement("style");n.id="map-height-fix",n.textContent=mapHeightCSS,document.head.appendChild(n),console.log("Applied map height and info window positioning fixes"),map&&google.maps.event&&setTimeout((()=>{google.maps.event.trigger(map,"resize"),console.log("Triggered map resize event")}),100)}}window.viewBusinessDetails=function(n){console.log("View details for business:",n),alert("This feature is coming soon: View details for "+n)},window.addBusinessToDatabase=async function(n,e=null){console.log("Adding place to database:",n,"Chain ID:",e);try{const o=new google.maps.places.PlacesService(map),t={placeId:n,fields:["name","formatted_address","formatted_phone_number","geometry","address_components"]};o.getDetails(t,(async(n,o)=>{if(o!==google.maps.places.PlacesServiceStatus.OK||!n)return console.error("Error fetching place details:",o),void alert("Sorry, we couldn't retrieve the details for this business. Please try again or add it manually.");console.log("Place details retrieved:",n);const t={};if(n.address_components)for(const e of n.address_components)for(const n of e.types)t[n]=e.short_name;const i={name:n.name||"",address1:(t.street_number||"")+" "+(t.route||""),city:t.locality||"",state:t.administrative_area_level_1||"",zip:t.postal_code||"",phone:n.formatted_phone_number||"",placeId:n.place_id,formattedAddress:n.formatted_address,lat:n.geometry?.location.lat()||0,lng:n.geometry?.location.lng()||0,location:{type:"Point",coordinates:[n.geometry?.location.lng()||0,n.geometry?.location.lat()||0]}};if(e){i.chain_id=e;try{const n=await getChainDetails(e);n&&n.bname&&(i.chain_name=n.bname)}catch(n){console.error("Error getting chain details:",n)}alert("This business will be added as a location of "+(i.chain_name||"the chain")+". Chain-wide incentives already apply to this location.")}sessionStorage.setItem("newBusinessData",JSON.stringify(i)),window.location.href="business-add.html?prefill=true"}))}catch(n){console.error("Error in addBusinessToDatabase:",n),alert("Sorry, we couldn't add this business to the database. Please try again or add it manually.")}},console.log("Enhanced Las Vegas search fix loaded!");const mapHeightCSS="\n#map {\n    width: 100%;\n    height: 800px !important; /* Increased from 500px */\n    min-height: 800px;\n    border: 1px solid #ccc;\n    border-radius: 4px;\n    margin: 10px 0;\n    position: relative;\n}\n\n#map-container {\n    width: 90%;\n    margin: 20px auto;\n    clear: both;\n}\n\n.map-controls {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 10px;\n    padding: 0 5px;\n}\n\n/* Ensure proper info window positioning */\n.gm-style .gm-style-iw-c {\n    padding: 0 !important;\n    border-radius: 8px !important;\n    box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n    max-width: 330px !important;\n    max-height: 400px !important;\n    overflow: hidden !important;\n    position: relative !important;\n    z-index: 1000 !important;\n    /* Ensure it's positioned correctly relative to the tail */\n    margin-bottom: 15px !important;\n}\n\n.gm-style .gm-style-iw-d {\n    overflow: auto !important;\n    max-height: 350px !important;\n    padding-right: 8px !important;\n}\n\n.gm-style .gm-style-iw {\n    /* Override any problematic positioning */\n    position: relative !important;\n    z-index: 1001 !important;\n}\n\n.gm-style .gm-style-iw-t {\n    position: absolute !important;\n    width: 100% !important;\n    /* Override the inline bottom positioning that's causing the issue */\n    bottom: 0px !important;\n    /* Ensure proper positioning */\n    right: auto !important;\n    left: 50% !important;\n    transform: translateX(-50%) !important;\n    /* Make sure it's properly sized */\n    height: 15px !important;\n}\n\n.gm-style .gm-style-iw-tc {\n    /* This is the tail connector - make sure it's positioned correctly */\n    top: auto !important;\n    bottom: -15px !important;\n    left: 50% !important;\n    right: auto !important;\n    transform: translateX(-50%) !important;\n    width: 24px !important;\n    height: 24px !important;\n}\n";function showBusinessInfoWindow(n){if(!n||!n.business)return void console.error("Invalid marker or missing business data");const e=n.business;console.log("Showing info window for business:",e.bname),infoWindow||(infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1}));const o=!0===e.isGooglePlace,t=!!e.chain_id,i=e.address1?`<p><strong>Address:</strong><br>${e.address1}${e.city?", "+e.city:""}${e.state?", "+e.state:""}${e.zip?" "+e.zip:""}</p>`:"",s=t?`<span style="display:inline-block; background-color:#4285F4; color:white; padding:2px 6px; border-radius:4px; font-size:0.8em; margin-left:5px;">${e.chain_name||"Chain Location"}</span>`:"";let a;a=o?t?`\n                <button style="background-color:#EA4335; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; margin-top:10px;" \n                        onclick="window.addBusinessToDatabase('${e.placeId}', '${e.chain_id}')">\n                    Add to Database\n                </button>\n            `:`\n                <button style="background-color:#EA4335; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; margin-top:10px;" \n                        onclick="window.addBusinessToDatabase('${e.placeId}')">\n                    Add to Patriot Thanks\n                </button>\n            `:`\n            <button style="background-color:#4285F4; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; margin-top:10px;" \n                    onclick="window.viewBusinessDetails('${e._id}')">\n                View Details\n            </button>\n        `;const r=`\n        <div style="max-width:300px; font-family:Arial,sans-serif;">\n            <h3 style="margin-top:0; margin-bottom:8px; font-size:16px;">${e.bname} ${s}</h3>\n            ${i}\n            <div id="incentives-container-${e._id||e.placeId}">\n                <p><em>Loading incentives...</em></p>\n            </div>\n            <div style="text-align:right;">\n                ${a}\n            </div>\n        </div>\n    `;if(infoWindow.setContent(r),infoWindow.open(map,n),o&&t)fetchChainIncentivesForInfoWindow(e.placeId,e.chain_id,!0);else if(o){const n=document.getElementById(`incentives-container-${e._id||e.placeId}`);n&&(n.innerHTML="<p><em>This business is not yet in the Patriot Thanks database.</em></p>")}else fetchBusinessIncentivesForInfoWindow(e._id)}function fetchChainIncentivesForInfoWindow(n,e,o=!1){if(!e)return void console.error("No chain ID provided for fetching incentives");const t=o?`incentives-container-${n}`:`info-window-incentives-${n}`,i=document.getElementById(t);if(!i)return void console.error(`Could not find incentives div for place ${n}`);const s=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${e}`;console.log("Fetching chain incentives from:",s),fetch(s).then((n=>{if(!n.ok)throw new Error(`Failed to fetch chain incentives: ${n.status}`);return n.json()})).then((e=>{if(console.log(`Chain incentives data for place ${n}:`,e),!e.results||0===e.results.length)return void(i.innerHTML="<p><strong>Chain Incentives:</strong> No incentives found</p>");let o='<p><strong>Chain Incentives:</strong></p><ul style="margin:8px 0; padding-left:20px;">';e.results.forEach((n=>{if(n.is_available){const e=getIncentiveTypeLabel(n.type),t=n.other_description?` (${n.other_description})`:"",i='<span style="display:inline-block; background-color:#4285F4; color:white; padding:1px 4px; border-radius:4px; font-size:0.7em; margin-left:5px;">Chain-wide</span>';o+=`\n                        <li>\n                            <strong>${e}${t}:</strong> ${n.amount}% ${i}\n                            ${n.information?`<div style="font-size:13px; color:#555; margin-top:2px;">${n.information}</div>`:""}\n                        </li>\n                    `}})),o+="</ul>",o+=`\n                <div style="margin-top:10px; font-style:italic; color:#666; font-size:12px;">\n                    This location matches ${e.chain_info?e.chain_info.bname:"a chain"} in our database.\n                    Chain-wide incentives apply to all locations.\n                </div>\n            `,i.innerHTML=o})).catch((n=>{console.error(`Error fetching chain incentives: ${n}`),i.innerHTML="<p><strong>Chain Incentives:</strong> Error loading incentives</p>"}))}function safeExtractCoordinates(n){try{if(!n)return null;let e,o;if("function"==typeof n.lat&&"function"==typeof n.lng)e=n.lat(),o=n.lng();else if(void 0!==n.lat&&void 0!==n.lng)e=parseFloat(n.lat),o=parseFloat(n.lng);else if(void 0!==n.latitude&&void 0!==n.longitude)e=parseFloat(n.latitude),o=parseFloat(n.longitude);else{if(!(Array.isArray(n)&&n.length>=2))return console.warn("Unrecognized location object format:",n),null;e=parseFloat(n[0]),o=parseFloat(n[1])}return isNaN(e)||isNaN(o)||!isFinite(e)||!isFinite(o)?(console.warn("Invalid coordinates extracted:",e,o),null):Math.abs(e)>90||Math.abs(o)>180?(console.warn("Coordinates out of valid range:",e,o),null):{lat:e,lng:o}}catch(n){return console.error("Error extracting coordinates:",n),null}}function showInfoWindow(n){if(console.log("showInfoWindow called with marker:",n),!n||!n.business)return void console.error("Invalid marker for info window",n);const e=n.business;console.log("Business data for info window:",e),infoWindow&&infoWindow.close(),infoWindow=new google.maps.InfoWindow({maxWidth:300,disableAutoPan:!1});const o=buildInfoWindowContent(e);infoWindow.setContent(o);let t=null;if(n.getPosition&&"function"==typeof n.getPosition)try{t=n.getPosition()}catch(n){console.warn("Error getting position from marker.getPosition():",n)}if(!t&&n.position&&(t=n.position),!t&&e){const n=safeExtractCoordinates(e);n&&(t=new google.maps.LatLng(n.lat,n.lng))}t||(console.error("Could not determine position for info window"),t=new google.maps.LatLng(39.8283,-98.5795));const i=safeExtractCoordinates(t);if(!i)return void console.error("Invalid position for info window");const s=new google.maps.LatLng(i.lat,i.lng);try{map.panTo(s)}catch(n){console.warn("Error panning to position:",n)}setTimeout((()=>{try{n.getPosition?infoWindow.open(map,n):(infoWindow.setPosition(s),infoWindow.open(map)),console.log("Info window opened successfully"),google.maps.event.addListenerOnce(infoWindow,"domready",(function(){console.log("Info window DOM ready"),setTimeout((()=>{fixInfoWindowPositioning(),e.isGooglePlace?e.chain_id&&setTimeout((()=>{loadChainIncentivesForInfoWindow(e.placeId,e.chain_id)}),200):setTimeout((()=>{loadIncentivesForInfoWindow(e._id)}),200)}),300)}))}catch(n){console.error("Error opening info window:",n)}}),200)}function withErrorHandling(n,e){return function(...o){try{return n.apply(this,o)}catch(n){return console.error(`Error in ${e}:`,n),null}}}function fixInfoWindowPositioning(){console.log("Applying info window positioning fix");const n=document.querySelector(".gm-style-iw-c"),e=document.querySelector(".gm-style-iw-d"),o=document.querySelector(".gm-style-iw-t");if(!n)return void console.log("Info window container not found");const t=n.getBoundingClientRect();if(console.log("Info window position:",t),t.width<50&&(console.log("Info window width too small, forcing proper dimensions"),n.style.width="auto",n.style.minWidth="280px",n.style.maxWidth="320px",e&&(e.style.width="auto",e.style.minWidth="280px")),t.top<0||t.top>window.innerHeight||t.left<0||t.left>window.innerWidth||t.width<50){console.log("Info window has positioning/sizing issues, applying comprehensive fix");const e=n.style.transform;if(e&&e.includes("translate")){console.log("Current transform:",e);const o=e.match(/translate\(([^,]+),\s*([^)]+)\)/);if(o){const e=parseFloat(o[1]),t=parseFloat(o[2]);(Math.abs(e)>window.innerWidth||Math.abs(t)>window.innerHeight)&&(console.log("Resetting extreme transform values"),n.style.transform="translate(0px, 0px)")}}n.style.display="block",n.style.visibility="visible",n.style.opacity="1",o&&(o.style.bottom="0px",o.style.left="50%",o.style.right="auto",o.style.transform="translateX(-50%)"),console.log("Applied comprehensive positioning fix"),setTimeout((()=>{google.maps.event.trigger(map,"resize");const e=n.getBoundingClientRect();console.log("Info window dimensions after fix:",e)}),100)}}function loadIncentivesForInfoWindow(n){const e=document.getElementById(`incentives-container-${n}`);if(!e)return void console.error("Incentives container not found for business:",n);const o=getBaseURL();fetch(`${o}/api/combined-api.js?operation=incentives&business_id=${n}`).then((n=>n.json())).then((n=>{if(!n.results||0===n.results.length)return void(e.innerHTML='<p style="margin:4px 0; font-style:italic; color:#666;">No incentives available</p>');let o='<p style="margin:4px 0;"><strong>Incentives:</strong></p><ul style="margin:4px 0; padding-left:16px; font-size:13px;">';n.results.forEach((n=>{if(n.is_available){const e=getIncentiveTypeLabel(n.type),t=n.other_description?` (${n.other_description})`:"",i=n.is_chain_wide?'<span style="background-color:#4285F4; color:white; padding:1px 4px; border-radius:3px; font-size:11px; margin-left:4px;">Chain-wide</span>':"";o+=`<li style="margin-bottom:4px;"><strong>${e}${t}:</strong> ${n.amount}% ${i}</li>`}})),o+="</ul>",e.innerHTML=o})).catch((n=>{console.error("Error loading incentives:",n),e.innerHTML='<p style="margin:4px 0; font-style:italic; color:#666;">Error loading incentives</p>'}))}function loadChainIncentivesForInfoWindow(n,e){const o=document.getElementById(`incentives-container-${n}`);if(!o)return void console.error("Incentives container not found for place:",n);const t=getBaseURL();fetch(`${t}/api/combined-api.js?operation=incentives&business_id=${e}`).then((n=>n.json())).then((n=>{if(!n.results||0===n.results.length)return void(o.innerHTML='<p style="margin:4px 0; font-style:italic; color:#666;">No chain incentives available</p>');let e='<p style="margin:4px 0;"><strong>Chain Incentives:</strong></p><ul style="margin:4px 0; padding-left:16px; font-size:13px;">';n.results.forEach((n=>{if(n.is_available){const o=getIncentiveTypeLabel(n.type),t=n.other_description?` (${n.other_description})`:"";e+=`<li style="margin-bottom:4px;"><strong>${o}${t}:</strong> ${n.amount}% <span style="background-color:#4285F4; color:white; padding:1px 4px; border-radius:3px; font-size:11px; margin-left:4px;">Chain-wide</span></li>`}})),e+="</ul>",e+='<p style="margin:8px 0 4px 0; font-size:12px; font-style:italic; color:#666;">These incentives apply to all locations of this chain.</p>',o.innerHTML=e})).catch((n=>{console.error("Error loading chain incentives:",n),o.innerHTML='<p style="margin:4px 0; font-style:italic; color:#666;">Error loading chain incentives</p>'}))}function applyInfoWindowCSS(){if(!document.getElementById("info-window-fix-css")){const n=document.createElement("style");n.id="info-window-fix-css",n.textContent="\n            /* Ensure info windows are visible and properly positioned */\n            .gm-style .gm-style-iw-c {\n                max-width: 320px !important;\n                max-height: 400px !important;\n                padding: 0 !important;\n                border-radius: 8px !important;\n                box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n                overflow: hidden !important;\n            }\n\n            .gm-style .gm-style-iw-d {\n                overflow: auto !important;\n                max-height: 350px !important;\n            }\n\n            .gm-style .gm-style-iw {\n                display: block !important;\n                visibility: visible !important;\n                opacity: 1 !important;\n            }\n\n            /* Fix tail positioning */\n            .gm-style .gm-style-iw-t {\n                bottom: 0px !important;\n                left: 50% !important;\n                right: auto !important;\n                transform: translateX(-50%) !important;\n                width: 20px !important;\n                height: 15px !important;\n            }\n\n            /* Ensure close button is visible */\n            .gm-ui-hover-effect {\n                opacity: 0.8 !important;\n                top: 2px !important;\n                right: 2px !important;\n            }\n\n            .gm-ui-hover-effect:hover {\n                opacity: 1 !important;\n            }\n\n            /* Custom scrollbar for info window content */\n            .gm-style .gm-style-iw-d::-webkit-scrollbar {\n                width: 6px;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-track {\n                background: #f1f1f1;\n                border-radius: 3px;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb {\n                background: #c1c1c1;\n                border-radius: 3px;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb:hover {\n                background: #a8a8a8;\n            }\n        ",document.head.appendChild(n),console.log("Applied info window CSS fixes")}}function applyTargetedTailFix(){console.log("Applying targeted tail fix...");const n=document.querySelector(".gm-style-iw-t");if(n){const e=window.getComputedStyle(n);console.log("Current tail positioning:",{bottom:e.bottom,right:e.right,left:e.left,width:e.width,height:e.height});const o=e.bottom,t=e.right;n.style.setProperty("bottom","0px","important"),n.style.setProperty("left","50%","important"),n.style.setProperty("right","auto","important"),n.style.setProperty("transform","translateX(-50%)","important"),console.log(`Applied tail fix: changed bottom from ${o} to 0px, right from ${t} to auto`),setTimeout((()=>{const e=document.querySelector(".gm-style-iw-c").getBoundingClientRect();console.log("Info window position after tail fix:",e);const o=window.getComputedStyle(n);console.log("New tail positioning:",{bottom:o.bottom,right:o.right,left:o.left,transform:o.transform})}),50)}else console.log("No tail element found for fixing")}function applyCSSOnlyTailFix(){if(!document.getElementById("css-only-tail-fix")){const n=document.createElement("style");n.id="css-only-tail-fix",n.textContent="\n            /* Target only the tail positioning without affecting the container */\n            .gm-style .gm-style-iw-t {\n                bottom: 0px !important;\n                left: 0px !important;\n                right: 0px !important;\n                transform: translateX(-50%) !important;\n                width: 0 !important;\n                height: 0 !important;\n            }\n            \n            /* Don't touch the main container transform */\n            .gm-style .gm-style-iw-c {\n                /* Let Google handle the main positioning */\n            }\n        ",document.head.appendChild(n),console.log("Applied CSS-only tail fix")}}function gentlyFixInfoWindowPosition(){console.log("Applying gentle info window position fix...");const n=document.querySelector(".gm-style-iw-t");if(n){const e=window.getComputedStyle(n);console.log("Current tail styles:",{bottom:e.bottom,right:e.right,left:e.left,position:e.position}),"34px"===e.bottom&&"0px"===e.right&&(console.log("Found problematic tail positioning, applying gentle fix..."),n.style.bottom="0px",console.log("Applied gentle fix - changed bottom from 34px to 0px"),setTimeout((()=>{const n=document.querySelector(".gm-style-iw-c");if(n){const e=n.getBoundingClientRect();console.log("Info window position after gentle fix:",e)}}),100))}}function checkAndReportInfoWindowPosition(){console.log("=== INFO WINDOW POSITION REPORT ===");const n=document.querySelector(".gm-style-iw-c"),e=(document.querySelector(".gm-style-iw-d"),document.querySelector(".gm-style-iw-t"));if(n){const o=n.getBoundingClientRect(),t=window.getComputedStyle(n);console.log("Container position:",o),console.log("Container visibility:",t.visibility),console.log("Container display:",t.display),console.log("Container opacity:",t.opacity),console.log("Container transform:",t.transform);const i=o.width>0&&o.height>0,s=o.top>=0&&o.top<=window.innerHeight&&o.left>=0&&o.left<=window.innerWidth;if(console.log("Is visible:",i),console.log("Is in viewport:",s),!s&&e){const n=window.getComputedStyle(e);console.log("Tail styles:",{bottom:n.bottom,right:n.right,left:n.left,width:n.width,height:n.height})}}else console.log("No info window container found");console.log("=== END REPORT ===")}function removeAggressiveCSS(){["final-info-window-fix","info-window-position-fix","minimal-info-window-fix"].forEach((n=>{const e=document.getElementById(n);e&&(console.log("Removing potentially problematic CSS:",n),e.remove())}))}function applyBasicInfoWindowCSS(){if(!document.getElementById("basic-info-window-css")){const n=document.createElement("style");n.id="basic-info-window-css",n.textContent="\n            /* Very basic CSS - just ensure visibility */\n            .gm-style .gm-style-iw-c {\n                display: block !important;\n                visibility: visible !important;\n                opacity: 1 !important;\n            }\n            \n            .gm-style .gm-style-iw {\n                display: block !important;\n                visibility: visible !important;\n                opacity: 1 !important;\n            }\n            \n            /* Map height fix */\n            #map-container {\n                width: 90%;\n                margin: 20px auto;\n                clear: both;\n                position: relative;\n            }\n\n            #map {\n                width: 100%;\n                height: 800px !important;\n                min-height: 800px;\n                border: 1px solid #ccc;\n                border-radius: 4px;\n                margin: 10px 0;\n                position: relative;\n                z-index: 1;\n            }\n        ",document.head.appendChild(n),console.log("Applied basic info window CSS")}}function fixInfoWindowTailPositioning(){console.log("Attempting to fix info window tail positioning");const n=document.querySelector(".gm-style-iw-t");if(n){console.log("Found info window tail element, applying aggressive fixes"),n.style.removeProperty("bottom"),n.style.removeProperty("right"),n.style.removeProperty("left"),n.style.removeProperty("top"),n.style.setProperty("position","absolute","important"),n.style.setProperty("bottom","0px","important"),n.style.setProperty("right","auto","important"),n.style.setProperty("left","50%","important"),n.style.setProperty("top","auto","important"),n.style.setProperty("transform","translateX(-50%)","important"),n.style.setProperty("width","20px","important"),n.style.setProperty("height","15px","important"),console.log("Applied positioning fixes to tail element");const e=document.querySelector(".gm-style-iw-c");if(e){const n=window.getComputedStyle(e).transform;if(console.log("Current info window transform:",n),n&&n.includes("matrix")){const n=e.getBoundingClientRect();(n.top<-100||n.top>window.innerHeight+100)&&(console.log("Info window positioned off-screen, attempting to reset transform"),e.style.setProperty("transform","none","important"),setTimeout((()=>{const n=e.getBoundingClientRect();console.log("Info window position after transform reset:",n)}),100))}}const o=document.querySelector(".gm-style-iw-tc");return o&&(o.style.setProperty("top","auto","important"),o.style.setProperty("bottom","-15px","important"),o.style.setProperty("left","50%","important"),o.style.setProperty("right","auto","important"),o.style.setProperty("transform","translateX(-50%)","important"),console.log("Fixed tail connector positioning")),!0}return console.warn("Could not find tail element to fix"),!1}function applyInfoWindowPositioningFixes(){if(!document.getElementById("final-info-window-fix")){const n=document.createElement("style");n.id="final-info-window-fix",n.textContent="\n            /* CRITICAL: Override Google's tail positioning that causes off-screen issues */\n            ..gm-style .gm-style-iw-t {\n                bottom: 0px !important;\n                left: 0px !important;\n                right: 0px !important;\n                transform: translateX(-50%) !important;\n                width: 0 !important;\n                height: 0 !important;\n            }\n            \n            /* Prevent off-screen positioning */\n            .gm-style .gm-style-iw-c {\n                max-width: 320px !important;\n                max-height: 400px !important;\n                overflow: hidden !important;\n                /* Prevent problematic transforms */\n                transform: none !important;\n            }\n            \n            /* Ensure visibility */\n            .gm-style .gm-style-iw {\n                display: block !important;\n                visibility: visible !important;\n                opacity: 1 !important;\n            }\n            \n            .gm-style .gm-style-iw-d {\n                overflow: auto !important;\n                max-height: 350px !important;\n            }\n            \n            /* Fix tail connector */\n            .gm-style .gm-style-iw-tc {\n                top: auto !important;\n                bottom: -15px !important;\n                left: 50% !important;\n                right: auto !important;\n                transform: translateX(-50%) !important;\n            }\n            \n            /* Map container styles */\n            #map-container {\n                width: 90%;\n                margin: 20px auto;\n                clear: both;\n                position: relative;\n            }\n\n            #map {\n                width: 100%;\n                height: 800px !important;\n                min-height: 800px;\n                border: 1px solid #ccc;\n                border-radius: 4px;\n                margin: 10px 0;\n                position: relative;\n                z-index: 1;\n            }\n        ",document.head.appendChild(n),console.log("Applied final info window positioning fixes")}}function fetchBusinessIncentivesForInfoWindow(n){n&&!n.startsWith("google_")&&setTimeout((()=>{const e=document.getElementById(`info-window-incentives-${n}`);if(!e)return void console.error(`Could not find incentives div for business ${n}`);const o=getBaseURL();fetch(`${o}/api/combined-api.js?operation=incentives&business_id=${n}`).then((n=>n.json())).then((n=>{if(!n.results||0===n.results.length)return void(e.innerHTML="<p><strong>Incentives:</strong> No incentives found</p>");let o='<p><strong>Incentives:</strong></p><ul style="margin:8px 0; padding-left:20px;">';n.results.forEach((n=>{if(n.is_available){const e=getIncentiveTypeLabel(n.type),t=n.other_description?` (${n.other_description})`:"",i=n.is_chain_wide?'<span style="display:inline-block; background-color:#4285F4; color:white; padding:1px 4px; border-radius:4px; font-size:0.7em; margin-left:5px;">Chain-wide</span>':"";o+=`<li><strong>${e}${t}:</strong> ${n.amount}% ${i}</li>`}})),o+="</ul>",e.innerHTML=o})).catch((n=>{console.error("Error fetching incentives:",n),e.innerHTML="<p><strong>Incentives:</strong> Error loading</p>"}))}),300)}function removeProblematicInfoWindowCSS(){document.querySelectorAll("#info-window-position-fix, #map-height-fix").forEach((n=>{console.log("Removing potentially problematic style:",n.id),n.remove()}));const n=document.createElement("style");n.id="minimal-info-window-fix",n.textContent="\n        /* Minimal CSS to ensure info windows are visible */\n        .gm-style .gm-style-iw-c {\n            max-width: 320px !important;\n            max-height: 400px !important;\n            overflow: visible !important;\n        }\n        \n        .gm-style .gm-style-iw-d {\n            overflow: auto !important;\n            max-height: 350px !important;\n        }\n        \n        .gm-style .gm-style-iw {\n            display: block !important;\n            visibility: visible !important;\n            opacity: 1 !important;\n        }\n        \n        /* Don't touch the tail positioning for now */\n        .gm-style .gm-style-iw-t {\n            /* Let Google handle this naturally */\n        }\n    ",document.head.appendChild(n),console.log("Applied minimal info window CSS")}async function findChainMatchesForResults(n){const e=n.map((n=>findMatchingChainForPlaceResult(n.bname).then((e=>(e&&(console.log(`Found matching chain for place: ${n.bname}`),n.chain_id=e._id,n.chain_name=e.bname,n.isChainLocation=!0),n))).catch((e=>(console.error(`Error matching chain for ${n.bname}:`,e),n)))));return await Promise.all(e),n}function findMatchingChainLocally(n){return new Promise((e=>{try{if(!n)return void e(null);console.log("Enhanced local chain matching for:",n);const o=[{name:"The Home Depot",variations:["the home depot","home depot","homedepot"],id:"681fe0e67d92c3d3e1e2a3da"},{name:"Lowe's",variations:["lowes","lowe's","lowes home improvement","lowe's home improvement"],id:"lowes_chain_id"},{name:"Walmart",variations:["walmart","wal-mart","walmart supercenter"],id:"walmart_chain_id"},{name:"Target",variations:["target","target store"],id:"target_chain_id"},{name:"Best Buy",variations:["best buy","bestbuy"],id:"bestbuy_chain_id"},{name:"McDonald's",variations:["mcdonalds","mcdonald's","mickey d's"],id:"mcdonalds_chain_id"}],t=n.toLowerCase().trim();for(const i of o)for(const o of i.variations)if(t===o||t.includes(o)||o.includes(t))return console.log(`Enhanced local match: "${n}" matches "${i.name}"`),void e({_id:i.id,bname:i.name,isLocalMatch:!0});console.log("No enhanced local chain match found for:",n),e(null)}catch(n){console.error("Error in enhanced local chain matching:",n),e(null)}}))}async function setupMapClickHandler(){if(map){console.log("Setting up map click handler");try{const{Place:n}=await google.maps.importLibrary("places");map.addListener("click",(async function(e){if(console.log("Map clicked",e),e.placeId){e.stop(),console.log("POI clicked, placeId:",e.placeId);try{const o=markers.find((n=>n.business&&(n.business.placeId===e.placeId||n.business._id==="google_"+e.placeId)));if(o)return console.log("Found existing marker for clicked place"),void showEnhancedInfoWindow(o);const t=new n({id:e.placeId});await t.fetchFields({fields:["displayName","formattedAddress","addressComponents","location","types","businessStatus","nationalPhoneNumber","internationalPhoneNumber"]}),console.log("Place details:",t);const i=t.displayName||"Unknown Business";let s="",a="",r="",l="",c="";if(c=t.nationalPhoneNumber||t.internationalPhoneNumber||"",t.addressComponents&&t.addressComponents.length>0){console.log("Parsing address components:",t.addressComponents);const n=getAddressComponent(t.addressComponents,"street_number"),e=getAddressComponent(t.addressComponents,"route");a=getAddressComponent(t.addressComponents,"locality"),r=getAddressComponent(t.addressComponents,"administrative_area_level_1"),l=getAddressComponent(t.addressComponents,"postal_code"),n&&e?s=`${n} ${e}`:e?s=e:n&&(s=n)}if(!s&&t.formattedAddress){console.log("Falling back to formatted address parsing");const n=t.formattedAddress.split(",").map((n=>n.trim()));if(n.length>=1&&(s=n[0]),n.length>=2&&(a=n[1]),n.length>=3){const e=n[2].match(/^([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/);if(e)r=e[1],l=e[2];else{const e=n[2].split(" ");e.length>=2&&(r=e[0],l=e[1])}}}let d=0,p=0;if(t.location)try{d="function"==typeof t.location.lat?t.location.lat():t.location.lat||0,p="function"==typeof t.location.lng?t.location.lng():t.location.lng||0}catch(n){console.warn("Error extracting coordinates:",n),e.latLng&&(d=e.latLng.lat(),p=e.latLng.lng())}else e.latLng&&(d=e.latLng.lat(),p=e.latLng.lng());const g=mapGooglePlaceTypeToBusinessType(t.types||[]);let m=null;try{m=await findMatchingChainForPlaceResult(i)}catch(n){console.warn("Error checking for chain match (non-critical):",n)}const u={_id:"google_"+t.id,bname:i,address1:s,city:a,state:r,zip:l,phone:c,type:g,formattedAddress:t.formattedAddress,isGooglePlace:!0,placeId:t.id,lat:d,lng:p,types:t.types||[]};if(m&&(console.log(`POI "${i}" matches chain: ${m.bname}`),u.chain_id=m._id,u.chain_name=m.bname,u.isChainLocation=!0),d&&p&&window.currentSearchLocation)try{u.distance=google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(d,p),new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng))}catch(n){console.warn("Error calculating distance:",n)}console.log("Parsed business object:",u),showEnhancedInfoWindow({business:u,position:new google.maps.LatLng(d,p),getPosition:function(){return this.position}})}catch(n){console.error("Error fetching place details:",n),alert("Unable to load details for this location. Please try again.")}}})),console.log("Map click handler set up successfully")}catch(n){console.error("Error setting up map click handler:",n)}}else console.error("Map not initialized in setupMapClickHandler")}function getAddressComponent(n,e){if(!n||!Array.isArray(n))return"";const o=n.find((n=>n.types&&n.types.includes(e)));return o&&(o.shortText||o.short_name)||""}function mapGooglePlaceTypeToBusinessType(n){if(!n||!Array.isArray(n))return"OTHER";const e={restaurant:"REST",meal_takeaway:"REST",meal_delivery:"REST",cafe:"REST",bakery:"REST",bar:"REST",night_club:"REST",food:"REST",mexican_restaurant:"REST",chinese_restaurant:"REST",italian_restaurant:"REST",japanese_restaurant:"REST",indian_restaurant:"REST",thai_restaurant:"REST",american_restaurant:"REST",pizza_restaurant:"REST",seafood_restaurant:"REST",steak_house:"REST",sushi_restaurant:"REST",vegetarian_restaurant:"REST",fast_food_restaurant:"REST",grocery_or_supermarket:"GROC",supermarket:"GROC",convenience_store:"CONV",gas_station:"FUEL",hardware_store:"HARDW",department_store:"DEPT",clothing_store:"CLTH",shoe_store:"CLTH",electronics_store:"ELEC",furniture_store:"FURN",home_goods_store:"FURN",jewelry_store:"JEWL",book_store:"BOOK",bicycle_store:"SPRT",sporting_goods_store:"SPRT",toy_store:"TOYS",pet_store:"OTHER",florist:"GIFT",gift_shop:"GIFT",car_dealer:"AUTO",car_rental:"AUTO",car_repair:"AUTO",car_wash:"AUTO",auto_parts_store:"AUTO",pharmacy:"RX",drugstore:"RX",hospital:"HEAL",doctor:"HEAL",dentist:"HEAL",veterinary_care:"HEAL",beauty_salon:"BEAU",hair_care:"BEAU",spa:"BEAU",movie_theater:"ENTR",amusement_park:"ENTR",zoo:"ENTR",aquarium:"ENTR",museum:"ENTR",art_gallery:"ENTR",bowling_alley:"ENTR",casino:"ENTR",bank:"SERV",atm:"SERV",post_office:"SERV",laundry:"SERV",gym:"SPRT",library:"BOOK",lodging:"OTHER",hotel:"OTHER",motel:"OTHER",store:"RETAIL",shopping_mall:"RETAIL",establishment:"OTHER",point_of_interest:"OTHER"};for(const o of n)if(e[o])return e[o];return"OTHER"}async function findMatchingChainForPlaceResult(n){try{if(!n)return console.warn("Empty place name provided for chain matching"),null;console.log("Checking if place matches a chain:",n);const e=n.trim(),o=getBaseURL();try{const n=await fetch(`${o}/api/business.js?operation=find_matching_chain&place_name=${encodeURIComponent(e)}`);if(n.ok){const e=await n.json();if(e.success&&e.chain)return console.log("Found exact chain match:",e.chain.bname),e.chain}const t=generateNameVariations(e);for(const n of t)try{const e=await fetch(`${o}/api/business.js?operation=find_matching_chain&place_name=${encodeURIComponent(n)}`);if(e.ok){const o=await e.json();if(o.success&&o.chain)return console.log(`Found chain match with variation "${n}":`,o.chain.bname),o.chain}}catch(e){console.warn(`Error testing variation "${n}":`,e);continue}return await findMatchingChainLocally(e)}catch(n){return console.warn("Error with chain matching API, using local matching:",n.message),await findMatchingChainLocally(e)}}catch(n){return console.warn("Error finding matching chain (non-critical):",n),null}}function generateNameVariations(n){const e=[],o=n.toLowerCase();return o.startsWith("the ")&&e.push(n.substring(4)),o.startsWith("the ")||o.includes("the ")||e.push("The "+n),[" Store"," Location"," #"," - "].forEach((o=>{n.includes(o)&&e.push(n.split(o)[0])})),[...new Set(e)]}function buildInfoWindowContent(n){const e=!0===n.isGooglePlace,o=!!n.chain_id;let t="";n.address1?(t=`<p><strong>Address:</strong><br>${n.address1}`,n.city&&(t+=`, ${n.city}`),n.state&&(t+=`, ${n.state}`),n.zip&&(t+=` ${n.zip}`),t+="</p>"):n.formattedAddress&&(t=`<p><strong>Address:</strong><br>${n.formattedAddress}</p>`);const i=o?`<span style="display:inline-block; background-color:#4285F4; color:white; padding:2px 6px; border-radius:4px; font-size:0.8em; margin-left:5px;">${n.chain_name||"Chain Location"}</span>`:"";let s="";n.type?s=`<p><strong>Type:</strong> ${getBusinessTypeLabel(n.type)}</p>`:e&&n.types&&n.types.length>0&&(s=`<p><strong>Type:</strong> ${getPlaceTypeLabel(n.types)}</p>`);const a=n.distance?`<p><strong>Distance:</strong> ${(n.distance/1609).toFixed(1)} miles</p>`:"",r=e?'<p style="color:#666; font-style:italic;">This business is not yet in the Patriot Thanks database.</p>':"",l=o?`<p style="color:#4285F4; font-size:12px; margin-top:8px;">This location appears to match ${n.chain_name} in our database. Chain-wide incentives may apply.</p>`:"";let c;return c=e?o?`\n                <button style="background-color:#EA4335; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; width:100%;" \n                        onclick="window.addBusinessToDatabase('${n.placeId}', '${n.chain_id}')">\n                    Add ${n.chain_name} Location\n                </button>\n            `:`\n                <button style="background-color:#EA4335; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; width:100%;" \n                        onclick="window.addBusinessToDatabase('${n.placeId}')">\n                    Add to Patriot Thanks\n                </button>\n            `:`\n            <button style="background-color:#4285F4; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; width:100%;" \n                    onclick="window.viewBusinessDetails('${n._id}')">\n                View Details\n            </button>\n        `,`\n        <div style="max-width:280px; font-family:Arial,sans-serif; padding:8px;">\n            <h3 style="margin:0 0 8px 0; font-size:16px; line-height:1.2;">${n.bname} ${i}</h3>\n            ${t}\n            ${s}\n            ${a}\n            ${r}\n            ${l}\n            <div id="incentives-container-${n._id||n.placeId}" style="margin:8px 0;">\n                ${e&&!o?'<p style="margin:4px 0; font-style:italic; color:#666;">Add this business to see available incentives.</p>':'<p style="margin:4px 0;"><em>Loading incentives...</em></p>'}\n            </div>\n            <div style="margin-top:12px; text-align:center;">\n                ${c}\n            </div>\n        </div>\n    `}function getPlaceTypeLabel(n){if(!n||!n.length)return"Business";const e={restaurant:"Restaurant",food:"Food & Dining",store:"Store",establishment:"Business",point_of_interest:"Point of Interest",gas_station:"Gas Station",lodging:"Lodging",cafe:"Cafe",bar:"Bar",hardware_store:"Hardware Store",home_goods_store:"Home Goods",department_store:"Department Store",grocery_or_supermarket:"Grocery Store",furniture_store:"Furniture Store",electronics_store:"Electronics Store",clothing_store:"Clothing Store",shoe_store:"Shoe Store",beauty_salon:"Beauty Salon",hair_care:"Hair Salon",spa:"Spa",pharmacy:"Pharmacy",drugstore:"Pharmacy",bank:"Bank",atm:"ATM",shopping_mall:"Shopping Mall",supermarket:"Supermarket",convenience_store:"Convenience Store",car_dealer:"Car Dealer",car_repair:"Auto Repair",car_wash:"Car Wash",gym:"Gym",hospital:"Hospital",doctor:"Medical",dentist:"Dental",veterinary_care:"Veterinary",movie_theater:"Movie Theater",amusement_park:"Amusement Park",zoo:"Zoo",aquarium:"Aquarium",museum:"Museum",library:"Library",book_store:"Bookstore",jewelry_store:"Jewelry Store",florist:"Florist",pet_store:"Pet Store",bicycle_store:"Bike Shop",sporting_goods_store:"Sporting Goods"};for(const o of n)if(e[o])return e[o];return n[0].replace(/_/g," ").replace(/\b\w/g,(n=>n.toUpperCase()))}function showErrorMessage(n,e){const o=e||document.getElementById("search_table");if(o){o.style.display="block";const e=o.querySelector("tbody");e?e.innerHTML=`<tr><td colspan="5" class="text-center error-message">${n}</td></tr>`:o.innerHTML=`<div class="error-message">${n}</div>`,o.scrollIntoView({behavior:"smooth"})}else alert(n)}function addInitialMapMessage(n){const e=document.createElement("div");e.id="initial-map-message",e.innerHTML="Search for businesses to see them on the map",e.style.position="absolute",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.background="white",e.style.padding="10px",e.style.borderRadius="5px",e.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)",e.style.zIndex="1",n.appendChild(e)}function setupResetMapButton(){const n=document.getElementById("reset-map");n&&n.addEventListener("click",(function(){resetMapView()}))}function resetMapView(){if(mapInitialized&&map)try{safelySetCenter(map,CONFIG.defaultCenter,CONFIG.defaultZoom),infoWindow&&infoWindow.close()}catch(n){console.error("Error resetting map view:",n)}else console.error("Cannot reset map view - map not initialized")}function setupMarkerClickPriority(){map?(console.log("Setting up enhanced marker click priority"),google.maps.event.addListener(map,"click",(function(n){if(n.placeId){const e=n.latLng,o=20,t=map.getProjection();if(!t)return;const i=Math.pow(2,map.getZoom()),s=t.fromLatLngToPoint(e);for(const e of markers){if(!e.position)continue;const a=e.position,r=t.fromLatLngToPoint(a);if(Math.sqrt(Math.pow((s.x-r.x)*i,2)+Math.pow((s.y-r.y)*i,2))<=o)return console.log("Preventing POI click, using our enhanced marker instead"),n.stop(),void setTimeout((()=>{showEnhancedInfoWindow(e)}),10)}}}),{passive:!1})):console.error("Map not initialized, cannot set up click priority")}function initAdditionalMapFeatures(){console.log("Initializing additional map features"),addCustomMarkerStyleFixes(),setupMarkerClickPriority(),customizeInfoWindows()}function addCustomMarkerStyleFixes(){if(!document.getElementById("marker-style-fixes")){const n=document.createElement("style");n.id="marker-style-fixes",n.textContent="\n            /* Ensure proper marker display */\n            .marker-icon {\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                width: 20px;\n                height: 20px;\n                color: #333;\n            }\n            \n            /* Fix for Font Awesome icons */\n            .marker-icon i {\n                font-size: 12px !important;\n                color: #333 !important;\n            }\n            \n            /* Info window styling */\n            .info-window-actions .view-details-btn {\n                margin-top: 8px;\n            }\n        ",document.head.appendChild(n)}}function customizeInfoWindows(){applyInfoWindowScrollableStyles();const n=document.createElement("style");n.textContent="\n        .gm-ui-hover-effect {\n            opacity: 0.8 !important;\n            width: 24px !important;\n            height: 24px !important;\n            right: 2px !important;\n            top: 2px !important;\n        }\n        \n        .gm-ui-hover-effect span {\n            width: 16px !important;\n            height: 16px !important;\n        }\n        \n        .gm-ui-hover-effect:hover {\n            opacity: 1 !important;\n        }\n    ",document.head.appendChild(n)}function applyInfoWindowScrollableStyles(){if(!document.getElementById("info-window-scrollable-styles")){const n=document.createElement("style");n.id="info-window-scrollable-styles",n.textContent="\n            /* Info window structure */\n            .gm-style .gm-style-iw-c {\n                padding: 0 !important;\n                border-radius: 8px !important;\n                box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n                max-width: 330px !important;\n                max-height: 400px !important;\n                overflow: hidden !important;\n            }\n            \n            .gm-style .gm-style-iw-d {\n                overflow: auto !important;\n                max-height: 350px !important;\n                padding-right: 8px !important; /* Allow space for scrollbar */\n            }\n            \n            /* Custom info window styles */\n            .info-window {\n                padding: 12px;\n                max-width: 300px;\n            }\n            \n            .info-window h3 {\n                margin-top: 0;\n                margin-bottom: 10px;\n                color: #212121;\n                font-size: 16px;\n                line-height: 1.3;\n            }\n            \n            .info-window p {\n                margin: 6px 0;\n                font-size: 14px;\n                line-height: 1.4;\n            }\n            \n            .info-window-actions {\n                margin-top: 12px;\n                padding-top: 8px;\n                border-top: 1px solid #eee;\n                text-align: right;\n            }\n            \n            .add-business-btn {\n                background-color: #EA4335;\n                color: white;\n                border: none;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                margin-top: 5px;\n                font-size: 13px;\n                font-weight: 500;\n            }\n            \n            .add-business-btn:hover {\n                background-color: #D32F2F;\n            }\n            \n            .view-details-btn {\n                background-color: #4285F4;\n                color: white;\n                border: none;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                margin-top: 5px;\n                font-size: 13px;\n                font-weight: 500;\n            }\n            \n            .view-details-btn:hover {\n                background-color: #2A75F3;\n            }\n            \n            /* Incentives list */\n            .incentives-list {\n                margin: 8px 0;\n                padding-left: 20px;\n            }\n            \n            .incentives-list li {\n                margin-bottom: 6px;\n            }\n            \n            /* Custom scrollbar styles */\n            .gm-style .gm-style-iw-d::-webkit-scrollbar {\n                width: 6px;\n                height: 6px;\n            }\n            \n            .gm-style .gm-style-iw-d::-webkit-scrollbar-track {\n                background: #f1f1f1;\n                border-radius: 3px;\n            }\n            \n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb {\n                background: #c1c1c1;\n                border-radius: 3px;\n            }\n            \n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb:hover {\n                background: #a8a8a8;\n            }\n            \n            /* Close button adjustment */\n            .gm-ui-hover-effect {\n                top: 2px !important;\n                right: 2px !important;\n            }\n        ",document.head.appendChild(n)}}function fetchBusinessAndCreateMarker(n){console.log("Fetching business data for marker creation:",n);const e=getBaseURL();fetch(`${e}/api/business.js?operation=get&id=${n}`).then((n=>{if(!n.ok)throw new Error(`Failed to fetch business: ${n.status}`);return n.json()})).then((e=>{if(e.result){console.log("Found business data:",e.result);const o=createBusinessMarker(e.result);o&&(map.setCenter(o.position),map.setZoom(15),showEnhancedInfoWindow(o),console.log("Created and focused on new enhanced marker for business:",n))}else console.error("Business data not found"),alert("Business information could not be found.");document.getElementById("map").scrollIntoView({behavior:"smooth"})})).catch((n=>{console.error("Error fetching business data:",n),alert("There was an error getting information for this business."),document.getElementById("map").scrollIntoView({behavior:"smooth"})}))}function isNotEmpty(n){return n&&""!==n.trim()}function validateField(n,e){console.log(`Validating ${n.id} with value: ${n.value}`),e(n.value)?(n.classList.remove("invalid-field"),n.classList.add("valid-field"),n.setAttribute("data-valid","true"),console.log(`${n.id} is VALID`)):(n.classList.remove("valid-field"),n.classList.add("invalid-field"),n.setAttribute("data-valid","false"),console.log(`${n.id} is INVALID`))}function displaySearchResults(n){try{const e=document.getElementById("business_search"),o=document.getElementById("search_table");if(!e||!o)return console.error("Required elements not found in the DOM"),void alert("There was an error displaying search results. Please try again later.");let t=e.querySelector("tbody");if(!t)return console.error("Table body not found within business_search table"),void alert("There was an error displaying search results. Please try again later.");t.innerHTML="",Array.isArray(n)||(console.error("businesses is not an array:",n),n=[]),o.style.display="block";const i=o.querySelector("h5");if(i&&(i.style.display="none"),0===n.length)return t.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria.</td></tr>',void o.scrollIntoView({behavior:"smooth"});const s=n.filter((n=>!n.isGooglePlace)),a=n.filter((n=>n.isGooglePlace&&n.chain_id)),r=n.filter((n=>n.isGooglePlace&&!n.chain_id));console.log(`Businesses to display: ${s.length} from database, ${a.length} chain-matched Places, ${r.length} regular Places`),s.forEach((n=>{addBusinessRow(n,t,!1)})),a.forEach((n=>{addBusinessRow(n,t,!0)})),r.forEach((n=>{addBusinessRow(n,t,!0)})),o.scrollIntoView({behavior:"smooth"})}catch(n){console.error("Error displaying search results: ",n),alert("There was an error displaying the search results: "+n.message)}}function addBusinessRow(n,e,o){if(!n)return;const t=n.address2?`${n.address1}<br>${n.address2}<br>${n.city}, ${n.state} ${n.zip}`:`${n.address1}<br>${n.city}, ${n.state} ${n.zip}`,i=getBusinessTypeLabel(n.type),s=!!n.chain_id,a=!!n.is_chain,r=!!n.isGooglePlace;let l,c="";a?c='<span class="chain-badge">National Chain</span>':s?c='<span class="chain-badge">Chain Location</span>':o&&n.chain_name&&(c=`<span class="chain-badge">Potential ${n.chain_name||"Chain"} Location</span>`),l=a?checkIfUserIsAdmin()?`<button class="admin-action-btn" onclick="handleChainBusinessAction('${n._id}', true)">Admin: Edit Chain</button>`:`<button class="view-chain-btn" onclick="viewChainDetails('${n._id}')">View Chain Info</button>`:r?s?`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${n.place_data?.place_id||n.placeId||""}', '${n.chain_id||""}')">Add Chain Location</button>`:`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${n.place_data?.place_id||n.placeId||""}')">Add to Database</button>`:`<button class="view-map-btn" onclick="focusOnMapMarker('${n._id}')">View on Map</button>`;const d=document.createElement("tr");d.innerHTML=`\n        <th class="left_table" data-business-id="${n._id}">\n            ${n.bname} ${c}\n        </th>\n        <th class="left_table">${t}</th>\n        <th class="left_table">${i}</th>\n        <th class="right_table" id="incentives-for-${n._id}">\n            ${o&&!s?"Not in database yet":"Loading incentives..."}\n        </th>\n        <th class="center_table">${l}</th>\n    `,e.appendChild(d),o&&s?fetchChainIncentivesForPlacesResult(n._id,n.chain_id):r||fetchBusinessIncentives(n._id,n.chain_id)}function fetchBusinessIncentives(n,e=null){if(!n)return void console.error("No business ID provided for fetching incentives");let o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${n}`;e&&(o+=`&chain_id=${e}`),console.log("Fetching incentives from: ",o),fetch(o).then((n=>{if(!n.ok)throw new Error(`Failed to fetch incentives: ${n.status} ${n.statusText}`);return n.json()})).then((e=>{console.log(`Incentives data for business ${n}:`,e);const o=document.getElementById(`incentives-for-${n}`);if(!o)return void console.error(`Could not find cell for incentives-for-${n}`);if(!e.results||0===e.results.length)return void(o.innerHTML="No incentives found");let t="";e.results.forEach((n=>{if(n.is_available){const e=getIncentiveTypeLabel(n.type),o=n.other_description?` (${n.other_description})`:"",i=n.is_chain_wide?'<span class="chain-badge small">Chain-wide</span>':"";t+=`\n                        <div class="incentive-item">\n                            <strong>${e}${o}:</strong> ${n.amount}% ${i}\n                            <div class="incentive-info">${n.information||""}</div>\n                        </div>\n                    `}})),o.innerHTML=""===t?"No active incentives found":t})).catch((e=>{console.error(`Error fetching incentives for business ${n}:`,e);const o=document.getElementById(`incentives-for-${n}`);o&&(o.innerHTML="Error loading incentives")}))}function fetchChainIncentivesForPlacesResult(n,e){if(!n||!e)return void console.error("Missing place ID or chain ID for fetching chain incentives");const o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${e}`;console.log("Fetching chain incentives for Places result: ",o),fetch(o).then((n=>{if(!n.ok)throw new Error(`Failed to fetch chain incentives: ${n.status}`);return n.json()})).then((e=>{console.log(`Chain incentives data for place ${n}:`,e);const o=document.getElementById(`incentives-for-${n}`);if(!o)return void console.error(`Could not find cell for incentives-for-${n}`);if(!e.results||0===e.results.length)return void(o.innerHTML="No chain incentives available");let t="";e.results.forEach((n=>{if(n.is_available){const e=getIncentiveTypeLabel(n.type),o=n.other_description?` (${n.other_description})`:"";t+=`\n                        <div class="incentive-item">\n                            <strong>${e}${o}:</strong> ${n.amount}% \n                            <span class="chain-badge small">Chain-wide</span>\n                            <div class="incentive-info">${n.information||""}</div>\n                        </div>\n                    `}})),o.innerHTML=""===t?"Not in database yet":t})).catch((e=>{console.error(`Error fetching chain incentives for place ${n}:`,e);const o=document.getElementById(`incentives-for-${n}`);o&&(o.innerHTML="Not in database yet")}))}function checkIfUserIsAdmin(){try{const n=localStorage.getItem("patriotThanksSession");if(!n)return!1;const e=JSON.parse(n);return e.user&&(!0===e.user.isAdmin||"Admin"===e.user.level)}catch(n){return console.error("Error checking admin status:",n),!1}}function performIncentivesFetch(n,e){const o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${n}`;console.log("Fetching incentives from:",o),fetch(o).then((n=>{if(!n.ok)throw new Error(`Failed to fetch incentives: ${n.status}`);return n.json()})).then((o=>{if(console.log(`Incentives data for business ${n}:`,o),!o.results||0===o.results.length)return void(e.innerHTML="<p><strong>Incentives:</strong> No incentives found</p>");let t='<p><strong>Incentives:</strong></p><ul style="margin:8px 0; padding-left:20px;">';o.results.forEach((n=>{if(n.is_available){const e=getIncentiveTypeLabel(n.type),o=n.other_description?` (${n.other_description})`:"",i=n.is_chain_wide?'<span style="display:inline-block; background-color:#4285F4; color:white; padding:1px 4px; border-radius:4px; font-size:0.7em; margin-left:5px;">Chain-wide</span>':"";t+=`\n                        <li>\n                            <strong>${e}${o}:</strong> ${n.amount}% ${i}\n                            ${n.information?`<div style="font-size:13px; color:#555; margin-top:2px;">${n.information}</div>`:""}\n                        </li>\n                    `}})),t+="</ul>",e.innerHTML='<p><strong>Incentives:</strong></p><ul style="margin:8px 0; padding-left:20px;"></ul>'===t?"<p><strong>Incentives:</strong> No active incentives found</p>":t})).catch((n=>{console.error(`Error fetching incentives for info window: ${n}`),e.innerHTML="<p><strong>Incentives:</strong> Error loading incentives</p>"}))}function getBusinessTypeTextIcon(n){return`<span style="font-size: 16px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${{AUTO:"ðŸš—",BEAU:"ðŸ’‡",BOOK:"ðŸ“š",CLTH:"ðŸ‘•",CONV:"ðŸª",DEPT:"ðŸ›ï¸",ELEC:"âš¡",ENTR:"ðŸŽ¬",FURN:"ðŸª‘",FUEL:"â›½",GIFT:"ðŸŽ",GROC:"ðŸ›’",HARDW:"ðŸ”¨",HEAL:"â¤ï¸",JEWL:"ðŸ’Ž",OTHER:"ðŸ¬",RX:"ðŸ’Š",REST:"ðŸ½ï¸",RETAIL:"ðŸ›ï¸",SERV:"ðŸ”§",SPEC:"â­",SPRT:"ðŸˆ",TECH:"ðŸ’»",TOYS:"ðŸŽ®"}[n]||"ðŸ¬"}</span>`}function createEnhancedFallbackMarker(n,e){try{console.log("Creating enhanced fallback marker for:",n.bname);let o=createSafeLatLng(e);if(!o&&n.lat&&n.lng&&(o=new google.maps.LatLng(parseFloat(n.lat),parseFloat(n.lng))),!o)return console.error("Invalid location for enhanced fallback marker:",e),null;const t=!n.isGooglePlace,i=(n.chain_id,t?CONFIG.markerColors.primary:CONFIG.markerColors.nearby),s=new google.maps.Marker({position:o,map,title:n.bname,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:i,fillOpacity:.9,strokeWeight:2,strokeColor:"#FFFFFF",scale:t?14:12},animation:google.maps.Animation.DROP,zIndex:t?1e3:100});return s.business=n,s.position=o,s.isFromDatabase=t,s.addListener("click",(function(){console.log("Enhanced fallback marker clicked:",n.bname),showEnhancedInfoWindow(s)})),markers.push(s),console.log(`Added enhanced fallback marker for ${n.bname}`),s}catch(n){return console.error("Error creating enhanced fallback marker:",n),null}}function showEnhancedInfoWindow(n){if(console.log("showEnhancedInfoWindow called with marker:",n),!n||!n.business)return void console.error("Invalid marker for enhanced info window",n);const e=n.business,o=!0===e.isGooglePlace,t=!!e.chain_id;infoWindow&&infoWindow.close(),infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1});const i=buildEnhancedInfoWindowContent(e);infoWindow.setContent(i);let s=n.position;if(!s&&n.getPosition&&(s=n.getPosition()),s||(s=createSafeLatLng(e)),s){try{map.panTo(s)}catch(n){console.warn("Error panning to position:",n)}setTimeout((()=>{try{n.getPosition?infoWindow.open(map,n):(infoWindow.setPosition(s),infoWindow.open(map)),console.log("Enhanced info window opened successfully"),google.maps.event.addListenerOnce(infoWindow,"domready",(function(){setTimeout((()=>{applyEnhancedInfoWindowFixes(),o?t&&(console.log(`Loading chain incentives for place: ${e.placeId}, chain: ${e.chain_id}`),loadChainIncentivesForEnhancedWindow(e.placeId,e.chain_id)):loadIncentivesForEnhancedWindow(e._id)}),200)}))}catch(n){console.error("Error opening enhanced info window:",n)}}),200)}else console.error("Could not determine position for enhanced info window")}function buildEnhancedInfoWindowContent(n){const e=!0===n.isGooglePlace,o=!!n.chain_id;let t="";if(n.address1){t=`<div class="info-address">\n            <strong>ðŸ“ Address:</strong><br>\n            ${n.address1}`,n.address2&&(t+=`<br>${n.address2}`);const e=[];n.city&&e.push(n.city),n.state&&e.push(n.state),n.zip&&e.push(n.zip),e.length>0&&(t+=`<br>${e.join(", ")}`),t+="</div>"}else if(n.formattedAddress){const e=n.formattedAddress.split(",").map((n=>n.trim()));t='<div class="info-address">\n            <strong>ðŸ“ Address:</strong><br>',e.length>=1&&(t+=e[0]),e.length>=2&&(t+=`<br>${e.slice(1).join(", ")}`),t+="</div>"}const i=n.phone?`<div class="info-phone"><strong>ðŸ“ž Phone:</strong> <a href="tel:${n.phone.replace(/\D/g,"")}" style="color: #4285F4; text-decoration: none;">${n.phone}</a></div>`:"";let s="";n.type&&"OTHER"!==n.type&&(s=`<div class="info-type"><strong>ðŸ¢ Type:</strong> ${getBusinessTypeLabel(n.type)}</div>`);const a=n.distance?`<div class="info-distance"><strong>ðŸ“ Distance:</strong> ${(n.distance/1609).toFixed(1)} miles</div>`:"",r=o?`<span class="enhanced-chain-badge">ðŸ”— ${n.chain_name||"Chain Location"}</span>`:"";let l,c="",d="";e?o?(c='<div class="info-status chain-match">ðŸ”— This location appears to match a chain in our database!</div>',d=`<div class="chain-explanation">\n                âœ¨ Great news! This location matches <strong>${n.chain_name}</strong> in our database. \n                Chain-wide incentives should apply to this location once added.\n            </div>`):c='<div class="info-status google-place">â„¹ï¸ This business is not yet in the Patriot Thanks database.</div>':c='<div class="info-status database-business">âœ… This business is in the Patriot Thanks database.</div>',l=e?o?`\n                <button class="enhanced-add-btn chain-add" onclick="window.addBusinessToDatabase('${n.placeId}', '${n.chain_id}')">\n                    ðŸ”— Add ${n.chain_name} Location\n                </button>\n            `:`\n                <button class="enhanced-add-btn" onclick="window.addBusinessToDatabase('${n.placeId}')">\n                    âž• Add to Patriot Thanks\n                </button>\n            `:`\n            <button class="enhanced-view-btn" onclick="window.viewBusinessDetails('${n._id}')">\n                ðŸ‘ï¸ View Details\n            </button>\n        `;const p=n._id||n.placeId;let g;return g=e&&o?"<em>â³ Loading chain incentives...</em>":e&&!o?"<em>ðŸ’¡ Add this business to see available incentives.</em>":"<em>â³ Loading incentives...</em>",`\n        <div class="enhanced-info-window">\n            <div class="info-header">\n                <h3>${n.bname} ${r}</h3>\n            </div>\n            \n            <div class="info-body">\n                ${t}\n                ${i}\n                ${s}\n                ${a}\n                ${c}\n                ${d}\n                \n                <div class="info-incentives">\n                    <div id="incentives-container-${p}">\n                        ${g}\n                    </div>\n                </div>\n            </div>\n            \n            <div class="info-actions">\n                ${l}\n            </div>\n        </div>\n    `}function loadIncentivesForEnhancedWindow(n){const e=document.getElementById(`incentives-container-${n}`);if(!e)return void console.error("Enhanced incentives container not found for business:",n);const o=getBaseURL();fetch(`${o}/api/combined-api.js?operation=incentives&business_id=${n}`).then((n=>n.json())).then((n=>{if(!n.results||0===n.results.length)return void(e.innerHTML="<em>ðŸ’­ No incentives available</em>");let o='<div class="incentives-header"><strong>ðŸŽ Available Incentives:</strong></div>';o+='<div class="incentives-list">',n.results.forEach((n=>{if(n.is_available){const e=getIncentiveTypeLabel(n.type),t=n.other_description?` (${n.other_description})`:"",i=n.is_chain_wide?'<span class="mini-chain-badge">ðŸ”— Chain-wide</span>':"";o+=`\n                        <div class="incentive-item">\n                            <div class="incentive-type">${e}${t}:</div>\n                            <div class="incentive-amount">${n.amount}% ${i}</div>\n                            ${n.information?`<div class="incentive-info">${n.information}</div>`:""}\n                        </div>\n                    `}})),o+="</div>",e.innerHTML=o})).catch((n=>{console.error("Error loading incentives:",n),e.innerHTML="<em>âŒ Error loading incentives</em>"}))}function loadChainIncentivesForEnhancedWindow(n,e){const o=document.getElementById(`incentives-container-${n}`);if(o)loadChainIncentivesInContainer(o,e);else{console.error("Enhanced chain incentives container not found for place:",n);const o=document.getElementById(`incentives-container-google_${n}`);if(o)return console.log("Found alternative container ID format"),void loadChainIncentivesInContainer(o,e);const t=document.querySelectorAll('[id*="incentives-container"]');console.log("Available incentives containers:",Array.from(t).map((n=>n.id)))}}function loadChainIncentivesInContainer(n,e){const o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${e}`;console.log("Loading chain incentives from:",o),fetch(o).then((n=>n.json())).then((e=>{if(!e.results||0===e.results.length)return void(n.innerHTML="<em>ðŸ’­ No chain incentives available</em>");let o='<div class="incentives-header"><strong>ðŸŽ Chain-wide Incentives:</strong></div>';o+='<div class="incentives-list">',e.results.forEach((n=>{if(n.is_available){const e=getIncentiveTypeLabel(n.type),t=n.other_description?` (${n.other_description})`:"";o+=`\n                        <div class="incentive-item chain-incentive">\n                            <div class="incentive-type">${e}${t}:</div>\n                            <div class="incentive-amount">${n.amount}% <span class="mini-chain-badge">ðŸ”— Chain-wide</span></div>\n                            ${n.information?`<div class="incentive-info">${n.information}</div>`:""}\n                        </div>\n                    `}})),o+="</div>",o+='<div class="chain-note">âœ¨ Great! These incentives apply to all locations of this chain.</div>',n.innerHTML=o,console.log("Successfully loaded chain incentives")})).catch((e=>{console.error("Error loading chain incentives:",e),n.innerHTML="<em>âŒ Error loading chain incentives</em>"}))}function applyEnhancedInfoWindowFixes(){const n=document.querySelector(".gm-style-iw-c"),e=document.querySelector(".gm-style-iw-d"),o=document.querySelector(".gm-style-iw-t");if(n){const e=n.getBoundingClientRect();e.width<50&&(n.style.width="auto",n.style.minWidth="300px",n.style.maxWidth="350px"),n.style.padding="0",n.style.margin="0",(e.top<0||e.top>window.innerHeight||e.left<0||e.left>window.innerWidth)&&(n.style.position="relative",n.style.transform="none")}e&&(e.style.padding="0",e.style.margin="0",e.style.overflow="auto",e.style.maxHeight="350px"),o&&(o.style.bottom="0px",o.style.left="50%",o.style.right="auto",o.style.transform="translateX(-50%)"),console.log("Applied enhanced info window fixes with proper padding")}function addEnhancedMarkerStyles(){if(!document.getElementById("enhanced-marker-styles")){const n=document.createElement("style");n.id="enhanced-marker-styles",n.textContent="\n            /* Enhanced marker container */\n            .enhanced-custom-marker {\n                cursor: pointer;\n                transition: transform 0.2s ease;\n                z-index: 100;\n            }\n\n            .enhanced-marker-container {\n                position: relative;\n                width: 36px;\n                height: 46px;\n            }\n\n            /* Enhanced pin styling */\n            .enhanced-marker-pin {\n                width: 32px;\n                height: 40px;\n                border-radius: 50% 50% 50% 0;\n                transform: rotate(-45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                box-shadow: 0 3px 6px rgba(0,0,0,0.3);\n                position: absolute;\n                top: 0;\n                left: 2px;\n                border: 2px solid white;\n            }\n\n            .enhanced-marker-pin.primary {\n                background: linear-gradient(45deg, #EA4335, #FF6B6B);\n            }\n\n            .enhanced-marker-pin.nearby {\n                background: linear-gradient(45deg, #4285F4, #64B5F6);\n            }\n\n            /* Enhanced icon styling */\n            .enhanced-marker-icon {\n                transform: rotate(45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                width: 20px;\n                height: 20px;\n                font-size: 16px;\n                filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5));\n            }\n\n            /* Enhanced shadow */\n            .enhanced-marker-shadow {\n                position: absolute;\n                bottom: -2px;\n                left: 8px;\n                width: 20px;\n                height: 8px;\n                background: radial-gradient(ellipse, rgba(0,0,0,0.3) 0%, transparent 70%);\n                border-radius: 50%;\n                filter: blur(1px);\n            }\n\n            /* Chain indicator */\n            .chain-indicator {\n                position: absolute;\n                top: -5px;\n                right: -5px;\n                background: #FFD700;\n                border-radius: 50%;\n                width: 18px;\n                height: 18px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 10px;\n                border: 2px solid white;\n                box-shadow: 0 1px 3px rgba(0,0,0,0.3);\n                z-index: 1001;\n            }\n\n            /* CRITICAL: Google Maps info window container fixes */\n            .gm-style .gm-style-iw-c {\n                padding: 0 !important;\n                border-radius: 8px !important;\n                box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n                max-width: 350px !important;\n                max-height: 400px !important;\n                overflow: hidden !important;\n            }\n\n            .gm-style .gm-style-iw-d {\n                overflow: auto !important;\n                max-height: 350px !important;\n                padding: 0 !important;\n                /* Add proper padding that Google Maps won't strip */\n                margin: 0 !important;\n            }\n\n            /* Enhanced info window styles with proper padding */\n            .enhanced-info-window {\n                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n                max-width: 320px;\n                line-height: 1.4;\n                /* CRITICAL: Add padding to the content container instead of relying on Google's padding */\n                padding: 12px 12px 12px 12px !important;\n                margin: 0;\n                box-sizing: border-box;\n            }\n\n            .info-header {\n                border-bottom: 2px solid #f0f0f0;\n                padding-bottom: 8px;\n                margin-bottom: 12px;\n            }\n\n            .info-header h3 {\n                margin: 0;\n                font-size: 16px;\n                color: #333;\n                font-weight: 600;\n            }\n\n            .enhanced-chain-badge {\n                display: inline-block;\n                background: linear-gradient(45deg, #4285F4, #64B5F6);\n                color: white;\n                padding: 2px 8px;\n                border-radius: 12px;\n                font-size: 11px;\n                margin-left: 8px;\n                font-weight: 500;\n            }\n\n            .info-body > div {\n                margin: 8px 0;\n                font-size: 14px;\n            }\n\n            .info-address, .info-phone, .info-type, .info-distance {\n                color: #555;\n            }\n\n            .info-status {\n                padding: 6px 10px;\n                border-radius: 6px;\n                font-size: 13px;\n                margin: 10px 0;\n            }\n\n            .info-status.database-business {\n                background-color: #e8f5e8;\n                color: #2e7d32;\n            }\n\n            .info-status.google-place {\n                background-color: #e3f2fd;\n                color: #1565c0;\n            }\n\n            .chain-explanation {\n                background-color: #fff3e0;\n                padding: 8px;\n                border-radius: 6px;\n                font-size: 13px;\n                color: #ef6c00;\n                border-left: 3px solid #ff9800;\n            }\n\n            .info-incentives {\n                margin: 12px 0;\n            }\n\n            .incentives-header {\n                font-weight: 600;\n                color: #333;\n                margin-bottom: 8px;\n            }\n\n            .incentive-item {\n                background-color: #f8f9fa;\n                padding: 8px;\n                border-radius: 6px;\n                margin: 6px 0;\n                border-left: 3px solid #4285F4;\n            }\n\n            .incentive-type {\n                font-weight: 500;\n                color: #333;\n            }\n\n            .incentive-amount {\n                font-size: 16px;\n                font-weight: 600;\n                color: #2e7d32;\n                margin: 2px 0;\n            }\n\n            .incentive-info {\n                font-size: 12px;\n                color: #666;\n                font-style: italic;\n                margin-top: 4px;\n            }\n\n            .mini-chain-badge {\n                background: #4285F4;\n                color: white;\n                padding: 1px 6px;\n                border-radius: 8px;\n                font-size: 10px;\n                margin-left: 4px;\n            }\n\n            .chain-note {\n                font-size: 12px;\n                color: #666;\n                font-style: italic;\n                margin-top: 8px;\n                padding: 4px 8px;\n                background-color: #f0f8ff;\n                border-radius: 4px;\n            }\n\n            .info-actions {\n                margin-top: 12px;\n                padding-top: 12px;\n                border-top: 1px solid #eee;\n                text-align: center;\n                /* Add bottom margin to ensure spacing at bottom */\n                margin-bottom: 4px;\n            }\n\n            .enhanced-add-btn, .enhanced-view-btn {\n                background: linear-gradient(45deg, #4285F4, #64B5F6);\n                color: white;\n                border: none;\n                padding: 10px 20px;\n                border-radius: 8px;\n                cursor: pointer;\n                font-weight: 500;\n                font-size: 14px;\n                transition: all 0.2s ease;\n                width: 100%;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n            }\n\n            .enhanced-add-btn {\n                background: linear-gradient(45deg, #EA4335, #FF6B6B);\n            }\n\n            .enhanced-add-btn:hover, .enhanced-view-btn:hover {\n                transform: translateY(-1px);\n                box-shadow: 0 4px 8px rgba(0,0,0,0.15);\n            }\n\n            /* ENHANCED SCROLLBAR - More visible and styled */\n            .gm-style .gm-style-iw-d::-webkit-scrollbar {\n                width: 8px;\n                height: 8px;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-track {\n                background: #f1f1f1;\n                border-radius: 4px;\n                border: 1px solid #e0e0e0;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb {\n                background: linear-gradient(180deg, #4285F4, #64B5F6);\n                border-radius: 4px;\n                border: 1px solid #3367D6;\n                box-shadow: inset 0 1px 2px rgba(255,255,255,0.3);\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb:hover {\n                background: linear-gradient(180deg, #3367D6, #4285F4);\n                cursor: pointer;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb:active {\n                background: linear-gradient(180deg, #2A56C6, #3367D6);\n            }\n\n            /* Add padding indicator when content is scrollable */\n            .gm-style .gm-style-iw-d::before {\n                content: '';\n                display: block;\n                height: 1px;\n                width: 100%;\n                background: transparent;\n            }\n\n            .gm-style .gm-style-iw-d::after {\n                content: '';\n                display: block;\n                height: 1px;\n                width: 100%;\n                background: transparent;\n            }\n\n            /* Responsive adjustments */\n            @media (max-width: 400px) {\n                .enhanced-info-window {\n                    max-width: 280px;\n                    padding: 10px 10px 10px 10px !important;\n                }\n                \n                .enhanced-marker-container {\n                    width: 32px;\n                    height: 42px;\n                }\n                \n                .enhanced-marker-pin {\n                    width: 28px;\n                    height: 36px;\n                }\n\n                .gm-style .gm-style-iw-d::-webkit-scrollbar {\n                    width: 6px;\n                }\n            }\n\n            /* Fix for tail positioning */\n            .gm-style .gm-style-iw-t {\n                bottom: 0px !important;\n                left: 50% !important;\n                right: auto !important;\n                transform: translateX(-50%) !important;\n                width: 20px !important;\n                height: 15px !important;\n            }\n\n            /* Ensure close button is properly positioned */\n            .gm-ui-hover-effect {\n                opacity: 0.8 !important;\n                top: 8px !important;\n                right: 8px !important;\n                width: 24px !important;\n                height: 24px !important;\n                z-index: 1002 !important;\n            }\n\n            .gm-ui-hover-effect:hover {\n                opacity: 1 !important;\n            }\n        ",document.head.appendChild(n)}}function createBusinessMarker(n){try{if(!n.lat||!n.lng||isNaN(parseFloat(n.lat))||isNaN(parseFloat(n.lng)))return console.warn(`Invalid coordinates for business: ${n.bname}`),null;const e=new google.maps.LatLng(parseFloat(n.lat),parseFloat(n.lng)),o=createEnhancedBusinessMarker(n,e);return o&&bounds&&bounds.extend(e),o}catch(n){return console.error("Error creating business marker:",n),null}}function searchNearbyBusinesses(n,e){try{console.log("Searching for nearby similar businesses near",n.lat(),n.lng()),console.log("Primary business type:",e);const o=getSimilarBusinessTypes(e);if(console.log("Looking for similar business types:",o),0===o.length)return void console.log("No similar business types defined for:",e);const t=getBaseURL(),i=o.map((e=>{const o=`${t}/api/business.js?operation=search&type=${e}&lat=${n.lat()}&lng=${n.lng()}&radius=15`;return console.log("Searching for similar businesses:",o),fetch(o).then((n=>{if(!n.ok)throw new Error(`Failed to fetch businesses of type ${e}: ${n.status}`);return n.json()})).then((n=>({businessType:e,results:n.results||[]})))}));Promise.all(i).then((e=>{let o=[];if(e.forEach((n=>{n.results.length>0&&(console.log(`Found ${n.results.length} businesses of type ${n.businessType}`),o=o.concat(n.results))})),0===o.length)return void console.log("No similar businesses found in the area");console.log(`Found ${o.length} total potential similar businesses`);const t=markers.map((n=>n.business?._id)).filter((n=>n)),i=markers.map((n=>n.business?.bname.toLowerCase())).filter((n=>n)),s=o.filter((n=>{if(t.includes(n._id))return!1;const e=n.bname.toLowerCase();return!i.some((n=>e.includes(n)||n.includes(e)))}));console.log(`${s.length} new similar businesses to add to map`);let a=0;s.forEach((e=>{e.isNearby=!0,e.isSimilarBusiness=!0;const o=getBusinessLocation(e);if(o){const t=new google.maps.LatLng(o.lat,o.lng),i=google.maps.geometry.spherical.computeDistanceBetween(n,t);i<=24140?createSimilarBusinessMarker(e,t)&&(a++,console.log(`Added similar business: ${e.bname} (${(i/1609).toFixed(1)} miles) - ${getBusinessTypeLabel(e.type)}`)):console.log(`Skipping distant similar business: ${e.bname} (${(i/1609).toFixed(1)} miles)`)}else console.warn(`Similar business ${e.bname} missing coordinates`)})),console.log(`Added ${a} similar businesses with blue markers`)})).catch((n=>{console.error("Error searching for similar businesses:",n)}))}catch(n){console.error("Error in searchNearbyBusinesses:",n)}}function getSimilarBusinessTypes(n){return({HARDW:["HARDW","DEPT"],REST:["REST"],GROC:["GROC","CONV"],DEPT:["DEPT","RETAIL","HARDW"],CLTH:["CLTH","DEPT"],ELEC:["ELEC","DEPT","TECH"],FURN:["FURN","DEPT"],AUTO:["AUTO","FUEL"],BEAU:["BEAU","RX"],RX:["RX","BEAU","GROC"],ENTR:["ENTR"],SPRT:["SPRT","DEPT"],FUEL:["FUEL","CONV"],CONV:["CONV","FUEL","GROC"],SERV:["SERV"],OTHER:["OTHER","RETAIL"]}[n]||[n]).filter((e=>e!==n))}function getBusinessLocation(n){let e,o;if(n.location&&n.location.coordinates&&Array.isArray(n.location.coordinates)&&n.location.coordinates.length>=2)o=n.location.coordinates[0],e=n.location.coordinates[1];else{if(void 0===n.lat||void 0===n.lng)return null;e=parseFloat(n.lat),o=parseFloat(n.lng)}return isNaN(e)||isNaN(o)?null:{lat:e,lng:o}}function createSimilarBusinessMarker(n,e){try{return n.lat=e.lat(),n.lng=e.lng(),createEnhancedBusinessMarker(n,e,!0)}catch(o){return console.error("Error creating similar business marker:",o),createEnhancedFallbackMarker(n,e)}}async function createEnhancedBusinessMarker(n,e,o=!1){try{const{AdvancedMarkerElement:t}=await google.maps.importLibrary("marker");let i=createSafeLatLng(e);if(!i)return console.error("Invalid position for enhanced marker:",e),createEnhancedFallbackMarker(n,e);const s=!n.isGooglePlace;let a,r;o||!0===n.isNearby||!0===n.isSimilarBusiness||n.isSimilarBusiness?(a=CONFIG.markerColors.nearby,r="nearby"):s?(a=CONFIG.markerColors.primary,r="primary"):(a=CONFIG.markerColors.nearby,r="nearby");const l=getBusinessTypeTextIcon(n.type),c=document.createElement("div");c.className="enhanced-custom-marker",c.setAttribute("title",n.bname),c.style.cursor="pointer",c.innerHTML=`\n            <div class="enhanced-marker-container">\n                <div class="enhanced-marker-pin ${r}" style="background-color: ${a};">\n                    <div class="enhanced-marker-icon">\n                        ${l}\n                    </div>\n                </div>\n                <div class="enhanced-marker-shadow"></div>\n                ${n.chain_id?'<div class="chain-indicator">â­</div>':""}\n                ${n.isSimilarBusiness?'<div class="similar-indicator">â‰ˆ</div>':""}\n            </div>\n        `;const d=new t({position:i,map,title:n.bname,content:c,collisionBehavior:s?"REQUIRED_AND_HIDES_OPTIONAL":"OPTIONAL_AND_HIDES_LOWER_PRIORITY"});return d.business=n,d.position=i,d.isFromDatabase=s,d.isSimilarBusiness=n.isSimilarBusiness||o,c.addEventListener("click",(function(e){console.log("Enhanced similar business marker clicked:",n.bname),e.stopPropagation(),showEnhancedInfoWindow(d)})),c.addEventListener("mouseenter",(function(){c.style.transform="scale(1.1)",c.style.zIndex="1000"})),c.addEventListener("mouseleave",(function(){c.style.transform="scale(1)",c.style.zIndex="auto"})),markers.push(d),console.log(`Added enhanced ${n.isSimilarBusiness?"similar business":""} marker for ${n.bname}`),d}catch(o){return console.error("Error creating enhanced marker:",o),createEnhancedFallbackMarker(n,e)}}document.addEventListener("DOMContentLoaded",(function(){setTimeout((()=>{applyInfoWindowCSS()}),500)})),"undefined"!=typeof window&&(window.showInfoWindow=showInfoWindow,window.fixInfoWindowPositioning=fixInfoWindowPositioning),window.testTailFix=function(){console.log("Testing tail fix...");const n=document.getElementById("css-only-tail-fix");n&&(n.remove(),console.log("Removed existing tail fix")),applyCSSOnlyTailFix(),infoWindow&&(infoWindow.close(),console.log("Closed info window. Click a marker to test the tail fix."))},window.testInfoWindow=function(){console.log("=== TESTING INFO WINDOW SETUP ==="),removeAggressiveCSS(),applyBasicInfoWindowCSS(),infoWindow&&infoWindow.close(),console.log("Reset complete. Try clicking a marker now."),console.log("If it still doesn't work, run: checkAndReportInfoWindowPosition()")},document.addEventListener("DOMContentLoaded",(function(){setTimeout((()=>{applyCSSOnlyTailFix()}),500)})),console.log("Step-by-step info window fix loaded. Run testInfoWindow() in console to reset everything."),document.addEventListener("DOMContentLoaded",(function(){setTimeout((()=>{applyInfoWindowPositioningFixes()}),500)})),window.debugInfoWindow=function(){console.log("Starting info window debug..."),removeProblematicInfoWindowCSS(),infoWindow&&infoWindow.close(),console.log("Ready for testing - try clicking a marker now")},document.addEventListener("DOMContentLoaded",(function(){setTimeout((()=>{removeProblematicInfoWindowCSS()}),1e3)})),console.log("Google Places address parsing fix loaded successfully!"),window.initGoogleMap=function(){console.log("Enhanced initGoogleMap function called");try{applyMapHeightFix();const n=document.getElementById("map");if(!n)return void console.error("Map container not found in the DOM");console.log("Map container dimensions:",n.offsetWidth,"x",n.offsetHeight),map?(console.log("Map already exists, applying height fix and triggering resize"),applyMapHeightFix(),setTimeout((()=>{google.maps.event.trigger(map,"resize")}),100)):(map=new google.maps.Map(n,{center:CONFIG.defaultCenter,zoom:CONFIG.defaultZoom,mapId:CONFIG.mapId||"ebe8ec43a7bc252d",clickableIcons:!0,gestureHandling:"greedy",zoomControl:!0,mapTypeControl:!1,scaleControl:!0,streetViewControl:!1,rotateControl:!1,fullscreenControl:!0}),console.log("Map object created with enhanced settings:",!!map),infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1,pixelOffset:new google.maps.Size(0,-10)}),bounds=new google.maps.LatLngBounds,addInitialMapMessage(n),setupResetMapButton(),mapInitialized=!0,console.log("Google Map successfully initialized with enhanced settings"),pendingBusinessesToDisplay.length>0&&(console.log("Processing pending businesses to display on map"),displayBusinessesOnMap(pendingBusinessesToDisplay),pendingBusinessesToDisplay=[]),setupMapClickHandler(),setupMarkerClickPriority(),initAdditionalMapFeatures(),setTimeout((()=>{google.maps.event.trigger(map,"resize")}),200))}catch(n){console.error("Error initializing Google Map:",n),mapInitialized=!1;const e=document.getElementById("map");e&&(e.innerHTML=`\n                <div style="text-align: center; padding: 20px;">\n                    <p>Sorry, we couldn't load the map. Please try refreshing the page.</p>\n                    <p>Error: ${n.message}</p>\n                </div>\n            `)}},window.debugEnhancedMarkers=function(){console.log("=== ENHANCED MARKER DEBUG ==="),console.log("Total markers:",markers.length),markers.forEach(((n,e)=>{console.log(`Marker ${e}:`,{business:n.business?.bname,isFromDatabase:n.isFromDatabase,position:n.position,hasAdvancedMarker:n instanceof google.maps.marker?.AdvancedMarkerElement})})),console.log("Enhanced styles loaded:",!!document.getElementById("enhanced-marker-styles")),console.log("=== END DEBUG ===")},console.log("Enhanced marker integration loaded successfully!"),console.log("Run debugEnhancedMarkers() in console to check marker status"),window.focusOnMapMarker=function(n){if(console.log("focusOnMapMarker called for business ID:",n),!mapInitialized||!map)return console.error("Map not initialized yet - cannot focus on marker"),void alert("Map is still loading. Please try again in a moment.");if(!markers||0===markers.length)return console.warn("No markers available yet."),void fetchBusinessAndCreateMarker(n);const e=markers.find((e=>e.business&&e.business._id===n));if(e)try{let o;if(e.getPosition&&"function"==typeof e.getPosition)o=e.getPosition();else if(e.position)o=e.position;else{if(!(e.business&&e.business.lat&&e.business.lng))return console.error("Could not determine marker position"),void alert("Could not focus on this business on the map.");o=new google.maps.LatLng(parseFloat(e.business.lat),parseFloat(e.business.lng))}map.setCenter(o),map.setZoom(16),showEnhancedInfoWindow(e),document.getElementById("map").scrollIntoView({behavior:"smooth"}),console.log("Successfully focused on marker for business:",n)}catch(n){console.error("Error focusing on marker:",n),alert("There was an error focusing on this business on the map.")}else console.warn(`No marker found for business ID: ${n}`),fetchBusinessAndCreateMarker(n)},document.addEventListener("DOMContentLoaded",(function(){console.log("DOM loaded, initializing enhanced business search..."),addEnhancedMarkerStyles(),setTimeout((()=>{applyInfoWindowPositioningFixes(),applyMapHeightFix()}),500),addCustomMarkerStyles(),addChainBadgeStyles(),initBusinessSearch(),checkForNewlyAddedBusiness(),window.google&&window.google.maps?(console.log("Google Maps already loaded, initializing map"),initGoogleMap()):console.log("Google Maps not yet loaded, will be initialized via callback")})),console.log("Enhanced nearby similar businesses functionality loaded!"),"undefined"!=typeof window&&(window.retrieveFromMongoDB=retrieveFromMongoDB,window.searchGooglePlacesForBusiness=searchGooglePlacesForBusiness,window.searchGooglePlacesForBusinessLegacy=searchGooglePlacesForBusinessLegacy,window.loadChainIncentivesForEnhancedWindow=loadChainIncentivesForEnhancedWindow,window.loadChainIncentivesInContainer=loadChainIncentivesInContainer,window.showEnhancedInfoWindow=showEnhancedInfoWindow,window.findMatchingChainForPlaceResult=findMatchingChainForPlaceResult,window.generateNameVariations=generateNameVariations,window.findMatchingChainLocally=findMatchingChainLocally,window.buildEnhancedInfoWindowContent=buildEnhancedInfoWindowContent,window.showNoResultsMessage=showNoResultsMessage,window.displayBusinessesOnMap=displayBusinessesOnMap,window.displaySearchResults=displaySearchResults,window.initGoogleMap=initGoogleMap,window.debugMapState=debugMapState,window.validateField=validateField,window.isNotEmpty=isNotEmpty,window.setupMapClickHandler=setupMapClickHandler,window.buildInfoWindowContent=buildInfoWindowContent,window.getPlaceTypeLabel=getPlaceTypeLabel,window.safeExtractCoordinates=safeExtractCoordinates,window.showInfoWindow=showInfoWindow,window.withErrorHandling=withErrorHandling,window.createEnhancedBusinessMarker=createEnhancedBusinessMarker,window.showEnhancedInfoWindow=showEnhancedInfoWindow,window.buildEnhancedInfoWindowContent=buildEnhancedInfoWindowContent,window.addEnhancedMarkerStyles=addEnhancedMarkerStyles,window.getBusinessTypeTextIcon=getBusinessTypeTextIcon,window.createEnhancedFallbackMarker=createEnhancedFallbackMarker,window.createEnhancedBusinessMarker=createEnhancedBusinessMarker,window.addEnhancedMarkerStyles=addEnhancedMarkerStyles,window.createBusinessMarker=createBusinessMarker,window.searchNearbyBusinesses=searchNearbyBusinesses,window.getSimilarBusinessTypes=getSimilarBusinessTypes,window.getBusinessLocation=getBusinessLocation,window.createSimilarBusinessMarker=createSimilarBusinessMarker);