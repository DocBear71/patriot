const CONFIG={mapId:"ebe8ec43a7bc252d",defaultCenter:{lat:39.8283,lng:-98.5795},defaultZoom:4,markerColors:{primary:"#EA4335",nearby:"#4285F4",database:"#28a745",chain:"#FF9800"},geocodeDelay:200,imageLoadDelay:1e3,maxNearbyDistance:2e4,debugMode:!1},ENHANCED_CONFIG={...CONFIG,markerColors:{primary:"#EA4335",nearby:"#4285F4",database:"#28a745",chain:"#FF9800"}};let map=null,mapInitialized=!1,markers=[],infoWindow=null,bounds=null,pendingBusinessesToDisplay=[],currentSearchLocation=null;const placeCache=new Map;function clearMarkers(){markers?(markers.forEach((e=>{e&&(e.map=null)})),markers=[]):markers=[]}function debugMapState(){if(console.log("==== MAP DEBUGGING INFO ===="),console.log("Map initialized:",mapInitialized),console.log("Map object exists:",!!map),map)try{const e=map.getCenter();console.log("Map center:",e?`${e.lat()}, ${e.lng()}`:"undefined"),console.log("Map zoom:",map.getZoom()),console.log("Map type:",map.getMapTypeId()),console.log("Map ID:",map.getMapId())}catch(e){console.error("Error getting map properties:",e)}if(console.log("Markers count:",markers?markers.length:0),markers&&markers.length>0&&(console.log("Markers summary:"),markers.forEach(((e,n)=>{try{let o;e.getPosition?o=e.getPosition():e.position&&(o=e.position);const s=o?"function"==typeof o.lat?`${o.lat()}, ${o.lng()}`:`${o.lat}, ${o.lng}`:"unknown";console.log(`  Marker #${n}: Business: ${e.business?e.business.bname:"unknown"}, Position: ${s}`)}catch(e){console.error(`  Error getting marker #${n} info:`,e)}}))),console.log("Bounds:",bounds?"exists":"not created"),bounds)try{const e=bounds.getNorthEast(),n=bounds.getSouthWest();if(console.log("  NE:",e?`${e.lat()}, ${e.lng()}`:"undefined"),console.log("  SW:",n?`${n.lat()}, ${n.lng()}`:"undefined"),console.log("  Empty:",bounds.isEmpty()),e&&n){const o=isNaN(e.lat())||isNaN(e.lng())||isNaN(n.lat())||isNaN(n.lng());console.log("  Has NaN coordinates:",o)}}catch(e){console.error("  Error getting bounds info:",e)}console.log("Map container:",document.getElementById("map")?"found":"not found");const e=document.getElementById("map");e&&(console.log("  Display:",window.getComputedStyle(e).display),console.log("  Dimensions:",`${e.offsetWidth} √ó ${e.offsetHeight}`),console.log("  Position:",e.style.position),console.log("  Visibility:",window.getComputedStyle(e).visibility),console.log("  Z-index:",window.getComputedStyle(e).zIndex)),console.log("Google Maps libraries:"),console.log("  maps:",!!google.maps),console.log("  places:",!!google.maps.places),console.log("  geometry:",!!google.maps.geometry),console.log("  marker:",!!google.maps.marker),console.log("Google Maps API Key:",getGoogleMapsApiKey()?"found":"not found"),console.log("Current search location:",currentSearchLocation?`${currentSearchLocation.lat}, ${currentSearchLocation.lng}`:"none"),console.log("==== END DEBUGGING INFO ====")}function isValidPosition(e){if(!e)return console.warn("Position is null or undefined"),!1;let n,o;if(e instanceof google.maps.LatLng)try{n=e.lat(),o=e.lng()}catch(e){return console.warn("Error getting lat/lng from LatLng:",e),!1}else if("function"==typeof e.lat&&"function"==typeof e.lng)try{n=e.lat(),o=e.lng()}catch(e){return console.warn("Error calling lat/lng functions:",e),!1}else{if(void 0===e.lat||void 0===e.lng)return console.warn("Position does not have lat/lng properties"),!1;n=parseFloat(e.lat),o=parseFloat(e.lng)}return isNaN(n)||isNaN(o)?(console.warn("Position has NaN coordinates:",n,o),!1):isFinite(n)&&isFinite(o)?!(Math.abs(n)>90||Math.abs(o)>180)||(console.warn("Position coordinates out of range:",n,o),!1):(console.warn("Position has non-finite coordinates:",n,o),!1)}function createSafeLatLng(e){if(!e)return null;try{if(e instanceof google.maps.LatLng)return isValidPosition(e)?e:null;let n,o;if("function"==typeof e.lat&&"function"==typeof e.lng)n=e.lat(),o=e.lng();else if(void 0!==e.lat&&void 0!==e.lng)n=parseFloat(e.lat),o=parseFloat(e.lng);else if(void 0!==e.latitude&&void 0!==e.longitude)n=parseFloat(e.latitude),o=parseFloat(e.longitude);else{if(!(Array.isArray(e)&&e.length>=2))return console.warn("Position format not recognized:",e),null;n=parseFloat(e[0]),o=parseFloat(e[1])}return isNaN(n)||isNaN(o)||!isFinite(n)||!isFinite(o)?(console.warn("Invalid coordinates:",n,o),null):Math.abs(n)>90||Math.abs(o)>180?(console.warn("Coordinates out of range:",n,o),null):new google.maps.LatLng(n,o)}catch(e){return console.error("Error creating LatLng:",e),null}}function safelySetCenter(e,n,o){if(!e)return!1;try{const s=createSafeLatLng(n);return!!s&&(e.setCenter(s),void 0!==o&&e.setZoom(o),!0)}catch(e){return console.error("Error setting map center:",e),!1}}function safelyFitBounds(e,n,o=11){if(!e||!n)return!1;try{const o=n.getNorthEast(),s=n.getSouthWest();return!o||!s||isNaN(o.lat())||isNaN(o.lng())||isNaN(s.lat())||isNaN(s.lng())?(console.warn("Invalid bounds for fitBounds:",n),!1):n.isEmpty()?(console.warn("Empty bounds, not fitting"),!1):(e.fitBounds(n),google.maps.event.addListenerOnce(e,"bounds_changed",(function(){const n=e.getZoom();n>16?e.setZoom(16):n<4&&e.setZoom(4)})),!0)}catch(n){console.error("Error fitting bounds:",n);try{void 0!==o&&e.setZoom(o)}catch(e){console.error("Error setting fallback zoom:",e)}return!1}}function createNewBounds(){return new google.maps.LatLngBounds}let googleMapsInitializing=!1,googleMapsInitialized=!1;function ensureGoogleMapsInitialized(){return googleMapsInitialized||googleMapsInitializing?(console.log("Google Maps already initialized or initializing"),Promise.resolve()):new Promise(((e,n)=>{try{if(googleMapsInitializing=!0,console.log("Starting Google Maps initialization"),window.google&&window.google.maps)return console.log("Google Maps API is already loaded, just initializing map"),initGoogleMap(),googleMapsInitialized=!0,googleMapsInitializing=!1,void e();const o=window.appConfig?.googleMapsApiKey||getGoogleMapsApiKey(),s=window.appConfig?.googleMapsMapId||CONFIG.mapId;window.initGoogleMapCallback=function(){console.log("Google Maps callback executed"),initGoogleMap(),googleMapsInitialized=!0,googleMapsInitializing=!1,e()};const t=document.createElement("script");t.src=`https://maps.googleapis.com/maps/api/js?key=${o}&map_ids=${s}&libraries=places,geometry,marker&callback=initGoogleMapCallback&loading=async&v=weekly`,t.async=!0,t.defer=!0,t.onerror=function(e){console.error("Google Maps API failed to load:",e),googleMapsInitializing=!1,n(e)},document.head.appendChild(t)}catch(e){googleMapsInitializing=!1,console.error("Error initializing Google Maps:",e),n(e)}}))}function addCustomMarkerStyles(){if(!document.getElementById("custom-marker-css")){const e=document.createElement("style");e.id="custom-marker-css",e.textContent='\n            .custom-marker {\n                cursor: pointer;\n            }\n            \n            .marker-container {\n                position: relative;\n                width: 32px;\n                height: 40px;\n            }\n            \n            .marker-pin {\n                width: 32px;\n                height: 40px;\n                border-radius: 50% 50% 50% 0;\n                background-color: #EA4335;\n                transform: rotate(-45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n                position: absolute;\n                top: 0;\n                left: 0;\n            }\n            \n            .marker-pin.nearby {\n                background-color: #4285F4;\n            }\n            \n            .marker-icon {\n                transform: rotate(45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                width: 20px;\n                height: 20px;\n            }\n            \n            /* Critical fix - ensure Font Awesome icons are visible */\n            .marker-icon i.fas,\n            .marker-icon i.fa,\n            .marker-icon i.far,\n            .marker-icon i.fab {\n                display: inline-block !important;\n                font-size: 14px !important;\n                color: white !important;\n                line-height: 1 !important;\n                width: auto !important;\n                height: auto !important;\n                vertical-align: middle !important;\n            }\n            \n            /* Fallback icon content for missing Font Awesome */\n            .marker-icon i.fas.fa-store-alt:after {\n                content: "üè™";\n                font-family: sans-serif;\n                font-size: 14px;\n            }\n            \n            .marker-icon i.fas.fa-shopping-cart:after {\n                content: "üõí";\n                font-family: sans-serif;\n                font-size: 14px;\n            }\n            \n            .marker-shadow {\n                background-color: rgba(0, 0, 0, 0.2);\n                border-radius: 50%;\n                height: 14px;\n                width: 14px;\n                position: absolute;\n                bottom: -3px;\n                left: 9px;\n                filter: blur(2px);\n                z-index: -1;\n            }\n            \n            /* Info window action button styling */\n            .info-window-actions {\n                margin-top: 12px;\n                padding-top: 8px;\n                border-top: 1px solid #eee;\n                text-align: right;\n            }\n            \n            .info-window-actions .add-business-btn,\n            .info-window-actions .view-details-btn {\n                margin-top: 8px;\n                font-weight: bold;\n                text-transform: uppercase;\n                font-size: 12px;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                transition: background-color 0.2s ease;\n                border: none;\n                color: white;\n                letter-spacing: 0.5px;\n                display: inline-block;\n            }\n            \n            .info-window-actions .add-business-btn {\n                background-color: #EA4335;\n            }\n            \n            .info-window-actions .add-business-btn:hover {\n                background-color: #D32F2F;\n            }\n            \n            .info-window-actions .view-details-btn {\n                background-color: #4285F4;\n            }\n            \n            .info-window-actions .view-details-btn:hover {\n                background-color: #2A75F3;\n            }\n        ',document.head.appendChild(e)}}function addChainBadgeStyles(){if(!document.getElementById("chain-badge-css")){const e=document.createElement("style");e.id="chain-badge-css",e.textContent="\n            .chain-badge {\n                display: inline-block;\n                background-color: #4285F4;\n                color: white;\n                padding: 2px 6px;\n                border-radius: 4px;\n                font-size: 0.8em;\n                margin-left: 5px;\n                font-weight: normal;\n            }\n\n            .chain-badge.small {\n                font-size: 0.7em;\n                padding: 1px 4px;\n            }\n            \n            .admin-action-btn {\n                background-color: #673AB7;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .view-chain-btn {\n                background-color: #2196F3;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .add-to-db-btn {\n                background-color: #4CAF50;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .view-map-btn {\n                background-color: #FF9800;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n        ",document.head.appendChild(e)}}function getUserLocation(){return new Promise(((e,n)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition((n=>{const o={lat:n.coords.latitude,lng:n.coords.longitude};console.log("Got user location:",o),e(o)}),(e=>{console.warn("Error getting location:",e),n(e)}),{enableHighAccuracy:!0,timeout:5e3,maximumAge:0}):(console.warn("Geolocation not supported by this browser"),n(new Error("Geolocation not supported")))}))}async function getChainDetails(e){if(!e)return null;const n=getBaseURL();try{const o=await fetch(`${n}/api/business.js?operation=get&id=${e}`);if(!o.ok)throw new Error(`Failed to get chain details: ${o.status}`);const s=await o.json();return s.result?s.result:null}catch(e){return console.error("Error getting chain details:",e),null}}function getAddressComponent(e,n){if(!e||!Array.isArray(e))return"";const o=e.find((e=>e.types&&e.types.includes(n)));return o&&(o.shortText||o.short_name)||""}function getAddressComponentFromPlace(e,n){if(!e.addressComponents)return"";const o=e.addressComponents.find((e=>e.types.includes(n)));return o?o.shortText:""}function getBusinessTypeLabel(e){return{AUTO:"Automotive",BEAU:"Beauty",BOOK:"Bookstore",CLTH:"Clothing",CONV:"Convenience Store/Gas Station",DEPT:"Department Store",ELEC:"Electronics",ENTR:"Entertainment",FURN:"Furniture",FUEL:"Fuel Station/Truck Stop",GIFT:"Gift Shop",GROC:"Grocery",HARDW:"Hardware",HEAL:"Health",JEWL:"Jewelry",OTHER:"Other",RX:"Pharmacy",REST:"Restaurant",RETAIL:"Retail",SERV:"Service",SPEC:"Specialty",SPRT:"Sporting Goods",TECH:"Technology",TOYS:"Toys"}[e]||e}function getIncentiveTypeLabel(e){return{VT:"Veteran",AD:"Active Duty",FR:"First Responder",SP:"Spouse",OT:"Other"}[e]||e}function getBaseURL(){return"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:window.location.origin}function initBusinessSearch(){console.log("Business search initialization...");const e={businessName:document.getElementById("business-name"),address:document.getElementById("address"),useMyLocation:document.getElementById("use-my-location")},n=document.getElementById("business-search-form");n?n.addEventListener("submit",(async function(n){if(n.preventDefault(),!e.businessName?.value&&!e.address?.value&&!e.useMyLocation?.checked)return void alert("Please enter either a business name, an address, or use your current location to search");const o={businessName:e.businessName?.value||"",address:e.address?.value||"",useMyLocation:e.useMyLocation?.checked||!1};if(console.log("Form data to submit:",o),mapInitialized){clearMarkers();const e=document.getElementById("initial-map-message");e&&e.remove(),await performEnhancedBusinessSearch(o,!1)}else console.warn("Map not initialized yet. Will initialize and display businesses after map loads."),ensureGoogleMapsInitialized().then((async()=>{clearMarkers(),await performEnhancedBusinessSearch(o,!1)})).catch((e=>{console.error("Failed to initialize Google Maps:",e),alert("There was a problem loading the map. Please try refreshing the page.")}))})):console.warn("Business search form not found in the DOM"),e.businessName&&e.businessName.addEventListener("input",(function(){validateField(this,isNotEmpty)})),e.address&&e.address.addEventListener("input",(function(){validateField(this,isNotEmpty)})),e.useMyLocation&&e.useMyLocation.addEventListener("change",(function(){const n=document.getElementById("location-status");this.checked?(e.address&&(e.address.disabled=!0,e.address.placeholder="Using your current location..."),n&&(n.textContent="Location will be used when you search",n.style.display="block",n.style.color="#666")):(e.address&&(e.address.disabled=!1,e.address.placeholder="Address, City, State, or Zip"),n&&(n.style.display="none"))})),addRefreshButton(),checkForNewlyAddedBusiness()}function addRefreshButton(){const e=document.getElementById("business-search-form");if(!e)return;if(document.getElementById("refresh-search-btn"))return;const n=document.createElement("button");n.id="refresh-search-btn",n.type="button",n.className="refresh-btn",n.innerHTML='<i class="fas fa-sync-alt"></i> Refresh Results',n.style.marginLeft="10px",n.style.backgroundColor="#28a745",n.style.color="white",n.style.border="none",n.style.borderRadius="4px",n.style.padding="8px 12px",n.style.cursor="pointer",n.addEventListener("click",(async function(){const e={businessName:document.getElementById("business-name")?.value||"",address:document.getElementById("address")?.value||"",useMyLocation:document.getElementById("use-my-location")?.checked||!1};clearMarkers();const n=document.getElementById("initial-map-message");n&&n.remove(),this.innerHTML='<i class="fas fa-sync-alt fa-spin"></i> Refreshing...',await performEnhancedBusinessSearch(e,!1),setTimeout((()=>{this.innerHTML='<i class="fas fa-sync-alt"></i> Refresh Results'}),1e3)}));const o=e.querySelector('input[type="submit"]');o&&o.parentNode?o.parentNode.insertBefore(n,o.nextSibling):e.appendChild(n)}function checkForNewlyAddedBusiness(){const e=new URLSearchParams(window.location.search),n=e.get("business_added"),o=e.get("business_name"),s=e.get("business_id");if("true"===n&&o){showBusinessAddedSuccessMessage(o,s);const e=window.location.pathname;window.history.replaceState({},document.title,e);const n=document.getElementById("business-name"),t=document.getElementById("address");n&&(n.value=o,validateField(n,isNotEmpty)),t&&(t.value=""),setTimeout((()=>{const e=document.getElementById("business-search-form");if(e){const n=new Event("submit",{cancelable:!0});e.dispatchEvent(n)}}),1e3)}}function showNewBusinessAlert(e){const n=document.createElement("div");n.className="alert alert-success",n.role="alert",n.style.marginBottom="20px",n.style.animation="fadeIn 0.5s",n.innerHTML=`\n        <strong>Success!</strong> "${e}" has been added to the database. \n        Searching for this business now...\n        <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n            <span aria-hidden="true">&times;</span>\n        </button>\n    `,n.style.backgroundColor="#d4edda",n.style.border="1px solid #c3e6cb",n.style.color="#155724",n.style.borderRadius="4px",n.style.padding="12px 20px";const o=n.querySelector(".close");o&&(o.style.float="right",o.style.fontSize="20px",o.style.fontWeight="bold",o.style.lineHeight="20px",o.style.color="#155724",o.style.opacity="0.5",o.style.cursor="pointer",o.addEventListener("click",(function(){n.remove()})));const s=document.createElement("style");s.textContent="\n        @keyframes fadeIn {\n            from { opacity: 0; transform: translateY(-10px); }\n            to { opacity: 1; transform: translateY(0); }\n        }\n        @keyframes fadeOut {\n            from { opacity: 1; transform: translateY(0); }\n            to { opacity: 0; transform: translateY(-10px); }\n        }\n    ",document.head.appendChild(s);const t=document.querySelector("main")||document.body;t.insertBefore(n,t.firstChild),setTimeout((()=>{n.parentNode&&(n.style.animation="fadeOut 0.5s",setTimeout((()=>n.remove()),500))}),8e3)}async function searchGooglePlacesForBusiness(e,n){try{console.log("Searching Google Places (new API) for:",e,"near",n);const{Place:o,SearchNearbyRequest:s}=await google.maps.importLibrary("places"),t=new google.maps.LatLng(n.lat,n.lng),a={textQuery:e,locationBias:{center:t,radius:4e4},maxResultCount:20,fields:["id","displayName","formattedAddress","location","types","nationalPhoneNumber","internationalPhoneNumber"]};console.log("New Places API request:",a);const{places:i}=await o.searchByText(a);if(!i||0===i.length)return console.log("No businesses found via new Places API"),[];console.log("Found businesses via new Places API:",i.length);const r=i.filter((n=>{const o=n.displayName.toLowerCase();return o.includes("pro desk")||o.includes("garden center")||o.includes("rental center")||o.includes("tool rental")||o.includes("customer service")?(console.log("Filtering out department:",n.displayName),!1):!(o.includes(" - ")&&!o.toLowerCase().startsWith(e.toLowerCase())&&(console.log("Filtering out formatted result:",n.displayName),1))}));console.log(`Filtered to ${r.length} main store results`);const l=r.map((async e=>{const o=e.formattedAddress?e.formattedAddress.split(","):[];let s="",a="",i="",r="";if(o.length>=1&&(s=o[0].trim()),o.length>=2&&(a=o[1].trim()),o.length>=3){const e=o[2].trim().match(/^([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/);e&&(i=e[1],r=e[2])}const l=e.location,c=google.maps.geometry.spherical.computeDistanceBetween(t,l);let d=0,g=0;if(e.location)try{d="function"==typeof e.location.lat?e.location.lat():e.location.lat||0,g="function"==typeof e.location.lng?e.location.lng():e.location.lng||0}catch(e){console.warn("Error extracting coordinates from new Places API:",e),d=n.lat,g=n.lng}const u={_id:"google_"+e.id,bname:e.displayName,address1:s,city:a,state:i,zip:r,formattedAddress:e.formattedAddress,type:mapGooglePlaceTypeToBusinessType(e.types),phone:e.nationalPhoneNumber||e.internationalPhoneNumber||"",isGooglePlace:!0,placeId:e.id,lat:d,lng:g,distance:c};try{const n=await findMatchingChainForPlaceResult(e.displayName);n?(console.log(`Found chain match for "${e.displayName}": ${n.bname}`),u.chain_id=n._id,u.chain_name=n.bname,u.isChainLocation=!0):console.log(`No chain match found for: ${e.displayName}`)}catch(e){console.warn("Error checking for chain match:",e)}return u})),c=await Promise.all(l);return c.sort(((e,n)=>e.distance-n.distance)),console.log("Final processed businesses with new API:",c.map((e=>({name:e.bname,placeId:e.placeId,isChain:!!e.chain_id,chainName:e.chain_name})))),c}catch(o){return console.error("Error in new Places API search:",o),console.warn("Falling back to deprecated PlacesService API"),await searchGooglePlacesForBusinessLegacy(e,n)}}async function searchGooglePlacesForBusinessLegacy(e,n){return new Promise(((o,s)=>{try{if(console.log("Using legacy PlacesService as fallback"),!map)return void s(new Error("Map not initialized"));const t=new google.maps.LatLng(n.lat,n.lng),a=new google.maps.places.PlacesService(map),i={query:e,location:t,radius:4e4};a.textSearch(i,(async(e,n)=>{if(n===google.maps.places.PlacesServiceStatus.OK&&e&&e.length>0){const n=e.filter((e=>{const n=e.name.toLowerCase();return!n.includes("pro desk")&&!n.includes("garden center")&&!n.includes("rental center")})),s=await Promise.all(n.map((async e=>{const n={_id:"google_"+e.place_id,bname:e.name,isGooglePlace:!0,placeId:e.place_id,lat:e.geometry.location.lat(),lng:e.geometry.location.lng()},o=await findMatchingChainForPlaceResult(e.name);return o&&(n.chain_id=o._id,n.chain_name=o.bname,n.isChainLocation=!0),n})));o(s)}else console.log("Legacy API also found no results"),o([])}))}catch(e){s(e)}}))}function displayBusinessesOnMap(e){if(!map)return console.log("Map not ready, storing businesses for later display"),void(pendingBusinessesToDisplay=e);console.log("Displaying businesses on map:",e.length),clearMarkers(),bounds=new google.maps.LatLngBounds;let n=0,o=0,s=0;e.forEach((e=>{try{if(console.log("Processing business for map:",e.bname),!0===e.is_chain)return console.log(`Skipping parent chain business: ${e.bname} (no physical location)`),void s++;let t,a;if(e.location&&e.location.coordinates&&Array.isArray(e.location.coordinates)&&e.location.coordinates.length>=2)a=e.location.coordinates[0],t=e.location.coordinates[1];else{if(void 0===e.lat||void 0===e.lng)return console.warn(`Business ${e.bname} missing coordinates`),void s++;t=parseFloat(e.lat),a=parseFloat(e.lng)}if(isNaN(t)||isNaN(a)||0===t||0===a)return console.warn(`Invalid coordinates for ${e.bname}: lat=${t}, lng=${a}`),void s++;if(Math.abs(t)>90||Math.abs(a)>180)return console.warn(`Coordinates out of range for ${e.bname}: lat=${t}, lng=${a}`),void s++;if(e.lat=t,e.lng=a,createBusinessMarker(e)){if(n++,window.currentSearchLocation){const n=new google.maps.LatLng(t,a),s=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng),i=google.maps.geometry.spherical.computeDistanceBetween(n,s);i<=80467?(o++,console.log(`${e.bname} is ${(621371e-9*i).toFixed(1)} miles from search location`)):console.log(`${e.bname} is ${(621371e-9*i).toFixed(1)} miles from search location (distant)`)}const s=new google.maps.LatLng(t,a);bounds.extend(s)}}catch(n){console.error(`Error adding business ${e.bname} to map:`,n),s++}})),console.log(`Added ${n} valid markers to the map (${o} nearby, ${s} skipped)`),setTimeout((()=>{try{if(window.currentSearchLocation&&o>0){console.log("Centering map on search location with nearby businesses");const e=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng);map.setCenter(e),map.setZoom(12)}else if(window.currentSearchLocation&&n>0){console.log("Centering map on search location (distant businesses only)");const e=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng);map.setCenter(e),map.setZoom(10)}else n>0&&bounds&&!bounds.isEmpty()?(console.log("No search location, fitting map to business bounds"),safelyFitBounds(map,bounds)):(console.log("Using default map center (no valid businesses to display)"),map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom))}catch(e){console.error("Error updating map view:",e)}}),200)}async function geocodeAddressClientSide(e){return new Promise(((n,o)=>{try{if(console.log(`Geocoding address client-side: ${e}`),!e)return console.error("No address provided for geocoding"),void o(new Error("No address provided"));if(!window.google||!window.google.maps)return void o(new Error("Google Maps API not loaded"));(new google.maps.Geocoder).geocode({address:e},(function(e,s){if(s===google.maps.GeocoderStatus.OK&&e&&e.length>0){const o=e[0].geometry.location,s={lat:o.lat(),lng:o.lng(),formattedAddress:e[0].formatted_address};console.log("Client-side geocoding result:",s),n(s)}else console.error("Client-side geocoding failed:",s),o(new Error(`Geocoding failed: ${s}`))}))}catch(e){console.error("Error in client-side geocoding:",e),o(e)}}))}async function searchGooglePlacesForSpecificBusiness(e,n){try{console.log("Searching specifically for:",e);const o=document.getElementById("map");o&&(o.style.display="block",o.style.height="500px");const s=document.createElement("div");s.id="map-loading",s.className="loading-indicator",s.innerHTML="Searching for businesses...",o.appendChild(s);const t=new google.maps.LatLng(n.lat,n.lng);map.setCenter(t),map.setZoom(11);const a=new google.maps.places.PlacesService(map),i={query:e,location:t,radius:5e4};a.textSearch(i,((o,s)=>{const t=document.getElementById("map-loading");if(t&&t.remove(),s===google.maps.places.PlacesServiceStatus.OK&&o&&o.length>0){console.log("Found specific businesses:",o.length);const e=o.map((e=>({_id:"google_"+e.place_id,bname:e.name,address1:e.formatted_address||"",city:"",state:"",zip:"",isGooglePlace:!0,placeId:e.place_id,lat:e.geometry.location.lat(),lng:e.geometry.location.lng()})));e.forEach((e=>{createBusinessMarker(e)})),displaySearchResults(e)}else console.log("No specific businesses found:",s),searchGooglePlaces({businessName:e},n)}))}catch(o){console.error("Error in specific business search:",o),searchGooglePlaces({businessName:e},n)}}async function searchGooglePlaces(e,n=null){try{console.log("Searching Google Places for:",e);const o=document.getElementById("map");o&&(o.style.display="block",o.style.height="500px"),clearMarkers(),bounds=new google.maps.LatLngBounds;let s="";e.businessName&&(s+=e.businessName),e.address&&(s+=" "+e.address),s=s.trim();const t=document.createElement("div");let a;t.id="map-loading",t.className="loading-indicator",t.innerHTML="Searching for businesses...",o.appendChild(t),n?(a=new google.maps.LatLng(n.lat,n.lng),bounds.extend(a),map.setCenter(a),map.setZoom(12)):(a=new google.maps.LatLng(CONFIG.defaultCenter.lat,CONFIG.defaultCenter.lng),bounds.extend(a),console.log("Using default US center for search"));try{const e=new google.maps.places.PlacesService(map),n={query:s,location:a,radius:4e4};e.textSearch(n,((e,n)=>{const o=document.getElementById("map-loading");if(o&&o.remove(),n===google.maps.places.PlacesServiceStatus.OK&&e&&e.length>0){console.log("Found places via Places API:",e.length);const n=e.map((e=>{const n=e.formatted_address?e.formatted_address.split(","):[];let o="",s="",t="",i="";if(n.length>=1&&(o=n[0].trim()),n.length>=2&&(s=n[1].trim()),n.length>=3){const e=n[2].trim().split(" ");e.length>=1&&(t=e[0].trim()),e.length>=2&&(i=e[1].trim())}const r=e.geometry.location,l=google.maps.geometry.spherical.computeDistanceBetween(a,r),c={_id:"google_"+e.place_id,bname:e.name,address1:o,city:s,state:t,zip:i,formattedAddress:e.formatted_address,type:mapGooglePlaceTypeToBusinessType(e.types),phone:e.formatted_phone_number||"",isGooglePlace:!0,placeId:e.place_id,lat:e.geometry.location.lat(),lng:e.geometry.location.lng(),distance:l};return createBusinessMarker(c),bounds.extend(r),c}));findChainMatchesForResults(n).then((()=>{n.sort(((e,n)=>e.distance-n.distance)),displaySearchResults(n),bounds&&!bounds.isEmpty()&&safelyFitBounds(map,bounds)}))}else console.log("No places found via Places API:",n),showErrorMessage("No businesses found matching your search criteria.")}))}catch(e){console.error("Error searching places:",e);const n=document.getElementById("map-loading");n&&n.remove(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}catch(e){console.error("Error in searchGooglePlaces:",e),showErrorMessage(`Error searching for businesses: ${e.message}`)}}function applyMapHeightFix(){if(!document.getElementById("map-height-fix")){const e=document.createElement("style");e.id="map-height-fix",e.textContent=mapHeightCSS,document.head.appendChild(e),console.log("Applied map height and info window positioning fixes"),map&&google.maps.event&&setTimeout((()=>{google.maps.event.trigger(map,"resize"),console.log("Triggered map resize event")}),100)}}window.viewBusinessDetails=function(e){console.log("View details for business:",e),alert("This feature is coming soon: View details for "+e)},window.addBusinessToDatabase=async function(e,n=null){console.log("Adding place to database:",e,"Chain ID:",n);try{const{Place:o}=await google.maps.importLibrary("places"),s=new o({id:e});await s.fetchFields({fields:["displayName","formattedAddress","addressComponents","location","nationalPhoneNumber","internationalPhoneNumber"]}),console.log("Place details retrieved with new API:",s);const t={};if(s.addressComponents)for(const e of s.addressComponents)for(const n of e.types)t[n]=e.shortText||e.longText;const a={name:s.displayName||"",address1:(t.street_number||"")+" "+(t.route||""),city:t.locality||"",state:t.administrative_area_level_1||"",zip:t.postal_code||"",phone:s.nationalPhoneNumber||s.internationalPhoneNumber||"",placeId:s.id,formattedAddress:s.formattedAddress,lat:s.location?.lat()||0,lng:s.location?.lng()||0,location:{type:"Point",coordinates:[s.location?.lng()||0,s.location?.lat()||0]}};let i="",r="";if(n)try{const e=await getChainDetails(n);e&&e.bname?(a.chain_name=e.bname,r=`This business will be added as a location of ${e.bname}. Chain-wide incentives already apply to this location.`):r="This business will be added as a chain location. Chain-wide incentives may apply."}catch(e){console.error("Error getting chain details:",e),r="This business will be added as a chain location."}i=`\n${r?r+"\n\n":""}You will now be redirected to the "Add Business" page where the form will be pre-filled with this business information.\n\nAfter you complete adding the business, you will be returned to this search page.\n\nClick OK to continue.`,confirm(i)&&(sessionStorage.setItem("newBusinessData",JSON.stringify(a)),sessionStorage.setItem("returnToSearch",window.location.href),window.location.href="business-add.html?prefill=true")}catch(e){console.error("Error in addBusinessToDatabase:",e),alert("Sorry, we couldn't retrieve the business information. Please try again or add it manually.")}};const mapHeightCSS="\n#map {\n    width: 100%;\n    height: 800px !important; /* Increased from 500px */\n    min-height: 800px;\n    border: 1px solid #ccc;\n    border-radius: 4px;\n    margin: 10px 0;\n    position: relative;\n}\n\n#map-container {\n    width: 90%;\n    margin: 20px auto;\n    clear: both;\n}\n\n.map-controls {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 10px;\n    padding: 0 5px;\n}\n\n/* Ensure proper info window positioning */\n.gm-style .gm-style-iw-c {\n    padding: 0 !important;\n    border-radius: 8px !important;\n    box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n    max-width: 330px !important;\n    max-height: 400px !important;\n    overflow: hidden !important;\n    position: relative !important;\n    z-index: 1000 !important;\n    /* Ensure it's positioned correctly relative to the tail */\n    margin-bottom: 15px !important;\n}\n\n.gm-style .gm-style-iw-d {\n    overflow: auto !important;\n    max-height: 350px !important;\n    padding-right: 8px !important;\n}\n\n.gm-style .gm-style-iw {\n    /* Override any problematic positioning */\n    position: relative !important;\n    z-index: 1001 !important;\n}\n\n.gm-style .gm-style-iw-t {\n    position: absolute !important;\n    width: 100% !important;\n    /* Override the inline bottom positioning that's causing the issue */\n    bottom: 0px !important;\n    /* Ensure proper positioning */\n    right: auto !important;\n    left: 50% !important;\n    transform: translateX(-50%) !important;\n    /* Make sure it's properly sized */\n    height: 15px !important;\n}\n\n.gm-style .gm-style-iw-tc {\n    /* This is the tail connector - make sure it's positioned correctly */\n    top: auto !important;\n    bottom: -15px !important;\n    left: 50% !important;\n    right: auto !important;\n    transform: translateX(-50%) !important;\n    width: 24px !important;\n    height: 24px !important;\n}\n";function showBusinessInfoWindow(e){if(!e||!e.business)return void console.error("Invalid marker or missing business data");const n=e.business;console.log("Showing info window for business:",n.bname),infoWindow||(infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1}));const o=!0===n.isGooglePlace,s=!!n.chain_id,t=n.address1?`<p><strong>Address:</strong><br>${n.address1}${n.city?", "+n.city:""}${n.state?", "+n.state:""}${n.zip?" "+n.zip:""}</p>`:"",a=s?`<span style="display:inline-block; background-color:#4285F4; color:white; padding:2px 6px; border-radius:4px; font-size:0.8em; margin-left:5px;">${n.chain_name||"Chain Location"}</span>`:"";let i;i=o?s?`\n                <button style="background-color:#EA4335; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; margin-top:10px;" \n                        onclick="window.addBusinessToDatabase('${n.placeId}', '${n.chain_id}')">\n                    Add to Database\n                </button>\n            `:`\n                <button style="background-color:#EA4335; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; margin-top:10px;" \n                        onclick="window.addBusinessToDatabase('${n.placeId}')">\n                    Add to Patriot Thanks\n                </button>\n            `:`\n            <button style="background-color:#4285F4; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; margin-top:10px;" \n                    onclick="window.viewBusinessDetails('${n._id}')">\n                View Details\n            </button>\n        `;const r=`\n        <div style="max-width:300px; font-family:Arial,sans-serif;">\n            <h3 style="margin-top:0; margin-bottom:8px; font-size:16px;">${n.bname} ${a}</h3>\n            ${t}\n            <div id="incentives-container-${n._id||n.placeId}">\n                <p><em>Loading incentives...</em></p>\n            </div>\n            <div style="text-align:right;">\n                ${i}\n            </div>\n        </div>\n    `;if(infoWindow.setContent(r),infoWindow.open(map,e),o&&s)fetchChainIncentivesForInfoWindow(n.placeId,n.chain_id,!0);else if(o){const e=document.getElementById(`incentives-container-${n._id||n.placeId}`);e&&(e.innerHTML="<p><em>This business is not yet in the Patriot Thanks database.</em></p>")}else fetchBusinessIncentivesForInfoWindow(n._id)}function fetchChainIncentivesForInfoWindow(e,n,o=!1){if(!n)return void console.error("No chain ID provided for fetching incentives");const s=o?`incentives-container-${e}`:`info-window-incentives-${e}`,t=document.getElementById(s);if(!t)return void console.error(`Could not find incentives div for place ${e}`);const a=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${n}`;console.log("Fetching chain incentives from:",a),fetch(a).then((e=>{if(!e.ok)throw new Error(`Failed to fetch chain incentives: ${e.status}`);return e.json()})).then((n=>{if(console.log(`Chain incentives data for place ${e}:`,n),!n.results||0===n.results.length)return void(t.innerHTML="<p><strong>Chain Incentives:</strong> No incentives found</p>");let o='<p><strong>Chain Incentives:</strong></p><ul style="margin:8px 0; padding-left:20px;">';n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),s=e.other_description?` (${e.other_description})`:"",t='<span style="display:inline-block; background-color:#4285F4; color:white; padding:1px 4px; border-radius:4px; font-size:0.7em; margin-left:5px;">Chain-wide</span>';o+=`\n                        <li>\n                            <strong>${n}${s}:</strong> ${e.amount}% ${t}\n                            ${e.information?`<div style="font-size:13px; color:#555; margin-top:2px;">${e.information}</div>`:""}\n                        </li>\n                    `}})),o+="</ul>",o+=`\n                <div style="margin-top:10px; font-style:italic; color:#666; font-size:12px;">\n                    This location matches ${n.chain_info?n.chain_info.bname:"a chain"} in our database.\n                    Chain-wide incentives apply to all locations.\n                </div>\n            `,t.innerHTML=o})).catch((e=>{console.error(`Error fetching chain incentives: ${e}`),t.innerHTML="<p><strong>Chain Incentives:</strong> Error loading incentives</p>"}))}function safeExtractCoordinates(e){try{if(!e)return null;let n,o;if("function"==typeof e.lat&&"function"==typeof e.lng)n=e.lat(),o=e.lng();else if(void 0!==e.lat&&void 0!==e.lng)n=parseFloat(e.lat),o=parseFloat(e.lng);else if(void 0!==e.latitude&&void 0!==e.longitude)n=parseFloat(e.latitude),o=parseFloat(e.longitude);else{if(!(Array.isArray(e)&&e.length>=2))return console.warn("Unrecognized location object format:",e),null;n=parseFloat(e[0]),o=parseFloat(e[1])}return isNaN(n)||isNaN(o)||!isFinite(n)||!isFinite(o)?(console.warn("Invalid coordinates extracted:",n,o),null):Math.abs(n)>90||Math.abs(o)>180?(console.warn("Coordinates out of valid range:",n,o),null):{lat:n,lng:o}}catch(e){return console.error("Error extracting coordinates:",e),null}}function showInfoWindow(e){if(console.log("showInfoWindow called with marker:",e),!e||!e.business)return void console.error("Invalid marker for info window",e);const n=e.business;console.log("Business data for info window:",n),infoWindow&&infoWindow.close(),infoWindow=new google.maps.InfoWindow({maxWidth:300,disableAutoPan:!1});const o=buildInfoWindowContent(n);infoWindow.setContent(o);let s=null;if(e.getPosition&&"function"==typeof e.getPosition)try{s=e.getPosition()}catch(e){console.warn("Error getting position from marker.getPosition():",e)}if(!s&&e.position&&(s=e.position),!s&&n){const e=safeExtractCoordinates(n);e&&(s=new google.maps.LatLng(e.lat,e.lng))}s||(console.error("Could not determine position for info window"),s=new google.maps.LatLng(39.8283,-98.5795));const t=safeExtractCoordinates(s);if(!t)return void console.error("Invalid position for info window");const a=new google.maps.LatLng(t.lat,t.lng);try{map.panTo(a)}catch(e){console.warn("Error panning to position:",e)}setTimeout((()=>{try{e.getPosition?infoWindow.open(map,e):(infoWindow.setPosition(a),infoWindow.open(map)),console.log("Info window opened successfully"),google.maps.event.addListenerOnce(infoWindow,"domready",(function(){console.log("Info window DOM ready"),setTimeout((()=>{fixInfoWindowPositioning(),n.isGooglePlace?n.chain_id&&setTimeout((()=>{loadChainIncentivesForInfoWindow(n.placeId,n.chain_id)}),200):setTimeout((()=>{loadIncentivesForInfoWindow(n._id)}),200)}),300)}))}catch(e){console.error("Error opening info window:",e)}}),200)}function withErrorHandling(e,n){return function(...o){try{return e.apply(this,o)}catch(e){return console.error(`Error in ${n}:`,e),null}}}function fixInfoWindowPositioning(){console.log("Applying info window positioning fix");const e=document.querySelector(".gm-style-iw-c"),n=document.querySelector(".gm-style-iw-d"),o=document.querySelector(".gm-style-iw-t");if(!e)return void console.log("Info window container not found");const s=e.getBoundingClientRect();if(console.log("Info window position:",s),s.width<50&&(console.log("Info window width too small, forcing proper dimensions"),e.style.width="auto",e.style.minWidth="280px",e.style.maxWidth="320px",n&&(n.style.width="auto",n.style.minWidth="280px")),s.top<0||s.top>window.innerHeight||s.left<0||s.left>window.innerWidth||s.width<50){console.log("Info window has positioning/sizing issues, applying comprehensive fix");const n=e.style.transform;if(n&&n.includes("translate")){console.log("Current transform:",n);const o=n.match(/translate\(([^,]+),\s*([^)]+)\)/);if(o){const n=parseFloat(o[1]),s=parseFloat(o[2]);(Math.abs(n)>window.innerWidth||Math.abs(s)>window.innerHeight)&&(console.log("Resetting extreme transform values"),e.style.transform="translate(0px, 0px)")}}e.style.display="block",e.style.visibility="visible",e.style.opacity="1",o&&(o.style.bottom="0px",o.style.left="50%",o.style.right="auto",o.style.transform="translateX(-50%)"),console.log("Applied comprehensive positioning fix"),setTimeout((()=>{google.maps.event.trigger(map,"resize");const n=e.getBoundingClientRect();console.log("Info window dimensions after fix:",n)}),100)}}function loadIncentivesForInfoWindow(e){const n=document.getElementById(`incentives-container-${e}`);if(!n)return void console.error("Incentives container not found for business:",e);const o=getBaseURL();fetch(`${o}/api/combined-api.js?operation=incentives&business_id=${e}`).then((e=>e.json())).then((e=>{if(!e.results||0===e.results.length)return void(n.innerHTML='<p style="margin:4px 0; font-style:italic; color:#666;">No incentives available</p>');let o='<p style="margin:4px 0;"><strong>Incentives:</strong></p><ul style="margin:4px 0; padding-left:16px; font-size:13px;">';e.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),s=e.other_description?` (${e.other_description})`:"",t=e.is_chain_wide?'<span style="background-color:#4285F4; color:white; padding:1px 4px; border-radius:3px; font-size:11px; margin-left:4px;">Chain-wide</span>':"";o+=`<li style="margin-bottom:4px;"><strong>${n}${s}:</strong> ${e.amount}% ${t}</li>`}})),o+="</ul>",n.innerHTML=o})).catch((e=>{console.error("Error loading incentives:",e),n.innerHTML='<p style="margin:4px 0; font-style:italic; color:#666;">Error loading incentives</p>'}))}function loadChainIncentivesForInfoWindow(e,n){const o=document.getElementById(`incentives-container-${e}`);if(!o)return void console.error("Incentives container not found for place:",e);const s=getBaseURL();fetch(`${s}/api/combined-api.js?operation=incentives&business_id=${n}`).then((e=>e.json())).then((e=>{if(!e.results||0===e.results.length)return void(o.innerHTML='<p style="margin:4px 0; font-style:italic; color:#666;">No chain incentives available</p>');let n='<p style="margin:4px 0;"><strong>Chain Incentives:</strong></p><ul style="margin:4px 0; padding-left:16px; font-size:13px;">';e.results.forEach((e=>{if(e.is_available){const o=getIncentiveTypeLabel(e.type),s=e.other_description?` (${e.other_description})`:"";n+=`<li style="margin-bottom:4px;"><strong>${o}${s}:</strong> ${e.amount}% <span style="background-color:#4285F4; color:white; padding:1px 4px; border-radius:3px; font-size:11px; margin-left:4px;">Chain-wide</span></li>`}})),n+="</ul>",n+='<p style="margin:8px 0 4px 0; font-size:12px; font-style:italic; color:#666;">These incentives apply to all locations of this chain.</p>',o.innerHTML=n})).catch((e=>{console.error("Error loading chain incentives:",e),o.innerHTML='<p style="margin:4px 0; font-style:italic; color:#666;">Error loading chain incentives</p>'}))}function applyInfoWindowCSS(){if(!document.getElementById("info-window-fix-css")){const e=document.createElement("style");e.id="info-window-fix-css",e.textContent="\n            /* Ensure info windows are visible and properly positioned */\n            .gm-style .gm-style-iw-c {\n                max-width: 320px !important;\n                max-height: 400px !important;\n                padding: 0 !important;\n                border-radius: 8px !important;\n                box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n                overflow: hidden !important;\n            }\n\n            .gm-style .gm-style-iw-d {\n                overflow: auto !important;\n                max-height: 350px !important;\n            }\n\n            .gm-style .gm-style-iw {\n                display: block !important;\n                visibility: visible !important;\n                opacity: 1 !important;\n            }\n\n            /* Fix tail positioning */\n            .gm-style .gm-style-iw-t {\n                bottom: 0px !important;\n                left: 50% !important;\n                right: auto !important;\n                transform: translateX(-50%) !important;\n                width: 20px !important;\n                height: 15px !important;\n            }\n\n            /* Ensure close button is visible */\n            .gm-ui-hover-effect {\n                opacity: 0.8 !important;\n                top: 2px !important;\n                right: 2px !important;\n            }\n\n            .gm-ui-hover-effect:hover {\n                opacity: 1 !important;\n            }\n\n            /* Custom scrollbar for info window content */\n            .gm-style .gm-style-iw-d::-webkit-scrollbar {\n                width: 6px;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-track {\n                background: #f1f1f1;\n                border-radius: 3px;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb {\n                background: #c1c1c1;\n                border-radius: 3px;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb:hover {\n                background: #a8a8a8;\n            }\n        ",document.head.appendChild(e),console.log("Applied info window CSS fixes")}}function applyTargetedTailFix(){console.log("Applying targeted tail fix...");const e=document.querySelector(".gm-style-iw-t");if(e){const n=window.getComputedStyle(e);console.log("Current tail positioning:",{bottom:n.bottom,right:n.right,left:n.left,width:n.width,height:n.height});const o=n.bottom,s=n.right;e.style.setProperty("bottom","0px","important"),e.style.setProperty("left","50%","important"),e.style.setProperty("right","auto","important"),e.style.setProperty("transform","translateX(-50%)","important"),console.log(`Applied tail fix: changed bottom from ${o} to 0px, right from ${s} to auto`),setTimeout((()=>{const n=document.querySelector(".gm-style-iw-c").getBoundingClientRect();console.log("Info window position after tail fix:",n);const o=window.getComputedStyle(e);console.log("New tail positioning:",{bottom:o.bottom,right:o.right,left:o.left,transform:o.transform})}),50)}else console.log("No tail element found for fixing")}function applyCSSOnlyTailFix(){if(!document.getElementById("css-only-tail-fix")){const e=document.createElement("style");e.id="css-only-tail-fix",e.textContent="\n            /* Target only the tail positioning without affecting the container */\n            .gm-style .gm-style-iw-t {\n                bottom: 0px !important;\n                left: 0px !important;\n                right: 0px !important;\n                transform: translateX(-50%) !important;\n                width: 0 !important;\n                height: 0 !important;\n            }\n            \n            /* Don't touch the main container transform */\n            .gm-style .gm-style-iw-c {\n                /* Let Google handle the main positioning */\n            }\n        ",document.head.appendChild(e),console.log("Applied CSS-only tail fix")}}function gentlyFixInfoWindowPosition(){console.log("Applying gentle info window position fix...");const e=document.querySelector(".gm-style-iw-t");if(e){const n=window.getComputedStyle(e);console.log("Current tail styles:",{bottom:n.bottom,right:n.right,left:n.left,position:n.position}),"34px"===n.bottom&&"0px"===n.right&&(console.log("Found problematic tail positioning, applying gentle fix..."),e.style.bottom="0px",console.log("Applied gentle fix - changed bottom from 34px to 0px"),setTimeout((()=>{const e=document.querySelector(".gm-style-iw-c");if(e){const n=e.getBoundingClientRect();console.log("Info window position after gentle fix:",n)}}),100))}}function checkAndReportInfoWindowPosition(){console.log("=== INFO WINDOW POSITION REPORT ===");const e=document.querySelector(".gm-style-iw-c"),n=(document.querySelector(".gm-style-iw-d"),document.querySelector(".gm-style-iw-t"));if(e){const o=e.getBoundingClientRect(),s=window.getComputedStyle(e);console.log("Container position:",o),console.log("Container visibility:",s.visibility),console.log("Container display:",s.display),console.log("Container opacity:",s.opacity),console.log("Container transform:",s.transform);const t=o.width>0&&o.height>0,a=o.top>=0&&o.top<=window.innerHeight&&o.left>=0&&o.left<=window.innerWidth;if(console.log("Is visible:",t),console.log("Is in viewport:",a),!a&&n){const e=window.getComputedStyle(n);console.log("Tail styles:",{bottom:e.bottom,right:e.right,left:e.left,width:e.width,height:e.height})}}else console.log("No info window container found");console.log("=== END REPORT ===")}function removeAggressiveCSS(){["final-info-window-fix","info-window-position-fix","minimal-info-window-fix"].forEach((e=>{const n=document.getElementById(e);n&&(console.log("Removing potentially problematic CSS:",e),n.remove())}))}function applyBasicInfoWindowCSS(){if(!document.getElementById("basic-info-window-css")){const e=document.createElement("style");e.id="basic-info-window-css",e.textContent="\n            /* Very basic CSS - just ensure visibility */\n            .gm-style .gm-style-iw-c {\n                display: block !important;\n                visibility: visible !important;\n                opacity: 1 !important;\n            }\n            \n            .gm-style .gm-style-iw {\n                display: block !important;\n                visibility: visible !important;\n                opacity: 1 !important;\n            }\n            \n            /* Map height fix */\n            #map-container {\n                width: 90%;\n                margin: 20px auto;\n                clear: both;\n                position: relative;\n            }\n\n            #map {\n                width: 100%;\n                height: 800px !important;\n                min-height: 800px;\n                border: 1px solid #ccc;\n                border-radius: 4px;\n                margin: 10px 0;\n                position: relative;\n                z-index: 1;\n            }\n        ",document.head.appendChild(e),console.log("Applied basic info window CSS")}}function fixInfoWindowTailPositioning(){console.log("Attempting to fix info window tail positioning");const e=document.querySelector(".gm-style-iw-t");if(e){console.log("Found info window tail element, applying aggressive fixes"),e.style.removeProperty("bottom"),e.style.removeProperty("right"),e.style.removeProperty("left"),e.style.removeProperty("top"),e.style.setProperty("position","absolute","important"),e.style.setProperty("bottom","0px","important"),e.style.setProperty("right","auto","important"),e.style.setProperty("left","50%","important"),e.style.setProperty("top","auto","important"),e.style.setProperty("transform","translateX(-50%)","important"),e.style.setProperty("width","20px","important"),e.style.setProperty("height","15px","important"),console.log("Applied positioning fixes to tail element");const n=document.querySelector(".gm-style-iw-c");if(n){const e=window.getComputedStyle(n).transform;if(console.log("Current info window transform:",e),e&&e.includes("matrix")){const e=n.getBoundingClientRect();(e.top<-100||e.top>window.innerHeight+100)&&(console.log("Info window positioned off-screen, attempting to reset transform"),n.style.setProperty("transform","none","important"),setTimeout((()=>{const e=n.getBoundingClientRect();console.log("Info window position after transform reset:",e)}),100))}}const o=document.querySelector(".gm-style-iw-tc");return o&&(o.style.setProperty("top","auto","important"),o.style.setProperty("bottom","-15px","important"),o.style.setProperty("left","50%","important"),o.style.setProperty("right","auto","important"),o.style.setProperty("transform","translateX(-50%)","important"),console.log("Fixed tail connector positioning")),!0}return console.warn("Could not find tail element to fix"),!1}function applyInfoWindowPositioningFixes(){if(!document.getElementById("final-info-window-fix")){const e=document.createElement("style");e.id="final-info-window-fix",e.textContent="\n            /* CRITICAL: Override Google's tail positioning that causes off-screen issues */\n            ..gm-style .gm-style-iw-t {\n                bottom: 0px !important;\n                left: 0px !important;\n                right: 0px !important;\n                transform: translateX(-50%) !important;\n                width: 0 !important;\n                height: 0 !important;\n            }\n            \n            /* Prevent off-screen positioning */\n            .gm-style .gm-style-iw-c {\n                max-width: 320px !important;\n                max-height: 400px !important;\n                overflow: hidden !important;\n                /* Prevent problematic transforms */\n                transform: none !important;\n            }\n            \n            /* Ensure visibility */\n            .gm-style .gm-style-iw {\n                display: block !important;\n                visibility: visible !important;\n                opacity: 1 !important;\n            }\n            \n            .gm-style .gm-style-iw-d {\n                overflow: auto !important;\n                max-height: 350px !important;\n            }\n            \n            /* Fix tail connector */\n            .gm-style .gm-style-iw-tc {\n                top: auto !important;\n                bottom: -15px !important;\n                left: 50% !important;\n                right: auto !important;\n                transform: translateX(-50%) !important;\n            }\n            \n            /* Map container styles */\n            #map-container {\n                width: 90%;\n                margin: 20px auto;\n                clear: both;\n                position: relative;\n            }\n\n            #map {\n                width: 100%;\n                height: 800px !important;\n                min-height: 800px;\n                border: 1px solid #ccc;\n                border-radius: 4px;\n                margin: 10px 0;\n                position: relative;\n                z-index: 1;\n            }\n        ",document.head.appendChild(e),console.log("Applied final info window positioning fixes")}}function fetchBusinessIncentivesForInfoWindow(e){e&&!e.startsWith("google_")&&setTimeout((()=>{const n=document.getElementById(`info-window-incentives-${e}`);if(!n)return void console.error(`Could not find incentives div for business ${e}`);const o=getBaseURL();fetch(`${o}/api/combined-api.js?operation=incentives&business_id=${e}`).then((e=>e.json())).then((e=>{if(!e.results||0===e.results.length)return void(n.innerHTML="<p><strong>Incentives:</strong> No incentives found</p>");let o='<p><strong>Incentives:</strong></p><ul style="margin:8px 0; padding-left:20px;">';e.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),s=e.other_description?` (${e.other_description})`:"",t=e.is_chain_wide?'<span style="display:inline-block; background-color:#4285F4; color:white; padding:1px 4px; border-radius:4px; font-size:0.7em; margin-left:5px;">Chain-wide</span>':"";o+=`<li><strong>${n}${s}:</strong> ${e.amount}% ${t}</li>`}})),o+="</ul>",n.innerHTML=o})).catch((e=>{console.error("Error fetching incentives:",e),n.innerHTML="<p><strong>Incentives:</strong> Error loading</p>"}))}),300)}function removeProblematicInfoWindowCSS(){document.querySelectorAll("#info-window-position-fix, #map-height-fix").forEach((e=>{console.log("Removing potentially problematic style:",e.id),e.remove()}));const e=document.createElement("style");e.id="minimal-info-window-fix",e.textContent="\n        /* Minimal CSS to ensure info windows are visible */\n        .gm-style .gm-style-iw-c {\n            max-width: 320px !important;\n            max-height: 400px !important;\n            overflow: visible !important;\n        }\n        \n        .gm-style .gm-style-iw-d {\n            overflow: auto !important;\n            max-height: 350px !important;\n        }\n        \n        .gm-style .gm-style-iw {\n            display: block !important;\n            visibility: visible !important;\n            opacity: 1 !important;\n        }\n        \n        /* Don't touch the tail positioning for now */\n        .gm-style .gm-style-iw-t {\n            /* Let Google handle this naturally */\n        }\n    ",document.head.appendChild(e),console.log("Applied minimal info window CSS")}async function findChainMatchesForResults(e){const n=e.map((e=>findMatchingChainForPlaceResult(e.bname).then((n=>(n&&(console.log(`Found matching chain for place: ${e.bname}`),e.chain_id=n._id,e.chain_name=n.bname,e.isChainLocation=!0),e))).catch((n=>(console.error(`Error matching chain for ${e.bname}:`,n),e)))));return await Promise.all(n),e}function findMatchingChainLocally(e){return new Promise((n=>{try{if(!e)return void n(null);console.log("Enhanced local chain matching for:",e);const o=[{name:"The Home Depot",variations:["the home depot","home depot","homedepot"],id:"681fe0e67d92c3d3e1e2a3da"},{name:"Lowe's",variations:["lowes","lowe's","lowes home improvement","lowe's home improvement"],id:"lowes_chain_id"},{name:"Walmart",variations:["walmart","wal-mart","walmart supercenter"],id:"walmart_chain_id"},{name:"Target",variations:["target","target store"],id:"target_chain_id"},{name:"Best Buy",variations:["best buy","bestbuy"],id:"bestbuy_chain_id"},{name:"McDonald's",variations:["mcdonalds","mcdonald's","mickey d's"],id:"mcdonalds_chain_id"}],s=e.toLowerCase().trim();for(const t of o)for(const o of t.variations)if(s===o||s.includes(o)||o.includes(s))return console.log(`Enhanced local match: "${e}" matches "${t.name}"`),void n({_id:t.id,bname:t.name,isLocalMatch:!0});console.log("No enhanced local chain match found for:",e),n(null)}catch(e){console.error("Error in enhanced local chain matching:",e),n(null)}}))}async function setupMapClickHandler(){if(map){console.log("Setting up map click handler");try{const{Place:e}=await google.maps.importLibrary("places");map.addListener("click",(async function(n){if(console.log("Map clicked",n),n.placeId){n.stop(),console.log("POI clicked, placeId:",n.placeId);try{const o=markers.find((e=>e.business&&(e.business.placeId===n.placeId||e.business._id==="google_"+n.placeId)));if(o)return console.log("Found existing marker for clicked place"),void showEnhancedInfoWindow(o);const s=new e({id:n.placeId});await s.fetchFields({fields:["displayName","formattedAddress","addressComponents","location","types","businessStatus","nationalPhoneNumber","internationalPhoneNumber"]}),console.log("Place details:",s);const t=s.displayName||"Unknown Business";let a="",i="",r="",l="",c="";if(c=s.nationalPhoneNumber||s.internationalPhoneNumber||"",s.addressComponents&&s.addressComponents.length>0){console.log("Parsing address components:",s.addressComponents);const e=getAddressComponent(s.addressComponents,"street_number"),n=getAddressComponent(s.addressComponents,"route");i=getAddressComponent(s.addressComponents,"locality"),r=getAddressComponent(s.addressComponents,"administrative_area_level_1"),l=getAddressComponent(s.addressComponents,"postal_code"),e&&n?a=`${e} ${n}`:n?a=n:e&&(a=e)}if(!a&&s.formattedAddress){console.log("Falling back to formatted address parsing");const e=s.formattedAddress.split(",").map((e=>e.trim()));if(e.length>=1&&(a=e[0]),e.length>=2&&(i=e[1]),e.length>=3){const n=e[2].match(/^([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/);if(n)r=n[1],l=n[2];else{const n=e[2].split(" ");n.length>=2&&(r=n[0],l=n[1])}}}let d=0,g=0;if(s.location)try{d="function"==typeof s.location.lat?s.location.lat():s.location.lat||0,g="function"==typeof s.location.lng?s.location.lng():s.location.lng||0}catch(e){console.warn("Error extracting coordinates:",e),n.latLng&&(d=n.latLng.lat(),g=n.latLng.lng())}else n.latLng&&(d=n.latLng.lat(),g=n.latLng.lng());const u=mapGooglePlaceTypeToBusinessType(s.types||[]);let h=null;try{h=await findMatchingChainForPlaceResult(t)}catch(e){console.warn("Error checking for chain match (non-critical):",e)}const p={_id:"google_"+s.id,bname:t,address1:a,city:i,state:r,zip:l,phone:c,type:u,formattedAddress:s.formattedAddress,isGooglePlace:!0,placeId:s.id,lat:d,lng:g,types:s.types||[]};if(h&&(console.log(`POI "${t}" matches chain: ${h.bname}`),p.chain_id=h._id,p.chain_name=h.bname,p.isChainLocation=!0),d&&g&&window.currentSearchLocation)try{p.distance=google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(d,g),new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng))}catch(e){console.warn("Error calculating distance:",e)}console.log("Parsed business object:",p),showEnhancedInfoWindow({business:p,position:new google.maps.LatLng(d,g),getPosition:function(){return this.position}})}catch(e){console.error("Error fetching place details:",e),alert("Unable to load details for this location. Please try again.")}}})),console.log("Map click handler set up successfully")}catch(e){console.error("Error setting up map click handler:",e)}}else console.error("Map not initialized in setupMapClickHandler")}function getAddressComponent(e,n){if(!e||!Array.isArray(e))return"";const o=e.find((e=>e.types&&e.types.includes(n)));return o&&(o.shortText||o.short_name)||""}function mapGooglePlaceTypeToBusinessType(e){if(!e||!Array.isArray(e))return"OTHER";const n={restaurant:"REST",meal_takeaway:"REST",meal_delivery:"REST",cafe:"REST",bakery:"REST",bar:"REST",night_club:"REST",food:"REST",mexican_restaurant:"REST",chinese_restaurant:"REST",italian_restaurant:"REST",japanese_restaurant:"REST",indian_restaurant:"REST",thai_restaurant:"REST",american_restaurant:"REST",pizza_restaurant:"REST",seafood_restaurant:"REST",steak_house:"REST",sushi_restaurant:"REST",vegetarian_restaurant:"REST",fast_food_restaurant:"REST",grocery_or_supermarket:"GROC",supermarket:"GROC",convenience_store:"CONV",gas_station:"FUEL",hardware_store:"HARDW",department_store:"DEPT",clothing_store:"CLTH",shoe_store:"CLTH",electronics_store:"ELEC",furniture_store:"FURN",home_goods_store:"FURN",jewelry_store:"JEWL",book_store:"BOOK",bicycle_store:"SPRT",sporting_goods_store:"SPRT",toy_store:"TOYS",pet_store:"OTHER",florist:"GIFT",gift_shop:"GIFT",car_dealer:"AUTO",car_rental:"AUTO",car_repair:"AUTO",car_wash:"AUTO",auto_parts_store:"AUTO",pharmacy:"RX",drugstore:"RX",hospital:"HEAL",doctor:"HEAL",dentist:"HEAL",veterinary_care:"HEAL",beauty_salon:"BEAU",hair_care:"BEAU",spa:"BEAU",movie_theater:"ENTR",amusement_park:"ENTR",zoo:"ENTR",aquarium:"ENTR",museum:"ENTR",art_gallery:"ENTR",bowling_alley:"ENTR",casino:"ENTR",bank:"SERV",atm:"SERV",post_office:"SERV",laundry:"SERV",gym:"SPRT",library:"BOOK",lodging:"OTHER",hotel:"OTHER",motel:"OTHER",store:"RETAIL",shopping_mall:"RETAIL",establishment:"OTHER",point_of_interest:"OTHER"};for(const o of e)if(n[o])return n[o];return"OTHER"}function buildInfoWindowContent(e){const n=!0===e.isGooglePlace,o=!!e.chain_id;let s="";e.address1?(s=`<p><strong>Address:</strong><br>${e.address1}`,e.city&&(s+=`, ${e.city}`),e.state&&(s+=`, ${e.state}`),e.zip&&(s+=` ${e.zip}`),s+="</p>"):e.formattedAddress&&(s=`<p><strong>Address:</strong><br>${e.formattedAddress}</p>`);const t=o?`<span style="display:inline-block; background-color:#4285F4; color:white; padding:2px 6px; border-radius:4px; font-size:0.8em; margin-left:5px;">${e.chain_name||"Chain Location"}</span>`:"";let a="";e.type?a=`<p><strong>Type:</strong> ${getBusinessTypeLabel(e.type)}</p>`:n&&e.types&&e.types.length>0&&(a=`<p><strong>Type:</strong> ${getPlaceTypeLabel(e.types)}</p>`);const i=e.distance?`<p><strong>Distance:</strong> ${(e.distance/1609).toFixed(1)} miles</p>`:"",r=n?'<p style="color:#666; font-style:italic;">This business is not yet in the Patriot Thanks database.</p>':"",l=o?`<p style="color:#4285F4; font-size:12px; margin-top:8px;">This location appears to match ${e.chain_name} in our database. Chain-wide incentives may apply.</p>`:"";let c;return c=n?o?`\n                <button style="background-color:#EA4335; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; width:100%;" \n                        onclick="window.addBusinessToDatabase('${e.placeId}', '${e.chain_id}')">\n                    Add ${e.chain_name} Location\n                </button>\n            `:`\n                <button style="background-color:#EA4335; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; width:100%;" \n                        onclick="window.addBusinessToDatabase('${e.placeId}')">\n                    Add to Patriot Thanks\n                </button>\n            `:`\n            <button style="background-color:#4285F4; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; width:100%;" \n                    onclick="window.viewBusinessDetails('${e._id}')">\n                View Details\n            </button>\n        `,`\n        <div style="max-width:280px; font-family:Arial,sans-serif; padding:8px;">\n            <h3 style="margin:0 0 8px 0; font-size:16px; line-height:1.2;">${e.bname} ${t}</h3>\n            ${s}\n            ${a}\n            ${i}\n            ${r}\n            ${l}\n            <div id="incentives-container-${e._id||e.placeId}" style="margin:8px 0;">\n                ${n&&!o?'<p style="margin:4px 0; font-style:italic; color:#666;">Add this business to see available incentives.</p>':'<p style="margin:4px 0;"><em>Loading incentives...</em></p>'}\n            </div>\n            <div style="margin-top:12px; text-align:center;">\n                ${c}\n            </div>\n        </div>\n    `}function getPlaceTypeLabel(e){if(!e||!e.length)return"Business";const n={restaurant:"Restaurant",food:"Food & Dining",store:"Store",establishment:"Business",point_of_interest:"Point of Interest",gas_station:"Gas Station",lodging:"Lodging",cafe:"Cafe",bar:"Bar",hardware_store:"Hardware Store",home_goods_store:"Home Goods",department_store:"Department Store",grocery_or_supermarket:"Grocery Store",furniture_store:"Furniture Store",electronics_store:"Electronics Store",clothing_store:"Clothing Store",shoe_store:"Shoe Store",beauty_salon:"Beauty Salon",hair_care:"Hair Salon",spa:"Spa",pharmacy:"Pharmacy",drugstore:"Pharmacy",bank:"Bank",atm:"ATM",shopping_mall:"Shopping Mall",supermarket:"Supermarket",convenience_store:"Convenience Store",car_dealer:"Car Dealer",car_repair:"Auto Repair",car_wash:"Car Wash",gym:"Gym",hospital:"Hospital",doctor:"Medical",dentist:"Dental",veterinary_care:"Veterinary",movie_theater:"Movie Theater",amusement_park:"Amusement Park",zoo:"Zoo",aquarium:"Aquarium",museum:"Museum",library:"Library",book_store:"Bookstore",jewelry_store:"Jewelry Store",florist:"Florist",pet_store:"Pet Store",bicycle_store:"Bike Shop",sporting_goods_store:"Sporting Goods"};for(const o of e)if(n[o])return n[o];return e[0].replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase()))}function addInitialMapMessage(e){const n=document.createElement("div");n.id="initial-map-message",n.innerHTML="Search for businesses to see them on the map",n.style.position="absolute",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.background="white",n.style.padding="10px",n.style.borderRadius="5px",n.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)",n.style.zIndex="1",e.appendChild(n)}function setupResetMapButton(){const e=document.getElementById("reset-map");e&&e.addEventListener("click",(function(){resetMapView()}))}function resetMapView(){if(mapInitialized&&map)try{safelySetCenter(map,CONFIG.defaultCenter,CONFIG.defaultZoom),infoWindow&&infoWindow.close()}catch(e){console.error("Error resetting map view:",e)}else console.error("Cannot reset map view - map not initialized")}function setupMarkerClickPriority(){map?(console.log("Setting up enhanced marker click priority"),google.maps.event.addListener(map,"click",(function(e){if(e.placeId){const n=e.latLng,o=20,s=map.getProjection();if(!s)return;const t=Math.pow(2,map.getZoom()),a=s.fromLatLngToPoint(n);for(const n of markers){if(!n.position)continue;const i=n.position,r=s.fromLatLngToPoint(i);if(Math.sqrt(Math.pow((a.x-r.x)*t,2)+Math.pow((a.y-r.y)*t,2))<=o)return console.log("Preventing POI click, using our enhanced marker instead"),e.stop(),void setTimeout((()=>{showEnhancedInfoWindow(n)}),10)}}}),{passive:!1})):console.error("Map not initialized, cannot set up click priority")}function initAdditionalMapFeatures(){console.log("Initializing additional map features"),addCustomMarkerStyleFixes(),setupMarkerClickPriority(),customizeInfoWindows()}function addCustomMarkerStyleFixes(){if(!document.getElementById("marker-style-fixes")){const e=document.createElement("style");e.id="marker-style-fixes",e.textContent="\n            /* Ensure proper marker display */\n            .marker-icon {\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                width: 20px;\n                height: 20px;\n                color: #333;\n            }\n            \n            /* Fix for Font Awesome icons */\n            .marker-icon i {\n                font-size: 12px !important;\n                color: #333 !important;\n            }\n            \n            /* Info window styling */\n            .info-window-actions .view-details-btn {\n                margin-top: 8px;\n            }\n        ",document.head.appendChild(e)}}function customizeInfoWindows(){applyInfoWindowScrollableStyles();const e=document.createElement("style");e.textContent="\n        .gm-ui-hover-effect {\n            opacity: 0.8 !important;\n            width: 24px !important;\n            height: 24px !important;\n            right: 2px !important;\n            top: 2px !important;\n        }\n        \n        .gm-ui-hover-effect span {\n            width: 16px !important;\n            height: 16px !important;\n        }\n        \n        .gm-ui-hover-effect:hover {\n            opacity: 1 !important;\n        }\n    ",document.head.appendChild(e)}function applyInfoWindowScrollableStyles(){if(!document.getElementById("info-window-scrollable-styles")){const e=document.createElement("style");e.id="info-window-scrollable-styles",e.textContent="\n            /* Info window structure */\n            .gm-style .gm-style-iw-c {\n                padding: 0 !important;\n                border-radius: 8px !important;\n                box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n                max-width: 330px !important;\n                max-height: 400px !important;\n                overflow: hidden !important;\n            }\n            \n            .gm-style .gm-style-iw-d {\n                overflow: auto !important;\n                max-height: 350px !important;\n                padding-right: 8px !important; /* Allow space for scrollbar */\n            }\n            \n            /* Custom info window styles */\n            .info-window {\n                padding: 12px;\n                max-width: 300px;\n            }\n            \n            .info-window h3 {\n                margin-top: 0;\n                margin-bottom: 10px;\n                color: #212121;\n                font-size: 16px;\n                line-height: 1.3;\n            }\n            \n            .info-window p {\n                margin: 6px 0;\n                font-size: 14px;\n                line-height: 1.4;\n            }\n            \n            .info-window-actions {\n                margin-top: 12px;\n                padding-top: 8px;\n                border-top: 1px solid #eee;\n                text-align: right;\n            }\n            \n            .add-business-btn {\n                background-color: #EA4335;\n                color: white;\n                border: none;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                margin-top: 5px;\n                font-size: 13px;\n                font-weight: 500;\n            }\n            \n            .add-business-btn:hover {\n                background-color: #D32F2F;\n            }\n            \n            .view-details-btn {\n                background-color: #4285F4;\n                color: white;\n                border: none;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                margin-top: 5px;\n                font-size: 13px;\n                font-weight: 500;\n            }\n            \n            .view-details-btn:hover {\n                background-color: #2A75F3;\n            }\n            \n            /* Incentives list */\n            .incentives-list {\n                margin: 8px 0;\n                padding-left: 20px;\n            }\n            \n            .incentives-list li {\n                margin-bottom: 6px;\n            }\n            \n            /* Custom scrollbar styles */\n            .gm-style .gm-style-iw-d::-webkit-scrollbar {\n                width: 6px;\n                height: 6px;\n            }\n            \n            .gm-style .gm-style-iw-d::-webkit-scrollbar-track {\n                background: #f1f1f1;\n                border-radius: 3px;\n            }\n            \n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb {\n                background: #c1c1c1;\n                border-radius: 3px;\n            }\n            \n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb:hover {\n                background: #a8a8a8;\n            }\n            \n            /* Close button adjustment */\n            .gm-ui-hover-effect {\n                top: 2px !important;\n                right: 2px !important;\n            }\n        ",document.head.appendChild(e)}}function fetchBusinessAndCreateMarker(e){console.log("Fetching business data for marker creation:",e);const n=getBaseURL();fetch(`${n}/api/business.js?operation=get&id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to fetch business: ${e.status}`);return e.json()})).then((n=>{if(n.result){console.log("Found business data:",n.result);const o=createBusinessMarker(n.result);o&&(map.setCenter(o.position),map.setZoom(15),showEnhancedInfoWindow(o),console.log("Created and focused on new enhanced marker for business:",e))}else console.error("Business data not found"),alert("Business information could not be found.");document.getElementById("map").scrollIntoView({behavior:"smooth"})})).catch((e=>{console.error("Error fetching business data:",e),alert("There was an error getting information for this business."),document.getElementById("map").scrollIntoView({behavior:"smooth"})}))}function isNotEmpty(e){return e&&""!==e.trim()}function validateField(e,n){console.log(`Validating ${e.id} with value: ${e.value}`),n(e.value)?(e.classList.remove("invalid-field"),e.classList.add("valid-field"),e.setAttribute("data-valid","true"),console.log(`${e.id} is VALID`)):(e.classList.remove("valid-field"),e.classList.add("invalid-field"),e.setAttribute("data-valid","false"),console.log(`${e.id} is INVALID`))}function displaySearchResults(e){try{hideLoadingIndicator();const n=document.getElementById("business_search"),o=document.getElementById("search_table");if(!n||!o)return console.error("Required elements not found in the DOM"),void showErrorMessage("There was an error displaying search results. Please try again later.");let s=n.querySelector("tbody");if(!s)return console.error("Table body not found within business_search table"),void showErrorMessage("There was an error displaying search results. Please try again later.");s.innerHTML="",Array.isArray(e)||(console.error("businesses is not an array:",e),e=[]),o.style.display="block";const t=o.querySelector("h5");if(t&&(t.style.display="none"),0===e.length)return s.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria.</td></tr>',void o.scrollIntoView({behavior:"smooth"});const a=e.filter((e=>!e.isGooglePlace)),i=e.filter((e=>e.isGooglePlace&&e.chain_id)),r=e.filter((e=>e.isGooglePlace&&!e.chain_id));console.log(`Businesses to display: ${a.length} from database, ${i.length} chain-matched Places, ${r.length} regular Places`),a.forEach((e=>{addBusinessRow(e,s,!1)})),i.forEach((e=>{addBusinessRow(e,s,!0)})),r.forEach((e=>{addBusinessRow(e,s,!0)})),o.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error displaying search results: ",e),hideLoadingIndicator(),showErrorMessage("There was an error displaying the search results: "+e.message)}}function addEnhancedLoadingCSS(){if(!document.getElementById("enhanced-loading-css")){const e=document.createElement("style");e.id="enhanced-loading-css",e.textContent="\n            .loading-indicator {\n                display: flex;\n                flex-direction: column;\n                justify-content: center;\n                align-items: center;\n                padding: 30px 20px;\n                text-align: center;\n                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);\n                border-radius: 8px;\n                margin: 20px 0;\n                box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            }\n\n            .loading-text {\n                font-size: 16px;\n                color: #333;\n                margin-bottom: 15px;\n                font-weight: 500;\n            }\n\n            .loading-spinner {\n                width: 40px;\n                height: 40px;\n                border: 4px solid #f3f3f3;\n                border-top: 4px solid #4285F4;\n                border-radius: 50%;\n                animation: spin 1s linear infinite;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n            }\n\n            @keyframes spin {\n                0% { transform: rotate(0deg); }\n                100% { transform: rotate(360deg); }\n            }\n\n            /* Enhanced error messages */\n            .error-message {\n                color: #721c24;\n                padding: 20px;\n                background: linear-gradient(135deg, #f8d7da 0%, #f1b0b7 100%);\n                border: 1px solid #f5c6cb;\n                border-radius: 8px;\n                margin: 20px 0;\n                text-align: center;\n                font-weight: 500;\n                box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n            }\n\n            /* Fade in animation for results */\n            .search-results-container {\n                animation: fadeIn 0.5s ease-in;\n            }\n\n            @keyframes fadeIn {\n                from { \n                    opacity: 0; \n                    transform: translateY(20px); \n                }\n                to { \n                    opacity: 1; \n                    transform: translateY(0); \n                }\n            }\n        ",document.head.appendChild(e)}}function fetchChainIncentivesForPlacesResult(e,n){if(!e||!n)return void console.error("Missing place ID or chain ID for fetching chain incentives");const o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${n}`;console.log("Fetching chain incentives for Places result: ",o),fetch(o).then((e=>{if(!e.ok)throw new Error(`Failed to fetch chain incentives: ${e.status}`);return e.json()})).then((n=>{console.log(`Chain incentives data for place ${e}:`,n);const o=document.getElementById(`incentives-for-${e}`);if(!o)return void console.error(`Could not find cell for incentives-for-${e}`);if(!n.results||0===n.results.length)return void(o.innerHTML="No chain incentives available");let s="";n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"";s+=`\n                        <div class="incentive-item">\n                            <strong>${n}${o}:</strong> ${e.amount}% \n                            <span class="chain-badge small">Chain-wide</span>\n                            <div class="incentive-info">${e.information||""}</div>\n                        </div>\n                    `}})),o.innerHTML=""===s?"Not in database yet":s})).catch((n=>{console.error(`Error fetching chain incentives for place ${e}:`,n);const o=document.getElementById(`incentives-for-${e}`);o&&(o.innerHTML="Not in database yet")}))}function checkIfUserIsAdmin(){try{const e=localStorage.getItem("patriotThanksSession");if(!e)return!1;const n=JSON.parse(e);return n.user&&(!0===n.user.isAdmin||"Admin"===n.user.level)}catch(e){return console.error("Error checking admin status:",e),!1}}function performIncentivesFetch(e,n){const o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${e}`;console.log("Fetching incentives from:",o),fetch(o).then((e=>{if(!e.ok)throw new Error(`Failed to fetch incentives: ${e.status}`);return e.json()})).then((o=>{if(console.log(`Incentives data for business ${e}:`,o),!o.results||0===o.results.length)return void(n.innerHTML="<p><strong>Incentives:</strong> No incentives found</p>");let s='<p><strong>Incentives:</strong></p><ul style="margin:8px 0; padding-left:20px;">';o.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"",t=e.is_chain_wide?'<span style="display:inline-block; background-color:#4285F4; color:white; padding:1px 4px; border-radius:4px; font-size:0.7em; margin-left:5px;">Chain-wide</span>':"";s+=`\n                        <li>\n                            <strong>${n}${o}:</strong> ${e.amount}% ${t}\n                            ${e.information?`<div style="font-size:13px; color:#555; margin-top:2px;">${e.information}</div>`:""}\n                        </li>\n                    `}})),s+="</ul>",n.innerHTML='<p><strong>Incentives:</strong></p><ul style="margin:8px 0; padding-left:20px;"></ul>'===s?"<p><strong>Incentives:</strong> No active incentives found</p>":s})).catch((e=>{console.error(`Error fetching incentives for info window: ${e}`),n.innerHTML="<p><strong>Incentives:</strong> Error loading incentives</p>"}))}function getBusinessTypeTextIcon(e){return`<span style="font-size: 16px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${{AUTO:"üöó",BEAU:"üíá",BOOK:"üìö",CLTH:"üëï",CONV:"üè™",DEPT:"üõçÔ∏è",ELEC:"‚ö°",ENTR:"üé¨",FURN:"ü™ë",FUEL:"‚õΩ",GIFT:"üéÅ",GROC:"üõí",HARDW:"üî®",HEAL:"‚ù§Ô∏è",JEWL:"üíé",OTHER:"üè¨",RX:"üíä",REST:"üçΩÔ∏è",RETAIL:"üõçÔ∏è",SERV:"üîß",SPEC:"‚≠ê",SPRT:"üèà",TECH:"üíª",TOYS:"üéÆ"}[e]||"üè¨"}</span>`}function createEnhancedFallbackMarker(e,n){try{console.log("Creating enhanced fallback marker for:",e.bname);let o=createSafeLatLng(n);if(!o&&e.lat&&e.lng&&(o=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng))),!o)return console.error("Invalid location for enhanced fallback marker:",n),null;const s=!e.isGooglePlace,t=(e.chain_id,s?CONFIG.markerColors.primary:CONFIG.markerColors.nearby),a=new google.maps.Marker({position:o,map,title:e.bname,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:t,fillOpacity:.9,strokeWeight:2,strokeColor:"#FFFFFF",scale:s?14:12},animation:google.maps.Animation.DROP,zIndex:s?1e3:100});return a.business=e,a.position=o,a.isFromDatabase=s,a.addListener("click",(function(){console.log("Enhanced fallback marker clicked:",e.bname),showEnhancedInfoWindow(a)})),markers.push(a),console.log(`Added enhanced fallback marker for ${e.bname}`),a}catch(e){return console.error("Error creating enhanced fallback marker:",e),null}}function showEnhancedInfoWindow(e){if(console.log("showEnhancedInfoWindow called with marker:",e),!e||!e.business)return void console.error("Invalid marker for enhanced info window",e);const n=e.business,o=!0===n.isGooglePlace,s=!!n.chain_id;infoWindow&&infoWindow.close(),infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1});const t=buildEnhancedInfoWindowContent(n);infoWindow.setContent(t);let a=e.position;if(!a&&e.getPosition&&(a=e.getPosition()),a||(a=createSafeLatLng(n)),a){try{map.panTo(a)}catch(e){console.warn("Error panning to position:",e)}setTimeout((()=>{try{e.getPosition?infoWindow.open(map,e):(infoWindow.setPosition(a),infoWindow.open(map)),console.log("Enhanced info window opened successfully"),google.maps.event.addListenerOnce(infoWindow,"domready",(function(){setTimeout((()=>{applyEnhancedInfoWindowFixes(),o?s&&(console.log(`Loading chain incentives for place: ${n.placeId}, chain: ${n.chain_id}`),loadChainIncentivesForEnhancedWindow(n.placeId,n.chain_id)):loadIncentivesForEnhancedWindow(n._id)}),200)}))}catch(e){console.error("Error opening enhanced info window:",e)}}),200)}else console.error("Could not determine position for enhanced info window")}function buildEnhancedInfoWindowContent(e){const n=!0===e.isGooglePlace,o=!!e.chain_id;let s="";if(e.address1){s=`<div class="info-address">\n            <strong>üìç Address:</strong><br>\n            ${e.address1}`,e.address2&&(s+=`<br>${e.address2}`);const n=[];e.city&&n.push(e.city),e.state&&n.push(e.state),e.zip&&n.push(e.zip),n.length>0&&(s+=`<br>${n.join(", ")}`),s+="</div>"}else if(e.formattedAddress){const n=e.formattedAddress.split(",").map((e=>e.trim()));s='<div class="info-address">\n            <strong>üìç Address:</strong><br>',n.length>=1&&(s+=n[0]),n.length>=2&&(s+=`<br>${n.slice(1).join(", ")}`),s+="</div>"}const t=e.phone?`<div class="info-phone"><strong>üìû Phone:</strong> <a href="tel:${e.phone.replace(/\D/g,"")}" style="color: #4285F4; text-decoration: none;">${e.phone}</a></div>`:"";let a="";e.type&&"OTHER"!==e.type&&(a=`<div class="info-type"><strong>üè¢ Type:</strong> ${getBusinessTypeLabel(e.type)}</div>`);const i=e.distance?`<div class="info-distance"><strong>üìè Distance:</strong> ${(e.distance/1609).toFixed(1)} miles</div>`:"",r=o?`<span class="enhanced-chain-badge">üîó ${e.chain_name||"Chain Location"}</span>`:"";let l,c="",d="";n?o?(c='<div class="info-status chain-match">üîó This location appears to match a chain in our database!</div>',d=`<div class="chain-explanation">\n                ‚ú® Great news! This location matches <strong>${e.chain_name}</strong> in our database. \n                Chain-wide incentives should apply to this location once added.\n            </div>`):c='<div class="info-status google-place">‚ÑπÔ∏è This business is not yet in the Patriot Thanks database.</div>':c='<div class="info-status database-business">‚úÖ This business is in the Patriot Thanks database.</div>',l=n?o?`\n                <button class="enhanced-add-btn chain-add" onclick="window.addBusinessToDatabase('${e.placeId}', '${e.chain_id}')">\n                    üîó Add ${e.chain_name} Location\n                </button>\n            `:`\n                <button class="enhanced-add-btn" onclick="window.addBusinessToDatabase('${e.placeId}')">\n                    ‚ûï Add to Patriot Thanks\n                </button>\n            `:`\n            <button class="enhanced-view-btn" onclick="window.viewBusinessDetails('${e._id}')">\n                üëÅÔ∏è View Details\n            </button>\n        `;const g=e._id||e.placeId;let u;return u=n&&o?"<em>‚è≥ Loading chain incentives...</em>":n&&!o?"<em>üí° Add this business to see available incentives.</em>":"<em>‚è≥ Loading incentives...</em>",`\n        <div class="enhanced-info-window">\n            <div class="info-header">\n                <h3>${e.bname} ${r}</h3>\n            </div>\n            \n            <div class="info-body">\n                ${s}\n                ${t}\n                ${a}\n                ${i}\n                ${c}\n                ${d}\n                \n                <div class="info-incentives">\n                    <div id="incentives-container-${g}">\n                        ${u}\n                    </div>\n                </div>\n            </div>\n            \n            <div class="info-actions">\n                ${l}\n            </div>\n        </div>\n    `}function loadIncentivesForEnhancedWindow(e){const n=document.getElementById(`incentives-container-${e}`);if(!n)return void console.error("Enhanced incentives container not found for business:",e);const o=getBaseURL();fetch(`${o}/api/combined-api.js?operation=incentives&business_id=${e}`).then((e=>e.json())).then((e=>{if(!e.results||0===e.results.length)return void(n.innerHTML="<em>üí≠ No incentives available</em>");let o='<div class="incentives-header"><strong>üéÅ Available Incentives:</strong></div>';o+='<div class="incentives-list">',e.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),s=e.other_description?` (${e.other_description})`:"",t=e.is_chain_wide?'<span class="mini-chain-badge">üîó Chain-wide</span>':"";o+=`\n                        <div class="incentive-item">\n                            <div class="incentive-type">${n}${s}:</div>\n                            <div class="incentive-amount">${e.amount}% ${t}</div>\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),o+="</div>",n.innerHTML=o})).catch((e=>{console.error("Error loading incentives:",e),n.innerHTML="<em>‚ùå Error loading incentives</em>"}))}function loadChainIncentivesForEnhancedWindow(e,n){const o=document.getElementById(`incentives-container-${e}`);if(o)loadChainIncentivesInContainer(o,n);else{console.error("Enhanced chain incentives container not found for place:",e);const o=document.getElementById(`incentives-container-google_${e}`);if(o)return console.log("Found alternative container ID format"),void loadChainIncentivesInContainer(o,n);const s=document.querySelectorAll('[id*="incentives-container"]');console.log("Available incentives containers:",Array.from(s).map((e=>e.id)))}}function loadChainIncentivesInContainer(e,n){const o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${n}`;console.log("Loading chain incentives from:",o),fetch(o).then((e=>e.json())).then((n=>{if(!n.results||0===n.results.length)return void(e.innerHTML="<em>üí≠ No chain incentives available</em>");let o='<div class="incentives-header"><strong>üéÅ Chain-wide Incentives:</strong></div>';o+='<div class="incentives-list">',n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),s=e.other_description?` (${e.other_description})`:"";o+=`\n                        <div class="incentive-item chain-incentive">\n                            <div class="incentive-type">${n}${s}:</div>\n                            <div class="incentive-amount">${e.amount}% <span class="mini-chain-badge">üîó Chain-wide</span></div>\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),o+="</div>",o+='<div class="chain-note">‚ú® Great! These incentives apply to all locations of this chain.</div>',e.innerHTML=o,console.log("Successfully loaded chain incentives")})).catch((n=>{console.error("Error loading chain incentives:",n),e.innerHTML="<em>‚ùå Error loading chain incentives</em>"}))}function applyEnhancedInfoWindowFixes(){const e=document.querySelector(".gm-style-iw-c"),n=document.querySelector(".gm-style-iw-d"),o=document.querySelector(".gm-style-iw-t");if(e){const n=e.getBoundingClientRect();n.width<50&&(e.style.width="auto",e.style.minWidth="300px",e.style.maxWidth="350px"),e.style.padding="0",e.style.margin="0",(n.top<0||n.top>window.innerHeight||n.left<0||n.left>window.innerWidth)&&(e.style.position="relative",e.style.transform="none")}n&&(n.style.padding="0",n.style.margin="0",n.style.overflow="auto",n.style.maxHeight="350px"),o&&(o.style.bottom="0px",o.style.left="50%",o.style.right="auto",o.style.transform="translateX(-50%)"),console.log("Applied enhanced info window fixes with proper padding")}function addEnhancedMarkerStyles(){if(!document.getElementById("enhanced-marker-styles")){const e=document.createElement("style");e.id="enhanced-marker-styles",e.textContent="\n            /* Enhanced marker container */\n            .enhanced-custom-marker {\n                cursor: pointer;\n                transition: transform 0.2s ease;\n                z-index: 100;\n            }\n\n            .enhanced-marker-container {\n                position: relative;\n                width: 36px;\n                height: 46px;\n            }\n\n            /* Enhanced pin styling */\n            .enhanced-marker-pin {\n                width: 32px;\n                height: 40px;\n                border-radius: 50% 50% 50% 0;\n                transform: rotate(-45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                box-shadow: 0 3px 6px rgba(0,0,0,0.3);\n                position: absolute;\n                top: 0;\n                left: 2px;\n                border: 2px solid white;\n            }\n\n            .enhanced-marker-pin.primary {\n                background: linear-gradient(45deg, #EA4335, #FF6B6B);\n            }\n\n            .enhanced-marker-pin.nearby {\n                background: linear-gradient(45deg, #4285F4, #64B5F6);\n            }\n\n            /* Enhanced icon styling */\n            .enhanced-marker-icon {\n                transform: rotate(45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                width: 20px;\n                height: 20px;\n                font-size: 16px;\n                filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5));\n            }\n\n            /* Enhanced shadow */\n            .enhanced-marker-shadow {\n                position: absolute;\n                bottom: -2px;\n                left: 8px;\n                width: 20px;\n                height: 8px;\n                background: radial-gradient(ellipse, rgba(0,0,0,0.3) 0%, transparent 70%);\n                border-radius: 50%;\n                filter: blur(1px);\n            }\n\n            /* Chain indicator */\n            .chain-indicator {\n                position: absolute;\n                top: -5px;\n                right: -5px;\n                background: #FFD700;\n                border-radius: 50%;\n                width: 18px;\n                height: 18px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 10px;\n                border: 2px solid white;\n                box-shadow: 0 1px 3px rgba(0,0,0,0.3);\n                z-index: 1001;\n            }\n\n            /* CRITICAL: Google Maps info window container fixes */\n            .gm-style .gm-style-iw-c {\n                padding: 0 !important;\n                border-radius: 8px !important;\n                box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n                max-width: 350px !important;\n                max-height: 400px !important;\n                overflow: hidden !important;\n            }\n\n            .gm-style .gm-style-iw-d {\n                overflow: auto !important;\n                max-height: 350px !important;\n                padding: 0 !important;\n                /* Add proper padding that Google Maps won't strip */\n                margin: 0 !important;\n            }\n\n            /* Enhanced info window styles with proper padding */\n            .enhanced-info-window {\n                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n                max-width: 320px;\n                line-height: 1.4;\n                /* CRITICAL: Add padding to the content container instead of relying on Google's padding */\n                padding: 12px 12px 12px 12px !important;\n                margin: 0;\n                box-sizing: border-box;\n            }\n\n            .info-header {\n                border-bottom: 2px solid #f0f0f0;\n                padding-bottom: 8px;\n                margin-bottom: 12px;\n            }\n\n            .info-header h3 {\n                margin: 0;\n                font-size: 16px;\n                color: #333;\n                font-weight: 600;\n            }\n\n            .enhanced-chain-badge {\n                display: inline-block;\n                background: linear-gradient(45deg, #4285F4, #64B5F6);\n                color: white;\n                padding: 2px 8px;\n                border-radius: 12px;\n                font-size: 11px;\n                margin-left: 8px;\n                font-weight: 500;\n            }\n\n            .info-body > div {\n                margin: 8px 0;\n                font-size: 14px;\n            }\n\n            .info-address, .info-phone, .info-type, .info-distance {\n                color: #555;\n            }\n\n            .info-status {\n                padding: 6px 10px;\n                border-radius: 6px;\n                font-size: 13px;\n                margin: 10px 0;\n            }\n\n            .info-status.database-business {\n                background-color: #e8f5e8;\n                color: #2e7d32;\n            }\n\n            .info-status.google-place {\n                background-color: #e3f2fd;\n                color: #1565c0;\n            }\n\n            .chain-explanation {\n                background-color: #fff3e0;\n                padding: 8px;\n                border-radius: 6px;\n                font-size: 13px;\n                color: #ef6c00;\n                border-left: 3px solid #ff9800;\n            }\n\n            .info-incentives {\n                margin: 12px 0;\n            }\n\n            .incentives-header {\n                font-weight: 600;\n                color: #333;\n                margin-bottom: 8px;\n            }\n\n            .incentive-item {\n                background-color: #f8f9fa;\n                padding: 8px;\n                border-radius: 6px;\n                margin: 6px 0;\n                border-left: 3px solid #4285F4;\n            }\n\n            .incentive-type {\n                font-weight: 500;\n                color: #333;\n            }\n\n            .incentive-amount {\n                font-size: 16px;\n                font-weight: 600;\n                color: #2e7d32;\n                margin: 2px 0;\n            }\n\n            .incentive-info {\n                font-size: 12px;\n                color: #666;\n                font-style: italic;\n                margin-top: 4px;\n            }\n\n            .mini-chain-badge {\n                background: #4285F4;\n                color: white;\n                padding: 1px 6px;\n                border-radius: 8px;\n                font-size: 10px;\n                margin-left: 4px;\n            }\n\n            .chain-note {\n                font-size: 12px;\n                color: #666;\n                font-style: italic;\n                margin-top: 8px;\n                padding: 4px 8px;\n                background-color: #f0f8ff;\n                border-radius: 4px;\n            }\n\n            .info-actions {\n                margin-top: 12px;\n                padding-top: 12px;\n                border-top: 1px solid #eee;\n                text-align: center;\n                /* Add bottom margin to ensure spacing at bottom */\n                margin-bottom: 4px;\n            }\n\n            .enhanced-add-btn, .enhanced-view-btn {\n                background: linear-gradient(45deg, #4285F4, #64B5F6);\n                color: white;\n                border: none;\n                padding: 10px 20px;\n                border-radius: 8px;\n                cursor: pointer;\n                font-weight: 500;\n                font-size: 14px;\n                transition: all 0.2s ease;\n                width: 100%;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n            }\n\n            .enhanced-add-btn {\n                background: linear-gradient(45deg, #EA4335, #FF6B6B);\n            }\n\n            .enhanced-add-btn:hover, .enhanced-view-btn:hover {\n                transform: translateY(-1px);\n                box-shadow: 0 4px 8px rgba(0,0,0,0.15);\n            }\n\n            /* ENHANCED SCROLLBAR - More visible and styled */\n            .gm-style .gm-style-iw-d::-webkit-scrollbar {\n                width: 8px;\n                height: 8px;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-track {\n                background: #f1f1f1;\n                border-radius: 4px;\n                border: 1px solid #e0e0e0;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb {\n                background: linear-gradient(180deg, #4285F4, #64B5F6);\n                border-radius: 4px;\n                border: 1px solid #3367D6;\n                box-shadow: inset 0 1px 2px rgba(255,255,255,0.3);\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb:hover {\n                background: linear-gradient(180deg, #3367D6, #4285F4);\n                cursor: pointer;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb:active {\n                background: linear-gradient(180deg, #2A56C6, #3367D6);\n            }\n\n            /* Add padding indicator when content is scrollable */\n            .gm-style .gm-style-iw-d::before {\n                content: '';\n                display: block;\n                height: 1px;\n                width: 100%;\n                background: transparent;\n            }\n\n            .gm-style .gm-style-iw-d::after {\n                content: '';\n                display: block;\n                height: 1px;\n                width: 100%;\n                background: transparent;\n            }\n\n            /* Responsive adjustments */\n            @media (max-width: 400px) {\n                .enhanced-info-window {\n                    max-width: 280px;\n                    padding: 10px 10px 10px 10px !important;\n                }\n                \n                .enhanced-marker-container {\n                    width: 32px;\n                    height: 42px;\n                }\n                \n                .enhanced-marker-pin {\n                    width: 28px;\n                    height: 36px;\n                }\n\n                .gm-style .gm-style-iw-d::-webkit-scrollbar {\n                    width: 6px;\n                }\n            }\n\n            /* Fix for tail positioning */\n            .gm-style .gm-style-iw-t {\n                bottom: 0px !important;\n                left: 50% !important;\n                right: auto !important;\n                transform: translateX(-50%) !important;\n                width: 20px !important;\n                height: 15px !important;\n            }\n\n            /* Ensure close button is properly positioned */\n            .gm-ui-hover-effect {\n                opacity: 0.8 !important;\n                top: 8px !important;\n                right: 8px !important;\n                width: 24px !important;\n                height: 24px !important;\n                z-index: 1002 !important;\n            }\n\n            .gm-ui-hover-effect:hover {\n                opacity: 1 !important;\n            }\n        ",document.head.appendChild(e)}}function searchNearbyBusinesses(e,n){try{console.log("Searching for nearby similar businesses near",e.lat(),e.lng()),console.log("Primary business type:",n);const o=getSimilarBusinessTypes(n);if(console.log("Looking for similar business types:",o),0===o.length)return void console.log("No similar business types defined for:",n);const s=getBaseURL(),t=o.map((n=>{const o=`${s}/api/business.js?operation=search&type=${n}&lat=${e.lat()}&lng=${e.lng()}&radius=15`;return console.log("Searching for similar businesses:",o),fetch(o).then((e=>{if(!e.ok)throw new Error(`Failed to fetch businesses of type ${n}: ${e.status}`);return e.json()})).then((e=>({businessType:n,results:e.results||[]})))}));Promise.all(t).then((n=>{let o=[];if(n.forEach((e=>{e.results.length>0&&(console.log(`Found ${e.results.length} businesses of type ${e.businessType}`),o=o.concat(e.results))})),0===o.length)return void console.log("No similar businesses found in the area");console.log(`Found ${o.length} total potential similar businesses`);const s=markers.map((e=>e.business?._id)).filter((e=>e)),t=markers.map((e=>e.business?.bname.toLowerCase())).filter((e=>e)),a=o.filter((e=>{if(s.includes(e._id))return!1;const n=e.bname.toLowerCase();return!t.some((e=>n.includes(e)||e.includes(n)))}));console.log(`${a.length} new similar businesses to add to map`);let i=0;a.forEach((n=>{n.isNearby=!0,n.isSimilarBusiness=!0;const o=getBusinessLocation(n);if(o){const s=new google.maps.LatLng(o.lat,o.lng),t=google.maps.geometry.spherical.computeDistanceBetween(e,s);t<=24140?createSimilarBusinessMarker(n,s)&&(i++,console.log(`Added similar business: ${n.bname} (${(t/1609).toFixed(1)} miles) - ${getBusinessTypeLabel(n.type)}`)):console.log(`Skipping distant similar business: ${n.bname} (${(t/1609).toFixed(1)} miles)`)}else console.warn(`Similar business ${n.bname} missing coordinates`)})),console.log(`Added ${i} similar businesses with blue markers`)})).catch((e=>{console.error("Error searching for similar businesses:",e)}))}catch(e){console.error("Error in searchNearbyBusinesses:",e)}}function getSimilarBusinessTypes(e){return({HARDW:["HARDW","DEPT"],REST:["REST"],GROC:["GROC","CONV"],DEPT:["DEPT","RETAIL","HARDW"],CLTH:["CLTH","DEPT"],ELEC:["ELEC","DEPT","TECH"],FURN:["FURN","DEPT"],AUTO:["AUTO","FUEL"],BEAU:["BEAU","RX"],RX:["RX","BEAU","GROC"],ENTR:["ENTR"],SPRT:["SPRT","DEPT"],FUEL:["FUEL","CONV"],CONV:["CONV","FUEL","GROC"],SERV:["SERV"],OTHER:["OTHER","RETAIL"]}[e]||[e]).filter((n=>n!==e))}function getBusinessLocation(e){let n,o;if(e.location&&e.location.coordinates&&Array.isArray(e.location.coordinates)&&e.location.coordinates.length>=2)o=e.location.coordinates[0],n=e.location.coordinates[1];else{if(void 0===e.lat||void 0===e.lng)return null;n=parseFloat(e.lat),o=parseFloat(e.lng)}return isNaN(n)||isNaN(o)?null:{lat:n,lng:o}}function createSimilarBusinessMarker(e,n){try{return e.lat=n.lat(),e.lng=n.lng(),createEnhancedBusinessMarker(e,n,!0)}catch(o){return console.error("Error creating similar business marker:",o),createEnhancedFallbackMarker(e,n)}}async function createEnhancedBusinessMarker(e,n,o=!1){try{const{AdvancedMarkerElement:s}=await google.maps.importLibrary("marker");let t=createSafeLatLng(n);if(!t)return console.error("Invalid position for enhanced marker:",n),createEnhancedFallbackMarker(e,n);const a=!e.isGooglePlace;let i,r;o||!0===e.isNearby||!0===e.isSimilarBusiness||e.isSimilarBusiness?(i=CONFIG.markerColors.nearby,r="nearby"):a?(i=CONFIG.markerColors.primary,r="primary"):(i=CONFIG.markerColors.nearby,r="nearby");const l=getBusinessTypeTextIcon(e.type),c=document.createElement("div");c.className="enhanced-custom-marker",c.setAttribute("title",e.bname),c.style.cursor="pointer",c.innerHTML=`\n            <div class="enhanced-marker-container">\n                <div class="enhanced-marker-pin ${r}" style="background-color: ${i};">\n                    <div class="enhanced-marker-icon">\n                        ${l}\n                    </div>\n                </div>\n                <div class="enhanced-marker-shadow"></div>\n                ${e.chain_id?'<div class="chain-indicator">‚≠ê</div>':""}\n                ${e.isSimilarBusiness?'<div class="similar-indicator">‚âà</div>':""}\n            </div>\n        `;const d=new s({position:t,map,title:e.bname,content:c,collisionBehavior:a?"REQUIRED_AND_HIDES_OPTIONAL":"OPTIONAL_AND_HIDES_LOWER_PRIORITY"});return d.business=e,d.position=t,d.isFromDatabase=a,d.isSimilarBusiness=e.isSimilarBusiness||o,c.addEventListener("click",(function(n){console.log("Enhanced similar business marker clicked:",e.bname),n.stopPropagation(),showEnhancedInfoWindow(d)})),c.addEventListener("mouseenter",(function(){c.style.transform="scale(1.1)",c.style.zIndex="1000"})),c.addEventListener("mouseleave",(function(){c.style.transform="scale(1)",c.style.zIndex="auto"})),markers.push(d),console.log(`Added enhanced ${e.isSimilarBusiness?"similar business":""} marker for ${e.bname}`),d}catch(o){return console.error("Error creating enhanced marker:",o),createEnhancedFallbackMarker(e,n)}}"undefined"!=typeof window&&(window.showInfoWindow=showInfoWindow,window.fixInfoWindowPositioning=fixInfoWindowPositioning),window.testTailFix=function(){console.log("Testing tail fix...");const e=document.getElementById("css-only-tail-fix");e&&(e.remove(),console.log("Removed existing tail fix")),applyCSSOnlyTailFix(),infoWindow&&(infoWindow.close(),console.log("Closed info window. Click a marker to test the tail fix."))},window.testInfoWindow=function(){console.log("=== TESTING INFO WINDOW SETUP ==="),removeAggressiveCSS(),applyBasicInfoWindowCSS(),infoWindow&&infoWindow.close(),console.log("Reset complete. Try clicking a marker now."),console.log("If it still doesn't work, run: checkAndReportInfoWindowPosition()")},console.log("Step-by-step info window fix loaded. Run testInfoWindow() in console to reset everything."),window.debugInfoWindow=function(){console.log("Starting info window debug..."),removeProblematicInfoWindowCSS(),infoWindow&&infoWindow.close(),console.log("Ready for testing - try clicking a marker now")},console.log("Google Places address parsing fix loaded successfully!"),window.initGoogleMap=function(){console.log("Enhanced initGoogleMap function called");try{applyMapHeightFix();const e=document.getElementById("map");if(!e)return void console.error("Map container not found in the DOM");console.log("Map container dimensions:",e.offsetWidth,"x",e.offsetHeight),map?(console.log("Map already exists, applying height fix and triggering resize"),applyMapHeightFix(),setTimeout((()=>{google.maps.event.trigger(map,"resize")}),100)):(map=new google.maps.Map(e,{center:CONFIG.defaultCenter,zoom:CONFIG.defaultZoom,mapId:CONFIG.mapId||"ebe8ec43a7bc252d",clickableIcons:!0,gestureHandling:"greedy",zoomControl:!0,mapTypeControl:!1,scaleControl:!0,streetViewControl:!1,rotateControl:!1,fullscreenControl:!0}),console.log("Map object created with enhanced settings:",!!map),infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1,pixelOffset:new google.maps.Size(0,-10)}),bounds=new google.maps.LatLngBounds,addInitialMapMessage(e),setupResetMapButton(),mapInitialized=!0,console.log("Google Map successfully initialized with enhanced settings"),pendingBusinessesToDisplay.length>0&&(console.log("Processing pending businesses to display on map"),displayBusinessesOnMap(pendingBusinessesToDisplay),pendingBusinessesToDisplay=[]),setupMapClickHandler(),setupMarkerClickPriority(),initAdditionalMapFeatures(),setTimeout((()=>{google.maps.event.trigger(map,"resize")}),200))}catch(e){console.error("Error initializing Google Map:",e),mapInitialized=!1;const n=document.getElementById("map");n&&(n.innerHTML=`\n                <div style="text-align: center; padding: 20px;">\n                    <p>Sorry, we couldn't load the map. Please try refreshing the page.</p>\n                    <p>Error: ${e.message}</p>\n                </div>\n            `)}},window.debugEnhancedMarkers=function(){console.log("=== ENHANCED MARKER DEBUG ==="),console.log("Total markers:",markers.length),markers.forEach(((e,n)=>{console.log(`Marker ${n}:`,{business:e.business?.bname,isFromDatabase:e.isFromDatabase,position:e.position,hasAdvancedMarker:e instanceof google.maps.marker?.AdvancedMarkerElement})})),console.log("Enhanced styles loaded:",!!document.getElementById("enhanced-marker-styles")),console.log("=== END DEBUG ===")},console.log("Enhanced marker integration loaded successfully!"),console.log("Run debugEnhancedMarkers() in console to check marker status"),window.focusOnMapMarker=function(e){if(console.log("focusOnMapMarker called for business ID:",e),!mapInitialized||!map)return console.error("Map not initialized yet - cannot focus on marker"),void alert("Map is still loading. Please try again in a moment.");if(!markers||0===markers.length)return console.warn("No markers available yet."),void fetchBusinessAndCreateMarker(e);const n=markers.find((n=>n.business&&n.business._id===e));if(n)try{let o;if(n.getPosition&&"function"==typeof n.getPosition)o=n.getPosition();else if(n.position)o=n.position;else{if(!(n.business&&n.business.lat&&n.business.lng))return console.error("Could not determine marker position"),void alert("Could not focus on this business on the map.");o=new google.maps.LatLng(parseFloat(n.business.lat),parseFloat(n.business.lng))}map.setCenter(o),map.setZoom(16),showEnhancedInfoWindow(n),document.getElementById("map").scrollIntoView({behavior:"smooth"}),console.log("Successfully focused on marker for business:",e)}catch(e){console.error("Error focusing on marker:",e),alert("There was an error focusing on this business on the map.")}else console.warn(`No marker found for business ID: ${e}`),fetchBusinessAndCreateMarker(e)},document.addEventListener("DOMContentLoaded",(function(){console.log("DOM loaded, initializing enhanced business search..."),addEnhancedMarkerStyles(),setTimeout((()=>{applyInfoWindowPositioningFixes(),applyMapHeightFix(),applyInfoWindowCSS(),applyCSSOnlyTailFix(),applyInfoWindowPositioningFixes(),removeProblematicInfoWindowCSS()}),500),addCustomMarkerStyles(),addChainBadgeStyles(),initBusinessSearch(),checkForNewlyAddedBusiness(),window.google&&window.google.maps?(console.log("Google Maps already loaded, initializing map"),initGoogleMap()):console.log("Google Maps not yet loaded, will be initialized via callback")}));const COMPREHENSIVE_CHAIN_DATABASE={homedepot:{id:"681fe0e67d92c3d3e1e2a3da",canonicalName:"The Home Depot",variations:["home depot","the home depot","homedepot","home depot store","the home depot store"],keywords:["home","depot","hardware","improvement"]},olivegardenitalian:{id:"olive_garden_chain_id",canonicalName:"Olive Garden",variations:["olive garden","olive garden italian restaurant","olive garden italian","olivegarden","olive garden restaurant"],keywords:["olive","garden","italian","restaurant","pasta"]},lowes:{id:"lowes_chain_id",canonicalName:"Lowe's",variations:["lowes","lowe's","lowes home improvement","lowe's home improvement","lowes companies","lowe's companies"],keywords:["lowes","lowe's","home","improvement","hardware"]},mcdonalds:{id:"mcdonalds_chain_id",canonicalName:"McDonald's",variations:["mcdonalds","mcdonald's","mickey d's","micky d's","mcdonalds restaurant","mcdonald's restaurant"],keywords:["mcdonalds","mcdonald's","fast","food","burger"]},walmart:{id:"walmart_chain_id",canonicalName:"Walmart",variations:["walmart","wal-mart","walmart supercenter","wal-mart supercenter","walmart store","wal-mart store"],keywords:["walmart","wal-mart","supercenter","retail"]},target:{id:"target_chain_id",canonicalName:"Target",variations:["target","target store","target corporation","target retail"],keywords:["target","retail","store"]},bestbuy:{id:"bestbuy_chain_id",canonicalName:"Best Buy",variations:["best buy","bestbuy","best buy store","bestbuy store"],keywords:["best","buy","electronics","tech"]},starbucks:{id:"starbucks_chain_id",canonicalName:"Starbucks",variations:["starbucks","starbucks coffee","starbucks corporation","starbucks store"],keywords:["starbucks","coffee","cafe"]}};function calculateSimilarity(e,n){if(!e||!n)return 0;const o=e.toLowerCase().trim(),s=n.toLowerCase().trim();if(o===s)return 1;if(o.includes(s)||s.includes(o))return.9;const t=1-levenshteinDistance(o,s)/Math.max(o.length,s.length);return Math.max(0,t)}function levenshteinDistance(e,n){const o=[];for(let e=0;e<=n.length;e++)o[e]=[e];for(let n=0;n<=e.length;n++)o[0][n]=n;for(let s=1;s<=n.length;s++)for(let t=1;t<=e.length;t++)n.charAt(s-1)===e.charAt(t-1)?o[s][t]=o[s-1][t-1]:o[s][t]=Math.min(o[s-1][t-1]+1,o[s][t-1]+1,o[s-1][t]+1);return o[n.length][e.length]}function extractKeywords(e){if(!e)return[];const n=["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","up","about","into","over","after","store","restaurant","inc","llc","corp","company","companies"];return e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter((e=>e.length>1&&!n.includes(e))).filter(Boolean)}async function findMatchingChainForPlaceResult(e){try{if(!e)return null;console.log("üîç Advanced chain matching for:",e);const n=e.trim();let o=null,s=0;const t=.7;try{const e=await tryServerSideChainMatching(n);if(e)return console.log("‚úÖ Server-side exact match found:",e.bname),e}catch(e){console.warn("Server-side matching failed, using local matching:",e.message)}const a=extractKeywords(n);console.log("üè∑Ô∏è Search keywords:",a);for(const[e,i]of Object.entries(COMPREHENSIVE_CHAIN_DATABASE)){for(const e of i.variations){const a=calculateSimilarity(n,e);a>s&&a>=t&&(s=a,o={_id:i.id,bname:i.canonicalName,matchType:"variation",matchScore:a,matchedVariation:e})}const e=a.filter((e=>i.keywords.some((n=>calculateSimilarity(e,n)>=.8))));if(e.length>=2){const n=.8;n>s&&(s=n,o={_id:i.id,bname:i.canonicalName,matchType:"keywords",matchScore:n,matchedKeywords:e})}}if(o){console.log(`üéØ Best match found: "${n}" ‚Üí "${o.bname}" (${o.matchType}, score: ${o.matchScore.toFixed(2)})`);try{const e=await getChainFromDatabase(o.bname);if(e)return e}catch(e){console.warn("Could not fetch chain from database:",e)}return o}return console.log("‚ùå No suitable chain match found for:",n),null}catch(e){return console.error("Error in advanced chain matching:",e),null}}async function tryServerSideChainMatching(e){const n=getBaseURL(),o=[e,...generateNameVariations(e)];for(const e of o)try{const o=await fetch(`${n}/api/business.js?operation=find_matching_chain&place_name=${encodeURIComponent(e)}`);if(o.ok){const n=await o.json();if(n.success&&n.chain)return console.log(`Server match found with "${e}":`,n.chain.bname),n.chain}}catch(e){continue}return null}async function getChainFromDatabase(e){try{const n=getBaseURL(),o=await fetch(`${n}/api/business.js?operation=search&business_name=${encodeURIComponent(e)}&is_chain=true`);if(o.ok){const e=await o.json();if(e.results&&e.results.length>0){const n=e.results.find((e=>!0===e.is_chain));if(n)return{_id:n._id,bname:n.bname}}}return null}catch(e){return console.error("Error fetching chain from database:",e),null}}function generateNameVariations(e){const n=[],o=e.toLowerCase();return o.startsWith("the ")?n.push(e.substring(4)):n.push("The "+e),[" italian restaurant"," italian"," restaurant"," store"," location"," home improvement"," companies"," corporation"," corp"," inc"," llc"].forEach((s=>{o.includes(s.toLowerCase())&&n.push(e.replace(new RegExp(s,"gi"),"").trim())})),[" restaurant"," store"].forEach((s=>{o.includes(s.toLowerCase())||n.push(e+s)})),[...new Set(n)].filter((n=>n!==e))}async function retrieveFromMongoDB(e,n=!1){try{console.log("üîç Starting enhanced search with form data:",e);const o=document.getElementById("business-search-results")||document.getElementById("search_table");o&&(o.innerHTML='<div class="loading-indicator" id="main-loading">Searching for businesses...</div>',o.style.display="block");let s=null;if(e.useMyLocation)try{updateLoadingMessage("Getting your location..."),s=await getUserLocation(),window.currentSearchLocation=s}catch(e){return console.error("Error getting user location:",e),hideLoadingIndicator(),void alert("Unable to get your current location. Please try entering an address instead.")}else if(e.address&&""!==e.address.trim())try{updateLoadingMessage("Finding location...");const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw new Error(`Geocoding failed for address: ${e.address}`);if(s=n,window.currentSearchLocation=s,map&&s){const e=new google.maps.LatLng(s.lat,s.lng);map.setCenter(e),map.setZoom(11)}}catch(e){return console.error("Error geocoding address:",e),hideLoadingIndicator(),void alert("We couldn't recognize that address. Please try a more specific address.")}updateLoadingMessage("Searching database...");const t=await searchDatabaseWithFuzzyMatching(e,s,n);console.log(`üìä Database search returned ${t.length} businesses`);let a=[],i=[];t&&t.length>0&&t.forEach((e=>{const n=getBusinessLocation(e);if(!n||!s)return void i.push(e);const o=new google.maps.LatLng(n.lat,n.lng),t=new google.maps.LatLng(s.lat,s.lng);621371e-9*google.maps.geometry.spherical.computeDistanceBetween(o,t)<=50?a.push(e):i.push(e)})),console.log(`üìç Location analysis: ${a.length} nearby, ${i.length} distant`);const r=[...a,...i];if(r.length>0){if(console.log("‚úÖ Found businesses in database, displaying those first"),updateLoadingMessage("Loading results..."),hideLoadingIndicator(),displayBusinessesOnMap(r),displaySearchResults(r),s&&0===a.length&&e.businessName&&(console.log("üåê No nearby database businesses, supplementing with Google Places"),await supplementWithGooglePlaces(e.businessName,s,r)),s){searchNearbyBusinesses(new google.maps.LatLng(s.lat,s.lng),r[0].type||"OTHER")}}else if(e.businessName&&s){console.log("üåê No database businesses found, searching Google Places"),updateLoadingMessage("Searching Google Places...");try{const n=await searchGooglePlacesForBusiness(e.businessName,s);n&&n.length>0?(console.log(`üìç Found ${n.length} businesses via Google Places`),updateLoadingMessage("Loading results..."),hideLoadingIndicator(),displayBusinessesOnMap(n),displaySearchResults(n)):(hideLoadingIndicator(),showNoResultsMessage())}catch(e){console.error("Error searching Google Places:",e),hideLoadingIndicator(),showErrorMessage("Error searching for businesses. Please try again.")}}else hideLoadingIndicator(),showNoResultsMessage()}catch(e){console.error("Enhanced search error:",e),hideLoadingIndicator(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}async function supplementWithGooglePlaces(e,n,o){try{console.log("üîç Supplementing with Google Places for:",e);const s=await searchGooglePlacesForBusiness(e,n);if(s&&s.length>0){console.log(`üìç Found ${s.length} additional businesses via Google Places`);const e=o.map((e=>`${e.address1} ${e.city} ${e.state}`.toLowerCase().replace(/\s+/g," "))),n=s.filter((n=>{const o=`${n.address1} ${n.city} ${n.state}`.toLowerCase().replace(/\s+/g," ");return!e.some((e=>e.includes(o)||o.includes(e)))}));n.length>0&&(console.log(`üìç Adding ${n.length} new Google Places results`),n.forEach((e=>{createBusinessMarker(e)})),displaySearchResults([...o,...n]))}}catch(e){console.error("Error supplementing with Google Places:",e)}}function fetchBusinessIncentives(e,n=null){if(!e)return void console.error("No business ID provided for fetching incentives");console.log(`üéÅ Fetching incentives for business: ${e}, chain: ${n}`);let o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${e}`;n&&(o+=`&chain_id=${n}`),console.log("Fetching incentives from: ",o),fetch(o).then((e=>{if(!e.ok)throw new Error(`Failed to fetch incentives: ${e.status} ${e.statusText}`);return e.json()})).then((n=>{console.log(`Incentives data for business ${e}:`,n);const o=document.getElementById(`incentives-for-${e}`);if(!o)return void console.error(`Could not find cell for incentives-for-${e}`);if(!n.results||0===n.results.length)return console.log(`No incentives found for business ${e}`),void(o.innerHTML="No incentives found");let s="";n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"",t=e.is_chain_wide?'<span class="chain-badge small">Chain-wide</span>':"";s+=`\n                        <div class="incentive-item">\n                            <strong>${n}${o}:</strong> ${e.amount}% ${t}\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),o.innerHTML=""===s?"No active incentives found":s,console.log(`‚úÖ Successfully loaded incentives for business ${e}`)})).catch((n=>{console.error(`Error fetching incentives for business ${e}:`,n);const o=document.getElementById(`incentives-for-${e}`);o&&(o.innerHTML="Error loading incentives")}))}function addBusinessRow(e,n,o){if(!e)return;if(!0===e.is_chain)return void console.log(`Skipping parent chain business in table: ${e.bname}`);let s="";if(e.address1)s=e.address2?`${e.address1}<br>${e.address2}<br>${e.city}, ${e.state} ${e.zip}`:`${e.address1}<br>${e.city}, ${e.state} ${e.zip}`;else{if(!e.formattedAddress)return void console.warn(`Business ${e.bname} has no address information`);s=e.formattedAddress.replace(/,/g,"<br>")}const t=getBusinessTypeLabel(e.type),a=!!e.chain_id,i=!!e.isGooglePlace;let r,l="";a&&(l='<span class="chain-badge">Chain Location</span>'),r=i?a?`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${e.placeId||""}', '${e.chain_id||""}')">Add Chain Location</button>`:`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${e.placeId||""}')">Add to Database</button>`:`<button class="view-map-btn" onclick="focusOnMapMarker('${e._id}')">View on Map</button>`;const c=document.createElement("tr");c.innerHTML=`\n        <th class="left_table" data-business-id="${e._id}">\n            ${e.bname} ${l}\n        </th>\n        <th class="left_table">${s}</th>\n        <th class="left_table">${t}</th>\n        <th class="right_table" id="incentives-for-${e._id}">\n            ${o&&!a?"Not in database yet":"Loading incentives..."}\n        </th>\n        <th class="center_table">${r}</th>\n    `,n.appendChild(c),o&&a?(console.log(`üîó Loading chain incentives for Google Places result: ${e.bname}`),fetchChainIncentivesForPlacesResult(e._id,e.chain_id)):i||(console.log(`üè¢ Loading incentives for database business: ${e.bname} (ID: ${e._id})`),setTimeout((()=>{fetchBusinessIncentives(e._id,e.chain_id)}),100))}function createBusinessMarker(e){try{if(console.log(`üîç MARKER DEBUG: Creating marker for ${e.bname}`),console.log(`   - isGooglePlace: ${e.isGooglePlace}`),console.log(`   - _id: ${e._id}`),console.log("   - Source: "+(e._id?.startsWith("google_")?"GOOGLE PLACES":"DATABASE")),!e.lat||!e.lng||isNaN(parseFloat(e.lat))||isNaN(parseFloat(e.lng)))return console.warn(`‚ùå Invalid coordinates for business: ${e.bname}`),null;const n=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng)),o=!e.isGooglePlace&&!e._id?.startsWith("google_");e.isFromDatabase=o,e.isGooglePlace=!o,console.log(`üè∑Ô∏è FINAL DETERMINATION: ${e.bname} ‚Üí ${o?"DATABASE (RED MARKER)":"GOOGLE PLACES (BLUE MARKER)"}`);const s=createEnhancedBusinessMarkerFixed(e,n,o);return s&&bounds&&bounds.extend(n),s}catch(e){return console.error("‚ùå Error creating business marker:",e),null}}async function createEnhancedBusinessMarkerFixed(e,n,o=!1){try{const{AdvancedMarkerElement:s}=await google.maps.importLibrary("marker");let t=createSafeLatLng(n);if(!t)return console.error("‚ùå Invalid position for enhanced marker:",n),createEnhancedFallbackMarker(e,n);const a=o||!e.isGooglePlace&&!e._id?.startsWith("google_"),i=!!e.chain_id;let r,l;a?(r=CONFIG.markerColors.primary,l="primary database-business",console.log(`üî¥ RED MARKER: ${e.bname} (Database business)`)):(r=CONFIG.markerColors.nearby,l="nearby google-places",console.log(`üîµ BLUE MARKER: ${e.bname} (Google Places)`));const c=getBusinessTypeTextIcon(e.type),d=document.createElement("div");d.className="enhanced-custom-marker",d.setAttribute("title",e.bname),d.style.cursor="pointer",d.innerHTML=`\n            <div class="enhanced-marker-container">\n                <div class="enhanced-marker-pin ${l}" style="background-color: ${r} !important; border: 3px solid #ffffff;">\n                    <div class="enhanced-marker-icon">\n                        ${c}\n                    </div>\n                </div>\n                <div class="enhanced-marker-shadow"></div>\n                ${i?'<div class="chain-indicator">üîó</div>':""}\n                ${a?'<div class="database-indicator">‚úì</div>':""}\n            </div>\n        `;const g=new s({position:t,map,title:e.bname,content:d,collisionBehavior:a?"REQUIRED_AND_HIDES_OPTIONAL":"OPTIONAL_AND_HIDES_LOWER_PRIORITY"});return g.business=e,g.position=t,g.isFromDatabase=a,d.addEventListener("click",(function(n){console.log(`üñ±Ô∏è Marker clicked: ${e.bname} (${a?"Database":"Google Places"})`),n.stopPropagation(),showEnhancedInfoWindow(g)})),d.addEventListener("mouseenter",(function(){d.style.transform="scale(1.1)",d.style.zIndex="1000"})),d.addEventListener("mouseleave",(function(){d.style.transform="scale(1)",d.style.zIndex="auto"})),markers.push(g),console.log(`‚úÖ Added ${a?"DATABASE":"GOOGLE PLACES"} marker for ${e.bname}`),g}catch(o){return console.error("‚ùå Error creating enhanced marker:",o),createEnhancedFallbackMarker(e,n)}}function fetchBusinessIncentivesFixed(e,n=null){e&&!e.startsWith("google_")?(console.log(`üéÅ INCENTIVES DEBUG: Fetching for business ID: ${e}`),console.log(`   - Chain ID: ${n||"None"}`),setTimeout((()=>{const n=document.getElementById(`incentives-for-${e}`);if(!n){console.error(`‚ùå Could not find incentives cell for business ${e}`),console.log(`   - Looking for element ID: incentives-for-${e}`);const n=document.querySelectorAll('[id*="incentives-for"]');return void console.log("üîç Available incentive elements:",Array.from(n).map((e=>e.id)))}console.log(`‚úÖ Found incentives cell for ${e}`),n.innerHTML='<span class="loading-incentives">Loading incentives...</span>';const o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${e}`;console.log(`üåê Fetching incentives from: ${o}`),fetch(o).then((e=>{if(console.log(`üì° Incentives API response status: ${e.status}`),!e.ok)throw new Error(`Failed to fetch incentives: ${e.status} ${e.statusText}`);return e.json()})).then((o=>{if(console.log(`üìä Incentives data for business ${e}:`,o),!o.results||0===o.results.length)return console.log(`‚ÑπÔ∏è No incentives found for business ${e}`),void(n.innerHTML='<em style="color: #666;">No incentives available</em>');let s="",t=0;o.results.forEach((e=>{if(e.is_available){t++;const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"",a=e.is_chain_wide?'<span class="chain-badge small">Chain-wide</span>':"";s+=`\n                            <div class="incentive-item">\n                                <strong>${n}${o}:</strong> ${e.amount}% ${a}\n                                ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                            </div>\n                        `}})),0===t?n.innerHTML='<em style="color: #666;">No active incentives found</em>':(n.innerHTML=s,console.log(`‚úÖ Successfully loaded ${t} incentives for business ${e}`))})).catch((o=>{console.error(`‚ùå Error fetching incentives for business ${e}:`,o),n.innerHTML='<span class="incentives-error">Error loading incentives</span>'}))}),200)):console.log(`‚è≠Ô∏è Skipping incentives for Google Places business: ${e}`)}function addBusinessRowFixed(e,n,o){if(!e)return;if(!0===e.is_chain)return void console.log(`‚è≠Ô∏è Skipping parent chain business in table: ${e.bname}`);console.log(`üìù Adding table row for: ${e.bname}`),console.log(`   - Is from Places: ${o}`),console.log(`   - Business ID: ${e._id}`),console.log(`   - Is chain location: ${!!e.chain_id}`);let s="";if(e.address1)s=e.address2?`${e.address1}<br>${e.address2}<br>${e.city}, ${e.state} ${e.zip}`:`${e.address1}<br>${e.city}, ${e.state} ${e.zip}`;else{if(!e.formattedAddress)return void console.warn(`‚ùå Business ${e.bname} has no address information`);s=e.formattedAddress.replace(/,/g,"<br>")}const t=getBusinessTypeLabel(e.type),a=!!e.chain_id,i=!!e.isGooglePlace;let r,l="";a&&(l='<span class="chain-badge">Chain Location</span>'),r=i?a?`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${e.placeId||""}', '${e.chain_id||""}')">Add Chain Location</button>`:`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${e.placeId||""}')">Add to Database</button>`:`<button class="view-map-btn" onclick="focusOnMapMarker('${e._id}')">View on Map</button>`;const c=document.createElement("tr");c.innerHTML=`\n        <th class="left_table" data-business-id="${e._id}">\n            ${e.bname} ${l}\n        </th>\n        <th class="left_table">${s}</th>\n        <th class="left_table">${t}</th>\n        <th class="right_table" id="incentives-for-${e._id}">\n            ${o&&!a?"Not in database yet":'<span class="loading-incentives">Loading incentives...</span>'}\n        </th>\n        <th class="center_table">${r}</th>\n    `,n.appendChild(c),i?a?(console.log(`üîó Scheduling chain incentives load for Google Places: ${e.bname}`),fetchChainIncentivesForPlacesResult(e._id,e.chain_id)):console.log(`‚ÑπÔ∏è No incentives to load for non-chain Google Places: ${e.bname}`):(console.log(`üéÅ Scheduling incentives load for database business: ${e.bname} (ID: ${e._id})`),fetchBusinessIncentivesFixed(e._id,e.chain_id))}async function retrieveFromMongoDBFixed(e,n=!1){try{console.log("üîç SEARCH DEBUG: Starting enhanced search with form data:",e);const o=document.getElementById("business-search-results")||document.getElementById("search_table");o&&(o.innerHTML='<div class="loading-indicator" id="main-loading">Searching for businesses...</div>',o.style.display="block");let s=null;if(e.useMyLocation)try{updateLoadingMessage("Getting your location..."),s=await getUserLocation(),window.currentSearchLocation=s,console.log(`üìç Got user location: ${s.lat}, ${s.lng}`)}catch(e){return console.error("‚ùå Error getting user location:",e),hideLoadingIndicator(),void alert("Unable to get your current location. Please try entering an address instead.")}else if(e.address&&""!==e.address.trim())try{updateLoadingMessage("Finding location...");const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw new Error(`Geocoding failed for address: ${e.address}`);if(s=n,window.currentSearchLocation=s,console.log(`üìç Geocoded location: ${s.lat}, ${s.lng}`),map&&s){const e=new google.maps.LatLng(s.lat,s.lng);map.setCenter(e),map.setZoom(11)}}catch(e){return console.error("‚ùå Error geocoding address:",e),hideLoadingIndicator(),void alert("We couldn't recognize that address. Please try a more specific address.")}updateLoadingMessage("Searching database...");const t=await searchDatabaseWithFuzzyMatching(e,s,n);console.log(`üìä DATABASE RESULTS: Found ${t.length} businesses`),t.forEach(((e,n)=>{console.log(`   ${n+1}. ${e.bname} (ID: ${e._id}, Chain: ${e.is_chain?"Yes":"No"})`)}));const a=t.filter((e=>!0!==e.is_chain||(console.log(`üö´ Filtering out parent chain: ${e.bname}`),!1)));if(console.log(`‚úÖ VALID BUSINESSES: ${a.length} after filtering`),a.length>0)console.log("‚úÖ Found businesses in database, displaying those"),a.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,console.log(`üè∑Ô∏è Tagged as database business: ${e.bname}`)})),hideLoadingIndicator(),displayBusinessesOnMapFixed(a),displaySearchResultsFixed(a),console.log("‚úÖ Database businesses displayed successfully");else if(e.businessName&&s){console.log("üåê No database businesses found, searching Google Places"),updateLoadingMessage("Searching Google Places...");try{const n=await searchGooglePlacesForBusiness(e.businessName,s);n&&n.length>0?(console.log(`üìç Found ${n.length} businesses via Google Places`),updateLoadingMessage("Loading results..."),hideLoadingIndicator(),displayBusinessesOnMapFixed(n),displaySearchResultsFixed(n)):(hideLoadingIndicator(),showNoResultsMessage())}catch(e){console.error("‚ùå Error searching Google Places:",e),hideLoadingIndicator(),showErrorMessage("Error searching for businesses. Please try again.")}}else hideLoadingIndicator(),showNoResultsMessage()}catch(e){console.error("‚ùå Enhanced search error:",e),hideLoadingIndicator(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}function displayBusinessesOnMapFixed(e){if(!map)return console.log("‚è≥ Map not ready, storing businesses for later display"),void(pendingBusinessesToDisplay=e);console.log(`üó∫Ô∏è DISPLAY DEBUG: Displaying ${e.length} businesses on map`),clearMarkers(),bounds=new google.maps.LatLngBounds;let n=0,o=0;e.forEach(((e,s)=>{try{if(console.log(`üîÑ Processing business ${s+1}: ${e.bname}`),!0===e.is_chain)return console.log(`üö´ Skipping parent chain business: ${e.bname}`),void o++;const t=getBusinessLocation(e);if(!t)return console.warn(`‚ùå Business ${e.bname} missing coordinates`),void o++;if(e.lat=t.lat,e.lng=t.lng,createBusinessMarker(e)){n++,console.log(`‚úÖ Created marker ${n} for ${e.bname}`);const o=new google.maps.LatLng(t.lat,t.lng);bounds.extend(o)}else console.error(`‚ùå Failed to create marker for ${e.bname}`),o++}catch(n){console.error(`‚ùå Error processing business ${e.bname}:`,n),o++}})),console.log(`üìä MARKER SUMMARY: Created ${n} markers, skipped ${o} businesses`),setTimeout((()=>{try{if(window.currentSearchLocation&&n>0){console.log("üìç Centering map on search location");const e=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng);map.setCenter(e),map.setZoom(12)}else n>0&&bounds&&!bounds.isEmpty()?(console.log("üéØ Fitting map to business bounds"),safelyFitBounds(map,bounds)):(console.log("üåé Using default map center"),map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom))}catch(e){console.error("‚ùå Error updating map view:",e)}}),200)}function displaySearchResultsFixed(e){try{console.log(`üìã RESULTS DEBUG: Displaying ${e.length} businesses in table`),hideLoadingIndicator();const n=document.getElementById("business_search"),o=document.getElementById("search_table");if(!n||!o)return console.error("‚ùå Required table elements not found in the DOM"),void showErrorMessage("There was an error displaying search results. Please try again later.");let s=n.querySelector("tbody");if(!s)return console.error("‚ùå Table body not found"),void showErrorMessage("There was an error displaying search results. Please try again later.");s.innerHTML="",o.style.display="block";const t=o.querySelector("h5");if(t&&(t.style.display="none"),0===e.length)return s.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria.</td></tr>',void o.scrollIntoView({behavior:"smooth"});const a=e.filter((e=>!e.isGooglePlace)),i=e.filter((e=>e.isGooglePlace));console.log(`üìä CATEGORY DEBUG: ${a.length} database, ${i.length} Google Places`),a.forEach(((e,n)=>{console.log(`üìù Adding database business ${n+1}: ${e.bname}`),addBusinessRowFixed(e,s,!1)})),i.forEach(((e,n)=>{console.log(`üìù Adding Google Places business ${n+1}: ${e.bname}`),addBusinessRowFixed(e,s,!0)})),o.scrollIntoView({behavior:"smooth"}),console.log("‚úÖ Search results displayed successfully")}catch(e){console.error("‚ùå Error displaying search results:",e),hideLoadingIndicator(),showErrorMessage("There was an error displaying the search results: "+e.message)}}function updateLoadingMessage(e){const n=document.getElementById("main-loading");n&&(n.innerHTML=`<div class="loading-text">${e}</div><div class="loading-spinner"></div>`)}function hideLoadingIndicator(){const e=document.getElementById("main-loading");e&&e.remove(),document.querySelectorAll(".loading-indicator").forEach((e=>{("main-loading"===e.id||e.textContent.includes("Searching"))&&e.remove()}))}function showNoResultsMessage(){hideLoadingIndicator();const e=document.getElementById("business-search-results")||document.getElementById("search_table");e&&(e.innerHTML='<div class="error-message">No businesses found matching your search criteria in this area.</div>',e.style.display="block")}function showErrorMessage(e){hideLoadingIndicator();const n=document.getElementById("business-search-results")||document.getElementById("search_table");n&&(n.innerHTML=`<div class="error-message">${e}</div>`,n.style.display="block")}async function searchDatabaseWithFuzzyMatching(e,n,o){const s={};e.businessName&&""!==e.businessName.trim()&&(s.business_name=e.businessName),e.address&&""!==e.address.trim()&&!n&&(s.address=e.address),n&&n.lat&&n.lng&&(s.lat=n.lat,s.lng=n.lng,s.radius=25),o&&(s.ts=(new Date).getTime());const t=new URLSearchParams(s).toString(),a=`${getBaseURL()}/api/business.js?operation=search&${t}`,i=await fetch(a,{method:"GET",headers:{"Content-Type":"application/json; charset=UTF-8","Cache-Control":o?"no-cache, no-store, must-revalidate":"default"}});if(!i.ok)throw new Error(`Database search failed: ${i.status}`);const r=(await i.json()).results||[],l=r.filter((e=>!0===e.is_chain?(console.log(`Filtering out parent chain business: ${e.bname}`),!1):!(n&&!hasValidCoordinates(e))||(console.log(`Filtering out business without valid coordinates: ${e.bname}`),!1)));return console.log(`üìä Filtered ${r.length} raw results to ${l.length} location businesses`),l}function hasValidCoordinates(e){if(void 0!==e.lat&&void 0!==e.lng){const n=parseFloat(e.lat),o=parseFloat(e.lng);return!isNaN(n)&&!isNaN(o)&&0!==n&&0!==o}if(e.location&&e.location.coordinates&&Array.isArray(e.location.coordinates)&&e.location.coordinates.length>=2){const n=parseFloat(e.location.coordinates[0]),o=parseFloat(e.location.coordinates[1]);return!isNaN(o)&&!isNaN(n)&&0!==o&&0!==n}return!1}async function testAPIEndpoints(){const e=getBaseURL();try{console.log("   Testing business search API...");const n=await fetch(`${e}/api/business.js?operation=search&business_name=Home Depot&limit=1`);if(n.ok){const o=await n.json();if(console.log(`   ‚úÖ Business search API working: Found ${o.results?.length||0} results`),o.results&&o.results.length>0){const n=o.results[0];console.log(`      - Sample business: ${n.bname} (ID: ${n._id})`),console.log(`      - Is chain: ${n.is_chain}`),console.log(`      - Chain ID: ${n.chain_id||"None"}`),console.log("   Testing incentives API...");const s=await fetch(`${e}/api/combined-api.js?operation=incentives&business_id=${n._id}`);if(s.ok){const e=await s.json();console.log(`   ‚úÖ Incentives API working: Found ${e.results?.length||0} incentives`)}else console.log(`   ‚ùå Incentives API failed: ${s.status}`)}}else console.log(`   ‚ùå Business search API failed: ${n.status}`)}catch(e){console.log(`   ‚ùå API test failed: ${e.message}`)}}async function searchGooglePlacesForBusinessFixed(e,n){try{console.log("üîç PLACES SEARCH: Searching Google Places for:",e,"near",n);const{Place:o}=await google.maps.importLibrary("places"),s=new google.maps.LatLng(n.lat,n.lng),t={textQuery:e,locationBias:{center:s,radius:25e3},maxResultCount:20,fields:["id","displayName","formattedAddress","location","types","nationalPhoneNumber","internationalPhoneNumber"]};console.log("üåê Places API request:",t);const{places:a}=await o.searchByText(t);if(!a||0===a.length)return console.log("‚ùå No businesses found via Places API"),[];console.log(`‚úÖ Found ${a.length} businesses via Places API`);const i=a.map((async e=>{const o=e.formattedAddress?e.formattedAddress.split(","):[];let t="",a="",i="",r="";if(o.length>=1&&(t=o[0].trim()),o.length>=2&&(a=o[1].trim()),o.length>=3){const e=o[2].trim().match(/^([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/);e&&(i=e[1],r=e[2])}const l=e.location,c=google.maps.geometry.spherical.computeDistanceBetween(s,l);let d=0,g=0;if(e.location)try{d="function"==typeof e.location.lat?e.location.lat():e.location.lat||0,g="function"==typeof e.location.lng?e.location.lng():e.location.lng||0}catch(e){console.warn("‚ö†Ô∏è Error extracting coordinates:",e),d=n.lat,g=n.lng}const u={_id:"google_"+e.id,bname:e.displayName,address1:t,city:a,state:i,zip:r,formattedAddress:e.formattedAddress,type:mapGooglePlaceTypeToBusinessType(e.types),phone:e.nationalPhoneNumber||e.internationalPhoneNumber||"",isGooglePlace:!0,placeId:e.id,lat:d,lng:g,distance:c};try{const n=await findMatchingChainForPlaceResult(e.displayName);n?(console.log(`üîó CHAIN MATCH: "${e.displayName}" matches "${n.bname}"`),u.chain_id=n._id,u.chain_name=n.bname,u.isChainLocation=!0):console.log(`‚ùå No chain match for: ${e.displayName}`)}catch(e){console.warn("‚ö†Ô∏è Error checking for chain match:",e)}return u})),r=await Promise.all(i);return r.sort(((e,n)=>e.distance-n.distance)),console.log(`üìä FINAL PLACES RESULTS: ${r.length} businesses processed`),r.forEach(((e,n)=>{console.log(`   ${n+1}. ${e.bname} (Chain: ${e.isChainLocation?e.chain_name:"No"})`)})),r}catch(e){return console.error("‚ùå Error in Places API search:",e),[]}}function loadChainIncentivesForDatabaseBusiness(e,n){if(!e||!n)return void console.log("‚è≠Ô∏è Missing business or chain ID for incentives loading");console.log(`üîó CHAIN INCENTIVES: Loading for database business ${e}, chain ${n}`);const o=document.getElementById(`incentives-container-${e}`);if(!o)return void console.error(`‚ùå Container not found: incentives-container-${e}`);const s=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${n}`;console.log(`üåê Fetching chain incentives from: ${s}`),fetch(s).then((e=>{if(!e.ok)throw new Error(`Chain incentives API failed: ${e.status}`);return e.json()})).then((n=>{if(console.log("üìä Chain incentives data:",n),!n.results||0===n.results.length)return void(o.innerHTML="<em>üí≠ No chain incentives available</em>");let s='<div class="incentives-header"><strong>üéÅ Available Incentives:</strong></div>';s+='<div class="incentives-list">',n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"";s+=`\n                        <div class="incentive-item chain-incentive">\n                            <div class="incentive-type">${n}${o}:</div>\n                            <div class="incentive-amount">${e.amount}% <span class="mini-chain-badge">üîó Chain-wide</span></div>\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),s+="</div>",o.innerHTML=s,console.log(`‚úÖ Successfully loaded chain incentives for ${e}`)})).catch((e=>{console.error("‚ùå Error loading chain incentives:",e),o.innerHTML="<em>‚ùå Error loading chain incentives</em>"}))}function buildEnhancedInfoWindowContentFixed(e){const n=!0===e.isGooglePlace,o=!!e.chain_id,s=!n;let t="";if(e.address1){t=`<div class="info-address">\n            <strong>üìç Address:</strong><br>\n            ${e.address1}`,e.address2&&(t+=`<br>${e.address2}`);const n=[];e.city&&n.push(e.city),e.state&&n.push(e.state),e.zip&&n.push(e.zip),n.length>0&&(t+=`<br>${n.join(", ")}`),t+="</div>"}else if(e.formattedAddress){const n=e.formattedAddress.split(",").map((e=>e.trim()));t='<div class="info-address">\n            <strong>üìç Address:</strong><br>',n.length>=1&&(t+=n[0]),n.length>=2&&(t+=`<br>${n.slice(1).join(", ")}`),t+="</div>"}const a=e.phone?`<div class="info-phone"><strong>üìû Phone:</strong> <a href="tel:${e.phone.replace(/\D/g,"")}" style="color: #4285F4; text-decoration: none;">${e.phone}</a></div>`:"";let i="";e.type&&"OTHER"!==e.type&&(i=`<div class="info-type"><strong>üè¢ Type:</strong> ${getBusinessTypeLabel(e.type)}</div>`);const r=e.distance?`<div class="info-distance"><strong>üìè Distance:</strong> ${(e.distance/1609).toFixed(1)} miles</div>`:"",l=o?`<span class="enhanced-chain-badge">üîó ${e.chain_name||"Chain Location"}</span>`:"";let c,d="",g="";n?o?(d='<div class="info-status chain-match">üîó This location appears to match a chain in our database!</div>',g=`<div class="chain-explanation">\n                ‚ú® Great news! This location matches <strong>${e.chain_name}</strong> in our database. \n                Chain-wide incentives should apply to this location once added.\n            </div>`):d='<div class="info-status google-place">‚ÑπÔ∏è This business is not yet in the Patriot Thanks database.</div>':d='<div class="info-status database-business">‚úÖ This business is in the Patriot Thanks database.</div>',c=n?o?`\n                <button class="enhanced-add-btn chain-add" onclick="window.addBusinessToDatabase('${e.placeId}', '${e.chain_id}')">\n                    üîó Add ${e.chain_name} Location\n                </button>\n            `:`\n                <button class="enhanced-add-btn" onclick="window.addBusinessToDatabase('${e.placeId}')">\n                    ‚ûï Add to Patriot Thanks\n                </button>\n            `:`\n            <button class="enhanced-view-btn" onclick="window.viewBusinessDetails('${e._id}')">\n                üëÅÔ∏è View Details\n            </button>\n        `;const u=e._id||e.placeId;let h;return h=s&&o?"<em>‚è≥ Loading chain incentives...</em>":s?"<em>‚è≥ Loading incentives...</em>":n&&o?"<em>‚è≥ Loading chain incentives...</em>":"<em>üí° Add this business to see available incentives.</em>",`\n        <div class="enhanced-info-window">\n            <div class="info-header">\n                <h3>${e.bname} ${l}</h3>\n            </div>\n            \n            <div class="info-body">\n                ${t}\n                ${a}\n                ${i}\n                ${r}\n                ${d}\n                ${g}\n                \n                <div class="info-incentives">\n                    <div id="incentives-container-${u}">\n                        ${h}\n                    </div>\n                </div>\n            </div>\n            \n            <div class="info-actions">\n                ${c}\n            </div>\n        </div>\n    `}async function retrieveFromMongoDBEnhanced(e,n=!1){try{console.log("üîç ENHANCED SEARCH: Starting search with form data:",e);const o=document.getElementById("business-search-results")||document.getElementById("search_table");o&&(o.innerHTML='<div class="loading-indicator" id="main-loading">Searching for businesses...</div>',o.style.display="block");let s=null;if(e.useMyLocation)try{updateLoadingMessage("Getting your location..."),s=await getUserLocation(),window.currentSearchLocation=s}catch(e){return console.error("‚ùå Error getting user location:",e),hideLoadingIndicator(),void alert("Unable to get your current location. Please try entering an address instead.")}else if(e.address&&""!==e.address.trim())try{updateLoadingMessage("Finding location...");const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw new Error(`Geocoding failed for address: ${e.address}`);if(s=n,window.currentSearchLocation=s,map&&s){const e=new google.maps.LatLng(s.lat,s.lng);map.setCenter(e),map.setZoom(11)}}catch(e){return console.error("‚ùå Error geocoding address:",e),hideLoadingIndicator(),void alert("We couldn't recognize that address. Please try a more specific address.")}updateLoadingMessage("Searching database...");const t=(await searchDatabaseWithFuzzyMatching(e,s,n)).filter((e=>!0!==e.is_chain));console.log(`üìä DATABASE: Found ${t.length} valid businesses`);let a=[];e.businessName&&s&&(updateLoadingMessage("Searching Google Places..."),a=await searchGooglePlacesForBusinessFixed(e.businessName,s),console.log(`üìä PLACES: Found ${a.length} businesses`));const i=[...t,...a];console.log(`üìä TOTAL: Combined ${i.length} businesses (${t.length} database + ${a.length} places)`),i.length>0?(t.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0})),a.forEach((e=>{e.isGooglePlace=!0,e.isFromDatabase=!1})),hideLoadingIndicator(),displayBusinessesOnMapFixed(i),displaySearchResultsFixed(i),console.log("‚úÖ Search completed successfully")):(hideLoadingIndicator(),showNoResultsMessage())}catch(e){console.error("‚ùå Enhanced search error:",e),hideLoadingIndicator(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}function showEnhancedInfoWindowFixed(e){if(console.log("ü™ü INFO WINDOW: Showing enhanced info window for:",e.business?.bname),!e||!e.business)return void console.error("‚ùå Invalid marker for info window");const n=e.business,o=!0===n.isGooglePlace,s=!!n.chain_id,t=!o;infoWindow&&infoWindow.close(),infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1});const a=buildEnhancedInfoWindowContentFixed(n);infoWindow.setContent(a);let i=e.position;if(!i&&e.getPosition&&(i=e.getPosition()),i||(i=createSafeLatLng(n)),i){try{map.panTo(i)}catch(e){console.warn("‚ö†Ô∏è Error panning to position:",e)}setTimeout((()=>{try{e.getPosition?infoWindow.open(map,e):(infoWindow.setPosition(i),infoWindow.open(map)),console.log("‚úÖ Info window opened successfully"),google.maps.event.addListenerOnce(infoWindow,"domready",(function(){setTimeout((()=>{applyEnhancedInfoWindowFixes();const e=n._id||n.placeId;t&&s?(console.log(`üîó Loading chain incentives for database business: ${n.bname}`),loadChainIncentivesForDatabaseBusiness(e,n.chain_id)):t?(console.log(`üè¢ Loading regular incentives for database business: ${n.bname}`),loadIncentivesForEnhancedWindow(e)):o&&s&&(console.log(`üåê Loading chain incentives for Google Places: ${n.bname}`),loadChainIncentivesForEnhancedWindow(n.placeId,n.chain_id))}),300)}))}catch(e){console.error("‚ùå Error opening info window:",e)}}),200)}else console.error("‚ùå Could not determine position for info window")}function buildEnhancedInfoWindowContentFixed2(e){const n=!0===e.isGooglePlace,o=!!e.chain_id,s=!n;let t="";if(e.address1){t=`<div class="info-address">\n            <strong>üìç Address:</strong><br>\n            ${e.address1}`,e.address2&&(t+=`<br>${e.address2}`);const n=[];e.city&&n.push(e.city),e.state&&n.push(e.state),e.zip&&n.push(e.zip),n.length>0&&(t+=`<br>${n.join(", ")}`),t+="</div>"}else if(e.formattedAddress){const n=e.formattedAddress.split(",").map((e=>e.trim()));t='<div class="info-address">\n            <strong>üìç Address:</strong><br>',n.length>=1&&(t+=n[0]),n.length>=2&&(t+=`<br>${n.slice(1).join(", ")}`),t+="</div>"}const a=e.phone?`<div class="info-phone"><strong>üìû Phone:</strong> <a href="tel:${e.phone.replace(/\D/g,"")}" style="color: #4285F4; text-decoration: none;">${e.phone}</a></div>`:"";let i="";e.type&&"OTHER"!==e.type&&(i=`<div class="info-type"><strong>üè¢ Type:</strong> ${getBusinessTypeLabel(e.type)}</div>`);const r=e.distance?`<div class="info-distance"><strong>üìè Distance:</strong> ${(e.distance/1609).toFixed(1)} miles</div>`:"",l=o?`<span class="enhanced-chain-badge">üîó ${e.chain_name||"Chain Location"}</span>`:"";let c,d="",g="";n?o?(d='<div class="info-status chain-match">üîó This location appears to match a chain in our database!</div>',g=`<div class="chain-explanation">\n                ‚ú® Great news! This location matches <strong>${e.chain_name}</strong> in our database. \n                Chain-wide incentives should apply to this location once added.\n            </div>`):d='<div class="info-status google-place">‚ÑπÔ∏è This business is not yet in the Patriot Thanks database.</div>':d='<div class="info-status database-business">‚úÖ This business is in the Patriot Thanks database.</div>',c=n?o?`\n                <button class="enhanced-add-btn chain-add" onclick="window.addBusinessToDatabase('${e.placeId}', '${e.chain_id}')">\n                    üîó Add ${e.chain_name} Location\n                </button>\n            `:`\n                <button class="enhanced-add-btn" onclick="window.addBusinessToDatabase('${e.placeId}')">\n                    ‚ûï Add to Patriot Thanks\n                </button>\n            `:`\n            <button class="enhanced-view-btn" onclick="window.viewBusinessDetails('${e._id}')">\n                üëÅÔ∏è View Details\n            </button>\n        `;const u=n?`google_${e.placeId}`:e._id;let h;return console.log(`üÜî INFO WINDOW: Using container ID: ${u} for business: ${e.bname}`),h=s&&o?"<em>‚è≥ Loading chain incentives...</em>":s?"<em>‚è≥ Loading incentives...</em>":n&&o?"<em>‚è≥ Loading chain incentives...</em>":"<em>üí° Add this business to see available incentives.</em>",`\n        <div class="enhanced-info-window">\n            <div class="info-header">\n                <h3>${e.bname} ${l}</h3>\n            </div>\n            \n            <div class="info-body">\n                ${t}\n                ${a}\n                ${i}\n                ${r}\n                ${d}\n                ${g}\n                \n                <div class="info-incentives">\n                    <div id="incentives-container-${u}">\n                        ${h}\n                    </div>\n                </div>\n            </div>\n            \n            <div class="info-actions">\n                ${c}\n            </div>\n        </div>\n    `}function showEnhancedInfoWindowFixed2(e){if(console.log("ü™ü INFO WINDOW: Showing enhanced info window for:",e.business?.bname),!e||!e.business)return void console.error("‚ùå Invalid marker for info window");const n=e.business,o=!0===n.isGooglePlace,s=!!n.chain_id,t=!o;infoWindow&&infoWindow.close(),infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1});const a=buildEnhancedInfoWindowContentFixed2(n);infoWindow.setContent(a);let i=e.position;if(!i&&e.getPosition&&(i=e.getPosition()),i||(i=createSafeLatLng(n)),i){try{map.panTo(i)}catch(e){console.warn("‚ö†Ô∏è Error panning to position:",e)}setTimeout((()=>{try{e.getPosition?infoWindow.open(map,e):(infoWindow.setPosition(i),infoWindow.open(map)),console.log("‚úÖ Info window opened successfully"),google.maps.event.addListenerOnce(infoWindow,"domready",(function(){setTimeout((()=>{applyEnhancedInfoWindowFixes();const e=o?`google_${n.placeId}`:n._id;console.log(`üéÅ INCENTIVES: Loading for container ID: ${e}`),t&&s?(console.log(`üîó Loading chain incentives for database business: ${n.bname}`),loadChainIncentivesForDatabaseBusinessFixed(e,n.chain_id)):t?(console.log(`üè¢ Loading regular incentives for database business: ${n.bname}`),loadIncentivesForEnhancedWindowFixed(e)):o&&s&&(console.log(`üåê Loading chain incentives for Google Places: ${n.bname}`),loadChainIncentivesForEnhancedWindowFixed(e,n.chain_id))}),300)}))}catch(e){console.error("‚ùå Error opening info window:",e)}}),200)}else console.error("‚ùå Could not determine position for info window")}function loadChainIncentivesForEnhancedWindowFixed(e,n){console.log(`üîó CHAIN INCENTIVES: Loading for container ${e}, chain ${n}`);const o=document.getElementById(`incentives-container-${e}`);if(!o){console.error(`‚ùå Container not found: incentives-container-${e}`);const n=document.querySelectorAll('[id*="incentives-container"]');return void console.log("üîç Available containers:",Array.from(n).map((e=>e.id)))}console.log(`‚úÖ Found container: incentives-container-${e}`);const s=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${n}`;console.log(`üåê Fetching chain incentives from: ${s}`),fetch(s).then((e=>{if(!e.ok)throw new Error(`Chain incentives API failed: ${e.status}`);return e.json()})).then((n=>{if(console.log("üìä Chain incentives data:",n),!n.results||0===n.results.length)return void(o.innerHTML="<em>üí≠ No chain incentives available</em>");let s='<div class="incentives-header"><strong>üéÅ Chain-wide Incentives:</strong></div>';s+='<div class="incentives-list">',n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"";s+=`\n                        <div class="incentive-item chain-incentive">\n                            <div class="incentive-type">${n}${o}:</div>\n                            <div class="incentive-amount">${e.amount}% <span class="mini-chain-badge">üîó Chain-wide</span></div>\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),s+="</div>",s+='<div class="chain-note">‚ú® Great! These incentives apply to all locations of this chain.</div>',o.innerHTML=s,console.log(`‚úÖ Successfully loaded chain incentives for ${e}`)})).catch((e=>{console.error("‚ùå Error loading chain incentives:",e),o.innerHTML="<em>‚ùå Error loading chain incentives</em>"}))}function loadIncentivesForEnhancedWindowFixed(e){console.log(`üè¢ REGULAR INCENTIVES: Loading for container ${e}`);const n=document.getElementById(`incentives-container-${e}`);if(!n)return void console.error(`‚ùå Container not found: incentives-container-${e}`);const o=getBaseURL();fetch(`${o}/api/combined-api.js?operation=incentives&business_id=${e}`).then((e=>e.json())).then((o=>{if(!o.results||0===o.results.length)return void(n.innerHTML="<em>üí≠ No incentives available</em>");let s='<div class="incentives-header"><strong>üéÅ Available Incentives:</strong></div>';s+='<div class="incentives-list">',o.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"",t=e.is_chain_wide?'<span class="mini-chain-badge">üîó Chain-wide</span>':"";s+=`\n                        <div class="incentive-item">\n                            <div class="incentive-type">${n}${o}:</div>\n                            <div class="incentive-amount">${e.amount}% ${t}</div>\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),s+="</div>",n.innerHTML=s,console.log(`‚úÖ Successfully loaded regular incentives for ${e}`)})).catch((e=>{console.error("‚ùå Error loading incentives:",e),n.innerHTML="<em>‚ùå Error loading incentives</em>"}))}function loadChainIncentivesForDatabaseBusinessFixed(e,n){console.log(`üîó DATABASE CHAIN INCENTIVES: Loading for container ${e}, chain ${n}`);const o=document.getElementById(`incentives-container-${e}`);if(!o)return void console.error(`‚ùå Container not found: incentives-container-${e}`);const s=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${n}`;console.log(`üåê Fetching database chain incentives from: ${s}`),fetch(s).then((e=>{if(!e.ok)throw new Error(`Chain incentives API failed: ${e.status}`);return e.json()})).then((n=>{if(console.log("üìä Database chain incentives data:",n),!n.results||0===n.results.length)return void(o.innerHTML="<em>üí≠ No chain incentives available</em>");let s='<div class="incentives-header"><strong>üéÅ Available Incentives:</strong></div>';s+='<div class="incentives-list">',n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"";s+=`\n                        <div class="incentive-item chain-incentive">\n                            <div class="incentive-type">${n}${o}:</div>\n                            <div class="incentive-amount">${e.amount}% <span class="mini-chain-badge">üîó Chain-wide</span></div>\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),s+="</div>",o.innerHTML=s,console.log(`‚úÖ Successfully loaded database chain incentives for ${e}`)})).catch((e=>{console.error("‚ùå Error loading database chain incentives:",e),o.innerHTML="<em>‚ùå Error loading chain incentives</em>"}))}window.debugBusinessSearch=function(){console.log("üîç ===== COMPREHENSIVE BUSINESS SEARCH DEBUG ====="),console.log("\nüìä CURRENT STATE:"),console.log("   - Map initialized:",!!map),console.log("   - Current search location:",window.currentSearchLocation),console.log("   - Total markers:",markers?markers.length:0),markers&&markers.length>0&&(console.log("\nüéØ MARKER ANALYSIS:"),markers.forEach(((e,n)=>{const o=e.business;if(o){const e=o.isGooglePlace||o._id?.startsWith("google_")?"BLUE":"RED";console.log(`   ${n+1}. ${o.bname}`),console.log(`      - ID: ${o._id}`),console.log(`      - isGooglePlace: ${o.isGooglePlace}`),console.log(`      - isFromDatabase: ${o.isFromDatabase}`),console.log(`      - Expected marker color: ${e}`),console.log(`      - Chain ID: ${o.chain_id||"None"}`),console.log(`      - Coordinates: ${o.lat}, ${o.lng}`)}}))),console.log("\nüìã TABLE ANALYSIS:");const e=document.querySelector("#business_search tbody");if(e){const n=e.querySelectorAll("tr");console.log(`   - Table rows found: ${n.length}`),n.forEach(((e,n)=>{const o=e.querySelector(".left_table").textContent.trim(),s=e.querySelector(".right_table"),t=e.querySelector(".left_table").getAttribute("data-business-id");console.log(`   ${n+1}. ${o}`),console.log(`      - Business ID: ${t}`),console.log(`      - Incentives cell ID: ${s?.id}`),console.log(`      - Incentives content: ${s?.textContent.substring(0,50)}...`)}))}else console.log("   - No table body found");console.log("\nüîç DOM ANALYSIS:");const n=document.querySelectorAll('[id*="incentives-for"]');console.log(`   - Total incentive elements: ${n.length}`),n.forEach(((e,n)=>{console.log(`      ${n+1}. ID: ${e.id}, Content: ${e.textContent.substring(0,30)}...`)})),console.log("\nüåê API TEST:"),testAPIEndpoints(),console.log("\n‚úÖ Debug complete. Check the detailed output above.")},window.testSpecificSearch=function(e,n=!1){console.log(`üß™ TESTING SEARCH: "${e}" (Location: ${n?"Yes":"No"})`),clearMarkers();const o={businessName:e,address:"",useMyLocation:n};console.log("üìù Form data:",o),retrieveFromMongoDBFixed(o).then((()=>{console.log("‚úÖ Search completed"),setTimeout(debugBusinessSearch,1e3)})).catch((e=>{console.error("‚ùå Search failed:",e)}))},window.testIncentivesLoading=function(e){if(console.log(`üéÅ TESTING INCENTIVES LOADING: ${e}`),!document.getElementById(`incentives-for-${e}`))return console.error(`‚ùå Element not found: incentives-for-${e}`),console.log("Available incentive elements:"),void document.querySelectorAll('[id*="incentives-for"]').forEach((e=>{console.log(`   - ${e.id}`)}));console.log("‚úÖ Found incentives element"),fetchBusinessIncentivesFixed(e)},window.monitorAPICalls=function(){console.log("üì° MONITORING API CALLS...");const e=window.fetch;window.fetch=function(...n){const o=n[0];return o.includes("/api/")&&console.log(`üåê API CALL: ${o}`),e.apply(this,n).then((e=>(o.includes("/api/")&&console.log(`üì° API RESPONSE: ${o} - Status: ${e.status}`),e))).catch((e=>{throw o.includes("/api/")&&console.error(`‚ùå API ERROR: ${o} - ${e.message}`),e}))},console.log("‚úÖ API monitoring enabled")},window.quickFixTest=function(){console.log("üîß RUNNING QUICK FIX TEST..."),console.log("1. Testing Home Depot search..."),testSpecificSearch("The Home Depot",!1),setTimeout((()=>{console.log("2. Testing location-based search..."),testSpecificSearch("The Home Depot",!0)}),3e3),monitorAPICalls()},window.addDebugOverlay=function(){const e=document.getElementById("debug-overlay");e&&e.remove();const n=document.createElement("div");n.id="debug-overlay",n.style.cssText="\n        position: fixed;\n        top: 10px;\n        right: 10px;\n        background: rgba(0,0,0,0.8);\n        color: white;\n        padding: 15px;\n        border-radius: 8px;\n        z-index: 10000;\n        font-family: monospace;\n        font-size: 12px;\n        max-width: 300px;\n        max-height: 400px;\n        overflow-y: auto;\n    ",n.innerHTML='\n        <h4 style="margin: 0 0 10px 0; color: #4CAF50;">üîß Debug Tools</h4>\n        <button onclick="debugBusinessSearch()" style="margin: 2px; padding: 5px 10px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">Full Debug</button><br>\n        <button onclick="quickFixTest()" style="margin: 2px; padding: 5px 10px; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer;">Quick Fix Test</button><br>\n        <button onclick="monitorAPICalls()" style="margin: 2px; padding: 5px 10px; background: #9C27B0; color: white; border: none; border-radius: 4px; cursor: pointer;">Monitor APIs</button><br>\n        <button onclick="clearMarkers(); console.clear();" style="margin: 2px; padding: 5px 10px; background: #F44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Clear All</button><br>\n        <button onclick="document.getElementById(\'debug-overlay\').remove();" style="margin: 2px; padding: 5px 10px; background: #607D8B; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>\n        <hr style="margin: 10px 0; border: 1px solid #666;">\n        <div id="debug-status">Ready</div>\n    ',document.body.appendChild(n),console.log("üéõÔ∏è Debug overlay added - check top right corner")},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(function(){setTimeout((()=>{console.log("üöÄ Business Search Debugger loaded!"),console.log("Run debugBusinessSearch() to start debugging"),console.log("Run addDebugOverlay() to add visual debug tools")}),1e3)})):(console.log("üöÄ Business Search Debugger loaded!"),console.log("Run debugBusinessSearch() to start debugging"),console.log("Run addDebugOverlay() to add visual debug tools"));const chainMatchCache=new Map,apiCallQueue=[];let isProcessingQueue=!1;async function findMatchingChainForPlaceResultFixed(e){try{if(!e)return null;console.log("üîç CACHED CHAIN MATCHING: Checking for:",e);const n=e.trim().toLowerCase();if(chainMatchCache.has(n)){const o=chainMatchCache.get(n);return console.log(`üíæ CACHE HIT: ${e} ‚Üí ${o?o.bname:"No match"}`),o}const o=await findMatchingChainLocallyEnhanced(e);return o?(console.log(`üè† LOCAL MATCH: ${e} ‚Üí ${o.bname}`),chainMatchCache.set(n,o),o):new Promise((o=>{apiCallQueue.push({placeName:e,cleanName:n,resolve:o}),processApiQueue()}))}catch(e){return console.error("‚ùå Error in cached chain matching:",e),null}}async function processApiQueue(){if(!isProcessingQueue&&0!==apiCallQueue.length){for(isProcessingQueue=!0;apiCallQueue.length>0;){const{placeName:e,cleanName:n,resolve:o}=apiCallQueue.shift();try{console.log(`üåê API QUEUE: Processing ${e} (${apiCallQueue.length} remaining)`);const s=await tryServerSideChainMatchingOptimized(e);s?(console.log(`‚úÖ SERVER MATCH: ${e} ‚Üí ${s.bname}`),chainMatchCache.set(n,s),o(s)):(console.log(`‚ùå NO MATCH: ${e}`),chainMatchCache.set(n,null),o(null)),apiCallQueue.length>0&&await new Promise((e=>setTimeout(e,200)))}catch(s){console.error(`‚ùå API queue error for ${e}:`,s),chainMatchCache.set(n,null),o(null),apiCallQueue.length>0&&await new Promise((e=>setTimeout(e,500)))}}isProcessingQueue=!1}}function findMatchingChainLocallyEnhanced(e){return new Promise((n=>{try{if(!e)return void n(null);console.log("üè† ENHANCED LOCAL: Matching for:",e);const o={homedepot:{id:"681fe0e67d92c3d3e1e2a3da",name:"The Home Depot",patterns:[/^the home depot$/i,/^home depot$/i,/^homedepot$/i,/home depot/i]},olivegarden:{id:"682b61ee7e3ea12414dd4665",name:"Olive Garden",patterns:[/^olive garden$/i,/^olive garden italian restaurant$/i,/^olive garden italian$/i,/olive garden/i]},lowes:{id:"lowes_chain_id",name:"Lowe's",patterns:[/^lowes$/i,/^lowe's$/i,/^lowes home improvement$/i,/^lowe's home improvement$/i,/lowes?/i]},mcdonalds:{id:"mcdonalds_chain_id",name:"McDonald's",patterns:[/^mcdonalds$/i,/^mcdonald's$/i,/^mickey d's$/i,/mcdonald/i]},walmart:{id:"walmart_chain_id",name:"Walmart",patterns:[/^walmart$/i,/^wal-mart$/i,/^walmart supercenter$/i,/walmart/i]}},s=e.toLowerCase().trim();for(const[t,a]of Object.entries(o))for(const o of a.patterns)if(o.test(s))return console.log(`üéØ ENHANCED LOCAL MATCH: "${e}" ‚Üí "${a.name}" (pattern: ${o})`),void n({_id:a.id,bname:a.name,isLocalMatch:!0});console.log(`‚ùå No enhanced local match for: ${e}`),n(null)}catch(e){console.error("‚ùå Error in enhanced local matching:",e),n(null)}}))}async function tryServerSideChainMatchingOptimized(e){const n=getBaseURL(),o=e.replace(/\s+(italian\s+restaurant|restaurant|store|location|inc|llc|corp)$/i,"").trim();try{const s=await fetch(`${n}/api/business.js?operation=find_matching_chain&place_name=${encodeURIComponent(o)}`);if(s.ok){const n=await s.json();if(n.success&&n.chain)return console.log(`‚úÖ OPTIMIZED SERVER MATCH: "${e}" ‚Üí "${n.chain.bname}" (using "${o}")`),n.chain}}catch(e){console.error(`‚ùå Optimized server matching failed for "${o}":`,e.message)}return console.log(`‚ùå No optimized server match for: ${e}`),null}function clearChainMatchCache(){chainMatchCache.clear(),console.log("üßπ CACHE CLEARED: Chain match cache has been cleared")}function getChainMatchCacheStatus(){if(console.log("üìä CACHE STATUS:"),console.log(`   - Total entries: ${chainMatchCache.size}`),console.log(`   - API queue length: ${apiCallQueue.length}`),console.log(`   - Processing queue: ${isProcessingQueue}`),chainMatchCache.size>0){console.log("   - Cached entries:");for(const[e,n]of chainMatchCache.entries())console.log(`     ${e} ‚Üí ${n?n.bname:"No match"}`)}}async function retrieveFromMongoDBWithRecovery(e,n=!1){try{console.log("üîç SEARCH WITH RECOVERY: Starting enhanced search:",e);const o=document.getElementById("business-search-results")||document.getElementById("search_table");o&&(o.innerHTML='<div class="loading-indicator" id="main-loading"><div class="loading-text">Searching for businesses...</div><div class="loading-spinner"></div></div>',o.style.display="block");let s=null,t="none";if(e.useMyLocation)try{updateLoadingMessage("Getting your location..."),s=await getUserLocation(),window.currentSearchLocation=s,t="geolocation",console.log(`üìç LOCATION SOURCE: ${t} - ${s.lat}, ${s.lng}`)}catch(e){console.error("‚ùå Geolocation failed:",e);try{updateLoadingMessage("Using approximate location..."),s=await getApproximateLocation(),s&&(window.currentSearchLocation=s,t="approximate",console.log(`üìç FALLBACK LOCATION: ${t}`))}catch(e){console.error("‚ùå Fallback location failed:",e)}if(!s)return hideLoadingIndicator(),void showUserFriendlyError("location","Unable to determine your location. Please try entering a city or zip code instead.")}else if(e.address&&""!==e.address.trim())try{updateLoadingMessage("Finding location...");const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw new Error(`Geocoding failed for: ${e.address}`);if(s=n,window.currentSearchLocation=s,t="geocoded",console.log(`üìç LOCATION SOURCE: ${t} - ${e.address}`),map&&s){const e=new google.maps.LatLng(s.lat,s.lng);map.setCenter(e),map.setZoom(11)}}catch(n){return console.error("‚ùå Geocoding failed:",n),hideLoadingIndicator(),void showUserFriendlyError("geocoding",`We couldn't find "${e.address}". Please try a more specific address like "Las Vegas, NV" or "89121".`)}updateLoadingMessage("Searching database...");let a=[],i=!1;try{a=await searchDatabaseWithFuzzyMatching(e,s,n),i=!0,console.log(`üìä DATABASE SUCCESS: Found ${a.length} businesses`)}catch(o){console.error("‚ùå Database search failed:",o);try{console.log("üîÑ RETRY: Attempting simplified database search...");const o={businessName:e.businessName,address:"",useMyLocation:!1};a=await searchDatabaseWithFuzzyMatching(o,null,n),i=!0,console.log(`üìä SIMPLIFIED SEARCH SUCCESS: Found ${a.length} businesses`)}catch(e){console.error("‚ùå Simplified search also failed:",e)}}const r=a.filter((e=>!0!==e.is_chain));console.log(`‚úÖ VALID DB BUSINESSES: ${r.length} after filtering`);let l=[],c=!1;if(e.businessName&&s){updateLoadingMessage("Searching Google Places...");try{l=await searchGooglePlacesForBusinessFixed(e.businessName,s),c=!0,console.log(`üìä PLACES SUCCESS: Found ${l.length} businesses`)}catch(e){console.error("‚ùå Places search failed:",e),console.log("‚ö†Ô∏è Continuing with database results only")}}const d=[...r,...l];if(console.log(`üìä TOTAL RESULTS: ${d.length} (${r.length} database + ${l.length} places)`),d.length>0)r.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0})),l.forEach((e=>{e.isGooglePlace=!0,e.isFromDatabase=!1})),hideLoadingIndicator(),displayBusinessesOnMapFixed(d),displaySearchResultsFixed(d),showSearchSuccessMessage(r.length,l.length,t),console.log("‚úÖ SEARCH WITH RECOVERY: Completed successfully");else{hideLoadingIndicator();let n="No businesses found matching your search.";i||c?e.businessName&&!s?n=`No businesses named "${e.businessName}" found. Try adding a location or searching for a more general term.`:s&&!e.businessName&&(n="No businesses found in this area. Try expanding your search with a business name."):n="Unable to search for businesses at this time. Please check your internet connection and try again.",showUserFriendlyError("no-results",n)}}catch(e){console.error("‚ùå CRITICAL SEARCH ERROR:",e),hideLoadingIndicator(),showUserFriendlyError("critical","Something went wrong with the search. Please try refreshing the page and searching again.")}}async function getApproximateLocation(){return{lat:39.8283,lng:-98.5795,source:"default-us-center"}}function showUserFriendlyError(e,n){const o=document.getElementById("business-search-results")||document.getElementById("search_table");if(!o)return;const s={location:"üìç",geocoding:"üó∫Ô∏è","no-results":"üîç",critical:"‚ö†Ô∏è",network:"üåê"}[e]||"‚ùå";o.innerHTML=`\n        <div class="user-friendly-error">\n            <div class="error-icon">${s}</div>\n            <div class="error-message">${n}</div>\n            <div class="error-actions">\n                <button onclick="location.reload()" class="retry-btn">üîÑ Try Again</button>\n                <button onclick="clearSearchForm()" class="clear-btn">üÜï New Search</button>\n            </div>\n        </div>\n    `,o.style.display="block"}function showSearchSuccessMessage(e,n,o){const s=document.createElement("div");s.className="search-success-banner",s.innerHTML=`\n        <div class="success-content">\n            <span class="success-icon">‚úÖ</span>\n            <span class="success-text">\n                Found ${e+n} businesses\n                ${e>0?`(${e} in database`:""}\n                ${n>0?`${e>0?", ":"("}${n} nearby)`:e>0?")":""}\n            </span>\n            <button onclick="this.parentElement.parentElement.remove()" class="close-success">√ó</button>\n        </div>\n    `;const t=document.querySelector("main")||document.body;t.insertBefore(s,t.firstChild),setTimeout((()=>{s.parentNode&&s.remove()}),5e3)}function clearSearchForm(){const e=document.getElementById("business-search-form");if(e){e.reset(),e.querySelectorAll("input").forEach((e=>{e.classList.remove("valid-field","invalid-field"),e.removeAttribute("data-valid")}));const n=document.getElementById("business-search-results")||document.getElementById("search_table");n&&(n.style.display="none"),clearMarkers(),map&&(map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom)),console.log("üÜï FORM CLEARED: Search form and results cleared")}}function createDebugDashboard(){const e=document.getElementById("debug-dashboard");e&&e.remove();const n=document.createElement("div");n.id="debug-dashboard",n.style.cssText="\n        position: fixed;\n        top: 10px;\n        right: 10px;\n        background: rgba(0,0,0,0.9);\n        color: white;\n        padding: 15px;\n        border-radius: 8px;\n        z-index: 10000;\n        font-family: monospace;\n        font-size: 11px;\n        max-width: 350px;\n        max-height: 80vh;\n        overflow-y: auto;\n        box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n    ",n.innerHTML='\n        <h4 style="margin: 0 0 10px 0; color: #4CAF50; text-align: center;">üõ†Ô∏è Debug Dashboard</h4>\n        \n        <div class="debug-section">\n            <h5 style="color: #2196F3; margin: 10px 0 5px 0;">üîç Quick Tests</h5>\n            <button onclick="testSpecificSearch(\'Olive Garden\', false)" class="debug-btn">Test Olive Garden</button>\n            <button onclick="testSpecificSearch(\'The Home Depot\', true)" class="debug-btn">Test Home Depot + Location</button>\n            <button onclick="testSpecificSearch(\'McDonald\\\'s\', false)" class="debug-btn">Test McDonald\'s</button>\n        </div>\n\n        <div class="debug-section">\n            <h5 style="color: #FF9800; margin: 10px 0 5px 0;">üìä System Status</h5>\n            <button onclick="debugBusinessSearch()" class="debug-btn">Full System Debug</button>\n            <button onclick="getChainMatchCacheStatus()" class="debug-btn">Cache Status</button>\n            <button onclick="checkMapMarkers()" class="debug-btn">Check Markers</button>\n        </div>\n\n        <div class="debug-section">\n            <h5 style="color: #9C27B0; margin: 10px 0 5px 0;">üßπ Maintenance</h5>\n            <button onclick="clearChainMatchCache()" class="debug-btn">Clear Cache</button>\n            <button onclick="clearSearchForm()" class="debug-btn">Clear Form</button>\n            <button onclick="resetMapView()" class="debug-btn">Reset Map</button>\n        </div>\n\n        <div class="debug-section">\n            <h5 style="color: #F44336; margin: 10px 0 5px 0;">üö® Emergency</h5>\n            <button onclick="emergencyReset()" class="debug-btn danger">Emergency Reset</button>\n            <button onclick="location.reload()" class="debug-btn danger">Reload Page</button>\n        </div>\n\n        <div id="debug-status" style="margin-top: 10px; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 10px;">\n            Ready for debugging\n        </div>\n\n        <button onclick="document.getElementById(\'debug-dashboard\').remove()" \n                style="position: absolute; top: 5px; right: 8px; background: none; border: none; color: #f44336; font-size: 16px; cursor: pointer;">√ó</button>\n    ';const o=document.createElement("style");o.textContent="\n        .debug-btn {\n            display: block;\n            width: 100%;\n            margin: 2px 0;\n            padding: 6px 8px;\n            background: #333;\n            color: white;\n            border: 1px solid #555;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 10px;\n            transition: background 0.2s;\n        }\n        \n        .debug-btn:hover {\n            background: #555;\n        }\n        \n        .debug-btn.danger {\n            background: #d32f2f;\n            border-color: #b71c1c;\n        }\n        \n        .debug-btn.danger:hover {\n            background: #f44336;\n        }\n        \n        .debug-section {\n            margin-bottom: 10px;\n            padding-bottom: 8px;\n            border-bottom: 1px solid #333;\n        }\n        \n        .debug-section:last-child {\n            border-bottom: none;\n        }\n    ",document.head.appendChild(o),document.body.appendChild(n),console.log("üõ†Ô∏è DEBUG DASHBOARD: Created comprehensive debugging dashboard")}function checkMapMarkers(){if(console.log("üéØ MARKER CHECK: Analyzing current markers..."),!markers||0===markers.length)return console.log("‚ùå No markers found"),void updateDebugStatus("No markers on map");let e=0,n=0,o=0;markers.forEach(((s,t)=>{s.business?(s.business.isGooglePlace?n++:e++,console.log(`   ${t+1}. ${s.business.bname} (${s.business.isGooglePlace?"PLACES":"DATABASE"})`)):o++}));const s=`${markers.length} markers: ${e} database, ${n} places, ${o} invalid`;console.log(`üìä MARKER SUMMARY: ${s}`),updateDebugStatus(s)}function emergencyReset(){console.log("üö® EMERGENCY RESET: Performing complete system reset...");try{clearMarkers(),"function"==typeof clearChainMatchCache&&clearChainMatchCache(),clearSearchForm(),map&&(map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom)),infoWindow&&infoWindow.close(),document.querySelectorAll(".modal-backdrop").forEach((e=>e.remove())),document.body.classList.remove("modal-open"),document.body.style.paddingRight="",document.body.style.overflow="",document.querySelectorAll(".error-message, .user-friendly-error, .loading-indicator").forEach((e=>e.remove())),console.log("‚úÖ EMERGENCY RESET: System reset completed"),updateDebugStatus("Emergency reset completed")}catch(e){console.error("‚ùå EMERGENCY RESET FAILED:",e),updateDebugStatus("Emergency reset failed - try page reload")}}function updateDebugStatus(e){const n=document.getElementById("debug-status");n&&(n.textContent=`${(new Date).toLocaleTimeString()}: ${e}`)}function addEnhancedUserInterfaceCSS(){if(!document.getElementById("enhanced-ui-css")){const e=document.createElement("style");e.id="enhanced-ui-css",e.textContent="\n            /* User-friendly error messages */\n            .user-friendly-error {\n                text-align: center;\n                padding: 40px 20px;\n                background: linear-gradient(135deg, #fff3e0 0%, #ffccbc 100%);\n                border-radius: 12px;\n                margin: 20px;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n            }\n\n            .error-icon {\n                font-size: 48px;\n                margin-bottom: 16px;\n            }\n\n            .error-message {\n                font-size: 16px;\n                color: #333;\n                margin-bottom: 20px;\n                line-height: 1.5;\n            }\n\n            .error-actions {\n                display: flex;\n                gap: 10px;\n                justify-content: center;\n                flex-wrap: wrap;\n            }\n\n            .retry-btn, .clear-btn {\n                padding: 10px 20px;\n                border: none;\n                border-radius: 6px;\n                cursor: pointer;\n                font-weight: 500;\n                transition: all 0.2s;\n            }\n\n            .retry-btn {\n                background: #4CAF50;\n                color: white;\n            }\n\n            .retry-btn:hover {\n                background: #45a049;\n                transform: translateY(-1px);\n            }\n\n            .clear-btn {\n                background: #2196F3;\n                color: white;\n            }\n\n            .clear-btn:hover {\n                background: #1976D2;\n                transform: translateY(-1px);\n            }\n\n            /* Success banner */\n            .search-success-banner {\n                background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);\n                border: 1px solid #4caf50;\n                border-radius: 8px;\n                margin: 10px 0;\n                animation: slideInFromTop 0.5s ease-out;\n            }\n\n            .success-content {\n                display: flex;\n                align-items: center;\n                padding: 12px 16px;\n                gap: 10px;\n            }\n\n            .success-icon {\n                font-size: 18px;\n            }\n\n            .success-text {\n                flex: 1;\n                color: #2e7d32;\n                font-weight: 500;\n            }\n\n            .close-success {\n                background: none;\n                border: none;\n                font-size: 18px;\n                color: #2e7d32;\n                cursor: pointer;\n                padding: 0;\n                width: 24px;\n                height: 24px;\n            }\n\n            .close-success:hover {\n                background: rgba(76, 175, 80, 0.1);\n                border-radius: 50%;\n            }\n\n            @keyframes slideInFromTop {\n                from {\n                    opacity: 0;\n                    transform: translateY(-20px);\n                }\n                to {\n                    opacity: 1;\n                    transform: translateY(0);\n                }\n            }\n\n            /* Enhanced loading indicator */\n            .loading-indicator {\n                text-align: center;\n                padding: 40px 20px;\n                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);\n                border-radius: 12px;\n                margin: 20px;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n            }\n\n            .loading-text {\n                font-size: 18px;\n                color: #333;\n                margin-bottom: 20px;\n                font-weight: 500;\n            }\n\n            .loading-spinner {\n                width: 40px;\n                height: 40px;\n                border: 4px solid #e3f2fd;\n                border-top: 4px solid #2196f3;\n                border-radius: 50%;\n                animation: spin 1s linear infinite;\n                margin: 0 auto;\n            }\n        ",document.head.appendChild(e)}}async function retrieveFromMongoDBWithNearbyDetection(e,n=!1){try{console.log("üîç ENHANCED SEARCH: Starting search with nearby database detection:",e);const o=document.getElementById("business-search-results")||document.getElementById("search_table");o&&(o.innerHTML='<div class="loading-indicator" id="main-loading"><div class="loading-text">Searching for businesses...</div><div class="loading-spinner"></div></div>',o.style.display="block");let s=null,t=25;if(e.useMyLocation)try{updateLoadingMessage("Getting your location..."),s=await getUserLocation(),window.currentSearchLocation=s}catch(e){return console.error("‚ùå Error getting user location:",e),hideLoadingIndicator(),void alert("Unable to get your current location. Please try entering an address instead.")}else if(e.address&&""!==e.address.trim())try{updateLoadingMessage("Finding location...");const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw new Error(`Geocoding failed for address: ${e.address}`);if(s=n,window.currentSearchLocation=s,/^\d{5}$/.test(e.address.trim())?(t=15,console.log("üìç ZIP CODE SEARCH: Using 15km radius")):(e.address.toLowerCase().includes("city")||e.address.split(",").length>=2)&&(t=20,console.log("üìç CITY SEARCH: Using 20km radius")),map&&s){const e=new google.maps.LatLng(s.lat,s.lng);map.setCenter(e),map.setZoom(t<=15?12:11)}}catch(e){return console.error("‚ùå Error geocoding address:",e),hideLoadingIndicator(),void alert("We couldn't recognize that address. Please try a more specific address.")}updateLoadingMessage("Searching database...");let a=[];if(e.businessName&&""!==e.businessName.trim())try{a=await searchDatabaseWithFuzzyMatching(e,s,n),a=a.filter((e=>!0!==e.is_chain)),console.log(`üìä PRIMARY RESULTS: Found ${a.length} businesses for "${e.businessName}"`)}catch(e){console.error("‚ùå Primary search failed:",e)}let i=[];if(s)try{updateLoadingMessage("Finding nearby businesses in database..."),i=await searchNearbyDatabaseBusinesses(s,t,e.businessName),console.log(`üìä NEARBY DATABASE: Found ${i.length} nearby database businesses`)}catch(e){console.error("‚ùå Nearby database search failed:",e)}let r=[];if(e.businessName&&s)try{updateLoadingMessage("Searching Google Places..."),r=await searchGooglePlacesForBusinessFixed(e.businessName,s),console.log(`üìä PLACES RESULTS: Found ${r.length} Google Places businesses`)}catch(e){console.error("‚ùå Places search failed:",e)}const{finalPrimaryResults:l,finalNearbyResults:c,finalPlacesResults:d}=categorizeFinalResults(a,i,r),g=[...l,...c,...d];console.log("üìä FINAL CATEGORIZATION:"),console.log(`   - Primary (RED): ${l.length} businesses`),console.log(`   - Nearby Database (GREEN): ${c.length} businesses`),console.log(`   - Google Places (BLUE): ${d.length} businesses`),console.log(`   - Total: ${g.length} businesses`),g.length>0?(l.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!0,e.markerColor="primary"})),c.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!1,e.isNearbyDatabase=!0,e.markerColor="database"})),d.forEach((e=>{e.isGooglePlace=!0,e.isFromDatabase=!1,e.isPrimaryResult=!1,e.markerColor="nearby"})),hideLoadingIndicator(),displayBusinessesOnMapWithCategories(g),displaySearchResultsWithCategories(g),showEnhancedSearchSuccessMessage(l.length,c.length,d.length),console.log("‚úÖ ENHANCED SEARCH: Completed successfully with nearby detection")):(hideLoadingIndicator(),showNoResultsMessage())}catch(e){console.error("‚ùå Enhanced search error:",e),hideLoadingIndicator(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}async function searchNearbyDatabaseBusinesses(e,n,o=""){try{const s=`${getBaseURL()}/api/business.js?${new URLSearchParams({operation:"search",lat:e.lat,lng:e.lng,radius:n,limit:50}).toString()}`;console.log(`üåê NEARBY DATABASE SEARCH: ${s}`);const t=await fetch(s);if(!t.ok)throw new Error(`Nearby search failed: ${t.status}`);let a=(await t.json()).results||[];return a=a.filter((e=>!(!0===e.is_chain||o&&e.bname.toLowerCase().includes(o.toLowerCase())&&(console.log(`üö´ EXCLUDING PRIMARY MATCH: ${e.bname} (matches "${o}")`),1)))),console.log(`‚úÖ NEARBY DATABASE FILTER: ${a.length} nearby businesses after filtering`),a}catch(e){return console.error("‚ùå Error searching nearby database businesses:",e),[]}}function categorizeFinalResults(e,n,o){console.log("üîÑ CATEGORIZING RESULTS:");const s=[...e],t=new Set,a=new Set;return s.forEach((e=>{const n=createAddressKey(e),o=e.bname.toLowerCase().trim();t.add(n),a.add(o),console.log(`üî¥ PRIMARY: ${e.bname} at ${n}`)})),{finalPrimaryResults:s,finalNearbyResults:n.filter((e=>{const n=createAddressKey(e),o=e.bname.toLowerCase().trim();return t.has(n)||a.has(o)?(console.log(`üö´ NEARBY DUPLICATE: ${e.bname} (already in primary results)`),!1):(t.add(n),a.add(o),console.log(`üü¢ NEARBY DB: ${e.bname} at ${n}`),!0)})),finalPlacesResults:o.filter((e=>{const n=createAddressKey(e),o=e.bname.toLowerCase().trim();return t.has(n)||a.has(o)?(console.log(`üö´ PLACES DUPLICATE: ${e.bname} (already in database)`),!1):(console.log(`üîµ PLACES: ${e.bname} at ${n}`),!0)}))}}function createAddressKey(e){const n=[];return e.address1&&n.push(e.address1.toLowerCase().trim()),e.city&&n.push(e.city.toLowerCase().trim()),e.state&&n.push(e.state.toLowerCase().trim()),e.zip&&n.push(e.zip.trim()),n.join("|")}async function createEnhancedBusinessMarkerWithCategory(e,n){try{const{AdvancedMarkerElement:o}=await google.maps.importLibrary("marker");let s=createSafeLatLng(n);if(!s)return console.error("‚ùå Invalid position for enhanced marker:",n),createEnhancedFallbackMarker(e,n);const t=e.markerColor||"nearby",a=ENHANCED_CONFIG.markerColors[t];let i="",r="";switch(t){case"primary":i="primary database-business",r=`üî¥ RED MARKER: ${e.bname} (Primary search result)`;break;case"database":i="database nearby-database",r=`üü¢ GREEN MARKER: ${e.bname} (Nearby database business)`;break;default:i="nearby google-places",r=`üîµ BLUE MARKER: ${e.bname} (Google Places)`}console.log(r);const l=getBusinessTypeTextIcon(e.type),c=document.createElement("div");c.className="enhanced-custom-marker",c.setAttribute("title",e.bname),c.style.cursor="pointer",c.innerHTML=`\n            <div class="enhanced-marker-container">\n                <div class="enhanced-marker-pin ${i}" style="background-color: ${a} !important; border: 3px solid #ffffff;">\n                    <div class="enhanced-marker-icon">\n                        ${l}\n                    </div>\n                </div>\n                <div class="enhanced-marker-shadow"></div>\n                ${e.chain_id?'<div class="chain-indicator">üîó</div>':""}\n                ${e.isFromDatabase?'<div class="database-indicator">‚úì</div>':""}\n                ${e.isNearbyDatabase?'<div class="nearby-database-indicator">üè¢</div>':""}\n            </div>\n        `;const d=new o({position:s,map,title:e.bname,content:c,collisionBehavior:e.isPrimaryResult?"REQUIRED_AND_HIDES_OPTIONAL":"OPTIONAL_AND_HIDES_LOWER_PRIORITY"});return d.business=e,d.position=s,d.isFromDatabase=e.isFromDatabase,d.isPrimaryResult=e.isPrimaryResult,d.isNearbyDatabase=e.isNearbyDatabase,c.addEventListener("click",(function(n){console.log(`üñ±Ô∏è Marker clicked: ${e.bname} (${e.markerColor})`),n.stopPropagation(),showEnhancedInfoWindowWithCategory(d)})),c.addEventListener("mouseenter",(function(){c.style.transform="scale(1.1)",c.style.zIndex="1000"})),c.addEventListener("mouseleave",(function(){c.style.transform="scale(1)",c.style.zIndex="auto"})),markers.push(d),console.log(`‚úÖ Added ${t.toUpperCase()} marker for ${e.bname}`),d}catch(o){return console.error("‚ùå Error creating enhanced marker with category:",o),createEnhancedFallbackMarker(e,n)}}function showEnhancedInfoWindowWithCategory(e){if(console.log("ü™ü CATEGORY INFO WINDOW: Showing for:",e.business?.bname),!e||!e.business)return void console.error("‚ùå Invalid marker for category info window");const n=e.business,o=!0===n.isGooglePlace,s=!!n.chain_id,t=!0===n.isFromDatabase;n.isNearbyDatabase,n.isPrimaryResult,infoWindow&&infoWindow.close(),infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1});const a=buildCategoryAwareInfoWindowContent(n);infoWindow.setContent(a);let i=e.position;if(!i&&e.getPosition&&(i=e.getPosition()),i||(i=createSafeLatLng(n)),i){try{map.panTo(i)}catch(e){console.warn("‚ö†Ô∏è Error panning to position:",e)}setTimeout((()=>{try{e.getPosition?infoWindow.open(map,e):(infoWindow.setPosition(i),infoWindow.open(map)),console.log("‚úÖ Category info window opened successfully"),google.maps.event.addListenerOnce(infoWindow,"domready",(function(){setTimeout((()=>{applyEnhancedInfoWindowFixes();const e=o?`google_${n.placeId}`:n._id;console.log(`üéÅ CATEGORY INCENTIVES: Loading for ${e} (${n.markerColor})`),t&&s?loadChainIncentivesForDatabaseBusinessFixed(e,n.chain_id):t?loadIncentivesForEnhancedWindowFixed(e):o&&s&&loadChainIncentivesForEnhancedWindowFixed(e,n.chain_id)}),300)}))}catch(e){console.error("‚ùå Error opening category info window:",e)}}),200)}else console.error("‚ùå Could not determine position for category info window")}function buildCategoryAwareInfoWindowContent(e){const n=!0===e.isGooglePlace,o=!!e.chain_id,s=!0===e.isFromDatabase,t=!0===e.isNearbyDatabase,a=!0===e.isPrimaryResult;let i="";if(e.address1){i=`<div class="info-address">\n            <strong>üìç Address:</strong><br>\n            ${e.address1}`,e.address2&&(i+=`<br>${e.address2}`);const n=[];e.city&&n.push(e.city),e.state&&n.push(e.state),e.zip&&n.push(e.zip),n.length>0&&(i+=`<br>${n.join(", ")}`),i+="</div>"}else if(e.formattedAddress){const n=e.formattedAddress.split(",").map((e=>e.trim()));i='<div class="info-address">\n            <strong>üìç Address:</strong><br>',n.length>=1&&(i+=n[0]),n.length>=2&&(i+=`<br>${n.slice(1).join(", ")}`),i+="</div>"}const r=e.phone?`<div class="info-phone"><strong>üìû Phone:</strong> <a href="tel:${e.phone.replace(/\D/g,"")}" style="color: #4285F4; text-decoration: none;">${e.phone}</a></div>`:"";let l="";e.type&&"OTHER"!==e.type&&(l=`<div class="info-type"><strong>üè¢ Type:</strong> ${getBusinessTypeLabel(e.type)}</div>`);const c=e.distance?`<div class="info-distance"><strong>üìè Distance:</strong> ${(e.distance/1609).toFixed(1)} miles</div>`:"";let d="";o&&(d=`<span class="enhanced-chain-badge" style="background-color: ${a?"#4285F4":t?"#28a745":"#4285F4"};">üîó ${e.chain_name||"Chain Location"}</span>`);let g,u="",h="";a?u='<div class="info-status primary-result">üéØ This business matches your search and is in the Patriot Thanks database.</div>':t?(u='<div class="info-status nearby-database">üè¢ This business is in the Patriot Thanks database (found nearby).</div>',h='<div class="nearby-explanation">üí° This business appeared because it\'s in your search area and already in our database.</div>'):n&&o?(u='<div class="info-status chain-match">üîó This location appears to match a chain in our database!</div>',h=`<div class="chain-explanation">\n            ‚ú® Great news! This location matches <strong>${e.chain_name}</strong> in our database. \n            Chain-wide incentives should apply to this location once added.\n        </div>`):n&&(u='<div class="info-status google-place">‚ÑπÔ∏è This business is not yet in the Patriot Thanks database.</div>'),s?g=`\n            <button class="enhanced-view-btn" onclick="window.viewBusinessDetails('${e._id}')">\n                üëÅÔ∏è View Details\n            </button>\n        `:n&&o?g=`\n            <button class="enhanced-add-btn chain-add" onclick="window.addBusinessToDatabase('${e.placeId}', '${e.chain_id}')">\n                üîó Add ${e.chain_name} Location\n            </button>\n        `:n&&(g=`\n            <button class="enhanced-add-btn" onclick="window.addBusinessToDatabase('${e.placeId}')">\n                ‚ûï Add to Patriot Thanks\n            </button>\n        `);const p=n?`google_${e.placeId}`:e._id;let m;return m=s&&o?"<em>‚è≥ Loading chain incentives...</em>":s?"<em>‚è≥ Loading incentives...</em>":n&&o?"<em>‚è≥ Loading chain incentives...</em>":"<em>üí° Add this business to see available incentives.</em>",`\n        <div class="enhanced-info-window category-aware">\n            <div class="info-header">\n                <h3>${e.bname} ${d}</h3>\n            </div>\n            \n            <div class="info-body">\n                ${i}\n                ${r}\n                ${l}\n                ${c}\n                ${u}\n                ${h}\n                \n                <div class="info-incentives">\n                    <div id="incentives-container-${p}">\n                        ${m}\n                    </div>\n                </div>\n            </div>\n            \n            <div class="info-actions">\n                ${g}\n            </div>\n        </div>\n    `}function displayBusinessesOnMapWithCategories(e){if(!map)return console.log("‚è≥ Map not ready, storing businesses for later display"),void(pendingBusinessesToDisplay=e);console.log(`üó∫Ô∏è CATEGORIZED DISPLAY: Displaying ${e.length} businesses on map`),clearMarkers(),bounds=new google.maps.LatLngBounds;let n=0,o=0,s=0,t=0;e.forEach(((a,i)=>{try{if(console.log(`üîÑ Processing business ${i+1}/${e.length}: ${a.bname} (${a.markerColor||"unknown"})`),!0===a.is_chain)return console.log(`üö´ Skipping parent chain business: ${a.bname}`),void t++;const r=getBusinessLocation(a);if(!r)return console.warn(`‚ùå Business ${a.bname} missing coordinates`),void t++;if(a.lat=r.lat,a.lng=r.lng,createCategorizedBusinessMarker(a)){switch(a.markerColor){case"primary":n++;break;case"database":o++;break;default:s++}console.log(`‚úÖ Created ${a.markerColor} marker for ${a.bname}`);const e=new google.maps.LatLng(r.lat,r.lng);bounds.extend(e)}else console.error(`‚ùå Failed to create marker for ${a.bname}`),t++}catch(e){console.error(`‚ùå Error processing business ${a.bname}:`,e),t++}})),console.log("üìä CATEGORIZED MARKER SUMMARY:"),console.log(`   - üî¥ Primary (RED): ${n} markers`),console.log(`   - üü¢ Nearby Database (GREEN): ${o} markers`),console.log(`   - üîµ Google Places (BLUE): ${s} markers`),console.log(`   - ‚ùå Skipped: ${t} businesses`),console.log(`   - ‚úÖ Total Created: ${n+o+s} markers`),setTimeout((()=>{try{if(window.currentSearchLocation&&(n>0||o>0)){console.log("üìç Centering map on search location with results");const e=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng);map.setCenter(e),map.setZoom(12)}else n+o+s>0&&bounds&&!bounds.isEmpty()?(console.log("üéØ Fitting map to all business bounds"),safelyFitBounds(map,bounds)):(console.log("üåé Using default map center"),map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom))}catch(e){console.error("‚ùå Error updating map view:",e)}}),200)}function createCategorizedBusinessMarker(e){try{if(!e.lat||!e.lng||isNaN(parseFloat(e.lat))||isNaN(parseFloat(e.lng)))return console.warn(`‚ùå Invalid coordinates for business: ${e.bname}`),null;return createEnhancedBusinessMarkerWithCategory(e,new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng)))}catch(e){return console.error("‚ùå Error creating categorized business marker:",e),null}}function displaySearchResultsWithCategories(e){try{console.log(`üìã CATEGORIZED RESULTS: Displaying ${e.length} businesses in table`),hideLoadingIndicator();const n=document.getElementById("business_search"),o=document.getElementById("search_table");if(!n||!o)return console.error("‚ùå Required table elements not found in the DOM"),void showErrorMessage("There was an error displaying search results. Please try again later.");let s=n.querySelector("tbody");if(!s)return console.error("‚ùå Table body not found"),void showErrorMessage("There was an error displaying search results. Please try again later.");s.innerHTML="",o.style.display="block";const t=o.querySelector("h5");if(t&&(t.style.display="none"),0===e.length)return s.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria.</td></tr>',void o.scrollIntoView({behavior:"smooth"});const a=e.filter((e=>"primary"===e.markerColor)),i=e.filter((e=>"database"===e.markerColor)),r=e.filter((e=>"nearby"===e.markerColor));console.log("üìä TABLE CATEGORIES:"),console.log(`   - Primary Results: ${a.length}`),console.log(`   - Nearby Database: ${i.length}`),console.log(`   - Google Places: ${r.length}`);let l=0;a.length>0&&(addTableSectionHeader(s,`üéØ Search Results (${a.length})`,"primary-section"),a.forEach(((e,n)=>{console.log(`üìù Adding primary business ${n+1}: ${e.bname}`),addCategorizedBusinessRow(e,s,"primary"),l++}))),i.length>0&&(addTableSectionHeader(s,`üè¢ Nearby Businesses in Database (${i.length})`,"database-section"),i.forEach(((e,n)=>{console.log(`üìù Adding nearby database business ${n+1}: ${e.bname}`),addCategorizedBusinessRow(e,s,"database"),l++}))),r.length>0&&(addTableSectionHeader(s,`üåê Additional Locations Found (${r.length})`,"places-section"),r.forEach(((e,n)=>{console.log(`üìù Adding Google Places business ${n+1}: ${e.bname}`),addCategorizedBusinessRow(e,s,"places"),l++}))),o.scrollIntoView({behavior:"smooth"}),console.log(`‚úÖ Categorized search results displayed: ${l} total rows`)}catch(e){console.error("‚ùå Error displaying categorized search results:",e),hideLoadingIndicator(),showErrorMessage("There was an error displaying the search results: "+e.message)}}function addTableSectionHeader(e,n,o){const s=document.createElement("tr");s.className=`section-header ${o}`,s.innerHTML=`\n        <td colspan="5" class="section-header-cell">\n            <strong>${n}</strong>\n        </td>\n    `,e.appendChild(s)}function addCategorizedBusinessRow(e,n,o){if(!e)return;if(!0===e.is_chain)return void console.log(`‚è≠Ô∏è Skipping parent chain business in table: ${e.bname}`);console.log(`üìù Adding categorized table row: ${e.bname} (${o})`);let s="";if(e.address1)s=e.address2?`${e.address1}<br>${e.address2}<br>${e.city}, ${e.state} ${e.zip}`:`${e.address1}<br>${e.city}, ${e.state} ${e.zip}`;else{if(!e.formattedAddress)return void console.warn(`‚ùå Business ${e.bname} has no address information`);s=e.formattedAddress.replace(/,/g,"<br>")}const t=getBusinessTypeLabel(e.type);let a="",i="";switch(o){case"primary":a='<span class="category-badge primary-badge">üéØ Search Result</span>',i="primary-result-row";break;case"database":a='<span class="category-badge database-badge">üè¢ In Database</span>',i="database-result-row";break;case"places":a='<span class="category-badge places-badge">üåê Found Nearby</span>',i="places-result-row"}const r=e.chain_id?'<span class="chain-badge">üîó Chain Location</span>':"";let l;l="primary"===o||"database"===o?`<button class="view-map-btn ${o}" onclick="focusOnMapMarker('${e._id}')">üìç View on Map</button>`:e.chain_id?`<button class="add-to-db-btn chain" onclick="addBusinessToDatabase('${e.placeId}', '${e.chain_id}')">üîó Add Chain Location</button>`:`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${e.placeId}')">‚ûï Add to Database</button>`;const c=document.createElement("tr");c.className=`business-row ${i}`,c.innerHTML=`\n        <th class="left_table" data-business-id="${e._id}">\n            ${e.bname} ${r}\n            <div class="category-badges">${a}</div>\n        </th>\n        <th class="left_table">${s}</th>\n        <th class="left_table">${t}</th>\n        <th class="right_table" id="incentives-for-${e._id}">\n            ${"primary"===o||"database"===o?'<span class="loading-incentives">Loading incentives...</span>':"Not in database yet"}\n        </th>\n        <th class="center_table">${l}</th>\n    `,n.appendChild(c),"primary"===o||"database"===o?(console.log(`üéÅ Scheduling incentives load for ${o} business: ${e.bname} (ID: ${e._id})`),setTimeout((()=>{fetchBusinessIncentivesFixed(e._id,e.chain_id)}),100)):"places"===o&&e.chain_id&&(console.log(`üîó Scheduling chain incentives load for Places business: ${e.bname}`),fetchChainIncentivesForPlacesResult(e._id,e.chain_id))}function showEnhancedSearchSuccessMessage(e,n,o){const s=document.createElement("div");s.className="enhanced-search-success-banner";let t=`Found ${e+n+o} businesses: `;const a=[];e>0&&a.push(`<span class="success-primary">${e} search result${1!==e?"s":""}</span>`),n>0&&a.push(`<span class="success-database">${n} nearby database business${1!==n?"es":""}</span>`),o>0&&a.push(`<span class="success-places">${o} additional location${1!==o?"s":""}</span>`),t+=a.join(", "),s.innerHTML=`\n        <div class="enhanced-success-content">\n            <span class="success-icon">‚úÖ</span>\n            <span class="success-text">${t}</span>\n            <button onclick="this.parentElement.parentElement.remove()" class="close-success">√ó</button>\n        </div>\n        <div class="success-legend">\n            <span class="legend-item"><span class="legend-dot red"></span>Search Results</span>\n            <span class="legend-item"><span class="legend-dot green"></span>Nearby Database</span>\n            <span class="legend-item"><span class="legend-dot blue"></span>Additional Locations</span>\n        </div>\n    `;const i=document.querySelector("main")||document.body;i.insertBefore(s,i.firstChild),setTimeout((()=>{s.parentNode&&s.remove()}),8e3)}function updateMapLegendWithCategories(){const e=document.getElementById("map-container");if(!e)return;const n=e.querySelector(".map-legend");n&&n.remove();const o=document.createElement("div");o.className="map-legend enhanced-legend",o.innerHTML='\n        <div class="legend-item">\n            <div class="legend-color primary"></div>\n            <span>Primary Search Results</span>\n        </div>\n        <div class="legend-item">\n            <div class="legend-color database"></div>\n            <span>Nearby Database Businesses</span>\n        </div>\n        <div class="legend-item">\n            <div class="legend-color nearby"></div>\n            <span>Additional Locations Found</span>\n        </div>\n    ',e.appendChild(o)}function testCategorizedSearch(e,n){console.log(`üß™ TESTING CATEGORIZED SEARCH: "${e}" in ${n||"current area"}`);const o={businessName:e||"",address:n||"",useMyLocation:!n};console.log("üìù Test form data:",o),clearMarkers(),retrieveFromMongoDBWithNearbyDetection(o).then((()=>{console.log("‚úÖ Categorized search test completed"),setTimeout((()=>{updateMapLegendWithCategories()}),1e3)})).catch((e=>{console.error("‚ùå Categorized search test failed:",e)}))}async function retrieveFromMongoDBWithBetterPriority(e,n=!1){try{console.log("üîç ENHANCED SEARCH: Starting search with better priority logic:",e);const o=document.getElementById("business-search-results")||document.getElementById("search_table");o&&(o.innerHTML='<div class="loading-indicator" id="main-loading"><div class="loading-text">Searching for businesses...</div><div class="loading-spinner"></div></div>',o.style.display="block");let s=null,t=30;if(e.useMyLocation)try{updateLoadingMessage("Getting your location..."),s=await getUserLocation(),window.currentSearchLocation=s}catch(e){return console.error("‚ùå Error getting user location:",e),hideLoadingIndicator(),void alert("Unable to get your current location. Please try entering an address instead.")}else if(e.address&&""!==e.address.trim())try{updateLoadingMessage("Finding location...");const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw new Error(`Geocoding failed for address: ${e.address}`);if(s=n,window.currentSearchLocation=s,/^\d{5}$/.test(e.address.trim())?(t=25,console.log("üìç ZIP CODE SEARCH: Using 25km radius for better metro coverage")):e.address.toLowerCase().includes("city")||e.address.split(",").length>=2?(t=30,console.log("üìç CITY SEARCH: Using 30km radius")):(t=20,console.log("üìç ADDRESS SEARCH: Using 20km radius")),map&&s){const e=new google.maps.LatLng(s.lat,s.lng);map.setCenter(e),map.setZoom(t<=20?12:11)}}catch(e){return console.error("‚ùå Error geocoding address:",e),hideLoadingIndicator(),void alert("We couldn't recognize that address. Please try a more specific address.")}updateLoadingMessage("Searching database...");let a=[];if(e.businessName&&""!==e.businessName.trim())try{a=await searchDatabaseWithFuzzyMatching(e,s,n),a=a.filter((e=>!0!==e.is_chain)),console.log(`üìä PRIMARY RESULTS: Found ${a.length} businesses for "${e.businessName}"`)}catch(e){console.error("‚ùå Primary search failed:",e)}let i=[];if(e.businessName&&s)try{updateLoadingMessage("Searching for additional locations...");const n={...s,searchRadius:Math.max(t,35)};i=await searchGooglePlacesForBusinessWithRadius(e.businessName,n),console.log(`üìä PLACES RESULTS: Found ${i.length} additional "${e.businessName}" locations`)}catch(e){console.error("‚ùå Places search failed:",e)}let r=[];const l=!e.businessName||a.length+i.length<8;if(s&&l)try{updateLoadingMessage("Finding other nearby businesses..."),r=await searchNearbyDatabaseBusinesses(s,t,e.businessName),console.log(`üìä NEARBY DATABASE: Found ${r.length} other nearby businesses`)}catch(e){console.error("‚ùå Nearby database search failed:",e)}else console.log("‚è≠Ô∏è SKIPPING nearby search - found many relevant results");const{finalPrimaryResults:c,finalPlacesResults:d,finalNearbyResults:g}=categorizeResultsWithBetterPriority(a,i,r),u=[...c,...d,...g];console.log("üìä IMPROVED PRIORITIZATION:"),console.log(`   - üî¥ Primary Database (RED): ${c.length} businesses`),console.log(`   - üîµ Additional Locations (BLUE): ${d.length} businesses`),console.log(`   - üü¢ Other Nearby (GREEN): ${g.length} businesses`),console.log(`   - Total: ${u.length} businesses`),u.length>0?(c.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!0,e.markerColor="primary",e.priority=1})),d.forEach((e=>{e.isGooglePlace=!0,e.isFromDatabase=!1,e.isPrimaryResult=!1,e.isRelevantPlaces=!0,e.markerColor="nearby",e.priority=2})),g.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!1,e.isNearbyDatabase=!0,e.markerColor="database",e.priority=3})),hideLoadingIndicator(),displayBusinessesOnMapWithBetterPriority(u),displaySearchResultsWithBetterPriority(u),showImprovedSearchSuccessMessage(c.length,d.length,g.length,e.businessName),console.log("‚úÖ IMPROVED SEARCH: Completed successfully with better prioritization")):(hideLoadingIndicator(),showNoResultsMessage())}catch(e){console.error("‚ùå Enhanced search error:",e),hideLoadingIndicator(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}async function searchGooglePlacesForBusinessWithRadius(e,n){try{console.log("üîç ENHANCED PLACES SEARCH: Searching for:",e,"near",n);const{Place:o}=await google.maps.importLibrary("places"),s=new google.maps.LatLng(n.lat,n.lng),t=1e3*(n.searchRadius||35),a={textQuery:e,locationBias:{center:s,radius:t},maxResultCount:20,fields:["id","displayName","formattedAddress","location","types","nationalPhoneNumber","internationalPhoneNumber"]};console.log(`üåê Enhanced Places API request with ${t/1e3}km radius:`,a);const{places:i}=await o.searchByText(a);if(!i||0===i.length)return console.log("‚ùå No businesses found via enhanced Places API"),[];console.log(`‚úÖ Found ${i.length} businesses via enhanced Places API`);const r=i.map((async e=>{const o=e.formattedAddress?e.formattedAddress.split(","):[];let t="",a="",i="",r="";if(o.length>=1&&(t=o[0].trim()),o.length>=2&&(a=o[1].trim()),o.length>=3){const e=o[2].trim().match(/^([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/);e&&(i=e[1],r=e[2])}const l=e.location,c=google.maps.geometry.spherical.computeDistanceBetween(s,l);let d=0,g=0;if(e.location)try{d="function"==typeof e.location.lat?e.location.lat():e.location.lat||0,g="function"==typeof e.location.lng?e.location.lng():e.location.lng||0}catch(e){console.warn("‚ö†Ô∏è Error extracting coordinates:",e),d=n.lat,g=n.lng}const u={_id:"google_"+e.id,bname:e.displayName,address1:t,city:a,state:i,zip:r,formattedAddress:e.formattedAddress,type:mapGooglePlaceTypeToBusinessType(e.types),phone:e.nationalPhoneNumber||e.internationalPhoneNumber||"",isGooglePlace:!0,placeId:e.id,lat:d,lng:g,distance:c};try{const n=await findMatchingChainForPlaceResult(e.displayName);n?(console.log(`üîó CHAIN MATCH: "${e.displayName}" matches "${n.bname}"`),u.chain_id=n._id,u.chain_name=n.bname,u.isChainLocation=!0):console.log(`‚ùå No chain match for: ${e.displayName}`)}catch(e){console.warn("‚ö†Ô∏è Error checking for chain match:",e)}return u})),l=await Promise.all(r);return l.sort(((e,n)=>e.distance-n.distance)),console.log(`üìä ENHANCED PLACES RESULTS: ${l.length} businesses processed with ${t/1e3}km radius`),l.forEach(((e,n)=>{const o=(e.distance/1e3).toFixed(1);console.log(`   ${n+1}. ${e.bname} (${o}km away, Chain: ${e.isChainLocation?e.chain_name:"No"})`)})),l}catch(o){console.error("‚ùå Error in enhanced Places API search:",o);const s={lat:n.lat,lng:n.lng};return await searchGooglePlacesForBusinessFixed(e,s)}}async function performEnhancedBusinessSearch(e,n=!1){try{let o=null,s=30;if(e.useMyLocation)try{updateLoadingMessage("Getting your location..."),o=await getUserLocation(),window.currentSearchLocation=o}catch(e){return console.error("‚ùå Error getting user location:",e),hideLoadingIndicator(),void alert("Unable to get your current location. Please try entering an address instead.")}else if(e.address&&""!==e.address.trim())try{updateLoadingMessage("Finding location...");const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw new Error(`Geocoding failed for address: ${e.address}`);if(o=n,window.currentSearchLocation=o,/^\d{5}$/.test(e.address.trim())?(s=25,console.log("üìç ZIP CODE SEARCH: Using 25km radius for better metro coverage")):e.address.toLowerCase().includes("city")||e.address.split(",").length>=2?(s=30,console.log("üìç CITY SEARCH: Using 30km radius")):(s=20,console.log("üìç ADDRESS SEARCH: Using 20km radius")),map&&o){const e=new google.maps.LatLng(o.lat,o.lng);map.setCenter(e),map.setZoom(s<=20?12:11)}}catch(e){return console.error("‚ùå Error geocoding address:",e),hideLoadingIndicator(),void alert("We couldn't recognize that address. Please try a more specific address.")}updateLoadingMessage("Searching database...");let t=[];if(e.businessName&&""!==e.businessName.trim())try{t=await searchDatabaseWithFuzzyMatching(e,o,n),t=t.filter((e=>!0!==e.is_chain)),console.log(`üìä PRIMARY RESULTS: Found ${t.length} businesses for "${e.businessName}"`)}catch(e){console.error("‚ùå Primary search failed:",e)}let a=[];if(e.businessName&&o)try{updateLoadingMessage("Searching for additional locations...");const n={...o,searchRadius:Math.max(s,35)};a=await searchGooglePlacesForBusinessWithRadius(e.businessName,n),console.log(`üìä PLACES RESULTS: Found ${a.length} additional "${e.businessName}" locations`)}catch(e){console.error("‚ùå Places search failed:",e)}let i=[];const r=!e.businessName||t.length+a.length<8;if(o&&r)try{updateLoadingMessage("Finding other nearby businesses..."),i=await searchNearbyDatabaseBusinesses(o,s,e.businessName),console.log(`üìä NEARBY DATABASE: Found ${i.length} other nearby businesses`)}catch(e){console.error("‚ùå Nearby database search failed:",e)}else console.log("‚è≠Ô∏è SKIPPING nearby search - found many relevant results");const{finalPrimaryResults:l,finalPlacesResults:c,finalNearbyResults:d}=categorizeResultsWithBetterPriority(t,a,i),g=[...l,...c,...d];console.log("üìä IMPROVED PRIORITIZATION:"),console.log(`   - üî¥ Primary Database (RED): ${l.length} businesses`),console.log(`   - üîµ Additional Locations (BLUE): ${c.length} businesses`),console.log(`   - üü¢ Other Nearby (GREEN): ${d.length} businesses`),console.log(`   - Total: ${g.length} businesses`),g.length>0?(l.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!0,e.markerColor="primary",e.priority=1})),c.forEach((e=>{e.isGooglePlace=!0,e.isFromDatabase=!1,e.isPrimaryResult=!1,e.isRelevantPlaces=!0,e.markerColor="nearby",e.priority=2})),d.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!1,e.isNearbyDatabase=!0,e.markerColor="database",e.priority=3})),hideLoadingIndicator(),displayBusinessesOnMapWithBetterPriority(g),displaySearchResultsWithBetterPriority(g),showImprovedSearchSuccessMessage(l.length,c.length,d.length,e.businessName),console.log("‚úÖ IMPROVED SEARCH: Completed successfully with better prioritization")):(hideLoadingIndicator(),showNoResultsMessage())}catch(e){console.error("‚ùå Enhanced search error:",e),hideLoadingIndicator(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}function categorizeResultsWithBetterPriority(e,n,o){console.log("üîÑ IMPROVED CATEGORIZATION:");const s=[...e],t=new Set,a=new Set;return s.forEach((e=>{const n=createAddressKey(e),o=e.bname.toLowerCase().trim();t.add(n),a.add(o),console.log(`üî¥ PRIMARY: ${e.bname} at ${n}`)})),{finalPrimaryResults:s,finalPlacesResults:n.filter((e=>{const n=createAddressKey(e),o=e.bname.toLowerCase().trim();return t.has(n)||a.has(o)?(console.log(`üö´ PLACES DUPLICATE: ${e.bname} (already in database)`),!1):(t.add(n),a.add(o),console.log(`üîµ RELEVANT PLACES: ${e.bname} at ${n}`),!0)})),finalNearbyResults:o.filter((e=>{const n=createAddressKey(e),o=e.bname.toLowerCase().trim();return t.has(n)||a.has(o)?(console.log(`üö´ NEARBY DUPLICATE: ${e.bname} (already displayed)`),!1):(console.log(`üü¢ OTHER NEARBY: ${e.bname} at ${n}`),!0)}))}}function displaySearchResultsWithBetterPriority(e){try{console.log(`üìã IMPROVED RESULTS: Displaying ${e.length} businesses in better priority order`),hideLoadingIndicator();const n=document.getElementById("business_search"),o=document.getElementById("search_table");if(!n||!o)return console.error("‚ùå Required table elements not found in the DOM"),void showErrorMessage("There was an error displaying search results. Please try again later.");let s=n.querySelector("tbody");if(!s)return console.error("‚ùå Table body not found"),void showErrorMessage("There was an error displaying search results. Please try again later.");s.innerHTML="",o.style.display="block";const t=o.querySelector("h5");if(t&&(t.style.display="none"),0===e.length)return s.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria.</td></tr>',void o.scrollIntoView({behavior:"smooth"});const a=e.filter((e=>1===e.priority)),i=e.filter((e=>2===e.priority)),r=e.filter((e=>3===e.priority));console.log("üìä IMPROVED TABLE CATEGORIES:"),console.log(`   - üî¥ Primary Database Results: ${a.length}`),console.log(`   - üîµ Additional Relevant Locations: ${i.length}`),console.log(`   - üü¢ Other Nearby Businesses: ${r.length}`);let l=0;a.length>0&&(addTableSectionHeader(s,`üéØ Database Results (${a.length})`,"primary-section"),a.forEach(((e,n)=>{console.log(`üìù Adding primary business ${n+1}: ${e.bname}`),addCategorizedBusinessRow(e,s,"primary"),l++}))),i.length>0&&(addTableSectionHeader(s,`üìç Additional Locations Found (${i.length})`,"places-section"),i.forEach(((e,n)=>{console.log(`üìù Adding relevant Places business ${n+1}: ${e.bname}`),addCategorizedBusinessRow(e,s,"places"),l++}))),r.length>0&&(addTableSectionHeader(s,`üè¢ Other Nearby Businesses (${r.length})`,"database-section"),r.forEach(((e,n)=>{console.log(`üìù Adding nearby database business ${n+1}: ${e.bname}`),addCategorizedBusinessRow(e,s,"database"),l++}))),o.scrollIntoView({behavior:"smooth"}),console.log(`‚úÖ Improved priority search results displayed: ${l} total rows`)}catch(e){console.error("‚ùå Error displaying improved priority search results:",e),hideLoadingIndicator(),showErrorMessage("There was an error displaying the search results: "+e.message)}}function displayBusinessesOnMapWithBetterPriority(e){if(!map)return console.log("‚è≥ Map not ready, storing businesses for later display"),void(pendingBusinessesToDisplay=e);console.log(`üó∫Ô∏è IMPROVED MAP DISPLAY: Displaying ${e.length} businesses with better priority`),clearMarkers(),bounds=new google.maps.LatLngBounds;let n=0,o=0,s=0,t=0;const a=[...e].sort(((e,n)=>(e.priority||999)-(n.priority||999)));a.forEach(((e,i)=>{try{if(console.log(`üîÑ Processing business ${i+1}/${a.length}: ${e.bname} (Priority: ${e.priority})`),!0===e.is_chain)return console.log(`üö´ Skipping parent chain business: ${e.bname}`),void t++;const r=getBusinessLocation(e);if(!r)return console.warn(`‚ùå Business ${e.bname} missing coordinates`),void t++;if(e.lat=r.lat,e.lng=r.lng,createCategorizedBusinessMarker(e)){switch(e.priority){case 1:n++;break;case 2:o++;break;default:s++}console.log(`‚úÖ Created priority ${e.priority} marker for ${e.bname}`);const t=new google.maps.LatLng(r.lat,r.lng);bounds.extend(t)}else console.error(`‚ùå Failed to create marker for ${e.bname}`),t++}catch(n){console.error(`‚ùå Error processing business ${e.bname}:`,n),t++}})),console.log("üìä IMPROVED PRIORITY MARKER SUMMARY:"),console.log(`   - üî¥ Priority 1 - Database Results (RED): ${n} markers`),console.log(`   - üîµ Priority 2 - Additional Locations (BLUE): ${o} markers`),console.log(`   - üü¢ Priority 3 - Other Nearby (GREEN): ${s} markers`),console.log(`   - ‚ùå Skipped: ${t} businesses`),console.log(`   - ‚úÖ Total Created: ${n+o+s} markers`),setTimeout((()=>{try{if(window.currentSearchLocation&&(n>0||o>0)){console.log("üìç Centering map on search location with relevant results");const e=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng);map.setCenter(e),map.setZoom(12)}else n+o+s>0&&bounds&&!bounds.isEmpty()?(console.log("üéØ Fitting map to all business bounds"),safelyFitBounds(map,bounds)):(console.log("üåé Using default map center"),map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom))}catch(e){console.error("‚ùå Error updating map view:",e)}}),200)}function showImprovedSearchSuccessMessage(e,n,o,s){const t=document.createElement("div");t.className="enhanced-search-success-banner";let a=`Found ${e+n+o} businesses`;s&&(a+=` for "${s}"`),a+=": ";const i=[];e>0&&i.push(`<span class="success-primary">${e} in database</span>`),n>0&&i.push(`<span class="success-places">${n} additional location${1!==n?"s":""}</span>`),o>0&&i.push(`<span class="success-database">${o} other nearby</span>`),a+=i.join(", "),t.innerHTML=`\n        <div class="enhanced-success-content">\n            <span class="success-icon">‚úÖ</span>\n            <span class="success-text">${a}</span>\n            <button onclick="this.parentElement.parentElement.remove()" class="close-success">√ó</button>\n        </div>\n        <div class="success-legend">\n            <span class="legend-item"><span class="legend-dot red"></span>Database Results</span>\n            <span class="legend-item"><span class="legend-dot blue"></span>Additional Locations</span>\n            <span class="legend-item"><span class="legend-dot green"></span>Other Nearby</span>\n        </div>\n    `;const r=document.querySelector("main")||document.body;r.insertBefore(t,r.firstChild),setTimeout((()=>{t.parentNode&&t.remove()}),8e3)}async function searchGooglePlacesForBusinessEnhanced(e,n){try{console.log("üîç ENHANCED PLACES SEARCH: Searching for:",e,"near",n);const{Place:o}=await google.maps.importLibrary("places"),s=new google.maps.LatLng(n.lat,n.lng),t=5e4,a={textQuery:e,locationBias:{center:s,radius:t},maxResultCount:20,fields:["id","displayName","formattedAddress","location","types","nationalPhoneNumber","internationalPhoneNumber","businessStatus"]};console.log(`üåê Enhanced Places API request with ${t/1e3}km radius:`,a);const{places:i}=await o.searchByText(a);if(!i||0===i.length){console.log("‚ùå No businesses found via enhanced Places API"),console.log("üîÑ FALLBACK: Trying with 75km radius...");const n={...a,locationBias:{center:s,radius:75e3}},{places:t}=await o.searchByText(n);return t&&0!==t.length?(console.log(`‚úÖ Fallback found ${t.length} businesses`),await processPlacesResults(t,s,e)):(console.log("‚ùå No businesses found even with larger radius"),[])}return console.log(`‚úÖ Found ${i.length} businesses via enhanced Places API`),await processPlacesResults(i,s,e)}catch(o){console.error("‚ùå Error in enhanced Places API search:",o),console.log("üîÑ FINAL FALLBACK: Using existing Places search...");try{return await searchGooglePlacesForBusinessFixed(e,n)}catch(e){return console.error("‚ùå All Places search methods failed:",e),[]}}}async function processPlacesResults(e,n,o){console.log(`üîÑ Processing ${e.length} Places results for "${o}"`);const s=e.filter((e=>{if("CLOSED_PERMANENTLY"===e.businessStatus)return console.log(`‚è≠Ô∏è Skipping permanently closed: ${e.displayName}`),!1;const n=e.displayName.toLowerCase(),s=o.toLowerCase();if(!n.includes(s)&&!s.includes(n)){const o=s.split(" "),t=n.split(" ");let a=0;for(const e of o)t.some((n=>n.includes(e)||e.includes(n)))&&a++;if(a<Math.ceil(o.length/2))return console.log(`‚è≠Ô∏è Skipping unrelated result: ${e.displayName}`),!1}return!0}));console.log(`‚úÖ Filtered to ${s.length} valid places`);const t=s.map((async(e,o)=>{console.log(`   ${o+1}. Processing: ${e.displayName}`);const s=e.formattedAddress?e.formattedAddress.split(","):[];let t="",a="",i="",r="";if(s.length>=1&&(t=s[0].trim()),s.length>=2&&(a=s[1].trim()),s.length>=3){const e=s[2].trim().match(/^([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/);e&&(i=e[1],r=e[2])}const l=e.location,c=google.maps.geometry.spherical.computeDistanceBetween(n,l),d=(c/1e3).toFixed(1);let g=0,u=0;if(e.location)try{g="function"==typeof e.location.lat?e.location.lat():e.location.lat||0,u="function"==typeof e.location.lng?e.location.lng():e.location.lng||0}catch(e){console.warn("‚ö†Ô∏è Error extracting coordinates:",e),g=n.lat(),u=n.lng()}const h={_id:"google_"+e.id,bname:e.displayName,address1:t,city:a,state:i,zip:r,formattedAddress:e.formattedAddress,type:mapGooglePlaceTypeToBusinessType(e.types),phone:e.nationalPhoneNumber||e.internationalPhoneNumber||"",isGooglePlace:!0,placeId:e.id,lat:g,lng:u,distance:c,businessStatus:e.businessStatus};console.log(`      ‚Üí ${h.bname} at ${d}km (${a}, ${i})`);try{const n=await findMatchingChainForPlaceResult(e.displayName);n&&(console.log(`      üîó Chain match: ${n.bname}`),h.chain_id=n._id,h.chain_name=n.bname,h.isChainLocation=!0)}catch(n){console.warn(`      ‚ö†Ô∏è Chain matching failed for ${e.displayName}:`,n.message)}return h})),a=await Promise.all(t);return a.sort(((e,n)=>e.distance-n.distance)),console.log(`üìä FINAL PROCESSED RESULTS: ${a.length} businesses`),a.forEach(((e,n)=>{const o=(e.distance/1e3).toFixed(1);console.log(`   ${n+1}. ${e.bname} - ${o}km - ${e.city}, ${e.state}`)})),a}async function searchNearbyDatabaseBusinessesEnhanced(e,n,o=""){try{console.log(`üè¢ ENHANCED NEARBY DB SEARCH: ${n}km radius around ${e.lat}, ${e.lng}`);const s=getBaseURL(),t=Math.max(n,30),a=`${s}/api/business.js?${new URLSearchParams({operation:"search",lat:e.lat,lng:e.lng,radius:t,limit:100}).toString()}`;console.log(`üåê Enhanced nearby search: ${a}`);const i=await fetch(a);if(!i.ok)throw new Error(`Nearby search failed: ${i.status}`);let r=(await i.json()).results||[];return console.log(`üìä Raw nearby results: ${r.length} businesses`),r=r.filter((e=>{if(!0===e.is_chain)return!1;if(o){const n=e.bname.toLowerCase(),s=o.toLowerCase();if(n===s||n.includes(s)||s.includes(n))return console.log(`üö´ EXCLUDING: ${e.bname} (matches "${o}")`),!1}return!!hasValidCoordinates(e)||(console.log(`üö´ EXCLUDING: ${e.bname} (invalid coordinates)`),!1)})),console.log(`‚úÖ ENHANCED NEARBY FILTER: ${r.length} businesses after filtering`),r.slice(0,5).forEach(((e,n)=>{console.log(`   ${n+1}. ${e.bname} - ${e.city}, ${e.state}`)})),r}catch(e){return console.error("‚ùå Error in enhanced nearby database search:",e),[]}}async function debugLasVegasOliveGardenSearch(){console.log("üß™ DEBUG: Testing Las Vegas Olive Garden search...");const e={lat:36.0395,lng:-115.061};try{console.log("1. Testing enhanced Places search...");const n=await searchGooglePlacesForBusinessEnhanced("Olive Garden",e);console.log(`   Found ${n.length} Olive Garden locations via Places API`),console.log("2. Testing enhanced nearby database search...");const o=await searchNearbyDatabaseBusinessesEnhanced(e,30,"Olive Garden");console.log(`   Found ${o.length} nearby database businesses`),console.log("3. Testing database search for Olive Garden...");const s={businessName:"Olive Garden",address:"",useMyLocation:!1},t=await searchDatabaseWithFuzzyMatching(s,e,!1);return console.log(`   Found ${t.length} Olive Garden locations in database`),console.log("‚úÖ DEBUG TEST COMPLETE"),{places:n.length,nearby:o.length,database:t.length}}catch(e){return console.error("‚ùå Debug test failed:",e),null}}async function testOliveGardenLasVegas(){console.log("üß™ TESTING: Olive Garden search in Las Vegas (89121)");const e={businessName:"Olive Garden",address:"89121",useMyLocation:!1};try{clearMarkers(),await performEnhancedBusinessSearch(e,!0),console.log("‚úÖ Test search completed - check results!")}catch(e){console.error("‚ùå Test search failed:",e)}}function createEnhancedAddressKey(e){const n=[];e.address1&&n.push(e.address1.toLowerCase().trim()),e.city&&n.push(e.city.toLowerCase().trim()),e.state&&n.push(e.state.toLowerCase().trim()),e.placeId&&n.push(`place_${e.placeId}`),e._id&&!e._id.startsWith("google_")&&n.push(`db_${e._id}`);const o=n.join("|");return console.log(`üîë ADDRESS KEY for ${e.bname}: ${o}`),o}function createBusinessNameKey(e){if(e.isChainLocation||e.chain_id){const n=e.address1?e.address1.toLowerCase().replace(/\d+/g,"").trim():"",o=`${e.bname.toLowerCase().trim()}_${n}`;return console.log(`üè™ CHAIN NAME KEY for ${e.bname}: ${o}`),o}const n=e.bname.toLowerCase().trim();return console.log(`üè¢ REGULAR NAME KEY for ${e.bname}: ${n}`),n}function categorizeResultsWithFixedDuplicateDetection(e,n,o){console.log("üîÑ FIXED CATEGORIZATION - Properly handling chain locations:");const s=[...e],t=new Set,a=new Set;s.forEach((e=>{const n=createEnhancedAddressKey(e),o=createBusinessNameKey(e);t.add(n),a.add(o),console.log(`üî¥ PRIMARY: ${e.bname} - Address: ${n} - Name: ${o}`)}));const i=n.filter(((e,n)=>{const o=createEnhancedAddressKey(e),s=createBusinessNameKey(e);return console.log(`üîç CHECKING PLACES #${n+1}: ${e.bname}`),console.log(`   Address Key: ${o}`),console.log(`   Name Key: ${s}`),t.has(o)?(console.log(`üö´ PLACES DUPLICATE: ${e.bname} (same address: ${o})`),!1):a.has(s)?(console.log(`üö´ PLACES DUPLICATE: ${e.bname} (same name+address combination: ${s})`),!1):(t.add(o),a.add(s),console.log(`üîµ PLACES ACCEPTED: ${e.bname} at ${e.address1}`),!0)})),r=o.filter((e=>{const n=createEnhancedAddressKey(e),o=createBusinessNameKey(e);return t.has(n)||a.has(o)?(console.log(`üö´ NEARBY DUPLICATE: ${e.bname} (already processed)`),!1):(console.log(`üü¢ NEARBY ACCEPTED: ${e.bname} at ${e.address1}`),!0)}));return console.log("üìä FIXED CATEGORIZATION RESULTS:"),console.log(`   üî¥ Primary: ${s.length}`),console.log(`   üîµ Places: ${i.length} (was ${n.length})`),console.log(`   üü¢ Nearby: ${r.length}`),{finalPrimaryResults:s,finalPlacesResults:i,finalNearbyResults:r}}async function performEnhancedBusinessSearchWithFixedDuplicates(e,n=!1){try{console.log("üîç FIXED SEARCH: Starting search with proper chain location handling:",e);const o=document.getElementById("business-search-results")||document.getElementById("search_table");o&&(o.innerHTML='<div class="loading-indicator" id="main-loading"><div class="loading-text">Searching for businesses...</div><div class="loading-spinner"></div></div>',o.style.display="block");let s=null,t=30;if(e.useMyLocation)try{updateLoadingMessage("Getting your location..."),s=await getUserLocation(),window.currentSearchLocation=s}catch(e){return console.error("‚ùå Error getting user location:",e),hideLoadingIndicator(),void alert("Unable to get your current location. Please try entering an address instead.")}else if(e.address&&""!==e.address.trim())try{updateLoadingMessage("Finding location...");const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw new Error(`Geocoding failed for address: ${e.address}`);if(s=n,window.currentSearchLocation=s,/^\d{5}$/.test(e.address.trim())?(t=25,console.log("üìç ZIP CODE SEARCH: Using 25km radius")):e.address.toLowerCase().includes("city")||e.address.split(",").length>=2?(t=30,console.log("üìç CITY SEARCH: Using 30km radius")):(t=20,console.log("üìç ADDRESS SEARCH: Using 20km radius")),map&&s){const e=new google.maps.LatLng(s.lat,s.lng);map.setCenter(e),map.setZoom(t<=20?12:11)}}catch(e){return console.error("‚ùå Error geocoding address:",e),hideLoadingIndicator(),void alert("We couldn't recognize that address. Please try a more specific address.")}updateLoadingMessage("Searching database...");let a=[];if(e.businessName&&""!==e.businessName.trim())try{a=await searchDatabaseWithFuzzyMatching(e,s,n),a=a.filter((e=>!0!==e.is_chain)),console.log(`üìä PRIMARY RESULTS: Found ${a.length} businesses for "${e.businessName}"`)}catch(e){console.error("‚ùå Primary search failed:",e)}let i=[];if(e.businessName&&s)try{updateLoadingMessage("Searching for additional locations...");const n={...s,searchRadius:Math.max(t,35)};i=await searchGooglePlacesForBusinessEnhanced(e.businessName,n),console.log(`üìä PLACES RESULTS: Found ${i.length} additional "${e.businessName}" locations`)}catch(e){console.error("‚ùå Places search failed:",e)}let r=[];const l=!e.businessName||a.length+i.length<8;if(s&&l)try{updateLoadingMessage("Finding other nearby businesses..."),r=await searchNearbyDatabaseBusinessesEnhanced(s,t,e.businessName),console.log(`üìä NEARBY DATABASE: Found ${r.length} other nearby businesses`)}catch(e){console.error("‚ùå Nearby database search failed:",e)}else console.log("‚è≠Ô∏è SKIPPING nearby search - found many relevant results");const{finalPrimaryResults:c,finalPlacesResults:d,finalNearbyResults:g}=categorizeResultsWithFixedDuplicateDetection(a,i,r),u=[...c,...d,...g];console.log("üìä FIXED SEARCH RESULTS:"),console.log(`   - üî¥ Primary Database (RED): ${c.length} businesses`),console.log(`   - üîµ Additional Locations (BLUE): ${d.length} businesses`),console.log(`   - üü¢ Other Nearby (GREEN): ${g.length} businesses`),console.log(`   - Total: ${u.length} businesses`),u.length>0?(c.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!0,e.markerColor="primary",e.priority=1})),d.forEach((e=>{e.isGooglePlace=!0,e.isFromDatabase=!1,e.isPrimaryResult=!1,e.isRelevantPlaces=!0,e.markerColor="nearby",e.priority=2})),g.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!1,e.isNearbyDatabase=!0,e.markerColor="database",e.priority=3})),hideLoadingIndicator(),displayBusinessesOnMapWithBetterPriority(u),displaySearchResultsWithBetterPriority(u),showImprovedSearchSuccessMessage(c.length,d.length,g.length,e.businessName),console.log("‚úÖ FIXED SEARCH: Completed successfully with proper chain location handling")):(hideLoadingIndicator(),showNoResultsMessage())}catch(e){console.error("‚ùå Fixed search error:",e),hideLoadingIndicator(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}async function testFixedOliveGardenSearch(){console.log("üß™ TESTING FIXED: Olive Garden search with proper duplicate detection");const e={businessName:"Olive Garden",address:"89121",useMyLocation:!1};try{clearMarkers(),await performEnhancedBusinessSearchWithFixedDuplicates(e,!0),console.log("‚úÖ Fixed test search completed - should now show 9+ Olive Garden locations!")}catch(e){console.error("‚ùå Fixed test search failed:",e)}}console.log("üöÄ FIXED duplicate detection loaded!"),console.log("üß™ Run testFixedOliveGardenSearch() to test the fix"),console.log("üìç Should now show 9+ Olive Garden locations in Las Vegas!"),"undefined"!=typeof window&&(window.retrieveFromMongoDB=performEnhancedBusinessSearchWithFixedDuplicates,window.createEnhancedAddressKey=createEnhancedAddressKey,window.createBusinessNameKey=createBusinessNameKey,window.categorizeResultsWithFixedDuplicateDetection=categorizeResultsWithFixedDuplicateDetection,window.performEnhancedBusinessSearchWithFixedDuplicates=performEnhancedBusinessSearchWithFixedDuplicates,window.testFixedOliveGardenSearch=testFixedOliveGardenSearch,window.performEnhancedBusinessSearch=performEnhancedBusinessSearchWithFixedDuplicates,window.searchGooglePlacesForBusinessEnhanced=searchGooglePlacesForBusinessEnhanced,window.processPlacesResults=processPlacesResults,window.searchNearbyDatabaseBusinessesEnhanced=searchNearbyDatabaseBusinessesEnhanced,window.debugLasVegasOliveGardenSearch=debugLasVegasOliveGardenSearch,window.testOliveGardenLasVegas=testOliveGardenLasVegas,window.searchGooglePlacesForBusiness=searchGooglePlacesForBusinessEnhanced,window.searchNearbyDatabaseBusinesses=searchNearbyDatabaseBusinessesEnhanced,window.categorizeResultsWithBetterPriority=categorizeResultsWithBetterPriority,window.displaySearchResultsWithBetterPriority=displaySearchResultsWithBetterPriority,window.displayBusinessesOnMapWithBetterPriority=displayBusinessesOnMapWithBetterPriority,window.showImprovedSearchSuccessMessage=showImprovedSearchSuccessMessage,window.searchGooglePlacesForBusinessWithRadius=searchGooglePlacesForBusinessWithRadius,window.displayBusinessesOnMap=displayBusinessesOnMapWithCategories,window.displaySearchResults=displaySearchResultsWithCategories,window.displayBusinessesOnMapFixed=displayBusinessesOnMapWithCategories,window.displaySearchResultsFixed=displaySearchResultsWithCategories,window.categorizeFinalResults=categorizeFinalResults,window.createAddressKey=createAddressKey,window.createEnhancedBusinessMarkerWithCategory=createEnhancedBusinessMarkerWithCategory,window.showEnhancedInfoWindowWithCategory=showEnhancedInfoWindowWithCategory,window.buildCategoryAwareInfoWindowContent=buildCategoryAwareInfoWindowContent,window.createCategorizedBusinessMarker=createCategorizedBusinessMarker,window.addTableSectionHeader=addTableSectionHeader,window.addCategorizedBusinessRow=addCategorizedBusinessRow,window.showEnhancedSearchSuccessMessage=showEnhancedSearchSuccessMessage,window.updateMapLegendWithCategories=updateMapLegendWithCategories,window.testCategorizedSearch=testCategorizedSearch,window.getApproximateLocation=getApproximateLocation,window.showUserFriendlyError=showUserFriendlyError,window.showSearchSuccessMessage=showSearchSuccessMessage,window.clearSearchForm=clearSearchForm,window.createDebugDashboard=createDebugDashboard,window.checkMapMarkers=checkMapMarkers,window.emergencyReset=emergencyReset,window.updateDebugStatus=updateDebugStatus,window.addEnhancedUserInterfaceCSS=addEnhancedUserInterfaceCSS,window.findMatchingChainForPlaceResult=findMatchingChainForPlaceResultFixed,window.findMatchingChainLocallyEnhanced=findMatchingChainLocallyEnhanced,window.tryServerSideChainMatchingOptimized=tryServerSideChainMatchingOptimized,window.clearChainMatchCache=clearChainMatchCache,window.getChainMatchCacheStatus=getChainMatchCacheStatus,window.processApiQueue=processApiQueue,window.buildEnhancedInfoWindowContent=buildEnhancedInfoWindowContentFixed2,window.showEnhancedInfoWindow=showEnhancedInfoWindowFixed2,window.loadChainIncentivesForEnhancedWindow=loadChainIncentivesForEnhancedWindowFixed,window.loadIncentivesForEnhancedWindow=loadIncentivesForEnhancedWindowFixed,window.loadChainIncentivesForDatabaseBusiness=loadChainIncentivesForDatabaseBusinessFixed,window.createBusinessMarker=createBusinessMarker,window.createEnhancedBusinessMarkerFixed=createEnhancedBusinessMarkerFixed,window.fetchBusinessIncentivesFixed=fetchBusinessIncentivesFixed,window.addBusinessRowFixed=addBusinessRowFixed,window.fetchBusinessIncentives=fetchBusinessIncentivesFixed,window.addBusinessRow=addBusinessRowFixed,window.supplementWithGooglePlaces=supplementWithGooglePlaces,window.createBusinessMarker=createBusinessMarker,window.searchDatabaseWithFuzzyMatching=searchDatabaseWithFuzzyMatching,window.hasValidCoordinates=hasValidCoordinates,window.checkForNewlyAddedBusiness=checkForNewlyAddedBusiness,window.updateLoadingMessage=updateLoadingMessage,window.hideLoadingIndicator=hideLoadingIndicator,window.showNoResultsMessage=showNoResultsMessage,window.showErrorMessage=showErrorMessage,window.addEnhancedLoadingCSS=addEnhancedLoadingCSS,window.calculateSimilarity=calculateSimilarity,window.extractKeywords=extractKeywords,window.generateNameVariations=generateNameVariations,window.tryServerSideChainMatching=tryServerSideChainMatching,window.getChainFromDatabase=getChainFromDatabase,window.searchGooglePlacesForBusinessLegacy=searchGooglePlacesForBusinessLegacy,window.loadChainIncentivesInContainer=loadChainIncentivesInContainer,window.generateNameVariations=generateNameVariations,window.findMatchingChainLocally=findMatchingChainLocally,window.initGoogleMap=initGoogleMap,window.debugMapState=debugMapState,window.validateField=validateField,window.isNotEmpty=isNotEmpty,window.setupMapClickHandler=setupMapClickHandler,window.buildInfoWindowContent=buildInfoWindowContent,window.getPlaceTypeLabel=getPlaceTypeLabel,window.safeExtractCoordinates=safeExtractCoordinates,window.showInfoWindow=showInfoWindow,window.withErrorHandling=withErrorHandling,window.createEnhancedBusinessMarker=createEnhancedBusinessMarker,window.showEnhancedInfoWindow=showEnhancedInfoWindow,window.buildEnhancedInfoWindowContent=buildEnhancedInfoWindowContent,window.addEnhancedMarkerStyles=addEnhancedMarkerStyles,window.getBusinessTypeTextIcon=getBusinessTypeTextIcon,window.createEnhancedFallbackMarker=createEnhancedFallbackMarker,window.createEnhancedBusinessMarker=createEnhancedBusinessMarker,window.addEnhancedMarkerStyles=addEnhancedMarkerStyles,window.searchNearbyBusinesses=searchNearbyBusinesses,window.getSimilarBusinessTypes=getSimilarBusinessTypes,window.getBusinessLocation=getBusinessLocation,window.createSimilarBusinessMarker=createSimilarBusinessMarker,window.ENHANCED_CONFIG=ENHANCED_CONFIG,addEnhancedUserInterfaceCSS());