const CONFIG={mapId:"ebe8ec43a7bc252d",defaultCenter:{lat:39.8283,lng:-98.5795},defaultZoom:4,markerColors:{primary:"#EA4335",nearby:"#4285F4"},geocodeDelay:200,imageLoadDelay:1e3,maxNearbyDistance:2e4,debugMode:!1};let map=null,mapInitialized=!1,markers=[],infoWindow=null,bounds=null,pendingBusinessesToDisplay=[],currentSearchLocation=null;const placeCache=new Map;function clearMarkers(){markers?(markers.forEach((e=>{e&&(e.map=null)})),markers=[]):markers=[]}function debugMapState(){if(console.log("==== MAP DEBUGGING INFO ===="),console.log("Map initialized:",mapInitialized),console.log("Map object exists:",!!map),map)try{const e=map.getCenter();console.log("Map center:",e?`${e.lat()}, ${e.lng()}`:"undefined"),console.log("Map zoom:",map.getZoom()),console.log("Map type:",map.getMapTypeId()),console.log("Map ID:",map.getMapId())}catch(e){console.error("Error getting map properties:",e)}if(console.log("Markers count:",markers?markers.length:0),markers&&markers.length>0&&(console.log("Markers summary:"),markers.forEach(((e,n)=>{try{let o;e.getPosition?o=e.getPosition():e.position&&(o=e.position);const t=o?"function"==typeof o.lat?`${o.lat()}, ${o.lng()}`:`${o.lat}, ${o.lng}`:"unknown";console.log(`  Marker #${n}: Business: ${e.business?e.business.bname:"unknown"}, Position: ${t}`)}catch(e){console.error(`  Error getting marker #${n} info:`,e)}}))),console.log("Bounds:",bounds?"exists":"not created"),bounds)try{const e=bounds.getNorthEast(),n=bounds.getSouthWest();if(console.log("  NE:",e?`${e.lat()}, ${e.lng()}`:"undefined"),console.log("  SW:",n?`${n.lat()}, ${n.lng()}`:"undefined"),console.log("  Empty:",bounds.isEmpty()),e&&n){const o=isNaN(e.lat())||isNaN(e.lng())||isNaN(n.lat())||isNaN(n.lng());console.log("  Has NaN coordinates:",o)}}catch(e){console.error("  Error getting bounds info:",e)}console.log("Map container:",document.getElementById("map")?"found":"not found");const e=document.getElementById("map");e&&(console.log("  Display:",window.getComputedStyle(e).display),console.log("  Dimensions:",`${e.offsetWidth} Ã— ${e.offsetHeight}`),console.log("  Position:",e.style.position),console.log("  Visibility:",window.getComputedStyle(e).visibility),console.log("  Z-index:",window.getComputedStyle(e).zIndex)),console.log("Google Maps libraries:"),console.log("  maps:",!!google.maps),console.log("  places:",!!google.maps.places),console.log("  geometry:",!!google.maps.geometry),console.log("  marker:",!!google.maps.marker),console.log("Google Maps API Key:",getGoogleMapsApiKey()?"found":"not found"),console.log("Current search location:",currentSearchLocation?`${currentSearchLocation.lat}, ${currentSearchLocation.lng}`:"none"),console.log("==== END DEBUGGING INFO ====")}function isValidPosition(e){if(!e)return console.warn("Position is null or undefined"),!1;let n,o;if(e instanceof google.maps.LatLng)try{n=e.lat(),o=e.lng()}catch(e){return console.warn("Error getting lat/lng from LatLng:",e),!1}else if("function"==typeof e.lat&&"function"==typeof e.lng)try{n=e.lat(),o=e.lng()}catch(e){return console.warn("Error calling lat/lng functions:",e),!1}else{if(void 0===e.lat||void 0===e.lng)return console.warn("Position does not have lat/lng properties"),!1;n=parseFloat(e.lat),o=parseFloat(e.lng)}return isNaN(n)||isNaN(o)?(console.warn("Position has NaN coordinates:",n,o),!1):isFinite(n)&&isFinite(o)?!(Math.abs(n)>90||Math.abs(o)>180)||(console.warn("Position coordinates out of range:",n,o),!1):(console.warn("Position has non-finite coordinates:",n,o),!1)}function createSafeLatLng(e){if(!e)return null;try{if(e instanceof google.maps.LatLng)return isValidPosition(e)?e:null;let n,o;if("function"==typeof e.lat&&"function"==typeof e.lng)n=e.lat(),o=e.lng();else if(void 0!==e.lat&&void 0!==e.lng)n=parseFloat(e.lat),o=parseFloat(e.lng);else if(void 0!==e.latitude&&void 0!==e.longitude)n=parseFloat(e.latitude),o=parseFloat(e.longitude);else{if(!(Array.isArray(e)&&e.length>=2))return console.warn("Position format not recognized:",e),null;n=parseFloat(e[0]),o=parseFloat(e[1])}return isNaN(n)||isNaN(o)||!isFinite(n)||!isFinite(o)?(console.warn("Invalid coordinates:",n,o),null):Math.abs(n)>90||Math.abs(o)>180?(console.warn("Coordinates out of range:",n,o),null):new google.maps.LatLng(n,o)}catch(e){return console.error("Error creating LatLng:",e),null}}function safelySetCenter(e,n,o){if(!e)return!1;try{const t=createSafeLatLng(n);return!!t&&(e.setCenter(t),void 0!==o&&e.setZoom(o),!0)}catch(e){return console.error("Error setting map center:",e),!1}}function safelyFitBounds(e,n,o=11){if(!e||!n)return!1;try{const o=n.getNorthEast(),t=n.getSouthWest();return!o||!t||isNaN(o.lat())||isNaN(o.lng())||isNaN(t.lat())||isNaN(t.lng())?(console.warn("Invalid bounds for fitBounds:",n),!1):n.isEmpty()?(console.warn("Empty bounds, not fitting"),!1):(e.fitBounds(n),google.maps.event.addListenerOnce(e,"bounds_changed",(function(){const n=e.getZoom();n>16?e.setZoom(16):n<4&&e.setZoom(4)})),!0)}catch(n){console.error("Error fitting bounds:",n);try{void 0!==o&&e.setZoom(o)}catch(e){console.error("Error setting fallback zoom:",e)}return!1}}function createNewBounds(){return new google.maps.LatLngBounds}let googleMapsInitializing=!1,googleMapsInitialized=!1;function ensureGoogleMapsInitialized(){return googleMapsInitialized||googleMapsInitializing?(console.log("Google Maps already initialized or initializing"),Promise.resolve()):new Promise(((e,n)=>{try{if(googleMapsInitializing=!0,console.log("Starting Google Maps initialization"),window.google&&window.google.maps)return console.log("Google Maps API is already loaded, just initializing map"),initGoogleMap(),googleMapsInitialized=!0,googleMapsInitializing=!1,void e();const o=window.appConfig?.googleMapsApiKey||getGoogleMapsApiKey(),t=window.appConfig?.googleMapsMapId||CONFIG.mapId;window.initGoogleMapCallback=function(){console.log("Google Maps callback executed"),initGoogleMap(),googleMapsInitialized=!0,googleMapsInitializing=!1,e()};const i=document.createElement("script");i.src=`https://maps.googleapis.com/maps/api/js?key=${o}&map_ids=${t}&libraries=places,geometry,marker&callback=initGoogleMapCallback&loading=async&v=weekly`,i.async=!0,i.defer=!0,i.onerror=function(e){console.error("Google Maps API failed to load:",e),googleMapsInitializing=!1,n(e)},document.head.appendChild(i)}catch(e){googleMapsInitializing=!1,console.error("Error initializing Google Maps:",e),n(e)}}))}function addCustomMarkerStyles(){if(!document.getElementById("custom-marker-css")){const e=document.createElement("style");e.id="custom-marker-css",e.textContent='\n            .custom-marker {\n                cursor: pointer;\n            }\n            \n            .marker-container {\n                position: relative;\n                width: 32px;\n                height: 40px;\n            }\n            \n            .marker-pin {\n                width: 32px;\n                height: 40px;\n                border-radius: 50% 50% 50% 0;\n                background-color: #EA4335;\n                transform: rotate(-45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n                position: absolute;\n                top: 0;\n                left: 0;\n            }\n            \n            .marker-pin.nearby {\n                background-color: #4285F4;\n            }\n            \n            .marker-icon {\n                transform: rotate(45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                width: 20px;\n                height: 20px;\n            }\n            \n            /* Critical fix - ensure Font Awesome icons are visible */\n            .marker-icon i.fas,\n            .marker-icon i.fa,\n            .marker-icon i.far,\n            .marker-icon i.fab {\n                display: inline-block !important;\n                font-size: 14px !important;\n                color: white !important;\n                line-height: 1 !important;\n                width: auto !important;\n                height: auto !important;\n                vertical-align: middle !important;\n            }\n            \n            /* Fallback icon content for missing Font Awesome */\n            .marker-icon i.fas.fa-store-alt:after {\n                content: "ðŸª";\n                font-family: sans-serif;\n                font-size: 14px;\n            }\n            \n            .marker-icon i.fas.fa-shopping-cart:after {\n                content: "ðŸ›’";\n                font-family: sans-serif;\n                font-size: 14px;\n            }\n            \n            .marker-shadow {\n                background-color: rgba(0, 0, 0, 0.2);\n                border-radius: 50%;\n                height: 14px;\n                width: 14px;\n                position: absolute;\n                bottom: -3px;\n                left: 9px;\n                filter: blur(2px);\n                z-index: -1;\n            }\n            \n            /* Info window action button styling */\n            .info-window-actions {\n                margin-top: 12px;\n                padding-top: 8px;\n                border-top: 1px solid #eee;\n                text-align: right;\n            }\n            \n            .info-window-actions .add-business-btn,\n            .info-window-actions .view-details-btn {\n                margin-top: 8px;\n                font-weight: bold;\n                text-transform: uppercase;\n                font-size: 12px;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                transition: background-color 0.2s ease;\n                border: none;\n                color: white;\n                letter-spacing: 0.5px;\n                display: inline-block;\n            }\n            \n            .info-window-actions .add-business-btn {\n                background-color: #EA4335;\n            }\n            \n            .info-window-actions .add-business-btn:hover {\n                background-color: #D32F2F;\n            }\n            \n            .info-window-actions .view-details-btn {\n                background-color: #4285F4;\n            }\n            \n            .info-window-actions .view-details-btn:hover {\n                background-color: #2A75F3;\n            }\n        ',document.head.appendChild(e)}}function addChainBadgeStyles(){if(!document.getElementById("chain-badge-css")){const e=document.createElement("style");e.id="chain-badge-css",e.textContent="\n            .chain-badge {\n                display: inline-block;\n                background-color: #4285F4;\n                color: white;\n                padding: 2px 6px;\n                border-radius: 4px;\n                font-size: 0.8em;\n                margin-left: 5px;\n                font-weight: normal;\n            }\n\n            .chain-badge.small {\n                font-size: 0.7em;\n                padding: 1px 4px;\n            }\n            \n            .admin-action-btn {\n                background-color: #673AB7;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .view-chain-btn {\n                background-color: #2196F3;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .add-to-db-btn {\n                background-color: #4CAF50;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .view-map-btn {\n                background-color: #FF9800;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n        ",document.head.appendChild(e)}}function getUserLocation(){return new Promise(((e,n)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition((n=>{const o={lat:n.coords.latitude,lng:n.coords.longitude};console.log("Got user location:",o),e(o)}),(e=>{console.warn("Error getting location:",e),n(e)}),{enableHighAccuracy:!0,timeout:5e3,maximumAge:0}):(console.warn("Geolocation not supported by this browser"),n(new Error("Geolocation not supported")))}))}function getPlaceTypeLabel(e){if(!e||!e.length)return"Unknown";const n={restaurant:"Restaurant",food:"Food",store:"Store",establishment:"Business",point_of_interest:"Point of Interest",gas_station:"Gas Station",lodging:"Lodging",cafe:"Cafe",bar:"Bar",hardware_store:"Hardware Store",home_goods_store:"Home Goods",department_store:"Department Store",grocery_or_supermarket:"Grocery Store",furniture_store:"Furniture Store",electronics_store:"Electronics Store"};for(const o of e)if(n[o])return n[o];return e[0].replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase()))}async function getChainDetails(e){if(!e)return null;const n=getBaseURL();try{const o=await fetch(`${n}/api/business.js?operation=get&id=${e}`);if(!o.ok)throw new Error(`Failed to get chain details: ${o.status}`);const t=await o.json();return t.result?t.result:null}catch(e){return console.error("Error getting chain details:",e),null}}function getAddressComponentFromPlace(e,n){if(!e.addressComponents)return"";const o=e.addressComponents.find((e=>e.types.includes(n)));return o?o.shortText:""}function getBusinessTypeLabel(e){return{AUTO:"Automotive",BEAU:"Beauty",BOOK:"Bookstore",CLTH:"Clothing",CONV:"Convenience Store/Gas Station",DEPT:"Department Store",ELEC:"Electronics",ENTR:"Entertainment",FURN:"Furniture",FUEL:"Fuel Station/Truck Stop",GIFT:"Gift Shop",GROC:"Grocery",HARDW:"Hardware",HEAL:"Health",JEWL:"Jewelry",OTHER:"Other",RX:"Pharmacy",REST:"Restaurant",RETAIL:"Retail",SERV:"Service",SPEC:"Specialty",SPRT:"Sporting Goods",TECH:"Technology",TOYS:"Toys"}[e]||e}function getIncentiveTypeLabel(e){return{VT:"Veteran",AD:"Active Duty",FR:"First Responder",SP:"Spouse",OT:"Other"}[e]||e}function getBaseURL(){return"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:window.location.origin}function initBusinessSearch(){console.log("Business search initialization...");const e={businessName:document.getElementById("business-name"),address:document.getElementById("address"),useMyLocation:document.getElementById("use-my-location")},n=document.getElementById("business-search-form");n?n.addEventListener("submit",(function(n){if(n.preventDefault(),!e.businessName?.value&&!e.address?.value&&!e.useMyLocation?.checked)return void alert("Please enter either a business name, an address, or use your current location to search");const o={businessName:e.businessName?.value||"",address:e.address?.value||"",useMyLocation:e.useMyLocation?.checked||!1};if(console.log("Form data to submit:",o),mapInitialized){clearMarkers();const e=document.getElementById("initial-map-message");e&&e.remove(),retrieveFromMongoDB(o)}else console.warn("Map not initialized yet. Will initialize and display businesses after map loads."),ensureGoogleMapsInitialized().then((()=>{clearMarkers(),retrieveFromMongoDB(o)})).catch((e=>{console.error("Failed to initialize Google Maps:",e),alert("There was a problem loading the map. Please try refreshing the page.")}))})):console.warn("Business search form not found in the DOM"),e.businessName&&e.businessName.addEventListener("input",(function(){validateField(this,isNotEmpty)})),e.address&&e.address.addEventListener("input",(function(){validateField(this,isNotEmpty)})),e.useMyLocation&&e.useMyLocation.addEventListener("change",(function(){const n=document.getElementById("location-status");this.checked?(e.address&&(e.address.disabled=!0,e.address.placeholder="Using your current location..."),n&&(n.textContent="Location will be used when you search",n.style.display="block",n.style.color="#666")):(e.address&&(e.address.disabled=!1,e.address.placeholder="Address, City, State, or Zip"),n&&(n.style.display="none"))})),addRefreshButton(),checkForNewlyAddedBusiness()}function addRefreshButton(){const e=document.getElementById("business-search-form");if(!e)return;if(document.getElementById("refresh-search-btn"))return;const n=document.createElement("button");n.id="refresh-search-btn",n.type="button",n.className="refresh-btn",n.innerHTML='<i class="fas fa-sync-alt"></i> Refresh Results',n.style.marginLeft="10px",n.style.backgroundColor="#28a745",n.style.color="white",n.style.border="none",n.style.borderRadius="4px",n.style.padding="8px 12px",n.style.cursor="pointer",n.addEventListener("click",(function(){const e={businessName:document.getElementById("business-name")?.value||"",address:document.getElementById("address")?.value||"",useMyLocation:document.getElementById("use-my-location")?.checked||!1};clearMarkers();const n=document.getElementById("initial-map-message");n&&n.remove(),this.innerHTML='<i class="fas fa-sync-alt fa-spin"></i> Refreshing...',retrieveFromMongoDB(e,!0),setTimeout((()=>{this.innerHTML='<i class="fas fa-sync-alt"></i> Refresh Results'}),1e3)}));const o=e.querySelector('input[type="submit"]');o&&o.parentNode?o.parentNode.insertBefore(n,o.nextSibling):e.appendChild(n)}function checkForNewlyAddedBusiness(){const e=new URLSearchParams(window.location.search),n=e.get("business_added"),o=e.get("business_name");if("true"===n&&o){showNewBusinessAlert(o);const e=document.getElementById("business-name");e&&(e.value=o,validateField(e,isNotEmpty)),setTimeout((()=>{const e=document.getElementById("business-search-form");if(e){const n=new Event("submit",{cancelable:!0});e.dispatchEvent(n)}}),500)}}function showNewBusinessAlert(e){const n=document.createElement("div");n.className="alert alert-success",n.role="alert",n.style.marginBottom="20px",n.style.animation="fadeIn 0.5s",n.innerHTML=`\n        <strong>Success!</strong> "${e}" has been added to the database. \n        Searching for this business now...\n        <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n            <span aria-hidden="true">&times;</span>\n        </button>\n    `,n.style.backgroundColor="#d4edda",n.style.border="1px solid #c3e6cb",n.style.color="#155724",n.style.borderRadius="4px",n.style.padding="12px 20px";const o=n.querySelector(".close");o&&(o.style.float="right",o.style.fontSize="20px",o.style.fontWeight="bold",o.style.lineHeight="20px",o.style.color="#155724",o.style.opacity="0.5",o.style.cursor="pointer",o.addEventListener("click",(function(){n.remove()})));const t=document.createElement("style");t.textContent="\n        @keyframes fadeIn {\n            from { opacity: 0; transform: translateY(-10px); }\n            to { opacity: 1; transform: translateY(0); }\n        }\n        @keyframes fadeOut {\n            from { opacity: 1; transform: translateY(0); }\n            to { opacity: 0; transform: translateY(-10px); }\n        }\n    ",document.head.appendChild(t);const i=document.querySelector("main")||document.body;i.insertBefore(n,i.firstChild),setTimeout((()=>{n.parentNode&&(n.style.animation="fadeOut 0.5s",setTimeout((()=>n.remove()),500))}),8e3)}async function retrieveFromMongoDB(e,n=!1){try{console.log("Starting search with form data:",e);const o=document.getElementById("business-search-results")||document.getElementById("search_table");o&&(o.innerHTML='<div class="loading-indicator">Searching for businesses...</div>',o.style.display="block");let t=null;if(e.useMyLocation)try{console.log("Getting user's location for search..."),t=await getUserLocation(),console.log("User location for search:",t),window.currentSearchLocation=t}catch(e){return console.error("Error getting user location:",e),void alert("Unable to get your current location. Please try entering an address instead.")}else if(e.address&&""!==e.address.trim())try{console.log("Geocoding address for search:",e.address);const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw console.warn("Client-side geocoding failed"),new Error(`Geocoding failed for address: ${e.address}`);if(t=n,console.log("Successfully geocoded address to:",t),window.currentSearchLocation=t,map&&t){const e=new google.maps.LatLng(t.lat,t.lng);map.setCenter(e),map.setZoom(11)}}catch(e){return console.error("Error geocoding address:",e),void alert("We couldn't recognize that address. Please try a more specific address.")}const i={};e.businessName&&""!==e.businessName.trim()&&(i.business_name=e.businessName),e.address&&""!==e.address.trim()&&(i.address=e.address),t&&t.lat&&t.lng&&(i.lat=t.lat,i.lng=t.lng,i.radius=25),n&&(i.ts=(new Date).getTime());const s=new URLSearchParams(i).toString(),a=`${getBaseURL()}/api/business.js?operation=search&${s}`;console.log("Submitting search to API:",a);const r=await fetch(a,{method:"GET",headers:{"Content-Type":"application/json; charset=UTF-8","Cache-Control":n?"no-cache, no-store, must-revalidate":"default",Pragma:n?"no-cache":"default",Expires:n?"0":"default"}});if(console.log("Response status:",r.status),!r.ok){const e=await r.text();throw console.error("Error response:",e),new Error(`Failed to retrieve data: ${r.status} ${e}`)}const l=await r.json();if(console.log("Search results from database:",l),clearMarkers(),bounds=new google.maps.LatLngBounds,l.results&&0!==l.results.length){if(console.log(`Found ${l.results.length} businesses in database`),displayBusinessesOnMap(l.results),document.getElementById("search_table"))displaySearchResults(l.results);else{const e=document.getElementById("business-search-results");e&&displayBusinessSearchResults(l.results,e)}if(t&&t.lat&&t.lng){const e=new google.maps.LatLng(t.lat,t.lng);l.results.length>0&&searchNearbyBusinesses(e,l.results[0].type)}}else console.log("No results in database, searching Google Places..."),t&&e.businessName?await searchGooglePlacesForSpecificBusiness(e.businessName,t):await searchGooglePlaces(e,t)}catch(e){console.error("Search error:",e);const n=document.getElementById("business-search-results")||document.getElementById("search_table");n?(n.innerHTML=`<div class="error-message">Error searching for businesses: ${e.message}</div>`,n.style.display="block"):alert(`Error searching for businesses: ${e.message}`)}}async function geocodeAddressClientSide(e){return new Promise(((n,o)=>{try{if(console.log(`Geocoding address client-side: ${e}`),!e)return console.error("No address provided for geocoding"),void o(new Error("No address provided"));if(!window.google||!window.google.maps)return void o(new Error("Google Maps API not loaded"));(new google.maps.Geocoder).geocode({address:e},(function(e,t){if(t===google.maps.GeocoderStatus.OK&&e&&e.length>0){const o=e[0].geometry.location,t={lat:o.lat(),lng:o.lng(),formattedAddress:e[0].formatted_address};console.log("Client-side geocoding result:",t),n(t)}else console.error("Client-side geocoding failed:",t),o(new Error(`Geocoding failed: ${t}`))}))}catch(e){console.error("Error in client-side geocoding:",e),o(e)}}))}async function searchGooglePlacesForSpecificBusiness(e,n){try{console.log("Searching specifically for:",e);const o=document.getElementById("map");o&&(o.style.display="block",o.style.height="500px");const t=document.createElement("div");t.id="map-loading",t.className="loading-indicator",t.innerHTML="Searching for businesses...",o.appendChild(t);const i=new google.maps.LatLng(n.lat,n.lng);map.setCenter(i),map.setZoom(11);const s=new google.maps.places.PlacesService(map),a={query:e,location:i,radius:5e4};s.textSearch(a,((o,t)=>{const i=document.getElementById("map-loading");if(i&&i.remove(),t===google.maps.places.PlacesServiceStatus.OK&&o&&o.length>0){console.log("Found specific businesses:",o.length);const e=o.map((e=>({_id:"google_"+e.place_id,bname:e.name,address1:e.formatted_address||"",city:"",state:"",zip:"",isGooglePlace:!0,placeId:e.place_id,lat:e.geometry.location.lat(),lng:e.geometry.location.lng()})));e.forEach((e=>{createBusinessMarker(e)})),displaySearchResults(e)}else console.log("No specific businesses found:",t),searchGooglePlaces({businessName:e},n)}))}catch(o){console.error("Error in specific business search:",o),searchGooglePlaces({businessName:e},n)}}async function searchGooglePlaces(e,n=null){try{console.log("Searching Google Places for:",e);const o=document.getElementById("map");o&&(o.style.display="block",o.style.height="500px"),clearMarkers(),bounds=new google.maps.LatLngBounds;let t="";e.businessName&&(t+=e.businessName),e.address&&(t+=" "+e.address),t=t.trim();const i=document.createElement("div");let s;i.id="map-loading",i.className="loading-indicator",i.innerHTML="Searching for businesses...",o.appendChild(i),n?(s=new google.maps.LatLng(n.lat,n.lng),bounds.extend(s),map.setCenter(s),map.setZoom(12)):(s=new google.maps.LatLng(CONFIG.defaultCenter.lat,CONFIG.defaultCenter.lng),bounds.extend(s),console.log("Using default US center for search"));try{const e=new google.maps.places.PlacesService(map),n={query:t,location:s,radius:4e4};e.textSearch(n,((e,n)=>{const o=document.getElementById("map-loading");if(o&&o.remove(),n===google.maps.places.PlacesServiceStatus.OK&&e&&e.length>0){console.log("Found places via Places API:",e.length);const n=e.map((e=>{const n=e.formatted_address?e.formatted_address.split(","):[];let o="",t="",i="",a="";if(n.length>=1&&(o=n[0].trim()),n.length>=2&&(t=n[1].trim()),n.length>=3){const e=n[2].trim().split(" ");e.length>=1&&(i=e[0].trim()),e.length>=2&&(a=e[1].trim())}const r=e.geometry.location,l=google.maps.geometry.spherical.computeDistanceBetween(s,r),c={_id:"google_"+e.place_id,bname:e.name,address1:o,city:t,state:i,zip:a,formattedAddress:e.formatted_address,type:mapGooglePlaceTypeToBusinessType(e.types),phone:e.formatted_phone_number||"",isGooglePlace:!0,placeId:e.place_id,lat:e.geometry.location.lat(),lng:e.geometry.location.lng(),distance:l};return createBusinessMarker(c),bounds.extend(r),c}));findChainMatchesForResults(n).then((()=>{n.sort(((e,n)=>e.distance-n.distance)),displaySearchResults(n),bounds&&!bounds.isEmpty()&&safelyFitBounds(map,bounds)}))}else console.log("No places found via Places API:",n),showErrorMessage("No businesses found matching your search criteria.")}))}catch(e){console.error("Error searching places:",e);const n=document.getElementById("map-loading");n&&n.remove(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}catch(e){console.error("Error in searchGooglePlaces:",e),showErrorMessage(`Error searching for businesses: ${e.message}`)}}function createBusinessMarker(e){try{if(!e.lat||!e.lng||isNaN(parseFloat(e.lat))||isNaN(parseFloat(e.lng)))return console.warn(`Invalid coordinates for business: ${e.bname}`),null;const n=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng)),o=e.isGooglePlace?CONFIG.markerColors.nearby:CONFIG.markerColors.primary,t=new google.maps.Marker({position:n,map,title:e.bname,animation:google.maps.Animation.DROP,optimized:!1,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:o,fillOpacity:1,strokeWeight:2,strokeColor:"#FFFFFF",scale:12}});return t.business=e,t.addListener("click",(function(){console.log("Marker clicked for business:",e.bname),showInfoWindow(this)})),markers.push(t),bounds&&bounds.extend(n),t}catch(e){return console.error("Error creating business marker:",e),null}}function applyMapHeightFix(){if(!document.getElementById("map-height-fix")){const e=document.createElement("style");e.id="map-height-fix",e.textContent=mapHeightCSS,document.head.appendChild(e),console.log("Applied map height and info window positioning fixes"),map&&google.maps.event&&setTimeout((()=>{google.maps.event.trigger(map,"resize"),console.log("Triggered map resize event")}),100)}}window.viewBusinessDetails=function(e){console.log("View details for business:",e),alert("This feature is coming soon: View details for "+e)},window.addBusinessToDatabase=async function(e,n=null){console.log("Adding place to database:",e,"Chain ID:",n);try{const o=new google.maps.places.PlacesService(map),t={placeId:e,fields:["name","formatted_address","formatted_phone_number","geometry","address_components"]};o.getDetails(t,(async(e,o)=>{if(o!==google.maps.places.PlacesServiceStatus.OK||!e)return console.error("Error fetching place details:",o),void alert("Sorry, we couldn't retrieve the details for this business. Please try again or add it manually.");console.log("Place details retrieved:",e);const t={};if(e.address_components)for(const n of e.address_components)for(const e of n.types)t[e]=n.short_name;const i={name:e.name||"",address1:(t.street_number||"")+" "+(t.route||""),city:t.locality||"",state:t.administrative_area_level_1||"",zip:t.postal_code||"",phone:e.formatted_phone_number||"",placeId:e.place_id,formattedAddress:e.formatted_address,lat:e.geometry?.location.lat()||0,lng:e.geometry?.location.lng()||0,location:{type:"Point",coordinates:[e.geometry?.location.lng()||0,e.geometry?.location.lat()||0]}};if(n){i.chain_id=n;try{const e=await getChainDetails(n);e&&e.bname&&(i.chain_name=e.bname)}catch(e){console.error("Error getting chain details:",e)}alert("This business will be added as a location of "+(i.chain_name||"the chain")+". Chain-wide incentives already apply to this location.")}sessionStorage.setItem("newBusinessData",JSON.stringify(i)),window.location.href="business-add.html?prefill=true"}))}catch(e){console.error("Error in addBusinessToDatabase:",e),alert("Sorry, we couldn't add this business to the database. Please try again or add it manually.")}};const mapHeightCSS="\n#map {\n    width: 100%;\n    height: 800px !important; /* Increased from 500px */\n    min-height: 800px;\n    border: 1px solid #ccc;\n    border-radius: 4px;\n    margin: 10px 0;\n    position: relative;\n}\n\n#map-container {\n    width: 90%;\n    margin: 20px auto;\n    clear: both;\n}\n\n.map-controls {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 10px;\n    padding: 0 5px;\n}\n\n/* Ensure proper info window positioning */\n.gm-style .gm-style-iw-c {\n    padding: 0 !important;\n    border-radius: 8px !important;\n    box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n    max-width: 330px !important;\n    max-height: 400px !important;\n    overflow: hidden !important;\n    position: relative !important;\n    z-index: 1000 !important;\n    /* Ensure it's positioned correctly relative to the tail */\n    margin-bottom: 15px !important;\n}\n\n.gm-style .gm-style-iw-d {\n    overflow: auto !important;\n    max-height: 350px !important;\n    padding-right: 8px !important;\n}\n\n.gm-style .gm-style-iw {\n    /* Override any problematic positioning */\n    position: relative !important;\n    z-index: 1001 !important;\n}\n\n.gm-style .gm-style-iw-t {\n    position: absolute !important;\n    width: 100% !important;\n    /* Override the inline bottom positioning that's causing the issue */\n    bottom: 0px !important;\n    /* Ensure proper positioning */\n    right: auto !important;\n    left: 50% !important;\n    transform: translateX(-50%) !important;\n    /* Make sure it's properly sized */\n    height: 15px !important;\n}\n\n.gm-style .gm-style-iw-tc {\n    /* This is the tail connector - make sure it's positioned correctly */\n    top: auto !important;\n    bottom: -15px !important;\n    left: 50% !important;\n    right: auto !important;\n    transform: translateX(-50%) !important;\n    width: 24px !important;\n    height: 24px !important;\n}\n";function showBusinessInfoWindow(e){if(!e||!e.business)return void console.error("Invalid marker or missing business data");const n=e.business;console.log("Showing info window for business:",n.bname),infoWindow||(infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1}));const o=!0===n.isGooglePlace,t=!!n.chain_id,i=n.address1?`<p><strong>Address:</strong><br>${n.address1}${n.city?", "+n.city:""}${n.state?", "+n.state:""}${n.zip?" "+n.zip:""}</p>`:"",s=t?`<span style="display:inline-block; background-color:#4285F4; color:white; padding:2px 6px; border-radius:4px; font-size:0.8em; margin-left:5px;">${n.chain_name||"Chain Location"}</span>`:"";let a;a=o?t?`\n                <button style="background-color:#EA4335; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; margin-top:10px;" \n                        onclick="window.addBusinessToDatabase('${n.placeId}', '${n.chain_id}')">\n                    Add to Database\n                </button>\n            `:`\n                <button style="background-color:#EA4335; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; margin-top:10px;" \n                        onclick="window.addBusinessToDatabase('${n.placeId}')">\n                    Add to Patriot Thanks\n                </button>\n            `:`\n            <button style="background-color:#4285F4; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; margin-top:10px;" \n                    onclick="window.viewBusinessDetails('${n._id}')">\n                View Details\n            </button>\n        `;const r=`\n        <div style="max-width:300px; font-family:Arial,sans-serif;">\n            <h3 style="margin-top:0; margin-bottom:8px; font-size:16px;">${n.bname} ${s}</h3>\n            ${i}\n            <div id="incentives-container-${n._id||n.placeId}">\n                <p><em>Loading incentives...</em></p>\n            </div>\n            <div style="text-align:right;">\n                ${a}\n            </div>\n        </div>\n    `;if(infoWindow.setContent(r),infoWindow.open(map,e),o&&t)fetchChainIncentivesForInfoWindow(n.placeId,n.chain_id,!0);else if(o){const e=document.getElementById(`incentives-container-${n._id||n.placeId}`);e&&(e.innerHTML="<p><em>This business is not yet in the Patriot Thanks database.</em></p>")}else fetchBusinessIncentivesForInfoWindow(n._id,!0)}function fetchChainIncentivesForInfoWindow(e,n,o=!1){if(!n)return void console.error("No chain ID provided for fetching incentives");const t=o?`incentives-container-${e}`:`info-window-incentives-${e}`,i=document.getElementById(t);if(!i)return void console.error(`Could not find incentives div for place ${e}`);const s=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${n}`;console.log("Fetching chain incentives from:",s),fetch(s).then((e=>{if(!e.ok)throw new Error(`Failed to fetch chain incentives: ${e.status}`);return e.json()})).then((n=>{if(console.log(`Chain incentives data for place ${e}:`,n),!n.results||0===n.results.length)return void(i.innerHTML="<p><strong>Chain Incentives:</strong> No incentives found</p>");let o='<p><strong>Chain Incentives:</strong></p><ul style="margin:8px 0; padding-left:20px;">';n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),t=e.other_description?` (${e.other_description})`:"",i='<span style="display:inline-block; background-color:#4285F4; color:white; padding:1px 4px; border-radius:4px; font-size:0.7em; margin-left:5px;">Chain-wide</span>';o+=`\n                        <li>\n                            <strong>${n}${t}:</strong> ${e.amount}% ${i}\n                            ${e.information?`<div style="font-size:13px; color:#555; margin-top:2px;">${e.information}</div>`:""}\n                        </li>\n                    `}})),o+="</ul>",o+=`\n                <div style="margin-top:10px; font-style:italic; color:#666; font-size:12px;">\n                    This location matches ${n.chain_info?n.chain_info.bname:"a chain"} in our database.\n                    Chain-wide incentives apply to all locations.\n                </div>\n            `,i.innerHTML=o})).catch((e=>{console.error(`Error fetching chain incentives: ${e}`),i.innerHTML="<p><strong>Chain Incentives:</strong> Error loading incentives</p>"}))}function showInfoWindow(e){if(console.log("showInfoWindow called with marker:",e),!e||!e.business)return void console.error("Invalid marker for info window",e);const n=e.business;console.log("Business data for info window:",n);const o=n.address2?`${n.address1}<br>${n.address2}<br>${n.city}, ${n.state} ${n.zip}`:`${n.address1}<br>${n.city}, ${n.state} ${n.zip}`,t=getBusinessTypeLabel(n.type),i=n.phone?`<p><strong>Phone:</strong> ${n.phone}</p>`:"",s=n.distance?`<p><strong>Distance:</strong> ${(n.distance/1609.34).toFixed(1)} miles</p>`:"",a=!0===n.isGooglePlace;let r;r=a?`\n        <button class="add-business-btn" \n                onclick="window.addBusinessToDatabase('${n.placeId}')">\n            Add to Patriot Thanks\n        </button>`:`\n        <button class="view-details-btn" \n                onclick="window.viewBusinessDetails('${n._id}')">\n            View Details\n        </button>`;const l=`\n    <div class="info-window">\n        <h3>${n.bname}</h3>\n        <p><strong>Address:</strong><br>${o}</p>\n        ${i}\n        ${s}\n        <p><strong>Type:</strong> ${t}</p>\n        <div id="info-window-incentives-${n._id}">\n            <p><strong>Incentives:</strong> <em>${a?"Not in database":"Loading..."}</em></p>\n        </div>\n        ${a?"<p>This business is not yet in the Patriot Thanks database.</p>":""}\n        <div class="info-window-actions">\n            ${r}\n        </div>\n    </div>\n    `;let c;infoWindow||(infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1,pixelOffset:new google.maps.Size(0,-30)})),infoWindow.setContent(l),infoWindow.close();try{if(e.getPosition&&"function"==typeof e.getPosition?c=e.getPosition():e.position?"function"==typeof e.position.lat?c=e.position:"number"==typeof e.position.lat&&(c=new google.maps.LatLng(e.position.lat,e.position.lng)):n.lat&&n.lng&&(c=new google.maps.LatLng(n.lat,n.lng)),!c)throw new Error("Could not determine marker position");map.panTo(c),setTimeout((()=>{try{e.getPosition?infoWindow.open(map,e):(infoWindow.setPosition(c),infoWindow.open(map)),console.log("Info window opened successfully")}catch(e){console.error("Error opening info window:",e),infoWindow.setPosition(c),infoWindow.open(map)}}),200)}catch(e){if(console.error("Error positioning info window:",e),!n.lat||!n.lng)return void alert("Could not display information for this business.");{const e=new google.maps.LatLng(n.lat,n.lng);map.panTo(e),setTimeout((()=>{infoWindow.setPosition(e),infoWindow.open(map)}),200)}}a||fetchBusinessIncentivesForInfoWindow(n._id),google.maps.event.addListener(infoWindow,"domready",(function(){console.log("Info window DOM ready, applying positioning fixes"),fixInfoWindowTailPositioning();const e=document.querySelector(".gm-style-iw");if(e){const n=e.nextElementSibling;n&&(n.style.top="3px",n.style.right="3px",n.style.width="24px",n.style.height="24px",n.style.opacity="0.8");const o=e.querySelector(".gm-style-iw-d");o&&(o.style.overflow="auto",o.style.maxHeight="350px")}}))}function fixInfoWindowTailPositioning(){const e=document.querySelector(".gm-style-iw-t");e?(console.log("Found info window tail element, fixing positioning"),e.style.bottom="0px",e.style.right="auto",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.width="20px",e.style.height="15px",console.log("Applied positioning fixes to tail element")):(console.log("Tail element not found, will retry"),setTimeout((()=>{const e=document.querySelector(".gm-style-iw-t");e&&(e.style.bottom="0px",e.style.right="auto",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.width="20px",e.style.height="15px",console.log("Applied positioning fixes to tail element (retry)"))}),100));const n=document.querySelector(".gm-style-iw-tc");n&&(n.style.top="auto",n.style.bottom="-15px",n.style.left="50%",n.style.right="auto",n.style.transform="translateX(-50%)")}function applyInfoWindowPositioningFixes(){if(!document.getElementById("info-window-position-fix")){const e=document.createElement("style");e.id="info-window-position-fix",e.textContent='\n            /* CRITICAL: Fix for Google Maps InfoWindow tail positioning */\n            .gm-style .gm-style-iw-t {\n                position: absolute !important;\n                width: 20px !important;\n                height: 15px !important;\n                bottom: 0px !important;\n                right: auto !important;\n                left: 50% !important;\n                transform: translateX(-50%) !important;\n            }\n            \n            /* Override inline styles with high specificity */\n            .gm-style div[class="gm-style-iw-t"][style] {\n                bottom: 0px !important;\n                right: auto !important;\n                left: 50% !important;\n                transform: translateX(-50%) !important;\n                width: 20px !important;\n                height: 15px !important;\n            }\n            \n            /* Fix tail connector */\n            .gm-style .gm-style-iw-tc {\n                top: auto !important;\n                bottom: -15px !important;\n                left: 50% !important;\n                right: auto !important;\n                transform: translateX(-50%) !important;\n            }\n            \n            /* Ensure info window container positioning */\n            .gm-style .gm-style-iw-c {\n                margin-bottom: 15px !important;\n                position: relative !important;\n            }\n        ',document.head.appendChild(e),console.log("Applied info window positioning fixes")}}function displayBusinessesOnMap(e){if(!map)return console.log("Map not ready, storing businesses for later display"),void(pendingBusinessesToDisplay=e);console.log("Displaying businesses on map:",e.length),clearMarkers(),bounds=new google.maps.LatLngBounds;let n=0;e.forEach((e=>{try{let o,t;if(console.log("Processing business for map:",e.bname),e.location&&e.location.coordinates&&Array.isArray(e.location.coordinates)&&e.location.coordinates.length>=2)t=e.location.coordinates[0],o=e.location.coordinates[1];else{if(void 0===e.lat||void 0===e.lng)return void console.warn(`Business ${e.bname} missing coordinates`);o=parseFloat(e.lat),t=parseFloat(e.lng)}if(isNaN(o)||isNaN(t))return void console.warn(`Invalid coordinates for ${e.bname}:`,o,t);e.lat=o,e.lng=t,createBusinessMarker(e)&&n++}catch(n){console.error(`Error adding business ${e.bname} to map:`,n)}})),console.log(`Added ${n} valid markers to the map`),setTimeout((()=>{try{n>0&&bounds&&!bounds.isEmpty()?(console.log("Fitting map to bounds of markers"),safelyFitBounds(map,bounds)):window.currentSearchLocation&&(console.log("Centering on search location:",window.currentSearchLocation),map.setCenter(new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng)),map.setZoom(11))}catch(e){console.error("Error updating map view:",e)}}),200)}async function findChainMatchesForResults(e){const n=e.map((e=>findMatchingChainForPlaceResult(e.bname).then((n=>(n&&(console.log(`Found matching chain for place: ${e.bname}`),e.chain_id=n._id,e.chain_name=n.bname,e.isChainLocation=!0),e))).catch((n=>(console.error(`Error matching chain for ${e.bname}:`,n),e)))));return await Promise.all(n),e}async function findMatchingChainForPlaceResult(e){try{if(!e)return console.warn("Empty place name provided for chain matching"),null;console.log("Checking if place matches a chain:",e);const n=getBaseURL();try{const o=await fetch(`${n}/api/business.js?operation=find_matching_chain&place_name=${encodeURIComponent(e)}`);if(404===o.status)return console.log("No matching chains found for",e),findMatchingChainLocally(e);if(!o.ok)return console.error("Error searching for matching chains:",o.status),findMatchingChainLocally(e);const t=await o.json();return t.success&&t.chain?(console.log("Found matching chain for place:",t.chain.bname),t.chain):findMatchingChainLocally(e)}catch(n){return console.error("Error with chain matching API, falling back to local matching:",n),findMatchingChainLocally(e)}}catch(e){return console.error("Error finding matching chain:",e),null}}function mapGooglePlaceTypeToBusinessType(e){return e&&Array.isArray(e)?e.includes("restaurant")||e.includes("meal_takeaway")||e.includes("cafe")||e.includes("bakery")||e.includes("bar")?"REST":e.includes("grocery_or_supermarket")||e.includes("supermarket")?"GROC":e.includes("gas_station")?"FUEL":e.includes("hardware_store")?"HARDW":e.includes("department_store")?"DEPT":e.includes("convenience_store")?"CONV":e.includes("clothing_store")||e.includes("shoe_store")?"CLTH":e.includes("electronics_store")?"ELEC":e.includes("computer_store")?"TECH":e.includes("furniture_store")?"FURN":e.includes("store")?"RETAIL":e.includes("drugstore")||e.includes("pharmacy")?"RX":e.includes("car_dealer")||e.includes("car_repair")||e.includes("car_wash")?"AUTO":e.includes("beauty_salon")||e.includes("hair_care")||e.includes("spa")?"BEAU":e.includes("book_store")||e.includes("library")?"BOOK":e.includes("movie_theater")||e.includes("amusement_park")||e.includes("aquarium")||e.includes("art_gallery")||e.includes("museum")||e.includes("zoo")?"ENTR":e.includes("sporting_goods_store")||e.includes("gym")?"SPRT":e.includes("jewelry_store")?"JEWL":e.includes("home_goods_store")||e.includes("gift_shop")?"GIFT":e.includes("health")||e.includes("doctor")||e.includes("dentist")||e.includes("hospital")?"HEAL":e.includes("point_of_interest")?"SPEC":e.includes("establishment")?"SERV":"OTHER":"OTHER"}function searchNearbyBusinesses(e,n){try{console.log("Searching for nearby businesses near",e.lat(),e.lng());const o=`${getBaseURL()}/api/business.js?operation=search&type=${n}&lat=${e.lat()}&lng=${e.lng()}&radius=25`;fetch(o).then((e=>{if(!e.ok)throw new Error(`Failed to fetch nearby businesses: ${e.status}`);return e.json()})).then((n=>{if(!n.results||0===n.results.length)return void console.log("No additional nearby businesses found in database");console.log(`Found ${n.results.length} potential nearby businesses in database`);const o=markers.map((e=>e.business?._id)).filter((e=>e)),t=n.results.filter((e=>!o.includes(e._id)));console.log(`${t.length} new businesses to add to map from database`),t.forEach((n=>{if(n.isNearby=!0,n.lat&&n.lng){const o=new google.maps.LatLng(n.lat,n.lng),t=google.maps.geometry.spherical.computeDistanceBetween(e,o);t<8e4?(createBusinessMarker(n),bounds&&bounds.extend(o)):console.log(`Skipping distant business: ${n.bname} (${t/1609} miles)`)}})),t.length>0&&bounds&&!bounds.isEmpty()&&safelyFitBounds(map,bounds)})).catch((e=>{console.error("Error searching for nearby businesses in database:",e)}))}catch(e){console.error("Error in searchNearbyBusinesses:",e)}}function showErrorMessage(e,n){const o=n||document.getElementById("search_table");if(o){o.style.display="block";const n=o.querySelector("tbody");n?n.innerHTML=`<tr><td colspan="5" class="text-center error-message">${e}</td></tr>`:o.innerHTML=`<div class="error-message">${e}</div>`,o.scrollIntoView({behavior:"smooth"})}else alert(e)}function addInitialMapMessage(e){const n=document.createElement("div");n.id="initial-map-message",n.innerHTML="Search for businesses to see them on the map",n.style.position="absolute",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.background="white",n.style.padding="10px",n.style.borderRadius="5px",n.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)",n.style.zIndex="1",e.appendChild(n)}function setupResetMapButton(){const e=document.getElementById("reset-map");e&&e.addEventListener("click",(function(){resetMapView()}))}function resetMapView(){if(mapInitialized&&map)try{safelySetCenter(map,CONFIG.defaultCenter,CONFIG.defaultZoom),infoWindow&&infoWindow.close()}catch(e){console.error("Error resetting map view:",e)}else console.error("Cannot reset map view - map not initialized")}async function setupMapClickHandler(){if(map){console.log("Setting up map click handler");try{const{Place:e}=await google.maps.importLibrary("places");map.addListener("click",(async function(n){if(console.log("Map clicked",n),n.placeId){n.stop(),console.log("POI clicked, placeId:",n.placeId);try{const o=markers.find((e=>e.business&&(e.business.placeId===n.placeId||e.business._id==="google_"+n.placeId)));if(o)return console.log("Found existing marker for clicked place"),void showInfoWindow(o);const t=new e({id:n.placeId});await t.fetchFields({fields:["displayName","formattedAddress","location","types","businessStatus","nationalPhoneNumber"]}),console.log("Place details:",t);const i=t.displayName||"";let s=null;try{s=await findMatchingChainForPlaceResult(i)}catch(e){console.error("Error checking for chain match:",e)}const a={_id:"google_"+t.id,bname:i,address1:t.formattedAddress||"",city:"",state:"",zip:"",isGooglePlace:!0,placeId:t.id,lat:t.location?.lat||0,lng:t.location?.lng||0};s&&(console.log(`POI "${i}" matches chain: ${s.bname}`),a.chain_id=s._id,a.chain_name=s.bname,a.isChainLocation=!0),t.location&&window.currentSearchLocation&&(a.distance=google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(t.location.lat,t.location.lng),new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng))),showInfoWindow({business:a,position:t.location?new google.maps.LatLng(t.location.lat,t.location.lng):n.latLng})}catch(e){console.error("Error fetching place details:",e),alert("Error loading place details. Please try again.")}}})),console.log("Map click handler set up")}catch(e){console.error("Error setting up map click handler:",e)}}else console.error("Map not initialized in setupMapClickHandler")}function setupMarkerClickPriority(){map?(console.log("Setting up marker click priority"),google.maps.event.addListener(map,"click",(function(e){if(e.placeId){const n=e.latLng,o=20,t=map.getProjection();if(!t)return;const i=Math.pow(2,map.getZoom()),s=t.fromLatLngToPoint(n);for(const n of markers){if(!n.position)continue;const a=n.position,r=t.fromLatLngToPoint(a);if(Math.sqrt(Math.pow((s.x-r.x)*i,2)+Math.pow((s.y-r.y)*i,2))<=o)return console.log("Preventing POI click, using our marker instead"),e.stop(),void setTimeout((()=>{showInfoWindow(n)}),10)}}}),{passive:!1})):console.error("Map not initialized, cannot set up click priority")}function initAdditionalMapFeatures(){console.log("Initializing additional map features"),addCustomMarkerStyleFixes(),setupMarkerClickPriority(),customizeInfoWindows()}function addCustomMarkerStyleFixes(){if(!document.getElementById("marker-style-fixes")){const e=document.createElement("style");e.id="marker-style-fixes",e.textContent="\n            /* Ensure proper marker display */\n            .marker-icon {\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                width: 20px;\n                height: 20px;\n                color: #333;\n            }\n            \n            /* Fix for Font Awesome icons */\n            .marker-icon i {\n                font-size: 12px !important;\n                color: #333 !important;\n            }\n            \n            /* Info window styling */\n            .info-window-actions .view-details-btn {\n                margin-top: 8px;\n            }\n        ",document.head.appendChild(e)}}function customizeInfoWindows(){applyInfoWindowScrollableStyles();const e=document.createElement("style");e.textContent="\n        .gm-ui-hover-effect {\n            opacity: 0.8 !important;\n            width: 24px !important;\n            height: 24px !important;\n            right: 2px !important;\n            top: 2px !important;\n        }\n        \n        .gm-ui-hover-effect span {\n            width: 16px !important;\n            height: 16px !important;\n        }\n        \n        .gm-ui-hover-effect:hover {\n            opacity: 1 !important;\n        }\n    ",document.head.appendChild(e)}function applyInfoWindowScrollableStyles(){if(!document.getElementById("info-window-scrollable-styles")){const e=document.createElement("style");e.id="info-window-scrollable-styles",e.textContent="\n            /* Info window structure */\n            .gm-style .gm-style-iw-c {\n                padding: 0 !important;\n                border-radius: 8px !important;\n                box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n                max-width: 330px !important;\n                max-height: 400px !important;\n                overflow: hidden !important;\n            }\n            \n            .gm-style .gm-style-iw-d {\n                overflow: auto !important;\n                max-height: 350px !important;\n                padding-right: 8px !important; /* Allow space for scrollbar */\n            }\n            \n            /* Custom info window styles */\n            .info-window {\n                padding: 12px;\n                max-width: 300px;\n            }\n            \n            .info-window h3 {\n                margin-top: 0;\n                margin-bottom: 10px;\n                color: #212121;\n                font-size: 16px;\n                line-height: 1.3;\n            }\n            \n            .info-window p {\n                margin: 6px 0;\n                font-size: 14px;\n                line-height: 1.4;\n            }\n            \n            .info-window-actions {\n                margin-top: 12px;\n                padding-top: 8px;\n                border-top: 1px solid #eee;\n                text-align: right;\n            }\n            \n            .add-business-btn {\n                background-color: #EA4335;\n                color: white;\n                border: none;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                margin-top: 5px;\n                font-size: 13px;\n                font-weight: 500;\n            }\n            \n            .add-business-btn:hover {\n                background-color: #D32F2F;\n            }\n            \n            .view-details-btn {\n                background-color: #4285F4;\n                color: white;\n                border: none;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                margin-top: 5px;\n                font-size: 13px;\n                font-weight: 500;\n            }\n            \n            .view-details-btn:hover {\n                background-color: #2A75F3;\n            }\n            \n            /* Incentives list */\n            .incentives-list {\n                margin: 8px 0;\n                padding-left: 20px;\n            }\n            \n            .incentives-list li {\n                margin-bottom: 6px;\n            }\n            \n            /* Custom scrollbar styles */\n            .gm-style .gm-style-iw-d::-webkit-scrollbar {\n                width: 6px;\n                height: 6px;\n            }\n            \n            .gm-style .gm-style-iw-d::-webkit-scrollbar-track {\n                background: #f1f1f1;\n                border-radius: 3px;\n            }\n            \n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb {\n                background: #c1c1c1;\n                border-radius: 3px;\n            }\n            \n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb:hover {\n                background: #a8a8a8;\n            }\n            \n            /* Close button adjustment */\n            .gm-ui-hover-effect {\n                top: 2px !important;\n                right: 2px !important;\n            }\n        ",document.head.appendChild(e)}}function fetchBusinessAndCreateMarker(e){console.log("Fetching business data for marker creation:",e);const n=getBaseURL();fetch(`${n}/api/business.js?operation=get&id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to fetch business: ${e.status}`);return e.json()})).then((n=>{if(n.result){console.log("Found business data:",n.result);const o=createBusinessMarker(n.result);o&&(map.setCenter(o.getPosition()),map.setZoom(15),showInfoWindow(o),console.log("Created and focused on new marker for business:",e))}else console.error("Business data not found"),alert("Business information could not be found.");document.getElementById("map").scrollIntoView({behavior:"smooth"})})).catch((e=>{console.error("Error fetching business data:",e),alert("There was an error getting information for this business."),document.getElementById("map").scrollIntoView({behavior:"smooth"})}))}function isNotEmpty(e){return e&&""!==e.trim()}function validateField(e,n){console.log(`Validating ${e.id} with value: ${e.value}`),n(e.value)?(e.classList.remove("invalid-field"),e.classList.add("valid-field"),e.setAttribute("data-valid","true"),console.log(`${e.id} is VALID`)):(e.classList.remove("valid-field"),e.classList.add("invalid-field"),e.setAttribute("data-valid","false"),console.log(`${e.id} is INVALID`))}function displaySearchResults(e){try{const n=document.getElementById("business_search"),o=document.getElementById("search_table");if(!n||!o)return console.error("Required elements not found in the DOM"),void alert("There was an error displaying search results. Please try again later.");let t=n.querySelector("tbody");if(!t)return console.error("Table body not found within business_search table"),void alert("There was an error displaying search results. Please try again later.");t.innerHTML="",Array.isArray(e)||(console.error("businesses is not an array:",e),e=[]),o.style.display="block";const i=o.querySelector("h5");if(i&&(i.style.display="none"),0===e.length)return t.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria.</td></tr>',void o.scrollIntoView({behavior:"smooth"});const s=e.filter((e=>!e.isGooglePlace)),a=e.filter((e=>e.isGooglePlace&&e.chain_id)),r=e.filter((e=>e.isGooglePlace&&!e.chain_id));console.log(`Businesses to display: ${s.length} from database, ${a.length} chain-matched Places, ${r.length} regular Places`),s.forEach((e=>{addBusinessRow(e,t,!1)})),a.forEach((e=>{addBusinessRow(e,t,!0)})),r.forEach((e=>{addBusinessRow(e,t,!0)})),o.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error displaying search results: ",e),alert("There was an error displaying the search results: "+e.message)}}function addBusinessRow(e,n,o){if(!e)return;const t=e.address2?`${e.address1}<br>${e.address2}<br>${e.city}, ${e.state} ${e.zip}`:`${e.address1}<br>${e.city}, ${e.state} ${e.zip}`,i=getBusinessTypeLabel(e.type),s=!!e.chain_id,a=!!e.is_chain,r=!!e.isGooglePlace;let l,c="";a?c='<span class="chain-badge">National Chain</span>':s?c='<span class="chain-badge">Chain Location</span>':o&&e.chain_name&&(c=`<span class="chain-badge">Potential ${e.chain_name||"Chain"} Location</span>`),l=a?checkIfUserIsAdmin()?`<button class="admin-action-btn" onclick="handleChainBusinessAction('${e._id}', true)">Admin: Edit Chain</button>`:`<button class="view-chain-btn" onclick="viewChainDetails('${e._id}')">View Chain Info</button>`:r?s?`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${e.place_data?.place_id||e.placeId||""}', '${e.chain_id||""}')">Add Chain Location</button>`:`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${e.place_data?.place_id||e.placeId||""}')">Add to Database</button>`:`<button class="view-map-btn" onclick="focusOnMapMarker('${e._id}')">View on Map</button>`;const d=document.createElement("tr");d.innerHTML=`\n        <th class="left_table" data-business-id="${e._id}">\n            ${e.bname} ${c}\n        </th>\n        <th class="left_table">${t}</th>\n        <th class="left_table">${i}</th>\n        <th class="right_table" id="incentives-for-${e._id}">\n            ${o&&!s?"Not in database yet":"Loading incentives..."}\n        </th>\n        <th class="center_table">${l}</th>\n    `,n.appendChild(d),o&&s?fetchChainIncentivesForPlacesResult(e._id,e.chain_id):r||fetchBusinessIncentives(e._id,e.chain_id)}function fetchBusinessIncentives(e,n=null){if(!e)return void console.error("No business ID provided for fetching incentives");let o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${e}`;n&&(o+=`&chain_id=${n}`),console.log("Fetching incentives from: ",o),fetch(o).then((e=>{if(!e.ok)throw new Error(`Failed to fetch incentives: ${e.status} ${e.statusText}`);return e.json()})).then((n=>{console.log(`Incentives data for business ${e}:`,n);const o=document.getElementById(`incentives-for-${e}`);if(!o)return void console.error(`Could not find cell for incentives-for-${e}`);if(!n.results||0===n.results.length)return void(o.innerHTML="No incentives found");let t="";n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"",i=e.is_chain_wide?'<span class="chain-badge small">Chain-wide</span>':"";t+=`\n                        <div class="incentive-item">\n                            <strong>${n}${o}:</strong> ${e.amount}% ${i}\n                            <div class="incentive-info">${e.information||""}</div>\n                        </div>\n                    `}})),o.innerHTML=""===t?"No active incentives found":t})).catch((n=>{console.error(`Error fetching incentives for business ${e}:`,n);const o=document.getElementById(`incentives-for-${e}`);o&&(o.innerHTML="Error loading incentives")}))}function fetchChainIncentivesForPlacesResult(e,n){if(!e||!n)return void console.error("Missing place ID or chain ID for fetching chain incentives");const o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${n}`;console.log("Fetching chain incentives for Places result: ",o),fetch(o).then((e=>{if(!e.ok)throw new Error(`Failed to fetch chain incentives: ${e.status}`);return e.json()})).then((n=>{console.log(`Chain incentives data for place ${e}:`,n);const o=document.getElementById(`incentives-for-${e}`);if(!o)return void console.error(`Could not find cell for incentives-for-${e}`);if(!n.results||0===n.results.length)return void(o.innerHTML="No chain incentives available");let t="";n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"";t+=`\n                        <div class="incentive-item">\n                            <strong>${n}${o}:</strong> ${e.amount}% \n                            <span class="chain-badge small">Chain-wide</span>\n                            <div class="incentive-info">${e.information||""}</div>\n                        </div>\n                    `}})),o.innerHTML=""===t?"Not in database yet":t})).catch((n=>{console.error(`Error fetching chain incentives for place ${e}:`,n);const o=document.getElementById(`incentives-for-${e}`);o&&(o.innerHTML="Not in database yet")}))}function checkIfUserIsAdmin(){try{const e=localStorage.getItem("patriotThanksSession");if(!e)return!1;const n=JSON.parse(e);return n.user&&(!0===n.user.isAdmin||"Admin"===n.user.level)}catch(e){return console.error("Error checking admin status:",e),!1}}function fetchBusinessIncentivesForInfoWindow(e,n=!1){if(!e)return void console.error("No business ID provided for fetching incentives");if(e.startsWith("google_")){const o=n?`incentives-container-${e}`:`info-window-incentives-${e}`,t=document.getElementById(o);return void(t&&(t.innerHTML="<p><strong>Incentives:</strong> Not in database</p>"))}const o=n?`incentives-container-${e}`:`info-window-incentives-${e}`,t=document.getElementById(o);if(!t)return void console.error(`Could not find incentives div for business ${e}`);const i=getBaseURL();fetch(`${i}/api/combined-api.js?operation=incentives&business_id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to fetch incentives: ${e.status}`);return e.json()})).then((e=>{if(!e.results||0===e.results.length)return void(t.innerHTML="<p><strong>Incentives:</strong> No incentives found</p>");let n='<p><strong>Incentives:</strong></p><ul style="margin:8px 0; padding-left:20px;">';e.results.forEach((e=>{if(e.is_available){const o=getIncentiveTypeLabel(e.type),t=e.other_description?` (${e.other_description})`:"",i=e.is_chain_wide?'<span style="display:inline-block; background-color:#4285F4; color:white; padding:1px 4px; border-radius:4px; font-size:0.7em; margin-left:5px;">Chain-wide</span>':"";n+=`\n                        <li>\n                            <strong>${o}${t}:</strong> ${e.amount}% ${i}\n                            ${e.information?`<div style="font-size:13px; color:#555; margin-top:2px;">${e.information}</div>`:""}\n                        </li>\n                    `}})),n+="</ul>",t.innerHTML='<p><strong>Incentives:</strong></p><ul style="margin:8px 0; padding-left:20px;"></ul>'===n?"<p><strong>Incentives:</strong> No active incentives found</p>":n})).catch((e=>{console.error(`Error fetching incentives for info window: ${e}`),t.innerHTML="<p><strong>Incentives:</strong> Error loading incentives</p>"}))}window.initGoogleMap=function(){console.log("Enhanced initGoogleMap function called");try{applyMapHeightFix();const e=document.getElementById("map");if(!e)return void console.error("Map container not found in the DOM");console.log("Map container dimensions:",e.offsetWidth,"x",e.offsetHeight),map?(console.log("Map already exists, applying height fix and triggering resize"),applyMapHeightFix(),setTimeout((()=>{google.maps.event.trigger(map,"resize")}),100)):(map=new google.maps.Map(e,{center:CONFIG.defaultCenter,zoom:CONFIG.defaultZoom,mapId:CONFIG.mapId||"ebe8ec43a7bc252d",clickableIcons:!0,gestureHandling:"greedy",zoomControl:!0,mapTypeControl:!1,scaleControl:!0,streetViewControl:!1,rotateControl:!1,fullscreenControl:!0}),console.log("Map object created with enhanced settings:",!!map),infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1,pixelOffset:new google.maps.Size(0,-10)}),bounds=new google.maps.LatLngBounds,addInitialMapMessage(e),setupResetMapButton(),mapInitialized=!0,console.log("Google Map successfully initialized with enhanced settings"),pendingBusinessesToDisplay.length>0&&(console.log("Processing pending businesses to display on map"),displayBusinessesOnMap(pendingBusinessesToDisplay),pendingBusinessesToDisplay=[]),setupMapClickHandler(),setupMarkerClickPriority(),initAdditionalMapFeatures(),setTimeout((()=>{google.maps.event.trigger(map,"resize")}),200))}catch(e){console.error("Error initializing Google Map:",e),mapInitialized=!1;const n=document.getElementById("map");n&&(n.innerHTML=`\n                <div style="text-align: center; padding: 20px;">\n                    <p>Sorry, we couldn't load the map. Please try refreshing the page.</p>\n                    <p>Error: ${e.message}</p>\n                </div>\n            `)}},window.focusOnMapMarker=function(e){if(console.log("focusOnMapMarker called for business ID:",e),!mapInitialized||!map)return console.error("Map not initialized yet - cannot focus on marker"),void alert("Map is still loading. Please try again in a moment.");if(!markers||0===markers.length)return console.warn("No markers available yet."),void fetchBusinessAndCreateMarker(e);const n=markers.find((n=>n.business&&n.business._id===e));if(n)try{let o;if(n.getPosition&&"function"==typeof n.getPosition)o=n.getPosition();else if(n.position)o=n.position;else{if(!(n.business&&n.business.lat&&n.business.lng))return console.error("Could not determine marker position"),void alert("Could not focus on this business on the map.");o=new google.maps.LatLng(parseFloat(n.business.lat),parseFloat(n.business.lng))}map.setCenter(o),map.setZoom(16),showInfoWindow(n),document.getElementById("map").scrollIntoView({behavior:"smooth"}),console.log("Successfully focused on marker for business:",e)}catch(e){console.error("Error focusing on marker:",e),alert("There was an error focusing on this business on the map.")}else console.warn(`No marker found for business ID: ${e}`),fetchBusinessAndCreateMarker(e)},document.addEventListener("DOMContentLoaded",(function(){console.log("DOM loaded, initializing business search..."),applyInfoWindowPositioningFixes(),applyMapHeightFix(),addCustomMarkerStyles(),addChainBadgeStyles(),initBusinessSearch(),checkForNewlyAddedBusiness(),window.google&&window.google.maps?(console.log("Google Maps already loaded, initializing map"),initGoogleMap()):console.log("Google Maps not yet loaded, will be initialized via callback")})),"undefined"!=typeof window&&(window.retrieveFromMongoDB=retrieveFromMongoDB,window.displaySearchResults=displaySearchResults,window.displayBusinessesOnMap=displayBusinessesOnMap,window.initGoogleMap=initGoogleMap,window.debugMapState=debugMapState,window.validateField=validateField,window.isNotEmpty=isNotEmpty);