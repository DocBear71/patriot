const CONFIG={mapId:"ebe8ec43a7bc252d",defaultCenter:{lat:39.8283,lng:-98.5795},defaultZoom:4,markerColors:{primary:"#EA4335",nearby:"#4285F4",database:"#28a745",chain:"#FF9800"},geocodeDelay:200,imageLoadDelay:1e3,maxNearbyDistance:2e4,debugMode:!1};let map=null,mapInitialized=!1,markers=[],infoWindow=null,bounds=null,pendingBusinessesToDisplay=[],currentSearchLocation=null;const placeCache=new Map,chainMatchCache=new Map,apiCallQueue=[];let isProcessingQueue=!1,googleMapsInitializing=!1,googleMapsInitialized=!1;function clearMarkers(){markers?(markers.forEach((e=>{e&&(e.map=null)})),markers=[]):markers=[]}function isValidPosition(e){if(!e)return!1;let n,o;if(e instanceof google.maps.LatLng)try{n=e.lat(),o=e.lng()}catch(e){return!1}else if("function"==typeof e.lat&&"function"==typeof e.lng)try{n=e.lat(),o=e.lng()}catch(e){return!1}else{if(void 0===e.lat||void 0===e.lng)return!1;n=parseFloat(e.lat),o=parseFloat(e.lng)}return!isNaN(n)&&!isNaN(o)&&isFinite(n)&&isFinite(o)&&Math.abs(n)<=90&&Math.abs(o)<=180}function createSafeLatLng(e){if(!e)return null;try{if(e instanceof google.maps.LatLng)return isValidPosition(e)?e:null;let n,o;if("function"==typeof e.lat&&"function"==typeof e.lng)n=e.lat(),o=e.lng();else if(void 0!==e.lat&&void 0!==e.lng)n=parseFloat(e.lat),o=parseFloat(e.lng);else{if(!(Array.isArray(e)&&e.length>=2))return null;n=parseFloat(e[0]),o=parseFloat(e[1])}return isNaN(n)||isNaN(o)||!isFinite(n)||!isFinite(o)||Math.abs(n)>90||Math.abs(o)>180?null:new google.maps.LatLng(n,o)}catch(e){return console.error("Error creating LatLng:",e),null}}function safelyFitBounds(e,n,o=11){if(!e||!n)return!1;try{const o=n.getNorthEast(),t=n.getSouthWest();return!(!o||!t||isNaN(o.lat())||isNaN(o.lng())||isNaN(t.lat())||isNaN(t.lng())||n.isEmpty()||(e.fitBounds(n),google.maps.event.addListenerOnce(e,"bounds_changed",(function(){const n=e.getZoom();n>16?e.setZoom(16):n<4&&e.setZoom(4)})),0))}catch(n){console.error("Error fitting bounds:",n);try{void 0!==o&&e.setZoom(o)}catch(e){console.error("Error setting fallback zoom:",e)}return!1}}function debugMapState(){if(console.log("==== MAP DEBUGGING INFO ===="),console.log("Map initialized:",mapInitialized),console.log("Map object exists:",!!map),map)try{const e=map.getCenter();console.log("Map center:",e?`${e.lat()}, ${e.lng()}`:"undefined"),console.log("Map zoom:",map.getZoom()),console.log("Map type:",map.getMapTypeId()),console.log("Map ID:",map.getMapId())}catch(e){console.error("Error getting map properties:",e)}if(console.log("Markers count:",markers?markers.length:0),markers&&markers.length>0&&(console.log("Markers summary:"),markers.forEach(((e,n)=>{try{let o;e.getPosition?o=e.getPosition():e.position&&(o=e.position);const t=o?"function"==typeof o.lat?`${o.lat()}, ${o.lng()}`:`${o.lat}, ${o.lng}`:"unknown";console.log(`  Marker #${n}: Business: ${e.business?e.business.bname:"unknown"}, Position: ${t}`)}catch(e){console.error(`  Error getting marker #${n} info:`,e)}}))),console.log("Bounds:",bounds?"exists":"not created"),bounds)try{const e=bounds.getNorthEast(),n=bounds.getSouthWest();if(console.log("  NE:",e?`${e.lat()}, ${e.lng()}`:"undefined"),console.log("  SW:",n?`${n.lat()}, ${n.lng()}`:"undefined"),console.log("  Empty:",bounds.isEmpty()),e&&n){const o=isNaN(e.lat())||isNaN(e.lng())||isNaN(n.lat())||isNaN(n.lng());console.log("  Has NaN coordinates:",o)}}catch(e){console.error("  Error getting bounds info:",e)}console.log("Map container:",document.getElementById("map")?"found":"not found");const e=document.getElementById("map");e&&(console.log("  Display:",window.getComputedStyle(e).display),console.log("  Dimensions:",`${e.offsetWidth} Ã— ${e.offsetHeight}`),console.log("  Position:",e.style.position),console.log("  Visibility:",window.getComputedStyle(e).visibility),console.log("  Z-index:",window.getComputedStyle(e).zIndex)),console.log("Google Maps libraries:"),console.log("  maps:",!!google.maps),console.log("  places:",!!google.maps.places),console.log("  geometry:",!!google.maps.geometry),console.log("  marker:",!!google.maps.marker),console.log("Google Maps API Key:",getGoogleMapsApiKey()?"found":"not found"),console.log("Current search location:",currentSearchLocation?`${currentSearchLocation.lat}, ${currentSearchLocation.lng}`:"none"),console.log("==== END DEBUGGING INFO ====")}function safelySetCenter(e,n,o){if(!e)return!1;try{const t=createSafeLatLng(n);return!!t&&(e.setCenter(t),void 0!==o&&e.setZoom(o),!0)}catch(e){return console.error("Error setting map center:",e),!1}}function ensureGoogleMapsInitialized(){return googleMapsInitialized||googleMapsInitializing?(console.log("Google Maps already initialized or initializing"),Promise.resolve()):new Promise(((e,n)=>{try{if(googleMapsInitializing=!0,console.log("Starting Google Maps initialization"),window.google&&window.google.maps)return console.log("Google Maps API is already loaded, just initializing map"),initGoogleMap(),googleMapsInitialized=!0,googleMapsInitializing=!1,void e();const o=window.appConfig?.googleMapsApiKey||getGoogleMapsApiKey(),t=window.appConfig?.googleMapsMapId||CONFIG.mapId;window.initGoogleMapCallback=function(){console.log("Google Maps callback executed"),initGoogleMap(),googleMapsInitialized=!0,googleMapsInitializing=!1,e()};const i=document.createElement("script");i.src=`https://maps.googleapis.com/maps/api/js?key=${o}&map_ids=${t}&libraries=places,geometry,marker&callback=initGoogleMapCallback&loading=async&v=weekly`,i.async=!0,i.defer=!0,i.onerror=function(e){console.error("Google Maps API failed to load:",e),googleMapsInitializing=!1,n(e)},document.head.appendChild(i)}catch(e){googleMapsInitializing=!1,console.error("Error initializing Google Maps:",e),n(e)}}))}function addCustomMarkerStyles(){if(!document.getElementById("custom-marker-css")){const e=document.createElement("style");e.id="custom-marker-css",e.textContent='\n            .custom-marker {\n                cursor: pointer;\n            }\n            \n            .marker-container {\n                position: relative;\n                width: 32px;\n                height: 40px;\n            }\n            \n            .marker-pin {\n                width: 32px;\n                height: 40px;\n                border-radius: 50% 50% 50% 0;\n                background-color: #EA4335;\n                transform: rotate(-45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n                position: absolute;\n                top: 0;\n                left: 0;\n            }\n            \n            .marker-pin.nearby {\n                background-color: #4285F4;\n            }\n            \n            .marker-icon {\n                transform: rotate(45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                width: 20px;\n                height: 20px;\n            }\n            \n            /* Critical fix - ensure Font Awesome icons are visible */\n            .marker-icon i.fas,\n            .marker-icon i.fa,\n            .marker-icon i.far,\n            .marker-icon i.fab {\n                display: inline-block !important;\n                font-size: 14px !important;\n                color: white !important;\n                line-height: 1 !important;\n                width: auto !important;\n                height: auto !important;\n                vertical-align: middle !important;\n            }\n            \n            /* Fallback icon content for missing Font Awesome */\n            .marker-icon i.fas.fa-store-alt:after {\n                content: "ðŸª";\n                font-family: sans-serif;\n                font-size: 14px;\n            }\n            \n            .marker-icon i.fas.fa-shopping-cart:after {\n                content: "ðŸ›’";\n                font-family: sans-serif;\n                font-size: 14px;\n            }\n            \n            .marker-shadow {\n                background-color: rgba(0, 0, 0, 0.2);\n                border-radius: 50%;\n                height: 14px;\n                width: 14px;\n                position: absolute;\n                bottom: -3px;\n                left: 9px;\n                filter: blur(2px);\n                z-index: -1;\n            }\n            \n            /* Info window action button styling */\n            .info-window-actions {\n                margin-top: 12px;\n                padding-top: 8px;\n                border-top: 1px solid #eee;\n                text-align: right;\n            }\n            \n            .info-window-actions .add-business-btn,\n            .info-window-actions .view-details-btn {\n                margin-top: 8px;\n                font-weight: bold;\n                text-transform: uppercase;\n                font-size: 12px;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                transition: background-color 0.2s ease;\n                border: none;\n                color: white;\n                letter-spacing: 0.5px;\n                display: inline-block;\n            }\n            \n            .info-window-actions .add-business-btn {\n                background-color: #EA4335;\n            }\n            \n            .info-window-actions .add-business-btn:hover {\n                background-color: #D32F2F;\n            }\n            \n            .info-window-actions .view-details-btn {\n                background-color: #4285F4;\n            }\n            \n            .info-window-actions .view-details-btn:hover {\n                background-color: #2A75F3;\n            }\n        ',document.head.appendChild(e)}}function addChainBadgeStyles(){if(!document.getElementById("chain-badge-css")){const e=document.createElement("style");e.id="chain-badge-css",e.textContent="\n            .chain-badge {\n                display: inline-block;\n                background-color: #4285F4;\n                color: white;\n                padding: 2px 6px;\n                border-radius: 4px;\n                font-size: 0.8em;\n                margin-left: 5px;\n                font-weight: normal;\n            }\n\n            .chain-badge.small {\n                font-size: 0.7em;\n                padding: 1px 4px;\n            }\n            \n            .admin-action-btn {\n                background-color: #673AB7;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .view-chain-btn {\n                background-color: #2196F3;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .add-to-db-btn {\n                background-color: #4CAF50;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .view-map-btn {\n                background-color: #FF9800;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n        ",document.head.appendChild(e)}}function getUserLocation(){return new Promise(((e,n)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition((n=>{const o={lat:n.coords.latitude,lng:n.coords.longitude};e(o)}),(e=>n(e)),{enableHighAccuracy:!0,timeout:5e3,maximumAge:0}):n(new Error("Geolocation not supported"))}))}function getBaseURL(){return"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:window.location.origin}async function getChainDetails(e){if(!e)return null;const n=getBaseURL();try{const o=await fetch(`${n}/api/business.js?operation=get&id=${e}`);if(!o.ok)throw new Error(`Failed to get chain details: ${o.status}`);const t=await o.json();return t.result?t.result:null}catch(e){return console.error("Error getting chain details:",e),null}}function getBusinessTypeLabel(e){return{AUTO:"Automotive",BEAU:"Beauty",BOOK:"Bookstore",CLTH:"Clothing",CONV:"Convenience Store/Gas Station",DEPT:"Department Store",ELEC:"Electronics",ENTR:"Entertainment",FURN:"Furniture",FUEL:"Fuel Station/Truck Stop",GIFT:"Gift Shop",GROC:"Grocery",HARDW:"Hardware",HEAL:"Health",JEWL:"Jewelry",OTHER:"Other",RX:"Pharmacy",REST:"Restaurant",RETAIL:"Retail",SERV:"Service",SPEC:"Specialty",SPRT:"Sporting Goods",TECH:"Technology",TOYS:"Toys"}[e]||e}function getIncentiveTypeLabel(e){return{VT:"Veteran",AD:"Active Duty",FR:"First Responder",SP:"Spouse",OT:"Other"}[e]||e}function initBusinessSearch(){console.log("Business search initialization...");const e={businessName:document.getElementById("business-name"),address:document.getElementById("address"),useMyLocation:document.getElementById("use-my-location")},n=document.getElementById("business-search-form");n?n.addEventListener("submit",(async function(n){if(n.preventDefault(),!e.businessName?.value&&!e.address?.value&&!e.useMyLocation?.checked)return void alert("Please enter either a business name, an address, or use your current location to search");const o={businessName:e.businessName?.value||"",address:e.address?.value||"",useMyLocation:e.useMyLocation?.checked||!1};if(console.log("Form data to submit:",o),mapInitialized){clearMarkers();const e=document.getElementById("initial-map-message");e&&e.remove(),await performEnhancedBusinessSearch(o,!1)}else console.warn("Map not initialized yet. Will initialize and display businesses after map loads."),ensureGoogleMapsInitialized().then((async()=>{clearMarkers(),await performEnhancedBusinessSearch(o,!1)})).catch((e=>{console.error("Failed to initialize Google Maps:",e),alert("There was a problem loading the map. Please try refreshing the page.")}))})):console.warn("Business search form not found in the DOM"),e.businessName&&e.businessName.addEventListener("input",(function(){validateField(this,isNotEmpty)})),e.address&&e.address.addEventListener("input",(function(){validateField(this,isNotEmpty)})),e.useMyLocation&&e.useMyLocation.addEventListener("change",(function(){const n=document.getElementById("location-status");this.checked?(e.address&&(e.address.disabled=!0,e.address.placeholder="Using your current location..."),n&&(n.textContent="Location will be used when you search",n.style.display="block",n.style.color="#666")):(e.address&&(e.address.disabled=!1,e.address.placeholder="Address, City, State, or Zip"),n&&(n.style.display="none"))})),addRefreshButton(),checkForNewlyAddedBusiness()}function addRefreshButton(){const e=document.getElementById("business-search-form");if(!e)return;if(document.getElementById("refresh-search-btn"))return;const n=document.createElement("button");n.id="refresh-search-btn",n.type="button",n.className="refresh-btn",n.innerHTML='<i class="fas fa-sync-alt"></i> Refresh Results',n.style.marginLeft="10px",n.style.backgroundColor="#28a745",n.style.color="white",n.style.border="none",n.style.borderRadius="4px",n.style.padding="8px 12px",n.style.cursor="pointer",n.addEventListener("click",(async function(){const e={businessName:document.getElementById("business-name")?.value||"",address:document.getElementById("address")?.value||"",useMyLocation:document.getElementById("use-my-location")?.checked||!1};clearMarkers();const n=document.getElementById("initial-map-message");n&&n.remove(),this.innerHTML='<i class="fas fa-sync-alt fa-spin"></i> Refreshing...',await performEnhancedBusinessSearch(e,!1),setTimeout((()=>{this.innerHTML='<i class="fas fa-sync-alt"></i> Refresh Results'}),1e3)}));const o=e.querySelector('input[type="submit"]');o&&o.parentNode?o.parentNode.insertBefore(n,o.nextSibling):e.appendChild(n)}function checkForNewlyAddedBusiness(){const e=new URLSearchParams(window.location.search),n=e.get("business_added"),o=e.get("business_name"),t=e.get("business_id");if("true"===n&&o){showBusinessAddedSuccessMessage(o,t);const e=window.location.pathname;window.history.replaceState({},document.title,e);const n=document.getElementById("business-name"),i=document.getElementById("address");n&&(n.value=o,validateField(n,isNotEmpty)),i&&(i.value=""),setTimeout((()=>{const e=document.getElementById("business-search-form");if(e){const n=new Event("submit",{cancelable:!0});e.dispatchEvent(n)}}),1e3)}}async function searchGooglePlacesForBusiness(e,n){try{console.log("Searching Google Places (new API) for:",e,"near",n);const{Place:o,SearchNearbyRequest:t}=await google.maps.importLibrary("places"),i=new google.maps.LatLng(n.lat,n.lng),s={textQuery:e,locationBias:{center:i,radius:4e4},maxResultCount:20,fields:["id","displayName","formattedAddress","location","types","nationalPhoneNumber","internationalPhoneNumber"]};console.log("New Places API request:",s);const{places:a}=await o.searchByText(s);if(!a||0===a.length)return console.log("No businesses found via new Places API"),[];console.log("Found businesses via new Places API:",a.length);const r=a.filter((n=>{const o=n.displayName.toLowerCase();return o.includes("pro desk")||o.includes("garden center")||o.includes("rental center")||o.includes("tool rental")||o.includes("customer service")?(console.log("Filtering out department:",n.displayName),!1):!(o.includes(" - ")&&!o.toLowerCase().startsWith(e.toLowerCase())&&(console.log("Filtering out formatted result:",n.displayName),1))}));console.log(`Filtered to ${r.length} main store results`);const l=r.map((async e=>{const o=e.formattedAddress?e.formattedAddress.split(","):[];let t="",s="",a="",r="";if(o.length>=1&&(t=o[0].trim()),o.length>=2&&(s=o[1].trim()),o.length>=3){const e=o[2].trim().match(/^([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/);e&&(a=e[1],r=e[2])}const l=e.location,c=google.maps.geometry.spherical.computeDistanceBetween(i,l);let d=0,g=0;if(e.location)try{d="function"==typeof e.location.lat?e.location.lat():e.location.lat||0,g="function"==typeof e.location.lng?e.location.lng():e.location.lng||0}catch(e){console.warn("Error extracting coordinates from new Places API:",e),d=n.lat,g=n.lng}const p={_id:"google_"+e.id,bname:e.displayName,address1:t,city:s,state:a,zip:r,formattedAddress:e.formattedAddress,type:mapGooglePlaceTypeToBusinessType(e.types),phone:e.nationalPhoneNumber||e.internationalPhoneNumber||"",isGooglePlace:!0,placeId:e.id,lat:d,lng:g,distance:c};try{const n=await findMatchingChainForPlaceResult(e.displayName);n?(console.log(`Found chain match for "${e.displayName}": ${n.bname}`),p.chain_id=n._id,p.chain_name=n.bname,p.isChainLocation=!0):console.log(`No chain match found for: ${e.displayName}`)}catch(e){console.warn("Error checking for chain match:",e)}return p})),c=await Promise.all(l);return c.sort(((e,n)=>e.distance-n.distance)),console.log("Final processed businesses with new API:",c.map((e=>({name:e.bname,placeId:e.placeId,isChain:!!e.chain_id,chainName:e.chain_name})))),c}catch(o){return console.error("Error in new Places API search:",o),console.warn("Falling back to deprecated PlacesService API"),await searchGooglePlacesForBusinessLegacy(e,n)}}async function searchGooglePlacesForBusinessLegacy(e,n){return new Promise(((o,t)=>{try{if(console.log("Using legacy PlacesService as fallback"),!map)return void t(new Error("Map not initialized"));const i=new google.maps.LatLng(n.lat,n.lng),s=new google.maps.places.PlacesService(map),a={query:e,location:i,radius:4e4};s.textSearch(a,(async(e,n)=>{if(n===google.maps.places.PlacesServiceStatus.OK&&e&&e.length>0){const n=e.filter((e=>{const n=e.name.toLowerCase();return!n.includes("pro desk")&&!n.includes("garden center")&&!n.includes("rental center")})),t=await Promise.all(n.map((async e=>{const n={_id:"google_"+e.place_id,bname:e.name,isGooglePlace:!0,placeId:e.place_id,lat:e.geometry.location.lat(),lng:e.geometry.location.lng()},o=await findMatchingChainForPlaceResult(e.name);return o&&(n.chain_id=o._id,n.chain_name=o.bname,n.isChainLocation=!0),n})));o(t)}else console.log("Legacy API also found no results"),o([])}))}catch(e){t(e)}}))}function displayBusinessesOnMap(e){if(!map)return console.log("Map not ready, storing businesses for later display"),void(pendingBusinessesToDisplay=e);console.log("Displaying businesses on map:",e.length),clearMarkers(),bounds=new google.maps.LatLngBounds;let n=0,o=0,t=0;e.forEach((e=>{try{if(console.log("Processing business for map:",e.bname),!0===e.is_chain)return console.log(`Skipping parent chain business: ${e.bname} (no physical location)`),void t++;let i,s;if(e.location&&e.location.coordinates&&Array.isArray(e.location.coordinates)&&e.location.coordinates.length>=2)s=e.location.coordinates[0],i=e.location.coordinates[1];else{if(void 0===e.lat||void 0===e.lng)return console.warn(`Business ${e.bname} missing coordinates`),void t++;i=parseFloat(e.lat),s=parseFloat(e.lng)}if(isNaN(i)||isNaN(s)||0===i||0===s)return console.warn(`Invalid coordinates for ${e.bname}: lat=${i}, lng=${s}`),void t++;if(Math.abs(i)>90||Math.abs(s)>180)return console.warn(`Coordinates out of range for ${e.bname}: lat=${i}, lng=${s}`),void t++;if(e.lat=i,e.lng=s,createBusinessMarker(e)){if(n++,window.currentSearchLocation){const n=new google.maps.LatLng(i,s),t=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng),a=google.maps.geometry.spherical.computeDistanceBetween(n,t);a<=80467?(o++,console.log(`${e.bname} is ${(621371e-9*a).toFixed(1)} miles from search location`)):console.log(`${e.bname} is ${(621371e-9*a).toFixed(1)} miles from search location (distant)`)}const t=new google.maps.LatLng(i,s);bounds.extend(t)}}catch(n){console.error(`Error adding business ${e.bname} to map:`,n),t++}})),console.log(`Added ${n} valid markers to the map (${o} nearby, ${t} skipped)`),setTimeout((()=>{try{if(window.currentSearchLocation&&o>0){console.log("Centering map on search location with nearby businesses");const e=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng);map.setCenter(e),map.setZoom(12)}else if(window.currentSearchLocation&&n>0){console.log("Centering map on search location (distant businesses only)");const e=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng);map.setCenter(e),map.setZoom(10)}else n>0&&bounds&&!bounds.isEmpty()?(console.log("No search location, fitting map to business bounds"),safelyFitBounds(map,bounds)):(console.log("Using default map center (no valid businesses to display)"),map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom))}catch(e){console.error("Error updating map view:",e)}}),200)}async function geocodeAddressClientSide(e){return new Promise(((n,o)=>{try{if(console.log(`Geocoding address client-side: ${e}`),!e)return console.error("No address provided for geocoding"),void o(new Error("No address provided"));if(!window.google||!window.google.maps)return void o(new Error("Google Maps API not loaded"));(new google.maps.Geocoder).geocode({address:e},(function(e,t){if(t===google.maps.GeocoderStatus.OK&&e&&e.length>0){const o=e[0].geometry.location,t={lat:o.lat(),lng:o.lng(),formattedAddress:e[0].formatted_address};console.log("Client-side geocoding result:",t),n(t)}else console.error("Client-side geocoding failed:",t),o(new Error(`Geocoding failed: ${t}`))}))}catch(e){console.error("Error in client-side geocoding:",e),o(e)}}))}function applyMapHeightFix(){if(!document.getElementById("map-height-fix")){const e=document.createElement("style");e.id="map-height-fix",e.textContent=mapHeightCSS,document.head.appendChild(e),console.log("Applied map height and info window positioning fixes"),map&&google.maps.event&&setTimeout((()=>{google.maps.event.trigger(map,"resize"),console.log("Triggered map resize event")}),100)}}window.viewBusinessDetails=function(e){console.log("View details for business:",e),alert("This feature is coming soon: View details for "+e)},window.addBusinessToDatabase=async function(e,n=null){console.log("Adding place to database:",e,"Chain ID:",n);try{const{Place:o}=await google.maps.importLibrary("places"),t=new o({id:e});await t.fetchFields({fields:["displayName","formattedAddress","addressComponents","location","nationalPhoneNumber","internationalPhoneNumber"]}),console.log("Place details retrieved with new API:",t);const i={};if(t.addressComponents)for(const e of t.addressComponents)for(const n of e.types)i[n]=e.shortText||e.longText;const s={name:t.displayName||"",address1:(i.street_number||"")+" "+(i.route||""),city:i.locality||"",state:i.administrative_area_level_1||"",zip:i.postal_code||"",phone:t.nationalPhoneNumber||t.internationalPhoneNumber||"",placeId:t.id,formattedAddress:t.formattedAddress,lat:t.location?.lat()||0,lng:t.location?.lng()||0,location:{type:"Point",coordinates:[t.location?.lng()||0,t.location?.lat()||0]}};let a="",r="";if(n)try{const e=await getChainDetails(n);e&&e.bname?(s.chain_name=e.bname,r=`This business will be added as a location of ${e.bname}. Chain-wide incentives already apply to this location.`):r="This business will be added as a chain location. Chain-wide incentives may apply."}catch(e){console.error("Error getting chain details:",e),r="This business will be added as a chain location."}a=`\n${r?r+"\n\n":""}You will now be redirected to the "Add Business" page where the form will be pre-filled with this business information.\n\nAfter you complete adding the business, you will be returned to this search page.\n\nClick OK to continue.`,confirm(a)&&(sessionStorage.setItem("newBusinessData",JSON.stringify(s)),sessionStorage.setItem("returnToSearch",window.location.href),window.location.href="business-add.html?prefill=true")}catch(e){console.error("Error in addBusinessToDatabase:",e),alert("Sorry, we couldn't retrieve the business information. Please try again or add it manually.")}};const mapHeightCSS="\n#map {\n    width: 100%;\n    height: 800px !important; /* Increased from 500px */\n    min-height: 800px;\n    border: 1px solid #ccc;\n    border-radius: 4px;\n    margin: 10px 0;\n    position: relative;\n}\n\n#map-container {\n    width: 90%;\n    margin: 20px auto;\n    clear: both;\n}\n\n.map-controls {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 10px;\n    padding: 0 5px;\n}\n\n/* Ensure proper info window positioning */\n.gm-style .gm-style-iw-c {\n    padding: 0 !important;\n    border-radius: 8px !important;\n    box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n    max-width: 330px !important;\n    max-height: 400px !important;\n    overflow: hidden !important;\n    position: relative !important;\n    z-index: 1000 !important;\n    /* Ensure it's positioned correctly relative to the tail */\n    margin-bottom: 15px !important;\n}\n\n.gm-style .gm-style-iw-d {\n    overflow: auto !important;\n    max-height: 350px !important;\n    padding-right: 8px !important;\n}\n\n.gm-style .gm-style-iw {\n    /* Override any problematic positioning */\n    position: relative !important;\n    z-index: 1001 !important;\n}\n\n.gm-style .gm-style-iw-t {\n    position: absolute !important;\n    width: 100% !important;\n    /* Override the inline bottom positioning that's causing the issue */\n    bottom: 0px !important;\n    /* Ensure proper positioning */\n    right: auto !important;\n    left: 50% !important;\n    transform: translateX(-50%) !important;\n    /* Make sure it's properly sized */\n    height: 15px !important;\n}\n\n.gm-style .gm-style-iw-tc {\n    /* This is the tail connector - make sure it's positioned correctly */\n    top: auto !important;\n    bottom: -15px !important;\n    left: 50% !important;\n    right: auto !important;\n    transform: translateX(-50%) !important;\n    width: 24px !important;\n    height: 24px !important;\n}\n";function safeExtractCoordinates(e){try{if(!e)return null;let n,o;if("function"==typeof e.lat&&"function"==typeof e.lng)n=e.lat(),o=e.lng();else if(void 0!==e.lat&&void 0!==e.lng)n=parseFloat(e.lat),o=parseFloat(e.lng);else if(void 0!==e.latitude&&void 0!==e.longitude)n=parseFloat(e.latitude),o=parseFloat(e.longitude);else{if(!(Array.isArray(e)&&e.length>=2))return console.warn("Unrecognized location object format:",e),null;n=parseFloat(e[0]),o=parseFloat(e[1])}return isNaN(n)||isNaN(o)||!isFinite(n)||!isFinite(o)?(console.warn("Invalid coordinates extracted:",n,o),null):Math.abs(n)>90||Math.abs(o)>180?(console.warn("Coordinates out of valid range:",n,o),null):{lat:n,lng:o}}catch(e){return console.error("Error extracting coordinates:",e),null}}function showInfoWindow(e){if(console.log("showInfoWindow called with marker:",e),!e||!e.business)return void console.error("Invalid marker for info window",e);const n=e.business;console.log("Business data for info window:",n),infoWindow&&infoWindow.close(),infoWindow=new google.maps.InfoWindow({maxWidth:300,disableAutoPan:!1});const o=buildInfoWindowContent(n);infoWindow.setContent(o);let t=null;if(e.getPosition&&"function"==typeof e.getPosition)try{t=e.getPosition()}catch(e){console.warn("Error getting position from marker.getPosition():",e)}if(!t&&e.position&&(t=e.position),!t&&n){const e=safeExtractCoordinates(n);e&&(t=new google.maps.LatLng(e.lat,e.lng))}t||(console.error("Could not determine position for info window"),t=new google.maps.LatLng(39.8283,-98.5795));const i=safeExtractCoordinates(t);if(!i)return void console.error("Invalid position for info window");const s=new google.maps.LatLng(i.lat,i.lng);try{map.panTo(s)}catch(e){console.warn("Error panning to position:",e)}setTimeout((()=>{try{e.getPosition?infoWindow.open(map,e):(infoWindow.setPosition(s),infoWindow.open(map)),console.log("Info window opened successfully"),google.maps.event.addListenerOnce(infoWindow,"domready",(function(){console.log("Info window DOM ready"),setTimeout((()=>{fixInfoWindowPositioning(),n.isGooglePlace?n.chain_id&&setTimeout((()=>{loadChainIncentivesForInfoWindow(n.placeId,n.chain_id)}),200):setTimeout((()=>{loadIncentivesForInfoWindow(n._id)}),200)}),300)}))}catch(e){console.error("Error opening info window:",e)}}),200)}function withErrorHandling(e,n){return function(...o){try{return e.apply(this,o)}catch(e){return console.error(`Error in ${n}:`,e),null}}}function fixInfoWindowPositioning(){console.log("Applying info window positioning fix");const e=document.querySelector(".gm-style-iw-c"),n=document.querySelector(".gm-style-iw-d"),o=document.querySelector(".gm-style-iw-t");if(!e)return void console.log("Info window container not found");const t=e.getBoundingClientRect();if(console.log("Info window position:",t),t.width<50&&(console.log("Info window width too small, forcing proper dimensions"),e.style.width="auto",e.style.minWidth="280px",e.style.maxWidth="320px",n&&(n.style.width="auto",n.style.minWidth="280px")),t.top<0||t.top>window.innerHeight||t.left<0||t.left>window.innerWidth||t.width<50){console.log("Info window has positioning/sizing issues, applying comprehensive fix");const n=e.style.transform;if(n&&n.includes("translate")){console.log("Current transform:",n);const o=n.match(/translate\(([^,]+),\s*([^)]+)\)/);if(o){const n=parseFloat(o[1]),t=parseFloat(o[2]);(Math.abs(n)>window.innerWidth||Math.abs(t)>window.innerHeight)&&(console.log("Resetting extreme transform values"),e.style.transform="translate(0px, 0px)")}}e.style.display="block",e.style.visibility="visible",e.style.opacity="1",o&&(o.style.bottom="0px",o.style.left="50%",o.style.right="auto",o.style.transform="translateX(-50%)"),console.log("Applied comprehensive positioning fix"),setTimeout((()=>{google.maps.event.trigger(map,"resize");const n=e.getBoundingClientRect();console.log("Info window dimensions after fix:",n)}),100)}}function loadIncentivesForInfoWindow(e){const n=document.getElementById(`incentives-container-${e}`);if(!n)return void console.error("Incentives container not found for business:",e);const o=getBaseURL();fetch(`${o}/api/combined-api.js?operation=incentives&business_id=${e}`).then((e=>e.json())).then((e=>{if(!e.results||0===e.results.length)return void(n.innerHTML='<p style="margin:4px 0; font-style:italic; color:#666;">No incentives available</p>');let o='<p style="margin:4px 0;"><strong>Incentives:</strong></p><ul style="margin:4px 0; padding-left:16px; font-size:13px;">';e.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),t=e.other_description?` (${e.other_description})`:"",i=e.is_chain_wide?'<span style="background-color:#4285F4; color:white; padding:1px 4px; border-radius:3px; font-size:11px; margin-left:4px;">Chain-wide</span>':"";o+=`<li style="margin-bottom:4px;"><strong>${n}${t}:</strong> ${e.amount}% ${i}</li>`}})),o+="</ul>",n.innerHTML=o})).catch((e=>{console.error("Error loading incentives:",e),n.innerHTML='<p style="margin:4px 0; font-style:italic; color:#666;">Error loading incentives</p>'}))}function loadChainIncentivesForInfoWindow(e,n){const o=document.getElementById(`incentives-container-${e}`);if(!o)return void console.error("Incentives container not found for place:",e);const t=getBaseURL();fetch(`${t}/api/combined-api.js?operation=incentives&business_id=${n}`).then((e=>e.json())).then((e=>{if(!e.results||0===e.results.length)return void(o.innerHTML='<p style="margin:4px 0; font-style:italic; color:#666;">No chain incentives available</p>');let n='<p style="margin:4px 0;"><strong>Chain Incentives:</strong></p><ul style="margin:4px 0; padding-left:16px; font-size:13px;">';e.results.forEach((e=>{if(e.is_available){const o=getIncentiveTypeLabel(e.type),t=e.other_description?` (${e.other_description})`:"";n+=`<li style="margin-bottom:4px;"><strong>${o}${t}:</strong> ${e.amount}% <span style="background-color:#4285F4; color:white; padding:1px 4px; border-radius:3px; font-size:11px; margin-left:4px;">Chain-wide</span></li>`}})),n+="</ul>",n+='<p style="margin:8px 0 4px 0; font-size:12px; font-style:italic; color:#666;">These incentives apply to all locations of this chain.</p>',o.innerHTML=n})).catch((e=>{console.error("Error loading chain incentives:",e),o.innerHTML='<p style="margin:4px 0; font-style:italic; color:#666;">Error loading chain incentives</p>'}))}function applyInfoWindowCSS(){if(!document.getElementById("info-window-fix-css")){const e=document.createElement("style");e.id="info-window-fix-css",e.textContent="\n            /* Ensure info windows are visible and properly positioned */\n            .gm-style .gm-style-iw-c {\n                max-width: 320px !important;\n                max-height: 400px !important;\n                padding: 0 !important;\n                border-radius: 8px !important;\n                box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n                overflow: hidden !important;\n            }\n\n            .gm-style .gm-style-iw-d {\n                overflow: auto !important;\n                max-height: 350px !important;\n            }\n\n            .gm-style .gm-style-iw {\n                display: block !important;\n                visibility: visible !important;\n                opacity: 1 !important;\n            }\n\n            /* Fix tail positioning */\n            .gm-style .gm-style-iw-t {\n                bottom: 0px !important;\n                left: 50% !important;\n                right: auto !important;\n                transform: translateX(-50%) !important;\n                width: 20px !important;\n                height: 15px !important;\n            }\n\n            /* Ensure close button is visible */\n            .gm-ui-hover-effect {\n                opacity: 0.8 !important;\n                top: 2px !important;\n                right: 2px !important;\n            }\n\n            .gm-ui-hover-effect:hover {\n                opacity: 1 !important;\n            }\n\n            /* Custom scrollbar for info window content */\n            .gm-style .gm-style-iw-d::-webkit-scrollbar {\n                width: 6px;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-track {\n                background: #f1f1f1;\n                border-radius: 3px;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb {\n                background: #c1c1c1;\n                border-radius: 3px;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb:hover {\n                background: #a8a8a8;\n            }\n        ",document.head.appendChild(e),console.log("Applied info window CSS fixes")}}function applyCSSOnlyTailFix(){if(!document.getElementById("css-only-tail-fix")){const e=document.createElement("style");e.id="css-only-tail-fix",e.textContent="\n            /* Target only the tail positioning without affecting the container */\n            .gm-style .gm-style-iw-t {\n                bottom: 0px !important;\n                left: 0px !important;\n                right: 0px !important;\n                transform: translateX(-50%) !important;\n                width: 0 !important;\n                height: 0 !important;\n            }\n            \n            /* Don't touch the main container transform */\n            .gm-style .gm-style-iw-c {\n                /* Let Google handle the main positioning */\n            }\n        ",document.head.appendChild(e),console.log("Applied CSS-only tail fix")}}function removeAggressiveCSS(){["final-info-window-fix","info-window-position-fix","minimal-info-window-fix"].forEach((e=>{const n=document.getElementById(e);n&&(console.log("Removing potentially problematic CSS:",e),n.remove())}))}function applyBasicInfoWindowCSS(){if(!document.getElementById("basic-info-window-css")){const e=document.createElement("style");e.id="basic-info-window-css",e.textContent="\n            /* Very basic CSS - just ensure visibility */\n            .gm-style .gm-style-iw-c {\n                display: block !important;\n                visibility: visible !important;\n                opacity: 1 !important;\n            }\n            \n            .gm-style .gm-style-iw {\n                display: block !important;\n                visibility: visible !important;\n                opacity: 1 !important;\n            }\n            \n            /* Map height fix */\n            #map-container {\n                width: 90%;\n                margin: 20px auto;\n                clear: both;\n                position: relative;\n            }\n\n            #map {\n                width: 100%;\n                height: 800px !important;\n                min-height: 800px;\n                border: 1px solid #ccc;\n                border-radius: 4px;\n                margin: 10px 0;\n                position: relative;\n                z-index: 1;\n            }\n        ",document.head.appendChild(e),console.log("Applied basic info window CSS")}}function applyInfoWindowPositioningFixes(){if(!document.getElementById("final-info-window-fix")){const e=document.createElement("style");e.id="final-info-window-fix",e.textContent="\n            /* CRITICAL: Override Google's tail positioning that causes off-screen issues */\n            ..gm-style .gm-style-iw-t {\n                bottom: 0px !important;\n                left: 0px !important;\n                right: 0px !important;\n                transform: translateX(-50%) !important;\n                width: 0 !important;\n                height: 0 !important;\n            }\n            \n            /* Prevent off-screen positioning */\n            .gm-style .gm-style-iw-c {\n                max-width: 320px !important;\n                max-height: 400px !important;\n                overflow: hidden !important;\n                /* Prevent problematic transforms */\n                transform: none !important;\n            }\n            \n            /* Ensure visibility */\n            .gm-style .gm-style-iw {\n                display: block !important;\n                visibility: visible !important;\n                opacity: 1 !important;\n            }\n            \n            .gm-style .gm-style-iw-d {\n                overflow: auto !important;\n                max-height: 350px !important;\n            }\n            \n            /* Fix tail connector */\n            .gm-style .gm-style-iw-tc {\n                top: auto !important;\n                bottom: -15px !important;\n                left: 50% !important;\n                right: auto !important;\n                transform: translateX(-50%) !important;\n            }\n            \n            /* Map container styles */\n            #map-container {\n                width: 90%;\n                margin: 20px auto;\n                clear: both;\n                position: relative;\n            }\n\n            #map {\n                width: 100%;\n                height: 800px !important;\n                min-height: 800px;\n                border: 1px solid #ccc;\n                border-radius: 4px;\n                margin: 10px 0;\n                position: relative;\n                z-index: 1;\n            }\n        ",document.head.appendChild(e),console.log("Applied final info window positioning fixes")}}function createEnhancedAddressKey(e){const n=[];return e.address1&&n.push(e.address1.toLowerCase().trim()),e.city&&n.push(e.city.toLowerCase().trim()),e.state&&n.push(e.state.toLowerCase().trim()),e.placeId&&n.push(`place_${e.placeId}`),e._id&&!e._id.startsWith("google_")&&n.push(`db_${e._id}`),n.join("|")}function createBusinessNameKey(e){if(e.isChainLocation||e.chain_id){const n=e.address1?e.address1.toLowerCase().replace(/\d+/g,"").trim():"";return`${e.bname.toLowerCase().trim()}_${n}`}return e.bname.toLowerCase().trim()}function categorizeResultsWithFixedDuplicateDetection(e,n,o){const t=[...e],i=new Set,s=new Set;return t.forEach((e=>{const n=createEnhancedAddressKey(e),o=createBusinessNameKey(e);i.add(n),s.add(o)})),{finalPrimaryResults:t,finalPlacesResults:n.filter((e=>{const n=createEnhancedAddressKey(e),o=createBusinessNameKey(e);return!i.has(n)&&!s.has(o)&&(i.add(n),s.add(o),!0)})),finalNearbyResults:o.filter((e=>{const n=createEnhancedAddressKey(e),o=createBusinessNameKey(e);return!i.has(n)&&!s.has(o)}))}}function fetchBusinessIncentivesForInfoWindow(e){e&&!e.startsWith("google_")&&setTimeout((()=>{const n=document.getElementById(`info-window-incentives-${e}`);if(!n)return void console.error(`Could not find incentives div for business ${e}`);const o=getBaseURL();fetch(`${o}/api/combined-api.js?operation=incentives&business_id=${e}`).then((e=>e.json())).then((e=>{if(!e.results||0===e.results.length)return void(n.innerHTML="<p><strong>Incentives:</strong> No incentives found</p>");let o='<p><strong>Incentives:</strong></p><ul style="margin:8px 0; padding-left:20px;">';e.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),t=e.other_description?` (${e.other_description})`:"",i=e.is_chain_wide?'<span style="display:inline-block; background-color:#4285F4; color:white; padding:1px 4px; border-radius:4px; font-size:0.7em; margin-left:5px;">Chain-wide</span>':"";o+=`<li><strong>${n}${t}:</strong> ${e.amount}% ${i}</li>`}})),o+="</ul>",n.innerHTML=o})).catch((e=>{console.error("Error fetching incentives:",e),n.innerHTML="<p><strong>Incentives:</strong> Error loading</p>"}))}),300)}function removeProblematicInfoWindowCSS(){document.querySelectorAll("#info-window-position-fix, #map-height-fix").forEach((e=>{console.log("Removing potentially problematic style:",e.id),e.remove()}));const e=document.createElement("style");e.id="minimal-info-window-fix",e.textContent="\n        /* Minimal CSS to ensure info windows are visible */\n        .gm-style .gm-style-iw-c {\n            max-width: 320px !important;\n            max-height: 400px !important;\n            overflow: visible !important;\n        }\n        \n        .gm-style .gm-style-iw-d {\n            overflow: auto !important;\n            max-height: 350px !important;\n        }\n        \n        .gm-style .gm-style-iw {\n            display: block !important;\n            visibility: visible !important;\n            opacity: 1 !important;\n        }\n        \n        /* Don't touch the tail positioning for now */\n        .gm-style .gm-style-iw-t {\n            /* Let Google handle this naturally */\n        }\n    ",document.head.appendChild(e),console.log("Applied minimal info window CSS")}async function findChainMatchesForResults(e){const n=e.map((e=>findMatchingChainForPlaceResult(e.bname).then((n=>(n&&(console.log(`Found matching chain for place: ${e.bname}`),e.chain_id=n._id,e.chain_name=n.bname,e.isChainLocation=!0),e))).catch((n=>(console.error(`Error matching chain for ${e.bname}:`,n),e)))));return await Promise.all(n),e}function findMatchingChainLocally(e){return new Promise((n=>{try{if(!e)return void n(null);console.log("Enhanced local chain matching for:",e);const o=[{name:"The Home Depot",variations:["the home depot","home depot","homedepot"],id:"681fe0e67d92c3d3e1e2a3da"},{name:"Lowe's",variations:["lowes","lowe's","lowes home improvement","lowe's home improvement"],id:"lowes_chain_id"},{name:"Walmart",variations:["walmart","wal-mart","walmart supercenter"],id:"walmart_chain_id"},{name:"Target",variations:["target","target store"],id:"target_chain_id"},{name:"Best Buy",variations:["best buy","bestbuy"],id:"bestbuy_chain_id"},{name:"McDonald's",variations:["mcdonalds","mcdonald's","mickey d's"],id:"mcdonalds_chain_id"}],t=e.toLowerCase().trim();for(const i of o)for(const o of i.variations)if(t===o||t.includes(o)||o.includes(t))return console.log(`Enhanced local match: "${e}" matches "${i.name}"`),void n({_id:i.id,bname:i.name,isLocalMatch:!0});console.log("No enhanced local chain match found for:",e),n(null)}catch(e){console.error("Error in enhanced local chain matching:",e),n(null)}}))}async function setupMapClickHandler(){if(map){console.log("Setting up map click handler");try{const{Place:e}=await google.maps.importLibrary("places");map.addListener("click",(async function(n){if(console.log("Map clicked",n),n.placeId){n.stop(),console.log("POI clicked, placeId:",n.placeId);try{const o=markers.find((e=>e.business&&(e.business.placeId===n.placeId||e.business._id==="google_"+n.placeId)));if(o)return console.log("Found existing marker for clicked place"),void showEnhancedInfoWindow(o);const t=new e({id:n.placeId});await t.fetchFields({fields:["displayName","formattedAddress","addressComponents","location","types","businessStatus","nationalPhoneNumber","internationalPhoneNumber"]}),console.log("Place details:",t);const i=t.displayName||"Unknown Business";let s="",a="",r="",l="",c="";if(c=t.nationalPhoneNumber||t.internationalPhoneNumber||"",t.addressComponents&&t.addressComponents.length>0){console.log("Parsing address components:",t.addressComponents);const e=getAddressComponent(t.addressComponents,"street_number"),n=getAddressComponent(t.addressComponents,"route");a=getAddressComponent(t.addressComponents,"locality"),r=getAddressComponent(t.addressComponents,"administrative_area_level_1"),l=getAddressComponent(t.addressComponents,"postal_code"),e&&n?s=`${e} ${n}`:n?s=n:e&&(s=e)}if(!s&&t.formattedAddress){console.log("Falling back to formatted address parsing");const e=t.formattedAddress.split(",").map((e=>e.trim()));if(e.length>=1&&(s=e[0]),e.length>=2&&(a=e[1]),e.length>=3){const n=e[2].match(/^([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/);if(n)r=n[1],l=n[2];else{const n=e[2].split(" ");n.length>=2&&(r=n[0],l=n[1])}}}let d=0,g=0;if(t.location)try{d="function"==typeof t.location.lat?t.location.lat():t.location.lat||0,g="function"==typeof t.location.lng?t.location.lng():t.location.lng||0}catch(e){console.warn("Error extracting coordinates:",e),n.latLng&&(d=n.latLng.lat(),g=n.latLng.lng())}else n.latLng&&(d=n.latLng.lat(),g=n.latLng.lng());const p=mapGooglePlaceTypeToBusinessType(t.types||[]);let u=null;try{u=await findMatchingChainForPlaceResult(i)}catch(e){console.warn("Error checking for chain match (non-critical):",e)}const h={_id:"google_"+t.id,bname:i,address1:s,city:a,state:r,zip:l,phone:c,type:p,formattedAddress:t.formattedAddress,isGooglePlace:!0,placeId:t.id,lat:d,lng:g,types:t.types||[]};if(u&&(console.log(`POI "${i}" matches chain: ${u.bname}`),h.chain_id=u._id,h.chain_name=u.bname,h.isChainLocation=!0),d&&g&&window.currentSearchLocation)try{h.distance=google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(d,g),new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng))}catch(e){console.warn("Error calculating distance:",e)}console.log("Parsed business object:",h),showEnhancedInfoWindow({business:h,position:new google.maps.LatLng(d,g),getPosition:function(){return this.position}})}catch(e){console.error("Error fetching place details:",e),alert("Unable to load details for this location. Please try again.")}}})),console.log("Map click handler set up successfully")}catch(e){console.error("Error setting up map click handler:",e)}}else console.error("Map not initialized in setupMapClickHandler")}function getAddressComponent(e,n){if(!e||!Array.isArray(e))return"";const o=e.find((e=>e.types&&e.types.includes(n)));return o&&(o.shortText||o.short_name)||""}function mapGooglePlaceTypeToBusinessType(e){if(!e||!Array.isArray(e))return"OTHER";const n={restaurant:"REST",meal_takeaway:"REST",meal_delivery:"REST",cafe:"REST",bakery:"REST",bar:"REST",night_club:"REST",food:"REST",mexican_restaurant:"REST",chinese_restaurant:"REST",italian_restaurant:"REST",japanese_restaurant:"REST",indian_restaurant:"REST",thai_restaurant:"REST",american_restaurant:"REST",pizza_restaurant:"REST",seafood_restaurant:"REST",steak_house:"REST",sushi_restaurant:"REST",vegetarian_restaurant:"REST",fast_food_restaurant:"REST",grocery_or_supermarket:"GROC",supermarket:"GROC",convenience_store:"CONV",gas_station:"FUEL",hardware_store:"HARDW",department_store:"DEPT",clothing_store:"CLTH",shoe_store:"CLTH",electronics_store:"ELEC",furniture_store:"FURN",home_goods_store:"FURN",jewelry_store:"JEWL",book_store:"BOOK",bicycle_store:"SPRT",sporting_goods_store:"SPRT",toy_store:"TOYS",pet_store:"OTHER",florist:"GIFT",gift_shop:"GIFT",car_dealer:"AUTO",car_rental:"AUTO",car_repair:"AUTO",car_wash:"AUTO",auto_parts_store:"AUTO",pharmacy:"RX",drugstore:"RX",hospital:"HEAL",doctor:"HEAL",dentist:"HEAL",veterinary_care:"HEAL",beauty_salon:"BEAU",hair_care:"BEAU",spa:"BEAU",movie_theater:"ENTR",amusement_park:"ENTR",zoo:"ENTR",aquarium:"ENTR",museum:"ENTR",art_gallery:"ENTR",bowling_alley:"ENTR",casino:"ENTR",bank:"SERV",atm:"SERV",post_office:"SERV",laundry:"SERV",gym:"SPRT",library:"BOOK",lodging:"OTHER",hotel:"OTHER",motel:"OTHER",store:"RETAIL",shopping_mall:"RETAIL",establishment:"OTHER",point_of_interest:"OTHER"};for(const o of e)if(n[o])return n[o];return"OTHER"}function buildInfoWindowContent(e){const n=!0===e.isGooglePlace,o=!!e.chain_id;let t="";e.address1?(t=`<p><strong>Address:</strong><br>${e.address1}`,e.city&&(t+=`, ${e.city}`),e.state&&(t+=`, ${e.state}`),e.zip&&(t+=` ${e.zip}`),t+="</p>"):e.formattedAddress&&(t=`<p><strong>Address:</strong><br>${e.formattedAddress}</p>`);const i=o?`<span style="display:inline-block; background-color:#4285F4; color:white; padding:2px 6px; border-radius:4px; font-size:0.8em; margin-left:5px;">${e.chain_name||"Chain Location"}</span>`:"";let s="";e.type?s=`<p><strong>Type:</strong> ${getBusinessTypeLabel(e.type)}</p>`:n&&e.types&&e.types.length>0&&(s=`<p><strong>Type:</strong> ${getPlaceTypeLabel(e.types)}</p>`);const a=e.distance?`<p><strong>Distance:</strong> ${(e.distance/1609).toFixed(1)} miles</p>`:"",r=n?'<p style="color:#666; font-style:italic;">This business is not yet in the Patriot Thanks database.</p>':"",l=o?`<p style="color:#4285F4; font-size:12px; margin-top:8px;">This location appears to match ${e.chain_name} in our database. Chain-wide incentives may apply.</p>`:"";let c;return c=n?o?`\n                <button style="background-color:#EA4335; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; width:100%;" \n                        onclick="window.addBusinessToDatabase('${e.placeId}', '${e.chain_id}')">\n                    Add ${e.chain_name} Location\n                </button>\n            `:`\n                <button style="background-color:#EA4335; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; width:100%;" \n                        onclick="window.addBusinessToDatabase('${e.placeId}')">\n                    Add to Patriot Thanks\n                </button>\n            `:`\n            <button style="background-color:#4285F4; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; width:100%;" \n                    onclick="window.viewBusinessDetails('${e._id}')">\n                View Details\n            </button>\n        `,`\n        <div style="max-width:280px; font-family:Arial,sans-serif; padding:8px;">\n            <h3 style="margin:0 0 8px 0; font-size:16px; line-height:1.2;">${e.bname} ${i}</h3>\n            ${t}\n            ${s}\n            ${a}\n            ${r}\n            ${l}\n            <div id="incentives-container-${e._id||e.placeId}" style="margin:8px 0;">\n                ${n&&!o?'<p style="margin:4px 0; font-style:italic; color:#666;">Add this business to see available incentives.</p>':'<p style="margin:4px 0;"><em>Loading incentives...</em></p>'}\n            </div>\n            <div style="margin-top:12px; text-align:center;">\n                ${c}\n            </div>\n        </div>\n    `}function getPlaceTypeLabel(e){if(!e||!e.length)return"Business";const n={restaurant:"Restaurant",food:"Food & Dining",store:"Store",establishment:"Business",point_of_interest:"Point of Interest",gas_station:"Gas Station",lodging:"Lodging",cafe:"Cafe",bar:"Bar",hardware_store:"Hardware Store",home_goods_store:"Home Goods",department_store:"Department Store",grocery_or_supermarket:"Grocery Store",furniture_store:"Furniture Store",electronics_store:"Electronics Store",clothing_store:"Clothing Store",shoe_store:"Shoe Store",beauty_salon:"Beauty Salon",hair_care:"Hair Salon",spa:"Spa",pharmacy:"Pharmacy",drugstore:"Pharmacy",bank:"Bank",atm:"ATM",shopping_mall:"Shopping Mall",supermarket:"Supermarket",convenience_store:"Convenience Store",car_dealer:"Car Dealer",car_repair:"Auto Repair",car_wash:"Car Wash",gym:"Gym",hospital:"Hospital",doctor:"Medical",dentist:"Dental",veterinary_care:"Veterinary",movie_theater:"Movie Theater",amusement_park:"Amusement Park",zoo:"Zoo",aquarium:"Aquarium",museum:"Museum",library:"Library",book_store:"Bookstore",jewelry_store:"Jewelry Store",florist:"Florist",pet_store:"Pet Store",bicycle_store:"Bike Shop",sporting_goods_store:"Sporting Goods"};for(const o of e)if(n[o])return n[o];return e[0].replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase()))}function addInitialMapMessage(e){const n=document.createElement("div");n.id="initial-map-message",n.innerHTML="Search for businesses to see them on the map",n.style.position="absolute",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.background="white",n.style.padding="10px",n.style.borderRadius="5px",n.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)",n.style.zIndex="1",e.appendChild(n)}function setupResetMapButton(){const e=document.getElementById("reset-map");e&&e.addEventListener("click",(function(){resetMapView()}))}function resetMapView(){if(mapInitialized&&map)try{safelySetCenter(map,CONFIG.defaultCenter,CONFIG.defaultZoom),infoWindow&&infoWindow.close()}catch(e){console.error("Error resetting map view:",e)}else console.error("Cannot reset map view - map not initialized")}function setupMarkerClickPriority(){map?(console.log("Setting up enhanced marker click priority"),google.maps.event.addListener(map,"click",(function(e){if(e.placeId){const n=e.latLng,o=20,t=map.getProjection();if(!t)return;const i=Math.pow(2,map.getZoom()),s=t.fromLatLngToPoint(n);for(const n of markers){if(!n.position)continue;const a=n.position,r=t.fromLatLngToPoint(a);if(Math.sqrt(Math.pow((s.x-r.x)*i,2)+Math.pow((s.y-r.y)*i,2))<=o)return console.log("Preventing POI click, using our enhanced marker instead"),e.stop(),void setTimeout((()=>{showEnhancedInfoWindow(n)}),10)}}}),{passive:!1})):console.error("Map not initialized, cannot set up click priority")}function initAdditionalMapFeatures(){console.log("Initializing additional map features"),addCustomMarkerStyleFixes(),setupMarkerClickPriority(),customizeInfoWindows()}function addCustomMarkerStyleFixes(){if(!document.getElementById("marker-style-fixes")){const e=document.createElement("style");e.id="marker-style-fixes",e.textContent="\n            /* Ensure proper marker display */\n            .marker-icon {\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                width: 20px;\n                height: 20px;\n                color: #333;\n            }\n            \n            /* Fix for Font Awesome icons */\n            .marker-icon i {\n                font-size: 12px !important;\n                color: #333 !important;\n            }\n            \n            /* Info window styling */\n            .info-window-actions .view-details-btn {\n                margin-top: 8px;\n            }\n        ",document.head.appendChild(e)}}function customizeInfoWindows(){applyInfoWindowScrollableStyles();const e=document.createElement("style");e.textContent="\n        .gm-ui-hover-effect {\n            opacity: 0.8 !important;\n            width: 24px !important;\n            height: 24px !important;\n            right: 2px !important;\n            top: 2px !important;\n        }\n        \n        .gm-ui-hover-effect span {\n            width: 16px !important;\n            height: 16px !important;\n        }\n        \n        .gm-ui-hover-effect:hover {\n            opacity: 1 !important;\n        }\n    ",document.head.appendChild(e)}function applyInfoWindowScrollableStyles(){if(!document.getElementById("info-window-scrollable-styles")){const e=document.createElement("style");e.id="info-window-scrollable-styles",e.textContent="\n            /* Info window structure */\n            .gm-style .gm-style-iw-c {\n                padding: 0 !important;\n                border-radius: 8px !important;\n                box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n                max-width: 330px !important;\n                max-height: 400px !important;\n                overflow: hidden !important;\n            }\n            \n            .gm-style .gm-style-iw-d {\n                overflow: auto !important;\n                max-height: 350px !important;\n                padding-right: 8px !important; /* Allow space for scrollbar */\n            }\n            \n            /* Custom info window styles */\n            .info-window {\n                padding: 12px;\n                max-width: 300px;\n            }\n            \n            .info-window h3 {\n                margin-top: 0;\n                margin-bottom: 10px;\n                color: #212121;\n                font-size: 16px;\n                line-height: 1.3;\n            }\n            \n            .info-window p {\n                margin: 6px 0;\n                font-size: 14px;\n                line-height: 1.4;\n            }\n            \n            .info-window-actions {\n                margin-top: 12px;\n                padding-top: 8px;\n                border-top: 1px solid #eee;\n                text-align: right;\n            }\n            \n            .add-business-btn {\n                background-color: #EA4335;\n                color: white;\n                border: none;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                margin-top: 5px;\n                font-size: 13px;\n                font-weight: 500;\n            }\n            \n            .add-business-btn:hover {\n                background-color: #D32F2F;\n            }\n            \n            .view-details-btn {\n                background-color: #4285F4;\n                color: white;\n                border: none;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                margin-top: 5px;\n                font-size: 13px;\n                font-weight: 500;\n            }\n            \n            .view-details-btn:hover {\n                background-color: #2A75F3;\n            }\n            \n            /* Incentives list */\n            .incentives-list {\n                margin: 8px 0;\n                padding-left: 20px;\n            }\n            \n            .incentives-list li {\n                margin-bottom: 6px;\n            }\n            \n            /* Custom scrollbar styles */\n            .gm-style .gm-style-iw-d::-webkit-scrollbar {\n                width: 6px;\n                height: 6px;\n            }\n            \n            .gm-style .gm-style-iw-d::-webkit-scrollbar-track {\n                background: #f1f1f1;\n                border-radius: 3px;\n            }\n            \n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb {\n                background: #c1c1c1;\n                border-radius: 3px;\n            }\n            \n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb:hover {\n                background: #a8a8a8;\n            }\n            \n            /* Close button adjustment */\n            .gm-ui-hover-effect {\n                top: 2px !important;\n                right: 2px !important;\n            }\n        ",document.head.appendChild(e)}}function fetchBusinessAndCreateMarker(e){console.log("Fetching business data for marker creation:",e);const n=getBaseURL();fetch(`${n}/api/business.js?operation=get&id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to fetch business: ${e.status}`);return e.json()})).then((n=>{if(n.result){console.log("Found business data:",n.result);const o=createBusinessMarker(n.result);o&&(map.setCenter(o.position),map.setZoom(15),showEnhancedInfoWindow(o),console.log("Created and focused on new enhanced marker for business:",e))}else console.error("Business data not found"),alert("Business information could not be found.");document.getElementById("map").scrollIntoView({behavior:"smooth"})})).catch((e=>{console.error("Error fetching business data:",e),alert("There was an error getting information for this business."),document.getElementById("map").scrollIntoView({behavior:"smooth"})}))}function isNotEmpty(e){return e&&""!==e.trim()}function validateField(e,n){console.log(`Validating ${e.id} with value: ${e.value}`),n(e.value)?(e.classList.remove("invalid-field"),e.classList.add("valid-field"),e.setAttribute("data-valid","true"),console.log(`${e.id} is VALID`)):(e.classList.remove("valid-field"),e.classList.add("invalid-field"),e.setAttribute("data-valid","false"),console.log(`${e.id} is INVALID`))}function displaySearchResults(e){try{hideLoadingIndicator();const n=document.getElementById("business_search"),o=document.getElementById("search_table");if(!n||!o)return console.error("Required elements not found in the DOM"),void showErrorMessage("There was an error displaying search results. Please try again later.");let t=n.querySelector("tbody");if(!t)return console.error("Table body not found within business_search table"),void showErrorMessage("There was an error displaying search results. Please try again later.");t.innerHTML="",Array.isArray(e)||(console.error("businesses is not an array:",e),e=[]),o.style.display="block";const i=o.querySelector("h5");if(i&&(i.style.display="none"),0===e.length)return t.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria.</td></tr>',void o.scrollIntoView({behavior:"smooth"});const s=e.filter((e=>!e.isGooglePlace)),a=e.filter((e=>e.isGooglePlace&&e.chain_id)),r=e.filter((e=>e.isGooglePlace&&!e.chain_id));console.log(`Businesses to display: ${s.length} from database, ${a.length} chain-matched Places, ${r.length} regular Places`),s.forEach((e=>{addBusinessRow(e,t,!1)})),a.forEach((e=>{addBusinessRow(e,t,!0)})),r.forEach((e=>{addBusinessRow(e,t,!0)})),o.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error displaying search results: ",e),hideLoadingIndicator(),showErrorMessage("There was an error displaying the search results: "+e.message)}}function addEnhancedLoadingCSS(){if(!document.getElementById("enhanced-loading-css")){const e=document.createElement("style");e.id="enhanced-loading-css",e.textContent="\n            .loading-indicator {\n                display: flex;\n                flex-direction: column;\n                justify-content: center;\n                align-items: center;\n                padding: 30px 20px;\n                text-align: center;\n                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);\n                border-radius: 8px;\n                margin: 20px 0;\n                box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            }\n\n            .loading-text {\n                font-size: 16px;\n                color: #333;\n                margin-bottom: 15px;\n                font-weight: 500;\n            }\n\n            .loading-spinner {\n                width: 40px;\n                height: 40px;\n                border: 4px solid #f3f3f3;\n                border-top: 4px solid #4285F4;\n                border-radius: 50%;\n                animation: spin 1s linear infinite;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n            }\n\n            @keyframes spin {\n                0% { transform: rotate(0deg); }\n                100% { transform: rotate(360deg); }\n            }\n\n            /* Enhanced error messages */\n            .error-message {\n                color: #721c24;\n                padding: 20px;\n                background: linear-gradient(135deg, #f8d7da 0%, #f1b0b7 100%);\n                border: 1px solid #f5c6cb;\n                border-radius: 8px;\n                margin: 20px 0;\n                text-align: center;\n                font-weight: 500;\n                box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n            }\n\n            /* Fade in animation for results */\n            .search-results-container {\n                animation: fadeIn 0.5s ease-in;\n            }\n\n            @keyframes fadeIn {\n                from { \n                    opacity: 0; \n                    transform: translateY(20px); \n                }\n                to { \n                    opacity: 1; \n                    transform: translateY(0); \n                }\n            }\n        ",document.head.appendChild(e)}}function fetchChainIncentivesForPlacesResult(e,n){if(!e||!n)return void console.error("Missing place ID or chain ID for fetching chain incentives");const o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${n}`;console.log("Fetching chain incentives for Places result: ",o),fetch(o).then((e=>{if(!e.ok)throw new Error(`Failed to fetch chain incentives: ${e.status}`);return e.json()})).then((n=>{console.log(`Chain incentives data for place ${e}:`,n);const o=document.getElementById(`incentives-for-${e}`);if(!o)return void console.error(`Could not find cell for incentives-for-${e}`);if(!n.results||0===n.results.length)return void(o.innerHTML="No chain incentives available");let t="";n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"";t+=`\n                        <div class="incentive-item">\n                            <strong>${n}${o}:</strong> ${e.amount}% \n                            <span class="chain-badge small">Chain-wide</span>\n                            <div class="incentive-info">${e.information||""}</div>\n                        </div>\n                    `}})),o.innerHTML=""===t?"Not in database yet":t})).catch((n=>{console.error(`Error fetching chain incentives for place ${e}:`,n);const o=document.getElementById(`incentives-for-${e}`);o&&(o.innerHTML="Not in database yet")}))}function getBusinessTypeTextIcon(e){return`<span style="font-size: 16px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${{AUTO:"ðŸš—",BEAU:"ðŸ’‡",BOOK:"ðŸ“š",CLTH:"ðŸ‘•",CONV:"ðŸª",DEPT:"ðŸ›ï¸",ELEC:"âš¡",ENTR:"ðŸŽ¬",FURN:"ðŸª‘",FUEL:"â›½",GIFT:"ðŸŽ",GROC:"ðŸ›’",HARDW:"ðŸ”¨",HEAL:"â¤ï¸",JEWL:"ðŸ’Ž",OTHER:"ðŸ¬",RX:"ðŸ’Š",REST:"ðŸ½ï¸",RETAIL:"ðŸ›ï¸",SERV:"ðŸ”§",SPEC:"â­",SPRT:"ðŸˆ",TECH:"ðŸ’»",TOYS:"ðŸŽ®"}[e]||"ðŸ¬"}</span>`}function createEnhancedFallbackMarker(e,n){try{console.log("Creating enhanced fallback marker for:",e.bname);let o=createSafeLatLng(n);if(!o&&e.lat&&e.lng&&(o=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng))),!o)return console.error("Invalid location for enhanced fallback marker:",n),null;const t=!e.isGooglePlace,i=(e.chain_id,t?CONFIG.markerColors.primary:CONFIG.markerColors.nearby),s=new google.maps.Marker({position:o,map,title:e.bname,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:i,fillOpacity:.9,strokeWeight:2,strokeColor:"#FFFFFF",scale:t?14:12},animation:google.maps.Animation.DROP,zIndex:t?1e3:100});return s.business=e,s.position=o,s.isFromDatabase=t,s.addListener("click",(function(){console.log("Enhanced fallback marker clicked:",e.bname),showEnhancedInfoWindow(s)})),markers.push(s),console.log(`Added enhanced fallback marker for ${e.bname}`),s}catch(e){return console.error("Error creating enhanced fallback marker:",e),null}}function showEnhancedInfoWindow(e){if(console.log("showEnhancedInfoWindow called with marker:",e),!e||!e.business)return void console.error("Invalid marker for enhanced info window",e);const n=e.business,o=!0===n.isGooglePlace,t=!!n.chain_id;infoWindow&&infoWindow.close(),infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1});const i=buildEnhancedInfoWindowContent(n);infoWindow.setContent(i);let s=e.position;if(!s&&e.getPosition&&(s=e.getPosition()),s||(s=createSafeLatLng(n)),s){try{map.panTo(s)}catch(e){console.warn("Error panning to position:",e)}setTimeout((()=>{try{e.getPosition?infoWindow.open(map,e):(infoWindow.setPosition(s),infoWindow.open(map)),console.log("Enhanced info window opened successfully"),google.maps.event.addListenerOnce(infoWindow,"domready",(function(){setTimeout((()=>{applyEnhancedInfoWindowFixes(),o?t&&(console.log(`Loading chain incentives for place: ${n.placeId}, chain: ${n.chain_id}`),loadChainIncentivesForEnhancedWindow(n.placeId,n.chain_id)):loadIncentivesForEnhancedWindow(n._id)}),200)}))}catch(e){console.error("Error opening enhanced info window:",e)}}),200)}else console.error("Could not determine position for enhanced info window")}function buildEnhancedInfoWindowContent(e){const n=!0===e.isGooglePlace,o=!!e.chain_id;let t="";if(e.address1){t=`<div class="info-address">\n            <strong>ðŸ“ Address:</strong><br>\n            ${e.address1}`,e.address2&&(t+=`<br>${e.address2}`);const n=[];e.city&&n.push(e.city),e.state&&n.push(e.state),e.zip&&n.push(e.zip),n.length>0&&(t+=`<br>${n.join(", ")}`),t+="</div>"}else if(e.formattedAddress){const n=e.formattedAddress.split(",").map((e=>e.trim()));t='<div class="info-address">\n            <strong>ðŸ“ Address:</strong><br>',n.length>=1&&(t+=n[0]),n.length>=2&&(t+=`<br>${n.slice(1).join(", ")}`),t+="</div>"}const i=e.phone?`<div class="info-phone"><strong>ðŸ“ž Phone:</strong> <a href="tel:${e.phone.replace(/\D/g,"")}" style="color: #4285F4; text-decoration: none;">${e.phone}</a></div>`:"";let s="";e.type&&"OTHER"!==e.type&&(s=`<div class="info-type"><strong>ðŸ¢ Type:</strong> ${getBusinessTypeLabel(e.type)}</div>`);const a=e.distance?`<div class="info-distance"><strong>ðŸ“ Distance:</strong> ${(e.distance/1609).toFixed(1)} miles</div>`:"",r=o?`<span class="enhanced-chain-badge">ðŸ”— ${e.chain_name||"Chain Location"}</span>`:"";let l,c="",d="";n?o?(c='<div class="info-status chain-match">ðŸ”— This location appears to match a chain in our database!</div>',d=`<div class="chain-explanation">\n                âœ¨ Great news! This location matches <strong>${e.chain_name}</strong> in our database. \n                Chain-wide incentives should apply to this location once added.\n            </div>`):c='<div class="info-status google-place">â„¹ï¸ This business is not yet in the Patriot Thanks database.</div>':c='<div class="info-status database-business">âœ… This business is in the Patriot Thanks database.</div>',l=n?o?`\n                <button class="enhanced-add-btn chain-add" onclick="window.addBusinessToDatabase('${e.placeId}', '${e.chain_id}')">\n                    ðŸ”— Add ${e.chain_name} Location\n                </button>\n            `:`\n                <button class="enhanced-add-btn" onclick="window.addBusinessToDatabase('${e.placeId}')">\n                    âž• Add to Patriot Thanks\n                </button>\n            `:`\n            <button class="enhanced-view-btn" onclick="window.viewBusinessDetails('${e._id}')">\n                ðŸ‘ï¸ View Details\n            </button>\n        `;const g=e._id||e.placeId;let p;return p=n&&o?"<em>â³ Loading chain incentives...</em>":n&&!o?"<em>ðŸ’¡ Add this business to see available incentives.</em>":"<em>â³ Loading incentives...</em>",`\n        <div class="enhanced-info-window">\n            <div class="info-header">\n                <h3>${e.bname} ${r}</h3>\n            </div>\n            \n            <div class="info-body">\n                ${t}\n                ${i}\n                ${s}\n                ${a}\n                ${c}\n                ${d}\n                \n                <div class="info-incentives">\n                    <div id="incentives-container-${g}">\n                        ${p}\n                    </div>\n                </div>\n            </div>\n            \n            <div class="info-actions">\n                ${l}\n            </div>\n        </div>\n    `}function loadIncentivesForEnhancedWindow(e){const n=document.getElementById(`incentives-container-${e}`);if(!n)return void console.error("Enhanced incentives container not found for business:",e);const o=getBaseURL();fetch(`${o}/api/combined-api.js?operation=incentives&business_id=${e}`).then((e=>e.json())).then((e=>{if(!e.results||0===e.results.length)return void(n.innerHTML="<em>ðŸ’­ No incentives available</em>");let o='<div class="incentives-header"><strong>ðŸŽ Available Incentives:</strong></div>';o+='<div class="incentives-list">',e.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),t=e.other_description?` (${e.other_description})`:"",i=e.is_chain_wide?'<span class="mini-chain-badge">ðŸ”— Chain-wide</span>':"";o+=`\n                        <div class="incentive-item">\n                            <div class="incentive-type">${n}${t}:</div>\n                            <div class="incentive-amount">${e.amount}% ${i}</div>\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),o+="</div>",n.innerHTML=o})).catch((e=>{console.error("Error loading incentives:",e),n.innerHTML="<em>âŒ Error loading incentives</em>"}))}function loadChainIncentivesForEnhancedWindow(e,n){const o=document.getElementById(`incentives-container-${e}`);if(o)loadChainIncentivesInContainer(o,n);else{console.error("Enhanced chain incentives container not found for place:",e);const o=document.getElementById(`incentives-container-google_${e}`);if(o)return console.log("Found alternative container ID format"),void loadChainIncentivesInContainer(o,n);const t=document.querySelectorAll('[id*="incentives-container"]');console.log("Available incentives containers:",Array.from(t).map((e=>e.id)))}}function loadChainIncentivesInContainer(e,n){const o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${n}`;console.log("Loading chain incentives from:",o),fetch(o).then((e=>e.json())).then((n=>{if(!n.results||0===n.results.length)return void(e.innerHTML="<em>ðŸ’­ No chain incentives available</em>");let o='<div class="incentives-header"><strong>ðŸŽ Chain-wide Incentives:</strong></div>';o+='<div class="incentives-list">',n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),t=e.other_description?` (${e.other_description})`:"";o+=`\n                        <div class="incentive-item chain-incentive">\n                            <div class="incentive-type">${n}${t}:</div>\n                            <div class="incentive-amount">${e.amount}% <span class="mini-chain-badge">ðŸ”— Chain-wide</span></div>\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),o+="</div>",o+='<div class="chain-note">âœ¨ Great! These incentives apply to all locations of this chain.</div>',e.innerHTML=o,console.log("Successfully loaded chain incentives")})).catch((n=>{console.error("Error loading chain incentives:",n),e.innerHTML="<em>âŒ Error loading chain incentives</em>"}))}function applyEnhancedInfoWindowFixes(){const e=document.querySelector(".gm-style-iw-c"),n=document.querySelector(".gm-style-iw-d"),o=document.querySelector(".gm-style-iw-t");if(e){const n=e.getBoundingClientRect();n.width<50&&(e.style.width="auto",e.style.minWidth="300px",e.style.maxWidth="350px"),e.style.padding="0",e.style.margin="0",(n.top<0||n.top>window.innerHeight||n.left<0||n.left>window.innerWidth)&&(e.style.position="relative",e.style.transform="none")}n&&(n.style.padding="0",n.style.margin="0",n.style.overflow="auto",n.style.maxHeight="350px"),o&&(o.style.bottom="0px",o.style.left="50%",o.style.right="auto",o.style.transform="translateX(-50%)"),console.log("Applied enhanced info window fixes with proper padding")}function addEnhancedMarkerStyles(){if(!document.getElementById("enhanced-marker-styles")){const e=document.createElement("style");e.id="enhanced-marker-styles",e.textContent="\n            /* Enhanced marker container */\n            .enhanced-custom-marker {\n                cursor: pointer;\n                transition: transform 0.2s ease;\n                z-index: 100;\n            }\n\n            .enhanced-marker-container {\n                position: relative;\n                width: 36px;\n                height: 46px;\n            }\n\n            /* Enhanced pin styling */\n            .enhanced-marker-pin {\n                width: 32px;\n                height: 40px;\n                border-radius: 50% 50% 50% 0;\n                transform: rotate(-45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                box-shadow: 0 3px 6px rgba(0,0,0,0.3);\n                position: absolute;\n                top: 0;\n                left: 2px;\n                border: 2px solid white;\n            }\n\n            .enhanced-marker-pin.primary {\n                background: linear-gradient(45deg, #EA4335, #FF6B6B);\n            }\n\n            .enhanced-marker-pin.nearby {\n                background: linear-gradient(45deg, #4285F4, #64B5F6);\n            }\n\n            /* Enhanced icon styling */\n            .enhanced-marker-icon {\n                transform: rotate(45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                width: 20px;\n                height: 20px;\n                font-size: 16px;\n                filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5));\n            }\n\n            /* Enhanced shadow */\n            .enhanced-marker-shadow {\n                position: absolute;\n                bottom: -2px;\n                left: 8px;\n                width: 20px;\n                height: 8px;\n                background: radial-gradient(ellipse, rgba(0,0,0,0.3) 0%, transparent 70%);\n                border-radius: 50%;\n                filter: blur(1px);\n            }\n\n            /* Chain indicator */\n            .chain-indicator {\n                position: absolute;\n                top: -5px;\n                right: -5px;\n                background: #FFD700;\n                border-radius: 50%;\n                width: 18px;\n                height: 18px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 10px;\n                border: 2px solid white;\n                box-shadow: 0 1px 3px rgba(0,0,0,0.3);\n                z-index: 1001;\n            }\n\n            /* CRITICAL: Google Maps info window container fixes */\n            .gm-style .gm-style-iw-c {\n                padding: 0 !important;\n                border-radius: 8px !important;\n                box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n                max-width: 350px !important;\n                max-height: 400px !important;\n                overflow: hidden !important;\n            }\n\n            .gm-style .gm-style-iw-d {\n                overflow: auto !important;\n                max-height: 350px !important;\n                padding: 0 !important;\n                /* Add proper padding that Google Maps won't strip */\n                margin: 0 !important;\n            }\n\n            /* Enhanced info window styles with proper padding */\n            .enhanced-info-window {\n                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n                max-width: 320px;\n                line-height: 1.4;\n                /* CRITICAL: Add padding to the content container instead of relying on Google's padding */\n                padding: 12px 12px 12px 12px !important;\n                margin: 0;\n                box-sizing: border-box;\n            }\n\n            .info-header {\n                border-bottom: 2px solid #f0f0f0;\n                padding-bottom: 8px;\n                margin-bottom: 12px;\n            }\n\n            .info-header h3 {\n                margin: 0;\n                font-size: 16px;\n                color: #333;\n                font-weight: 600;\n            }\n\n            .enhanced-chain-badge {\n                display: inline-block;\n                background: linear-gradient(45deg, #4285F4, #64B5F6);\n                color: white;\n                padding: 2px 8px;\n                border-radius: 12px;\n                font-size: 11px;\n                margin-left: 8px;\n                font-weight: 500;\n            }\n\n            .info-body > div {\n                margin: 8px 0;\n                font-size: 14px;\n            }\n\n            .info-address, .info-phone, .info-type, .info-distance {\n                color: #555;\n            }\n\n            .info-status {\n                padding: 6px 10px;\n                border-radius: 6px;\n                font-size: 13px;\n                margin: 10px 0;\n            }\n\n            .info-status.database-business {\n                background-color: #e8f5e8;\n                color: #2e7d32;\n            }\n\n            .info-status.google-place {\n                background-color: #e3f2fd;\n                color: #1565c0;\n            }\n\n            .chain-explanation {\n                background-color: #fff3e0;\n                padding: 8px;\n                border-radius: 6px;\n                font-size: 13px;\n                color: #ef6c00;\n                border-left: 3px solid #ff9800;\n            }\n\n            .info-incentives {\n                margin: 12px 0;\n            }\n\n            .incentives-header {\n                font-weight: 600;\n                color: #333;\n                margin-bottom: 8px;\n            }\n\n            .incentive-item {\n                background-color: #f8f9fa;\n                padding: 8px;\n                border-radius: 6px;\n                margin: 6px 0;\n                border-left: 3px solid #4285F4;\n            }\n\n            .incentive-type {\n                font-weight: 500;\n                color: #333;\n            }\n\n            .incentive-amount {\n                font-size: 16px;\n                font-weight: 600;\n                color: #2e7d32;\n                margin: 2px 0;\n            }\n\n            .incentive-info {\n                font-size: 12px;\n                color: #666;\n                font-style: italic;\n                margin-top: 4px;\n            }\n\n            .mini-chain-badge {\n                background: #4285F4;\n                color: white;\n                padding: 1px 6px;\n                border-radius: 8px;\n                font-size: 10px;\n                margin-left: 4px;\n            }\n\n            .chain-note {\n                font-size: 12px;\n                color: #666;\n                font-style: italic;\n                margin-top: 8px;\n                padding: 4px 8px;\n                background-color: #f0f8ff;\n                border-radius: 4px;\n            }\n\n            .info-actions {\n                margin-top: 12px;\n                padding-top: 12px;\n                border-top: 1px solid #eee;\n                text-align: center;\n                /* Add bottom margin to ensure spacing at bottom */\n                margin-bottom: 4px;\n            }\n\n            .enhanced-add-btn, .enhanced-view-btn {\n                background: linear-gradient(45deg, #4285F4, #64B5F6);\n                color: white;\n                border: none;\n                padding: 10px 20px;\n                border-radius: 8px;\n                cursor: pointer;\n                font-weight: 500;\n                font-size: 14px;\n                transition: all 0.2s ease;\n                width: 100%;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n            }\n\n            .enhanced-add-btn {\n                background: linear-gradient(45deg, #EA4335, #FF6B6B);\n            }\n\n            .enhanced-add-btn:hover, .enhanced-view-btn:hover {\n                transform: translateY(-1px);\n                box-shadow: 0 4px 8px rgba(0,0,0,0.15);\n            }\n\n            /* ENHANCED SCROLLBAR - More visible and styled */\n            .gm-style .gm-style-iw-d::-webkit-scrollbar {\n                width: 8px;\n                height: 8px;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-track {\n                background: #f1f1f1;\n                border-radius: 4px;\n                border: 1px solid #e0e0e0;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb {\n                background: linear-gradient(180deg, #4285F4, #64B5F6);\n                border-radius: 4px;\n                border: 1px solid #3367D6;\n                box-shadow: inset 0 1px 2px rgba(255,255,255,0.3);\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb:hover {\n                background: linear-gradient(180deg, #3367D6, #4285F4);\n                cursor: pointer;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb:active {\n                background: linear-gradient(180deg, #2A56C6, #3367D6);\n            }\n\n            /* Add padding indicator when content is scrollable */\n            .gm-style .gm-style-iw-d::before {\n                content: '';\n                display: block;\n                height: 1px;\n                width: 100%;\n                background: transparent;\n            }\n\n            .gm-style .gm-style-iw-d::after {\n                content: '';\n                display: block;\n                height: 1px;\n                width: 100%;\n                background: transparent;\n            }\n\n            /* Responsive adjustments */\n            @media (max-width: 400px) {\n                .enhanced-info-window {\n                    max-width: 280px;\n                    padding: 10px 10px 10px 10px !important;\n                }\n                \n                .enhanced-marker-container {\n                    width: 32px;\n                    height: 42px;\n                }\n                \n                .enhanced-marker-pin {\n                    width: 28px;\n                    height: 36px;\n                }\n\n                .gm-style .gm-style-iw-d::-webkit-scrollbar {\n                    width: 6px;\n                }\n            }\n\n            /* Fix for tail positioning */\n            .gm-style .gm-style-iw-t {\n                bottom: 0px !important;\n                left: 50% !important;\n                right: auto !important;\n                transform: translateX(-50%) !important;\n                width: 20px !important;\n                height: 15px !important;\n            }\n\n            /* Ensure close button is properly positioned */\n            .gm-ui-hover-effect {\n                opacity: 0.8 !important;\n                top: 8px !important;\n                right: 8px !important;\n                width: 24px !important;\n                height: 24px !important;\n                z-index: 1002 !important;\n            }\n\n            .gm-ui-hover-effect:hover {\n                opacity: 1 !important;\n            }\n        ",document.head.appendChild(e)}}function searchNearbyBusinesses(e,n){try{console.log("Searching for nearby similar businesses near",e.lat(),e.lng()),console.log("Primary business type:",n);const o=getSimilarBusinessTypes(n);if(console.log("Looking for similar business types:",o),0===o.length)return void console.log("No similar business types defined for:",n);const t=getBaseURL(),i=o.map((n=>{const o=`${t}/api/business.js?operation=search&type=${n}&lat=${e.lat()}&lng=${e.lng()}&radius=15`;return console.log("Searching for similar businesses:",o),fetch(o).then((e=>{if(!e.ok)throw new Error(`Failed to fetch businesses of type ${n}: ${e.status}`);return e.json()})).then((e=>({businessType:n,results:e.results||[]})))}));Promise.all(i).then((n=>{let o=[];if(n.forEach((e=>{e.results.length>0&&(console.log(`Found ${e.results.length} businesses of type ${e.businessType}`),o=o.concat(e.results))})),0===o.length)return void console.log("No similar businesses found in the area");console.log(`Found ${o.length} total potential similar businesses`);const t=markers.map((e=>e.business?._id)).filter((e=>e)),i=markers.map((e=>e.business?.bname.toLowerCase())).filter((e=>e)),s=o.filter((e=>{if(t.includes(e._id))return!1;const n=e.bname.toLowerCase();return!i.some((e=>n.includes(e)||e.includes(n)))}));console.log(`${s.length} new similar businesses to add to map`);let a=0;s.forEach((n=>{n.isNearby=!0,n.isSimilarBusiness=!0;const o=getBusinessLocation(n);if(o){const t=new google.maps.LatLng(o.lat,o.lng),i=google.maps.geometry.spherical.computeDistanceBetween(e,t);i<=24140?createSimilarBusinessMarker(n,t)&&(a++,console.log(`Added similar business: ${n.bname} (${(i/1609).toFixed(1)} miles) - ${getBusinessTypeLabel(n.type)}`)):console.log(`Skipping distant similar business: ${n.bname} (${(i/1609).toFixed(1)} miles)`)}else console.warn(`Similar business ${n.bname} missing coordinates`)})),console.log(`Added ${a} similar businesses with blue markers`)})).catch((e=>{console.error("Error searching for similar businesses:",e)}))}catch(e){console.error("Error in searchNearbyBusinesses:",e)}}function getSimilarBusinessTypes(e){return({HARDW:["HARDW","DEPT"],REST:["REST"],GROC:["GROC","CONV"],DEPT:["DEPT","RETAIL","HARDW"],CLTH:["CLTH","DEPT"],ELEC:["ELEC","DEPT","TECH"],FURN:["FURN","DEPT"],AUTO:["AUTO","FUEL"],BEAU:["BEAU","RX"],RX:["RX","BEAU","GROC"],ENTR:["ENTR"],SPRT:["SPRT","DEPT"],FUEL:["FUEL","CONV"],CONV:["CONV","FUEL","GROC"],SERV:["SERV"],OTHER:["OTHER","RETAIL"]}[e]||[e]).filter((n=>n!==e))}function getBusinessLocation(e){let n,o;if(e.location&&e.location.coordinates&&Array.isArray(e.location.coordinates)&&e.location.coordinates.length>=2)o=e.location.coordinates[0],n=e.location.coordinates[1];else{if(void 0===e.lat||void 0===e.lng)return null;n=parseFloat(e.lat),o=parseFloat(e.lng)}return isNaN(n)||isNaN(o)?null:{lat:n,lng:o}}function createSimilarBusinessMarker(e,n){try{return e.lat=n.lat(),e.lng=n.lng(),createEnhancedBusinessMarker(e,n,!0)}catch(o){return console.error("Error creating similar business marker:",o),createEnhancedFallbackMarker(e,n)}}async function createEnhancedBusinessMarker(e,n,o=!1){try{const{AdvancedMarkerElement:t}=await google.maps.importLibrary("marker");let i=createSafeLatLng(n);if(!i)return console.error("Invalid position for enhanced marker:",n),createEnhancedFallbackMarker(e,n);const s=!e.isGooglePlace;let a,r;o||!0===e.isNearby||!0===e.isSimilarBusiness||e.isSimilarBusiness?(a=CONFIG.markerColors.nearby,r="nearby"):s?(a=CONFIG.markerColors.primary,r="primary"):(a=CONFIG.markerColors.nearby,r="nearby");const l=getBusinessTypeTextIcon(e.type),c=document.createElement("div");c.className="enhanced-custom-marker",c.setAttribute("title",e.bname),c.style.cursor="pointer",c.innerHTML=`\n            <div class="enhanced-marker-container">\n                <div class="enhanced-marker-pin ${r}" style="background-color: ${a};">\n                    <div class="enhanced-marker-icon">\n                        ${l}\n                    </div>\n                </div>\n                <div class="enhanced-marker-shadow"></div>\n                ${e.chain_id?'<div class="chain-indicator">â­</div>':""}\n                ${e.isSimilarBusiness?'<div class="similar-indicator">â‰ˆ</div>':""}\n            </div>\n        `;const d=new t({position:i,map,title:e.bname,content:c,collisionBehavior:s?"REQUIRED_AND_HIDES_OPTIONAL":"OPTIONAL_AND_HIDES_LOWER_PRIORITY"});return d.business=e,d.position=i,d.isFromDatabase=s,d.isSimilarBusiness=e.isSimilarBusiness||o,c.addEventListener("click",(function(n){console.log("Enhanced similar business marker clicked:",e.bname),n.stopPropagation(),showEnhancedInfoWindow(d)})),c.addEventListener("mouseenter",(function(){c.style.transform="scale(1.1)",c.style.zIndex="1000"})),c.addEventListener("mouseleave",(function(){c.style.transform="scale(1)",c.style.zIndex="auto"})),markers.push(d),console.log(`Added enhanced ${e.isSimilarBusiness?"similar business":""} marker for ${e.bname}`),d}catch(o){return console.error("Error creating enhanced marker:",o),createEnhancedFallbackMarker(e,n)}}window.initGoogleMap=function(){console.log("Enhanced initGoogleMap function called");try{applyMapHeightFix();const e=document.getElementById("map");if(!e)return void console.error("Map container not found in the DOM");console.log("Map container dimensions:",e.offsetWidth,"x",e.offsetHeight),map?(console.log("Map already exists, applying height fix and triggering resize"),applyMapHeightFix(),setTimeout((()=>{google.maps.event.trigger(map,"resize")}),100)):(map=new google.maps.Map(e,{center:CONFIG.defaultCenter,zoom:CONFIG.defaultZoom,mapId:CONFIG.mapId||"ebe8ec43a7bc252d",clickableIcons:!0,gestureHandling:"greedy",zoomControl:!0,mapTypeControl:!1,scaleControl:!0,streetViewControl:!1,rotateControl:!1,fullscreenControl:!0}),console.log("Map object created with enhanced settings:",!!map),infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1,pixelOffset:new google.maps.Size(0,-10)}),bounds=new google.maps.LatLngBounds,addInitialMapMessage(e),setupResetMapButton(),mapInitialized=!0,console.log("Google Map successfully initialized with enhanced settings"),pendingBusinessesToDisplay.length>0&&(console.log("Processing pending businesses to display on map"),displayBusinessesOnMap(pendingBusinessesToDisplay),pendingBusinessesToDisplay=[]),setupMapClickHandler(),setupMarkerClickPriority(),initAdditionalMapFeatures(),setTimeout((()=>{google.maps.event.trigger(map,"resize")}),200))}catch(e){console.error("Error initializing Google Map:",e),mapInitialized=!1;const n=document.getElementById("map");n&&(n.innerHTML=`\n                <div style="text-align: center; padding: 20px;">\n                    <p>Sorry, we couldn't load the map. Please try refreshing the page.</p>\n                    <p>Error: ${e.message}</p>\n                </div>\n            `)}},window.focusOnMapMarker=function(e){if(console.log("focusOnMapMarker called for business ID:",e),!mapInitialized||!map)return console.error("Map not initialized yet - cannot focus on marker"),void alert("Map is still loading. Please try again in a moment.");if(!markers||0===markers.length)return console.warn("No markers available yet."),void fetchBusinessAndCreateMarker(e);const n=markers.find((n=>n.business&&n.business._id===e));if(n)try{let o;if(n.getPosition&&"function"==typeof n.getPosition)o=n.getPosition();else if(n.position)o=n.position;else{if(!(n.business&&n.business.lat&&n.business.lng))return console.error("Could not determine marker position"),void alert("Could not focus on this business on the map.");o=new google.maps.LatLng(parseFloat(n.business.lat),parseFloat(n.business.lng))}map.setCenter(o),map.setZoom(16),showEnhancedInfoWindow(n),document.getElementById("map").scrollIntoView({behavior:"smooth"}),console.log("Successfully focused on marker for business:",e)}catch(e){console.error("Error focusing on marker:",e),alert("There was an error focusing on this business on the map.")}else console.warn(`No marker found for business ID: ${e}`),fetchBusinessAndCreateMarker(e)},document.addEventListener("DOMContentLoaded",(function(){console.log("DOM loaded, initializing enhanced business search..."),addEnhancedMarkerStyles(),setTimeout((()=>{applyInfoWindowPositioningFixes(),applyMapHeightFix(),applyInfoWindowCSS(),applyCSSOnlyTailFix(),applyInfoWindowPositioningFixes(),removeProblematicInfoWindowCSS()}),500),addCustomMarkerStyles(),addChainBadgeStyles(),initBusinessSearch(),checkForNewlyAddedBusiness(),window.google&&window.google.maps?(console.log("Google Maps already loaded, initializing map"),initGoogleMap()):console.log("Google Maps not yet loaded, will be initialized via callback")}));const COMPREHENSIVE_CHAIN_DATABASE={homedepot:{id:"681fe0e67d92c3d3e1e2a3da",canonicalName:"The Home Depot",variations:["home depot","the home depot","homedepot","home depot store","the home depot store"],keywords:["home","depot","hardware","improvement"]},olivegardenitalian:{id:"olive_garden_chain_id",canonicalName:"Olive Garden",variations:["olive garden","olive garden italian restaurant","olive garden italian","olivegarden","olive garden restaurant"],keywords:["olive","garden","italian","restaurant","pasta"]},lowes:{id:"lowes_chain_id",canonicalName:"Lowe's",variations:["lowes","lowe's","lowes home improvement","lowe's home improvement","lowes companies","lowe's companies"],keywords:["lowes","lowe's","home","improvement","hardware"]},mcdonalds:{id:"mcdonalds_chain_id",canonicalName:"McDonald's",variations:["mcdonalds","mcdonald's","mickey d's","micky d's","mcdonalds restaurant","mcdonald's restaurant"],keywords:["mcdonalds","mcdonald's","fast","food","burger"]},walmart:{id:"walmart_chain_id",canonicalName:"Walmart",variations:["walmart","wal-mart","walmart supercenter","wal-mart supercenter","walmart store","wal-mart store"],keywords:["walmart","wal-mart","supercenter","retail"]},target:{id:"target_chain_id",canonicalName:"Target",variations:["target","target store","target corporation","target retail"],keywords:["target","retail","store"]},bestbuy:{id:"bestbuy_chain_id",canonicalName:"Best Buy",variations:["best buy","bestbuy","best buy store","bestbuy store"],keywords:["best","buy","electronics","tech"]},starbucks:{id:"starbucks_chain_id",canonicalName:"Starbucks",variations:["starbucks","starbucks coffee","starbucks corporation","starbucks store"],keywords:["starbucks","coffee","cafe"]}};function calculateSimilarity(e,n){if(!e||!n)return 0;const o=e.toLowerCase().trim(),t=n.toLowerCase().trim();if(o===t)return 1;if(o.includes(t)||t.includes(o))return.9;const i=1-levenshteinDistance(o,t)/Math.max(o.length,t.length);return Math.max(0,i)}function levenshteinDistance(e,n){const o=[];for(let e=0;e<=n.length;e++)o[e]=[e];for(let n=0;n<=e.length;n++)o[0][n]=n;for(let t=1;t<=n.length;t++)for(let i=1;i<=e.length;i++)n.charAt(t-1)===e.charAt(i-1)?o[t][i]=o[t-1][i-1]:o[t][i]=Math.min(o[t-1][i-1]+1,o[t][i-1]+1,o[t-1][i]+1);return o[n.length][e.length]}function extractKeywords(e){if(!e)return[];const n=["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","up","about","into","over","after","store","restaurant","inc","llc","corp","company","companies"];return e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter((e=>e.length>1&&!n.includes(e))).filter(Boolean)}async function findMatchingChainForPlaceResult(e){try{if(!e)return null;console.log("ðŸ” Advanced chain matching for:",e);const n=e.trim();let o=null,t=0;const i=.7;try{const e=await tryServerSideChainMatching(n);if(e)return console.log("âœ… Server-side exact match found:",e.bname),e}catch(e){console.warn("Server-side matching failed, using local matching:",e.message)}const s=extractKeywords(n);console.log("ðŸ·ï¸ Search keywords:",s);for(const[e,a]of Object.entries(COMPREHENSIVE_CHAIN_DATABASE)){for(const e of a.variations){const s=calculateSimilarity(n,e);s>t&&s>=i&&(t=s,o={_id:a.id,bname:a.canonicalName,matchType:"variation",matchScore:s,matchedVariation:e})}const e=s.filter((e=>a.keywords.some((n=>calculateSimilarity(e,n)>=.8))));if(e.length>=2){const n=.8;n>t&&(t=n,o={_id:a.id,bname:a.canonicalName,matchType:"keywords",matchScore:n,matchedKeywords:e})}}if(o){console.log(`ðŸŽ¯ Best match found: "${n}" â†’ "${o.bname}" (${o.matchType}, score: ${o.matchScore.toFixed(2)})`);try{const e=await getChainFromDatabase(o.bname);if(e)return e}catch(e){console.warn("Could not fetch chain from database:",e)}return o}return console.log("âŒ No suitable chain match found for:",n),null}catch(e){return console.error("Error in advanced chain matching:",e),null}}async function tryServerSideChainMatching(e){const n=getBaseURL(),o=[e,...generateNameVariations(e)];for(const e of o)try{const o=await fetch(`${n}/api/business.js?operation=find_matching_chain&place_name=${encodeURIComponent(e)}`);if(o.ok){const n=await o.json();if(n.success&&n.chain)return console.log(`Server match found with "${e}":`,n.chain.bname),n.chain}}catch(e){continue}return null}async function getChainFromDatabase(e){try{const n=getBaseURL(),o=await fetch(`${n}/api/business.js?operation=search&business_name=${encodeURIComponent(e)}&is_chain=true`);if(o.ok){const e=await o.json();if(e.results&&e.results.length>0){const n=e.results.find((e=>!0===e.is_chain));if(n)return{_id:n._id,bname:n.bname}}}return null}catch(e){return console.error("Error fetching chain from database:",e),null}}function generateNameVariations(e){const n=[],o=e.toLowerCase();return o.startsWith("the ")?n.push(e.substring(4)):n.push("The "+e),[" italian restaurant"," italian"," restaurant"," store"," location"," home improvement"," companies"," corporation"," corp"," inc"," llc"].forEach((t=>{o.includes(t.toLowerCase())&&n.push(e.replace(new RegExp(t,"gi"),"").trim())})),[" restaurant"," store"].forEach((t=>{o.includes(t.toLowerCase())||n.push(e+t)})),[...new Set(n)].filter((n=>n!==e))}async function retrieveFromMongoDB(e,n=!1){try{console.log("ðŸ” Starting enhanced search with form data:",e);const o=document.getElementById("business-search-results")||document.getElementById("search_table");o&&(o.innerHTML='<div class="loading-indicator" id="main-loading">Searching for businesses...</div>',o.style.display="block");let t=null;if(e.useMyLocation)try{updateLoadingMessage("Getting your location..."),t=await getUserLocation(),window.currentSearchLocation=t}catch(e){return console.error("Error getting user location:",e),hideLoadingIndicator(),void alert("Unable to get your current location. Please try entering an address instead.")}else if(e.address&&""!==e.address.trim())try{updateLoadingMessage("Finding location...");const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw new Error(`Geocoding failed for address: ${e.address}`);if(t=n,window.currentSearchLocation=t,map&&t){const e=new google.maps.LatLng(t.lat,t.lng);map.setCenter(e),map.setZoom(11)}}catch(e){return console.error("Error geocoding address:",e),hideLoadingIndicator(),void alert("We couldn't recognize that address. Please try a more specific address.")}updateLoadingMessage("Searching database...");const i=await searchDatabaseWithFuzzyMatching(e,t,n);console.log(`ðŸ“Š Database search returned ${i.length} businesses`);let s=[],a=[];i&&i.length>0&&i.forEach((e=>{const n=getBusinessLocation(e);if(!n||!t)return void a.push(e);const o=new google.maps.LatLng(n.lat,n.lng),i=new google.maps.LatLng(t.lat,t.lng);621371e-9*google.maps.geometry.spherical.computeDistanceBetween(o,i)<=50?s.push(e):a.push(e)})),console.log(`ðŸ“ Location analysis: ${s.length} nearby, ${a.length} distant`);const r=[...s,...a];if(r.length>0){if(console.log("âœ… Found businesses in database, displaying those first"),updateLoadingMessage("Loading results..."),hideLoadingIndicator(),displayBusinessesOnMap(r),displaySearchResults(r),t&&0===s.length&&e.businessName&&(console.log("ðŸŒ No nearby database businesses, supplementing with Google Places"),await supplementWithGooglePlaces(e.businessName,t,r)),t){searchNearbyBusinesses(new google.maps.LatLng(t.lat,t.lng),r[0].type||"OTHER")}}else if(e.businessName&&t){console.log("ðŸŒ No database businesses found, searching Google Places"),updateLoadingMessage("Searching Google Places...");try{const n=await searchGooglePlacesForBusiness(e.businessName,t);n&&n.length>0?(console.log(`ðŸ“ Found ${n.length} businesses via Google Places`),updateLoadingMessage("Loading results..."),hideLoadingIndicator(),displayBusinessesOnMap(n),displaySearchResults(n)):(hideLoadingIndicator(),showNoResultsMessage())}catch(e){console.error("Error searching Google Places:",e),hideLoadingIndicator(),showErrorMessage("Error searching for businesses. Please try again.")}}else hideLoadingIndicator(),showNoResultsMessage()}catch(e){console.error("Enhanced search error:",e),hideLoadingIndicator(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}async function supplementWithGooglePlaces(e,n,o){try{console.log("ðŸ” Supplementing with Google Places for:",e);const t=await searchGooglePlacesForBusiness(e,n);if(t&&t.length>0){console.log(`ðŸ“ Found ${t.length} additional businesses via Google Places`);const e=o.map((e=>`${e.address1} ${e.city} ${e.state}`.toLowerCase().replace(/\s+/g," "))),n=t.filter((n=>{const o=`${n.address1} ${n.city} ${n.state}`.toLowerCase().replace(/\s+/g," ");return!e.some((e=>e.includes(o)||o.includes(e)))}));n.length>0&&(console.log(`ðŸ“ Adding ${n.length} new Google Places results`),n.forEach((e=>{createBusinessMarker(e)})),displaySearchResults([...o,...n]))}}catch(e){console.error("Error supplementing with Google Places:",e)}}function fetchBusinessIncentives(e,n=null){if(!e)return void console.error("No business ID provided for fetching incentives");console.log(`ðŸŽ Fetching incentives for business: ${e}, chain: ${n}`);let o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${e}`;n&&(o+=`&chain_id=${n}`),console.log("Fetching incentives from: ",o),fetch(o).then((e=>{if(!e.ok)throw new Error(`Failed to fetch incentives: ${e.status} ${e.statusText}`);return e.json()})).then((n=>{console.log(`Incentives data for business ${e}:`,n);const o=document.getElementById(`incentives-for-${e}`);if(!o)return void console.error(`Could not find cell for incentives-for-${e}`);if(!n.results||0===n.results.length)return console.log(`No incentives found for business ${e}`),void(o.innerHTML="No incentives found");let t="";n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"",i=e.is_chain_wide?'<span class="chain-badge small">Chain-wide</span>':"";t+=`\n                        <div class="incentive-item">\n                            <strong>${n}${o}:</strong> ${e.amount}% ${i}\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),o.innerHTML=""===t?"No active incentives found":t,console.log(`âœ… Successfully loaded incentives for business ${e}`)})).catch((n=>{console.error(`Error fetching incentives for business ${e}:`,n);const o=document.getElementById(`incentives-for-${e}`);o&&(o.innerHTML="Error loading incentives")}))}function addBusinessRow(e,n,o){if(!e)return;if(!0===e.is_chain)return void console.log(`Skipping parent chain business in table: ${e.bname}`);let t="";if(e.address1)t=e.address2?`${e.address1}<br>${e.address2}<br>${e.city}, ${e.state} ${e.zip}`:`${e.address1}<br>${e.city}, ${e.state} ${e.zip}`;else{if(!e.formattedAddress)return void console.warn(`Business ${e.bname} has no address information`);t=e.formattedAddress.replace(/,/g,"<br>")}const i=getBusinessTypeLabel(e.type),s=!!e.chain_id,a=!!e.isGooglePlace;let r,l="";s&&(l='<span class="chain-badge">Chain Location</span>'),r=a?s?`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${e.placeId||""}', '${e.chain_id||""}')">Add Chain Location</button>`:`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${e.placeId||""}')">Add to Database</button>`:`<button class="view-map-btn" onclick="focusOnMapMarker('${e._id}')">View on Map</button>`;const c=document.createElement("tr");c.innerHTML=`\n        <th class="left_table" data-business-id="${e._id}">\n            ${e.bname} ${l}\n        </th>\n        <th class="left_table">${t}</th>\n        <th class="left_table">${i}</th>\n        <th class="right_table" id="incentives-for-${e._id}">\n            ${o&&!s?"Not in database yet":"Loading incentives..."}\n        </th>\n        <th class="center_table">${r}</th>\n    `,n.appendChild(c),o&&s?(console.log(`ðŸ”— Loading chain incentives for Google Places result: ${e.bname}`),fetchChainIncentivesForPlacesResult(e._id,e.chain_id)):a||(console.log(`ðŸ¢ Loading incentives for database business: ${e.bname} (ID: ${e._id})`),setTimeout((()=>{fetchBusinessIncentives(e._id,e.chain_id)}),100))}function createBusinessMarker(e){try{if(console.log(`ðŸ” MARKER DEBUG: Creating marker for ${e.bname}`),console.log(`   - isGooglePlace: ${e.isGooglePlace}`),console.log(`   - _id: ${e._id}`),console.log("   - Source: "+(e._id?.startsWith("google_")?"GOOGLE PLACES":"DATABASE")),!e.lat||!e.lng||isNaN(parseFloat(e.lat))||isNaN(parseFloat(e.lng)))return console.warn(`âŒ Invalid coordinates for business: ${e.bname}`),null;const n=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng)),o=!e.isGooglePlace&&!e._id?.startsWith("google_");e.isFromDatabase=o,e.isGooglePlace=!o,console.log(`ðŸ·ï¸ FINAL DETERMINATION: ${e.bname} â†’ ${o?"DATABASE (RED MARKER)":"GOOGLE PLACES (BLUE MARKER)"}`);const t=createEnhancedBusinessMarkerFixed(e,n,o);return t&&bounds&&bounds.extend(n),t}catch(e){return console.error("âŒ Error creating business marker:",e),null}}function fetchBusinessIncentivesFixed(e,n=null){e&&!e.startsWith("google_")?(console.log(`ðŸŽ INCENTIVES DEBUG: Fetching for business ID: ${e}`),console.log(`   - Chain ID: ${n||"None"}`),setTimeout((()=>{const n=document.getElementById(`incentives-for-${e}`);if(!n){console.error(`âŒ Could not find incentives cell for business ${e}`),console.log(`   - Looking for element ID: incentives-for-${e}`);const n=document.querySelectorAll('[id*="incentives-for"]');return void console.log("ðŸ” Available incentive elements:",Array.from(n).map((e=>e.id)))}console.log(`âœ… Found incentives cell for ${e}`),n.innerHTML='<span class="loading-incentives">Loading incentives...</span>';const o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${e}`;console.log(`ðŸŒ Fetching incentives from: ${o}`),fetch(o).then((e=>{if(console.log(`ðŸ“¡ Incentives API response status: ${e.status}`),!e.ok)throw new Error(`Failed to fetch incentives: ${e.status} ${e.statusText}`);return e.json()})).then((o=>{if(console.log(`ðŸ“Š Incentives data for business ${e}:`,o),!o.results||0===o.results.length)return console.log(`â„¹ï¸ No incentives found for business ${e}`),void(n.innerHTML='<em style="color: #666;">No incentives available</em>');let t="",i=0;o.results.forEach((e=>{if(e.is_available){i++;const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"",s=e.is_chain_wide?'<span class="chain-badge small">Chain-wide</span>':"";t+=`\n                            <div class="incentive-item">\n                                <strong>${n}${o}:</strong> ${e.amount}% ${s}\n                                ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                            </div>\n                        `}})),0===i?n.innerHTML='<em style="color: #666;">No active incentives found</em>':(n.innerHTML=t,console.log(`âœ… Successfully loaded ${i} incentives for business ${e}`))})).catch((o=>{console.error(`âŒ Error fetching incentives for business ${e}:`,o),n.innerHTML='<span class="incentives-error">Error loading incentives</span>'}))}),200)):console.log(`â­ï¸ Skipping incentives for Google Places business: ${e}`)}function addBusinessRowFixed(e,n,o){if(!e)return;if(!0===e.is_chain)return void console.log(`â­ï¸ Skipping parent chain business in table: ${e.bname}`);console.log(`ðŸ“ Adding table row for: ${e.bname}`),console.log(`   - Is from Places: ${o}`),console.log(`   - Business ID: ${e._id}`),console.log(`   - Is chain location: ${!!e.chain_id}`);let t="";if(e.address1)t=e.address2?`${e.address1}<br>${e.address2}<br>${e.city}, ${e.state} ${e.zip}`:`${e.address1}<br>${e.city}, ${e.state} ${e.zip}`;else{if(!e.formattedAddress)return void console.warn(`âŒ Business ${e.bname} has no address information`);t=e.formattedAddress.replace(/,/g,"<br>")}const i=getBusinessTypeLabel(e.type),s=!!e.chain_id,a=!!e.isGooglePlace;let r,l="";s&&(l='<span class="chain-badge">Chain Location</span>'),r=a?s?`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${e.placeId||""}', '${e.chain_id||""}')">Add Chain Location</button>`:`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${e.placeId||""}')">Add to Database</button>`:`<button class="view-map-btn" onclick="focusOnMapMarker('${e._id}')">View on Map</button>`;const c=document.createElement("tr");c.innerHTML=`\n        <th class="left_table" data-business-id="${e._id}">\n            ${e.bname} ${l}\n        </th>\n        <th class="left_table">${t}</th>\n        <th class="left_table">${i}</th>\n        <th class="right_table" id="incentives-for-${e._id}">\n            ${o&&!s?"Not in database yet":'<span class="loading-incentives">Loading incentives...</span>'}\n        </th>\n        <th class="center_table">${r}</th>\n    `,n.appendChild(c),a?s?(console.log(`ðŸ”— Scheduling chain incentives load for Google Places: ${e.bname}`),fetchChainIncentivesForPlacesResult(e._id,e.chain_id)):console.log(`â„¹ï¸ No incentives to load for non-chain Google Places: ${e.bname}`):(console.log(`ðŸŽ Scheduling incentives load for database business: ${e.bname} (ID: ${e._id})`),fetchBusinessIncentivesFixed(e._id,e.chain_id))}function updateLoadingMessage(e){const n=document.getElementById("main-loading");n&&(n.innerHTML=`<div class="loading-text">${e}</div><div class="loading-spinner"></div>`)}function hideLoadingIndicator(){const e=document.getElementById("main-loading");e&&e.remove(),document.querySelectorAll(".loading-indicator").forEach((e=>{("main-loading"===e.id||e.textContent.includes("Searching"))&&e.remove()}))}function showNoResultsMessage(){hideLoadingIndicator();const e=document.getElementById("business-search-results")||document.getElementById("search_table");e&&(e.innerHTML='<div class="error-message">No businesses found matching your search criteria in this area.</div>',e.style.display="block")}function showErrorMessage(e){hideLoadingIndicator();const n=document.getElementById("business-search-results")||document.getElementById("search_table");n&&(n.innerHTML=`<div class="error-message">${e}</div>`,n.style.display="block")}async function searchDatabaseWithFuzzyMatching(e,n,o){const t={};e.businessName&&""!==e.businessName.trim()&&(t.business_name=e.businessName),e.address&&""!==e.address.trim()&&!n&&(t.address=e.address),n&&n.lat&&n.lng&&(t.lat=n.lat,t.lng=n.lng,t.radius=25),o&&(t.ts=(new Date).getTime());const i=new URLSearchParams(t).toString(),s=`${getBaseURL()}/api/business.js?operation=search&${i}`,a=await fetch(s,{method:"GET",headers:{"Content-Type":"application/json; charset=UTF-8","Cache-Control":o?"no-cache, no-store, must-revalidate":"default"}});if(!a.ok)throw new Error(`Database search failed: ${a.status}`);const r=(await a.json()).results||[],l=r.filter((e=>!0===e.is_chain?(console.log(`Filtering out parent chain business: ${e.bname}`),!1):!(n&&!hasValidCoordinates(e))||(console.log(`Filtering out business without valid coordinates: ${e.bname}`),!1)));return console.log(`ðŸ“Š Filtered ${r.length} raw results to ${l.length} location businesses`),l}function hasValidCoordinates(e){if(void 0!==e.lat&&void 0!==e.lng){const n=parseFloat(e.lat),o=parseFloat(e.lng);return!isNaN(n)&&!isNaN(o)&&0!==n&&0!==o}if(e.location&&e.location.coordinates&&Array.isArray(e.location.coordinates)&&e.location.coordinates.length>=2){const n=parseFloat(e.location.coordinates[0]),o=parseFloat(e.location.coordinates[1]);return!isNaN(o)&&!isNaN(n)&&0!==o&&0!==n}return!1}function buildEnhancedInfoWindowContentFixed2(e){const n=!0===e.isGooglePlace,o=!!e.chain_id,t=!n;let i="";if(e.address1){i=`<div class="info-address">\n            <strong>ðŸ“ Address:</strong><br>\n            ${e.address1}`,e.address2&&(i+=`<br>${e.address2}`);const n=[];e.city&&n.push(e.city),e.state&&n.push(e.state),e.zip&&n.push(e.zip),n.length>0&&(i+=`<br>${n.join(", ")}`),i+="</div>"}else if(e.formattedAddress){const n=e.formattedAddress.split(",").map((e=>e.trim()));i='<div class="info-address">\n            <strong>ðŸ“ Address:</strong><br>',n.length>=1&&(i+=n[0]),n.length>=2&&(i+=`<br>${n.slice(1).join(", ")}`),i+="</div>"}const s=e.phone?`<div class="info-phone"><strong>ðŸ“ž Phone:</strong> <a href="tel:${e.phone.replace(/\D/g,"")}" style="color: #4285F4; text-decoration: none;">${e.phone}</a></div>`:"";let a="";e.type&&"OTHER"!==e.type&&(a=`<div class="info-type"><strong>ðŸ¢ Type:</strong> ${getBusinessTypeLabel(e.type)}</div>`);const r=e.distance?`<div class="info-distance"><strong>ðŸ“ Distance:</strong> ${(e.distance/1609).toFixed(1)} miles</div>`:"",l=o?`<span class="enhanced-chain-badge">ðŸ”— ${e.chain_name||"Chain Location"}</span>`:"";let c,d="",g="";n?o?(d='<div class="info-status chain-match">ðŸ”— This location appears to match a chain in our database!</div>',g=`<div class="chain-explanation">\n                âœ¨ Great news! This location matches <strong>${e.chain_name}</strong> in our database. \n                Chain-wide incentives should apply to this location once added.\n            </div>`):d='<div class="info-status google-place">â„¹ï¸ This business is not yet in the Patriot Thanks database.</div>':d='<div class="info-status database-business">âœ… This business is in the Patriot Thanks database.</div>',c=n?o?`\n                <button class="enhanced-add-btn chain-add" onclick="window.addBusinessToDatabase('${e.placeId}', '${e.chain_id}')">\n                    ðŸ”— Add ${e.chain_name} Location\n                </button>\n            `:`\n                <button class="enhanced-add-btn" onclick="window.addBusinessToDatabase('${e.placeId}')">\n                    âž• Add to Patriot Thanks\n                </button>\n            `:`\n            <button class="enhanced-view-btn" onclick="window.viewBusinessDetails('${e._id}')">\n                ðŸ‘ï¸ View Details\n            </button>\n        `;const p=n?`google_${e.placeId}`:e._id;let u;return console.log(`ðŸ†” INFO WINDOW: Using container ID: ${p} for business: ${e.bname}`),u=t&&o?"<em>â³ Loading chain incentives...</em>":t?"<em>â³ Loading incentives...</em>":n&&o?"<em>â³ Loading chain incentives...</em>":"<em>ðŸ’¡ Add this business to see available incentives.</em>",`\n        <div class="enhanced-info-window">\n            <div class="info-header">\n                <h3>${e.bname} ${l}</h3>\n            </div>\n            \n            <div class="info-body">\n                ${i}\n                ${s}\n                ${a}\n                ${r}\n                ${d}\n                ${g}\n                \n                <div class="info-incentives">\n                    <div id="incentives-container-${p}">\n                        ${u}\n                    </div>\n                </div>\n            </div>\n            \n            <div class="info-actions">\n                ${c}\n            </div>\n        </div>\n    `}function showEnhancedInfoWindowFixed2(e){if(console.log("ðŸªŸ INFO WINDOW: Showing enhanced info window for:",e.business?.bname),!e||!e.business)return void console.error("âŒ Invalid marker for info window");const n=e.business,o=!0===n.isGooglePlace,t=!!n.chain_id,i=!o;infoWindow&&infoWindow.close(),infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1});const s=buildEnhancedInfoWindowContentFixed2(n);infoWindow.setContent(s);let a=e.position;if(!a&&e.getPosition&&(a=e.getPosition()),a||(a=createSafeLatLng(n)),a){try{map.panTo(a)}catch(e){console.warn("âš ï¸ Error panning to position:",e)}setTimeout((()=>{try{e.getPosition?infoWindow.open(map,e):(infoWindow.setPosition(a),infoWindow.open(map)),console.log("âœ… Info window opened successfully"),google.maps.event.addListenerOnce(infoWindow,"domready",(function(){setTimeout((()=>{applyEnhancedInfoWindowFixes();const e=o?`google_${n.placeId}`:n._id;console.log(`ðŸŽ INCENTIVES: Loading for container ID: ${e}`),i&&t?(console.log(`ðŸ”— Loading chain incentives for database business: ${n.bname}`),loadChainIncentivesForDatabaseBusinessFixed(e,n.chain_id)):i?(console.log(`ðŸ¢ Loading regular incentives for database business: ${n.bname}`),loadIncentivesForEnhancedWindowFixed(e)):o&&t&&(console.log(`ðŸŒ Loading chain incentives for Google Places: ${n.bname}`),loadChainIncentivesForEnhancedWindowFixed(e,n.chain_id))}),300)}))}catch(e){console.error("âŒ Error opening info window:",e)}}),200)}else console.error("âŒ Could not determine position for info window")}function loadChainIncentivesForEnhancedWindowFixed(e,n){console.log(`ðŸ”— CHAIN INCENTIVES: Loading for container ${e}, chain ${n}`);const o=document.getElementById(`incentives-container-${e}`);if(!o){console.error(`âŒ Container not found: incentives-container-${e}`);const n=document.querySelectorAll('[id*="incentives-container"]');return void console.log("ðŸ” Available containers:",Array.from(n).map((e=>e.id)))}console.log(`âœ… Found container: incentives-container-${e}`);const t=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${n}`;console.log(`ðŸŒ Fetching chain incentives from: ${t}`),fetch(t).then((e=>{if(!e.ok)throw new Error(`Chain incentives API failed: ${e.status}`);return e.json()})).then((n=>{if(console.log("ðŸ“Š Chain incentives data:",n),!n.results||0===n.results.length)return void(o.innerHTML="<em>ðŸ’­ No chain incentives available</em>");let t='<div class="incentives-header"><strong>ðŸŽ Chain-wide Incentives:</strong></div>';t+='<div class="incentives-list">',n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"";t+=`\n                        <div class="incentive-item chain-incentive">\n                            <div class="incentive-type">${n}${o}:</div>\n                            <div class="incentive-amount">${e.amount}% <span class="mini-chain-badge">ðŸ”— Chain-wide</span></div>\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),t+="</div>",t+='<div class="chain-note">âœ¨ Great! These incentives apply to all locations of this chain.</div>',o.innerHTML=t,console.log(`âœ… Successfully loaded chain incentives for ${e}`)})).catch((e=>{console.error("âŒ Error loading chain incentives:",e),o.innerHTML="<em>âŒ Error loading chain incentives</em>"}))}function loadIncentivesForEnhancedWindowFixed(e){console.log(`ðŸ¢ REGULAR INCENTIVES: Loading for container ${e}`);const n=document.getElementById(`incentives-container-${e}`);if(!n)return void console.error(`âŒ Container not found: incentives-container-${e}`);const o=getBaseURL();fetch(`${o}/api/combined-api.js?operation=incentives&business_id=${e}`).then((e=>e.json())).then((o=>{if(!o.results||0===o.results.length)return void(n.innerHTML="<em>ðŸ’­ No incentives available</em>");let t='<div class="incentives-header"><strong>ðŸŽ Available Incentives:</strong></div>';t+='<div class="incentives-list">',o.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"",i=e.is_chain_wide?'<span class="mini-chain-badge">ðŸ”— Chain-wide</span>':"";t+=`\n                        <div class="incentive-item">\n                            <div class="incentive-type">${n}${o}:</div>\n                            <div class="incentive-amount">${e.amount}% ${i}</div>\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),t+="</div>",n.innerHTML=t,console.log(`âœ… Successfully loaded regular incentives for ${e}`)})).catch((e=>{console.error("âŒ Error loading incentives:",e),n.innerHTML="<em>âŒ Error loading incentives</em>"}))}function loadChainIncentivesForDatabaseBusinessFixed(e,n){console.log(`ðŸ”— DATABASE CHAIN INCENTIVES: Loading for container ${e}, chain ${n}`);const o=document.getElementById(`incentives-container-${e}`);if(!o)return void console.error(`âŒ Container not found: incentives-container-${e}`);const t=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${n}`;console.log(`ðŸŒ Fetching database chain incentives from: ${t}`),fetch(t).then((e=>{if(!e.ok)throw new Error(`Chain incentives API failed: ${e.status}`);return e.json()})).then((n=>{if(console.log("ðŸ“Š Database chain incentives data:",n),!n.results||0===n.results.length)return void(o.innerHTML="<em>ðŸ’­ No chain incentives available</em>");let t='<div class="incentives-header"><strong>ðŸŽ Available Incentives:</strong></div>';t+='<div class="incentives-list">',n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"";t+=`\n                        <div class="incentive-item chain-incentive">\n                            <div class="incentive-type">${n}${o}:</div>\n                            <div class="incentive-amount">${e.amount}% <span class="mini-chain-badge">ðŸ”— Chain-wide</span></div>\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),t+="</div>",o.innerHTML=t,console.log(`âœ… Successfully loaded database chain incentives for ${e}`)})).catch((e=>{console.error("âŒ Error loading database chain incentives:",e),o.innerHTML="<em>âŒ Error loading chain incentives</em>"}))}async function findMatchingChainForPlaceResultFixed(e){try{if(!e)return null;console.log("ðŸ” CACHED CHAIN MATCHING: Checking for:",e);const n=e.trim().toLowerCase();if(chainMatchCache.has(n)){const o=chainMatchCache.get(n);return console.log(`ðŸ’¾ CACHE HIT: ${e} â†’ ${o?o.bname:"No match"}`),o}const o=await findMatchingChainLocallyEnhanced(e);return o?(console.log(`ðŸ  LOCAL MATCH: ${e} â†’ ${o.bname}`),chainMatchCache.set(n,o),o):new Promise((o=>{apiCallQueue.push({placeName:e,cleanName:n,resolve:o}),processApiQueue()}))}catch(e){return console.error("âŒ Error in cached chain matching:",e),null}}async function processApiQueue(){if(!isProcessingQueue&&0!==apiCallQueue.length){for(isProcessingQueue=!0;apiCallQueue.length>0;){const{placeName:e,cleanName:n,resolve:o}=apiCallQueue.shift();try{console.log(`ðŸŒ API QUEUE: Processing ${e} (${apiCallQueue.length} remaining)`);const t=await tryServerSideChainMatchingOptimized(e);t?(console.log(`âœ… SERVER MATCH: ${e} â†’ ${t.bname}`),chainMatchCache.set(n,t),o(t)):(console.log(`âŒ NO MATCH: ${e}`),chainMatchCache.set(n,null),o(null)),apiCallQueue.length>0&&await new Promise((e=>setTimeout(e,200)))}catch(t){console.error(`âŒ API queue error for ${e}:`,t),chainMatchCache.set(n,null),o(null),apiCallQueue.length>0&&await new Promise((e=>setTimeout(e,500)))}}isProcessingQueue=!1}}function findMatchingChainLocallyEnhanced(e){return new Promise((n=>{try{if(!e)return void n(null);console.log("ðŸ  ENHANCED LOCAL: Matching for:",e);const o={homedepot:{id:"681fe0e67d92c3d3e1e2a3da",name:"The Home Depot",patterns:[/^the home depot$/i,/^home depot$/i,/^homedepot$/i,/home depot/i]},olivegarden:{id:"682b61ee7e3ea12414dd4665",name:"Olive Garden",patterns:[/^olive garden$/i,/^olive garden italian restaurant$/i,/^olive garden italian$/i,/olive garden/i]},lowes:{id:"lowes_chain_id",name:"Lowe's",patterns:[/^lowes$/i,/^lowe's$/i,/^lowes home improvement$/i,/^lowe's home improvement$/i,/lowes?/i]},mcdonalds:{id:"mcdonalds_chain_id",name:"McDonald's",patterns:[/^mcdonalds$/i,/^mcdonald's$/i,/^mickey d's$/i,/mcdonald/i]},walmart:{id:"walmart_chain_id",name:"Walmart",patterns:[/^walmart$/i,/^wal-mart$/i,/^walmart supercenter$/i,/walmart/i]}},t=e.toLowerCase().trim();for(const[i,s]of Object.entries(o))for(const o of s.patterns)if(o.test(t))return console.log(`ðŸŽ¯ ENHANCED LOCAL MATCH: "${e}" â†’ "${s.name}" (pattern: ${o})`),void n({_id:s.id,bname:s.name,isLocalMatch:!0});console.log(`âŒ No enhanced local match for: ${e}`),n(null)}catch(e){console.error("âŒ Error in enhanced local matching:",e),n(null)}}))}async function tryServerSideChainMatchingOptimized(e){const n=getBaseURL(),o=e.replace(/\s+(italian\s+restaurant|restaurant|store|location|inc|llc|corp)$/i,"").trim();try{const t=await fetch(`${n}/api/business.js?operation=find_matching_chain&place_name=${encodeURIComponent(o)}`);if(t.ok){const n=await t.json();if(n.success&&n.chain)return console.log(`âœ… OPTIMIZED SERVER MATCH: "${e}" â†’ "${n.chain.bname}" (using "${o}")`),n.chain}}catch(e){console.error(`âŒ Optimized server matching failed for "${o}":`,e.message)}return console.log(`âŒ No optimized server match for: ${e}`),null}function clearChainMatchCache(){chainMatchCache.clear(),console.log("ðŸ§¹ CACHE CLEARED: Chain match cache has been cleared")}function getChainMatchCacheStatus(){if(console.log("ðŸ“Š CACHE STATUS:"),console.log(`   - Total entries: ${chainMatchCache.size}`),console.log(`   - API queue length: ${apiCallQueue.length}`),console.log(`   - Processing queue: ${isProcessingQueue}`),chainMatchCache.size>0){console.log("   - Cached entries:");for(const[e,n]of chainMatchCache.entries())console.log(`     ${e} â†’ ${n?n.bname:"No match"}`)}}async function getApproximateLocation(){return{lat:39.8283,lng:-98.5795,source:"default-us-center"}}function showUserFriendlyError(e,n){const o=document.getElementById("business-search-results")||document.getElementById("search_table");if(!o)return;const t={location:"ðŸ“",geocoding:"ðŸ—ºï¸","no-results":"ðŸ”",critical:"âš ï¸",network:"ðŸŒ"}[e]||"âŒ";o.innerHTML=`\n        <div class="user-friendly-error">\n            <div class="error-icon">${t}</div>\n            <div class="error-message">${n}</div>\n            <div class="error-actions">\n                <button onclick="location.reload()" class="retry-btn">ðŸ”„ Try Again</button>\n                <button onclick="clearSearchForm()" class="clear-btn">ðŸ†• New Search</button>\n            </div>\n        </div>\n    `,o.style.display="block"}function showSearchSuccessMessage(e,n,o){const t=document.createElement("div");t.className="search-success-banner",t.innerHTML=`\n        <div class="success-content">\n            <span class="success-icon">âœ…</span>\n            <span class="success-text">\n                Found ${e+n} businesses\n                ${e>0?`(${e} in database`:""}\n                ${n>0?`${e>0?", ":"("}${n} nearby)`:e>0?")":""}\n            </span>\n            <button onclick="this.parentElement.parentElement.remove()" class="close-success">Ã—</button>\n        </div>\n    `;const i=document.querySelector("main")||document.body;i.insertBefore(t,i.firstChild),setTimeout((()=>{t.parentNode&&t.remove()}),5e3)}function clearSearchForm(){const e=document.getElementById("business-search-form");if(e){e.reset(),e.querySelectorAll("input").forEach((e=>{e.classList.remove("valid-field","invalid-field"),e.removeAttribute("data-valid")}));const n=document.getElementById("business-search-results")||document.getElementById("search_table");n&&(n.style.display="none"),clearMarkers(),map&&(map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom)),console.log("ðŸ†• FORM CLEARED: Search form and results cleared")}}function createDebugDashboard(){const e=document.getElementById("debug-dashboard");e&&e.remove();const n=document.createElement("div");n.id="debug-dashboard",n.style.cssText="\n        position: fixed;\n        top: 10px;\n        right: 10px;\n        background: rgba(0,0,0,0.9);\n        color: white;\n        padding: 15px;\n        border-radius: 8px;\n        z-index: 10000;\n        font-family: monospace;\n        font-size: 11px;\n        max-width: 350px;\n        max-height: 80vh;\n        overflow-y: auto;\n        box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n    ",n.innerHTML='\n        <h4 style="margin: 0 0 10px 0; color: #4CAF50; text-align: center;">ðŸ› ï¸ Debug Dashboard</h4>\n        \n        <div class="debug-section">\n            <h5 style="color: #2196F3; margin: 10px 0 5px 0;">ðŸ” Quick Tests</h5>\n            <button onclick="testSpecificSearch(\'Olive Garden\', false)" class="debug-btn">Test Olive Garden</button>\n            <button onclick="testSpecificSearch(\'The Home Depot\', true)" class="debug-btn">Test Home Depot + Location</button>\n            <button onclick="testSpecificSearch(\'McDonald\\\'s\', false)" class="debug-btn">Test McDonald\'s</button>\n        </div>\n\n        <div class="debug-section">\n            <h5 style="color: #FF9800; margin: 10px 0 5px 0;">ðŸ“Š System Status</h5>\n            <button onclick="debugBusinessSearch()" class="debug-btn">Full System Debug</button>\n            <button onclick="getChainMatchCacheStatus()" class="debug-btn">Cache Status</button>\n            <button onclick="checkMapMarkers()" class="debug-btn">Check Markers</button>\n        </div>\n\n        <div class="debug-section">\n            <h5 style="color: #9C27B0; margin: 10px 0 5px 0;">ðŸ§¹ Maintenance</h5>\n            <button onclick="clearChainMatchCache()" class="debug-btn">Clear Cache</button>\n            <button onclick="clearSearchForm()" class="debug-btn">Clear Form</button>\n            <button onclick="resetMapView()" class="debug-btn">Reset Map</button>\n        </div>\n\n        <div class="debug-section">\n            <h5 style="color: #F44336; margin: 10px 0 5px 0;">ðŸš¨ Emergency</h5>\n            <button onclick="emergencyReset()" class="debug-btn danger">Emergency Reset</button>\n            <button onclick="location.reload()" class="debug-btn danger">Reload Page</button>\n        </div>\n\n        <div id="debug-status" style="margin-top: 10px; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 10px;">\n            Ready for debugging\n        </div>\n\n        <button onclick="document.getElementById(\'debug-dashboard\').remove()" \n                style="position: absolute; top: 5px; right: 8px; background: none; border: none; color: #f44336; font-size: 16px; cursor: pointer;">Ã—</button>\n    ';const o=document.createElement("style");o.textContent="\n        .debug-btn {\n            display: block;\n            width: 100%;\n            margin: 2px 0;\n            padding: 6px 8px;\n            background: #333;\n            color: white;\n            border: 1px solid #555;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 10px;\n            transition: background 0.2s;\n        }\n        \n        .debug-btn:hover {\n            background: #555;\n        }\n        \n        .debug-btn.danger {\n            background: #d32f2f;\n            border-color: #b71c1c;\n        }\n        \n        .debug-btn.danger:hover {\n            background: #f44336;\n        }\n        \n        .debug-section {\n            margin-bottom: 10px;\n            padding-bottom: 8px;\n            border-bottom: 1px solid #333;\n        }\n        \n        .debug-section:last-child {\n            border-bottom: none;\n        }\n    ",document.head.appendChild(o),document.body.appendChild(n),console.log("ðŸ› ï¸ DEBUG DASHBOARD: Created comprehensive debugging dashboard")}function checkMapMarkers(){if(console.log("ðŸŽ¯ MARKER CHECK: Analyzing current markers..."),!markers||0===markers.length)return console.log("âŒ No markers found"),void updateDebugStatus("No markers on map");let e=0,n=0,o=0;markers.forEach(((t,i)=>{t.business?(t.business.isGooglePlace?n++:e++,console.log(`   ${i+1}. ${t.business.bname} (${t.business.isGooglePlace?"PLACES":"DATABASE"})`)):o++}));const t=`${markers.length} markers: ${e} database, ${n} places, ${o} invalid`;console.log(`ðŸ“Š MARKER SUMMARY: ${t}`),updateDebugStatus(t)}function emergencyReset(){console.log("ðŸš¨ EMERGENCY RESET: Performing complete system reset...");try{clearMarkers(),"function"==typeof clearChainMatchCache&&clearChainMatchCache(),clearSearchForm(),map&&(map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom)),infoWindow&&infoWindow.close(),document.querySelectorAll(".modal-backdrop").forEach((e=>e.remove())),document.body.classList.remove("modal-open"),document.body.style.paddingRight="",document.body.style.overflow="",document.querySelectorAll(".error-message, .user-friendly-error, .loading-indicator").forEach((e=>e.remove())),console.log("âœ… EMERGENCY RESET: System reset completed"),updateDebugStatus("Emergency reset completed")}catch(e){console.error("âŒ EMERGENCY RESET FAILED:",e),updateDebugStatus("Emergency reset failed - try page reload")}}function updateDebugStatus(e){const n=document.getElementById("debug-status");n&&(n.textContent=`${(new Date).toLocaleTimeString()}: ${e}`)}function addEnhancedUserInterfaceCSS(){if(!document.getElementById("enhanced-ui-css")){const e=document.createElement("style");e.id="enhanced-ui-css",e.textContent="\n            /* User-friendly error messages */\n            .user-friendly-error {\n                text-align: center;\n                padding: 40px 20px;\n                background: linear-gradient(135deg, #fff3e0 0%, #ffccbc 100%);\n                border-radius: 12px;\n                margin: 20px;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n            }\n\n            .error-icon {\n                font-size: 48px;\n                margin-bottom: 16px;\n            }\n\n            .error-message {\n                font-size: 16px;\n                color: #333;\n                margin-bottom: 20px;\n                line-height: 1.5;\n            }\n\n            .error-actions {\n                display: flex;\n                gap: 10px;\n                justify-content: center;\n                flex-wrap: wrap;\n            }\n\n            .retry-btn, .clear-btn {\n                padding: 10px 20px;\n                border: none;\n                border-radius: 6px;\n                cursor: pointer;\n                font-weight: 500;\n                transition: all 0.2s;\n            }\n\n            .retry-btn {\n                background: #4CAF50;\n                color: white;\n            }\n\n            .retry-btn:hover {\n                background: #45a049;\n                transform: translateY(-1px);\n            }\n\n            .clear-btn {\n                background: #2196F3;\n                color: white;\n            }\n\n            .clear-btn:hover {\n                background: #1976D2;\n                transform: translateY(-1px);\n            }\n\n            /* Success banner */\n            .search-success-banner {\n                background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);\n                border: 1px solid #4caf50;\n                border-radius: 8px;\n                margin: 10px 0;\n                animation: slideInFromTop 0.5s ease-out;\n            }\n\n            .success-content {\n                display: flex;\n                align-items: center;\n                padding: 12px 16px;\n                gap: 10px;\n            }\n\n            .success-icon {\n                font-size: 18px;\n            }\n\n            .success-text {\n                flex: 1;\n                color: #2e7d32;\n                font-weight: 500;\n            }\n\n            .close-success {\n                background: none;\n                border: none;\n                font-size: 18px;\n                color: #2e7d32;\n                cursor: pointer;\n                padding: 0;\n                width: 24px;\n                height: 24px;\n            }\n\n            .close-success:hover {\n                background: rgba(76, 175, 80, 0.1);\n                border-radius: 50%;\n            }\n\n            @keyframes slideInFromTop {\n                from {\n                    opacity: 0;\n                    transform: translateY(-20px);\n                }\n                to {\n                    opacity: 1;\n                    transform: translateY(0);\n                }\n            }\n\n            /* Enhanced loading indicator */\n            .loading-indicator {\n                text-align: center;\n                padding: 40px 20px;\n                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);\n                border-radius: 12px;\n                margin: 20px;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n            }\n\n            .loading-text {\n                font-size: 18px;\n                color: #333;\n                margin-bottom: 20px;\n                font-weight: 500;\n            }\n\n            .loading-spinner {\n                width: 40px;\n                height: 40px;\n                border: 4px solid #e3f2fd;\n                border-top: 4px solid #2196f3;\n                border-radius: 50%;\n                animation: spin 1s linear infinite;\n                margin: 0 auto;\n            }\n        ",document.head.appendChild(e)}}function showEnhancedInfoWindowWithCategory(e){if(console.log("ðŸªŸ CATEGORY INFO WINDOW: Showing for:",e.business?.bname),!e||!e.business)return void console.error("âŒ Invalid marker for category info window");const n=e.business,o=!0===n.isGooglePlace,t=!!n.chain_id,i=!0===n.isFromDatabase;n.isNearbyDatabase,n.isPrimaryResult,infoWindow&&infoWindow.close(),infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1});const s=buildCategoryAwareInfoWindowContent(n);infoWindow.setContent(s);let a=e.position;if(!a&&e.getPosition&&(a=e.getPosition()),a||(a=createSafeLatLng(n)),a){try{map.panTo(a)}catch(e){console.warn("âš ï¸ Error panning to position:",e)}setTimeout((()=>{try{e.getPosition?infoWindow.open(map,e):(infoWindow.setPosition(a),infoWindow.open(map)),console.log("âœ… Category info window opened successfully"),google.maps.event.addListenerOnce(infoWindow,"domready",(function(){setTimeout((()=>{applyEnhancedInfoWindowFixes();const e=o?`google_${n.placeId}`:n._id;console.log(`ðŸŽ CATEGORY INCENTIVES: Loading for ${e} (${n.markerColor})`),i&&t?loadChainIncentivesForDatabaseBusinessFixed(e,n.chain_id):i?loadIncentivesForEnhancedWindowFixed(e):o&&t&&loadChainIncentivesForEnhancedWindowFixed(e,n.chain_id)}),300)}))}catch(e){console.error("âŒ Error opening category info window:",e)}}),200)}else console.error("âŒ Could not determine position for category info window")}function buildCategoryAwareInfoWindowContent(e){const n=!0===e.isGooglePlace,o=!!e.chain_id,t=!0===e.isFromDatabase,i=!0===e.isNearbyDatabase,s=!0===e.isPrimaryResult;let a="";if(e.address1){a=`<div class="info-address">\n            <strong>ðŸ“ Address:</strong><br>\n            ${e.address1}`,e.address2&&(a+=`<br>${e.address2}`);const n=[];e.city&&n.push(e.city),e.state&&n.push(e.state),e.zip&&n.push(e.zip),n.length>0&&(a+=`<br>${n.join(", ")}`),a+="</div>"}else if(e.formattedAddress){const n=e.formattedAddress.split(",").map((e=>e.trim()));a='<div class="info-address">\n            <strong>ðŸ“ Address:</strong><br>',n.length>=1&&(a+=n[0]),n.length>=2&&(a+=`<br>${n.slice(1).join(", ")}`),a+="</div>"}const r=e.phone?`<div class="info-phone"><strong>ðŸ“ž Phone:</strong> <a href="tel:${e.phone.replace(/\D/g,"")}" style="color: #4285F4; text-decoration: none;">${e.phone}</a></div>`:"";let l="";e.type&&"OTHER"!==e.type&&(l=`<div class="info-type"><strong>ðŸ¢ Type:</strong> ${getBusinessTypeLabel(e.type)}</div>`);const c=e.distance?`<div class="info-distance"><strong>ðŸ“ Distance:</strong> ${(e.distance/1609).toFixed(1)} miles</div>`:"";let d="";o&&(d=`<span class="enhanced-chain-badge" style="background-color: ${s?"#4285F4":i?"#28a745":"#4285F4"};">ðŸ”— ${e.chain_name||"Chain Location"}</span>`);let g,p="",u="";s?p='<div class="info-status primary-result">ðŸŽ¯ This business matches your search and is in the Patriot Thanks database.</div>':i?(p='<div class="info-status nearby-database">ðŸ¢ This business is in the Patriot Thanks database (found nearby).</div>',u='<div class="nearby-explanation">ðŸ’¡ This business appeared because it\'s in your search area and already in our database.</div>'):n&&o?(p='<div class="info-status chain-match">ðŸ”— This location appears to match a chain in our database!</div>',u=`<div class="chain-explanation">\n            âœ¨ Great news! This location matches <strong>${e.chain_name}</strong> in our database. \n            Chain-wide incentives should apply to this location once added.\n        </div>`):n&&(p='<div class="info-status google-place">â„¹ï¸ This business is not yet in the Patriot Thanks database.</div>'),t?g=`\n            <button class="enhanced-view-btn" onclick="window.viewBusinessDetails('${e._id}')">\n                ðŸ‘ï¸ View Details\n            </button>\n        `:n&&o?g=`\n            <button class="enhanced-add-btn chain-add" onclick="window.addBusinessToDatabase('${e.placeId}', '${e.chain_id}')">\n                ðŸ”— Add ${e.chain_name} Location\n            </button>\n        `:n&&(g=`\n            <button class="enhanced-add-btn" onclick="window.addBusinessToDatabase('${e.placeId}')">\n                âž• Add to Patriot Thanks\n            </button>\n        `);const h=n?`google_${e.placeId}`:e._id;let m;return m=t&&o?"<em>â³ Loading chain incentives...</em>":t?"<em>â³ Loading incentives...</em>":n&&o?"<em>â³ Loading chain incentives...</em>":"<em>ðŸ’¡ Add this business to see available incentives.</em>",`\n        <div class="enhanced-info-window category-aware">\n            <div class="info-header">\n                <h3>${e.bname} ${d}</h3>\n            </div>\n            \n            <div class="info-body">\n                ${a}\n                ${r}\n                ${l}\n                ${c}\n                ${p}\n                ${u}\n                \n                <div class="info-incentives">\n                    <div id="incentives-container-${h}">\n                        ${m}\n                    </div>\n                </div>\n            </div>\n            \n            <div class="info-actions">\n                ${g}\n            </div>\n        </div>\n    `}function displayBusinessesOnMapWithCategories(e){if(!map)return console.log("â³ Map not ready, storing businesses for later display"),void(pendingBusinessesToDisplay=e);console.log(`ðŸ—ºï¸ CATEGORIZED DISPLAY: Displaying ${e.length} businesses on map`),clearMarkers(),bounds=new google.maps.LatLngBounds;let n=0,o=0,t=0,i=0;e.forEach(((s,a)=>{try{if(console.log(`ðŸ”„ Processing business ${a+1}/${e.length}: ${s.bname} (${s.markerColor||"unknown"})`),!0===s.is_chain)return console.log(`ðŸš« Skipping parent chain business: ${s.bname}`),void i++;const r=getBusinessLocation(s);if(!r)return console.warn(`âŒ Business ${s.bname} missing coordinates`),void i++;if(s.lat=r.lat,s.lng=r.lng,createCategorizedBusinessMarker(s)){switch(s.markerColor){case"primary":n++;break;case"database":o++;break;default:t++}console.log(`âœ… Created ${s.markerColor} marker for ${s.bname}`);const e=new google.maps.LatLng(r.lat,r.lng);bounds.extend(e)}else console.error(`âŒ Failed to create marker for ${s.bname}`),i++}catch(e){console.error(`âŒ Error processing business ${s.bname}:`,e),i++}})),console.log("ðŸ“Š CATEGORIZED MARKER SUMMARY:"),console.log(`   - ðŸ”´ Primary (RED): ${n} markers`),console.log(`   - ðŸŸ¢ Nearby Database (GREEN): ${o} markers`),console.log(`   - ðŸ”µ Google Places (BLUE): ${t} markers`),console.log(`   - âŒ Skipped: ${i} businesses`),console.log(`   - âœ… Total Created: ${n+o+t} markers`),setTimeout((()=>{try{if(window.currentSearchLocation&&(n>0||o>0)){console.log("ðŸ“ Centering map on search location with results");const e=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng);map.setCenter(e),map.setZoom(12)}else n+o+t>0&&bounds&&!bounds.isEmpty()?(console.log("ðŸŽ¯ Fitting map to all business bounds"),safelyFitBounds(map,bounds)):(console.log("ðŸŒŽ Using default map center"),map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom))}catch(e){console.error("âŒ Error updating map view:",e)}}),200)}function createCategorizedBusinessMarker(e){try{if(!e.lat||!e.lng||isNaN(parseFloat(e.lat))||isNaN(parseFloat(e.lng)))return console.warn(`âŒ Invalid coordinates for business: ${e.bname}`),null;const n=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng));return createEnhancedBusinessMarkerWithCategory(e,n)}catch(e){return console.error("âŒ Error creating categorized business marker:",e),null}}function displaySearchResultsWithCategories(e){try{console.log(`ðŸ“‹ CATEGORIZED RESULTS: Displaying ${e.length} businesses in table`),hideLoadingIndicator();const n=document.getElementById("business_search"),o=document.getElementById("search_table");if(!n||!o)return console.error("âŒ Required table elements not found in the DOM"),void showErrorMessage("There was an error displaying search results. Please try again later.");let t=n.querySelector("tbody");if(!t)return console.error("âŒ Table body not found"),void showErrorMessage("There was an error displaying search results. Please try again later.");t.innerHTML="",o.style.display="block";const i=o.querySelector("h5");if(i&&(i.style.display="none"),0===e.length)return t.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria.</td></tr>',void o.scrollIntoView({behavior:"smooth"});const s=e.filter((e=>"primary"===e.markerColor)),a=e.filter((e=>"database"===e.markerColor)),r=e.filter((e=>"nearby"===e.markerColor));console.log("ðŸ“Š TABLE CATEGORIES:"),console.log(`   - Primary Results: ${s.length}`),console.log(`   - Nearby Database: ${a.length}`),console.log(`   - Google Places: ${r.length}`);let l=0;s.length>0&&(addTableSectionHeader(t,`ðŸŽ¯ Search Results (${s.length})`,"primary-section"),s.forEach(((e,n)=>{console.log(`ðŸ“ Adding primary business ${n+1}: ${e.bname}`),addCategorizedBusinessRow(e,t,"primary"),l++}))),a.length>0&&(addTableSectionHeader(t,`ðŸ¢ Nearby Businesses in Database (${a.length})`,"database-section"),a.forEach(((e,n)=>{console.log(`ðŸ“ Adding nearby database business ${n+1}: ${e.bname}`),addCategorizedBusinessRow(e,t,"database"),l++}))),r.length>0&&(addTableSectionHeader(t,`ðŸŒ Additional Locations Found (${r.length})`,"places-section"),r.forEach(((e,n)=>{console.log(`ðŸ“ Adding Google Places business ${n+1}: ${e.bname}`),addCategorizedBusinessRow(e,t,"places"),l++}))),o.scrollIntoView({behavior:"smooth"}),console.log(`âœ… Categorized search results displayed: ${l} total rows`)}catch(e){console.error("âŒ Error displaying categorized search results:",e),hideLoadingIndicator(),showErrorMessage("There was an error displaying the search results: "+e.message)}}function addTableSectionHeader(e,n,o){const t=document.createElement("tr");t.className=`section-header ${o}`,t.innerHTML=`\n        <td colspan="5" class="section-header-cell">\n            <strong>${n}</strong>\n        </td>\n    `,e.appendChild(t)}function addCategorizedBusinessRow(e,n,o){if(!e)return;if(!0===e.is_chain)return void console.log(`â­ï¸ Skipping parent chain business in table: ${e.bname}`);console.log(`ðŸ“ Adding categorized table row: ${e.bname} (${o})`);let t="";if(e.address1)t=e.address2?`${e.address1}<br>${e.address2}<br>${e.city}, ${e.state} ${e.zip}`:`${e.address1}<br>${e.city}, ${e.state} ${e.zip}`;else{if(!e.formattedAddress)return void console.warn(`âŒ Business ${e.bname} has no address information`);t=e.formattedAddress.replace(/,/g,"<br>")}const i=getBusinessTypeLabel(e.type);let s="",a="";switch(o){case"primary":s='<span class="category-badge primary-badge">ðŸŽ¯ Search Result</span>',a="primary-result-row";break;case"database":s='<span class="category-badge database-badge">ðŸ¢ In Database</span>',a="database-result-row";break;case"places":s='<span class="category-badge places-badge">ðŸŒ Found Nearby</span>',a="places-result-row"}const r=e.chain_id?'<span class="chain-badge">ðŸ”— Chain Location</span>':"";let l;l="primary"===o||"database"===o?`<button class="view-map-btn ${o}" onclick="focusOnMapMarker('${e._id}')">ðŸ“ View on Map</button>`:e.chain_id?`<button class="add-to-db-btn chain" onclick="addBusinessToDatabase('${e.placeId}', '${e.chain_id}')">ðŸ”— Add Chain Location</button>`:`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${e.placeId}')">âž• Add to Database</button>`;const c=document.createElement("tr");c.className=`business-row ${a}`,c.innerHTML=`\n        <th class="left_table" data-business-id="${e._id}">\n            ${e.bname} ${r}\n            <div class="category-badges">${s}</div>\n        </th>\n        <th class="left_table">${t}</th>\n        <th class="left_table">${i}</th>\n        <th class="right_table" id="incentives-for-${e._id}">\n            ${"primary"===o||"database"===o?'<span class="loading-incentives">Loading incentives...</span>':"Not in database yet"}\n        </th>\n        <th class="center_table">${l}</th>\n    `,n.appendChild(c),"primary"===o||"database"===o?(console.log(`ðŸŽ Scheduling incentives load for ${o} business: ${e.bname} (ID: ${e._id})`),setTimeout((()=>{fetchBusinessIncentivesFixed(e._id,e.chain_id)}),100)):"places"===o&&e.chain_id&&(console.log(`ðŸ”— Scheduling chain incentives load for Places business: ${e.bname}`),fetchChainIncentivesForPlacesResult(e._id,e.chain_id))}function showEnhancedSearchSuccessMessage(e,n,o){const t=document.createElement("div");t.className="enhanced-search-success-banner";let i=`Found ${e+n+o} businesses: `;const s=[];e>0&&s.push(`<span class="success-primary">${e} search result${1!==e?"s":""}</span>`),n>0&&s.push(`<span class="success-database">${n} nearby database business${1!==n?"es":""}</span>`),o>0&&s.push(`<span class="success-places">${o} additional location${1!==o?"s":""}</span>`),i+=s.join(", "),t.innerHTML=`\n        <div class="enhanced-success-content">\n            <span class="success-icon">âœ…</span>\n            <span class="success-text">${i}</span>\n            <button onclick="this.parentElement.parentElement.remove()" class="close-success">Ã—</button>\n        </div>\n        <div class="success-legend">\n            <span class="legend-item"><span class="legend-dot red"></span>Search Results</span>\n            <span class="legend-item"><span class="legend-dot green"></span>Nearby Database</span>\n            <span class="legend-item"><span class="legend-dot blue"></span>Additional Locations</span>\n        </div>\n    `;const a=document.querySelector("main")||document.body;a.insertBefore(t,a.firstChild),setTimeout((()=>{t.parentNode&&t.remove()}),8e3)}function updateMapLegendWithCategories(){const e=document.getElementById("map-container");if(!e)return;const n=e.querySelector(".map-legend");n&&n.remove();const o=document.createElement("div");o.className="map-legend enhanced-legend",o.innerHTML='\n        <div class="legend-item">\n            <div class="legend-color primary"></div>\n            <span>Primary Search Results</span>\n        </div>\n        <div class="legend-item">\n            <div class="legend-color database"></div>\n            <span>Nearby Database Businesses</span>\n        </div>\n        <div class="legend-item">\n            <div class="legend-color nearby"></div>\n            <span>Additional Locations Found</span>\n        </div>\n    ',e.appendChild(o)}async function performEnhancedBusinessSearch(e,n=!1){try{const o=document.getElementById("business-search-results")||document.getElementById("search_table");o&&(o.innerHTML='<div class="loading-indicator" id="main-loading"><div class="loading-text">Searching for businesses...</div><div class="loading-spinner"></div></div>',o.style.display="block");let t=null,i=30;if(e.useMyLocation)updateLoadingMessage("Getting your location..."),t=await getUserLocation(),window.currentSearchLocation=t;else if(e.address&&""!==e.address.trim()){updateLoadingMessage("Finding location...");const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw new Error(`Geocoding failed for address: ${e.address}`);if(t=n,window.currentSearchLocation=t,i=/^\d{5}$/.test(e.address.trim())?25:e.address.toLowerCase().includes("city")||e.address.split(",").length>=2?30:20,map&&t){const e=new google.maps.LatLng(t.lat,t.lng);map.setCenter(e),map.setZoom(i<=20?12:11)}}updateLoadingMessage("Searching database...");let s=[];e.businessName&&""!==e.businessName.trim()&&(s=await searchDatabaseWithFuzzyMatching(e,t,n),s=s.filter((e=>!0!==e.is_chain)));let a=[];if(e.businessName&&t){updateLoadingMessage("Searching for additional locations...");const n={...t,searchRadius:Math.max(i,35)};a=await searchGooglePlacesForBusinessEnhanced(e.businessName,n)}let r=[];t&&(updateLoadingMessage("Finding other nearby businesses in database..."),r=await searchNearbyDatabaseBusinessesEnhanced(t,i,e.businessName));const{finalPrimaryResults:l,finalPlacesResults:c,finalNearbyResults:d}=categorizeResultsWithFixedDuplicateDetection(s,a,r),g=[...l,...c,...d];g.length>0?(l.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!0,e.markerColor="primary",e.priority=1})),c.forEach((e=>{e.isGooglePlace=!0,e.isFromDatabase=!1,e.isPrimaryResult=!1,e.isRelevantPlaces=!0,e.markerColor="nearby",e.priority=2})),d.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!1,e.isNearbyDatabase=!0,e.markerColor="database",e.priority=3})),hideLoadingIndicator(),displayBusinessesOnMapWithBetterPriority(g),displaySearchResultsWithBetterPriority(g),showImprovedSearchSuccessMessage(l.length,c.length,d.length,e.businessName)):(hideLoadingIndicator(),showNoResultsMessage())}catch(e){console.error("Enhanced search error:",e),hideLoadingIndicator(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}function displaySearchResultsWithBetterPriority(e){try{console.log(`ðŸ“‹ IMPROVED RESULTS: Displaying ${e.length} businesses in better priority order`),hideLoadingIndicator();const n=document.getElementById("business_search"),o=document.getElementById("search_table");if(!n||!o)return console.error("âŒ Required table elements not found in the DOM"),void showErrorMessage("There was an error displaying search results. Please try again later.");let t=n.querySelector("tbody");if(!t)return console.error("âŒ Table body not found"),void showErrorMessage("There was an error displaying search results. Please try again later.");t.innerHTML="",o.style.display="block";const i=o.querySelector("h5");if(i&&(i.style.display="none"),0===e.length)return t.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria.</td></tr>',void o.scrollIntoView({behavior:"smooth"});const s=e.filter((e=>1===e.priority)),a=e.filter((e=>2===e.priority)),r=e.filter((e=>3===e.priority));console.log("ðŸ“Š IMPROVED TABLE CATEGORIES:"),console.log(`   - ðŸ”´ Primary Database Results: ${s.length}`),console.log(`   - ðŸ”µ Additional Relevant Locations: ${a.length}`),console.log(`   - ðŸŸ¢ Other Nearby Businesses: ${r.length}`);let l=0;s.length>0&&(addTableSectionHeader(t,`ðŸŽ¯ Database Results (${s.length})`,"primary-section"),s.forEach(((e,n)=>{console.log(`ðŸ“ Adding primary business ${n+1}: ${e.bname}`),addCategorizedBusinessRow(e,t,"primary"),l++}))),a.length>0&&(addTableSectionHeader(t,`ðŸ“ Additional Locations Found (${a.length})`,"places-section"),a.forEach(((e,n)=>{console.log(`ðŸ“ Adding relevant Places business ${n+1}: ${e.bname}`),addCategorizedBusinessRow(e,t,"places"),l++}))),r.length>0&&(addTableSectionHeader(t,`ðŸ¢ Other Nearby Businesses (${r.length})`,"database-section"),r.forEach(((e,n)=>{console.log(`ðŸ“ Adding nearby database business ${n+1}: ${e.bname}`),addCategorizedBusinessRow(e,t,"database"),l++}))),o.scrollIntoView({behavior:"smooth"}),console.log(`âœ… Improved priority search results displayed: ${l} total rows`)}catch(e){console.error("âŒ Error displaying improved priority search results:",e),hideLoadingIndicator(),showErrorMessage("There was an error displaying the search results: "+e.message)}}function displayBusinessesOnMapWithBetterPriority(e){if(!map)return console.log("â³ Map not ready, storing businesses for later display"),void(pendingBusinessesToDisplay=e);console.log(`ðŸ—ºï¸ IMPROVED MAP DISPLAY: Displaying ${e.length} businesses with better priority`),clearMarkers(),bounds=new google.maps.LatLngBounds;let n=0,o=0,t=0,i=0;const s=[...e].sort(((e,n)=>(e.priority||999)-(n.priority||999)));s.forEach(((e,a)=>{try{if(console.log(`ðŸ”„ Processing business ${a+1}/${s.length}: ${e.bname} (Priority: ${e.priority})`),!0===e.is_chain)return console.log(`ðŸš« Skipping parent chain business: ${e.bname}`),void i++;const r=getBusinessLocation(e);if(!r)return console.warn(`âŒ Business ${e.bname} missing coordinates`),void i++;if(e.lat=r.lat,e.lng=r.lng,createCategorizedBusinessMarker(e)){switch(e.priority){case 1:n++;break;case 2:o++;break;default:t++}console.log(`âœ… Created priority ${e.priority} marker for ${e.bname}`);const i=new google.maps.LatLng(r.lat,r.lng);bounds.extend(i)}else console.error(`âŒ Failed to create marker for ${e.bname}`),i++}catch(n){console.error(`âŒ Error processing business ${e.bname}:`,n),i++}})),console.log("ðŸ“Š IMPROVED PRIORITY MARKER SUMMARY:"),console.log(`   - ðŸ”´ Priority 1 - Database Results (RED): ${n} markers`),console.log(`   - ðŸ”µ Priority 2 - Additional Locations (BLUE): ${o} markers`),console.log(`   - ðŸŸ¢ Priority 3 - Other Nearby (GREEN): ${t} markers`),console.log(`   - âŒ Skipped: ${i} businesses`),console.log(`   - âœ… Total Created: ${n+o+t} markers`),setTimeout((()=>{try{if(window.currentSearchLocation&&(n>0||o>0)){console.log("ðŸ“ Centering map on search location with relevant results");const e=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng);map.setCenter(e),map.setZoom(12)}else n+o+t>0&&bounds&&!bounds.isEmpty()?(console.log("ðŸŽ¯ Fitting map to all business bounds"),safelyFitBounds(map,bounds)):(console.log("ðŸŒŽ Using default map center"),map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom))}catch(e){console.error("âŒ Error updating map view:",e)}}),200)}function showImprovedSearchSuccessMessage(e,n,o,t){const i=document.createElement("div");i.className="enhanced-search-success-banner";let s=`Found ${e+n+o} businesses`;t&&(s+=` for "${t}"`),s+=": ";const a=[];e>0&&a.push(`<span class="success-primary">${e} in database</span>`),n>0&&a.push(`<span class="success-places">${n} additional location${1!==n?"s":""}</span>`),o>0&&a.push(`<span class="success-database">${o} other nearby</span>`),s+=a.join(", "),i.innerHTML=`\n        <div class="enhanced-success-content">\n            <span class="success-icon">âœ…</span>\n            <span class="success-text">${s}</span>\n            <button onclick="this.parentElement.parentElement.remove()" class="close-success">Ã—</button>\n        </div>\n        <div class="success-legend">\n            <span class="legend-item"><span class="legend-dot red"></span>Database Results</span>\n            <span class="legend-item"><span class="legend-dot blue"></span>Additional Locations</span>\n            <span class="legend-item"><span class="legend-dot green"></span>Other Nearby</span>\n        </div>\n    `;const r=document.querySelector("main")||document.body;r.insertBefore(i,r.firstChild),setTimeout((()=>{i.parentNode&&i.remove()}),8e3)}async function searchGooglePlacesForBusinessEnhanced(e,n){try{const{Place:o}=await google.maps.importLibrary("places"),t=new google.maps.LatLng(n.lat,n.lng),i={textQuery:e,locationBias:{center:t,radius:5e4},maxResultCount:20,fields:["id","displayName","formattedAddress","location","types","nationalPhoneNumber","internationalPhoneNumber","businessStatus"]},{places:s}=await o.searchByText(i);if(!s||0===s.length){const n={...i,locationBias:{center:t,radius:75e3}},{places:s}=await o.searchByText(n);return s&&0!==s.length?await processPlacesResults(s,t,e):[]}return await processPlacesResults(s,t,e)}catch(e){return console.error("Error in Places API search:",e),[]}}async function processPlacesResults(e,n,o){const t=e.filter((e=>{if("CLOSED_PERMANENTLY"===e.businessStatus)return!1;const n=e.displayName.toLowerCase(),t=o.toLowerCase();if(!n.includes(t)&&!t.includes(n)){const e=t.split(" "),o=n.split(" ");let i=0;for(const n of e)o.some((e=>e.includes(n)||n.includes(e)))&&i++;if(i<Math.ceil(e.length/2))return!1}return!0})).map((async e=>{const o=e.formattedAddress?e.formattedAddress.split(","):[];let t="",i="",s="",a="";if(o.length>=1&&(t=o[0].trim()),o.length>=2&&(i=o[1].trim()),o.length>=3){const e=o[2].trim().match(/^([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/);e&&(s=e[1],a=e[2])}const r=google.maps.geometry.spherical.computeDistanceBetween(n,e.location);let l=0,c=0;if(e.location)try{l="function"==typeof e.location.lat?e.location.lat():e.location.lat||0,c="function"==typeof e.location.lng?e.location.lng():e.location.lng||0}catch(e){l=n.lat(),c=n.lng()}const d={_id:"google_"+e.id,bname:e.displayName,address1:t,city:i,state:s,zip:a,formattedAddress:e.formattedAddress,type:mapGooglePlaceTypeToBusinessType(e.types),phone:e.nationalPhoneNumber||e.internationalPhoneNumber||"",isGooglePlace:!0,placeId:e.id,lat:l,lng:c,distance:r,businessStatus:e.businessStatus};try{const n=await findMatchingChainForPlaceResult(e.displayName);n&&(d.chain_id=n._id,d.chain_name=n.bname,d.isChainLocation=!0)}catch(n){console.warn(`Chain matching failed for ${e.displayName}:`,n.message)}return d})),i=await Promise.all(t);return i.sort(((e,n)=>e.distance-n.distance)),i}async function searchNearbyDatabaseBusinessesEnhanced(e,n,o=""){try{const t=getBaseURL(),i=Math.max(n,30),s=new URLSearchParams({operation:"search",lat:e.lat,lng:e.lng,radius:i,limit:100}),a=await fetch(`${t}/api/business.js?${s.toString()}`);if(!a.ok)throw new Error(`Nearby search failed: ${a.status}`);return((await a.json()).results||[]).filter((e=>{if(!0===e.is_chain)return!1;if(o){const n=e.bname.toLowerCase(),t=o.toLowerCase();if(n===t||n.includes(t)||t.includes(n))return!1}return hasValidCoordinates(e)}))}catch(e){return console.error("Error in nearby database search:",e),[]}}async function searchNearbyDatabaseBusinessesWithDebugging(e,n,o=""){try{console.log(`ðŸ¢ DEBUGGING NEARBY SEARCH: ${n}km radius around ${e.lat}, ${e.lng}`),console.log(`   Excluding business name: "${o}"`);const t=getBaseURL(),i=Math.max(n,30);console.log(`   Using enhanced radius: ${i}km`);const s=`${t}/api/business.js?${new URLSearchParams({operation:"search",lat:e.lat,lng:e.lng,radius:i,limit:100}).toString()}`;console.log(`ðŸŒ DEBUGGING nearby search URL: ${s}`);const a=await fetch(s);if(!a.ok)throw new Error(`Nearby search failed: ${a.status}`);let r=(await a.json()).results||[];console.log(`ðŸ“Š DEBUGGING raw nearby results: ${r.length} businesses total`),console.log("ðŸ” ALL NEARBY BUSINESSES FOUND (first 20):"),r.slice(0,20).forEach(((e,n)=>{const o=!0===e.is_chain?" (CHAIN PARENT)":"",t=hasValidCoordinates(e)?"âœ…":"âŒ";console.log(`   ${n+1}. ${e.bname} - ${e.city}, ${e.state} ${t}${o}`)}));const l=r.filter(((e,n)=>{if(console.log(`ðŸ” FILTERING #${n+1}: ${e.bname}`),!0===e.is_chain)return console.log("   ðŸš« EXCLUDE: Parent chain business"),!1;if(!hasValidCoordinates(e))return console.log("   ðŸš« EXCLUDE: Invalid coordinates"),!1;if(o){const n=e.bname.toLowerCase(),t=o.toLowerCase();if(n===t||n.includes(t)||t.includes(n))return console.log(`   ðŸš« EXCLUDE: Matches excluded name "${o}"`),!1}return console.log(`   âœ… INCLUDE: ${e.bname}`),!0}));return console.log(`âœ… DEBUGGING FILTER RESULTS: ${l.length} businesses after filtering`),l.length>0?(console.log("ðŸ“‹ FINAL NEARBY BUSINESSES:"),l.slice(0,10).forEach(((e,n)=>{console.log(`   ${n+1}. ${e.bname} (${e.type}) - ${e.city}, ${e.state}`)}))):console.log("âŒ NO NEARBY BUSINESSES after filtering - this indicates a potential issue"),l}catch(e){return console.error("âŒ Error in debugging nearby database search:",e),[]}}console.log("ðŸš€ NEARBY SEARCH FIX loaded!"),console.log("ðŸ” Run debugNearbySearchOnly() to debug just the nearby search"),console.log("ðŸ“ Should now show: 1 red (Cedar Rapids), 9 blue (Las Vegas Olive Gardens), + green (Home Depot, etc.)"),"undefined"!=typeof window&&(window.performEnhancedBusinessSearch=performEnhancedBusinessSearch,window.retrieveFromMongoDB=performEnhancedBusinessSearch,window.searchGooglePlacesForBusinessEnhanced=searchGooglePlacesForBusinessEnhanced,window.searchNearbyDatabaseBusinessesEnhanced=searchNearbyDatabaseBusinessesEnhanced,window.categorizeResultsWithFixedDuplicateDetection=categorizeResultsWithFixedDuplicateDetection,window.createEnhancedAddressKey=createEnhancedAddressKey,window.createBusinessNameKey=createBusinessNameKey,window.clearMarkers=clearMarkers,window.getUserLocation=getUserLocation,window.getBaseURL=getBaseURL,window.isValidPosition=isValidPosition,window.createSafeLatLng=createSafeLatLng,window.safelyFitBounds=safelyFitBounds,window.searchNearbyDatabaseBusinessesWithDebugging=searchNearbyDatabaseBusinessesWithDebugging,window.processPlacesResults=processPlacesResults,window.searchGooglePlacesForBusiness=searchGooglePlacesForBusinessEnhanced,window.searchNearbyDatabaseBusinesses=searchNearbyDatabaseBusinessesEnhanced,window.displaySearchResultsWithBetterPriority=displaySearchResultsWithBetterPriority,window.displayBusinessesOnMapWithBetterPriority=displayBusinessesOnMapWithBetterPriority,window.showImprovedSearchSuccessMessage=showImprovedSearchSuccessMessage,window.displayBusinessesOnMap=displayBusinessesOnMapWithCategories,window.displaySearchResults=displaySearchResultsWithCategories,window.displayBusinessesOnMapFixed=displayBusinessesOnMapWithCategories,window.displaySearchResultsFixed=displaySearchResultsWithCategories,window.showEnhancedInfoWindowWithCategory=showEnhancedInfoWindowWithCategory,window.buildCategoryAwareInfoWindowContent=buildCategoryAwareInfoWindowContent,window.createCategorizedBusinessMarker=createCategorizedBusinessMarker,window.addTableSectionHeader=addTableSectionHeader,window.addCategorizedBusinessRow=addCategorizedBusinessRow,window.showEnhancedSearchSuccessMessage=showEnhancedSearchSuccessMessage,window.updateMapLegendWithCategories=updateMapLegendWithCategories,window.getApproximateLocation=getApproximateLocation,window.showUserFriendlyError=showUserFriendlyError,window.showSearchSuccessMessage=showSearchSuccessMessage,window.clearSearchForm=clearSearchForm,window.createDebugDashboard=createDebugDashboard,window.checkMapMarkers=checkMapMarkers,window.emergencyReset=emergencyReset,window.updateDebugStatus=updateDebugStatus,window.addEnhancedUserInterfaceCSS=addEnhancedUserInterfaceCSS,window.findMatchingChainForPlaceResult=findMatchingChainForPlaceResultFixed,window.findMatchingChainLocallyEnhanced=findMatchingChainLocallyEnhanced,window.tryServerSideChainMatchingOptimized=tryServerSideChainMatchingOptimized,window.clearChainMatchCache=clearChainMatchCache,window.getChainMatchCacheStatus=getChainMatchCacheStatus,window.processApiQueue=processApiQueue,window.buildEnhancedInfoWindowContent=buildEnhancedInfoWindowContentFixed2,window.showEnhancedInfoWindow=showEnhancedInfoWindowFixed2,window.loadChainIncentivesForEnhancedWindow=loadChainIncentivesForEnhancedWindowFixed,window.loadIncentivesForEnhancedWindow=loadIncentivesForEnhancedWindowFixed,window.loadChainIncentivesForDatabaseBusiness=loadChainIncentivesForDatabaseBusinessFixed,window.createBusinessMarker=createBusinessMarker,window.fetchBusinessIncentivesFixed=fetchBusinessIncentivesFixed,window.addBusinessRowFixed=addBusinessRowFixed,window.fetchBusinessIncentives=fetchBusinessIncentivesFixed,window.addBusinessRow=addBusinessRowFixed,window.supplementWithGooglePlaces=supplementWithGooglePlaces,window.createBusinessMarker=createBusinessMarker,window.searchDatabaseWithFuzzyMatching=searchDatabaseWithFuzzyMatching,window.hasValidCoordinates=hasValidCoordinates,window.checkForNewlyAddedBusiness=checkForNewlyAddedBusiness,window.updateLoadingMessage=updateLoadingMessage,window.hideLoadingIndicator=hideLoadingIndicator,window.showNoResultsMessage=showNoResultsMessage,window.showErrorMessage=showErrorMessage,window.addEnhancedLoadingCSS=addEnhancedLoadingCSS,window.calculateSimilarity=calculateSimilarity,window.extractKeywords=extractKeywords,window.generateNameVariations=generateNameVariations,window.tryServerSideChainMatching=tryServerSideChainMatching,window.getChainFromDatabase=getChainFromDatabase,window.searchGooglePlacesForBusinessLegacy=searchGooglePlacesForBusinessLegacy,window.loadChainIncentivesInContainer=loadChainIncentivesInContainer,window.generateNameVariations=generateNameVariations,window.findMatchingChainLocally=findMatchingChainLocally,window.initGoogleMap=initGoogleMap,window.debugMapState=debugMapState,window.validateField=validateField,window.isNotEmpty=isNotEmpty,window.setupMapClickHandler=setupMapClickHandler,window.buildInfoWindowContent=buildInfoWindowContent,window.getPlaceTypeLabel=getPlaceTypeLabel,window.safeExtractCoordinates=safeExtractCoordinates,window.showInfoWindow=showInfoWindow,window.withErrorHandling=withErrorHandling,window.createEnhancedBusinessMarker=createEnhancedBusinessMarker,window.showEnhancedInfoWindow=showEnhancedInfoWindow,window.buildEnhancedInfoWindowContent=buildEnhancedInfoWindowContent,window.addEnhancedMarkerStyles=addEnhancedMarkerStyles,window.getBusinessTypeTextIcon=getBusinessTypeTextIcon,window.createEnhancedFallbackMarker=createEnhancedFallbackMarker,window.createEnhancedBusinessMarker=createEnhancedBusinessMarker,window.addEnhancedMarkerStyles=addEnhancedMarkerStyles,window.searchNearbyBusinesses=searchNearbyBusinesses,window.getSimilarBusinessTypes=getSimilarBusinessTypes,window.getBusinessLocation=getBusinessLocation,window.createSimilarBusinessMarker=createSimilarBusinessMarker,addEnhancedUserInterfaceCSS());