const isSafariOrIOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)||/iPad|iPhone|iPod/.test(navigator.userAgent),CONFIG={mapId:"ebe8ec43a7bc252d",defaultCenter:{lat:39.8283,lng:-98.5795},defaultZoom:4,markerColors:{primary:"#EA4335",nearby:"#4285F4",database:"#28a745",chain:"#FF9800"},geocodeDelay:200,imageLoadDelay:1e3,maxNearbyDistance:2e4,debugMode:!1},ENHANCED_CONFIG={...CONFIG,markerColors:{primary:"#EA4335",nearby:"#4285F4",database:"#28a745",chain:"#FF9800"}};let map=null,mapInitialized=!1,markers=[],infoWindow=null,bounds=null,pendingBusinessesToDisplay=[],currentSearchLocation=null;const placeCache=new Map,chainMatchCache=new Map,apiCallQueue=[];let isProcessingQueue=!1,googleMapsInitializing=!1,googleMapsInitialized=!1;function clearMarkers(){markers?(markers.forEach((e=>{e&&(e.map=null)})),markers=[]):markers=[]}function debugMapState(){if(console.log("==== MAP DEBUGGING INFO ===="),console.log("Map initialized:",mapInitialized),console.log("Map object exists:",!!map),map)try{const e=map.getCenter();console.log("Map center:",e?`${e.lat()}, ${e.lng()}`:"undefined"),console.log("Map zoom:",map.getZoom()),console.log("Map type:",map.getMapTypeId()),console.log("Map ID:",map.getMapId())}catch(e){console.error("Error getting map properties:",e)}if(console.log("Markers count:",markers?markers.length:0),markers&&markers.length>0&&(console.log("Markers summary:"),markers.forEach(((e,n)=>{try{let o;e.getPosition?o=e.getPosition():e.position&&(o=e.position);const a=o?"function"==typeof o.lat?`${o.lat()}, ${o.lng()}`:`${o.lat}, ${o.lng}`:"unknown";console.log(`  Marker #${n}: Business: ${e.business?e.business.bname:"unknown"}, Position: ${a}`)}catch(e){console.error(`  Error getting marker #${n} info:`,e)}}))),console.log("Bounds:",bounds?"exists":"not created"),bounds)try{const e=bounds.getNorthEast(),n=bounds.getSouthWest();if(console.log("  NE:",e?`${e.lat()}, ${e.lng()}`:"undefined"),console.log("  SW:",n?`${n.lat()}, ${n.lng()}`:"undefined"),console.log("  Empty:",bounds.isEmpty()),e&&n){const o=isNaN(e.lat())||isNaN(e.lng())||isNaN(n.lat())||isNaN(n.lng());console.log("  Has NaN coordinates:",o)}}catch(e){console.error("  Error getting bounds info:",e)}console.log("Map container:",document.getElementById("map")?"found":"not found");const e=document.getElementById("map");e&&(console.log("  Display:",window.getComputedStyle(e).display),console.log("  Dimensions:",`${e.offsetWidth} Ã— ${e.offsetHeight}`),console.log("  Position:",e.style.position),console.log("  Visibility:",window.getComputedStyle(e).visibility),console.log("  Z-index:",window.getComputedStyle(e).zIndex)),console.log("Google Maps libraries:"),console.log("  maps:",!!google.maps),console.log("  places:",!!google.maps.places),console.log("  geometry:",!!google.maps.geometry),console.log("  marker:",!!google.maps.marker),console.log("Google Maps API Key:",getGoogleMapsApiKey()?"found":"not found"),console.log("Current search location:",currentSearchLocation?`${currentSearchLocation.lat}, ${currentSearchLocation.lng}`:"none"),console.log("==== END DEBUGGING INFO ====")}function isValidPosition(e){if(!e)return console.warn("Position is null or undefined"),!1;let n,o;if(e instanceof google.maps.LatLng)try{n=e.lat(),o=e.lng()}catch(e){return console.warn("Error getting lat/lng from LatLng:",e),!1}else if("function"==typeof e.lat&&"function"==typeof e.lng)try{n=e.lat(),o=e.lng()}catch(e){return console.warn("Error calling lat/lng functions:",e),!1}else{if(void 0===e.lat||void 0===e.lng)return console.warn("Position does not have lat/lng properties"),!1;n=parseFloat(e.lat),o=parseFloat(e.lng)}return isNaN(n)||isNaN(o)?(console.warn("Position has NaN coordinates:",n,o),!1):isFinite(n)&&isFinite(o)?!(Math.abs(n)>90||Math.abs(o)>180)||(console.warn("Position coordinates out of range:",n,o),!1):(console.warn("Position has non-finite coordinates:",n,o),!1)}function createSafeLatLng(e){if(!e)return null;try{if(e instanceof google.maps.LatLng)return isValidPosition(e)?e:null;let n,o;if("function"==typeof e.lat&&"function"==typeof e.lng)n=e.lat(),o=e.lng();else if(void 0!==e.lat&&void 0!==e.lng)n=parseFloat(e.lat),o=parseFloat(e.lng);else if(void 0!==e.latitude&&void 0!==e.longitude)n=parseFloat(e.latitude),o=parseFloat(e.longitude);else{if(!(Array.isArray(e)&&e.length>=2))return console.warn("Position format not recognized:",e),null;n=parseFloat(e[0]),o=parseFloat(e[1])}return isNaN(n)||isNaN(o)||!isFinite(n)||!isFinite(o)?(console.warn("Invalid coordinates:",n,o),null):Math.abs(n)>90||Math.abs(o)>180?(console.warn("Coordinates out of range:",n,o),null):new google.maps.LatLng(n,o)}catch(e){return console.error("Error creating LatLng:",e),null}}function safelySetCenter(e,n,o){if(!e)return!1;try{const a=createSafeLatLng(n);return!!a&&(e.setCenter(a),void 0!==o&&e.setZoom(o),!0)}catch(e){return console.error("Error setting map center:",e),!1}}function safelyFitBounds(e,n,o=11){if(!e||!n)return!1;try{const o=n.getNorthEast(),a=n.getSouthWest();return!o||!a||isNaN(o.lat())||isNaN(o.lng())||isNaN(a.lat())||isNaN(a.lng())?(console.warn("Invalid bounds for fitBounds:",n),!1):n.isEmpty()?(console.warn("Empty bounds, not fitting"),!1):(e.fitBounds(n),google.maps.event.addListenerOnce(e,"bounds_changed",(function(){const n=e.getZoom();n>16?e.setZoom(16):n<4&&e.setZoom(4)})),!0)}catch(n){console.error("Error fitting bounds:",n);try{void 0!==o&&e.setZoom(o)}catch(e){console.error("Error setting fallback zoom:",e)}return!1}}function ensureGoogleMapsInitialized(){return googleMapsInitialized||googleMapsInitializing?(console.log("Google Maps already initialized or initializing"),Promise.resolve()):new Promise(((e,n)=>{try{if(googleMapsInitializing=!0,console.log("Starting Google Maps initialization"),window.google&&window.google.maps)return console.log("Google Maps API is already loaded, just initializing map"),initGoogleMap(),googleMapsInitialized=!0,googleMapsInitializing=!1,void e();const o=window.appConfig?.googleMapsApiKey||getGoogleMapsApiKey(),a=window.appConfig?.googleMapsMapId||CONFIG.mapId;window.initGoogleMapCallback=function(){console.log("Google Maps callback executed"),initGoogleMap(),googleMapsInitialized=!0,googleMapsInitializing=!1,e()};const t=document.createElement("script");t.src=`https://maps.googleapis.com/maps/api/js?key=${o}&map_ids=${a}&libraries=places,geometry,marker&callback=initGoogleMapCallback&loading=async&v=weekly`,t.async=!0,t.defer=!0,t.onerror=function(e){console.error("Google Maps API failed to load:",e),googleMapsInitializing=!1,n(e)},document.head.appendChild(t)}catch(e){googleMapsInitializing=!1,console.error("Error initializing Google Maps:",e),n(e)}}))}function addCustomMarkerStyles(){if(!document.getElementById("custom-marker-css")){const e=document.createElement("style");e.id="custom-marker-css",e.textContent='\n            .custom-marker {\n                cursor: pointer;\n            }\n            \n            .marker-container {\n                position: relative;\n                width: 32px;\n                height: 40px;\n            }\n            \n            .marker-pin {\n                width: 32px;\n                height: 40px;\n                border-radius: 50% 50% 50% 0;\n                background-color: #EA4335;\n                transform: rotate(-45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n                position: absolute;\n                top: 0;\n                left: 0;\n            }\n            \n            .marker-pin.nearby {\n                background-color: #4285F4;\n            }\n            \n            .marker-icon {\n                transform: rotate(45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                width: 20px;\n                height: 20px;\n            }\n            \n            /* Critical fix - ensure Font Awesome icons are visible */\n            .marker-icon i.fas,\n            .marker-icon i.fa,\n            .marker-icon i.far,\n            .marker-icon i.fab {\n                display: inline-block !important;\n                font-size: 14px !important;\n                color: white !important;\n                line-height: 1 !important;\n                width: auto !important;\n                height: auto !important;\n                vertical-align: middle !important;\n            }\n            \n            /* Fallback icon content for missing Font Awesome */\n            .marker-icon i.fas.fa-store-alt:after {\n                content: "ðŸª";\n                font-family: sans-serif;\n                font-size: 14px;\n            }\n            \n            .marker-icon i.fas.fa-shopping-cart:after {\n                content: "ðŸ›’";\n                font-family: sans-serif;\n                font-size: 14px;\n            }\n            \n            .marker-shadow {\n                background-color: rgba(0, 0, 0, 0.2);\n                border-radius: 50%;\n                height: 14px;\n                width: 14px;\n                position: absolute;\n                bottom: -3px;\n                left: 9px;\n                filter: blur(2px);\n                z-index: -1;\n            }\n            \n            /* Info window action button styling */\n            .info-window-actions {\n                margin-top: 12px;\n                padding-top: 8px;\n                border-top: 1px solid #eee;\n                text-align: right;\n            }\n            \n            .info-window-actions .add-business-btn,\n            .info-window-actions .view-details-btn {\n                margin-top: 8px;\n                font-weight: bold;\n                text-transform: uppercase;\n                font-size: 12px;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                transition: background-color 0.2s ease;\n                border: none;\n                color: white;\n                letter-spacing: 0.5px;\n                display: inline-block;\n            }\n            \n            .info-window-actions .add-business-btn {\n                background-color: #EA4335;\n            }\n            \n            .info-window-actions .add-business-btn:hover {\n                background-color: #D32F2F;\n            }\n            \n            .info-window-actions .view-details-btn {\n                background-color: #4285F4;\n            }\n            \n            .info-window-actions .view-details-btn:hover {\n                background-color: #2A75F3;\n            }\n        ',document.head.appendChild(e)}}function addChainBadgeStyles(){if(!document.getElementById("chain-badge-css")){const e=document.createElement("style");e.id="chain-badge-css",e.textContent="\n            .chain-badge {\n                display: inline-block;\n                background-color: #4285F4;\n                color: white;\n                padding: 2px 6px;\n                border-radius: 4px;\n                font-size: 0.8em;\n                margin-left: 5px;\n                font-weight: normal;\n            }\n\n            .chain-badge.small {\n                font-size: 0.7em;\n                padding: 1px 4px;\n            }\n            \n            .admin-action-btn {\n                background-color: #673AB7;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .view-chain-btn {\n                background-color: #2196F3;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .add-to-db-btn {\n                background-color: #4CAF50;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .view-map-btn {\n                background-color: #FF9800;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n        ",document.head.appendChild(e)}}function getUserLocation(){return new Promise(((e,n)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition((n=>{const o={lat:n.coords.latitude,lng:n.coords.longitude};console.log("Got user location:",o),e(o)}),(e=>{console.warn("Error getting location:",e),n(e)}),{enableHighAccuracy:!0,timeout:5e3,maximumAge:0}):(console.warn("Geolocation not supported by this browser"),n(new Error("Geolocation not supported")))}))}async function getChainDetailsFromChainsAPI(e){if(!e)return null;const n=getBaseURL();try{const o=await fetch(`${n}/api/chains.js?operation=get&id=${e}`);if(!o.ok)throw new Error(`Failed to get chain details: ${o.status}`);const a=await o.json();return a.success&&a.chain?(console.log("ðŸ“Š Complete chain details retrieved:",a.chain),{_id:a.chain._id,chain_name:a.chain.chain_name,business_type:a.chain.business_type,universal_incentives:a.chain.universal_incentives,status:a.chain.status,incentives:a.chain.incentives||[]}):null}catch(e){return console.error("Error getting complete chain details:",e),null}}async function getChainDetails(e){if(!e)return null;const n=getBaseURL();try{const o=await fetch(`${n}/api/chains.js?operation=get&id=${e}`);if(!o.ok)throw new Error(`Failed to get chain details: ${o.status}`);const a=await o.json();return a.chain?{_id:a.chain._id,bname:a.chain.chain_name,type:a.chain.business_type,universal_incentives:a.chain.universal_incentives,is_chain:!0}:null}catch(e){return console.error("Error getting chain details:",e),null}}function getAddressComponent(e,n){if(!e||!Array.isArray(e))return"";const o=e.find((e=>e.types&&e.types.includes(n)));return o&&(o.shortText||o.short_name)||""}function getBusinessTypeLabel(e){return{AUTO:"Automotive",BEAU:"Beauty",BOOK:"Bookstore",CLTH:"Clothing",CONV:"Convenience Store/Gas Station",DEPT:"Department Store",ELEC:"Electronics",ENTR:"Entertainment",FURN:"Furniture",FUEL:"Fuel Station/Truck Stop",GIFT:"Gift Shop",GROC:"Grocery",HARDW:"Hardware",HEAL:"Health",HOTEL:"Hotel/Motel",JEWL:"Jewelry",OTHER:"Other",RX:"Pharmacy",REST:"Restaurant",RETAIL:"Retail",SERV:"Service",SPEC:"Specialty",SPRT:"Sporting Goods",TECH:"Technology",TOYS:"Toys"}[e]||e}function getIncentiveTypeLabel(e){return{VT:"Veteran",AD:"Active-Duty",FR:"First Responder",SP:"Spouse",OT:"Other"}[e]||e}function getBaseURL(){return"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:window.location.origin}function initBusinessSearch(){console.log("Business search initialization...");const e={businessName:document.getElementById("business-name"),address:document.getElementById("address"),useMyLocation:document.getElementById("use-my-location")},n=document.getElementById("business-search-form");n?n.addEventListener("submit",(async function(n){if(n.preventDefault(),!e.businessName?.value&&!e.address?.value&&!e.useMyLocation?.checked)return void alert("Please enter either a business name, an address, or use your current location to search");const o={businessName:e.businessName?.value||"",address:e.address?.value||"",useMyLocation:e.useMyLocation?.checked||!1};if(console.log("Form data to submit:",o),mapInitialized){clearMarkers();const e=document.getElementById("initial-map-message");e&&e.remove(),await performEnhancedBusinessSearch(o,!1)}else console.warn("Map not initialized yet. Will initialize and display businesses after map loads."),ensureGoogleMapsInitialized().then((async()=>{clearMarkers(),await performEnhancedBusinessSearch(o,!1)})).catch((e=>{console.error("Failed to initialize Google Maps:",e),alert("There was a problem loading the map. Please try refreshing the page.")}))})):console.warn("Business search form not found in the DOM"),e.businessName&&e.businessName.addEventListener("input",(function(){validateField(this,isNotEmpty)})),e.address&&e.address.addEventListener("input",(function(){validateField(this,isNotEmpty)})),e.useMyLocation&&e.useMyLocation.addEventListener("change",(function(){const n=document.getElementById("location-status");this.checked?(e.address&&(e.address.disabled=!0,e.address.placeholder="Using your current location..."),n&&(n.textContent="Location will be used when you search",n.style.display="block",n.style.color="#666")):(e.address&&(e.address.disabled=!1,e.address.placeholder="Address, City, State, or Zip"),n&&(n.style.display="none"))})),addRefreshButton(),checkForNewlyAddedBusiness()}function addRefreshButton(){const e=document.getElementById("business-search-form");if(!e)return;if(document.getElementById("refresh-search-btn"))return;const n=document.createElement("button");n.id="refresh-search-btn",n.type="button",n.className="refresh-btn",n.innerHTML='<i class="fas fa-sync-alt"></i> Refresh Results',n.style.marginLeft="10px",n.style.backgroundColor="#28a745",n.style.color="white",n.style.border="none",n.style.borderRadius="4px",n.style.padding="8px 12px",n.style.cursor="pointer",n.addEventListener("click",(async function(){const e={businessName:document.getElementById("business-name")?.value||"",address:document.getElementById("address")?.value||"",useMyLocation:document.getElementById("use-my-location")?.checked||!1};clearMarkers();const n=document.getElementById("initial-map-message");n&&n.remove(),this.innerHTML='<i class="fas fa-sync-alt fa-spin"></i> Refreshing...',await performEnhancedBusinessSearch(e,!1),setTimeout((()=>{this.innerHTML='<i class="fas fa-sync-alt"></i> Refresh Results'}),1e3)}));const o=e.querySelector('input[type="submit"]');o&&o.parentNode?o.parentNode.insertBefore(n,o.nextSibling):e.appendChild(n)}function checkForNewlyAddedBusiness(){const e=new URLSearchParams(window.location.search),n=e.get("business_added"),o=e.get("business_name"),a=e.get("business_id");if("true"===n&&o){showBusinessAddedSuccessMessage(o,a);const e=window.location.pathname;window.history.replaceState({},document.title,e);const n=document.getElementById("business-name"),t=document.getElementById("address");n&&(n.value=o,validateField(n,isNotEmpty)),t&&(t.value=""),setTimeout((()=>{const e=document.getElementById("business-search-form");if(e){const n=new Event("submit",{cancelable:!0});e.dispatchEvent(n)}}),1e3)}}async function searchGooglePlacesForBusiness(e,n){try{console.log("Searching Google Places (new API) for:",e,"near",n);const{Place:o,SearchNearbyRequest:a}=await google.maps.importLibrary("places"),t=new google.maps.LatLng(n.lat,n.lng),i={textQuery:e,locationBias:{center:t,radius:4e4},maxResultCount:20,fields:["id","displayName","formattedAddress","location","types","nationalPhoneNumber","internationalPhoneNumber"]};console.log("New Places API request:",i);const{places:s}=await o.searchByText(i);if(!s||0===s.length)return console.log("No businesses found via new Places API"),[];console.log("Found businesses via new Places API:",s.length);const r=s.filter((n=>{const o=n.displayName.toLowerCase();return o.includes("pro desk")||o.includes("garden center")||o.includes("rental center")||o.includes("tool rental")||o.includes("customer service")?(console.log("Filtering out department:",n.displayName),!1):!(o.includes(" - ")&&!o.toLowerCase().startsWith(e.toLowerCase())&&(console.log("Filtering out formatted result:",n.displayName),1))}));console.log(`Filtered to ${r.length} main store results`);const c=r.map((async e=>{const o=e.formattedAddress?e.formattedAddress.split(","):[];let a="",i="",s="",r="";if(o.length>=1&&(a=o[0].trim()),o.length>=2&&(i=o[1].trim()),o.length>=3){const e=o[2].trim().match(/^([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/);e&&(s=e[1],r=e[2])}const c=e.location,l=google.maps.geometry.spherical.computeDistanceBetween(t,c);let d=0,g=0;if(e.location)try{d="function"==typeof e.location.lat?e.location.lat():e.location.lat||0,g="function"==typeof e.location.lng?e.location.lng():e.location.lng||0}catch(e){console.warn("Error extracting coordinates from new Places API:",e),d=n.lat,g=n.lng}const u={_id:"google_"+e.id,bname:e.displayName,address1:a,city:i,state:s,zip:r,formattedAddress:e.formattedAddress,type:mapGooglePlaceTypeToBusinessType(e.types),phone:e.nationalPhoneNumber||e.internationalPhoneNumber||"",isGooglePlace:!0,placeId:e.id,lat:d,lng:g,distance:l};try{const n=await findMatchingChainForPlaceResult(e.displayName);n?(console.log(`Found chain match for "${e.displayName}": ${n.bname}`),u.chain_id=n._id,u.chain_name=n.bname,u.isChainLocation=!0):console.log(`No chain match found for: ${e.displayName}`)}catch(e){console.warn("Error checking for chain match:",e)}return u})),l=await Promise.all(c);return l.sort(((e,n)=>e.distance-n.distance)),console.log("Final processed businesses with new API:",l.map((e=>({name:e.bname,placeId:e.placeId,isChain:!!e.chain_id,chainName:e.chain_name})))),l}catch(o){return console.error("Error in new Places API search:",o),console.warn("Falling back to deprecated PlacesService API"),await searchGooglePlacesForBusinessLegacy(e,n)}}async function searchGooglePlacesForBusinessLegacy(e,n){return new Promise(((o,a)=>{try{if(console.log("Using legacy PlacesService as fallback"),!map)return void a(new Error("Map not initialized"));const t=new google.maps.LatLng(n.lat,n.lng),i=new google.maps.places.PlacesService(map),s={query:e,location:t,radius:4e4};i.textSearch(s,(async(e,n)=>{if(n===google.maps.places.PlacesServiceStatus.OK&&e&&e.length>0){const n=e.filter((e=>{const n=e.name.toLowerCase();return!n.includes("pro desk")&&!n.includes("garden center")&&!n.includes("rental center")})),a=await Promise.all(n.map((async e=>{const n={_id:"google_"+e.place_id,bname:e.name,isGooglePlace:!0,placeId:e.place_id,lat:e.geometry.location.lat(),lng:e.geometry.location.lng()},o=await findMatchingChainForPlaceResult(e.name);return o&&(n.chain_id=o._id,n.chain_name=o.bname,n.isChainLocation=!0),n})));o(a)}else console.log("Legacy API also found no results"),o([])}))}catch(e){a(e)}}))}function displayBusinessesOnMap(e){if(!map)return console.log("Map not ready, storing businesses for later display"),void(pendingBusinessesToDisplay=e);console.log("Displaying businesses on map:",e.length),clearMarkers(),bounds=new google.maps.LatLngBounds;let n=0,o=0,a=0;e.forEach((e=>{try{if(console.log("Processing business for map:",e.bname),!0===e.is_chain)return console.log(`Skipping parent chain business: ${e.bname} (no physical location)`),void a++;let t,i;if(e.location&&e.location.coordinates&&Array.isArray(e.location.coordinates)&&e.location.coordinates.length>=2)i=e.location.coordinates[0],t=e.location.coordinates[1];else{if(void 0===e.lat||void 0===e.lng)return console.warn(`Business ${e.bname} missing coordinates`),void a++;t=parseFloat(e.lat),i=parseFloat(e.lng)}if(isNaN(t)||isNaN(i)||0===t||0===i)return console.warn(`Invalid coordinates for ${e.bname}: lat=${t}, lng=${i}`),void a++;if(Math.abs(t)>90||Math.abs(i)>180)return console.warn(`Coordinates out of range for ${e.bname}: lat=${t}, lng=${i}`),void a++;if(e.lat=t,e.lng=i,createBusinessMarker(e)){if(n++,window.currentSearchLocation){const n=new google.maps.LatLng(t,i),a=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng),s=google.maps.geometry.spherical.computeDistanceBetween(n,a);s<=80467?(o++,console.log(`${e.bname} is ${(621371e-9*s).toFixed(1)} miles from search location`)):console.log(`${e.bname} is ${(621371e-9*s).toFixed(1)} miles from search location (distant)`)}const a=new google.maps.LatLng(t,i);bounds.extend(a)}}catch(n){console.error(`Error adding business ${e.bname} to map:`,n),a++}})),console.log(`Added ${n} valid markers to the map (${o} nearby, ${a} skipped)`),setTimeout((()=>{try{if(window.currentSearchLocation&&o>0){console.log("Centering map on search location with nearby businesses");const e=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng);map.setCenter(e),map.setZoom(12)}else if(window.currentSearchLocation&&n>0){console.log("Centering map on search location (distant businesses only)");const e=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng);map.setCenter(e),map.setZoom(10)}else n>0&&bounds&&!bounds.isEmpty()?(console.log("No search location, fitting map to business bounds"),safelyFitBounds(map,bounds)):(console.log("Using default map center (no valid businesses to display)"),map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom))}catch(e){console.error("Error updating map view:",e)}}),200)}async function geocodeAddressClientSide(e){return new Promise(((n,o)=>{try{if(console.log(`Geocoding address client-side: ${e}`),!e)return console.error("No address provided for geocoding"),void o(new Error("No address provided"));if(!window.google||!window.google.maps)return void o(new Error("Google Maps API not loaded"));(new google.maps.Geocoder).geocode({address:e},(function(e,a){if(a===google.maps.GeocoderStatus.OK&&e&&e.length>0){const o=e[0].geometry.location,a={lat:o.lat(),lng:o.lng(),formattedAddress:e[0].formatted_address};console.log("Client-side geocoding result:",a),n(a)}else console.error("Client-side geocoding failed:",a),o(new Error(`Geocoding failed: ${a}`))}))}catch(e){console.error("Error in client-side geocoding:",e),o(e)}}))}function applyMapHeightFix(){if(!document.getElementById("map-height-fix")){const e=document.createElement("style");e.id="map-height-fix",e.textContent=mapHeightCSS,document.head.appendChild(e),console.log("Applied map height and info window positioning fixes"),map&&google.maps.event&&setTimeout((()=>{google.maps.event.trigger(map,"resize"),console.log("Triggered map resize event")}),100)}}window.viewBusinessDetails=function(e){console.log("View details for business:",e),alert("This feature is coming soon: View details for "+e)},window.addBusinessToDatabase=async function(e,n=null){console.log("ðŸ”— CHAIN INCENTIVE FIX: Adding place to database with proper chain inheritance:",e,"Chain ID:",n);try{const{Place:o}=await google.maps.importLibrary("places"),a=new o({id:e});await a.fetchFields({fields:["displayName","formattedAddress","addressComponents","location","nationalPhoneNumber","internationalPhoneNumber"]}),console.log("Place details retrieved:",a);const t={};if(a.addressComponents)for(const e of a.addressComponents)for(const n of e.types)t[n]=e.shortText||e.longText;const i={name:a.displayName||"",address1:(t.street_number||"")+" "+(t.route||""),city:t.locality||"",state:t.administrative_area_level_1||"",zip:t.postal_code||"",phone:a.nationalPhoneNumber||a.internationalPhoneNumber||"",placeId:a.id,formattedAddress:a.formattedAddress,lat:a.location?.lat()||0,lng:a.location?.lng()||0,location:{type:"Point",coordinates:[a.location?.lng()||0,a.location?.lat()||0]}};let s=null,r="";if(n)try{s=await getChainDetailsFromChainsAPI(n),s?(i.chain_id=n,i.chain_name=s.chain_name,i.is_chain_location=!0,i.universal_incentives=s.universal_incentives,r=`ðŸ”— CHAIN INCENTIVE INHERITANCE: This business will inherit chain settings!\n\nâœ¨ Chain Benefits:\nâ€¢ Chain Name: ${s.chain_name}\nâ€¢ Universal Incentives: ${s.universal_incentives?"YES - Chain incentives will apply":"No"}\nâ€¢ Automatic chain-wide incentive access\nâ€¢ Consistent branding and information\n\n`,console.log(`âœ… CHAIN INHERITANCE: ${i.name} â†’ ${i.chain_name}`),console.log(`   - Chain ID: ${n}`),console.log(`   - Universal Incentives: ${i.universal_incentives}`)):console.warn(`âš ï¸ Chain details not found for ID: ${n}`)}catch(e){console.error("âŒ Error getting chain details:",e)}else{console.log("ðŸ” ATTEMPTING AUTO CHAIN DETECTION...");try{const e=await findMatchingChainForPlaceResult(a.displayName);e?(s=await getChainDetailsFromChainsAPI(e._id),s&&(i.chain_id=e._id,i.chain_name=s.chain_name,i.is_chain_location=!0,i.universal_incentives=s.universal_incentives,r=`ðŸŽ¯ AUTO CHAIN DETECTION: We detected this matches ${i.chain_name}!\n\nâœ¨ Auto Chain Benefits:\nâ€¢ Chain Name: ${s.chain_name}\nâ€¢ Universal Incentives: ${s.universal_incentives?"YES - Chain incentives will apply automatically":"No"}\nâ€¢ No manual linking required\nâ€¢ Automatic incentive inheritance\n\n`,console.log(`ðŸŽ¯ AUTO CHAIN DETECTION: ${i.name} â†’ ${i.chain_name}`),console.log(`   - Chain ID: ${i.chain_id}`),console.log(`   - Universal Incentives: ${i.universal_incentives}`))):console.log("â„¹ï¸ No chain match found for auto-detection")}catch(e){console.error("âŒ Auto chain detection failed:",e)}}const c=`${r}You will now be redirected to the "Add Business" page where the form will be pre-filled with this business information.\n\n${s?`ðŸ”— Chain association and incentive inheritance will be automatically included!\n\nðŸ“‹ Chain Details:\nâ€¢ Name: ${s.chain_name}\nâ€¢ Universal Incentives: ${s.universal_incentives?"Enabled":"Disabled"}\nâ€¢ Business Type: ${s.business_type}`:""}\n\nAfter you complete adding the business, you will be returned to this search page.\n\nClick OK to continue.`;confirm(c)&&(sessionStorage.setItem("newBusinessData",JSON.stringify(i)),sessionStorage.setItem("returnToSearch",window.location.href),s&&sessionStorage.setItem("autoChainLinking",JSON.stringify({chainId:i.chain_id,chainName:i.chain_name,universalIncentives:i.universal_incentives,autoDetected:!n,message:r})),window.location.href="business-add.html?prefill=true&auto_chain=true")}catch(e){console.error("âŒ Error in enhanced addBusinessToDatabase with chain inheritance:",e),alert("Sorry, we couldn't retrieve the business information. Please try again or add it manually.")}};const mapHeightCSS="\n#map {\n    width: 100%;\n    height: 800px !important; /* Increased from 500px */\n    min-height: 800px;\n    border: 1px solid #ccc;\n    border-radius: 4px;\n    margin: 10px 0;\n    position: relative;\n}\n\n#map-container {\n    width: 90%;\n    margin: 20px auto;\n    clear: both;\n}\n\n.map-controls {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 10px;\n    padding: 0 5px;\n}\n\n/* Ensure proper info window positioning */\n.gm-style .gm-style-iw-c {\n    padding: 0 !important;\n    border-radius: 8px !important;\n    box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n    max-width: 330px !important;\n    max-height: 400px !important;\n    overflow: hidden !important;\n    position: relative !important;\n    z-index: 1000 !important;\n    /* Ensure it's positioned correctly relative to the tail */\n    margin-bottom: 15px !important;\n}\n\n.gm-style .gm-style-iw-d {\n    overflow: auto !important;\n    max-height: 350px !important;\n    padding-right: 8px !important;\n}\n\n.gm-style .gm-style-iw {\n    /* Override any problematic positioning */\n    position: relative !important;\n    z-index: 1001 !important;\n}\n\n.gm-style .gm-style-iw-t {\n    position: absolute !important;\n    width: 100% !important;\n    /* Override the inline bottom positioning that's causing the issue */\n    bottom: 0px !important;\n    /* Ensure proper positioning */\n    right: auto !important;\n    left: 50% !important;\n    transform: translateX(-50%) !important;\n    /* Make sure it's properly sized */\n    height: 15px !important;\n}\n\n.gm-style .gm-style-iw-tc {\n    /* This is the tail connector - make sure it's positioned correctly */\n    top: auto !important;\n    bottom: -15px !important;\n    left: 50% !important;\n    right: auto !important;\n    transform: translateX(-50%) !important;\n    width: 24px !important;\n    height: 24px !important;\n}\n";function safeExtractCoordinates(e){try{if(!e)return null;let n,o;if("function"==typeof e.lat&&"function"==typeof e.lng)n=e.lat(),o=e.lng();else if(void 0!==e.lat&&void 0!==e.lng)n=parseFloat(e.lat),o=parseFloat(e.lng);else if(void 0!==e.latitude&&void 0!==e.longitude)n=parseFloat(e.latitude),o=parseFloat(e.longitude);else{if(!(Array.isArray(e)&&e.length>=2))return console.warn("Unrecognized location object format:",e),null;n=parseFloat(e[0]),o=parseFloat(e[1])}return isNaN(n)||isNaN(o)||!isFinite(n)||!isFinite(o)?(console.warn("Invalid coordinates extracted:",n,o),null):Math.abs(n)>90||Math.abs(o)>180?(console.warn("Coordinates out of valid range:",n,o),null):{lat:n,lng:o}}catch(e){return console.error("Error extracting coordinates:",e),null}}function showInfoWindow(e){if(console.log("showInfoWindow called with marker:",e),!e||!e.business)return void console.error("Invalid marker for info window",e);const n=e.business;console.log("Business data for info window:",n),infoWindow&&infoWindow.close(),infoWindow=new google.maps.InfoWindow({maxWidth:300,disableAutoPan:!1});const o=buildInfoWindowContent(n);infoWindow.setContent(o);let a=null;if(e.getPosition&&"function"==typeof e.getPosition)try{a=e.getPosition()}catch(e){console.warn("Error getting position from marker.getPosition():",e)}if(!a&&e.position&&(a=e.position),!a&&n){const e=safeExtractCoordinates(n);e&&(a=new google.maps.LatLng(e.lat,e.lng))}a||(console.error("Could not determine position for info window"),a=new google.maps.LatLng(39.8283,-98.5795));const t=safeExtractCoordinates(a);if(!t)return void console.error("Invalid position for info window");const i=new google.maps.LatLng(t.lat,t.lng);try{map.panTo(i)}catch(e){console.warn("Error panning to position:",e)}setTimeout((()=>{try{e.getPosition?infoWindow.open(map,e):(infoWindow.setPosition(i),infoWindow.open(map)),console.log("Info window opened successfully"),google.maps.event.addListenerOnce(infoWindow,"domready",(function(){console.log("Info window DOM ready"),setTimeout((()=>{fixInfoWindowPositioning(),n.isGooglePlace?n.chain_id&&setTimeout((()=>{loadChainIncentivesForInfoWindow(n.placeId,n.chain_id)}),200):setTimeout((()=>{loadIncentivesForInfoWindow(n._id)}),200)}),300)}))}catch(e){console.error("Error opening info window:",e)}}),200)}function withErrorHandling(e,n){return function(...o){try{return e.apply(this,o)}catch(e){return console.error(`Error in ${n}:`,e),null}}}function fixInfoWindowPositioning(){console.log("Applying info window positioning fix");const e=document.querySelector(".gm-style-iw-c"),n=document.querySelector(".gm-style-iw-d"),o=document.querySelector(".gm-style-iw-t");if(!e)return void console.log("Info window container not found");const a=e.getBoundingClientRect();if(console.log("Info window position:",a),a.width<50&&(console.log("Info window width too small, forcing proper dimensions"),e.style.width="auto",e.style.minWidth="280px",e.style.maxWidth="320px",n&&(n.style.width="auto",n.style.minWidth="280px")),a.top<0||a.top>window.innerHeight||a.left<0||a.left>window.innerWidth||a.width<50){console.log("Info window has positioning/sizing issues, applying comprehensive fix");const n=e.style.transform;if(n&&n.includes("translate")){console.log("Current transform:",n);const o=n.match(/translate\(([^,]+),\s*([^)]+)\)/);if(o){const n=parseFloat(o[1]),a=parseFloat(o[2]);(Math.abs(n)>window.innerWidth||Math.abs(a)>window.innerHeight)&&(console.log("Resetting extreme transform values"),e.style.transform="translate(0px, 0px)")}}e.style.display="block",e.style.visibility="visible",e.style.opacity="1",o&&(o.style.bottom="0px",o.style.left="50%",o.style.right="auto",o.style.transform="translateX(-50%)"),console.log("Applied comprehensive positioning fix"),setTimeout((()=>{google.maps.event.trigger(map,"resize");const n=e.getBoundingClientRect();console.log("Info window dimensions after fix:",n)}),100)}}function loadIncentivesForInfoWindow(e){const n=document.getElementById(`incentives-container-${e}`);if(!n)return void console.error("Incentives container not found for business:",e);const o=getBaseURL();fetch(`${o}/api/combined-api.js?operation=incentives&business_id=${e}`).then((e=>e.json())).then((e=>{if(!e.results||0===e.results.length)return void(n.innerHTML='<p style="margin:4px 0; font-style:italic; color:#666;">No incentives available</p>');let o='<p style="margin:4px 0;"><strong>Incentives:</strong></p><ul style="margin:4px 0; padding-left:16px; font-size:13px;">';e.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),a=e.other_description?` (${e.other_description})`:"",t=e.is_chain_wide?'<span style="background-color:#4285F4; color:white; padding:1px 4px; border-radius:3px; font-size:11px; margin-left:4px;">Chain-wide</span>':"";o+=`<li style="margin-bottom:4px;"><strong>${n}${a}:</strong> ${e.amount}% ${t}</li>`}})),o+="</ul>",n.innerHTML=o})).catch((e=>{console.error("Error loading incentives:",e),n.innerHTML='<p style="margin:4px 0; font-style:italic; color:#666;">Error loading incentives</p>'}))}function loadChainIncentivesForInfoWindow(e,n){const o=document.getElementById(`incentives-container-${e}`);if(!o)return void console.error("Incentives container not found for place:",e);const a=getBaseURL();fetch(`${a}/api/combined-api.js?operation=incentives&business_id=${n}`).then((e=>e.json())).then((e=>{if(!e.results||0===e.results.length)return void(o.innerHTML='<p style="margin:4px 0; font-style:italic; color:#666;">No chain incentives available</p>');let n='<p style="margin:4px 0;"><strong>Chain Incentives:</strong></p><ul style="margin:4px 0; padding-left:16px; font-size:13px;">';e.results.forEach((e=>{if(e.is_available){const o=getIncentiveTypeLabel(e.type),a=e.other_description?` (${e.other_description})`:"";n+=`<li style="margin-bottom:4px;"><strong>${o}${a}:</strong> ${e.amount}% <span style="background-color:#4285F4; color:white; padding:1px 4px; border-radius:3px; font-size:11px; margin-left:4px;">Chain-wide</span></li>`}})),n+="</ul>",n+='<p style="margin:8px 0 4px 0; font-size:12px; font-style:italic; color:#666;">These incentives apply to all locations of this chain.</p>',o.innerHTML=n})).catch((e=>{console.error("Error loading chain incentives:",e),o.innerHTML='<p style="margin:4px 0; font-style:italic; color:#666;">Error loading chain incentives</p>'}))}function applyInfoWindowCSS(){if(!document.getElementById("info-window-fix-css")){const e=document.createElement("style");e.id="info-window-fix-css",e.textContent="\n            /* Ensure info windows are visible and properly positioned */\n            .gm-style .gm-style-iw-c {\n                max-width: 320px !important;\n                max-height: 400px !important;\n                padding: 0 !important;\n                border-radius: 8px !important;\n                box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n                overflow: hidden !important;\n            }\n\n            .gm-style .gm-style-iw-d {\n                overflow: auto !important;\n                max-height: 350px !important;\n            }\n\n            .gm-style .gm-style-iw {\n                display: block !important;\n                visibility: visible !important;\n                opacity: 1 !important;\n            }\n\n            /* Fix tail positioning */\n            .gm-style .gm-style-iw-t {\n                bottom: 0px !important;\n                left: 50% !important;\n                right: auto !important;\n                transform: translateX(-50%) !important;\n                width: 20px !important;\n                height: 15px !important;\n            }\n\n            /* Ensure close button is visible */\n            .gm-ui-hover-effect {\n                opacity: 0.8 !important;\n                top: 2px !important;\n                right: 2px !important;\n            }\n\n            .gm-ui-hover-effect:hover {\n                opacity: 1 !important;\n            }\n\n            /* Custom scrollbar for info window content */\n            .gm-style .gm-style-iw-d::-webkit-scrollbar {\n                width: 6px;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-track {\n                background: #f1f1f1;\n                border-radius: 3px;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb {\n                background: #c1c1c1;\n                border-radius: 3px;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb:hover {\n                background: #a8a8a8;\n            }\n        ",document.head.appendChild(e),console.log("Applied info window CSS fixes")}}function applyCSSOnlyTailFix(){if(!document.getElementById("css-only-tail-fix")){const e=document.createElement("style");e.id="css-only-tail-fix",e.textContent="\n            /* Target only the tail positioning without affecting the container */\n            .gm-style .gm-style-iw-t {\n                bottom: 0px !important;\n                left: 0px !important;\n                right: 0px !important;\n                transform: translateX(-50%) !important;\n                width: 0 !important;\n                height: 0 !important;\n            }\n            \n            /* Don't touch the main container transform */\n            .gm-style .gm-style-iw-c {\n                /* Let Google handle the main positioning */\n            }\n        ",document.head.appendChild(e),console.log("Applied CSS-only tail fix")}}function applyInfoWindowPositioningFixes(){if(!document.getElementById("final-info-window-fix")){const e=document.createElement("style");e.id="final-info-window-fix",e.textContent="\n            /* CRITICAL: Override Google's tail positioning that causes off-screen issues */\n            ..gm-style .gm-style-iw-t {\n                bottom: 0px !important;\n                left: 0px !important;\n                right: 0px !important;\n                transform: translateX(-50%) !important;\n                width: 0 !important;\n                height: 0 !important;\n            }\n            \n            /* Prevent off-screen positioning */\n            .gm-style .gm-style-iw-c {\n                max-width: 320px !important;\n                max-height: 400px !important;\n                overflow: hidden !important;\n                /* Prevent problematic transforms */\n                transform: none !important;\n            }\n            \n            /* Ensure visibility */\n            .gm-style .gm-style-iw {\n                display: block !important;\n                visibility: visible !important;\n                opacity: 1 !important;\n            }\n            \n            .gm-style .gm-style-iw-d {\n                overflow: auto !important;\n                max-height: 350px !important;\n            }\n            \n            /* Fix tail connector */\n            .gm-style .gm-style-iw-tc {\n                top: auto !important;\n                bottom: -15px !important;\n                left: 50% !important;\n                right: auto !important;\n                transform: translateX(-50%) !important;\n            }\n            \n            /* Map container styles */\n            #map-container {\n                width: 90%;\n                margin: 20px auto;\n                clear: both;\n                position: relative;\n            }\n\n            #map {\n                width: 100%;\n                height: 800px !important;\n                min-height: 800px;\n                border: 1px solid #ccc;\n                border-radius: 4px;\n                margin: 10px 0;\n                position: relative;\n                z-index: 1;\n            }\n        ",document.head.appendChild(e),console.log("Applied final info window positioning fixes")}}function removeProblematicInfoWindowCSS(){document.querySelectorAll("#info-window-position-fix, #map-height-fix").forEach((e=>{console.log("Removing potentially problematic style:",e.id),e.remove()}));const e=document.createElement("style");e.id="minimal-info-window-fix",e.textContent="\n        /* Minimal CSS to ensure info windows are visible */\n        .gm-style .gm-style-iw-c {\n            max-width: 320px !important;\n            max-height: 400px !important;\n            overflow: visible !important;\n        }\n        \n        .gm-style .gm-style-iw-d {\n            overflow: auto !important;\n            max-height: 350px !important;\n        }\n        \n        .gm-style .gm-style-iw {\n            display: block !important;\n            visibility: visible !important;\n            opacity: 1 !important;\n        }\n        \n        /* Don't touch the tail positioning for now */\n        .gm-style .gm-style-iw-t {\n            /* Let Google handle this naturally */\n        }\n    ",document.head.appendChild(e),console.log("Applied minimal info window CSS")}function findMatchingChainLocally(e){return new Promise((n=>{try{if(!e)return void n(null);console.log("Enhanced local chain matching for:",e);const o=[{name:"The Home Depot",variations:["the home depot","home depot","homedepot"],id:"6831163b09ee562f96d2a573"},{name:"Lowe's",variations:["lowes","lowe's","lowes home improvement","lowe's home improvement"],id:"6831163b09ee562f96d2a572"},{name:"Walmart",variations:["walmart","wal-mart","walmart supercenter"],id:"walmart_chain_id"},{name:"Target",variations:["target","target store"],id:"target_chain_id"},{name:"Best Buy",variations:["best buy","bestbuy"],id:"bestbuy_chain_id"},{name:"McDonald's",variations:["mcdonalds","mcdonald's","mickey d's"],id:"mcdonalds_chain_id"}],a=e.toLowerCase().trim();for(const t of o)for(const o of t.variations)if(a===o||a.includes(o)||o.includes(a))return console.log(`Enhanced local match: "${e}" matches "${t.name}"`),void n({_id:t.id,bname:t.name,isLocalMatch:!0});console.log("No enhanced local chain match found for:",e),n(null)}catch(e){console.error("Error in enhanced local chain matching:",e),n(null)}}))}async function setupMapClickHandler(){if(map){console.log("Setting up map click handler with precise conflict detection");try{const{Place:e}=await google.maps.importLibrary("places");map.addListener("click",(async function(n){if(console.log("Map clicked",n),n.placeId){console.log("POI clicked, placeId:",n.placeId);const o=markers.find((e=>!(!e.business||e.business.placeId!==n.placeId&&e.business._id!=="google_"+n.placeId||(console.log("Found exact place ID match - preventing POI click"),0))));if(o)return console.log("Exact match found - using our enhanced marker"),n.stop(),void setTimeout((()=>{showEnhancedInfoWindowWithCombinedIncentives(o)}),50);if(n.latLng){const o=markers.find((e=>{if(!e.business||!e.business.lat||!e.business.lng)return!1;const o=new google.maps.LatLng(parseFloat(e.business.lat),parseFloat(e.business.lng)),a=google.maps.geometry.spherical.computeDistanceBetween(n.latLng,o);return a<=25&&(console.log(`Very close marker found at ${a.toFixed(1)}m - potential conflict`),!0)}));if(o)try{const a=new e({id:n.placeId});await a.fetchFields({fields:["displayName"]});const t=a.displayName.toLowerCase().trim(),i=o.business.bname.toLowerCase().trim();if(t.includes(i)||i.includes(t)||calculateSimilarity(t,i)>.8)return console.log("Very close marker with similar name - preventing POI click"),n.stop(),void setTimeout((()=>{showEnhancedInfoWindowWithCombinedIncentives(o)}),50)}catch(e){console.warn("Error comparing POI name:",e)}}console.log("No exact match found - processing POI normally");try{const o=new e({id:n.placeId});await o.fetchFields({fields:["displayName","formattedAddress","addressComponents","location","types","businessStatus","nationalPhoneNumber","internationalPhoneNumber"]}),console.log("POI place details:",o);const a=o.displayName||"Unknown Business";let t="",i="",s="",r="",c="";if(c=o.nationalPhoneNumber||o.internationalPhoneNumber||"",o.addressComponents&&o.addressComponents.length>0){const e=getAddressComponent(o.addressComponents,"street_number"),n=getAddressComponent(o.addressComponents,"route");i=getAddressComponent(o.addressComponents,"locality"),s=getAddressComponent(o.addressComponents,"administrative_area_level_1"),r=getAddressComponent(o.addressComponents,"postal_code"),e&&n?t=`${e} ${n}`:n?t=n:e&&(t=e)}if(!t&&o.formattedAddress){const e=o.formattedAddress.split(",").map((e=>e.trim()));if(e.length>=1&&(t=e[0]),e.length>=2&&(i=e[1]),e.length>=3){const n=e[2].match(/^([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/);if(n)s=n[1],r=n[2];else{const n=e[2].split(" ");n.length>=2&&(s=n[0],r=n[1])}}}let l=0,d=0;if(o.location)try{l="function"==typeof o.location.lat?o.location.lat():o.location.lat||0,d="function"==typeof o.location.lng?o.location.lng():o.location.lng||0}catch(e){console.warn("Error extracting coordinates:",e),n.latLng&&(l=n.latLng.lat(),d=n.latLng.lng())}else n.latLng&&(l=n.latLng.lat(),d=n.latLng.lng());const g=mapGooglePlaceTypeToBusinessType(o.types||[]);let u=null;try{u=await findMatchingChainForPlaceResult(a)}catch(e){console.warn("Error checking for chain match:",e)}const h={_id:"google_"+o.id,bname:a,address1:t,city:i,state:s,zip:r,phone:c,type:g,formattedAddress:o.formattedAddress,isGooglePlace:!0,placeId:o.id,lat:l,lng:d,types:o.types||[]};if(u&&(console.log(`POI "${a}" matches chain: ${u.bname}`),h.chain_id=u._id,h.chain_name=u.bname,h.isChainLocation=!0),l&&d&&window.currentSearchLocation)try{h.distance=google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(l,d),new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng))}catch(e){console.warn("Error calculating distance:",e)}console.log("Created POI business object:",h);const p={business:h,position:new google.maps.LatLng(l,d),getPosition:function(){return this.position}};setTimeout((()=>{showEnhancedInfoWindowWithCombinedIncentives(p)}),100)}catch(e){console.error("Error processing POI click:",e),alert("Unable to load details for this location. Please try again.")}}})),console.log("Map click handler set up successfully with precise conflict detection")}catch(e){console.error("Error setting up map click handler:",e)}}else console.error("Map not initialized in setupMapClickHandler")}function mapGooglePlaceTypeToBusinessType(e){if(!e||!Array.isArray(e))return"OTHER";const n={restaurant:"REST",meal_takeaway:"REST",meal_delivery:"REST",cafe:"REST",bakery:"REST",bar:"REST",night_club:"REST",food:"REST",mexican_restaurant:"REST",chinese_restaurant:"REST",italian_restaurant:"REST",japanese_restaurant:"REST",indian_restaurant:"REST",thai_restaurant:"REST",american_restaurant:"REST",pizza_restaurant:"REST",seafood_restaurant:"REST",steak_house:"REST",sushi_restaurant:"REST",vegetarian_restaurant:"REST",fast_food_restaurant:"REST",grocery_or_supermarket:"GROC",supermarket:"GROC",convenience_store:"CONV",gas_station:"FUEL",hardware_store:"HARDW",department_store:"DEPT",clothing_store:"CLTH",shoe_store:"CLTH",electronics_store:"ELEC",furniture_store:"FURN",home_goods_store:"FURN",jewelry_store:"JEWL",book_store:"BOOK",bicycle_store:"SPRT",sporting_goods_store:"SPRT",toy_store:"TOYS",pet_store:"OTHER",florist:"GIFT",gift_shop:"GIFT",car_dealer:"AUTO",car_rental:"AUTO",car_repair:"AUTO",car_wash:"AUTO",auto_parts_store:"AUTO",pharmacy:"RX",drugstore:"RX",hospital:"HEAL",doctor:"HEAL",dentist:"HEAL",veterinary_care:"HEAL",beauty_salon:"BEAU",hair_care:"BEAU",spa:"BEAU",movie_theater:"ENTR",amusement_park:"ENTR",zoo:"ENTR",aquarium:"ENTR",museum:"ENTR",art_gallery:"ENTR",bowling_alley:"ENTR",casino:"ENTR",bank:"SERV",atm:"SERV",post_office:"SERV",laundry:"SERV",gym:"SPRT",library:"BOOK",lodging:"OTHER",hotel:"OTHER",motel:"OTHER",store:"RETAIL",shopping_mall:"RETAIL",establishment:"OTHER",point_of_interest:"OTHER"};for(const o of e)if(n[o])return n[o];return"OTHER"}function buildInfoWindowContent(e){const n=!0===e.isGooglePlace,o=!!e.chain_id;let a="";e.address1?(a=`<p><strong>Address:</strong><br>${e.address1}`,e.city&&(a+=`, ${e.city}`),e.state&&(a+=`, ${e.state}`),e.zip&&(a+=` ${e.zip}`),a+="</p>"):e.formattedAddress&&(a=`<p><strong>Address:</strong><br>${e.formattedAddress}</p>`);const t=o?`<span style="display:inline-block; background-color:#4285F4; color:white; padding:2px 6px; border-radius:4px; font-size:0.8em; margin-left:5px;">${e.chain_name||"Chain Location"}</span>`:"";let i="";e.type?i=`<p><strong>Type:</strong> ${getBusinessTypeLabel(e.type)}</p>`:n&&e.types&&e.types.length>0&&(i=`<p><strong>Type:</strong> ${getPlaceTypeLabel(e.types)}</p>`);const s=e.distance?`<p><strong>Distance:</strong> ${(e.distance/1609).toFixed(1)} miles</p>`:"",r=n?'<p style="color:#666; font-style:italic;">This business is not yet in the Patriot Thanks database.</p>':"",c=o?`<p style="color:#4285F4; font-size:12px; margin-top:8px;">This location appears to match ${e.chain_name} in our database. Chain-wide incentives may apply.</p>`:"";let l;return l=n?o?`\n                <button style="background-color:#EA4335; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; width:100%;" \n                        onclick="window.addBusinessToDatabase('${e.placeId}', '${e.chain_id}')">\n                    Add ${e.chain_name} Location\n                </button>\n            `:`\n                <button style="background-color:#EA4335; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; width:100%;" \n                        onclick="window.addBusinessToDatabase('${e.placeId}')">\n                    Add to Patriot Thanks\n                </button>\n            `:`\n            <button style="background-color:#4285F4; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; width:100%;" \n                    onclick="window.viewBusinessDetails('${e._id}')">\n                View Details\n            </button>\n        `,`\n        <div style="max-width:280px; font-family:Arial,sans-serif; padding:8px;">\n            <h3 style="margin:0 0 8px 0; font-size:16px; line-height:1.2;">${e.bname} ${t}</h3>\n            ${a}\n            ${i}\n            ${s}\n            ${r}\n            ${c}\n            <div id="incentives-container-${e._id||e.placeId}" style="margin:8px 0;">\n                ${n&&!o?'<p style="margin:4px 0; font-style:italic; color:#666;">Add this business to see available incentives.</p>':'<p style="margin:4px 0;"><em>Loading incentives...</em></p>'}\n            </div>\n            <div style="margin-top:12px; text-align:center;">\n                ${l}\n            </div>\n        </div>\n    `}function getPlaceTypeLabel(e){if(!e||!e.length)return"Business";const n={restaurant:"Restaurant",food:"Food & Dining",store:"Store",establishment:"Business",point_of_interest:"Point of Interest",gas_station:"Gas Station",lodging:"Lodging",cafe:"Cafe",bar:"Bar",hardware_store:"Hardware Store",home_goods_store:"Home Goods",department_store:"Department Store",grocery_or_supermarket:"Grocery Store",furniture_store:"Furniture Store",electronics_store:"Electronics Store",clothing_store:"Clothing Store",shoe_store:"Shoe Store",beauty_salon:"Beauty Salon",hair_care:"Hair Salon",spa:"Spa",pharmacy:"Pharmacy",drugstore:"Pharmacy",bank:"Bank",atm:"ATM",shopping_mall:"Shopping Mall",supermarket:"Supermarket",convenience_store:"Convenience Store",car_dealer:"Car Dealer",car_repair:"Auto Repair",car_wash:"Car Wash",gym:"Gym",hospital:"Hospital",doctor:"Medical",dentist:"Dental",veterinary_care:"Veterinary",movie_theater:"Movie Theater",amusement_park:"Amusement Park",zoo:"Zoo",aquarium:"Aquarium",museum:"Museum",library:"Library",book_store:"Bookstore",jewelry_store:"Jewelry Store",florist:"Florist",pet_store:"Pet Store",bicycle_store:"Bike Shop",sporting_goods_store:"Sporting Goods"};for(const o of e)if(n[o])return n[o];return e[0].replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase()))}function addInitialMapMessage(e){const n=document.createElement("div");n.id="initial-map-message",n.innerHTML="Search for businesses to see them on the map",n.style.position="absolute",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.background="white",n.style.padding="10px",n.style.borderRadius="5px",n.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)",n.style.zIndex="1",e.appendChild(n)}function setupResetMapButton(){const e=document.getElementById("reset-map");e&&e.addEventListener("click",(function(){resetMapView()}))}function resetMapView(){if(mapInitialized&&map)try{safelySetCenter(map,CONFIG.defaultCenter,CONFIG.defaultZoom),infoWindow&&infoWindow.close()}catch(e){console.error("Error resetting map view:",e)}else console.error("Cannot reset map view - map not initialized")}function setupMarkerClickPriority(){map?(console.log("Setting up precise marker click priority"),isSafariOrIOS&&(console.log("Safari: Adding minimal POI filtering"),map.setOptions({styles:[{featureType:"poi.park",stylers:[{visibility:"off"}]},{featureType:"poi.government",stylers:[{visibility:"off"}]}]})),google.maps.event.addListener(map,"click",(function(e){if(e.placeId){console.log("Priority check for POI:",e.placeId);const n=markers.find((n=>!!n.business&&(n.business.placeId===e.placeId||n.business._id==="google_"+e.placeId)));if(n)return console.log("Exact marker match found - preventing POI click"),e.stop(),void setTimeout((()=>{showEnhancedInfoWindowWithCombinedIncentives(n)}),50);console.log("No exact marker match - allowing POI click to proceed")}}))):console.error("Map not initialized, cannot set up click priority")}function initAdditionalMapFeatures(){console.log("Initializing additional map features"),addCustomMarkerStyleFixes(),setupMarkerClickPriority(),customizeInfoWindows()}function addCustomMarkerStyleFixes(){if(!document.getElementById("marker-style-fixes")){const e=document.createElement("style");e.id="marker-style-fixes",e.textContent="\n            /* Ensure proper marker display */\n            .marker-icon {\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                width: 20px;\n                height: 20px;\n                color: #333;\n            }\n            \n            /* Fix for Font Awesome icons */\n            .marker-icon i {\n                font-size: 12px !important;\n                color: #333 !important;\n            }\n            \n            /* Info window styling */\n            .info-window-actions .view-details-btn {\n                margin-top: 8px;\n            }\n        ",document.head.appendChild(e)}}function customizeInfoWindows(){applyInfoWindowScrollableStyles();const e=document.createElement("style");e.textContent="\n        .gm-ui-hover-effect {\n            opacity: 0.8 !important;\n            width: 24px !important;\n            height: 24px !important;\n            right: 2px !important;\n            top: 2px !important;\n        }\n        \n        .gm-ui-hover-effect span {\n            width: 16px !important;\n            height: 16px !important;\n        }\n        \n        .gm-ui-hover-effect:hover {\n            opacity: 1 !important;\n        }\n    ",document.head.appendChild(e)}function applyInfoWindowScrollableStyles(){if(!document.getElementById("info-window-scrollable-styles")){const e=document.createElement("style");e.id="info-window-scrollable-styles",e.textContent="\n            /* Info window structure */\n            .gm-style .gm-style-iw-c {\n                padding: 0 !important;\n                border-radius: 8px !important;\n                box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n                max-width: 330px !important;\n                max-height: 400px !important;\n                overflow: hidden !important;\n            }\n            \n            .gm-style .gm-style-iw-d {\n                overflow: auto !important;\n                max-height: 350px !important;\n                padding-right: 8px !important; /* Allow space for scrollbar */\n            }\n            \n            /* Custom info window styles */\n            .info-window {\n                padding: 12px;\n                max-width: 300px;\n            }\n            \n            .info-window h3 {\n                margin-top: 0;\n                margin-bottom: 10px;\n                color: #212121;\n                font-size: 16px;\n                line-height: 1.3;\n            }\n            \n            .info-window p {\n                margin: 6px 0;\n                font-size: 14px;\n                line-height: 1.4;\n            }\n            \n            .info-window-actions {\n                margin-top: 12px;\n                padding-top: 8px;\n                border-top: 1px solid #eee;\n                text-align: right;\n            }\n            \n            .add-business-btn {\n                background-color: #EA4335;\n                color: white;\n                border: none;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                margin-top: 5px;\n                font-size: 13px;\n                font-weight: 500;\n            }\n            \n            .add-business-btn:hover {\n                background-color: #D32F2F;\n            }\n            \n            .view-details-btn {\n                background-color: #4285F4;\n                color: white;\n                border: none;\n                padding: 8px 12px;\n                border-radius: 4px;\n                cursor: pointer;\n                margin-top: 5px;\n                font-size: 13px;\n                font-weight: 500;\n            }\n            \n            .view-details-btn:hover {\n                background-color: #2A75F3;\n            }\n            \n            /* Incentives list */\n            .incentives-list {\n                margin: 8px 0;\n                padding-left: 20px;\n            }\n            \n            .incentives-list li {\n                margin-bottom: 6px;\n            }\n            \n            /* Custom scrollbar styles */\n            .gm-style .gm-style-iw-d::-webkit-scrollbar {\n                width: 6px;\n                height: 6px;\n            }\n            \n            .gm-style .gm-style-iw-d::-webkit-scrollbar-track {\n                background: #f1f1f1;\n                border-radius: 3px;\n            }\n            \n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb {\n                background: #c1c1c1;\n                border-radius: 3px;\n            }\n            \n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb:hover {\n                background: #a8a8a8;\n            }\n            \n            /* Close button adjustment */\n            .gm-ui-hover-effect {\n                top: 2px !important;\n                right: 2px !important;\n            }\n        ",document.head.appendChild(e)}}function fetchBusinessAndCreateMarker(e){console.log("Fetching business data for marker creation:",e);const n=getBaseURL();fetch(`${n}/api/business.js?operation=get&id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to fetch business: ${e.status}`);return e.json()})).then((n=>{if(n.result){console.log("Found business data:",n.result);const o=createBusinessMarker(n.result);o&&(map.setCenter(o.position),map.setZoom(15),showEnhancedInfoWindow(o),console.log("Created and focused on new enhanced marker for business:",e))}else console.error("Business data not found"),alert("Business information could not be found.");document.getElementById("map").scrollIntoView({behavior:"smooth"})})).catch((e=>{console.error("Error fetching business data:",e),alert("There was an error getting information for this business."),document.getElementById("map").scrollIntoView({behavior:"smooth"})}))}function isNotEmpty(e){return e&&""!==e.trim()}function validateField(e,n){console.log(`Validating ${e.id} with value: ${e.value}`),n(e.value)?(e.classList.remove("invalid-field"),e.classList.add("valid-field"),e.setAttribute("data-valid","true"),console.log(`${e.id} is VALID`)):(e.classList.remove("valid-field"),e.classList.add("invalid-field"),e.setAttribute("data-valid","false"),console.log(`${e.id} is INVALID`))}function displaySearchResults(e){try{hideLoadingIndicator();const n=document.getElementById("business_search"),o=document.getElementById("search_table");if(!n||!o)return console.error("Required elements not found in the DOM"),void showErrorMessage("There was an error displaying search results. Please try again later.");let a=n.querySelector("tbody");if(!a)return console.error("Table body not found within business_search table"),void showErrorMessage("There was an error displaying search results. Please try again later.");a.innerHTML="",Array.isArray(e)||(console.error("businesses is not an array:",e),e=[]),o.style.display="block";const t=o.querySelector("h5");if(t&&(t.style.display="none"),0===e.length)return a.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria.</td></tr>',void o.scrollIntoView({behavior:"smooth"});const i=e.filter((e=>!e.isGooglePlace)),s=e.filter((e=>e.isGooglePlace&&e.chain_id)),r=e.filter((e=>e.isGooglePlace&&!e.chain_id));console.log(`Businesses to display: ${i.length} from database, ${s.length} chain-matched Places, ${r.length} regular Places`),i.forEach((e=>{addBusinessRow(e,a,!1)})),s.forEach((e=>{addBusinessRow(e,a,!0)})),r.forEach((e=>{addBusinessRow(e,a,!0)})),o.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error displaying search results: ",e),hideLoadingIndicator(),showErrorMessage("There was an error displaying the search results: "+e.message)}}function addEnhancedLoadingCSS(){if(!document.getElementById("enhanced-loading-css")){const e=document.createElement("style");e.id="enhanced-loading-css",e.textContent="\n            .loading-indicator {\n                display: flex;\n                flex-direction: column;\n                justify-content: center;\n                align-items: center;\n                padding: 30px 20px;\n                text-align: center;\n                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);\n                border-radius: 8px;\n                margin: 20px 0;\n                box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            }\n\n            .loading-text {\n                font-size: 16px;\n                color: #333;\n                margin-bottom: 15px;\n                font-weight: 500;\n            }\n\n            .loading-spinner {\n                width: 40px;\n                height: 40px;\n                border: 4px solid #f3f3f3;\n                border-top: 4px solid #4285F4;\n                border-radius: 50%;\n                animation: spin 1s linear infinite;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n            }\n\n            @keyframes spin {\n                0% { transform: rotate(0deg); }\n                100% { transform: rotate(360deg); }\n            }\n\n            /* Enhanced error messages */\n            .error-message {\n                color: #721c24;\n                padding: 20px;\n                background: linear-gradient(135deg, #f8d7da 0%, #f1b0b7 100%);\n                border: 1px solid #f5c6cb;\n                border-radius: 8px;\n                margin: 20px 0;\n                text-align: center;\n                font-weight: 500;\n                box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n            }\n\n            /* Fade in animation for results */\n            .search-results-container {\n                animation: fadeIn 0.5s ease-in;\n            }\n\n            @keyframes fadeIn {\n                from { \n                    opacity: 0; \n                    transform: translateY(20px); \n                }\n                to { \n                    opacity: 1; \n                    transform: translateY(0); \n                }\n            }\n        ",document.head.appendChild(e)}}function fetchChainIncentivesForPlacesResult(e,n){if(!e||!n)return void console.error("Missing place ID or chain ID for fetching chain incentives");const o=`${getBaseURL()}/api/chains.js?operation=get_incentives&chain_id=${n}`;console.log("Fetching chain incentives from NEW API: ",o),fetch(o).then((e=>{if(!e.ok)throw new Error(`Failed to fetch chain incentives: ${e.status}`);return e.json()})).then((n=>{console.log(`Chain incentives data from NEW API for place ${e}:`,n);const o=document.getElementById(`incentives-for-${e}`);if(!o)return void console.error(`Could not find cell for incentives-for-${e}`);if(!n.incentives||0===n.incentives.length)return void(o.innerHTML="No chain incentives available");let a="";n.incentives.forEach((e=>{if(e.is_active){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"";a+=`\n                        <div class="incentive-item">\n                            <strong>${n}${o}:</strong> ${e.amount}% \n                            <span class="chain-badge small">Chain-wide</span>\n                            <div class="incentive-info">${e.information||""}</div>\n                        </div>\n                    `}})),o.innerHTML=""===a?"No active chain incentives":a})).catch((n=>{console.error(`Error fetching chain incentives from NEW API for place ${e}:`,n);const o=document.getElementById(`incentives-for-${e}`);o&&(o.innerHTML="Error loading chain incentives")}))}function getBusinessTypeTextIcon(e){return`<span style="font-size: 16px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${{AUTO:"ðŸš—",BEAU:"ðŸ’‡",BOOK:"ðŸ“š",CLTH:"ðŸ‘•",CONV:"ðŸª",DEPT:"ðŸ›ï¸",ELEC:"âš¡",ENTR:"ðŸŽ¬",FURN:"ðŸª‘",FUEL:"â›½",GIFT:"ðŸŽ",GROC:"ðŸ›’",HARDW:"ðŸ”¨",HEAL:"â¤ï¸",HOTEL:"ðŸ¨",JEWL:"ðŸ’Ž",OTHER:"ðŸ¬",RX:"ðŸ’Š",REST:"ðŸ½ï¸",RETAIL:"ðŸ›ï¸",SERV:"ðŸ”§",SPEC:"â­",SPRT:"ðŸˆ",TECH:"ðŸ’»",TOYS:"ðŸŽ®"}[e]||"ðŸ¬"}</span>`}function createEnhancedFallbackMarker(e,n){try{console.log("Creating enhanced fallback marker for:",e.bname);let o=createSafeLatLng(n);if(!o&&e.lat&&e.lng&&(o=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng))),!o)return console.error("Invalid location for enhanced fallback marker:",n),null;const a=!e.isGooglePlace,t=(e.chain_id,a?CONFIG.markerColors.primary:CONFIG.markerColors.nearby),i=new google.maps.Marker({position:o,map,title:e.bname,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:t,fillOpacity:.9,strokeWeight:2,strokeColor:"#FFFFFF",scale:a?14:12},animation:google.maps.Animation.DROP,zIndex:a?1e3:100});return i.business=e,i.position=o,i.isFromDatabase=a,i.addListener("click",(function(){console.log("Enhanced fallback marker clicked:",e.bname),showEnhancedInfoWindow(i)})),markers.push(i),console.log(`Added enhanced fallback marker for ${e.bname}`),i}catch(e){return console.error("Error creating enhanced fallback marker:",e),null}}function showEnhancedInfoWindow(e){if(console.log("showEnhancedInfoWindow called with marker:",e),!e||!e.business)return void console.error("Invalid marker for enhanced info window",e);const n=e.business,o=!0===n.isGooglePlace,a=!!n.chain_id;infoWindow&&infoWindow.close(),infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1});const t=buildEnhancedInfoWindowContent(n);infoWindow.setContent(t);let i=e.position;if(!i&&e.getPosition&&(i=e.getPosition()),i||(i=createSafeLatLng(n)),i){try{map.panTo(i)}catch(e){console.warn("Error panning to position:",e)}setTimeout((()=>{try{if(e instanceof google.maps.marker.AdvancedMarkerElement||e instanceof google.maps.Marker)infoWindow.open(map,e),console.log("Info window opened with Google Maps marker - will move with map");else{console.log("Info window opened at position - adding comprehensive map tracking"),infoWindow.setPosition(i),infoWindow.open(map);const e=[],n=i,o=()=>{infoWindow.getMap()&&infoWindow.setPosition(n)};e.push(google.maps.event.addListener(map,"center_changed",o)),e.push(google.maps.event.addListener(map,"zoom_changed",o)),e.push(google.maps.event.addListener(map,"drag",o)),e.push(google.maps.event.addListener(map,"dragstart",o)),e.push(google.maps.event.addListener(map,"dragend",o)),e.push(google.maps.event.addListener(map,"bounds_changed",o));const a=()=>{e.forEach((e=>google.maps.event.removeListener(e))),console.log("Cleaned up info window movement listeners")};google.maps.event.addListenerOnce(infoWindow,"closeclick",a),google.maps.event.addListenerOnce(infoWindow,"position_changed",a)}console.log("Enhanced info window opened successfully"),google.maps.event.addListenerOnce(infoWindow,"domready",(function(){setTimeout((()=>{applyEnhancedInfoWindowFixes();const e=o?`google_${n.placeId}`:n._id;console.log(`ðŸŽ INCENTIVES: Loading for container ID: ${e}`),isFromDatabase&&a?loadChainIncentivesForDatabaseBusinessFixed(e,n.chain_id):isFromDatabase?loadIncentivesForEnhancedWindowFixed(e):o&&a&&loadChainIncentivesForEnhancedWindowFixed(e,n.chain_id)}),300)}))}catch(e){console.error("Error opening enhanced info window:",e)}}),200)}else console.error("Could not determine position for enhanced info window")}function buildEnhancedInfoWindowContent(e){const n=!0===e.isGooglePlace,o=!!e.chain_id;let a="";if(e.address1){a=`<div class="info-address">\n            <strong>ðŸ“ Address:</strong><br>\n            ${e.address1}`,e.address2&&(a+=`<br>${e.address2}`);const n=[];e.city&&n.push(e.city),e.state&&n.push(e.state),e.zip&&n.push(e.zip),n.length>0&&(a+=`<br>${n.join(", ")}`),a+="</div>"}else if(e.formattedAddress){const n=e.formattedAddress.split(",").map((e=>e.trim()));a='<div class="info-address">\n            <strong>ðŸ“ Address:</strong><br>',n.length>=1&&(a+=n[0]),n.length>=2&&(a+=`<br>${n.slice(1).join(", ")}`),a+="</div>"}const t=e.phone?`<div class="info-phone"><strong>ðŸ“ž Phone:</strong> <a href="tel:${e.phone.replace(/\D/g,"")}" style="color: #4285F4; text-decoration: none;">${e.phone}</a></div>`:"";let i="";e.type&&"OTHER"!==e.type&&(i=`<div class="info-type"><strong>ðŸ¢ Type:</strong> ${getBusinessTypeLabel(e.type)}</div>`);const s=e.distance?`<div class="info-distance"><strong>ðŸ“ Distance:</strong> ${(e.distance/1609).toFixed(1)} miles</div>`:"",r=o?`<span class="enhanced-chain-badge">ðŸ”— ${e.chain_name||"Chain Location"}</span>`:"";let c,l,d="";n?o?(c='<div class="info-status chain-match">ðŸ”— This location appears to match a chain in our database!</div>',d=`<div class="chain-explanation">\n                âœ¨ Great news! This location matches <strong>${e.chain_name}</strong> in our database. \n                Chain-wide incentives should apply to this location once added.\n            </div>`):c='<div class="info-status google-place">â„¹ï¸ This business is not yet in the Patriot Thanks database.</div>':c='<div class="info-status database-business">âœ… This business is in the Patriot Thanks database.</div>',l=n?o?`\n                <button class="enhanced-add-btn chain-add" onclick="window.addBusinessToDatabase('${e.placeId}', '${e.chain_id}')">\n                    ðŸ”— Add ${e.chain_name} Location\n                </button>\n            `:`\n                <button class="enhanced-add-btn" onclick="window.addBusinessToDatabase('${e.placeId}')">\n                    âž• Add to Patriot Thanks\n                </button>\n            `:`\n            <button class="enhanced-view-btn" onclick="window.viewBusinessDetails('${e._id}')">\n                ðŸ‘ï¸ View Details\n            </button>\n        `;const g=e._id||e.placeId;let u;return u=n&&o?"<em>â³ Loading chain incentives...</em>":n&&!o?"<em>ðŸ’¡ Add this business to see available incentives.</em>":"<em>â³ Loading incentives...</em>",`\n        <div class="enhanced-info-window">\n            <div class="info-header">\n                <h3>${e.bname} ${r}</h3>\n            </div>\n            \n            <div class="info-body">\n                ${a}\n                ${t}\n                ${i}\n                ${s}\n                ${c}\n                ${d}\n                \n                <div class="info-incentives">\n                    <div id="incentives-container-${g}">\n                        ${u}\n                    </div>\n                </div>\n            </div>\n            \n            <div class="info-actions">\n                ${l}\n            </div>\n        </div>\n    `}function loadIncentivesForEnhancedWindow(e){const n=document.getElementById(`incentives-container-${e}`);if(!n)return void console.error("Enhanced incentives container not found for business:",e);const o=getBaseURL();fetch(`${o}/api/combined-api.js?operation=incentives&business_id=${e}`).then((e=>e.json())).then((e=>{if(!e.results||0===e.results.length)return void(n.innerHTML="<em>ðŸ’­ No incentives available</em>");let o='<div class="incentives-header"><strong>ðŸŽ Available Incentives:</strong></div>';o+='<div class="incentives-list">',e.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),a=e.other_description?` (${e.other_description})`:"",t=e.is_chain_wide?'<span class="mini-chain-badge">ðŸ”— Chain-wide</span>':"";o+=`\n                        <div class="incentive-item">\n                            <div class="incentive-type">${n}${a}:</div>\n                            <div class="incentive-amount">${e.amount}% ${t}</div>\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),o+="</div>",n.innerHTML=o})).catch((e=>{console.error("Error loading incentives:",e),n.innerHTML="<em>âŒ Error loading incentives</em>"}))}function loadChainIncentivesForEnhancedWindow(e,n){const o=document.getElementById(`incentives-container-${e}`);if(o)loadChainIncentivesInContainer(o,n);else{console.error("Enhanced chain incentives container not found for place:",e);const o=document.getElementById(`incentives-container-google_${e}`);if(o)return console.log("Found alternative container ID format"),void loadChainIncentivesInContainer(o,n);const a=document.querySelectorAll('[id*="incentives-container"]');console.log("Available incentives containers:",Array.from(a).map((e=>e.id)))}}function loadChainIncentivesInContainer(e,n){const o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${n}`;console.log("Loading chain incentives from:",o),fetch(o).then((e=>e.json())).then((n=>{if(!n.results||0===n.results.length)return void(e.innerHTML="<em>ðŸ’­ No chain incentives available</em>");let o='<div class="incentives-header"><strong>ðŸŽ Chain-wide Incentives:</strong></div>';o+='<div class="incentives-list">',n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),a=e.other_description?` (${e.other_description})`:"";o+=`\n                        <div class="incentive-item chain-incentive">\n                            <div class="incentive-type">${n}${a}:</div>\n                            <div class="incentive-amount">${e.amount}% <span class="mini-chain-badge">ðŸ”— Chain-wide</span></div>\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),o+="</div>",o+='<div class="chain-note">âœ¨ Great! These incentives apply to all locations of this chain.</div>',e.innerHTML=o,console.log("Successfully loaded chain incentives")})).catch((n=>{console.error("Error loading chain incentives:",n),e.innerHTML="<em>âŒ Error loading chain incentives</em>"}))}function applyEnhancedInfoWindowFixes(){const e=document.querySelector(".gm-style-iw-c"),n=document.querySelector(".gm-style-iw-d"),o=document.querySelector(".gm-style-iw-t");if(e){const n=e.getBoundingClientRect();n.width<50&&(e.style.width="auto",e.style.minWidth="300px",e.style.maxWidth="350px"),e.style.padding="0",e.style.margin="0",(n.top<0||n.top>window.innerHeight||n.left<0||n.left>window.innerWidth)&&(e.style.position="relative",e.style.transform="none")}n&&(n.style.padding="0",n.style.margin="0",n.style.overflow="auto",n.style.maxHeight="350px"),o&&(o.style.bottom="0px",o.style.left="50%",o.style.right="auto",o.style.transform="translateX(-50%)"),console.log("Applied enhanced info window fixes with proper padding")}function addEnhancedMarkerStyles(){if(!document.getElementById("enhanced-marker-styles")){const e=document.createElement("style");e.id="enhanced-marker-styles",e.textContent="\n            /* Enhanced marker container */\n            .enhanced-custom-marker {\n                cursor: pointer;\n                transition: transform 0.2s ease;\n                z-index: 100;\n            }\n\n            .enhanced-marker-container {\n                position: relative;\n                width: 36px;\n                height: 46px;\n            }\n\n            /* Enhanced pin styling */\n            .enhanced-marker-pin {\n                width: 32px;\n                height: 40px;\n                border-radius: 50% 50% 50% 0;\n                transform: rotate(-45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                box-shadow: 0 3px 6px rgba(0,0,0,0.3);\n                position: absolute;\n                top: 0;\n                left: 2px;\n                border: 2px solid white;\n            }\n\n            .enhanced-marker-pin.primary {\n                background: linear-gradient(45deg, #EA4335, #FF6B6B);\n            }\n\n            .enhanced-marker-pin.nearby {\n                background: linear-gradient(45deg, #4285F4, #64B5F6);\n            }\n\n            /* Enhanced icon styling */\n            .enhanced-marker-icon {\n                transform: rotate(45deg);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                width: 20px;\n                height: 20px;\n                font-size: 16px;\n                filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5));\n            }\n\n            /* Enhanced shadow */\n            .enhanced-marker-shadow {\n                position: absolute;\n                bottom: -2px;\n                left: 8px;\n                width: 20px;\n                height: 8px;\n                background: radial-gradient(ellipse, rgba(0,0,0,0.3) 0%, transparent 70%);\n                border-radius: 50%;\n                filter: blur(1px);\n            }\n\n            /* Chain indicator */\n            .chain-indicator {\n                position: absolute;\n                top: -5px;\n                right: -5px;\n                background: #FFD700;\n                border-radius: 50%;\n                width: 18px;\n                height: 18px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 10px;\n                border: 2px solid white;\n                box-shadow: 0 1px 3px rgba(0,0,0,0.3);\n                z-index: 1001;\n            }\n\n            /* CRITICAL: Google Maps info window container fixes */\n            .gm-style .gm-style-iw-c {\n                padding: 0 !important;\n                border-radius: 8px !important;\n                box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n                max-width: 350px !important;\n                max-height: 400px !important;\n                overflow: hidden !important;\n            }\n\n            .gm-style .gm-style-iw-d {\n                overflow: auto !important;\n                max-height: 350px !important;\n                padding: 0 !important;\n                /* Add proper padding that Google Maps won't strip */\n                margin: 0 !important;\n            }\n\n            /* Enhanced info window styles with proper padding */\n            .enhanced-info-window {\n                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n                max-width: 320px;\n                line-height: 1.4;\n                /* CRITICAL: Add padding to the content container instead of relying on Google's padding */\n                padding: 12px 12px 12px 12px !important;\n                margin: 0;\n                box-sizing: border-box;\n            }\n\n            .info-header {\n                border-bottom: 2px solid #f0f0f0;\n                padding-bottom: 8px;\n                margin-bottom: 12px;\n            }\n\n            .info-header h3 {\n                margin: 0;\n                font-size: 16px;\n                color: #333;\n                font-weight: 600;\n            }\n\n            .enhanced-chain-badge {\n                display: inline-block;\n                background: linear-gradient(45deg, rgb(66, 133, 244, 0.3), rgb(100, 181, 246, 0.3));\n                color: #000000;\n                padding: 2px 8px;\n                border-radius: 12px;\n                font-size: 11px;\n                margin-left: 8px;\n                font-weight: 500;\n            }\n\n            .info-body > div {\n                margin: 8px 0;\n                font-size: 14px;\n            }\n\n            .info-address, .info-phone, .info-type, .info-distance {\n                color: #555;\n            }\n\n            .info-status {\n                padding: 6px 10px;\n                border-radius: 6px;\n                font-size: 13px;\n                margin: 10px 0;\n            }\n\n            .info-status.database-business {\n                background-color: #e8f5e8;\n                color: #2e7d32;\n            }\n\n            .info-status.google-place {\n                background-color: #e3f2fd;\n                color: #1565c0;\n            }\n\n            .chain-explanation {\n                background-color: #fff3e0;\n                padding: 8px;\n                border-radius: 6px;\n                font-size: 13px;\n                color: #ef6c00;\n                border-left: 3px solid #ff9800;\n            }\n\n            .info-incentives {\n                margin: 12px 0;\n            }\n\n            .incentives-header {\n                font-weight: 600;\n                color: #333;\n                margin-bottom: 8px;\n            }\n\n            .incentive-item {\n                background-color: #f8f9fa;\n                padding: 8px;\n                border-radius: 6px;\n                margin: 6px 0;\n                border-left: 3px solid #4285F4;\n            }\n\n            .incentive-type {\n                font-weight: 500;\n                color: #333;\n            }\n\n            .incentive-amount {\n                font-size: 16px;\n                font-weight: 600;\n                color: #2e7d32;\n                margin: 2px 0;\n            }\n\n            .incentive-info {\n                font-size: 12px;\n                color: #666;\n                font-style: italic;\n                margin-top: 4px;\n            }\n\n            .mini-chain-badge {\n                background: #4285F4;\n                color: white;\n                padding: 1px 6px;\n                border-radius: 8px;\n                font-size: 10px;\n                margin-left: 4px;\n            }\n\n            .chain-note {\n                font-size: 12px;\n                color: #666;\n                font-style: italic;\n                margin-top: 8px;\n                padding: 4px 8px;\n                background-color: #f0f8ff;\n                border-radius: 4px;\n            }\n\n            .info-actions {\n                margin-top: 12px;\n                padding-top: 12px;\n                border-top: 1px solid #eee;\n                text-align: center;\n                /* Add bottom margin to ensure spacing at bottom */\n                margin-bottom: 4px;\n            }\n\n            .enhanced-add-btn, .enhanced-view-btn {\n                background: linear-gradient(45deg, #4285F4, #64B5F6);\n                color: white;\n                border: none;\n                padding: 10px 20px;\n                border-radius: 8px;\n                cursor: pointer;\n                font-weight: 500;\n                font-size: 14px;\n                transition: all 0.2s ease;\n                width: 100%;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n            }\n\n            .enhanced-add-btn {\n                background: linear-gradient(45deg, #EA4335, #FF6B6B);\n            }\n\n            .enhanced-add-btn:hover, .enhanced-view-btn:hover {\n                transform: translateY(-1px);\n                box-shadow: 0 4px 8px rgba(0,0,0,0.15);\n            }\n\n            /* ENHANCED SCROLLBAR - More visible and styled */\n            .gm-style .gm-style-iw-d::-webkit-scrollbar {\n                width: 8px;\n                height: 8px;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-track {\n                background: #f1f1f1;\n                border-radius: 4px;\n                border: 1px solid #e0e0e0;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb {\n                background: linear-gradient(180deg, #4285F4, #64B5F6);\n                border-radius: 4px;\n                border: 1px solid #3367D6;\n                box-shadow: inset 0 1px 2px rgba(255,255,255,0.3);\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb:hover {\n                background: linear-gradient(180deg, #3367D6, #4285F4);\n                cursor: pointer;\n            }\n\n            .gm-style .gm-style-iw-d::-webkit-scrollbar-thumb:active {\n                background: linear-gradient(180deg, #2A56C6, #3367D6);\n            }\n\n            /* Add padding indicator when content is scrollable */\n            .gm-style .gm-style-iw-d::before {\n                content: '';\n                display: block;\n                height: 1px;\n                width: 100%;\n                background: transparent;\n            }\n\n            .gm-style .gm-style-iw-d::after {\n                content: '';\n                display: block;\n                height: 1px;\n                width: 100%;\n                background: transparent;\n            }\n\n            /* Responsive adjustments */\n            @media (max-width: 400px) {\n                .enhanced-info-window {\n                    max-width: 280px;\n                    padding: 10px 10px 10px 10px !important;\n                }\n                \n                .enhanced-marker-container {\n                    width: 32px;\n                    height: 42px;\n                }\n                \n                .enhanced-marker-pin {\n                    width: 28px;\n                    height: 36px;\n                }\n\n                .gm-style .gm-style-iw-d::-webkit-scrollbar {\n                    width: 6px;\n                }\n            }\n\n            /* Fix for tail positioning */\n            .gm-style .gm-style-iw-t {\n                bottom: 0px !important;\n                left: 50% !important;\n                right: auto !important;\n                transform: translateX(-50%) !important;\n                width: 20px !important;\n                height: 15px !important;\n            }\n\n            /* Ensure close button is properly positioned */\n            .gm-ui-hover-effect {\n                opacity: 0.8 !important;\n                top: 8px !important;\n                right: 8px !important;\n                width: 24px !important;\n                height: 24px !important;\n                z-index: 1002 !important;\n            }\n\n            .gm-ui-hover-effect:hover {\n                opacity: 1 !important;\n            }\n        ",document.head.appendChild(e)}}function searchNearbyBusinesses(e,n){try{console.log("Searching for nearby similar businesses near",e.lat(),e.lng()),console.log("Primary business type:",n);const o=getSimilarBusinessTypes(n);if(console.log("Looking for similar business types:",o),0===o.length)return void console.log("No similar business types defined for:",n);const a=getBaseURL(),t=o.map((n=>{const o=`${a}/api/business.js?operation=search&type=${n}&lat=${e.lat()}&lng=${e.lng()}&radius=15`;return console.log("Searching for similar businesses:",o),fetch(o).then((e=>{if(!e.ok)throw new Error(`Failed to fetch businesses of type ${n}: ${e.status}`);return e.json()})).then((e=>({businessType:n,results:e.results||[]})))}));Promise.all(t).then((n=>{let o=[];if(n.forEach((e=>{e.results.length>0&&(console.log(`Found ${e.results.length} businesses of type ${e.businessType}`),o=o.concat(e.results))})),0===o.length)return void console.log("No similar businesses found in the area");console.log(`Found ${o.length} total potential similar businesses`);const a=markers.map((e=>e.business?._id)).filter((e=>e)),t=markers.map((e=>e.business?.bname.toLowerCase())).filter((e=>e)),i=o.filter((e=>{if(a.includes(e._id))return!1;const n=e.bname.toLowerCase();return!t.some((e=>n.includes(e)||e.includes(n)))}));console.log(`${i.length} new similar businesses to add to map`);let s=0;i.forEach((n=>{n.isNearby=!0,n.isSimilarBusiness=!0;const o=getBusinessLocation(n);if(o){const a=new google.maps.LatLng(o.lat,o.lng),t=google.maps.geometry.spherical.computeDistanceBetween(e,a);t<=24140?createSimilarBusinessMarker(n,a)&&(s++,console.log(`Added similar business: ${n.bname} (${(t/1609).toFixed(1)} miles) - ${getBusinessTypeLabel(n.type)}`)):console.log(`Skipping distant similar business: ${n.bname} (${(t/1609).toFixed(1)} miles)`)}else console.warn(`Similar business ${n.bname} missing coordinates`)})),console.log(`Added ${s} similar businesses with blue markers`)})).catch((e=>{console.error("Error searching for similar businesses:",e)}))}catch(e){console.error("Error in searchNearbyBusinesses:",e)}}function getSimilarBusinessTypes(e){return({HARDW:["HARDW","DEPT"],REST:["REST"],GROC:["GROC","CONV"],DEPT:["DEPT","RETAIL","HARDW"],CLTH:["CLTH","DEPT"],ELEC:["ELEC","DEPT","TECH"],FURN:["FURN","DEPT"],AUTO:["AUTO","FUEL"],BEAU:["BEAU","RX"],RX:["RX","BEAU","GROC"],ENTR:["ENTR"],SPRT:["SPRT","DEPT"],FUEL:["FUEL","CONV"],CONV:["CONV","FUEL","GROC"],SERV:["SERV"],OTHER:["OTHER","RETAIL"]}[e]||[e]).filter((n=>n!==e))}function getBusinessLocation(e){let n,o;if(e.location&&e.location.coordinates&&Array.isArray(e.location.coordinates)&&e.location.coordinates.length>=2)o=e.location.coordinates[0],n=e.location.coordinates[1];else{if(void 0===e.lat||void 0===e.lng)return null;n=parseFloat(e.lat),o=parseFloat(e.lng)}return isNaN(n)||isNaN(o)?null:{lat:n,lng:o}}function createSimilarBusinessMarker(e,n){try{return e.lat=n.lat(),e.lng=n.lng(),createEnhancedBusinessMarker(e,n,!0)}catch(o){return console.error("Error creating similar business marker:",o),createEnhancedFallbackMarker(e,n)}}async function createEnhancedBusinessMarker(e,n,o=!1){try{const{AdvancedMarkerElement:a}=await google.maps.importLibrary("marker");let t=createSafeLatLng(n);if(!t)return console.error("Invalid position for enhanced marker:",n),createEnhancedFallbackMarker(e,n);const i=!e.isGooglePlace;let s,r;o||!0===e.isNearby||!0===e.isSimilarBusiness||e.isSimilarBusiness?(s=CONFIG.markerColors.nearby,r="nearby"):i?(s=CONFIG.markerColors.primary,r="primary"):(s=CONFIG.markerColors.nearby,r="nearby");const c=getBusinessTypeTextIcon(e.type),l=document.createElement("div");l.className="enhanced-custom-marker",l.setAttribute("title",e.bname),l.style.cursor="pointer",l.innerHTML=`\n            <div class="enhanced-marker-container">\n                <div class="enhanced-marker-pin ${r}" style="background-color: ${s};">\n                    <div class="enhanced-marker-icon">\n                        ${c}\n                    </div>\n                </div>\n                <div class="enhanced-marker-shadow"></div>\n                ${e.chain_id?'<div class="chain-indicator">â­</div>':""}\n                ${e.isSimilarBusiness?'<div class="similar-indicator">â‰ˆ</div>':""}\n            </div>\n        `;const d=new a({position:t,map,title:e.bname,content:l,collisionBehavior:i?"REQUIRED_AND_HIDES_OPTIONAL":"OPTIONAL_AND_HIDES_LOWER_PRIORITY"});return d.business=e,d.position=t,d.isFromDatabase=i,d.isSimilarBusiness=e.isSimilarBusiness||o,l.addEventListener("click",(function(n){console.log("Enhanced similar business marker clicked:",e.bname),n.stopPropagation(),showEnhancedInfoWindow(d)})),l.addEventListener("mouseenter",(function(){l.style.transform="scale(1.1)",l.style.zIndex="1000"})),l.addEventListener("mouseleave",(function(){l.style.transform="scale(1)",l.style.zIndex="auto"})),markers.push(d),console.log(`Added enhanced ${e.isSimilarBusiness?"similar business":""} marker for ${e.bname}`),d}catch(o){return console.error("Error creating enhanced marker:",o),createEnhancedFallbackMarker(e,n)}}window.initGoogleMap=function(){console.log("Enhanced initGoogleMap function called");try{applyMapHeightFix();const e=document.getElementById("map");if(!e)return void console.error("Map container not found in the DOM");if(console.log("Map container dimensions:",e.offsetWidth,"x",e.offsetHeight),map)console.log("Map already exists, applying height fix and triggering resize"),applyMapHeightFix(),setTimeout((()=>{google.maps.event.trigger(map,"resize")}),100);else{const n={center:CONFIG.defaultCenter,zoom:CONFIG.defaultZoom,mapId:CONFIG.mapId||"ebe8ec43a7bc252d",clickableIcons:!0,gestureHandling:"greedy",zoomControl:!0,mapTypeControl:!1,scaleControl:!0,streetViewControl:!1,rotateControl:!1,fullscreenControl:!0};isSafariOrIOS&&(n.styles=[{featureType:"poi.park",stylers:[{visibility:"off"}]},{featureType:"poi.government",stylers:[{visibility:"off"}]},{featureType:"poi.school",stylers:[{visibility:"off"}]}]),map=new google.maps.Map(e,n),console.log("Map object created with precise POI handling:",!!map),infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1,pixelOffset:new google.maps.Size(0,-10)}),bounds=new google.maps.LatLngBounds,addInitialMapMessage(e),setupResetMapButton(),mapInitialized=!0,console.log("Google Map successfully initialized with precise POI conflict detection"),pendingBusinessesToDisplay.length>0&&(console.log("Processing pending businesses to display on map"),displayBusinessesOnMap(pendingBusinessesToDisplay),pendingBusinessesToDisplay=[]),setupMapClickHandler(),setupMarkerClickPriority(),initAdditionalMapFeatures(),setTimeout((()=>{google.maps.event.trigger(map,"resize")}),200)}}catch(e){console.error("Error initializing Google Map:",e),mapInitialized=!1;const n=document.getElementById("map");n&&(n.innerHTML=`\n                <div style="text-align: center; padding: 20px;">\n                    <p>Sorry, we couldn't load the map. Please try refreshing the page.</p>\n                    <p>Error: ${e.message}</p>\n                </div>\n            `)}},window.focusOnMapMarker=function(e){if(console.log("focusOnMapMarker called for business ID:",e),!mapInitialized||!map)return console.error("Map not initialized yet - cannot focus on marker"),void alert("Map is still loading. Please try again in a moment.");if(!markers||0===markers.length)return console.warn("No markers available yet."),void fetchBusinessAndCreateMarker(e);const n=markers.find((n=>n.business&&n.business._id===e));if(n)try{let o;if(n.getPosition&&"function"==typeof n.getPosition)o=n.getPosition();else if(n.position)o=n.position;else{if(!(n.business&&n.business.lat&&n.business.lng))return console.error("Could not determine marker position"),void alert("Could not focus on this business on the map.");o=new google.maps.LatLng(parseFloat(n.business.lat),parseFloat(n.business.lng))}map.setCenter(o),map.setZoom(16),showEnhancedInfoWindow(n),document.getElementById("map").scrollIntoView({behavior:"smooth"}),console.log("Successfully focused on marker for business:",e)}catch(e){console.error("Error focusing on marker:",e),alert("There was an error focusing on this business on the map.")}else console.warn(`No marker found for business ID: ${e}`),fetchBusinessAndCreateMarker(e)},document.addEventListener("DOMContentLoaded",(function(){console.log("DOM loaded, initializing enhanced business search..."),addEnhancedMarkerStyles(),setTimeout((()=>{applyInfoWindowPositioningFixes(),applyMapHeightFix(),applyInfoWindowCSS(),applyCSSOnlyTailFix(),applyInfoWindowPositioningFixes(),removeProblematicInfoWindowCSS()}),500),addCustomMarkerStyles(),addChainBadgeStyles(),initBusinessSearch(),checkForNewlyAddedBusiness(),window.google&&window.google.maps?(console.log("Google Maps already loaded, initializing map"),initGoogleMap()):console.log("Google Maps not yet loaded, will be initialized via callback")}));let COMPREHENSIVE_CHAIN_DATABASE_UPDATED={homedepot:{id:"6831163b09ee562f96d2a573",canonicalName:"The Home Depot",variations:["home depot","the home depot","homedepot","home depot store","the home depot store"],keywords:["home","depot","hardware","improvement"]},olivegardenitalian:{id:"6831163b09ee562f96d2a574",canonicalName:"Olive Garden",variations:["olive garden","olive garden italian restaurant","olive garden italian","olivegarden","olive garden restaurant"],keywords:["olive","garden","italian","restaurant","pasta"]},lowes:{id:"6831163b09ee562f96d2a572",canonicalName:"Lowe's",variations:["lowes","lowe's","lowes home improvement","lowe's home improvement"],keywords:["lowes","lowe's","home","improvement","hardware"]}},COMPREHENSIVE_CHAIN_DATABASE={homedepot:{id:"6831163b09ee562f96d2a573",canonicalName:"The Home Depot",variations:["home depot","the home depot","homedepot","home depot store","the home depot store"],keywords:["home","depot","hardware","improvement"]},olivegardenitalian:{id:"6831163b09ee562f96d2a574",canonicalName:"Olive Garden",variations:["olive garden","olive garden italian restaurant","olive garden italian","olivegarden","olive garden restaurant"],keywords:["olive","garden","italian","restaurant","pasta"]},lowes:{id:"6831163b09ee562f96d2a572",canonicalName:"Lowe's",variations:["lowes","lowe's","lowes home improvement","lowe's home improvement","lowes companies","lowe's companies"],keywords:["lowes","lowe's","home","improvement","hardware"]},mcdonalds:{id:"mcdonalds_chain_id",canonicalName:"McDonald's",variations:["mcdonalds","mcdonald's","mickey d's","micky d's","mcdonalds restaurant","mcdonald's restaurant"],keywords:["mcdonalds","mcdonald's","fast","food","burger"]},walmart:{id:"walmart_chain_id",canonicalName:"Walmart",variations:["walmart","wal-mart","walmart supercenter","wal-mart supercenter","walmart store","wal-mart store"],keywords:["walmart","wal-mart","supercenter","retail"]},target:{id:"target_chain_id",canonicalName:"Target",variations:["target","target store","target corporation","target retail"],keywords:["target","retail","store"]},bestbuy:{id:"bestbuy_chain_id",canonicalName:"Best Buy",variations:["best buy","bestbuy","best buy store","bestbuy store"],keywords:["best","buy","electronics","tech"]},starbucks:{id:"starbucks_chain_id",canonicalName:"Starbucks",variations:["starbucks","starbucks coffee","starbucks corporation","starbucks store"],keywords:["starbucks","coffee","cafe"]}};function calculateSimilarity(e,n){if(!e||!n)return 0;const o=e.toLowerCase().trim(),a=n.toLowerCase().trim();if(o===a)return 1;if(o.includes(a)||a.includes(o))return.9;const t=1-levenshteinDistance(o,a)/Math.max(o.length,a.length);return Math.max(0,t)}function levenshteinDistance(e,n){const o=[];for(let e=0;e<=n.length;e++)o[e]=[e];for(let n=0;n<=e.length;n++)o[0][n]=n;for(let a=1;a<=n.length;a++)for(let t=1;t<=e.length;t++)n.charAt(a-1)===e.charAt(t-1)?o[a][t]=o[a-1][t-1]:o[a][t]=Math.min(o[a-1][t-1]+1,o[a][t-1]+1,o[a-1][t]+1);return o[n.length][e.length]}function extractKeywords(e){if(!e)return[];const n=["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","up","about","into","over","after","store","restaurant","inc","llc","corp","company","companies"];return e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter((e=>e.length>1&&!n.includes(e))).filter(Boolean)}async function findMatchingChainForPlaceResult(e){try{if(!e)return null;console.log("ðŸ” Advanced chain matching for:",e);const n=e.trim();let o=null,a=0;const t=.7;try{const e=await tryServerSideChainMatching(n);if(e)return console.log("âœ… Server-side exact match found:",e.bname),e}catch(e){console.warn("Server-side matching failed, using local matching:",e.message)}const i=extractKeywords(n);console.log("ðŸ·ï¸ Search keywords:",i);for(const[e,s]of Object.entries(COMPREHENSIVE_CHAIN_DATABASE)){for(const e of s.variations){const i=calculateSimilarity(n,e);i>a&&i>=t&&(a=i,o={_id:s.id,bname:s.canonicalName,matchType:"variation",matchScore:i,matchedVariation:e})}const e=i.filter((e=>s.keywords.some((n=>calculateSimilarity(e,n)>=.8))));if(e.length>=2){const n=.8;n>a&&(a=n,o={_id:s.id,bname:s.canonicalName,matchType:"keywords",matchScore:n,matchedKeywords:e})}}if(o){console.log(`ðŸŽ¯ Best match found: "${n}" â†’ "${o.bname}" (${o.matchType}, score: ${o.matchScore.toFixed(2)})`);try{const e=await getChainFromDatabase(o.bname);if(e)return e}catch(e){console.warn("Could not fetch chain from database:",e)}return o}return console.log("âŒ No suitable chain match found for:",n),null}catch(e){return console.error("Error in advanced chain matching:",e),null}}async function tryServerSideChainMatching(e){const n=getBaseURL(),o=[e,...generateNameVariations(e)];for(const e of o)try{const o=await fetch(`${n}/api/business.js?operation=find_matching_chain&place_name=${encodeURIComponent(e)}`);if(o.ok){const n=await o.json();if(n.success&&n.chain)return console.log(`Server match found with "${e}":`,n.chain.bname),n.chain}}catch(e){}return null}async function getChainFromDatabase(e){try{const n=getBaseURL(),o=await fetch(`${n}/api/chains.js?operation=search&chain_name=${encodeURIComponent(e)}`);if(o.ok){const e=await o.json();if(e.chains&&e.chains.length>0){const n=e.chains[0];return{_id:n._id,bname:n.chain_name,chain_name:n.chain_name}}}return null}catch(e){return console.error("Error fetching chain from new chains collection:",e),null}}function generateNameVariations(e){const n=[],o=e.toLowerCase();return o.startsWith("the ")?n.push(e.substring(4)):n.push("The "+e),[" italian restaurant"," italian"," restaurant"," store"," location"," home improvement"," companies"," corporation"," corp"," inc"," llc"].forEach((a=>{o.includes(a.toLowerCase())&&n.push(e.replace(new RegExp(a,"gi"),"").trim())})),[" restaurant"," store"].forEach((a=>{o.includes(a.toLowerCase())||n.push(e+a)})),[...new Set(n)].filter((n=>n!==e))}async function retrieveFromMongoDB(e,n=!1){try{console.log("ðŸ” Starting enhanced search with form data:",e);const o=document.getElementById("business-search-results")||document.getElementById("search_table");o&&(o.innerHTML='<div class="loading-indicator" id="main-loading">Searching for businesses...</div>',o.style.display="block");let a=null;if(e.useMyLocation)try{updateLoadingMessage("Getting your location..."),a=await getUserLocation(),window.currentSearchLocation=a}catch(e){return console.error("Error getting user location:",e),hideLoadingIndicator(),void alert("Unable to get your current location. Please try entering an address instead.")}else if(e.address&&""!==e.address.trim())try{updateLoadingMessage("Finding location...");const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw new Error(`Geocoding failed for address: ${e.address}`);if(a=n,window.currentSearchLocation=a,map&&a){const e=new google.maps.LatLng(a.lat,a.lng);map.setCenter(e),map.setZoom(11)}}catch(e){return console.error("Error geocoding address:",e),hideLoadingIndicator(),void alert("We couldn't recognize that address. Please try a more specific address.")}updateLoadingMessage("Searching database...");const t=await searchDatabaseWithFuzzyMatching(e,a,n);console.log(`ðŸ“Š Database search returned ${t.length} businesses`);let i=[],s=[];t&&t.length>0&&t.forEach((e=>{const n=getBusinessLocation(e);if(!n||!a)return void s.push(e);const o=new google.maps.LatLng(n.lat,n.lng),t=new google.maps.LatLng(a.lat,a.lng);621371e-9*google.maps.geometry.spherical.computeDistanceBetween(o,t)<=50?i.push(e):s.push(e)})),console.log(`ðŸ“ Location analysis: ${i.length} nearby, ${s.length} distant`);const r=[...i,...s];if(r.length>0){if(console.log("âœ… Found businesses in database, displaying those first"),updateLoadingMessage("Loading results..."),hideLoadingIndicator(),displayBusinessesOnMap(r),displaySearchResults(r),a&&0===i.length&&e.businessName&&(console.log("ðŸŒ No nearby database businesses, supplementing with Google Places"),await supplementWithGooglePlaces(e.businessName,a,r)),a){searchNearbyBusinesses(new google.maps.LatLng(a.lat,a.lng),r[0].type||"OTHER")}}else if(e.businessName&&a){console.log("ðŸŒ No database businesses found, searching Google Places"),updateLoadingMessage("Searching Google Places...");try{const n=await searchGooglePlacesForBusiness(e.businessName,a);n&&n.length>0?(console.log(`ðŸ“ Found ${n.length} businesses via Google Places`),updateLoadingMessage("Loading results..."),hideLoadingIndicator(),displayBusinessesOnMap(n),displaySearchResults(n)):(hideLoadingIndicator(),showNoResultsMessage())}catch(e){console.error("Error searching Google Places:",e),hideLoadingIndicator(),showErrorMessage("Error searching for businesses. Please try again.")}}else hideLoadingIndicator(),showNoResultsMessage()}catch(e){console.error("Enhanced search error:",e),hideLoadingIndicator(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}async function supplementWithGooglePlaces(e,n,o){try{console.log("ðŸ” Supplementing with Google Places for:",e);const a=await searchGooglePlacesForBusiness(e,n);if(a&&a.length>0){console.log(`ðŸ“ Found ${a.length} additional businesses via Google Places`);const e=o.map((e=>`${e.address1} ${e.city} ${e.state}`.toLowerCase().replace(/\s+/g," "))),n=a.filter((n=>{const o=`${n.address1} ${n.city} ${n.state}`.toLowerCase().replace(/\s+/g," ");return!e.some((e=>e.includes(o)||o.includes(e)))}));n.length>0&&(console.log(`ðŸ“ Adding ${n.length} new Google Places results`),n.forEach((e=>{createBusinessMarker(e)})),displaySearchResults([...o,...n]))}}catch(e){console.error("Error supplementing with Google Places:",e)}}function fetchBusinessIncentives(e,n=null){if(!e)return void console.error("No business ID provided for fetching incentives");console.log(`ðŸŽ Fetching incentives for business: ${e}, chain: ${n}`);let o=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${e}`;n&&(o+=`&chain_id=${n}`),console.log("Fetching incentives from: ",o),fetch(o).then((e=>{if(!e.ok)throw new Error(`Failed to fetch incentives: ${e.status} ${e.statusText}`);return e.json()})).then((n=>{console.log(`Incentives data for business ${e}:`,n);const o=document.getElementById(`incentives-for-${e}`);if(!o)return void console.error(`Could not find cell for incentives-for-${e}`);if(!n.results||0===n.results.length)return console.log(`No incentives found for business ${e}`),void(o.innerHTML="No incentives found");let a="";n.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"",t=e.is_chain_wide?'<span class="chain-badge small">Chain-wide</span>':"";a+=`\n                        <div class="incentive-item">\n                            <strong>${n}${o}:</strong> ${e.amount}% ${t}\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),o.innerHTML=""===a?"No active incentives found":a,console.log(`âœ… Successfully loaded incentives for business ${e}`)})).catch((n=>{console.error(`Error fetching incentives for business ${e}:`,n);const o=document.getElementById(`incentives-for-${e}`);o&&(o.innerHTML="Error loading incentives")}))}function addBusinessRow(e,n,o){if(!e)return;if(!0===e.is_chain)return void console.log(`Skipping parent chain business in table: ${e.bname}`);let a="";if(e.address1)a=e.address2?`${e.address1}<br>${e.address2}<br>${e.city}, ${e.state} ${e.zip}`:`${e.address1}<br>${e.city}, ${e.state} ${e.zip}`;else{if(!e.formattedAddress)return void console.warn(`Business ${e.bname} has no address information`);a=e.formattedAddress.replace(/,/g,"<br>")}const t=getBusinessTypeLabel(e.type),i=!!e.chain_id,s=!!e.isGooglePlace;let r,c="";i&&(c='<span class="chain-badge">Chain Location</span>'),r=s?i?`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${e.placeId||""}', '${e.chain_id||""}')">Add Chain Location</button>`:`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${e.placeId||""}')">Add to Database</button>`:`<button class="view-map-btn" onclick="focusOnMapMarker('${e._id}')">View on Map</button>`;const l=document.createElement("tr");l.innerHTML=`\n        <th class="left_table" data-business-id="${e._id}">\n            ${e.bname} ${c}\n        </th>\n        <th class="left_table">${a}</th>\n        <th class="left_table">${t}</th>\n        <th class="right_table" id="incentives-for-${e._id}">\n            ${o&&!i?"Not in database yet":"Loading incentives..."}\n        </th>\n        <th class="center_table">${r}</th>\n    `,n.appendChild(l),o&&i?(console.log(`ðŸ”— Loading chain incentives for Google Places result: ${e.bname}`),fetchChainIncentivesForPlacesResult(e._id,e.chain_id)):s||(console.log(`ðŸ¢ Loading incentives for database business: ${e.bname} (ID: ${e._id})`),setTimeout((()=>{fetchBusinessIncentives(e._id,e.chain_id)}),100))}function createBusinessMarker(e){try{if(console.log(`ðŸ” STABLE MARKER: Creating marker for ${e.bname}`),console.log("   - Platform: "+(isSafariOrIOS?"Safari/iOS":"Other")),console.log("   - Source: "+(e._id?.startsWith("google_")?"GOOGLE PLACES":"DATABASE")),!e.lat||!e.lng||isNaN(parseFloat(e.lat))||isNaN(parseFloat(e.lng)))return console.warn(`âŒ Invalid coordinates for business: ${e.bname}`),null;const n=!e.isGooglePlace&&!e._id?.startsWith("google_"),o=!0===e.isGooglePlace||e._id?.startsWith("google_");e.isFromDatabase=n,e.isGooglePlace=o,console.log(`ðŸ·ï¸ STABLE MARKER: ${e.bname} â†’ ${n?"DATABASE":"GOOGLE PLACES"}`);const a=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng));let t;return t=isSafariOrIOS?createStableSafariMarker(e,a,n):createEnhancedBusinessMarkerFixed(e,a,n),t&&bounds&&bounds.extend(a),t}catch(e){return console.error("âŒ Error creating stable marker:",e),null}}function createStableSafariMarker(e,n,o){try{console.log(`ðŸ“± SAFARI STABLE: Creating non-flickering marker for ${e.bname}`),e.chain_id;const a=o?CONFIG.markerColors.primary:CONFIG.markerColors.nearby,t=createSafariCompatibleIcon(e,a,o),i=new google.maps.Marker({position:n,map,title:e.bname,icon:t,animation:null,zIndex:o?1e3:100,optimized:!1,clickable:!0});return i.business=e,i.position=n,i.isFromDatabase=o,i.isSafariStableMarker=!0,i.addListener("click",(function(n){console.log(`ðŸ“± Safari stable marker clicked: ${e.bname}`),n&&n.stop&&n.stop(),setTimeout((()=>{showEnhancedInfoWindowWithCombinedIncentives(i)}),50)})),markers.push(i),console.log(`âœ… Created STABLE Safari marker for ${e.bname}`),i}catch(a){return console.error("âŒ Error creating Safari stable marker:",a),createBasicSafariMarker(e,n,o)}}function createSafariCompatibleIcon(e,n,o){try{const a=o?40:36,t=`\n            <svg width="${a}" height="${a+8}" viewBox="0 0 ${a} ${a+8}" xmlns="http://www.w3.org/2000/svg">\n                <defs>\n                    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">\n                        <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="rgba(0,0,0,0.3)"/>\n                    </filter>\n                </defs>\n                <circle cx="${a/2}" cy="${a/2}" r="${(a-8)/2}" \n                        fill="${n}" \n                        stroke="white" \n                        stroke-width="3" \n                        filter="url(#shadow)"/>\n                <text x="${a/2}" y="${a/2+2}" \n                      text-anchor="middle" \n                      dominant-baseline="middle" \n                      font-size="${a/3}" \n                      fill="white">\n                    ${getBusinessTypeEmojiForSafari(e.type)}\n                </text>\n                ${e.chain_id?`\n                    <circle cx="${a-8}" cy="8" r="6" fill="#FFD700" stroke="white" stroke-width="2"/>\n                    <text x="${a-8}" y="10" text-anchor="middle" dominant-baseline="middle" font-size="8" fill="#333">â›“</text>\n                `:""}\n            </svg>\n        `;return{url:"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(t),size:new google.maps.Size(a,a+8),scaledSize:new google.maps.Size(a,a+8),anchor:new google.maps.Point(a/2,a+8),optimized:!1}}catch(e){return console.error("âŒ Error creating Safari icon:",e),createFallbackSafariIcon(n,o)}}function getBusinessTypeEmojiForSafari(e){return{AUTO:"ðŸš—",BEAU:"ðŸ’„",BOOK:"ðŸ“š",CLTH:"ðŸ‘•",CONV:"ðŸª",DEPT:"ðŸ¬",ELEC:"âš¡",ENTR:"ðŸŽ¬",FURN:"ðŸª‘",FUEL:"â›½",GIFT:"ðŸŽ",GROC:"ðŸ›’",HARDW:"ðŸ”¨",HEAL:"ðŸ¥",HOTEL:"ðŸ¨",JEWL:"ðŸ’Ž",OTHER:"ðŸ“",RX:"ðŸ’Š",REST:"ðŸ½ï¸",RETAIL:"ðŸ›ï¸",SERV:"ðŸ”§",SPEC:"â­",SPRT:"âš½",TECH:"ðŸ’»",TOYS:"ðŸ§¸"}[e]||"ðŸ“"}function createFallbackSafariIcon(e,n){const o=n?20:16;return{path:google.maps.SymbolPath.CIRCLE,fillColor:e,fillOpacity:.9,strokeWeight:3,strokeColor:"#FFFFFF",scale:o,anchor:new google.maps.Point(0,0)}}function createBasicSafariMarker(e,n,o){try{console.log(`ðŸ“± BASIC SAFARI: Creating basic marker for ${e.bname}`);const a=o?CONFIG.markerColors.primary:CONFIG.markerColors.nearby,t=new google.maps.Marker({position:n,map,title:e.bname,icon:createFallbackSafariIcon(a,o),animation:null,zIndex:o?1e3:100,optimized:!1});return t.business=e,t.position=n,t.isFromDatabase=o,t.isBasicSafariMarker=!0,t.addListener("click",(function(){console.log(`ðŸ“± Basic Safari marker clicked: ${e.bname}`),setTimeout((()=>{showEnhancedInfoWindowWithCombinedIncentives(t)}),50)})),markers.push(t),console.log(`âœ… Created BASIC Safari marker for ${e.bname}`),t}catch(e){return console.error("âŒ Error creating basic Safari marker:",e),null}}async function createEnhancedBusinessMarkerFixed(e,n,o=!1){try{console.log(`ðŸ”§ ENHANCED MARKER: Creating for ${e.bname} (Non-Safari)`);const{AdvancedMarkerElement:a}=await google.maps.importLibrary("marker");let t=createSafeLatLng(n);if(!t)return console.error("âŒ Invalid position for enhanced marker:",n),createStableSafariMarker(e,n,o);const i=o||!e.isGooglePlace&&!e._id?.startsWith("google_"),s=!!e.chain_id;let r,c;i?(r=CONFIG.markerColors.primary,c="primary database-business",console.log(`ðŸ”´ RED ADVANCED MARKER: ${e.bname} (Database business)`)):(r=CONFIG.markerColors.nearby,c="nearby google-places",console.log(`ðŸ”µ BLUE ADVANCED MARKER: ${e.bname} (Google Places)`));const l=getBusinessTypeTextIcon(e.type),d=document.createElement("div");d.className="enhanced-custom-marker",d.setAttribute("title",e.bname),d.style.cursor="pointer",d.innerHTML=`\n            <div class="enhanced-marker-container">\n                <div class="enhanced-marker-pin ${c}" style="background-color: ${r} !important; border: 3px solid #ffffff;">\n                    <div class="enhanced-marker-icon">\n                        ${l}\n                    </div>\n                </div>\n                <div class="enhanced-marker-shadow"></div>\n                ${s?'<div class="chain-indicator">ðŸ”—</div>':""}\n                ${i?'<div class="database-indicator">âœ“</div>':""}\n            </div>\n        `;const g=new a({position:t,map,title:e.bname,content:d,collisionBehavior:i?"REQUIRED_AND_HIDES_OPTIONAL":"OPTIONAL_AND_HIDES_LOWER_PRIORITY"});g.business=e,g.position=t,g.isFromDatabase=i,g.isAdvancedMarker=!0;const u=function(n){n&&(n.preventDefault(),n.stopPropagation()),console.log(`ðŸ–±ï¸ Advanced marker clicked: ${e.bname}`),showEnhancedInfoWindowWithCombinedIncentives(g)};return d.addEventListener("click",u,{passive:!1}),"ontouchstart"in window||(d.addEventListener("mouseenter",(function(){d.style.transform="scale(1.1)",d.style.zIndex="1000"})),d.addEventListener("mouseleave",(function(){d.style.transform="scale(1)",d.style.zIndex="auto"}))),markers.push(g),console.log(`âœ… Added ADVANCED marker for ${e.bname}`),g}catch(a){return console.error("âŒ Error creating enhanced marker, falling back to Safari stable:",a),createStableSafariMarker(e,n,o)}}function fetchBusinessIncentivesFixed(e,n=null){e&&!e.startsWith("google_")?(console.log(`ðŸŽ ENHANCED INCENTIVES DEBUG: Fetching for business ID: ${e}`),console.log(`   - Chain ID: ${n||"None"}`),setTimeout((()=>{const o=document.getElementById(`incentives-for-${e}`);if(!o)return void console.error(`âŒ Could not find incentives cell for business ${e}`);console.log(`âœ… Found incentives cell for ${e}`),o.innerHTML='<span class="loading-incentives">Loading incentives...</span>';const a=getBaseURL();fetch(`${a}/api/business.js?operation=get&id=${e}`).then((e=>{if(!e.ok)throw new Error(`Failed to get business details: ${e.status}`);return e.json()})).then((o=>{console.log("ðŸ“Š Business details for incentives:",o.result);const a=o.result,t=!(!a.chain_id&&!n),i=a.chain_id||n;console.log(`ðŸ” Chain analysis for ${a.bname}:`),console.log(`   - Has chain_id: ${!!a.chain_id}`),console.log(`   - Passed chainId: ${n}`),console.log(`   - Is chain location: ${t}`),console.log(`   - Effective chain ID: ${i}`),t&&i?(console.log(`ðŸ”— Loading CHAIN incentives for ${a.bname} (Chain ID: ${i})`),loadChainIncentivesForTableCell(e,i,a.bname)):(console.log(`ðŸ¢ Loading BUSINESS incentives for ${a.bname}`),loadBusinessIncentivesForTableCell(e,a.bname))})).catch((n=>{console.error("âŒ Error getting business details for incentives:",n),loadBusinessIncentivesForTableCell(e,"Unknown Business")}))}),200)):console.log(`â­ï¸ Skipping incentives for Google Places business: ${e}`)}function loadChainIncentivesForTableCell(e,n,o){console.log(`ðŸ”— TABLE CHAIN INCENTIVES: Loading for business ${o} (ID: ${e}, Chain: ${n})`);const a=document.getElementById(`incentives-for-${e}`);if(!a)return void console.error(`âŒ Incentives cell not found for ${e}`);const t=`${getBaseURL()}/api/chains.js?operation=get_incentives&chain_id=${n}`;console.log(`ðŸŒ Fetching chain incentives for table: ${t}`),fetch(t).then((e=>{if(!e.ok)throw new Error(`Chain incentives API failed: ${e.status}`);return e.json()})).then((e=>{if(console.log(`ðŸ“Š Chain incentives data for table (${o}):`,e),!e.incentives||0===e.incentives.length)return void(a.innerHTML='<em style="color: #666;">No chain incentives available</em>');let n="",t=0;e.incentives.forEach((e=>{if(e.is_active){t++;const o=getIncentiveTypeLabel(e.type),a=e.other_description?` (${e.other_description})`:"";n+=`\n                        <div class="incentive-item table-incentive">\n                            <strong>${o}${a}:</strong> ${e.amount}% \n                            <span class="chain-badge small">â›“ï¸ Chain-wide</span>\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),0===t?a.innerHTML='<em style="color: #666;">No active chain incentives</em>':(a.innerHTML=n,console.log(`âœ… Successfully loaded ${t} chain incentives for table (${o})`))})).catch((e=>{console.error(`âŒ Error loading chain incentives for table (${o}):`,e),a.innerHTML='<span class="incentives-error">Error loading chain incentives</span>'}))}function loadBusinessIncentivesForTableCell(e,n){console.log(`ðŸ¢ TABLE BUSINESS INCENTIVES: Loading for ${n} (ID: ${e})`);const o=document.getElementById(`incentives-for-${e}`);if(!o)return void console.error(`âŒ Incentives cell not found for ${e}`);const a=`${getBaseURL()}/api/combined-api.js?operation=incentives&business_id=${e}`;console.log(`ðŸŒ Fetching business incentives for table: ${a}`),fetch(a).then((e=>{if(!e.ok)throw new Error(`Business incentives API failed: ${e.status}`);return e.json()})).then((e=>{if(console.log(`ðŸ“Š Business incentives data for table (${n}):`,e),!e.results||0===e.results.length)return void(o.innerHTML='<em style="color: #666;">No incentives available</em>');let a="",t=0;e.results.forEach((e=>{if(e.is_available){t++;const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"";a+=`\n                        <div class="incentive-item table-incentive">\n                            <strong>${n}${o}:</strong> ${e.amount}%\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),0===t?o.innerHTML='<em style="color: #666;">No active incentives</em>':(o.innerHTML=a,console.log(`âœ… Successfully loaded ${t} business incentives for table (${n})`))})).catch((e=>{console.error(`âŒ Error loading business incentives for table (${n}):`,e),o.innerHTML='<span class="incentives-error">Error loading incentives</span>'}))}function addBusinessRowFixed(e,n,o){if(!e)return;if(!0===e.is_chain)return void console.log(`â­ï¸ Skipping parent chain business in table: ${e.bname}`);console.log(`ðŸ“ ENHANCED TABLE ROW: Adding row for: ${e.bname}`),console.log(`   - Is from Places: ${o}`),console.log(`   - Business ID: ${e._id}`),console.log(`   - Chain ID: ${e.chain_id||"None"}`),console.log(`   - Is chain location: ${!!e.chain_id}`);let a="";if(e.address1)a=e.address2?`${e.address1}<br>${e.address2}<br>${e.city}, ${e.state} ${e.zip}`:`${e.address1}<br>${e.city}, ${e.state} ${e.zip}`;else{if(!e.formattedAddress)return void console.warn(`âŒ Business ${e.bname} has no address information`);a=e.formattedAddress.replace(/,/g,"<br>")}const t=getBusinessTypeLabel(e.type),i=!!e.chain_id,s=!!e.isGooglePlace;let r,c="";i&&(c=`<span class="chain-badge enhanced">ðŸ”— ${e.chain_name||"Chain Location"}</span>`),r=s?i?`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${e.placeId||""}', '${e.chain_id||""}')">Add Chain Location</button>`:`<button class="add-to-db-btn" onclick="addBusinessToDatabase('${e.placeId||""}')">Add to Database</button>`:`<button class="view-map-btn" onclick="focusOnMapMarker('${e._id}')">View on Map</button>`;const l=document.createElement("tr");l.className="business-row "+(i?"chain-business":"regular-business"),l.innerHTML=`\n        <th class="left_table" data-business-id="${e._id}">\n            ${e.bname} ${c}\n        </th>\n        <th class="left_table">${a}</th>\n        <th class="left_table">${t}</th>\n        <th class="right_table" id="incentives-for-${e._id}">\n            ${o&&!i?"Not in database yet":'<span class="loading-incentives">Loading incentives...</span>'}\n        </th>\n        <th class="center_table">${r}</th>\n    `,n.appendChild(l),s?i?(console.log(`ðŸ”— Scheduling chain incentives load for Google Places: ${e.bname}`),fetchChainIncentivesForPlacesResult(e._id,e.chain_id)):console.log(`â„¹ï¸ No incentives to load for non-chain Google Places: ${e.bname}`):(console.log(`ðŸŽ ENHANCED: Scheduling incentives load for database business: ${e.bname}`),console.log("   - Will check for chain association: "+(i?"Yes":"No")),console.log(`   - Chain ID to pass: ${e.chain_id||"None"}`),setTimeout((()=>{fetchBusinessIncentivesFixed(e._id,e.chain_id)}),100))}function addEnhancedTableChainStyles(){if(!document.getElementById("enhanced-table-chain-styles")){const e=document.createElement("style");e.id="enhanced-table-chain-styles",e.textContent="\n            /* Enhanced chain business styling in tables */\n            .business-row.chain-business {\n                background-color: rgba(66, 133, 244, 0.05);\n                border-left: 3px solid #4285F4;\n            }\n            \n            .chain-badge.enhanced {\n                display: inline-block;\n                background: linear-gradient(45deg, #4285F4, #64B5F6);\n                color: white;\n                padding: 3px 8px;\n                border-radius: 12px;\n                font-size: 0.8em;\n                margin-left: 8px;\n                font-weight: 500;\n                box-shadow: 0 1px 3px rgba(0,0,0,0.2);\n            }\n            \n            .incentive-item.table-incentive {\n                margin: 4px 0;\n                padding: 4px 6px;\n                background-color: #f8f9fa;\n                border-radius: 4px;\n                border-left: 3px solid #28a745;\n                font-size: 13px;\n            }\n            \n            .chain-badge.small {\n                background: #4285F4;\n                color: white;\n                padding: 1px 6px;\n                border-radius: 8px;\n                font-size: 10px;\n                margin-left: 4px;\n                font-weight: 500;\n            }\n            \n            .incentive-info {\n                font-size: 11px;\n                color: #666;\n                font-style: italic;\n                margin-top: 2px;\n            }\n            \n            .loading-incentives {\n                color: #666;\n                font-style: italic;\n            }\n            \n            .incentives-error {\n                color: #dc3545;\n                font-style: italic;\n            }\n        ",document.head.appendChild(e)}}function updateLoadingMessage(e){const n=document.getElementById("main-loading");n&&(n.innerHTML=`<div class="loading-text">${e}</div><div class="loading-spinner"></div>`)}function hideLoadingIndicator(){const e=document.getElementById("main-loading");e&&e.remove(),document.querySelectorAll(".loading-indicator").forEach((e=>{("main-loading"===e.id||e.textContent.includes("Searching"))&&e.remove()}))}function showNoResultsMessage(){hideLoadingIndicator();const e=document.getElementById("business-search-results")||document.getElementById("search_table");e&&(e.innerHTML='<div class="error-message">No businesses found matching your search criteria in this area.</div>',e.style.display="block")}function showErrorMessage(e){hideLoadingIndicator();const n=document.getElementById("business-search-results")||document.getElementById("search_table");n&&(n.innerHTML=`<div class="error-message">${e}</div>`,n.style.display="block")}async function searchDatabaseWithExpandedChainRadius(e,n,o){const a={};e.businessName&&""!==e.businessName.trim()&&(a.business_name=e.businessName),e.address&&""!==e.address.trim()&&!n&&(a.address=e.address),n&&n.lat&&n.lng&&(a.lat=n.lat,a.lng=n.lng,e.businessName&&""!==e.businessName.trim()?(a.radius=200,console.log(`ðŸ” BUSINESS NAME SEARCH: Using expanded ${a.radius}km radius for "${e.businessName}"`)):(a.radius=25,console.log(`ðŸ“ LOCATION SEARCH: Using standard ${a.radius}km radius`))),o&&(a.ts=(new Date).getTime());const t=new URLSearchParams(a).toString(),i=`${getBaseURL()}/api/business.js?operation=search&${t}`;console.log(`ðŸŒ ENHANCED DATABASE SEARCH: ${i}`);const s=await fetch(i,{method:"GET",headers:{"Content-Type":"application/json; charset=UTF-8","Cache-Control":o?"no-cache, no-store, must-revalidate":"default"}});if(!s.ok)throw new Error(`Database search failed: ${s.status}`);const r=(await s.json()).results||[];console.log(`ðŸ“Š Raw database results: ${r.length} businesses found`);const c=r.filter((e=>!0===e.is_chain?(console.log(`ðŸš« Filtering out parent chain business: ${e.bname}`),!1):!(n&&!hasValidCoordinates(e))||(console.log(`ðŸš« Filtering out business without valid coordinates: ${e.bname}`),!1)));return console.log(`âœ… ENHANCED FILTER: ${r.length} raw â†’ ${c.length} valid location businesses`),c.length>0&&(console.log("ðŸ“‹ Database businesses found:"),c.forEach(((e,o)=>{const a=n&&e.lat&&e.lng?calculateDistance(n.lat,n.lng,e.lat,e.lng):"Unknown";console.log(`   ${o+1}. ${e.bname} - ${e.city}, ${e.state} (${a}km)`)}))),c}function calculateDistance(e,n,o,a){const t=(o-e)*Math.PI/180,i=(a-n)*Math.PI/180,s=Math.sin(t/2)*Math.sin(t/2)+Math.cos(e*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2),r=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))*6371;return Math.round(r)}async function performEnhancedBusinessSearchWithExpandedChainRadius(e,n=!1){try{console.log("ðŸ” EXPANDED CHAIN SEARCH: Starting search with dynamic radius for chains:",e);const o=document.getElementById("business-search-results")||document.getElementById("search_table");o&&(o.innerHTML='<div class="loading-indicator" id="main-loading"><div class="loading-text">Searching for businesses...</div><div class="loading-spinner"></div></div>',o.style.display="block");let a=null,t=30;if(e.useMyLocation)try{updateLoadingMessage("Getting your location..."),a=await getUserLocation(),window.currentSearchLocation=a}catch(e){return console.error("âŒ Error getting user location:",e),hideLoadingIndicator(),void alert("Unable to get your current location. Please try entering an address instead.")}else if(e.address&&""!==e.address.trim())try{updateLoadingMessage("Finding location...");const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw new Error(`Geocoding failed for address: ${e.address}`);if(a=n,window.currentSearchLocation=a,/^\d{5}$/.test(e.address.trim())?(t=25,console.log("ðŸ“ ZIP CODE SEARCH: Using 25km radius")):e.address.toLowerCase().includes("city")||e.address.split(",").length>=2?(t=30,console.log("ðŸ“ CITY SEARCH: Using 30km radius")):(t=20,console.log("ðŸ“ ADDRESS SEARCH: Using 20km radius")),map&&a){const e=new google.maps.LatLng(a.lat,a.lng);map.setCenter(e),map.setZoom(t<=20?12:11)}}catch(e){return console.error("âŒ Error geocoding address:",e),hideLoadingIndicator(),void alert("We couldn't recognize that address. Please try a more specific address.")}updateLoadingMessage("Searching database with expanded radius...");let i=[];if(e.businessName&&""!==e.businessName.trim())try{i=await searchDatabaseWithExpandedChainRadius(e,a,n),i=i.filter((e=>!0!==e.is_chain)),console.log(`ðŸ“Š ENHANCED PRIMARY RESULTS: Found ${i.length} businesses for "${e.businessName}" with expanded radius`)}catch(e){console.error("âŒ Enhanced primary search failed:",e)}let s=[];if(e.businessName&&a)try{updateLoadingMessage("Searching for additional locations...");const n={...a,searchRadius:Math.max(t,35)};s=await searchGooglePlacesForBusinessEnhanced(e.businessName,n),console.log(`ðŸ“Š PLACES RESULTS: Found ${s.length} additional "${e.businessName}" locations`)}catch(e){console.error("âŒ Places search failed:",e)}let r=[];const c=!e.businessName||e.businessName&&i.length<3;if(a&&c)try{updateLoadingMessage("Finding other nearby businesses..."),r=await searchNearbyDatabaseBusinessesEnhanced(a,t,e.businessName),console.log(`ðŸ“Š NEARBY DATABASE: Found ${r.length} other nearby businesses`)}catch(e){console.error("âŒ Nearby database search failed:",e)}else console.log("â­ï¸ SKIPPING nearby search - found sufficient business name results or no business name provided");const{finalPrimaryResults:l,finalPlacesResults:d,finalNearbyResults:g}=categorizeResultsWithImprovedChainDetection(i,s,r),u=[...l,...d,...g];console.log("ðŸ“Š EXPANDED CHAIN SEARCH RESULTS:"),console.log(`   - ðŸ”´ Primary Database (RED): ${l.length} businesses`),console.log(`   - ðŸ”µ Additional Locations (BLUE): ${d.length} businesses`),console.log(`   - ðŸŸ¢ Other Nearby (GREEN): ${g.length} businesses`),console.log(`   - Total: ${u.length} businesses`),u.length>0?(l.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!0,e.markerColor="primary",e.priority=1})),d.forEach((e=>{e.isGooglePlace=!0,e.isFromDatabase=!1,e.isPrimaryResult=!1,e.isRelevantPlaces=!0,e.markerColor="nearby",e.priority=2})),g.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!1,e.isNearbyDatabase=!0,e.markerColor="database",e.priority=3})),hideLoadingIndicator(),displayBusinessesOnMapWithBetterPriority(u),displaySearchResultsWithBetterPriority(u),showImprovedSearchSuccessMessage(l.length,d.length,g.length,e.businessName),console.log("âœ… EXPANDED CHAIN SEARCH: Completed successfully with dynamic radius")):(hideLoadingIndicator(),showNoResultsMessage())}catch(e){console.error("âŒ Expanded chain search error:",e),hideLoadingIndicator(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}async function testExpandedChainRadius(){console.log("ðŸ§ª TESTING EXPANDED CHAIN RADIUS: Should find all Shag locations from Cedar Rapids");const e={businessName:"Shag",address:"",useMyLocation:!0};try{clearMarkers(),await performEnhancedBusinessSearchWithExpandedChainRadius(e,!0),console.log("âœ… Expanded chain radius test completed - should show ALL Shag locations in database!")}catch(e){console.error("âŒ Expanded chain radius test failed:",e)}}function hasValidCoordinates(e){if(void 0!==e.lat&&void 0!==e.lng){const n=parseFloat(e.lat),o=parseFloat(e.lng);return!isNaN(n)&&!isNaN(o)&&0!==n&&0!==o}if(e.location&&e.location.coordinates&&Array.isArray(e.location.coordinates)&&e.location.coordinates.length>=2){const n=parseFloat(e.location.coordinates[0]),o=parseFloat(e.location.coordinates[1]);return!isNaN(o)&&!isNaN(n)&&0!==o&&0!==n}return!1}async function searchGooglePlacesForBusinessFixed(e,n){try{console.log("ðŸ” PLACES SEARCH: Searching Google Places for:",e,"near",n);const{Place:o}=await google.maps.importLibrary("places"),a=new google.maps.LatLng(n.lat,n.lng),t={textQuery:e,locationBias:{center:a,radius:25e3},maxResultCount:20,fields:["id","displayName","formattedAddress","location","types","nationalPhoneNumber","internationalPhoneNumber"]};console.log("ðŸŒ Places API request:",t);const{places:i}=await o.searchByText(t);if(!i||0===i.length)return console.log("âŒ No businesses found via Places API"),[];console.log(`âœ… Found ${i.length} businesses via Places API`);const s=i.map((async e=>{const o=e.formattedAddress?e.formattedAddress.split(","):[];let t="",i="",s="",r="";if(o.length>=1&&(t=o[0].trim()),o.length>=2&&(i=o[1].trim()),o.length>=3){const e=o[2].trim().match(/^([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/);e&&(s=e[1],r=e[2])}const c=e.location,l=google.maps.geometry.spherical.computeDistanceBetween(a,c);let d=0,g=0;if(e.location)try{d="function"==typeof e.location.lat?e.location.lat():e.location.lat||0,g="function"==typeof e.location.lng?e.location.lng():e.location.lng||0}catch(e){console.warn("âš ï¸ Error extracting coordinates:",e),d=n.lat,g=n.lng}const u={_id:"google_"+e.id,bname:e.displayName,address1:t,city:i,state:s,zip:r,formattedAddress:e.formattedAddress,type:mapGooglePlaceTypeToBusinessType(e.types),phone:e.nationalPhoneNumber||e.internationalPhoneNumber||"",isGooglePlace:!0,placeId:e.id,lat:d,lng:g,distance:l};try{const n=await findMatchingChainForPlaceResult(e.displayName);n?(console.log(`ðŸ”— CHAIN MATCH: "${e.displayName}" matches "${n.bname}"`),u.chain_id=n._id,u.chain_name=n.bname,u.isChainLocation=!0):console.log(`âŒ No chain match for: ${e.displayName}`)}catch(e){console.warn("âš ï¸ Error checking for chain match:",e)}return u})),r=await Promise.all(s);return r.sort(((e,n)=>e.distance-n.distance)),console.log(`ðŸ“Š FINAL PLACES RESULTS: ${r.length} businesses processed`),r.forEach(((e,n)=>{console.log(`   ${n+1}. ${e.bname} (Chain: ${e.isChainLocation?e.chain_name:"No"})`)})),r}catch(e){return console.error("âŒ Error in Places API search:",e),[]}}function buildEnhancedInfoWindowContentFixed2(e){const n=!0===e.isGooglePlace,o=!!e.chain_id,a=!n;let t="";if(e.address1){t=`<div class="info-address">\n            <strong>ðŸ“ Address:</strong><br>\n            ${e.address1}`,e.address2&&(t+=`<br>${e.address2}`);const n=[];e.city&&n.push(e.city),e.state&&n.push(e.state),e.zip&&n.push(e.zip),n.length>0&&(t+=`<br>${n.join(", ")}`),t+="</div>"}else if(e.formattedAddress){const n=e.formattedAddress.split(",").map((e=>e.trim()));t='<div class="info-address">\n            <strong>ðŸ“ Address:</strong><br>',n.length>=1&&(t+=n[0]),n.length>=2&&(t+=`<br>${n.slice(1).join(", ")}`),t+="</div>"}const i=e.phone?`<div class="info-phone"><strong>ðŸ“ž Phone:</strong> <a href="tel:${e.phone.replace(/\D/g,"")}" style="color: #4285F4; text-decoration: none;">${e.phone}</a></div>`:"";let s="";e.type&&"OTHER"!==e.type&&(s=`<div class="info-type"><strong>ðŸ¢ Type:</strong> ${getBusinessTypeLabel(e.type)}</div>`);const r=e.distance?`<div class="info-distance"><strong>ðŸ“ Distance:</strong> ${(e.distance/1609).toFixed(1)} miles</div>`:"",c=o?`<span class="enhanced-chain-badge">ðŸ”— ${e.chain_name||"Chain Location"}</span>`:"";let l,d,g="";n?o?(l='<div class="info-status chain-match">ðŸ”— This location appears to match a chain in our database!</div>',g=`<div class="chain-explanation">\n                âœ¨ Great news! This location matches <strong>${e.chain_name}</strong> in our database. \n                Chain-wide incentives should apply to this location once added.\n            </div>`):l='<div class="info-status google-place">â„¹ï¸ This business is not yet in the Patriot Thanks database.</div>':l='<div class="info-status database-business">âœ… This business is in the Patriot Thanks database.</div>',d=n?o?`\n                <button class="enhanced-add-btn chain-add" onclick="window.addBusinessToDatabase('${e.placeId}', '${e.chain_id}')">\n                    ðŸ”— Add ${e.chain_name} Location\n                </button>\n            `:`\n                <button class="enhanced-add-btn" onclick="window.addBusinessToDatabase('${e.placeId}')">\n                    âž• Add to Patriot Thanks\n                </button>\n            `:`\n            <button class="enhanced-view-btn" onclick="window.viewBusinessDetails('${e._id}')">\n                ðŸ‘ï¸ View Details\n            </button>\n        `;const u=n?`google_${e.placeId}`:e._id;let h;return console.log(`ðŸ†” INFO WINDOW: Using container ID: ${u} for business: ${e.bname}`),h=a&&o?"<em>â³ Loading chain incentives...</em>":a?"<em>â³ Loading incentives...</em>":n&&o?"<em>â³ Loading chain incentives...</em>":"<em>ðŸ’¡ Add this business to see available incentives.</em>",`\n        <div class="enhanced-info-window">\n            <div class="info-header">\n                <h3>${e.bname} ${c}</h3>\n            </div>\n            \n            <div class="info-body">\n                ${t}\n                ${i}\n                ${s}\n                ${r}\n                ${l}\n                ${g}\n                \n                <div class="info-incentives">\n                    <div id="incentives-container-${u}">\n                        ${h}\n                    </div>\n                </div>\n            </div>\n            \n            <div class="info-actions">\n                ${d}\n            </div>\n        </div>\n    `}function showEnhancedInfoWindowFixed2(e){if(console.log("ðŸªŸ INFO WINDOW: Showing enhanced info window for:",e.business?.bname),!e||!e.business)return void console.error("âŒ Invalid marker for info window");const n=e.business,o=!0===n.isGooglePlace,a=!!n.chain_id,t=!o;infoWindow&&infoWindow.close(),infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1});const i=buildEnhancedInfoWindowContentFixed2(n);infoWindow.setContent(i);let s=e.position;if(!s&&e.getPosition&&(s=e.getPosition()),s||(s=createSafeLatLng(n)),s){try{map.panTo(s)}catch(e){console.warn("âš ï¸ Error panning to position:",e)}setTimeout((()=>{try{e.getPosition?infoWindow.open(map,e):(infoWindow.setPosition(s),infoWindow.open(map)),console.log("âœ… Info window opened successfully"),google.maps.event.addListenerOnce(infoWindow,"domready",(function(){setTimeout((()=>{applyEnhancedInfoWindowFixes();const e=o?`google_${n.placeId}`:n._id;console.log(`ðŸŽ INCENTIVES: Loading for container ID: ${e}`),t&&a?(console.log(`ðŸ”— Loading chain incentives for database business: ${n.bname}`),loadChainIncentivesForDatabaseBusinessFixed(e,n.chain_id)):t?(console.log(`ðŸ¢ Loading regular incentives for database business: ${n.bname}`),loadIncentivesForEnhancedWindowFixed(e)):o&&a&&(console.log(`ðŸŒ Loading chain incentives for Google Places: ${n.bname}`),loadChainIncentivesForEnhancedWindowFixed(e,n.chain_id))}),300)}))}catch(e){console.error("âŒ Error opening info window:",e)}}),200)}else console.error("âŒ Could not determine position for info window")}function loadChainIncentivesForEnhancedWindowFixed(e,n){console.log(`ðŸ”— CHAIN INCENTIVES (NEW API): Loading for container ${e}, chain ${n}`);const o=document.getElementById(`incentives-container-${e}`);if(!o)return void console.error(`âŒ Container not found: incentives-container-${e}`);const a=`${getBaseURL()}/api/chains.js?operation=get_incentives&chain_id=${n}`;console.log(`ðŸŒ Fetching chain incentives from NEW API: ${a}`),fetch(a).then((e=>{if(!e.ok)throw new Error(`Chain incentives API failed: ${e.status}`);return e.json()})).then((n=>{if(console.log("ðŸ“Š Chain incentives data from NEW API:",n),!n.incentives||0===n.incentives.length)return void(o.innerHTML="<em>ðŸ’­ No chain incentives available</em>");let a='<div class="incentives-header"><strong>ðŸŽ Chain-wide Incentives:</strong></div>';a+='<div class="incentives-list">',n.incentives.forEach((e=>{if(e.is_active){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"";a+=`\n                        <div class="incentive-item chain-incentive">\n                            <div class="incentive-type">${n}${o}:</div>\n                            <div class="incentive-amount">${e.amount}% <span class="mini-chain-badge">ðŸ”— Chain-wide</span></div>\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),a+="</div>",a+='<div class="chain-note">âœ¨ Great! These incentives apply to all locations of this chain.</div>',o.innerHTML=a,console.log(`âœ… Successfully loaded chain incentives from NEW API for ${e}`)})).catch((e=>{console.error("âŒ Error loading chain incentives from NEW API:",e),o.innerHTML="<em>âŒ Error loading chain incentives</em>"}))}function loadIncentivesForEnhancedWindowFixed(e){console.log(`ðŸ¢ REGULAR INCENTIVES: Loading for container ${e}`);const n=document.getElementById(`incentives-container-${e}`);if(!n)return void console.error(`âŒ Container not found: incentives-container-${e}`);const o=getBaseURL();fetch(`${o}/api/combined-api.js?operation=incentives&business_id=${e}`).then((e=>e.json())).then((o=>{if(!o.results||0===o.results.length)return void(n.innerHTML="<em>ðŸ’­ No incentives available</em>");let a='<div class="incentives-header"><strong>ðŸŽ Available Incentives:</strong></div>';a+='<div class="incentives-list">',o.results.forEach((e=>{if(e.is_available){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"",t=e.is_chain_wide?'<span class="mini-chain-badge">ðŸ”— Chain-wide</span>':"";a+=`\n                        <div class="incentive-item">\n                            <div class="incentive-type">${n}${o}:</div>\n                            <div class="incentive-amount">${e.amount}% ${t}</div>\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),a+="</div>",n.innerHTML=a,console.log(`âœ… Successfully loaded regular incentives for ${e}`)})).catch((e=>{console.error("âŒ Error loading incentives:",e),n.innerHTML="<em>âŒ Error loading incentives</em>"}))}function loadChainIncentivesForDatabaseBusinessFixed(e,n){console.log(`ðŸ”— DATABASE CHAIN INCENTIVES (NEW API): Loading for container ${e}, chain ${n}`);const o=document.getElementById(`incentives-container-${e}`);if(!o)return void console.error(`âŒ Container not found: incentives-container-${e}`);const a=`${getBaseURL()}/api/chains.js?operation=get_incentives&chain_id=${n}`;console.log(`ðŸŒ Fetching database chain incentives from NEW API: ${a}`),fetch(a).then((e=>{if(!e.ok)throw new Error(`Chain incentives API failed: ${e.status}`);return e.json()})).then((n=>{if(console.log("ðŸ“Š Database chain incentives data from NEW API:",n),!n.incentives||0===n.incentives.length)return void(o.innerHTML="<em>ðŸ’­ No chain incentives available</em>");let a='<div class="incentives-header"><strong>ðŸŽ Available Incentives:</strong></div>';a+='<div class="incentives-list">',n.incentives.forEach((e=>{if(e.is_active){const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"";a+=`\n                        <div class="incentive-item chain-incentive">\n                            <div class="incentive-type">${n}${o}:</div>\n                            <div class="incentive-amount">${e.amount}% <span class="mini-chain-badge">ðŸ”— Chain-wide</span></div>\n                            ${e.information?`<div class="incentive-info">${e.information}</div>`:""}\n                        </div>\n                    `}})),a+="</div>",o.innerHTML=a,console.log(`âœ… Successfully loaded database chain incentives from NEW API for ${e}`)})).catch((e=>{console.error("âŒ Error loading database chain incentives from NEW API:",e),o.innerHTML="<em>âŒ Error loading chain incentives</em>"}))}async function findMatchingChainForPlaceResultFixed(e){try{if(!e)return null;console.log("ðŸ” CHAIN MATCHING (NEW API): Checking for:",e);const n=e.trim().toLowerCase();if(chainMatchCache.has(n)){const o=chainMatchCache.get(n);return console.log(`ðŸ’¾ CACHE HIT: ${e} â†’ ${o?o.bname:"No match"}`),o}const o=await findMatchingChainLocallyEnhanced(e);return o?(console.log(`ðŸ  LOCAL MATCH (NEW API): ${e} â†’ ${o.bname}`),chainMatchCache.set(n,o),o):new Promise((o=>{apiCallQueue.push({placeName:e,cleanName:n,resolve:o}),processApiQueueWithNewAPI()}))}catch(e){return console.error("âŒ Error in chain matching with NEW API:",e),null}}async function processApiQueueWithNewAPI(){if(!isProcessingQueue&&0!==apiCallQueue.length){for(isProcessingQueue=!0;apiCallQueue.length>0;){const{placeName:e,cleanName:n,resolve:o}=apiCallQueue.shift();try{console.log(`ðŸŒ API QUEUE (NEW API): Processing ${e} (${apiCallQueue.length} remaining)`);const a=await tryServerSideChainMatchingWithNewAPI(e);a?(console.log(`âœ… SERVER MATCH (NEW API): ${e} â†’ ${a.bname}`),chainMatchCache.set(n,a),o(a)):(console.log(`âŒ NO MATCH (NEW API): ${e}`),chainMatchCache.set(n,null),o(null)),apiCallQueue.length>0&&await new Promise((e=>setTimeout(e,200)))}catch(a){console.error(`âŒ API queue error (NEW API) for ${e}:`,a),chainMatchCache.set(n,null),o(null),apiCallQueue.length>0&&await new Promise((e=>setTimeout(e,500)))}}isProcessingQueue=!1}}async function tryServerSideChainMatchingWithNewAPI(e){const n=getBaseURL(),o=e.replace(/\s+(italian\s+restaurant|restaurant|store|location|inc|llc|corp)$/i,"").trim();try{const a=await fetch(`${n}/api/chains.js?operation=find_match&place_name=${encodeURIComponent(o)}`);if(a.ok){const n=await a.json();if(n.success&&n.chain)return console.log(`âœ… SERVER MATCH (NEW API): "${e}" â†’ "${n.chain.chain_name}" (using "${o}")`),{_id:n.chain._id,bname:n.chain.chain_name,chain_name:n.chain.chain_name}}}catch(e){console.error(`âŒ Server matching failed (NEW API) for "${o}":`,e.message)}return console.log(`âŒ No server match (NEW API) for: ${e}`),null}function findMatchingChainLocallyEnhanced(e){return new Promise((n=>{try{if(!e)return void n(null);console.log("ðŸ  ENHANCED LOCAL (NEW API): Matching for:",e);const o=e.toLowerCase().trim();for(const[a,t]of Object.entries(COMPREHENSIVE_CHAIN_DATABASE_UPDATED))for(const a of t.variations)if(o.includes(a.toLowerCase())||a.toLowerCase().includes(o))return console.log(`ðŸŽ¯ ENHANCED LOCAL MATCH (NEW API): "${e}" â†’ "${t.canonicalName}"`),void n({_id:t.id,bname:t.canonicalName,chain_name:t.canonicalName,isLocalMatch:!0});console.log(`âŒ No enhanced local match for: ${e}`),n(null)}catch(e){console.error("âŒ Error in enhanced local matching:",e),n(null)}}))}async function tryServerSideChainMatchingOptimized(e){const n=getBaseURL(),o=e.replace(/\s+(italian\s+restaurant|restaurant|store|location|inc|llc|corp)$/i,"").trim();try{const a=await fetch(`${n}/api/chains.js?operation=find_match&place_name=${encodeURIComponent(o)}`);if(a.ok){const n=await a.json();if(n.success&&n.chain)return console.log(`âœ… SERVER CHAIN MATCH: "${e}" â†’ "${n.chain.chain_name}" (using "${o}")`),{_id:n.chain._id,bname:n.chain.chain_name,chain_name:n.chain.chain_name}}}catch(e){console.error(`âŒ Server chain matching failed for "${o}":`,e.message)}return console.log(`âŒ No server chain match for: ${e}`),null}function clearChainMatchCache(){chainMatchCache.clear(),console.log("ðŸ§¹ CACHE CLEARED: Chain match cache has been cleared")}function getChainMatchCacheStatus(){if(console.log("ðŸ“Š CACHE STATUS:"),console.log(`   - Total entries: ${chainMatchCache.size}`),console.log(`   - API queue length: ${apiCallQueue.length}`),console.log(`   - Processing queue: ${isProcessingQueue}`),chainMatchCache.size>0){console.log("   - Cached entries:");for(const[e,n]of chainMatchCache.entries())console.log(`     ${e} â†’ ${n?n.bname:"No match"}`)}}async function getApproximateLocation(){return{lat:39.8283,lng:-98.5795,source:"default-us-center"}}function showUserFriendlyError(e,n){const o=document.getElementById("business-search-results")||document.getElementById("search_table");if(!o)return;const a={location:"ðŸ“",geocoding:"ðŸ—ºï¸","no-results":"ðŸ”",critical:"âš ï¸",network:"ðŸŒ"}[e]||"âŒ";o.innerHTML=`\n        <div class="user-friendly-error">\n            <div class="error-icon">${a}</div>\n            <div class="error-message">${n}</div>\n            <div class="error-actions">\n                <button onclick="location.reload()" class="retry-btn">ðŸ”„ Try Again</button>\n                <button onclick="clearSearchForm()" class="clear-btn">ðŸ†• New Search</button>\n            </div>\n        </div>\n    `,o.style.display="block"}function showSearchSuccessMessage(e,n,o){const a=document.createElement("div");a.className="search-success-banner",a.innerHTML=`\n        <div class="success-content">\n            <span class="success-icon">âœ…</span>\n            <span class="success-text">\n                Found ${e+n} businesses\n                ${e>0?`(${e} in database`:""}\n                ${n>0?`${e>0?", ":"("}${n} nearby)`:e>0?")":""}\n            </span>\n            <button onclick="this.parentElement.parentElement.remove()" class="close-success">Ã—</button>\n        </div>\n    `;const t=document.querySelector("main")||document.body;t.insertBefore(a,t.firstChild),setTimeout((()=>{a.parentNode&&a.remove()}),5e3)}function clearSearchForm(){const e=document.getElementById("business-search-form");if(e){e.reset(),e.querySelectorAll("input").forEach((e=>{e.classList.remove("valid-field","invalid-field"),e.removeAttribute("data-valid")}));const n=document.getElementById("business-search-results")||document.getElementById("search_table");n&&(n.style.display="none"),clearMarkers(),map&&(map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom)),console.log("ðŸ†• FORM CLEARED: Search form and results cleared")}}function createDebugDashboard(){const e=document.getElementById("debug-dashboard");e&&e.remove();const n=document.createElement("div");n.id="debug-dashboard",n.style.cssText="\n        position: fixed;\n        top: 10px;\n        right: 10px;\n        background: rgba(0,0,0,0.9);\n        color: white;\n        padding: 15px;\n        border-radius: 8px;\n        z-index: 10000;\n        font-family: monospace;\n        font-size: 11px;\n        max-width: 350px;\n        max-height: 80vh;\n        overflow-y: auto;\n        box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n    ",n.innerHTML='\n        <h4 style="margin: 0 0 10px 0; color: #4CAF50; text-align: center;">ðŸ› ï¸ Debug Dashboard</h4>\n        \n        <div class="debug-section">\n            <h5 style="color: #2196F3; margin: 10px 0 5px 0;">ðŸ” Quick Tests</h5>\n            <button onclick="testSpecificSearch(\'Olive Garden\', false)" class="debug-btn">Test Olive Garden</button>\n            <button onclick="testSpecificSearch(\'The Home Depot\', true)" class="debug-btn">Test Home Depot + Location</button>\n            <button onclick="testSpecificSearch(\'McDonald\\\'s\', false)" class="debug-btn">Test McDonald\'s</button>\n        </div>\n\n        <div class="debug-section">\n            <h5 style="color: #FF9800; margin: 10px 0 5px 0;">ðŸ“Š System Status</h5>\n            <button onclick="debugBusinessSearch()" class="debug-btn">Full System Debug</button>\n            <button onclick="getChainMatchCacheStatus()" class="debug-btn">Cache Status</button>\n            <button onclick="checkMapMarkers()" class="debug-btn">Check Markers</button>\n        </div>\n\n        <div class="debug-section">\n            <h5 style="color: #9C27B0; margin: 10px 0 5px 0;">ðŸ§¹ Maintenance</h5>\n            <button onclick="clearChainMatchCache()" class="debug-btn">Clear Cache</button>\n            <button onclick="clearSearchForm()" class="debug-btn">Clear Form</button>\n            <button onclick="resetMapView()" class="debug-btn">Reset Map</button>\n        </div>\n\n        <div class="debug-section">\n            <h5 style="color: #F44336; margin: 10px 0 5px 0;">ðŸš¨ Emergency</h5>\n            <button onclick="emergencyReset()" class="debug-btn danger">Emergency Reset</button>\n            <button onclick="location.reload()" class="debug-btn danger">Reload Page</button>\n        </div>\n\n        <div id="debug-status" style="margin-top: 10px; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 10px;">\n            Ready for debugging\n        </div>\n\n        <button onclick="document.getElementById(\'debug-dashboard\').remove()" \n                style="position: absolute; top: 5px; right: 8px; background: none; border: none; color: #f44336; font-size: 16px; cursor: pointer;">Ã—</button>\n    ';const o=document.createElement("style");o.textContent="\n        .debug-btn {\n            display: block;\n            width: 100%;\n            margin: 2px 0;\n            padding: 6px 8px;\n            background: #333;\n            color: white;\n            border: 1px solid #555;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 10px;\n            transition: background 0.2s;\n        }\n        \n        .debug-btn:hover {\n            background: #555;\n        }\n        \n        .debug-btn.danger {\n            background: #d32f2f;\n            border-color: #b71c1c;\n        }\n        \n        .debug-btn.danger:hover {\n            background: #f44336;\n        }\n        \n        .debug-section {\n            margin-bottom: 10px;\n            padding-bottom: 8px;\n            border-bottom: 1px solid #333;\n        }\n        \n        .debug-section:last-child {\n            border-bottom: none;\n        }\n    ",document.head.appendChild(o),document.body.appendChild(n),console.log("ðŸ› ï¸ DEBUG DASHBOARD: Created comprehensive debugging dashboard")}function checkMapMarkers(){if(console.log("ðŸŽ¯ MARKER CHECK: Analyzing current markers..."),!markers||0===markers.length)return console.log("âŒ No markers found"),void updateDebugStatus("No markers on map");let e=0,n=0,o=0;markers.forEach(((a,t)=>{a.business?(a.business.isGooglePlace?n++:e++,console.log(`   ${t+1}. ${a.business.bname} (${a.business.isGooglePlace?"PLACES":"DATABASE"})`)):o++}));const a=`${markers.length} markers: ${e} database, ${n} places, ${o} invalid`;console.log(`ðŸ“Š MARKER SUMMARY: ${a}`),updateDebugStatus(a)}function emergencyReset(){console.log("ðŸš¨ EMERGENCY RESET: Performing complete system reset...");try{clearMarkers(),"function"==typeof clearChainMatchCache&&clearChainMatchCache(),clearSearchForm(),map&&(map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom)),infoWindow&&infoWindow.close(),document.querySelectorAll(".modal-backdrop").forEach((e=>e.remove())),document.body.classList.remove("modal-open"),document.body.style.paddingRight="",document.body.style.overflow="",document.querySelectorAll(".error-message, .user-friendly-error, .loading-indicator").forEach((e=>e.remove())),console.log("âœ… EMERGENCY RESET: System reset completed"),updateDebugStatus("Emergency reset completed")}catch(e){console.error("âŒ EMERGENCY RESET FAILED:",e),updateDebugStatus("Emergency reset failed - try page reload")}}function updateDebugStatus(e){const n=document.getElementById("debug-status");n&&(n.textContent=`${(new Date).toLocaleTimeString()}: ${e}`)}function addEnhancedUserInterfaceCSS(){if(!document.getElementById("enhanced-ui-css")){const e=document.createElement("style");e.id="enhanced-ui-css",e.textContent="\n            /* User-friendly error messages */\n            .user-friendly-error {\n                text-align: center;\n                padding: 40px 20px;\n                background: linear-gradient(135deg, #fff3e0 0%, #ffccbc 100%);\n                border-radius: 12px;\n                margin: 20px;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n            }\n\n            .error-icon {\n                font-size: 48px;\n                margin-bottom: 16px;\n            }\n\n            .error-message {\n                font-size: 16px;\n                color: #333;\n                margin-bottom: 20px;\n                line-height: 1.5;\n            }\n\n            .error-actions {\n                display: flex;\n                gap: 10px;\n                justify-content: center;\n                flex-wrap: wrap;\n            }\n\n            .retry-btn, .clear-btn {\n                padding: 10px 20px;\n                border: none;\n                border-radius: 6px;\n                cursor: pointer;\n                font-weight: 500;\n                transition: all 0.2s;\n            }\n\n            .retry-btn {\n                background: #4CAF50;\n                color: white;\n            }\n\n            .retry-btn:hover {\n                background: #45a049;\n                transform: translateY(-1px);\n            }\n\n            .clear-btn {\n                background: #2196F3;\n                color: white;\n            }\n\n            .clear-btn:hover {\n                background: #1976D2;\n                transform: translateY(-1px);\n            }\n\n            /* Success banner */\n            .search-success-banner {\n                background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);\n                border: 1px solid #4caf50;\n                border-radius: 8px;\n                margin: 10px 0;\n                animation: slideInFromTop 0.5s ease-out;\n            }\n\n            .success-content {\n                display: flex;\n                align-items: center;\n                padding: 12px 16px;\n                gap: 10px;\n            }\n\n            .success-icon {\n                font-size: 18px;\n            }\n\n            .success-text {\n                flex: 1;\n                color: #2e7d32;\n                font-weight: 500;\n            }\n\n            .close-success {\n                background: none;\n                border: none;\n                font-size: 18px;\n                color: #2e7d32;\n                cursor: pointer;\n                padding: 0;\n                width: 24px;\n                height: 24px;\n            }\n\n            .close-success:hover {\n                background: rgba(76, 175, 80, 0.1);\n                border-radius: 50%;\n            }\n\n            @keyframes slideInFromTop {\n                from {\n                    opacity: 0;\n                    transform: translateY(-20px);\n                }\n                to {\n                    opacity: 1;\n                    transform: translateY(0);\n                }\n            }\n\n            /* Enhanced loading indicator */\n            .loading-indicator {\n                text-align: center;\n                padding: 40px 20px;\n                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);\n                border-radius: 12px;\n                margin: 20px;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n            }\n\n            .loading-text {\n                font-size: 18px;\n                color: #333;\n                margin-bottom: 20px;\n                font-weight: 500;\n            }\n\n            .loading-spinner {\n                width: 40px;\n                height: 40px;\n                border: 4px solid #e3f2fd;\n                border-top: 4px solid #2196f3;\n                border-radius: 50%;\n                animation: spin 1s linear infinite;\n                margin: 0 auto;\n            }\n        ",document.head.appendChild(e)}}async function retrieveFromMongoDBWithNearbyDetection(e,n=!1){try{console.log("ðŸ” ENHANCED SEARCH: Starting search with nearby database detection:",e);const o=document.getElementById("business-search-results")||document.getElementById("search_table");o&&(o.innerHTML='<div class="loading-indicator" id="main-loading"><div class="loading-text">Searching for businesses...</div><div class="loading-spinner"></div></div>',o.style.display="block");let a=null,t=25;if(e.useMyLocation)try{updateLoadingMessage("Getting your location..."),a=await getUserLocation(),window.currentSearchLocation=a}catch(e){return console.error("âŒ Error getting user location:",e),hideLoadingIndicator(),void alert("Unable to get your current location. Please try entering an address instead.")}else if(e.address&&""!==e.address.trim())try{updateLoadingMessage("Finding location...");const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw new Error(`Geocoding failed for address: ${e.address}`);if(a=n,window.currentSearchLocation=a,/^\d{5}$/.test(e.address.trim())?(t=15,console.log("ðŸ“ ZIP CODE SEARCH: Using 15km radius")):(e.address.toLowerCase().includes("city")||e.address.split(",").length>=2)&&(t=20,console.log("ðŸ“ CITY SEARCH: Using 20km radius")),map&&a){const e=new google.maps.LatLng(a.lat,a.lng);map.setCenter(e),map.setZoom(t<=15?12:11)}}catch(e){return console.error("âŒ Error geocoding address:",e),hideLoadingIndicator(),void alert("We couldn't recognize that address. Please try a more specific address.")}updateLoadingMessage("Searching database...");let i=[];if(e.businessName&&""!==e.businessName.trim())try{i=await searchDatabaseWithFuzzyMatching(e,a,n),i=i.filter((e=>!0!==e.is_chain)),console.log(`ðŸ“Š PRIMARY RESULTS: Found ${i.length} businesses for "${e.businessName}"`)}catch(e){console.error("âŒ Primary search failed:",e)}let s=[];if(a)try{updateLoadingMessage("Finding nearby businesses in database..."),s=await searchNearbyDatabaseBusinesses(a,t,e.businessName),console.log(`ðŸ“Š NEARBY DATABASE: Found ${s.length} nearby database businesses`)}catch(e){console.error("âŒ Nearby database search failed:",e)}let r=[];if(e.businessName&&a)try{updateLoadingMessage("Searching Google Places..."),r=await searchGooglePlacesForBusinessFixed(e.businessName,a),console.log(`ðŸ“Š PLACES RESULTS: Found ${r.length} Google Places businesses`)}catch(e){console.error("âŒ Places search failed:",e)}const{finalPrimaryResults:c,finalNearbyResults:l,finalPlacesResults:d}=categorizeFinalResults(i,s,r),g=[...c,...l,...d];console.log("ðŸ“Š FINAL CATEGORIZATION:"),console.log(`   - Primary (RED): ${c.length} businesses`),console.log(`   - Nearby Database (GREEN): ${l.length} businesses`),console.log(`   - Google Places (BLUE): ${d.length} businesses`),console.log(`   - Total: ${g.length} businesses`),g.length>0?(c.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!0,e.markerColor="primary"})),l.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!1,e.isNearbyDatabase=!0,e.markerColor="database"})),d.forEach((e=>{e.isGooglePlace=!0,e.isFromDatabase=!1,e.isPrimaryResult=!1,e.markerColor="nearby"})),hideLoadingIndicator(),displayBusinessesOnMapWithCategories(g),displaySearchResultsWithCategories(g),showEnhancedSearchSuccessMessage(c.length,l.length,d.length),console.log("âœ… ENHANCED SEARCH: Completed successfully with nearby detection")):(hideLoadingIndicator(),showNoResultsMessage())}catch(e){console.error("âŒ Enhanced search error:",e),hideLoadingIndicator(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}async function searchNearbyDatabaseBusinesses(e,n,o=""){try{const a=`${getBaseURL()}/api/business.js?${new URLSearchParams({operation:"search",lat:e.lat,lng:e.lng,radius:n,limit:50}).toString()}`;console.log(`ðŸŒ NEARBY DATABASE SEARCH: ${a}`);const t=await fetch(a);if(!t.ok)throw new Error(`Nearby search failed: ${t.status}`);let i=(await t.json()).results||[];return i=i.filter((e=>!(!0===e.is_chain||o&&e.bname.toLowerCase().includes(o.toLowerCase())&&(console.log(`ðŸš« EXCLUDING PRIMARY MATCH: ${e.bname} (matches "${o}")`),1)))),console.log(`âœ… NEARBY DATABASE FILTER: ${i.length} nearby businesses after filtering`),i}catch(e){return console.error("âŒ Error searching nearby database businesses:",e),[]}}function categorizeFinalResults(e,n,o){console.log("ðŸ”„ CATEGORIZING RESULTS:");const a=[...e],t=new Set,i=new Set;return a.forEach((e=>{const n=createAddressKey(e),o=e.bname.toLowerCase().trim();t.add(n),i.add(o),console.log(`ðŸ”´ PRIMARY: ${e.bname} at ${n}`)})),{finalPrimaryResults:a,finalNearbyResults:n.filter((e=>{const n=createAddressKey(e),o=e.bname.toLowerCase().trim();return t.has(n)||i.has(o)?(console.log(`ðŸš« NEARBY DUPLICATE: ${e.bname} (already in primary results)`),!1):(t.add(n),i.add(o),console.log(`ðŸŸ¢ NEARBY DB: ${e.bname} at ${n}`),!0)})),finalPlacesResults:o.filter((e=>{const n=createAddressKey(e),o=e.bname.toLowerCase().trim();return t.has(n)||i.has(o)?(console.log(`ðŸš« PLACES DUPLICATE: ${e.bname} (already in database)`),!1):(console.log(`ðŸ”µ PLACES: ${e.bname} at ${n}`),!0)}))}}function createAddressKey(e){const n=[];return e.address1&&n.push(e.address1.toLowerCase().trim()),e.city&&n.push(e.city.toLowerCase().trim()),e.state&&n.push(e.state.toLowerCase().trim()),e.zip&&n.push(e.zip.trim()),n.join("|")}async function createEnhancedBusinessMarkerWithCategory(e,n){try{return console.log(`ðŸŽ¯ CATEGORY MARKER: Creating for ${e.bname} with category ${e.markerColor}`),isSafariOrIOS?(console.log(`ðŸ“± Safari detected - using stable marker for ${e.bname}`),createStableSafariMarker(e,n,"primary"===e.markerColor||"database"===e.markerColor||!0===e.isFromDatabase)):createEnhancedBusinessMarkerFixed(e,n,e.isFromDatabase||"primary"===e.markerColor||"database"===e.markerColor)}catch(o){return console.error("âŒ Error creating category marker:",o),createStableSafariMarker(e,n,"primary"===e.markerColor||"database"===e.markerColor)}}function showEnhancedInfoWindowWithCategory(e){if(console.log("ðŸªŸ CATEGORY INFO WINDOW: Showing for:",e.business?.bname),!e||!e.business)return void console.error("âŒ Invalid marker for category info window");const n=e.business,o=!0===n.isGooglePlace,a=!!n.chain_id,t=!0===n.isFromDatabase;n.isNearbyDatabase,n.isPrimaryResult,infoWindow&&infoWindow.close(),infoWindow=new google.maps.InfoWindow({maxWidth:320,disableAutoPan:!1});const i=buildCategoryAwareInfoWindowContent(n);infoWindow.setContent(i);let s=e.position;if(!s&&e.getPosition&&(s=e.getPosition()),s||(s=createSafeLatLng(n)),s){try{map.panTo(s)}catch(e){console.warn("âš ï¸ Error panning to position:",e)}setTimeout((()=>{try{e.getPosition?infoWindow.open(map,e):(infoWindow.setPosition(s),infoWindow.open(map)),console.log("âœ… Category info window opened successfully"),google.maps.event.addListenerOnce(infoWindow,"domready",(function(){setTimeout((()=>{applyEnhancedInfoWindowFixes();const e=o?`google_${n.placeId}`:n._id;console.log(`ðŸŽ CATEGORY INCENTIVES: Loading for ${e} (${n.markerColor})`),t&&a?loadChainIncentivesForDatabaseBusinessFixed(e,n.chain_id):t?loadIncentivesForEnhancedWindowFixed(e):o&&a&&loadChainIncentivesForEnhancedWindowFixed(e,n.chain_id)}),300)}))}catch(e){console.error("âŒ Error opening category info window:",e)}}),200)}else console.error("âŒ Could not determine position for category info window")}function buildCategoryAwareInfoWindowContent(e){const n=!0===e.isGooglePlace,o=!!e.chain_id,a=!0===e.isFromDatabase,t=!0===e.isNearbyDatabase,i=!0===e.isPrimaryResult;let s="";if(e.address1){s=`<div class="info-address">\n            <strong>ðŸ“ Address:</strong><br>\n            ${e.address1}`,e.address2&&(s+=`<br>${e.address2}`);const n=[];e.city&&n.push(e.city),e.state&&n.push(e.state),e.zip&&n.push(e.zip),n.length>0&&(s+=`<br>${n.join(", ")}`),s+="</div>"}else if(e.formattedAddress){const n=e.formattedAddress.split(",").map((e=>e.trim()));s='<div class="info-address">\n            <strong>ðŸ“ Address:</strong><br>',n.length>=1&&(s+=n[0]),n.length>=2&&(s+=`<br>${n.slice(1).join(", ")}`),s+="</div>"}const r=e.phone?`<div class="info-phone"><strong>ðŸ“ž Phone:</strong> <a href="tel:${e.phone.replace(/\D/g,"")}" style="color: #4285F4; text-decoration: none;">${e.phone}</a></div>`:"";let c="";e.type&&"OTHER"!==e.type&&(c=`<div class="info-type"><strong>ðŸ¢ Type:</strong> ${getBusinessTypeLabel(e.type)}</div>`);const l=e.distance?`<div class="info-distance"><strong>ðŸ“ Distance:</strong> ${(e.distance/1609).toFixed(1)} miles</div>`:"";let d="";o&&(d=`<span class="enhanced-chain-badge" style="background-color: ${i?"rgb(66, 133, 244, 0.3)":t?"rgb(40, 167, 69, 0.3)":"rgb(66, 133, 244, 0.3)"};">ðŸ”— ${e.chain_name||"Chain Location"}</span>`);let g,u="",h="";i?u='<div class="info-status primary-result">ðŸŽ¯ This business matches your search and is in the Patriot Thanks database.</div>':t?(u='<div class="info-status nearby-database">ðŸ¢ This business is in the Patriot Thanks database (found nearby).</div>',h='<div class="nearby-explanation">ðŸ’¡ This business appeared because it\'s in your search area and already in our database.</div>'):n&&o?(u='<div class="info-status chain-match">ðŸ”— This location appears to match a chain in our database!</div>',h=`<div class="chain-explanation">\n            âœ¨ Great news! This location matches <strong>${e.chain_name}</strong> in our database. \n            Chain-wide incentives should apply to this location once added.\n        </div>`):n&&(u='<div class="info-status google-place">â„¹ï¸ This business is not yet in the Patriot Thanks database.</div>'),a?g=`\n            <button class="enhanced-view-btn" onclick="window.viewBusinessDetails('${e._id}')">\n                ðŸ‘ï¸ View Details\n            </button>\n        `:n&&o?g=`\n            <button class="enhanced-add-btn chain-add" onclick="window.addBusinessToDatabase('${e.placeId}', '${e.chain_id}')">\n                ðŸ”— Add ${e.chain_name} Location\n            </button>\n        `:n&&(g=`\n            <button class="enhanced-add-btn" onclick="window.addBusinessToDatabase('${e.placeId}')">\n                âž• Add to Patriot Thanks\n            </button>\n        `);const p=n?`google_${e.placeId}`:e._id;let m;return m=a&&o?"<em>â³ Loading chain incentives...</em>":a?"<em>â³ Loading incentives...</em>":n&&o?"<em>â³ Loading chain incentives...</em>":"<em>ðŸ’¡ Add this business to see available incentives.</em>",`\n        <div class="enhanced-info-window category-aware">\n            <div class="info-header">\n                <h3>${e.bname} ${d}</h3>\n            </div>\n            \n            <div class="info-body">\n                ${s}\n                ${r}\n                ${c}\n                ${l}\n                ${u}\n                ${h}\n                \n                <div class="info-incentives">\n                    <div id="incentives-container-${p}">\n                        ${m}\n                    </div>\n                </div>\n            </div>\n            \n            <div class="info-actions">\n                ${g}\n            </div>\n        </div>\n    `}function displayBusinessesOnMapWithCategories(e){if(!map)return console.log("â³ Map not ready, storing businesses for later display"),void(pendingBusinessesToDisplay=e);console.log(`ðŸ—ºï¸ CATEGORIZED DISPLAY: Displaying ${e.length} businesses on map`),clearMarkers(),bounds=new google.maps.LatLngBounds;let n=0,o=0,a=0,t=0;e.forEach(((i,s)=>{try{if(console.log(`ðŸ”„ Processing business ${s+1}/${e.length}: ${i.bname} (${i.markerColor||"unknown"})`),!0===i.is_chain)return console.log(`ðŸš« Skipping parent chain business: ${i.bname}`),void t++;const r=getBusinessLocation(i);if(!r)return console.warn(`âŒ Business ${i.bname} missing coordinates`),void t++;if(i.lat=r.lat,i.lng=r.lng,createCategorizedBusinessMarker(i)){switch(i.markerColor){case"primary":n++;break;case"database":o++;break;default:a++}console.log(`âœ… Created ${i.markerColor} marker for ${i.bname}`);const e=new google.maps.LatLng(r.lat,r.lng);bounds.extend(e)}else console.error(`âŒ Failed to create marker for ${i.bname}`),t++}catch(e){console.error(`âŒ Error processing business ${i.bname}:`,e),t++}})),console.log("ðŸ“Š CATEGORIZED MARKER SUMMARY:"),console.log(`   - ðŸ”´ Primary (RED): ${n} markers`),console.log(`   - ðŸŸ¢ Nearby Database (GREEN): ${o} markers`),console.log(`   - ðŸ”µ Google Places (BLUE): ${a} markers`),console.log(`   - âŒ Skipped: ${t} businesses`),console.log(`   - âœ… Total Created: ${n+o+a} markers`),setTimeout((()=>{try{if(window.currentSearchLocation&&(n>0||o>0)){console.log("ðŸ“ Centering map on search location with results");const e=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng);map.setCenter(e),map.setZoom(12)}else n+o+a>0&&bounds&&!bounds.isEmpty()?(console.log("ðŸŽ¯ Fitting map to all business bounds"),safelyFitBounds(map,bounds)):(console.log("ðŸŒŽ Using default map center"),map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom))}catch(e){console.error("âŒ Error updating map view:",e)}}),200)}function createCategorizedBusinessMarker(e){try{if(!e.lat||!e.lng||isNaN(parseFloat(e.lat))||isNaN(parseFloat(e.lng)))return console.warn(`âŒ Invalid coordinates for business: ${e.bname}`),null;const n=new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng));return isSafariOrIOS?createStableSafariMarker(e,n,"primary"===e.markerColor||"database"===e.markerColor):createEnhancedBusinessMarkerWithCategory(e,n)}catch(e){return console.error("âŒ Error creating categorized marker:",e),null}}function debugMarkerStability(){if(console.log("ðŸ” MARKER STABILITY DEBUG:"),console.log("   Platform: "+(isSafariOrIOS?"Safari/iOS (using stable markers)":"Other (using advanced markers)")),!markers||0===markers.length)return void console.log("âŒ No markers found");let e=0,n=0,o=0,a=0;markers.forEach(((t,i)=>{if(!t.business)return void a++;let s="Unknown";t.isSafariStableMarker?(e++,s="Safari Stable"):t.isBasicSafariMarker?(o++,s="Basic Safari"):t.isAdvancedMarker?(n++,s="Advanced"):a++,console.log(`   ${i+1}. ${t.business.bname} - ${s}`)})),console.log("ðŸ“Š STABILITY SUMMARY:"),console.log(`   - Safari Stable: ${e}`),console.log(`   - Advanced: ${n}`),console.log(`   - Basic Safari: ${o}`),console.log(`   - Unknown: ${a}`),isSafariOrIOS&&n>0&&console.warn("âš ï¸ Advanced markers detected on Safari - these may flicker!")}function initializeStableMarkerSystem(){if(console.log("ðŸ”§ Initializing stable marker system for "+(isSafariOrIOS?"Safari/iOS":"other browsers")),window.debugMarkerStability=debugMarkerStability,isSafariOrIOS){console.log("ðŸ“± Safari/iOS detected - using stable marker system to prevent flickering");const e=document.createElement("style");e.textContent='\n            /* Safari marker stability improvements */\n            .gm-style img {\n                max-width: none !important;\n                image-rendering: -webkit-optimize-contrast !important;\n            }\n            \n            /* Prevent Safari from reprocessing marker images */\n            .gm-style div[style*="position: absolute"] img {\n                will-change: auto !important;\n                transform: translateZ(0) !important;\n                -webkit-transform: translateZ(0) !important;\n            }\n        ',document.head.appendChild(e)}console.log("âœ… Stable marker system initialized")}function displaySearchResultsWithCategories(e){try{console.log(`ðŸ“‹ CATEGORIZED RESULTS: Displaying ${e.length} businesses in table`),hideLoadingIndicator();const n=document.getElementById("business_search"),o=document.getElementById("search_table");if(!n||!o)return console.error("âŒ Required table elements not found in the DOM"),void showErrorMessage("There was an error displaying search results. Please try again later.");let a=n.querySelector("tbody");if(!a)return console.error("âŒ Table body not found"),void showErrorMessage("There was an error displaying search results. Please try again later.");a.innerHTML="",o.style.display="block";const t=o.querySelector("h5");if(t&&(t.style.display="none"),0===e.length)return a.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria.</td></tr>',void o.scrollIntoView({behavior:"smooth"});const i=e.filter((e=>"primary"===e.markerColor)),s=e.filter((e=>"database"===e.markerColor)),r=e.filter((e=>"nearby"===e.markerColor));console.log("ðŸ“Š TABLE CATEGORIES:"),console.log(`   - Primary Results: ${i.length}`),console.log(`   - Nearby Database: ${s.length}`),console.log(`   - Google Places: ${r.length}`);let c=0;i.length>0&&(addTableSectionHeader(a,`ðŸŽ¯ Search Results (${i.length})`,"primary-section"),i.forEach(((e,n)=>{console.log(`ðŸ“ Adding primary business ${n+1}: ${e.bname}`),addCategorizedBusinessRow(e,a,"primary"),c++}))),s.length>0&&(addTableSectionHeader(a,`ðŸ¢ Nearby Businesses in Database (${s.length})`,"database-section"),s.forEach(((e,n)=>{console.log(`ðŸ“ Adding nearby database business ${n+1}: ${e.bname}`),addCategorizedBusinessRow(e,a,"database"),c++}))),r.length>0&&(addTableSectionHeader(a,`ðŸŒ Additional Locations Found (${r.length})`,"places-section"),r.forEach(((e,n)=>{console.log(`ðŸ“ Adding Google Places business ${n+1}: ${e.bname}`),addCategorizedBusinessRow(e,a,"places"),c++}))),o.scrollIntoView({behavior:"smooth"}),console.log(`âœ… Categorized search results displayed: ${c} total rows`)}catch(e){console.error("âŒ Error displaying categorized search results:",e),hideLoadingIndicator(),showErrorMessage("There was an error displaying the search results: "+e.message)}}function addTableSectionHeader(e,n,o){const a=document.createElement("tr");a.className=`section-header ${o}`,a.innerHTML=`\n        <td colspan="5" class="section-header-cell">\n            <strong>${n}</strong>\n        </td>\n    `,e.appendChild(a)}function addCategorizedBusinessRowEnhanced(e,n,o){if(!e)return;if(!0===e.is_chain)return void console.log(`â­ï¸ Skipping parent chain business in table: ${e.bname}`);console.log(`ðŸ“ Adding categorized table row: ${e.bname} (${o})`);let a="";if(e.address1)a=e.address2?`${e.address1}<br>${e.address2}<br>${e.city}, ${e.state} ${e.zip}`:`${e.address1}<br>${e.city}, ${e.state} ${e.zip}`;else{if(!e.formattedAddress)return void console.warn(`âŒ Business ${e.bname} has no address information`);a=e.formattedAddress.replace(/,/g,"<br>")}const t=getBusinessTypeLabel(e.type);let i="",s="";switch(o){case"primary":i='<span class="category-badge primary-badge">ðŸŽ¯ Search Result</span>',s="primary-result-row";break;case"database":i='<span class="category-badge database-badge">ðŸ¢ In Database</span>',s="database-result-row";break;case"places":i='<span class="category-badge places-badge">ðŸŒ Found Nearby</span>',s="places-result-row"}const r=e.chain_id?'<span class="chain-badge">ðŸ”— Chain Location</span>':"";let c;if("primary"===o||"database"===o)c=`<button class="view-map-btn ${o}" onclick="focusOnMapMarker('${e._id}')">ðŸ“ View on Map</button>`;else{const n=e._id||e.placeId;let o=e.chain_id?"ðŸ”— Add Chain Location":"âž• Add to Database",a=e.chain_id?`addBusinessToDatabase('${e.placeId}', '${e.chain_id}')`:`addBusinessToDatabase('${e.placeId}')`;c=`\n            <div class="dual-action-buttons">\n                <button class="view-map-btn places" onclick="focusOnGooglePlacesMarker('${n}')">ðŸ“ View on Map</button>\n                <button class="add-to-db-btn ${e.chain_id?"chain":""}" onclick="${a}">${o}</button>\n            </div>\n        `}const l=document.createElement("tr");l.className=`business-row ${s}`,l.innerHTML=`\n        <th class="left_table" data-business-id="${e._id}">\n            ${e.bname} ${r}\n            <div class="category-badges">${i}</div>\n        </th>\n        <th class="left_table">${a}</th>\n        <th class="left_table">${t}</th>\n        <th class="right_table" id="incentives-for-${e._id}">\n            ${"primary"===o||"database"===o?'<span class="loading-incentives">Loading incentives...</span>':"Not in database yet"}\n        </th>\n        <th class="center_table">${c}</th>\n    `,n.appendChild(l),"primary"===o||"database"===o?(console.log(`ðŸŽ Scheduling incentives load for ${o} business: ${e.bname} (ID: ${e._id})`),setTimeout((()=>{fetchBusinessIncentivesFixed(e._id,e.chain_id)}),100)):"places"===o&&e.chain_id&&(console.log(`ðŸ”— Scheduling chain incentives load for Places business: ${e.bname}`),fetchChainIncentivesForPlacesResult(e._id,e.chain_id))}function buildCategoryAwareInfoWindowContentEnhanced(e){const n=!0===e.isGooglePlace,o=!!e.chain_id,a=!0===e.isFromDatabase,t=!0===e.isNearbyDatabase,i=!0===e.isPrimaryResult;let s="";if(e.address1){s=`<div class="info-address">\n            <strong>ðŸ“ Address:</strong><br>\n            ${e.address1}`,e.address2&&(s+=`<br>${e.address2}`);const n=[];e.city&&n.push(e.city),e.state&&n.push(e.state),e.zip&&n.push(e.zip),n.length>0&&(s+=`<br>${n.join(", ")}`),s+="</div>"}else if(e.formattedAddress){const n=e.formattedAddress.split(",").map((e=>e.trim()));s='<div class="info-address">\n            <strong>ðŸ“ Address:</strong><br>',n.length>=1&&(s+=n[0]),n.length>=2&&(s+=`<br>${n.slice(1).join(", ")}`),s+="</div>"}const r=e.phone?`<div class="info-phone"><strong>ðŸ“ž Phone:</strong> <a href="tel:${e.phone.replace(/\D/g,"")}" style="color: #4285F4; text-decoration: none;">${e.phone}</a></div>`:"";let c="";e.type&&"OTHER"!==e.type&&(c=`<div class="info-type"><strong>ðŸ¢ Type:</strong> ${getBusinessTypeLabel(e.type)}</div>`);const l=e.distance?`<div class="info-distance"><strong>ðŸ“ Distance:</strong> ${(e.distance/1609).toFixed(1)} miles</div>`:"";let d="";o&&(d=`<span class="enhanced-chain-badge" style="background-color: ${i?"rgb(66, 133, 244, 0.3)":t?"rgb(40, 167, 69, 0.3)":"rgb(66, 133, 244, 0.3)"};">ðŸ”— ${e.chain_name||"Chain Location"}</span>`);let g,u="",h="";i?u='<div class="info-status primary-result">ðŸŽ¯ This business matches your search and is in the Patriot Thanks database.</div>':t?(u='<div class="info-status nearby-database">ðŸ¢ This business is in the Patriot Thanks database (found nearby).</div>',h='<div class="nearby-explanation">ðŸ’¡ This business appeared because it\'s in your search area and already in our database.</div>'):n&&o?(u='<div class="info-status chain-match">ðŸ”— This location appears to match a chain in our database!</div>',h=`<div class="chain-explanation">\n            âœ¨ Great news! This location matches <strong>${e.chain_name}</strong> in our database. \n            Chain-wide incentives should apply to this location once added.\n        </div>`):n&&(u='<div class="info-status google-place">â„¹ï¸ This business is not yet in the Patriot Thanks database.</div>'),a?g='\n            <div class="info-note">\n                <em>â„¹ï¸ This business is already in the Patriot Thanks database. Click anywhere outside to close.</em>\n            </div>\n        ':n&&o?g=`\n            <button class="enhanced-add-btn chain-add" onclick="window.addBusinessToDatabase('${e.placeId}', '${e.chain_id}')">\n                ðŸ”— Add ${e.chain_name} Location\n            </button>\n        `:n&&(g=`\n            <button class="enhanced-add-btn" onclick="window.addBusinessToDatabase('${e.placeId}')">\n                âž• Add to Patriot Thanks\n            </button>\n        `);const p=n?`google_${e.placeId}`:e._id;let m;return m=a&&o?"<em>â³ Loading chain incentives...</em>":a?"<em>â³ Loading incentives...</em>":n&&o?"<em>â³ Loading chain incentives...</em>":"<em>ðŸ’¡ Add this business to see available incentives.</em>",`\n        <div class="enhanced-info-window category-aware">\n            <div class="info-header">\n                <h3>${e.bname} ${d}</h3>\n            </div>\n            \n            <div class="info-body">\n                ${s}\n                ${r}\n                ${c}\n                ${l}\n                ${u}\n                ${h}\n                \n                <div class="info-incentives">\n                    <div id="incentives-container-${p}">\n                        ${m}\n                    </div>\n                </div>\n            </div>\n            \n            <div class="info-actions">\n                ${g}\n            </div>\n        </div>\n    `}function addDualActionButtonStyles(){if(!document.getElementById("dual-action-button-styles")){const e=document.createElement("style");e.id="dual-action-button-styles",e.textContent="\n            /* Dual action button container */\n            .dual-action-buttons {\n                display: flex;\n                flex-direction: column;\n                gap: 5px;\n                align-items: center;\n            }\n\n            /* Button styling for dual actions */\n            .dual-action-buttons .view-map-btn,\n            .dual-action-buttons .add-to-db-btn {\n                width: 100%;\n                max-width: 160px;\n                padding: 6px 10px;\n                border: none;\n                border-radius: 4px;\n                cursor: pointer;\n                font-size: 11px;\n                font-weight: 500;\n                text-align: center;\n                transition: all 0.2s ease;\n            }\n\n            /* View on Map button styling */\n            .dual-action-buttons .view-map-btn {\n                background: linear-gradient(45deg, #2196F3, #64B5F6);\n                color: white;\n                border: 1px solid #1976D2;\n            }\n\n            .dual-action-buttons .view-map-btn:hover {\n                background: linear-gradient(45deg, #1976D2, #42A5F5);\n                transform: translateY(-1px);\n                box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n            }\n\n            /* Add to Database button styling */\n            .dual-action-buttons .add-to-db-btn {\n                background: linear-gradient(45deg, #4CAF50, #81C784);\n                color: white;\n                border: 1px solid #388E3C;\n            }\n\n            .dual-action-buttons .add-to-db-btn.chain {\n                background: linear-gradient(45deg, #FF9800, #FFB74D);\n                border-color: #F57C00;\n            }\n\n            .dual-action-buttons .add-to-db-btn:hover {\n                background: linear-gradient(45deg, #388E3C, #66BB6A);\n                transform: translateY(-1px);\n                box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n            }\n\n            .dual-action-buttons .add-to-db-btn.chain:hover {\n                background: linear-gradient(45deg, #F57C00, #FFA726);\n            }\n\n            /* Responsive adjustments */\n            @media (max-width: 768px) {\n                .dual-action-buttons {\n                    gap: 3px;\n                }\n                \n                .dual-action-buttons .view-map-btn,\n                .dual-action-buttons .add-to-db-btn {\n                    font-size: 10px;\n                    padding: 5px 8px;\n                }\n            }\n\n            /* Info window note styling */\n            .info-note {\n                padding: 8px;\n                background-color: #E3F2FD;\n                border-radius: 4px;\n                text-align: center;\n                font-style: italic;\n                color: #1565C0;\n                border: 1px solid #BBDEFB;\n            }\n        ",document.head.appendChild(e)}}function showEnhancedSearchSuccessMessage(e,n,o){const a=document.createElement("div");a.className="enhanced-search-success-banner";let t=`Found ${e+n+o} businesses: `;const i=[];e>0&&i.push(`<span class="success-primary">${e} search result${1!==e?"s":""}</span>`),n>0&&i.push(`<span class="success-database">${n} nearby database business${1!==n?"es":""}</span>`),o>0&&i.push(`<span class="success-places">${o} additional location${1!==o?"s":""}</span>`),t+=i.join(", "),a.innerHTML=`\n        <div class="enhanced-success-content">\n            <span class="success-icon">âœ…</span>\n            <span class="success-text">${t}</span>\n            <button onclick="this.parentElement.parentElement.remove()" class="close-success">Ã—</button>\n        </div>\n        <div class="success-legend">\n            <span class="legend-item"><span class="legend-dot red"></span>Search Results</span>\n            <span class="legend-item"><span class="legend-dot green"></span>Nearby Database</span>\n            <span class="legend-item"><span class="legend-dot blue"></span>Additional Locations</span>\n        </div>\n    `;const s=document.querySelector("main")||document.body;s.insertBefore(a,s.firstChild),setTimeout((()=>{a.parentNode&&a.remove()}),8e3)}function updateMapLegendWithCategories(){const e=document.getElementById("map-container");if(!e)return;const n=e.querySelector(".map-legend");n&&n.remove();const o=document.createElement("div");o.className="map-legend enhanced-legend",o.innerHTML='\n        <div class="legend-item">\n            <div class="legend-color primary"></div>\n            <span>Primary Search Results</span>\n        </div>\n        <div class="legend-item">\n            <div class="legend-color database"></div>\n            <span>Nearby Database Businesses</span>\n        </div>\n        <div class="legend-item">\n            <div class="legend-color nearby"></div>\n            <span>Additional Locations Found</span>\n        </div>\n    ',e.appendChild(o)}function testCategorizedSearch(e,n){console.log(`ðŸ§ª TESTING CATEGORIZED SEARCH: "${e}" in ${n||"current area"}`);const o={businessName:e||"",address:n||"",useMyLocation:!n};console.log("ðŸ“ Test form data:",o),clearMarkers(),retrieveFromMongoDBWithNearbyDetection(o).then((()=>{console.log("âœ… Categorized search test completed"),setTimeout((()=>{updateMapLegendWithCategories()}),1e3)})).catch((e=>{console.error("âŒ Categorized search test failed:",e)}))}async function searchGooglePlacesForBusinessWithRadius(e,n){try{console.log("ðŸ” ENHANCED PLACES SEARCH: Searching for:",e,"near",n);const{Place:o}=await google.maps.importLibrary("places"),a=new google.maps.LatLng(n.lat,n.lng),t=1e3*(n.searchRadius||35),i={textQuery:e,locationBias:{center:a,radius:t},maxResultCount:20,fields:["id","displayName","formattedAddress","location","types","nationalPhoneNumber","internationalPhoneNumber"]};console.log(`ðŸŒ Enhanced Places API request with ${t/1e3}km radius:`,i);const{places:s}=await o.searchByText(i);if(!s||0===s.length)return console.log("âŒ No businesses found via enhanced Places API"),[];console.log(`âœ… Found ${s.length} businesses via enhanced Places API`);const r=s.map((async e=>{const o=e.formattedAddress?e.formattedAddress.split(","):[];let t="",i="",s="",r="";if(o.length>=1&&(t=o[0].trim()),o.length>=2&&(i=o[1].trim()),o.length>=3){const e=o[2].trim().match(/^([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/);e&&(s=e[1],r=e[2])}const c=e.location,l=google.maps.geometry.spherical.computeDistanceBetween(a,c);let d=0,g=0;if(e.location)try{d="function"==typeof e.location.lat?e.location.lat():e.location.lat||0,g="function"==typeof e.location.lng?e.location.lng():e.location.lng||0}catch(e){console.warn("âš ï¸ Error extracting coordinates:",e),d=n.lat,g=n.lng}const u={_id:"google_"+e.id,bname:e.displayName,address1:t,city:i,state:s,zip:r,formattedAddress:e.formattedAddress,type:mapGooglePlaceTypeToBusinessType(e.types),phone:e.nationalPhoneNumber||e.internationalPhoneNumber||"",isGooglePlace:!0,placeId:e.id,lat:d,lng:g,distance:l};try{const n=await findMatchingChainForPlaceResult(e.displayName);n?(console.log(`ðŸ”— CHAIN MATCH: "${e.displayName}" matches "${n.bname}"`),u.chain_id=n._id,u.chain_name=n.bname,u.isChainLocation=!0):console.log(`âŒ No chain match for: ${e.displayName}`)}catch(e){console.warn("âš ï¸ Error checking for chain match:",e)}return u})),c=await Promise.all(r);return c.sort(((e,n)=>e.distance-n.distance)),console.log(`ðŸ“Š ENHANCED PLACES RESULTS: ${c.length} businesses processed with ${t/1e3}km radius`),c.forEach(((e,n)=>{const o=(e.distance/1e3).toFixed(1);console.log(`   ${n+1}. ${e.bname} (${o}km away, Chain: ${e.isChainLocation?e.chain_name:"No"})`)})),c}catch(o){console.error("âŒ Error in enhanced Places API search:",o);const a={lat:n.lat,lng:n.lng};return await searchGooglePlacesForBusinessFixed(e,a)}}async function performEnhancedBusinessSearch(e,n=!1){try{let o=null,a=30;if(e.useMyLocation)try{updateLoadingMessage("Getting your location..."),o=await getUserLocation(),window.currentSearchLocation=o}catch(e){return console.error("âŒ Error getting user location:",e),hideLoadingIndicator(),void alert("Unable to get your current location. Please try entering an address instead.")}else if(e.address&&""!==e.address.trim())try{updateLoadingMessage("Finding location...");const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw new Error(`Geocoding failed for address: ${e.address}`);if(o=n,window.currentSearchLocation=o,/^\d{5}$/.test(e.address.trim())?(a=25,console.log("ðŸ“ ZIP CODE SEARCH: Using 25km radius for better metro coverage")):e.address.toLowerCase().includes("city")||e.address.split(",").length>=2?(a=30,console.log("ðŸ“ CITY SEARCH: Using 30km radius")):(a=20,console.log("ðŸ“ ADDRESS SEARCH: Using 20km radius")),map&&o){const e=new google.maps.LatLng(o.lat,o.lng);map.setCenter(e),map.setZoom(a<=20?12:11)}}catch(e){return console.error("âŒ Error geocoding address:",e),hideLoadingIndicator(),void alert("We couldn't recognize that address. Please try a more specific address.")}updateLoadingMessage("Searching database...");let t=[];if(e.businessName&&""!==e.businessName.trim())try{t=await searchDatabaseWithFuzzyMatching(e,o,n),t=t.filter((e=>!0!==e.is_chain)),console.log(`ðŸ“Š PRIMARY RESULTS: Found ${t.length} businesses for "${e.businessName}"`)}catch(e){console.error("âŒ Primary search failed:",e)}let i=[];if(e.businessName&&o)try{updateLoadingMessage("Searching for additional locations...");const n={...o,searchRadius:Math.max(a,35)};i=await searchGooglePlacesForBusinessWithRadius(e.businessName,n),console.log(`ðŸ“Š PLACES RESULTS: Found ${i.length} additional "${e.businessName}" locations`)}catch(e){console.error("âŒ Places search failed:",e)}let s=[];const r=!e.businessName||t.length+i.length<8;if(o&&r)try{updateLoadingMessage("Finding other nearby businesses..."),s=await searchNearbyDatabaseBusinesses(o,a,e.businessName),console.log(`ðŸ“Š NEARBY DATABASE: Found ${s.length} other nearby businesses`)}catch(e){console.error("âŒ Nearby database search failed:",e)}else console.log("â­ï¸ SKIPPING nearby search - found many relevant results");const{finalPrimaryResults:c,finalPlacesResults:l,finalNearbyResults:d}=categorizeResultsWithBetterPriority(t,i,s),g=[...c,...l,...d];console.log("ðŸ“Š IMPROVED PRIORITIZATION:"),console.log(`   - ðŸ”´ Primary Database (RED): ${c.length} businesses`),console.log(`   - ðŸ”µ Additional Locations (BLUE): ${l.length} businesses`),console.log(`   - ðŸŸ¢ Other Nearby (GREEN): ${d.length} businesses`),console.log(`   - Total: ${g.length} businesses`),g.length>0?(c.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!0,e.markerColor="primary",e.priority=1})),l.forEach((e=>{e.isGooglePlace=!0,e.isFromDatabase=!1,e.isPrimaryResult=!1,e.isRelevantPlaces=!0,e.markerColor="nearby",e.priority=2})),d.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!1,e.isNearbyDatabase=!0,e.markerColor="database",e.priority=3})),hideLoadingIndicator(),displayBusinessesOnMapWithBetterPriority(g),displaySearchResultsWithBetterPriority(g),showImprovedSearchSuccessMessage(c.length,l.length,d.length,e.businessName),console.log("âœ… IMPROVED SEARCH: Completed successfully with better prioritization")):(hideLoadingIndicator(),showNoResultsMessage())}catch(e){console.error("âŒ Enhanced search error:",e),hideLoadingIndicator(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}function categorizeResultsWithBetterPriority(e,n,o){console.log("ðŸ”„ IMPROVED CATEGORIZATION:");const a=[...e],t=new Set,i=new Set;return a.forEach((e=>{const n=createAddressKey(e),o=e.bname.toLowerCase().trim();t.add(n),i.add(o),console.log(`ðŸ”´ PRIMARY: ${e.bname} at ${n}`)})),{finalPrimaryResults:a,finalPlacesResults:n.filter((e=>{const n=createAddressKey(e),o=e.bname.toLowerCase().trim();return t.has(n)||i.has(o)?(console.log(`ðŸš« PLACES DUPLICATE: ${e.bname} (already in database)`),!1):(t.add(n),i.add(o),console.log(`ðŸ”µ RELEVANT PLACES: ${e.bname} at ${n}`),!0)})),finalNearbyResults:o.filter((e=>{const n=createAddressKey(e),o=e.bname.toLowerCase().trim();return t.has(n)||i.has(o)?(console.log(`ðŸš« NEARBY DUPLICATE: ${e.bname} (already displayed)`),!1):(console.log(`ðŸŸ¢ OTHER NEARBY: ${e.bname} at ${n}`),!0)}))}}function displaySearchResultsWithBetterPriority(e){try{console.log(`ðŸ“‹ IMPROVED RESULTS: Displaying ${e.length} businesses in better priority order`),hideLoadingIndicator();const n=document.getElementById("business_search"),o=document.getElementById("search_table");if(!n||!o)return console.error("âŒ Required table elements not found in the DOM"),void showErrorMessage("There was an error displaying search results. Please try again later.");let a=n.querySelector("tbody");if(!a)return console.error("âŒ Table body not found"),void showErrorMessage("There was an error displaying search results. Please try again later.");a.innerHTML="",o.style.display="block";const t=o.querySelector("h5");if(t&&(t.style.display="none"),0===e.length)return a.innerHTML='<tr><td colspan="5" class="text-center">No businesses found matching your search criteria.</td></tr>',void o.scrollIntoView({behavior:"smooth"});const i=e.filter((e=>1===e.priority)),s=e.filter((e=>2===e.priority)),r=e.filter((e=>3===e.priority));console.log("ðŸ“Š IMPROVED TABLE CATEGORIES:"),console.log(`   - ðŸ”´ Primary Database Results: ${i.length}`),console.log(`   - ðŸ”µ Additional Relevant Locations: ${s.length}`),console.log(`   - ðŸŸ¢ Other Nearby Businesses: ${r.length}`);let c=0;i.length>0&&(addTableSectionHeader(a,`ðŸŽ¯ Database Results (${i.length})`,"primary-section"),i.forEach(((e,n)=>{console.log(`ðŸ“ Adding primary business ${n+1}: ${e.bname}`),addCategorizedBusinessRow(e,a,"primary"),c++}))),s.length>0&&(addTableSectionHeader(a,`ðŸ“ Additional Locations Found (${s.length})`,"places-section"),s.forEach(((e,n)=>{console.log(`ðŸ“ Adding relevant Places business ${n+1}: ${e.bname}`),addCategorizedBusinessRow(e,a,"places"),c++}))),r.length>0&&(addTableSectionHeader(a,`ðŸ¢ Other Nearby Businesses (${r.length})`,"database-section"),r.forEach(((e,n)=>{console.log(`ðŸ“ Adding nearby database business ${n+1}: ${e.bname}`),addCategorizedBusinessRow(e,a,"database"),c++}))),o.scrollIntoView({behavior:"smooth"}),console.log(`âœ… Improved priority search results displayed: ${c} total rows`)}catch(e){console.error("âŒ Error displaying improved priority search results:",e),hideLoadingIndicator(),showErrorMessage("There was an error displaying the search results: "+e.message)}}function displayBusinessesOnMapWithBetterPriority(e){if(!map)return console.log("â³ Map not ready, storing businesses for later display"),void(pendingBusinessesToDisplay=e);console.log(`ðŸ—ºï¸ IMPROVED MAP DISPLAY: Displaying ${e.length} businesses with better priority`),clearMarkers(),bounds=new google.maps.LatLngBounds;let n=0,o=0,a=0,t=0;const i=[...e].sort(((e,n)=>(e.priority||999)-(n.priority||999)));i.forEach(((e,s)=>{try{if(console.log(`ðŸ”„ Processing business ${s+1}/${i.length}: ${e.bname} (Priority: ${e.priority})`),!0===e.is_chain)return console.log(`ðŸš« Skipping parent chain business: ${e.bname}`),void t++;const r=getBusinessLocation(e);if(!r)return console.warn(`âŒ Business ${e.bname} missing coordinates`),void t++;if(e.lat=r.lat,e.lng=r.lng,createCategorizedBusinessMarker(e)){switch(e.priority){case 1:n++;break;case 2:o++;break;default:a++}console.log(`âœ… Created priority ${e.priority} marker for ${e.bname}`);const t=new google.maps.LatLng(r.lat,r.lng);bounds.extend(t)}else console.error(`âŒ Failed to create marker for ${e.bname}`),t++}catch(n){console.error(`âŒ Error processing business ${e.bname}:`,n),t++}})),console.log("ðŸ“Š IMPROVED PRIORITY MARKER SUMMARY:"),console.log(`   - ðŸ”´ Priority 1 - Database Results (RED): ${n} markers`),console.log(`   - ðŸ”µ Priority 2 - Additional Locations (BLUE): ${o} markers`),console.log(`   - ðŸŸ¢ Priority 3 - Other Nearby (GREEN): ${a} markers`),console.log(`   - âŒ Skipped: ${t} businesses`),console.log(`   - âœ… Total Created: ${n+o+a} markers`),setTimeout((()=>{try{if(window.currentSearchLocation&&(n>0||o>0)){console.log("ðŸ“ Centering map on search location with relevant results");const e=new google.maps.LatLng(window.currentSearchLocation.lat,window.currentSearchLocation.lng);map.setCenter(e),map.setZoom(12)}else n+o+a>0&&bounds&&!bounds.isEmpty()?(console.log("ðŸŽ¯ Fitting map to all business bounds"),safelyFitBounds(map,bounds)):(console.log("ðŸŒŽ Using default map center"),map.setCenter(CONFIG.defaultCenter),map.setZoom(CONFIG.defaultZoom))}catch(e){console.error("âŒ Error updating map view:",e)}}),200)}function showImprovedSearchSuccessMessage(e,n,o,a){const t=document.createElement("div");t.className="enhanced-search-success-banner";let i=`Found ${e+n+o} businesses`;a&&(i+=` for "${a}"`),i+=": ";const s=[];e>0&&s.push(`<span class="success-primary">${e} in database</span>`),n>0&&s.push(`<span class="success-places">${n} additional location${1!==n?"s":""}</span>`),o>0&&s.push(`<span class="success-database">${o} other nearby</span>`),i+=s.join(", "),t.innerHTML=`\n        <div class="enhanced-success-content">\n            <span class="success-icon">âœ…</span>\n            <span class="success-text">${i}</span>\n            <button onclick="this.parentElement.parentElement.remove()" class="close-success">Ã—</button>\n        </div>\n        <div class="success-legend">\n            <span class="legend-item"><span class="legend-dot red"></span>Database Results</span>\n            <span class="legend-item"><span class="legend-dot blue"></span>Additional Locations</span>\n            <span class="legend-item"><span class="legend-dot green"></span>Other Nearby</span>\n        </div>\n    `;const r=document.querySelector("main")||document.body;r.insertBefore(t,r.firstChild),setTimeout((()=>{t.parentNode&&t.remove()}),8e3)}async function searchGooglePlacesForBusinessEnhanced(e,n){try{console.log("ðŸ” ENHANCED PLACES SEARCH: Searching for:",e,"near",n);const{Place:o}=await google.maps.importLibrary("places"),a=new google.maps.LatLng(n.lat,n.lng),t=5e4,i={textQuery:e,locationBias:{center:a,radius:t},maxResultCount:20,fields:["id","displayName","formattedAddress","location","types","nationalPhoneNumber","internationalPhoneNumber","businessStatus"]};console.log(`ðŸŒ Enhanced Places API request with ${t/1e3}km radius:`,i);const{places:s}=await o.searchByText(i);if(!s||0===s.length){console.log("âŒ No businesses found via enhanced Places API"),console.log("ðŸ”„ FALLBACK: Trying with 75km radius...");const n={...i,locationBias:{center:a,radius:75e3}},{places:t}=await o.searchByText(n);return t&&0!==t.length?(console.log(`âœ… Fallback found ${t.length} businesses`),await processPlacesResults(t,a,e)):(console.log("âŒ No businesses found even with larger radius"),[])}return console.log(`âœ… Found ${s.length} businesses via enhanced Places API`),await processPlacesResults(s,a,e)}catch(o){console.error("âŒ Error in enhanced Places API search:",o),console.log("ðŸ”„ FINAL FALLBACK: Using existing Places search...");try{return await searchGooglePlacesForBusinessFixed(e,n)}catch(e){return console.error("âŒ All Places search methods failed:",e),[]}}}async function processPlacesResults(e,n,o){console.log(`ðŸ”„ Processing ${e.length} Places results for "${o}"`);const a=e.filter((e=>{if("CLOSED_PERMANENTLY"===e.businessStatus)return console.log(`â­ï¸ Skipping permanently closed: ${e.displayName}`),!1;const n=e.displayName.toLowerCase(),a=o.toLowerCase();if(!n.includes(a)&&!a.includes(n)){const o=a.split(" "),t=n.split(" ");let i=0;for(const e of o)t.some((n=>n.includes(e)||e.includes(n)))&&i++;if(i<Math.ceil(o.length/2))return console.log(`â­ï¸ Skipping unrelated result: ${e.displayName}`),!1}return!0}));console.log(`âœ… Filtered to ${a.length} valid places`);const t=a.map((async(e,o)=>{console.log(`   ${o+1}. Processing: ${e.displayName}`);const a=e.formattedAddress?e.formattedAddress.split(","):[];let t="",i="",s="",r="";if(a.length>=1&&(t=a[0].trim()),a.length>=2&&(i=a[1].trim()),a.length>=3){const e=a[2].trim().match(/^([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/);e&&(s=e[1],r=e[2])}const c=e.location,l=google.maps.geometry.spherical.computeDistanceBetween(n,c),d=(l/1e3).toFixed(1);let g=0,u=0;if(e.location)try{g="function"==typeof e.location.lat?e.location.lat():e.location.lat||0,u="function"==typeof e.location.lng?e.location.lng():e.location.lng||0}catch(e){console.warn("âš ï¸ Error extracting coordinates:",e),g=n.lat(),u=n.lng()}const h={_id:"google_"+e.id,bname:e.displayName,address1:t,city:i,state:s,zip:r,formattedAddress:e.formattedAddress,type:mapGooglePlaceTypeToBusinessType(e.types),phone:e.nationalPhoneNumber||e.internationalPhoneNumber||"",isGooglePlace:!0,placeId:e.id,lat:g,lng:u,distance:l,businessStatus:e.businessStatus};console.log(`      â†’ ${h.bname} at ${d}km (${i}, ${s})`);try{const n=await findMatchingChainForPlaceResult(e.displayName);n&&(console.log(`      ðŸ”— Chain match: ${n.bname}`),h.chain_id=n._id,h.chain_name=n.bname,h.isChainLocation=!0)}catch(n){console.warn(`      âš ï¸ Chain matching failed for ${e.displayName}:`,n.message)}return h})),i=await Promise.all(t);return i.sort(((e,n)=>e.distance-n.distance)),console.log(`ðŸ“Š FINAL PROCESSED RESULTS: ${i.length} businesses`),i.forEach(((e,n)=>{const o=(e.distance/1e3).toFixed(1);console.log(`   ${n+1}. ${e.bname} - ${o}km - ${e.city}, ${e.state}`)})),i}async function searchNearbyDatabaseBusinessesEnhanced(e,n,o=""){try{console.log(`ðŸ¢ ENHANCED NEARBY DB SEARCH: ${n}km radius around ${e.lat}, ${e.lng}`);const a=getBaseURL(),t=Math.max(n,30),i=`${a}/api/business.js?${new URLSearchParams({operation:"search",lat:e.lat,lng:e.lng,radius:t,limit:100}).toString()}`;console.log(`ðŸŒ Enhanced nearby search: ${i}`);const s=await fetch(i);if(!s.ok)throw new Error(`Nearby search failed: ${s.status}`);let r=(await s.json()).results||[];return console.log(`ðŸ“Š Raw nearby results: ${r.length} businesses`),r=r.filter((e=>{if(!0===e.is_chain)return!1;if(o){const n=e.bname.toLowerCase(),a=o.toLowerCase();if(n===a||n.includes(a)||a.includes(n))return console.log(`ðŸš« EXCLUDING: ${e.bname} (matches "${o}")`),!1}return!!hasValidCoordinates(e)||(console.log(`ðŸš« EXCLUDING: ${e.bname} (invalid coordinates)`),!1)})),console.log(`âœ… ENHANCED NEARBY FILTER: ${r.length} businesses after filtering`),r.slice(0,5).forEach(((e,n)=>{console.log(`   ${n+1}. ${e.bname} - ${e.city}, ${e.state}`)})),r}catch(e){return console.error("âŒ Error in enhanced nearby database search:",e),[]}}async function debugLasVegasOliveGardenSearch(){console.log("ðŸ§ª DEBUG: Testing Las Vegas Olive Garden search...");const e={lat:36.0395,lng:-115.061};try{console.log("1. Testing enhanced Places search...");const n=await searchGooglePlacesForBusinessEnhanced("Olive Garden",e);console.log(`   Found ${n.length} Olive Garden locations via Places API`),console.log("2. Testing enhanced nearby database search...");const o=await searchNearbyDatabaseBusinessesEnhanced(e,30,"Olive Garden");console.log(`   Found ${o.length} nearby database businesses`),console.log("3. Testing database search for Olive Garden...");const a={businessName:"Olive Garden",address:"",useMyLocation:!1},t=await searchDatabaseWithFuzzyMatching(a,e,!1);return console.log(`   Found ${t.length} Olive Garden locations in database`),console.log("âœ… DEBUG TEST COMPLETE"),{places:n.length,nearby:o.length,database:t.length}}catch(e){return console.error("âŒ Debug test failed:",e),null}}async function testOliveGardenLasVegas(){console.log("ðŸ§ª TESTING: Olive Garden search in Las Vegas (89121)");const e={businessName:"Olive Garden",address:"89121",useMyLocation:!1};try{clearMarkers(),await performEnhancedBusinessSearch(e,!0),console.log("âœ… Test search completed - check results!")}catch(e){console.error("âŒ Test search failed:",e)}}function createEnhancedAddressKey(e){const n=[];e.address1&&n.push(e.address1.toLowerCase().trim()),e.city&&n.push(e.city.toLowerCase().trim()),e.state&&n.push(e.state.toLowerCase().trim()),e.placeId&&n.push(`place_${e.placeId}`),e._id&&!e._id.startsWith("google_")&&n.push(`db_${e._id}`);const o=n.join("|");return console.log(`ðŸ”‘ ADDRESS KEY for ${e.bname}: ${o}`),o}function createBusinessNameKey(e){if(e.isChainLocation||e.chain_id){const n=e.address1?e.address1.toLowerCase().replace(/\d+/g,"").trim():"",o=`${e.bname.toLowerCase().trim()}_${n}`;return console.log(`ðŸª CHAIN NAME KEY for ${e.bname}: ${o}`),o}const n=e.bname.toLowerCase().trim();return console.log(`ðŸ¢ REGULAR NAME KEY for ${e.bname}: ${n}`),n}function categorizeResultsWithFixedDuplicateDetection(e,n,o){console.log("ðŸ”„ FIXED CATEGORIZATION - Properly handling chain locations:");const a=[...e],t=new Set,i=new Set;a.forEach((e=>{const n=createEnhancedAddressKeyFixed(e),o=createBusinessNameKeyFixed(e);t.add(n),i.add(o),console.log(`ðŸ”´ PRIMARY: ${e.bname} - Address: ${n} - Name: ${o}`)}));const s=n.filter(((e,n)=>{const o=createEnhancedAddressKeyFixed(e),a=createBusinessNameKeyFixed(e);return console.log(`ðŸ” CHECKING PLACES #${n+1}: ${e.bname}`),console.log(`   Address Key: ${o}`),console.log(`   Name Key: ${a}`),t.has(o)?(console.log(`ðŸš« PLACES DUPLICATE: ${e.bname} (same address: ${o})`),!1):i.has(a)?(console.log(`ðŸš« PLACES DUPLICATE: ${e.bname} (same name+address combination: ${a})`),!1):(t.add(o),i.add(a),console.log(`ðŸ”µ PLACES ACCEPTED: ${e.bname} at ${e.address1}`),!0)})),r=o.filter((e=>{const n=createEnhancedAddressKeyFixed(e),o=createBusinessNameKeyFixed(e);return t.has(n)||i.has(o)?(console.log(`ðŸš« NEARBY DUPLICATE: ${e.bname} (already processed)`),!1):(console.log(`ðŸŸ¢ NEARBY ACCEPTED: ${e.bname} at ${e.address1}`),!0)}));return console.log("ðŸ“Š FIXED CATEGORIZATION RESULTS:"),console.log(`   ðŸ”´ Primary: ${a.length}`),console.log(`   ðŸ”µ Places: ${s.length} (was ${n.length})`),console.log(`   ðŸŸ¢ Nearby: ${r.length}`),{finalPrimaryResults:a,finalPlacesResults:s,finalNearbyResults:r}}async function performEnhancedBusinessSearchWithFixedDuplicates(e,n=!1){try{console.log("ðŸ” FIXED SEARCH: Starting search with proper chain location handling:",e);const o=document.getElementById("business-search-results")||document.getElementById("search_table");o&&(o.innerHTML='<div class="loading-indicator" id="main-loading"><div class="loading-text">Searching for businesses...</div><div class="loading-spinner"></div></div>',o.style.display="block");let a=null,t=30;if(e.useMyLocation)try{updateLoadingMessage("Getting your location..."),a=await getUserLocation(),window.currentSearchLocation=a}catch(e){return console.error("âŒ Error getting user location:",e),hideLoadingIndicator(),void alert("Unable to get your current location. Please try entering an address instead.")}else if(e.address&&""!==e.address.trim())try{updateLoadingMessage("Finding location...");const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw new Error(`Geocoding failed for address: ${e.address}`);if(a=n,window.currentSearchLocation=a,/^\d{5}$/.test(e.address.trim())?(t=25,console.log("ðŸ“ ZIP CODE SEARCH: Using 25km radius")):e.address.toLowerCase().includes("city")||e.address.split(",").length>=2?(t=30,console.log("ðŸ“ CITY SEARCH: Using 30km radius")):(t=20,console.log("ðŸ“ ADDRESS SEARCH: Using 20km radius")),map&&a){const e=new google.maps.LatLng(a.lat,a.lng);map.setCenter(e),map.setZoom(t<=20?12:11)}}catch(e){return console.error("âŒ Error geocoding address:",e),hideLoadingIndicator(),void alert("We couldn't recognize that address. Please try a more specific address.")}updateLoadingMessage("Searching database...");let i=[];if(e.businessName&&""!==e.businessName.trim())try{i=await searchDatabaseWithFuzzyMatching(e,a,n),i=i.filter((e=>!0!==e.is_chain)),console.log(`ðŸ“Š PRIMARY RESULTS: Found ${i.length} businesses for "${e.businessName}"`)}catch(e){console.error("âŒ Primary search failed:",e)}let s=[];if(e.businessName&&a)try{updateLoadingMessage("Searching for additional locations...");const n={...a,searchRadius:Math.max(t,35)};s=await searchGooglePlacesForBusinessEnhanced(e.businessName,n),console.log(`ðŸ“Š PLACES RESULTS: Found ${s.length} additional "${e.businessName}" locations`)}catch(e){console.error("âŒ Places search failed:",e)}let r=[];const c=!e.businessName||i.length+s.length<8;if(a&&c)try{updateLoadingMessage("Finding other nearby businesses..."),r=await searchNearbyDatabaseBusinessesEnhanced(a,t,e.businessName),console.log(`ðŸ“Š NEARBY DATABASE: Found ${r.length} other nearby businesses`)}catch(e){console.error("âŒ Nearby database search failed:",e)}else console.log("â­ï¸ SKIPPING nearby search - found many relevant results");const{finalPrimaryResults:l,finalPlacesResults:d,finalNearbyResults:g}=categorizeResultsWithImprovedChainDetection(i,s,r),u=[...l,...d,...g];console.log("ðŸ“Š FIXED SEARCH RESULTS:"),console.log(`   - ðŸ”´ Primary Database (RED): ${l.length} businesses`),console.log(`   - ðŸ”µ Additional Locations (BLUE): ${d.length} businesses`),console.log(`   - ðŸŸ¢ Other Nearby (GREEN): ${g.length} businesses`),console.log(`   - Total: ${u.length} businesses`),u.length>0?(l.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!0,e.markerColor="primary",e.priority=1})),d.forEach((e=>{e.isGooglePlace=!0,e.isFromDatabase=!1,e.isPrimaryResult=!1,e.isRelevantPlaces=!0,e.markerColor="nearby",e.priority=2})),g.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!1,e.isNearbyDatabase=!0,e.markerColor="database",e.priority=3})),hideLoadingIndicator(),displayBusinessesOnMapWithBetterPriority(u),displaySearchResultsWithBetterPriority(u),showImprovedSearchSuccessMessage(l.length,d.length,g.length,e.businessName),console.log("âœ… FIXED SEARCH: Completed successfully with proper chain location handling")):(hideLoadingIndicator(),showNoResultsMessage())}catch(e){console.error("âŒ Fixed search error:",e),hideLoadingIndicator(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}async function testFixedOliveGardenSearch(){console.log("ðŸ§ª TESTING FIXED: Olive Garden search with proper duplicate detection");const e={businessName:"Olive Garden",address:"89121",useMyLocation:!1};try{clearMarkers(),await performEnhancedBusinessSearchWithFixedDuplicates(e,!0),console.log("âœ… Fixed test search completed - should now show 9+ Olive Garden locations!")}catch(e){console.error("âŒ Fixed test search failed:",e)}}async function performEnhancedBusinessSearchWithNearbyFixed(e,n=!1){try{console.log("ðŸ” NEARBY FIXED SEARCH: Starting search with guaranteed nearby search:",e);const o=document.getElementById("business-search-results")||document.getElementById("search_table");o&&(o.innerHTML='<div class="loading-indicator" id="main-loading"><div class="loading-text">Searching for businesses...</div><div class="loading-spinner"></div></div>',o.style.display="block");let a=null,t=30;if(e.useMyLocation)try{updateLoadingMessage("Getting your location..."),a=await getUserLocation(),window.currentSearchLocation=a}catch(e){return console.error("âŒ Error getting user location:",e),hideLoadingIndicator(),void alert("Unable to get your current location. Please try entering an address instead.")}else if(e.address&&""!==e.address.trim())try{updateLoadingMessage("Finding location...");const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw new Error(`Geocoding failed for address: ${e.address}`);if(a=n,window.currentSearchLocation=a,/^\d{5}$/.test(e.address.trim())?(t=25,console.log("ðŸ“ ZIP CODE SEARCH: Using 25km radius")):e.address.toLowerCase().includes("city")||e.address.split(",").length>=2?(t=30,console.log("ðŸ“ CITY SEARCH: Using 30km radius")):(t=20,console.log("ðŸ“ ADDRESS SEARCH: Using 20km radius")),map&&a){const e=new google.maps.LatLng(a.lat,a.lng);map.setCenter(e),map.setZoom(t<=20?12:11)}}catch(e){return console.error("âŒ Error geocoding address:",e),hideLoadingIndicator(),void alert("We couldn't recognize that address. Please try a more specific address.")}updateLoadingMessage("Searching database...");let i=[];if(e.businessName&&""!==e.businessName.trim())try{i=await searchDatabaseWithFuzzyMatching(e,a,n),i=i.filter((e=>!0!==e.is_chain)),console.log(`ðŸ“Š PRIMARY RESULTS: Found ${i.length} businesses for "${e.businessName}"`)}catch(e){console.error("âŒ Primary search failed:",e)}let s=[];if(e.businessName&&a)try{updateLoadingMessage("Searching for additional locations...");const n={...a,searchRadius:Math.max(t,35)};s=await searchGooglePlacesForBusinessEnhanced(e.businessName,n),console.log(`ðŸ“Š PLACES RESULTS: Found ${s.length} additional "${e.businessName}" locations`)}catch(e){console.error("âŒ Places search failed:",e)}let r=[];if(a)try{updateLoadingMessage("Finding other nearby businesses in database..."),console.log("ðŸ” ALWAYS SEARCHING nearby businesses for context and completeness"),r=await searchNearbyDatabaseBusinessesEnhanced(a,t,e.businessName),console.log(`ðŸ“Š NEARBY DATABASE: Found ${r.length} other nearby businesses`),r.length>0?(console.log("ðŸ¢ NEARBY BUSINESSES FOUND:"),r.slice(0,10).forEach(((e,n)=>{console.log(`   ${n+1}. ${e.bname} (${e.type}) - ${e.city}, ${e.state}`)}))):console.log("âŒ No nearby database businesses found - this seems unusual for Las Vegas")}catch(e){console.error("âŒ Nearby database search failed:",e)}else console.log("â­ï¸ No search location available - cannot search for nearby businesses");const{finalPrimaryResults:c,finalPlacesResults:l,finalNearbyResults:d}=categorizeResultsWithImprovedChainDetection(i,s,r),g=[...c,...l,...d];console.log("ðŸ“Š NEARBY FIXED SEARCH RESULTS:"),console.log(`   - ðŸ”´ Primary Database (RED): ${c.length} businesses`),console.log(`   - ðŸ”µ Additional Locations (BLUE): ${l.length} businesses`),console.log(`   - ðŸŸ¢ Other Nearby Database (GREEN): ${d.length} businesses`),console.log(`   - Total: ${g.length} businesses`),g.length>0?(c.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!0,e.markerColor="primary",e.priority=1})),l.forEach((e=>{e.isGooglePlace=!0,e.isFromDatabase=!1,e.isPrimaryResult=!1,e.isRelevantPlaces=!0,e.markerColor="nearby",e.priority=2})),d.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!1,e.isNearbyDatabase=!0,e.markerColor="database",e.priority=3})),hideLoadingIndicator(),displayBusinessesOnMapWithBetterPriority(g),displaySearchResultsWithBetterPriority(g),showImprovedSearchSuccessMessage(c.length,l.length,d.length,e.businessName),console.log("âœ… NEARBY FIXED SEARCH: Completed successfully with guaranteed nearby search")):(hideLoadingIndicator(),showNoResultsMessage())}catch(e){console.error("âŒ Nearby fixed search error:",e),hideLoadingIndicator(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}async function searchNearbyDatabaseBusinessesWithDebugging(e,n,o=""){try{console.log(`ðŸ¢ DEBUGGING NEARBY SEARCH: ${n}km radius around ${e.lat}, ${e.lng}`),console.log(`   Excluding business name: "${o}"`);const a=getBaseURL(),t=Math.max(n,30);console.log(`   Using enhanced radius: ${t}km`);const i=`${a}/api/business.js?${new URLSearchParams({operation:"search",lat:e.lat,lng:e.lng,radius:t,limit:100}).toString()}`;console.log(`ðŸŒ DEBUGGING nearby search URL: ${i}`);const s=await fetch(i);if(!s.ok)throw new Error(`Nearby search failed: ${s.status}`);let r=(await s.json()).results||[];console.log(`ðŸ“Š DEBUGGING raw nearby results: ${r.length} businesses total`),console.log("ðŸ” ALL NEARBY BUSINESSES FOUND (first 20):"),r.slice(0,20).forEach(((e,n)=>{const o=!0===e.is_chain?" (CHAIN PARENT)":"",a=hasValidCoordinates(e)?"âœ…":"âŒ";console.log(`   ${n+1}. ${e.bname} - ${e.city}, ${e.state} ${a}${o}`)}));const c=r.filter(((e,n)=>{if(console.log(`ðŸ” FILTERING #${n+1}: ${e.bname}`),!0===e.is_chain)return console.log("   ðŸš« EXCLUDE: Parent chain business"),!1;if(!hasValidCoordinates(e))return console.log("   ðŸš« EXCLUDE: Invalid coordinates"),!1;if(o){const n=e.bname.toLowerCase(),a=o.toLowerCase();if(n===a||n.includes(a)||a.includes(n))return console.log(`   ðŸš« EXCLUDE: Matches excluded name "${o}"`),!1}return console.log(`   âœ… INCLUDE: ${e.bname}`),!0}));return console.log(`âœ… DEBUGGING FILTER RESULTS: ${c.length} businesses after filtering`),c.length>0?(console.log("ðŸ“‹ FINAL NEARBY BUSINESSES:"),c.slice(0,10).forEach(((e,n)=>{console.log(`   ${n+1}. ${e.bname} (${e.type}) - ${e.city}, ${e.state}`)}))):console.log("âŒ NO NEARBY BUSINESSES after filtering - this indicates a potential issue"),c}catch(e){return console.error("âŒ Error in debugging nearby database search:",e),[]}}async function testNearbySearchFix(){console.log("ðŸ§ª TESTING NEARBY SEARCH FIX: Should find Home Depot in Las Vegas");const e={businessName:"Olive Garden",address:"89121",useMyLocation:!1};try{clearMarkers(),await performEnhancedBusinessSearchWithNearbyFixed(e,!0),console.log("âœ… Nearby search fix test completed - should now show Home Depot in green!")}catch(e){console.error("âŒ Nearby search fix test failed:",e)}}async function debugNearbySearchOnly(){console.log("ðŸ” DEBUGGING: Nearby search only for Las Vegas");const e={lat:36.1165487,lng:-115.0881146};try{const n=await searchNearbyDatabaseBusinessesWithDebugging(e,30,"Olive Garden");return console.log(`ðŸ“Š NEARBY DEBUG RESULTS: Found ${n.length} nearby businesses`),n}catch(e){return console.error("âŒ Nearby debug failed:",e),[]}}window.focusOnGooglePlacesMarker=function(e){if(console.log("focusOnGooglePlacesMarker called for business ID:",e),!mapInitialized||!map)return console.error("Map not initialized yet - cannot focus on marker"),void alert("Map is still loading. Please try again in a moment.");if(!markers||0===markers.length)return console.warn("No markers available yet."),void alert("No businesses are currently displayed on the map.");const n=markers.find((n=>!!n.business&&(n.business._id===e||n.business.placeId===e||n.business._id===`google_${e}`||e.includes(n.business.placeId))));if(n)try{let o;if(n.getPosition&&"function"==typeof n.getPosition)o=n.getPosition();else if(n.position)o=n.position;else{if(!(n.business&&n.business.lat&&n.business.lng))return console.error("Could not determine marker position"),void alert("Could not focus on this business on the map.");o=new google.maps.LatLng(parseFloat(n.business.lat),parseFloat(n.business.lng))}map.setCenter(o),map.setZoom(16),"function"==typeof showEnhancedInfoWindowWithCategory?showEnhancedInfoWindowWithCategory(n):"function"==typeof showEnhancedInfoWindow?showEnhancedInfoWindow(n):showInfoWindow(n),document.getElementById("map").scrollIntoView({behavior:"smooth"}),console.log("Successfully focused on Google Places marker for business:",e)}catch(e){console.error("Error focusing on Google Places marker:",e),alert("There was an error focusing on this business on the map.")}else{console.warn(`No marker found for Google Places business ID: ${e}`);const n=markers.find((n=>n.business&&e.toLowerCase().includes(n.business.bname.toLowerCase())));if(n){console.log("Found marker by business name, focusing on that instead");const e=n.business._id||n.business.placeId;window.focusOnGooglePlacesMarker(e)}else alert("Could not find this business on the map. It may not be currently displayed.")}};let databaseStats=null;async function loadDatabaseStatistics(){console.log("ðŸ“Š Loading real-time database statistics...");try{showStatsLoading(!0);const e=getBaseURL(),n=getAuthTokenOptional(),o={"Cache-Control":"no-cache"};n&&(o.Authorization=`Bearer ${n}`),console.log("ðŸŒ Fetching statistics from API...");const a=await fetch(`${e}/api/auth.js?operation=dashboard-stats`,{method:"GET",headers:o});if(!a.ok)throw console.log("ðŸ”„ Primary stats endpoint failed, trying alternative..."),new Error(`Stats API failed: ${a.status}`);const t=await a.json();console.log("ðŸ“Š Dashboard stats received:",t),console.log("ðŸ”— Loading chain statistics...");const i=await loadChainStatistics(),s={businessCount:t.businessCount||0,chainCount:i?.totalChains||0,businessIncentives:t.incentiveCount||0,chainIncentives:i?.totalChainIncentives||0,activeBusinesses:t.activeBusinessCount||0,newBusinessesThisMonth:t.newBusinessesThisMonth||0,availableIncentives:t.availableIncentiveCount||0};console.log("âœ… Combined statistics:",s),databaseStats=s,updateStatisticsDisplay(s),showStatsLoading(!1),animateStatsContainer(),console.log("âœ… Database statistics loaded successfully")}catch(e){console.error("âŒ Error loading database statistics:",e);try{console.log("ðŸ”„ Trying fallback statistics method...");const e=await loadFallbackStatistics();if(e)return databaseStats=e,updateStatisticsDisplay(e),showStatsLoading(!1),void console.log("âœ… Fallback statistics loaded")}catch(e){console.error("âŒ Fallback statistics also failed:",e)}showStatsError()}}async function loadChainStatistics(){try{const e=getBaseURL(),n=getAuthTokenOptional(),o={"Cache-Control":"no-cache"};n&&(o.Authorization=`Bearer ${n}`);const a=await fetch(`${e}/api/chains.js?operation=summary`,{method:"GET",headers:o});if(!a.ok)return console.warn("âš ï¸ Chain statistics API failed:",a.status),null;const t=await a.json();return console.log("ðŸ”— Chain statistics:",t),{totalChains:t.total_chains||0,totalChainLocations:t.total_locations||0,totalChainIncentives:t.total_incentives||0,activeChainsWithIncentives:t.active_chains_with_incentives||0}}catch(e){return console.error("âŒ Error loading chain statistics:",e),null}}async function loadFallbackStatistics(){try{console.log("ðŸ”„ Using fallback statistics method...");const e=getBaseURL(),n=await fetch(`${e}/api/business.js?operation=search&limit=1`);if(n.ok){const e=await n.json(),o=e.total||e.results?.length||0;return console.log("ðŸ“Š Fallback business count:",o),{businessCount:o,chainCount:0,businessIncentives:Math.floor(.6*o),chainIncentives:0}}return null}catch(e){return console.error("âŒ Fallback statistics failed:",e),null}}function updateStatisticsDisplay(e){console.log("ðŸŽ¨ Updating statistics display with:",e);const n=document.getElementById("stat-businesses"),o=document.getElementById("stat-chains"),a=document.getElementById("stat-business-incentives"),t=document.getElementById("stat-chain-incentives");n&&o&&a&&t?(animateNumberUpdate(n,e.businessCount),animateNumberUpdate(o,e.chainCount),animateNumberUpdate(a,e.businessIncentives),animateNumberUpdate(t,e.chainIncentives),console.log("âœ… Statistics display updated")):console.error("âŒ Statistics elements not found in DOM")}function animateNumberUpdate(e,n){const o=performance.now();requestAnimationFrame((function a(t){const i=t-o,s=Math.min(i/1e3,1),r=1-Math.pow(1-s,3),c=Math.floor(0+(n-0)*r);e.textContent=c.toLocaleString(),s<1?requestAnimationFrame(a):e.textContent=n.toLocaleString()}))}function showStatsLoading(e){const n=document.getElementById("stats-loading"),o=document.querySelector(".stats-text");n&&o&&(e?(n.style.display="block",o.classList.add("stats-hidden")):(n.style.display="none",o.classList.remove("stats-hidden")))}function showStatsError(){const e=document.getElementById("database-stats");e&&(e.innerHTML='\n            <p class="stats-error">\n                Unable to load current database statistics. Please try refreshing the page.\n            </p>\n        ')}function animateStatsContainer(){const e=document.getElementById("database-stats");e&&(e.classList.add("animate"),setTimeout((()=>{e.classList.remove("animate")}),2e3))}function getAuthTokenOptional(){try{const e=localStorage.getItem("patriotThanksSession");return e&&JSON.parse(e).token||null}catch(e){return console.log("â„¹ï¸ No auth token available (this is okay for public stats)"),null}}function refreshDatabaseStatistics(){console.log("ðŸ”„ Refreshing database statistics..."),loadDatabaseStatistics()}function initializeDatabaseStatistics(){console.log("ðŸš€ Initializing database statistics..."),loadDatabaseStatistics(),setInterval(refreshDatabaseStatistics,3e5)}function createEnhancedAddressKeyFixed(e){const n=[];if(e.address1){let o=e.address1.toLowerCase().trim().replace(/\s+/g," ").replace(/[^\w\s#]/g,"").replace(/\b(suite?|ste?|unit|apt|apartment)\b/g,"").replace(/\s+/g," ").trim();n.push(o)}if(e.city&&n.push(e.city.toLowerCase().trim().replace(/\s+/g,"")),e.state&&n.push(e.state.toLowerCase().trim()),e.zip){const o=e.zip.trim().substring(0,5);n.push(o)}const o=n.join("|");return console.log(`ðŸ”‘ FIXED ADDRESS KEY for ${e.bname}: ${o}`),o}function createBusinessNameKeyFixed(e){const n=e.bname.toLowerCase().trim();if(e.isChainLocation||e.chain_id||isChainVariationName(n)){const o=e.address1?e.address1.toLowerCase().replace(/[^\w\s]/g,"").replace(/\s+/g,"").substring(0,20):"noaddr",a=`${normalizeChainName(n)}_${o}`;return console.log(`ðŸª FIXED CHAIN NAME KEY for ${e.bname}: ${a}`),a}const o=n.replace(/[^\w\s]/g,"").replace(/\s+/g,"");return console.log(`ðŸ¢ FIXED REGULAR NAME KEY for ${e.bname}: ${o}`),o}function isChainVariationName(e){return[/^shag\s/i,/\bshag\b/i,/alternative\s*superstore/i].some((n=>n.test(e)))}function normalizeChainName(e){return e.toLowerCase().replace(/\b(alternative\s*superstore|superstore)\b/i,"alt-super").replace(/\b(cedar\s*rapids|marshalltown|west\s*des\s*moines|wiley\s*blvd)\b/i,"").replace(/[^\w]/g,"").trim()}function categorizeResultsWithImprovedChainDetection(e,n,o){console.log("ðŸ”„ IMPROVED CHAIN CATEGORIZATION - Better duplicate detection:");const a=[...e],t=new Set,i=new Set;a.forEach((e=>{const n=createEnhancedAddressKeyFixed(e),o=createBusinessNameKeyFixed(e);t.add(n),i.add(o),console.log(`ðŸ”´ PRIMARY: ${e.bname}`),console.log(`   Address Key: ${n}`),console.log(`   Name Key: ${o}`)}));const s=n.filter(((e,n)=>{const o=createEnhancedAddressKeyFixed(e),a=createBusinessNameKeyFixed(e);return console.log(`ðŸ” CHECKING PLACES #${n+1}: ${e.bname}`),console.log(`   Address Key: ${o}`),console.log(`   Name Key: ${a}`),t.has(o)?(console.log(`ðŸš« PLACES DUPLICATE BY ADDRESS: ${e.bname} (same address: ${o})`),!1):i.has(a)?(console.log(`ðŸš« PLACES DUPLICATE BY NAME+ADDRESS: ${e.bname} (same name+address: ${a})`),!1):(e.isChainLocation||isChainVariationName(e.bname))&&Array.from(t).some((e=>o.split("|")[0]===e.split("|")[0]))?(console.log(`ðŸš« CHAIN LOCATION DUPLICATE: ${e.bname} (same address as existing chain location)`),!1):(t.add(o),i.add(a),console.log(`ðŸ”µ PLACES ACCEPTED: ${e.bname} at ${e.address1}`),!0)})),r=o.filter((e=>{const n=createEnhancedAddressKeyFixed(e),o=createBusinessNameKeyFixed(e);return t.has(n)||i.has(o)?(console.log(`ðŸš« NEARBY DUPLICATE: ${e.bname} (already processed)`),!1):(console.log(`ðŸŸ¢ NEARBY ACCEPTED: ${e.bname} at ${e.address1}`),!0)}));return console.log("ðŸ“Š IMPROVED CHAIN CATEGORIZATION RESULTS:"),console.log(`   ðŸ”´ Primary: ${a.length}`),console.log(`   ðŸ”µ Places: ${s.length} (was ${n.length})`),console.log(`   ðŸŸ¢ Nearby: ${r.length}`),{finalPrimaryResults:a,finalPlacesResults:s,finalNearbyResults:r}}async function performEnhancedBusinessSearchWithImprovedChainDetection(e,n=!1){try{console.log("ðŸ” IMPROVED CHAIN SEARCH: Starting search with better duplicate detection:",e);const o=document.getElementById("business-search-results")||document.getElementById("search_table");o&&(o.innerHTML='<div class="loading-indicator" id="main-loading"><div class="loading-text">Searching for businesses...</div><div class="loading-spinner"></div></div>',o.style.display="block");let a=null,t=30;if(e.useMyLocation)try{updateLoadingMessage("Getting your location..."),a=await getUserLocation(),window.currentSearchLocation=a}catch(e){return console.error("âŒ Error getting user location:",e),hideLoadingIndicator(),void alert("Unable to get your current location. Please try entering an address instead.")}else if(e.address&&""!==e.address.trim())try{updateLoadingMessage("Finding location...");const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw new Error(`Geocoding failed for address: ${e.address}`);if(a=n,window.currentSearchLocation=a,/^\d{5}$/.test(e.address.trim())?(t=25,console.log("ðŸ“ ZIP CODE SEARCH: Using 25km radius")):e.address.toLowerCase().includes("city")||e.address.split(",").length>=2?(t=30,console.log("ðŸ“ CITY SEARCH: Using 30km radius")):(t=20,console.log("ðŸ“ ADDRESS SEARCH: Using 20km radius")),map&&a){const e=new google.maps.LatLng(a.lat,a.lng);map.setCenter(e),map.setZoom(t<=20?12:11)}}catch(e){return console.error("âŒ Error geocoding address:",e),hideLoadingIndicator(),void alert("We couldn't recognize that address. Please try a more specific address.")}updateLoadingMessage("Searching database...");let i=[];if(e.businessName&&""!==e.businessName.trim())try{i=await searchDatabaseWithFuzzyMatching(e,a,n),i=i.filter((e=>!0!==e.is_chain)),console.log(`ðŸ“Š PRIMARY RESULTS: Found ${i.length} businesses for "${e.businessName}"`)}catch(e){console.error("âŒ Primary search failed:",e)}let s=[];if(e.businessName&&a)try{updateLoadingMessage("Searching for additional locations...");const n={...a,searchRadius:Math.max(t,35)};s=await searchGooglePlacesForBusinessEnhanced(e.businessName,n),console.log(`ðŸ“Š PLACES RESULTS: Found ${s.length} additional "${e.businessName}" locations`)}catch(e){console.error("âŒ Places search failed:",e)}let r=[];const c=!e.businessName||i.length+s.length<8;if(a&&c)try{updateLoadingMessage("Finding other nearby businesses..."),r=await searchNearbyDatabaseBusinessesEnhanced(a,t,e.businessName),console.log(`ðŸ“Š NEARBY DATABASE: Found ${r.length} other nearby businesses`)}catch(e){console.error("âŒ Nearby database search failed:",e)}else console.log("â­ï¸ SKIPPING nearby search - found many relevant results");const{finalPrimaryResults:l,finalPlacesResults:d,finalNearbyResults:g}=categorizeResultsWithImprovedChainDetection(i,s,r),u=[...l,...d,...g];console.log("ðŸ“Š IMPROVED CHAIN SEARCH RESULTS:"),console.log(`   - ðŸ”´ Primary Database (RED): ${l.length} businesses`),console.log(`   - ðŸ”µ Additional Locations (BLUE): ${d.length} businesses`),console.log(`   - ðŸŸ¢ Other Nearby (GREEN): ${g.length} businesses`),console.log(`   - Total: ${u.length} businesses`),u.length>0?(l.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!0,e.markerColor="primary",e.priority=1})),d.forEach((e=>{e.isGooglePlace=!0,e.isFromDatabase=!1,e.isPrimaryResult=!1,e.isRelevantPlaces=!0,e.markerColor="nearby",e.priority=2})),g.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!1,e.isNearbyDatabase=!0,e.markerColor="database",e.priority=3})),hideLoadingIndicator(),displayBusinessesOnMapWithBetterPriority(u),displaySearchResultsWithBetterPriority(u),showImprovedSearchSuccessMessage(l.length,d.length,g.length,e.businessName),console.log("âœ… IMPROVED CHAIN SEARCH: Completed successfully with better duplicate detection")):(hideLoadingIndicator(),showNoResultsMessage())}catch(e){console.error("âŒ Improved chain search error:",e),hideLoadingIndicator(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}async function testImprovedChainDetection(){console.log("ðŸ§ª TESTING IMPROVED CHAIN DETECTION: Should eliminate Shag duplicates");const e={businessName:"Shag",address:"Cedar Rapids, IA",useMyLocation:!1};try{clearMarkers(),await performEnhancedBusinessSearchWithImprovedChainDetection(e,!0),console.log("âœ… Improved chain detection test completed - should show only database OR places results, not both!")}catch(e){console.error("âŒ Improved chain detection test failed:",e)}}document.addEventListener("DOMContentLoaded",(function(){setTimeout((()=>{initializeDatabaseStatistics()}),1e3)}));let loadingOverlay=null,loadingProgress=0,loadingSteps=[],currentStepIndex=0;function createLoadingOverlay(){return loadingOverlay&&document.body.contains(loadingOverlay)||(loadingOverlay=document.createElement("div"),loadingOverlay.id="patriot-loading-overlay",loadingOverlay.className="patriot-loading-overlay",loadingOverlay.innerHTML='\n        <div class="loading-backdrop"></div>\n        <div class="loading-container">\n            <div class="loading-content">\n                \x3c!-- Logo or Icon --\x3e\n                <div class="loading-logo">\n                    <img src="./images/patriotthankslogo6-13-2025.png" alt="Patriot Thanks" class="loading-logo-img">\n                </div>\n                \n                \x3c!-- Main Loading Animation --\x3e\n                <div class="loading-spinner-container">\n                    <div class="loading-spinner"></div>\n                    <div class="loading-spinner-ring"></div>\n                </div>\n                \n                \x3c!-- Loading Text --\x3e\n                <div class="loading-text">\n                    <h3 id="loading-title">Searching for Businesses</h3>\n                    <p id="loading-message">Please wait while we find the best results...</p>\n                </div>\n                \n                \x3c!-- Progress Bar --\x3e\n                <div class="loading-progress-container">\n                    <div class="loading-progress-bar">\n                        <div class="loading-progress-fill" id="loading-progress-fill"></div>\n                    </div>\n                    <div class="loading-progress-text">\n                        <span id="loading-step">Step 1 of 4</span>\n                        <span id="loading-percentage">0%</span>\n                    </div>\n                </div>\n                \n                \x3c!-- Loading Steps --\x3e\n                <div class="loading-steps">\n                    <div class="loading-step active" id="step-1">\n                        <div class="step-icon">ðŸ“</div>\n                        <div class="step-text">Processing Location</div>\n                    </div>\n                    <div class="loading-step" id="step-2">\n                        <div class="step-icon">ðŸ¢</div>\n                        <div class="step-text">Searching Database</div>\n                    </div>\n                    <div class="loading-step" id="step-3">\n                        <div class="step-icon">ðŸŒ</div>\n                        <div class="step-text">Finding Additional Locations</div>\n                    </div>\n                    <div class="loading-step" id="step-4">\n                        <div class="step-icon">ðŸ“Š</div>\n                        <div class="step-text">Organizing Results</div>\n                    </div>\n                </div>\n                \n                \x3c!-- Cancel Button (optional) --\x3e\n                <div class="loading-actions">\n                    <button class="loading-cancel-btn" onclick="hideLoadingOverlay()">\n                        Cancel Search\n                    </button>\n                </div>\n            </div>\n        </div>\n    '),loadingOverlay}function addLoadingOverlayStyles(){if(document.getElementById("loading-overlay-styles"))return;const e=document.createElement("style");e.id="loading-overlay-styles",e.textContent="\n        /* Loading Overlay Styles */\n        .patriot-loading-overlay {\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            z-index: 9999;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            opacity: 0;\n            visibility: hidden;\n            transition: opacity 0.3s ease, visibility 0.3s ease;\n        }\n\n        .patriot-loading-overlay.show {\n            opacity: 1;\n            visibility: visible;\n        }\n\n        .loading-backdrop {\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.75);\n            backdrop-filter: blur(4px);\n            -webkit-backdrop-filter: blur(4px);\n        }\n\n        .loading-container {\n            position: relative;\n            z-index: 1;\n            max-width: 400px;\n            width: 90%;\n            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);\n            border-radius: 16px;\n            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n            overflow: hidden;\n            transform: scale(0.9);\n            transition: transform 0.3s ease;\n        }\n\n        .patriot-loading-overlay.show .loading-container {\n            transform: scale(1);\n        }\n\n        .loading-content {\n            padding: 40px 30px 30px;\n            text-align: center;\n        }\n\n        /* Logo */\n        .loading-logo {\n            margin-bottom: 20px;\n        }\n\n        .loading-logo-img {\n            width: 60px;\n            height: 60px;\n            border-radius: 50%;\n            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n        }\n\n        /* Spinner Animation */\n        .loading-spinner-container {\n            position: relative;\n            width: 80px;\n            height: 80px;\n            margin: 20px auto;\n        }\n\n        .loading-spinner {\n            width: 60px;\n            height: 60px;\n            border: 4px solid #e3f2fd;\n            border-top: 4px solid #2196f3;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            position: absolute;\n            top: 10px;\n            left: 10px;\n        }\n\n        .loading-spinner-ring {\n            width: 80px;\n            height: 80px;\n            border: 2px solid transparent;\n            border-top: 2px solid #4caf50;\n            border-right: 2px solid #4caf50;\n            border-radius: 50%;\n            animation: spin 2s linear infinite reverse;\n            position: absolute;\n            top: 0;\n            left: 0;\n        }\n\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n\n        /* Loading Text */\n        .loading-text {\n            margin: 20px 0;\n        }\n\n        .loading-text h3 {\n            margin: 0 0 8px 0;\n            font-size: 20px;\n            font-weight: 600;\n            color: #1976d2;\n        }\n\n        .loading-text p {\n            margin: 0;\n            font-size: 14px;\n            color: #666;\n            line-height: 1.5;\n        }\n\n        /* Progress Bar */\n        .loading-progress-container {\n            margin: 20px 0;\n        }\n\n        .loading-progress-bar {\n            width: 100%;\n            height: 6px;\n            background-color: #e0e0e0;\n            border-radius: 3px;\n            overflow: hidden;\n            margin-bottom: 8px;\n        }\n\n        .loading-progress-fill {\n            height: 100%;\n            background: linear-gradient(90deg, #2196f3, #4caf50, #ff9800);\n            background-size: 200% 100%;\n            border-radius: 3px;\n            width: 0%;\n            transition: width 0.3s ease;\n            animation: progressShine 2s ease-in-out infinite;\n        }\n\n        @keyframes progressShine {\n            0% { background-position: 200% 0; }\n            100% { background-position: -200% 0; }\n        }\n\n        .loading-progress-text {\n            display: flex;\n            justify-content: space-between;\n            font-size: 12px;\n            color: #666;\n        }\n\n        /* Loading Steps */\n        .loading-steps {\n            display: flex;\n            justify-content: space-between;\n            margin: 24px 0;\n            padding: 0 10px;\n        }\n\n        .loading-step {\n            flex: 1;\n            text-align: center;\n            opacity: 0.4;\n            transition: opacity 0.3s ease, transform 0.3s ease;\n        }\n\n        .loading-step.active {\n            opacity: 1;\n            transform: scale(1.1);\n        }\n\n        .loading-step.completed {\n            opacity: 0.8;\n        }\n\n        .step-icon {\n            font-size: 24px;\n            margin-bottom: 8px;\n            filter: grayscale(100%);\n            transition: filter 0.3s ease;\n        }\n\n        .loading-step.active .step-icon,\n        .loading-step.completed .step-icon {\n            filter: grayscale(0%);\n        }\n\n        .step-text {\n            font-size: 11px;\n            color: #666;\n            font-weight: 500;\n            line-height: 1.2;\n        }\n\n        .loading-step.active .step-text {\n            color: #1976d2;\n            font-weight: 600;\n        }\n\n        /* Actions */\n        .loading-actions {\n            margin-top: 20px;\n            padding-top: 20px;\n            border-top: 1px solid #e0e0e0;\n        }\n\n        .loading-cancel-btn {\n            background: transparent;\n            border: 1px solid #ccc;\n            color: #666;\n            padding: 8px 16px;\n            border-radius: 6px;\n            cursor: pointer;\n            font-size: 12px;\n            transition: all 0.2s ease;\n        }\n\n        .loading-cancel-btn:hover {\n            background: #f5f5f5;\n            border-color: #999;\n            color: #333;\n        }\n\n        /* Responsive */\n        @media (max-width: 480px) {\n            .loading-container {\n                max-width: 350px;\n            }\n            \n            .loading-content {\n                padding: 30px 20px 20px;\n            }\n            \n            .loading-steps {\n                flex-wrap: wrap;\n                gap: 16px;\n            }\n            \n            .loading-step {\n                flex: 0 0 calc(50% - 8px);\n            }\n        }\n\n        /* Dark mode support */\n        @media (prefers-color-scheme: dark) {\n            .loading-container {\n                background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);\n            }\n            \n            .loading-text h3 {\n                color: #64b5f6;\n            }\n            \n            .loading-text p,\n            .loading-progress-text,\n            .step-text {\n                color: #ccc;\n            }\n            \n            .loading-step.active .step-text {\n                color: #64b5f6;\n            }\n            \n            .loading-actions {\n                border-color: #444;\n            }\n            \n            .loading-cancel-btn {\n                border-color: #666;\n                color: #ccc;\n            }\n            \n            .loading-cancel-btn:hover {\n                background: #333;\n                border-color: #888;\n                color: #fff;\n            }\n        }\n    ",document.head.appendChild(e)}function showLoadingOverlay(e={}){const{title:n="Searching for Businesses",message:o="Please wait while we find the best results...",steps:a=[{id:"step-1",text:"Processing Location",icon:"ðŸ“"},{id:"step-2",text:"Searching Database",icon:"ðŸ¢"},{id:"step-3",text:"Finding Additional Locations",icon:"ðŸŒ"},{id:"step-4",text:"Organizing Results",icon:"ðŸ“Š"}],showCancel:t=!0}=e;addLoadingOverlayStyles(),loadingOverlay&&document.body.contains(loadingOverlay)||(loadingOverlay=createLoadingOverlay(),document.body.appendChild(loadingOverlay));const i=document.getElementById("loading-title"),s=document.getElementById("loading-message"),r=loadingOverlay.querySelector(".loading-cancel-btn");i&&(i.textContent=n),s&&(s.textContent=o),r&&(r.style.display=t?"inline-block":"none"),loadingSteps=a,currentStepIndex=0,loadingProgress=0,updateLoadingProgress(0),loadingOverlay.classList.add("show"),a.length>0&&activateLoadingStep(0),console.log("âœ¨ Loading overlay shown")}function hideLoadingOverlay(){loadingOverlay&&(loadingOverlay.classList.remove("show"),setTimeout((()=>{loadingOverlay&&document.body.contains(loadingOverlay)&&(document.body.removeChild(loadingOverlay),loadingOverlay=null)}),300)),console.log("ðŸ”„ Loading overlay hidden")}function updateLoadingProgress(e,n=null){if(!loadingOverlay)return;loadingProgress=Math.max(0,Math.min(100,e));const o=document.getElementById("loading-progress-fill"),a=document.getElementById("loading-percentage"),t=document.getElementById("loading-message");o&&(o.style.width=`${loadingProgress}%`),a&&(a.textContent=`${Math.round(loadingProgress)}%`),n&&t&&(t.textContent=n),console.log(`ðŸ“Š Loading progress: ${loadingProgress}%${n?` - ${n}`:""}`)}function activateLoadingStep(e,n=null){if(!loadingOverlay||e>=loadingSteps.length)return;currentStepIndex=e,loadingOverlay.querySelectorAll(".loading-step").forEach(((n,o)=>{n.classList.remove("active","completed"),o<e?n.classList.add("completed"):o===e&&n.classList.add("active")}));const o=document.getElementById("loading-step");o&&(o.textContent=`Step ${e+1} of ${loadingSteps.length}`),updateLoadingProgress((e+1)/loadingSteps.length*100,n||loadingSteps[e]?.text||""),console.log(`ðŸ”„ Activated loading step ${e+1}: ${loadingSteps[e]?.text}`)}function nextLoadingStep(e=null){currentStepIndex<loadingSteps.length-1&&activateLoadingStep(currentStepIndex+1,e)}function showLoadingWithSteps(e,n,o=[]){showLoadingOverlay({title:e,message:n}),o.forEach(((e,n)=>{setTimeout((()=>{nextLoadingStep(e)}),1e3*(n+1))}))}async function performEnhancedBusinessSearchWithLoadingOverlay(e,n=!1){try{console.log("ðŸ” ENHANCED SEARCH WITH LOADING: Starting search with full-screen loading:",e),showLoadingOverlay({title:`Searching for ${e.businessName||"Businesses"}`,message:"Please wait while we find the best results in your area...",steps:[{id:"step-1",text:"Processing Location",icon:"ðŸ“"},{id:"step-2",text:"Searching Database",icon:"ðŸ¢"},{id:"step-3",text:"Finding Additional Locations",icon:"ðŸŒ"},{id:"step-4",text:"Organizing Results",icon:"ðŸ“Š"}],showCancel:!0}),await new Promise((e=>setTimeout(e,500))),activateLoadingStep(0,"Determining your search location...");let o=null,a=30;if(e.useMyLocation)try{updateLoadingProgress(10,"Getting your current location..."),o=await getUserLocation(),window.currentSearchLocation=o,updateLoadingProgress(20,"Location found successfully!")}catch(e){return console.error("âŒ Error getting user location:",e),hideLoadingOverlay(),void alert("Unable to get your current location. Please try entering an address instead.")}else if(e.address&&""!==e.address.trim())try{updateLoadingProgress(10,"Finding location for your address...");const n=await geocodeAddressClientSide(e.address);if(!(n&&n.lat&&n.lng))throw new Error(`Geocoding failed for address: ${e.address}`);if(o=n,window.currentSearchLocation=o,/^\d{5}$/.test(e.address.trim())?(a=25,console.log("ðŸ“ ZIP CODE SEARCH: Using 25km radius")):e.address.toLowerCase().includes("city")||e.address.split(",").length>=2?(a=30,console.log("ðŸ“ CITY SEARCH: Using 30km radius")):(a=20,console.log("ðŸ“ ADDRESS SEARCH: Using 20km radius")),map&&o){const e=new google.maps.LatLng(o.lat,o.lng);map.setCenter(e),map.setZoom(a<=20?12:11)}updateLoadingProgress(20,`Address found: ${n.formattedAddress||e.address}`)}catch(e){return console.error("âŒ Error geocoding address:",e),hideLoadingOverlay(),void alert("We couldn't recognize that address. Please try a more specific address.")}else updateLoadingProgress(20,"Using general search area...");nextLoadingStep("Searching our business database...");let t=[];if(e.businessName&&""!==e.businessName.trim())try{updateLoadingProgress(35,`Looking for "${e.businessName}" in our database...`),t=await searchDatabaseWithExpandedChainRadius(e,o,n),t=t.filter((e=>!0!==e.is_chain)),updateLoadingProgress(45,`Found ${t.length} matching businesses in database`),console.log(`ðŸ“Š PRIMARY RESULTS: Found ${t.length} businesses for "${e.businessName}"`)}catch(e){console.error("âŒ Primary search failed:",e),updateLoadingProgress(45,"Database search completed with some issues")}else updateLoadingProgress(45,"Skipping database search (no business name provided)");nextLoadingStep("Finding additional locations...");let i=[];if(e.businessName&&o)try{updateLoadingProgress(55,`Searching Google Places for "${e.businessName}"...`);const n={...o,searchRadius:Math.max(a,35)};i=await searchGooglePlacesForBusinessEnhanced(e.businessName,n),updateLoadingProgress(70,`Found ${i.length} additional locations via Google Places`),console.log(`ðŸ“Š PLACES RESULTS: Found ${i.length} additional "${e.businessName}" locations`)}catch(e){console.error("âŒ Places search failed:",e),updateLoadingProgress(70,"Additional location search completed")}else updateLoadingProgress(70,"Skipping additional location search");let s=[];const r=!e.businessName||e.businessName&&t.length<3;if(o&&r)try{updateLoadingProgress(75,"Finding other nearby businesses..."),s=await searchNearbyDatabaseBusinessesEnhanced(o,a,e.businessName),console.log(`ðŸ“Š NEARBY DATABASE: Found ${s.length} other nearby businesses`)}catch(e){console.error("âŒ Nearby database search failed:",e)}nextLoadingStep("Organizing your results..."),updateLoadingProgress(80,"Removing duplicates and organizing results...");const{finalPrimaryResults:c,finalPlacesResults:l,finalNearbyResults:d}=categorizeResultsWithImprovedChainDetection(t,i,s),g=[...c,...l,...d];updateLoadingProgress(90,`Preparing to display ${g.length} businesses...`),console.log("ðŸ“Š FINAL SEARCH RESULTS:"),console.log(`   - ðŸ”´ Primary Database: ${c.length} businesses`),console.log(`   - ðŸ”µ Additional Locations: ${l.length} businesses`),console.log(`   - ðŸŸ¢ Other Nearby: ${d.length} businesses`),g.length>0?(c.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!0,e.markerColor="primary",e.priority=1})),l.forEach((e=>{e.isGooglePlace=!0,e.isFromDatabase=!1,e.isPrimaryResult=!1,e.isRelevantPlaces=!0,e.markerColor="nearby",e.priority=2})),d.forEach((e=>{e.isGooglePlace=!1,e.isFromDatabase=!0,e.isPrimaryResult=!1,e.isNearbyDatabase=!0,e.markerColor="database",e.priority=3})),updateLoadingProgress(95,"Loading results on map and table..."),displayBusinessesOnMapWithBetterPriority(g),displaySearchResultsWithBetterPriority(g),updateLoadingProgress(100,"Search completed successfully!"),setTimeout((()=>{hideLoadingOverlay(),showImprovedSearchSuccessMessage(c.length,l.length,d.length,e.businessName)}),800),console.log("âœ… ENHANCED SEARCH WITH LOADING: Completed successfully")):(updateLoadingProgress(100,"No businesses found matching your criteria"),setTimeout((()=>{hideLoadingOverlay(),showNoResultsMessage()}),1e3))}catch(e){console.error("âŒ Enhanced search with loading error:",e),hideLoadingOverlay(),showErrorMessage(`Error searching for businesses: ${e.message}`)}}function enhanceFormSubmissionWithLoading(){const e=document.getElementById("business-search-form");if(!e)return;const n=e.cloneNode(!0);e.parentNode.replaceChild(n,e),n.addEventListener("submit",(async function(e){e.preventDefault();const n={businessName:document.getElementById("business-name")?.value||"",address:document.getElementById("address")?.value||"",useMyLocation:document.getElementById("use-my-location")?.checked||!1};if(!n.businessName&&!n.address&&!n.useMyLocation)return void alert("Please enter either a business name, an address, or use your current location to search");console.log("ðŸ” Form submitted with enhanced loading:",n),clearMarkers();const o=document.getElementById("initial-map-message");o&&o.remove();try{await performEnhancedBusinessSearchWithLoadingOverlay(n,!1)}catch(e){console.error("âŒ Form submission failed:",e),hideLoadingOverlay(),showErrorMessage("Search failed. Please try again.")}})),console.log("âœ… Enhanced form submission with loading overlay initialized")}async function testLoadingOverlay(){console.log("ðŸ§ª TESTING LOADING OVERLAY"),showLoadingOverlay({title:"Testing Loading System",message:"This is a test of the loading overlay...",showCancel:!0});const e=["Simulating location lookup...","Pretending to search database...","Fake Google Places search...","Organizing fake results..."];for(let n=0;n<e.length;n++)await new Promise((e=>setTimeout(e,1500))),nextLoadingStep(e[n]),updateLoadingProgress((n+1)/e.length*100);await new Promise((e=>setTimeout(e,1e3))),hideLoadingOverlay(),console.log("âœ… Loading overlay test completed")}async function loadCombinedIncentivesForTableCell(e,n=null){console.log(`ðŸŽ FIXED TABLE INCENTIVES: Loading for business ${e}, chain ${n}`);const o=document.getElementById(`incentives-for-${e}`);if(!o)return void console.error(`âŒ Table container not found: incentives-for-${e}`);o.innerHTML='<em style="color: #666;">â³ Loading all incentives...</em>';const a=getBaseURL();let t=[];try{console.log(`ðŸ“ Loading location-specific incentives for business ${e}`);try{const n=await fetch(`${a}/api/combined-api.js?operation=incentives&business_id=${e}`);if(n.ok){const o=await n.json();if(o.results&&o.results.length>0){const e=o.results.filter((e=>e.is_available)).map((e=>({...e,source:"location",scope:"Location only"})));t.push(...e),console.log(`âœ… Found ${e.length} location-specific incentives`)}else console.log(`â„¹ï¸ No location-specific incentives found for business ${e}`)}}catch(e){console.error("âŒ Error loading location-specific incentives:",e)}if(n){console.log(`ðŸ”— Loading chain-wide incentives for chain ${n}`);try{const o=await fetch(`${a}/api/chains.js?operation=get_incentives&chain_id=${n}`);if(o.ok){const a=await o.json();if(a.incentives&&a.incentives.length>0){const n=a.incentives.filter((e=>e.is_active)).map((n=>({_id:n._id,business_id:e,is_available:n.is_active,type:n.type,amount:n.amount,information:n.information,other_description:n.other_description,created_at:n.created_date,source:"chain",scope:"Chain-wide"})));t.push(...n),console.log(`âœ… Found ${n.length} chain-wide incentives`)}else console.log(`â„¹ï¸ No chain-wide incentives found for chain ${n}`)}}catch(e){console.error("âŒ Error loading chain-wide incentives:",e)}}if(console.log(`ðŸ“Š Total incentives found: ${t.length}`),0===t.length)return void(o.innerHTML='<em style="color: #666;">ðŸ’­ No incentives available</em>');t.sort(((e,n)=>"chain"===e.source&&"location"===n.source?-1:"location"===e.source&&"chain"===n.source?1:0));let i="";t.forEach((e=>{const n=getIncentiveTypeLabel(e.type),o=e.other_description?` (${e.other_description})`:"",a="chain"===e.source?'<span class="scope-badge-table chain-scope">â›“ï¸ Chain-wide</span>':'<span class="scope-badge-table location-scope">ðŸ“ Location only</span>';i+=`\n                <div class="table-incentive-item ${e.source}-incentive">\n                    <div class="table-incentive-header">\n                        <strong>${n}${o}:</strong> \n                        <span class="incentive-amount">${e.amount}%</span>\n                        ${a}\n                    </div>\n                    ${e.information?`<div class="table-incentive-info">${e.information}</div>`:""}\n                </div>\n            `})),o.innerHTML=i,console.log(`âœ… Successfully displayed ${t.length} combined incentives in table`)}catch(e){console.error("âŒ Error loading combined incentives for table:",e),o.innerHTML='<em style="color: #dc3545;">âŒ Error loading incentives</em>'}}function fetchCombinedBusinessIncentivesFixed(e,n=null){e&&!e.startsWith("google_")?(console.log(`ðŸŽ FIXED TABLE INCENTIVES: Fetching for business ID: ${e}`),console.log(`   - Chain ID: ${n||"None"}`),setTimeout((()=>{document.getElementById(`incentives-for-${e}`)?(console.log(`âœ… Found incentives cell for ${e}, loading combined incentives`),loadCombinedIncentivesForTableCell(e,n)):console.error(`âŒ Could not find incentives cell for business ${e}`)}),200)):console.log(`â­ï¸ Skipping incentives for Google Places business: ${e}`)}function addTableCombinedIncentivesStyles(){if(!document.getElementById("table-combined-incentives-styles")){const e=document.createElement("style");e.id="table-combined-incentives-styles",e.textContent="\n            /* Table-specific Combined Incentives Styles */\n            .table-incentive-item {\n                margin: 3px 0;\n                padding: 6px 8px;\n                border-radius: 4px;\n                border-left: 3px solid #ddd;\n                background-color: #f8f9fa;\n                font-size: 13px;\n                line-height: 1.3;\n            }\n\n            .table-incentive-item.chain-incentive {\n                border-left-color: #4285F4;\n                background-color: #e8f0fe;\n            }\n\n            .table-incentive-item.location-incentive {\n                border-left-color: #34a853;\n                background-color: #e8f5e8;\n            }\n\n            .table-incentive-header {\n                display: flex;\n                flex-wrap: wrap;\n                align-items: center;\n                gap: 4px;\n                margin-bottom: 2px;\n            }\n\n            .table-incentive-header strong {\n                color: #333;\n                font-size: 13px;\n            }\n\n            .incentive-amount {\n                color: #2e7d32;\n                font-weight: 600;\n                font-size: 14px;\n                margin-left: 4px;\n            }\n\n            .scope-badge-table {\n                font-size: 10px;\n                padding: 2px 4px;\n                border-radius: 6px;\n                font-weight: 500;\n                white-space: nowrap;\n                margin-left: 4px;\n            }\n\n            .scope-badge-table.chain-scope {\n                background-color: #4285F4;\n                color: white;\n            }\n\n            .scope-badge-table.location-scope {\n                background-color: #34a853;\n                color: white;\n            }\n\n            .table-incentive-info {\n                font-size: 11px;\n                color: #666;\n                font-style: italic;\n                margin-top: 2px;\n                line-height: 1.2;\n            }\n\n            /* Responsive table incentives */\n            @media (max-width: 768px) {\n                .table-incentive-header {\n                    flex-direction: column;\n                    align-items: flex-start;\n                    gap: 2px;\n                }\n                \n                .scope-badge-table {\n                    margin-left: 0;\n                }\n            }\n        ",document.head.appendChild(e)}}async function loadCombinedIncentivesForDatabaseBusiness(e,n,o=null){console.log(`ðŸŽ COMBINED INCENTIVES: Loading for business ${n}, chain ${o}`);const a=document.getElementById(`incentives-container-${e}`);if(!a)return void console.error(`âŒ Container not found: incentives-container-${e}`);a.innerHTML='<em style="color: #666;">â³ Loading all incentives...</em>';const t=getBaseURL();let i=[];try{console.log(`ðŸ“ Loading location-specific incentives for business ${n}`);try{const e=await fetch(`${t}/api/combined-api.js?operation=incentives&business_id=${n}`);if(e.ok){const o=await e.json();if(o.results&&o.results.length>0){const e=o.results.filter((e=>e.is_available)).map((e=>({...e,source:"location",scope:"Location only"})));i.push(...e),console.log(`âœ… Found ${e.length} location-specific incentives`)}else console.log(`â„¹ï¸ No location-specific incentives found for business ${n}`)}}catch(e){console.error("âŒ Error loading location-specific incentives:",e)}if(o){console.log(`ðŸ”— Loading chain-wide incentives for chain ${o}`);try{const e=await fetch(`${t}/api/chains.js?operation=get_incentives&chain_id=${o}`);if(e.ok){const a=await e.json();if(a.incentives&&a.incentives.length>0){const e=a.incentives.filter((e=>e.is_active)).map((e=>({_id:e._id,business_id:n,is_available:e.is_active,type:e.type,amount:e.amount,information:e.information,other_description:e.other_description,created_at:e.created_date,source:"chain",scope:"Chain-wide"})));i.push(...e),console.log(`âœ… Found ${e.length} chain-wide incentives`)}else console.log(`â„¹ï¸ No chain-wide incentives found for chain ${o}`)}}catch(e){console.error("âŒ Error loading chain-wide incentives:",e)}}if(console.log(`ðŸ“Š Total incentives found: ${i.length}`),0===i.length)return void(a.innerHTML='<em style="color: #666;">ðŸ’­ No incentives available</em>');i.sort(((e,n)=>"chain"===e.source&&"location"===n.source?-1:"location"===e.source&&"chain"===n.source?1:0));let e='<div class="incentives-header"><strong>ðŸŽ Available Incentives:</strong></div>';e+='<div class="combined-incentives-list">',i.forEach((n=>{const o=getIncentiveTypeLabel(n.type),a=n.other_description?` (${n.other_description})`:"",t="chain"===n.source?'<span class="scope-badge chain-scope">ðŸ”— Chain-wide</span>':'<span class="scope-badge location-scope">ðŸ“ Location only</span>';e+=`\n                <div class="combined-incentive-item ${n.source}-incentive">\n                    <div class="incentive-header">\n                        <div class="incentive-type-amount">\n                            <strong>${o}${a}:</strong> \n                            <span class="incentive-amount">${n.amount}%</span>\n                        </div>\n                        ${t}\n                    </div>\n                    ${n.information?`<div class="incentive-info">${n.information}</div>`:""}\n                </div>\n            `})),e+="</div>";const s=i.filter((e=>"chain"===e.source)).length,r=i.filter((e=>"location"===e.source)).length;s>0&&r>0&&(e+=`\n                <div class="incentives-summary">\n                    âœ¨ This location offers ${s} chain-wide incentive${1!==s?"s":""} \n                    plus ${r} location-specific incentive${1!==r?"s":""}!\n                </div>\n            `),a.innerHTML=e,console.log(`âœ… Successfully displayed ${i.length} combined incentives`)}catch(e){console.error("âŒ Error loading combined incentives:",e),a.innerHTML='<em style="color: #dc3545;">âŒ Error loading incentives</em>'}}async function loadCombinedIncentivesForInfoWindow(e,n,o=null){console.log(`ðŸªŸ INFO WINDOW COMBINED INCENTIVES: Loading for ${e}, business ${n}, chain ${o}`),document.getElementById(`incentives-container-${e}`)?await loadCombinedIncentivesForDatabaseBusiness(e,n,o):console.error(`âŒ Info window container not found: incentives-container-${e}`)}function fetchCombinedBusinessIncentives(e,n=null){e&&!e.startsWith("google_")?(console.log(`ðŸŽ TABLE COMBINED INCENTIVES: Fetching for business ID: ${e}`),console.log(`   - Chain ID: ${n||"None"}`),setTimeout((()=>{document.getElementById(`incentives-for-${e}`)?(console.log(`âœ… Found incentives cell for ${e}, loading combined incentives`),loadCombinedIncentivesForDatabaseBusiness(e,e,n)):console.error(`âŒ Could not find incentives cell for business ${e}`)}),200)):console.log(`â­ï¸ Skipping incentives for Google Places business: ${e}`)}function addCombinedIncentivesStyles(){if(!document.getElementById("combined-incentives-styles")){const e=document.createElement("style");e.id="combined-incentives-styles",e.textContent="\n            /* Combined Incentives Styles */\n            .combined-incentives-list {\n                margin: 8px 0;\n            }\n\n            .combined-incentive-item {\n                margin: 8px 0;\n                padding: 10px;\n                border-radius: 6px;\n                border-left: 4px solid #ddd;\n                background-color: #f8f9fa;\n                transition: all 0.2s ease;\n            }\n\n            .combined-incentive-item.chain-incentive {\n                border-left-color: #4285F4;\n                background-color: #e8f0fe;\n            }\n\n            .combined-incentive-item.location-incentive {\n                border-left-color: #34a853;\n                background-color: #e8f5e8;\n            }\n\n            .incentive-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: flex-start;\n                margin-bottom: 4px;\n            }\n\n            .incentive-type-amount {\n                flex: 1;\n                color: #333;\n                font-size: 14px;\n                line-height: 1.3;\n            }\n\n            .incentive-amount {\n                color: #2e7d32;\n                font-weight: 600;\n                font-size: 16px;\n            }\n\n            .scope-badge {\n                font-size: 11px;\n                padding: 2px 6px;\n                border-radius: 8px;\n                font-weight: 500;\n                white-space: nowrap;\n                margin-left: 8px;\n            }\n\n            .scope-badge.chain-scope {\n                background-color: #4285F4;\n                color: white;\n            }\n\n            .scope-badge.location-scope {\n                background-color: #34a853;\n                color: white;\n            }\n\n            .incentive-info {\n                font-size: 12px;\n                color: #666;\n                font-style: italic;\n                margin-top: 4px;\n                line-height: 1.3;\n            }\n\n            .incentives-summary {\n                margin-top: 12px;\n                padding: 8px;\n                background-color: #fff3e0;\n                border-radius: 4px;\n                font-size: 12px;\n                color: #ef6c00;\n                border-left: 3px solid #ff9800;\n                font-style: italic;\n            }\n\n            /* Table-specific styles */\n            .table-incentive.combined-incentive-item {\n                margin: 4px 0;\n                padding: 6px 8px;\n                font-size: 13px;\n            }\n\n            .table-incentive .incentive-header {\n                flex-direction: column;\n                align-items: flex-start;\n                gap: 2px;\n            }\n\n            .table-incentive .scope-badge {\n                font-size: 10px;\n                padding: 1px 4px;\n            }\n\n            .table-incentive .incentive-info {\n                font-size: 11px;\n                margin-top: 2px;\n            }\n\n            /* Info window specific styles */\n            .enhanced-info-window .combined-incentive-item {\n                margin: 6px 0;\n                padding: 8px;\n            }\n\n            .enhanced-info-window .incentive-header {\n                margin-bottom: 3px;\n            }\n\n            .enhanced-info-window .incentives-summary {\n                margin-top: 8px;\n                padding: 6px;\n                font-size: 11px;\n            }\n\n            /* Responsive adjustments */\n            @media (max-width: 768px) {\n                .incentive-header {\n                    flex-direction: column;\n                    align-items: flex-start;\n                    gap: 4px;\n                }\n\n                .scope-badge {\n                    margin-left: 0;\n                }\n            }\n        ",document.head.appendChild(e)}}function addBusinessRowWithCombinedIncentives(e,n,o){if(!e)return;if(!0===e.is_chain)return void console.log(`â­ï¸ Skipping parent chain business in table: ${e.bname}`);console.log(`ðŸ“ COMBINED INCENTIVES ROW: Adding row for: ${e.bname} (${o})`),console.log(`   - Business ID: ${e._id}`),console.log(`   - Chain ID: ${e.chain_id||"None"}`),console.log(`   - Is chain location: ${!!e.chain_id}`);let a="";if(e.address1)a=e.address2?`${e.address1}<br>${e.address2}<br>${e.city}, ${e.state} ${e.zip}`:`${e.address1}<br>${e.city}, ${e.state} ${e.zip}`;else{if(!e.formattedAddress)return void console.warn(`âŒ Business ${e.bname} has no address information`);a=e.formattedAddress.replace(/,/g,"<br>")}const t=getBusinessTypeLabel(e.type);let i="",s="";switch(o){case"primary":i='<span class="category-badge primary-badge">ðŸŽ¯ Search Result</span>',s="primary-result-row";break;case"database":i='<span class="category-badge database-badge">ðŸ¢ In Database</span>',s="database-result-row";break;case"places":i='<span class="category-badge places-badge">ðŸŒ Found Nearby</span>',s="places-result-row"}const r=e.chain_id?'<span class="chain-badge">ðŸ”— Chain Location</span>':"";let c;if("primary"===o||"database"===o)c=`<button class="view-map-btn ${o}" onclick="focusOnMapMarker('${e._id}')">ðŸ“ View on Map</button>`;else{const n=e._id||e.placeId;let o=e.chain_id?"ðŸ”— Add Chain Location":"âž• Add to Database",a=e.chain_id?`addBusinessToDatabase('${e.placeId}', '${e.chain_id}')`:`addBusinessToDatabase('${e.placeId}')`;c=`\n            <div class="dual-action-buttons">\n                <button class="view-map-btn places" onclick="focusOnGooglePlacesMarker('${n}')">ðŸ“ View on Map</button>\n                <button class="add-to-db-btn ${e.chain_id?"chain":""}" onclick="${a}">${o}</button>\n            </div>\n        `}const l=document.createElement("tr");l.className=`business-row ${s}`,l.innerHTML=`\n        <th class="left_table" data-business-id="${e._id}">\n            ${e.bname} ${r}\n            <div class="category-badges">${i}</div>\n        </th>\n        <th class="left_table">${a}</th>\n        <th class="left_table">${t}</th>\n        <th class="right_table" id="incentives-for-${e._id}">\n            ${"primary"===o||"database"===o?'<span class="loading-incentives">â³ Loading all incentives...</span>':"Not in database yet"}\n        </th>\n        <th class="center_table">${c}</th>\n    `,n.appendChild(l),"primary"===o||"database"===o?(console.log(`ðŸŽ COMBINED: Scheduling combined incentives load for ${o} business: ${e.bname}`),console.log(`   - Business ID: ${e._id}`),console.log(`   - Chain ID: ${e.chain_id||"None"}`),setTimeout((()=>{fetchCombinedBusinessIncentives(e._id,e.chain_id)}),100)):"places"===o&&e.chain_id&&(console.log(`ðŸ”— Scheduling chain incentives load for Places business: ${e.bname}`),fetchChainIncentivesForPlacesResult(e._id,e.chain_id))}function buildInfoWindowContentWithCombinedIncentives(e){const n=!0===e.isGooglePlace,o=!!e.chain_id,a=!0===e.isFromDatabase,t=!0===e.isNearbyDatabase,i=!0===e.isPrimaryResult;let s="";if(e.address1){s=`<div class="info-address">\n            <strong>ðŸ“ Address:</strong><br>\n            ${e.address1}`,e.address2&&(s+=`<br>${e.address2}`);const n=[];e.city&&n.push(e.city),e.state&&n.push(e.state),e.zip&&n.push(e.zip),n.length>0&&(s+=`<br>${n.join(", ")}`),s+="</div>"}else if(e.formattedAddress){const n=e.formattedAddress.split(",").map((e=>e.trim()));s='<div class="info-address">\n            <strong>ðŸ“ Address:</strong><br>',n.length>=1&&(s+=n[0]),n.length>=2&&(s+=`<br>${n.slice(1).join(", ")}`),s+="</div>"}const r=e.phone?`<div class="info-phone"><strong>ðŸ“ž Phone:</strong> <a href="tel:${e.phone.replace(/\D/g,"")}" style="color: #4285F4; text-decoration: none;">${e.phone}</a></div>`:"";let c="";e.type&&"OTHER"!==e.type&&(c=`<div class="info-type"><strong>ðŸ¢ Type:</strong> ${getBusinessTypeLabel(e.type)}</div>`);const l=e.distance?`<div class="info-distance"><strong>ðŸ“ Distance:</strong> ${(e.distance/1609).toFixed(1)} miles</div>`:"";let d="";o&&(d=`<span class="enhanced-chain-badge" style="background-color: ${i?"rgb(66, 133, 244, 0.3)":t?"rgb(40, 167, 69, 0.3)":"rgb(66, 133, 244, 0.3)"};">ðŸ”— ${e.chain_name||"Chain Location"}</span>`);let g,u="",h="";i?u='<div class="info-status primary-result">ðŸŽ¯ This business matches your search and is in the Patriot Thanks database.</div>':t?(u='<div class="info-status nearby-database">ðŸ¢ This business is in the Patriot Thanks database (found nearby).</div>',h='<div class="nearby-explanation">ðŸ’¡ This business appeared because it\'s in your search area and already in our database.</div>'):n&&o?(u='<div class="info-status chain-match">ðŸ”— This location appears to match a chain in our database!</div>',h=`<div class="chain-explanation">\n            âœ¨ Great news! This location matches <strong>${e.chain_name}</strong> in our database. \n            Chain-wide incentives should apply to this location once added.\n        </div>`):n&&(u='<div class="info-status google-place">â„¹ï¸ This business is not yet in the Patriot Thanks database.</div>'),a?g='\n            <div class="info-note">\n                <em>â„¹ï¸ This business is already in the Patriot Thanks database. Click anywhere outside to close.</em>\n            </div>\n        ':n&&o?g=`\n            <button class="enhanced-add-btn chain-add" onclick="window.addBusinessToDatabase('${e.placeId}', '${e.chain_id}')">\n                ðŸ”— Add ${e.chain_name} Location\n            </button>\n        `:n&&(g=`\n            <button class="enhanced-add-btn" onclick="window.addBusinessToDatabase('${e.placeId}')">\n                âž• Add to Patriot Thanks\n            </button>\n        `);const p=n?`google_${e.placeId}`:e._id;let m;return m=a&&o?"<em>â³ Loading chain and location incentives...</em>":a?"<em>â³ Loading location incentives...</em>":n&&o?"<em>â³ Loading chain incentives...</em>":"<em>ðŸ’¡ Add this business to see available incentives.</em>",`\n        <div class="enhanced-info-window category-aware">\n            <div class="info-header">\n                <h3>${e.bname} ${d}</h3>\n            </div>\n            \n            <div class="info-body">\n                ${s}\n                ${r}\n                ${c}\n                ${l}\n                ${u}\n                ${h}\n                \n                <div class="info-incentives">\n                    <div id="incentives-container-${p}">\n                        ${m}\n                    </div>\n                </div>\n            </div>\n            \n            <div class="info-actions">\n                ${g}\n            </div>\n        </div>\n    `}function showEnhancedInfoWindowWithCombinedIncentives(e){if(console.log("ðŸªŸ SAFARI FIX: Showing enhanced info window for:",e.business?.bname),!e||!e.business)return void console.error("âŒ Invalid marker for info window");const n=e.business,o=!0===n.isGooglePlace,a=!!n.chain_id,t=!0===n.isFromDatabase;function i(){infoWindow=new google.maps.InfoWindow({maxWidth:300,disableAutoPan:!1,zIndex:1e3});const i=buildInfoWindowContentWithCombinedIncentives(n);infoWindow.setContent(i);let s=null;try{e.getPosition&&"function"==typeof e.getPosition?s=e.getPosition():e.position&&(s=e.position),!s&&n.lat&&n.lng&&(s=new google.maps.LatLng(parseFloat(n.lat),parseFloat(n.lng)))}catch(e){console.warn("âš ï¸ Error getting marker position:",e),n.lat&&n.lng&&(s=new google.maps.LatLng(parseFloat(n.lat),parseFloat(n.lng)))}if(s){try{map.panTo(s)}catch(e){console.warn("âš ï¸ Error panning to position:",e)}setTimeout((()=>{try{e instanceof google.maps.Marker||e instanceof google.maps.marker.AdvancedMarkerElement?infoWindow.open(map,e):(infoWindow.setPosition(s),infoWindow.open(map)),console.log("âœ… Safari-compatible info window opened");const i=function(){console.log("ðŸ”„ Info window DOM ready on Safari"),setTimeout((()=>{applySafariInfoWindowFixes()}),100),setTimeout((()=>{loadIncentivesForSafari(o?`google_${n.placeId}`:n._id,n,t,a)}),300)};google.maps.event.addListenerOnce(infoWindow,"domready",i),setTimeout(i,500)}catch(o){console.error("âŒ Error opening info window on Safari:",o);try{new google.maps.InfoWindow({content:`<div style="padding: 10px;"><h4>${n.bname}</h4><p>Click for more details</p></div>`,maxWidth:250}).open(map,e),console.log("ðŸ“± Opened fallback info window for Safari")}catch(e){console.error("âŒ Even fallback info window failed:",e)}}}),150)}else console.error("âŒ Could not determine position for info window")}infoWindow?(infoWindow.close(),setTimeout((()=>{i()}),100)):i()}function applySafariInfoWindowFixes(){console.log("ðŸ”§ Applying Safari-specific info window fixes");try{const e=document.querySelector(".gm-style-iw-c"),n=document.querySelector(".gm-style-iw-d");if(!e)return void console.log("â„¹ï¸ Info window container not found - may not be rendered yet");e.style.width="auto",e.style.minWidth="280px",e.style.maxWidth="300px",e.style.height="auto",e.style.maxHeight="350px",e.style.display="block",e.style.visibility="visible",e.style.opacity="1",e.style.position="relative";const o=e.style.transform;if(o&&o.includes("translate")){console.log("ðŸ”„ Resetting problematic transform for Safari");const n=e.getBoundingClientRect();(n.width<50||n.top<0)&&(e.style.transform="none",e.style.left="auto",e.style.top="auto")}n&&(n.style.overflow="auto",n.style.maxHeight="300px",n.style.padding="0",n.style.width="auto");const a=document.querySelector(".gm-style-iw-t");a&&(a.style.position="absolute",a.style.bottom="0px",a.style.left="50%",a.style.transform="translateX(-50%)",a.style.width="20px",a.style.height="15px");const t=document.querySelector(".gm-ui-hover-effect");t&&(t.style.position="absolute",t.style.top="8px",t.style.right="8px",t.style.width="24px",t.style.height="24px",t.style.opacity="0.8",t.style.zIndex="1002",t.style.cursor="pointer",t.style.webkitTouchCallout="none",t.style.webkitUserSelect="none"),console.log("âœ… Safari info window fixes applied")}catch(e){console.error("âŒ Error applying Safari fixes:",e)}}function loadIncentivesForSafari(e,n,o,a){console.log(`ðŸŽ SAFARI: Loading incentives for ${e}`);try{o&&a?loadCombinedIncentivesForInfoWindow(e,n._id,n.chain_id):o?loadCombinedIncentivesForInfoWindow(e,n._id,null):n.isGooglePlace&&a&&loadChainIncentivesForEnhancedWindowFixed(e,n.chain_id)}catch(e){console.error("âŒ Error loading incentives on Safari:",e)}}function addSafariMarkerClickFix(){const e=window.createBusinessMarker;window.createBusinessMarker=function(n){const o=e(n);if(o&&o.content){const e=o.content,a=e.cloneNode(!0);e.parentNode.replaceChild(a,e),o.content=a;const t=function(e){e.preventDefault(),e.stopPropagation(),console.log(`ðŸ“± Safari marker clicked: ${n.bname}`),setTimeout((()=>{showEnhancedInfoWindowWithCombinedIncentives(o)}),50)};a.addEventListener("click",t,{passive:!1}),a.addEventListener("touchstart",t,{passive:!1}),a.style.webkitTouchCallout="none",a.style.webkitUserSelect="none",a.style.touchAction="manipulation",a.style.cursor="pointer"}return o}}function addSafariCompatibleCSS(){if(document.getElementById("safari-info-window-fix"))return;const e=document.createElement("style");e.id="safari-info-window-fix",e.textContent="\n        /* SAFARI iOS SPECIFIC FIXES */\n        \n        /* Force info window visibility on Safari */\n        .gm-style .gm-style-iw-c {\n            padding: 0 !important;\n            border-radius: 8px !important;\n            box-shadow: 0 2px 7px 1px rgba(0,0,0,0.3) !important;\n            width: auto !important;\n            min-width: 280px !important;\n            max-width: 300px !important;\n            max-height: 350px !important;\n            overflow: hidden !important;\n            position: relative !important;\n            display: block !important;\n            visibility: visible !important;\n            opacity: 1 !important;\n            /* Safari-specific fixes */\n            -webkit-transform: none !important;\n            transform: none !important;\n            will-change: auto !important;\n        }\n\n        .gm-style .gm-style-iw-d {\n            overflow: auto !important;\n            max-height: 300px !important;\n            padding: 0 !important;\n            width: auto !important;\n            min-width: 280px !important;\n            /* Safari scroll fix */\n            -webkit-overflow-scrolling: touch;\n        }\n\n        .gm-style .gm-style-iw {\n            display: block !important;\n            visibility: visible !important;\n            opacity: 1 !important;\n            position: relative !important;\n        }\n\n        /* Safari-specific tail fixes */\n        .gm-style .gm-style-iw-t {\n            position: absolute !important;\n            bottom: 0px !important;\n            left: 50% !important;\n            right: auto !important;\n            top: auto !important;\n            transform: translateX(-50%) !important;\n            -webkit-transform: translateX(-50%) !important;\n            width: 20px !important;\n            height: 15px !important;\n            margin: 0 !important;\n        }\n\n        /* Safari close button fix */\n        .gm-ui-hover-effect {\n            opacity: 0.8 !important;\n            width: 24px !important;\n            height: 24px !important;\n            right: 8px !important;\n            top: 8px !important;\n            z-index: 1002 !important;\n            position: absolute !important;\n            cursor: pointer !important;\n            /* Safari touch improvements */\n            -webkit-touch-callout: none !important;\n            -webkit-user-select: none !important;\n            touch-action: manipulation !important;\n        }\n\n        /* Safari marker improvements */\n        .enhanced-custom-marker,\n        .custom-marker {\n            cursor: pointer !important;\n            /* Safari touch improvements */\n            -webkit-touch-callout: none !important;\n            -webkit-user-select: none !important;\n            touch-action: manipulation !important;\n        }\n\n        /* Enhanced info window content for Safari */\n        .enhanced-info-window {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            max-width: 280px;\n            line-height: 1.4;\n            padding: 12px !important;\n            margin: 0;\n            box-sizing: border-box;\n            /* Safari-specific improvements */\n            -webkit-text-size-adjust: 100%;\n            text-size-adjust: 100%;\n        }\n\n        /* Safari button improvements */\n        .enhanced-add-btn, \n        .enhanced-view-btn,\n        .add-business-btn,\n        .view-details-btn {\n            /* Safari touch improvements */\n            -webkit-touch-callout: none !important;\n            -webkit-user-select: none !important;\n            touch-action: manipulation !important;\n            cursor: pointer !important;\n            /* Prevent zoom on double-tap */\n            touch-action: manipulation !important;\n        }\n\n        /* Safari-specific responsive fixes */\n        @media screen and (max-width: 480px) {\n            .gm-style .gm-style-iw-c {\n                max-width: 250px !important;\n                min-width: 250px !important;\n            }\n            \n            .enhanced-info-window {\n                max-width: 230px;\n                padding: 10px !important;\n            }\n        }\n\n        /* Fix for Safari viewport issues */\n        @supports (-webkit-touch-callout: none) {\n            .gm-style .gm-style-iw-c {\n                /* Additional Safari-only fixes */\n                backface-visibility: hidden;\n                -webkit-backface-visibility: hidden;\n                perspective: 1000px;\n                -webkit-perspective: 1000px;\n            }\n        }\n    ",document.head.appendChild(e),console.log("ðŸ“± Added Safari-compatible CSS")}function initSafariInfoWindowFixes(){console.log("ðŸ“± Initializing Safari info window fixes"),addSafariCompatibleCSS(),addSafariMarkerClickFix(),window.showInfoWindow,window.showInfoWindow=function(e){console.log("ðŸ“± Safari showInfoWindow called"),showEnhancedInfoWindowWithCombinedIncentives(e)},console.log("âœ… Safari fixes initialized")}function detectAndFixSafari(){const e=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),n=/iPad|iPhone|iPod/.test(navigator.userAgent);if((e||n)&&(console.log("ðŸ“± Safari or iOS detected, applying fixes"),initSafariInfoWindowFixes(),n)){console.log("ðŸ“± iOS detected, applying additional mobile fixes");const e=document.querySelector('meta[name="viewport"]');e&&e.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"),document.addEventListener("touchstart",(function(){}),{passive:!0})}}async function testCombinedIncentives(){console.log("ðŸ§ª TESTING COMBINED INCENTIVES: Should show both chain and location incentives");const e={businessName:"Hy-Vee Fast & Fresh",address:"Cedar Rapids, IA",useMyLocation:!1};try{clearMarkers(),await performEnhancedBusinessSearchWithLoadingOverlay(e,!0),console.log("âœ… Combined incentives test completed - should show ALL incentives for Hy-Vee Fast & Fresh!")}catch(e){console.error("âŒ Combined incentives test failed:",e)}}document.addEventListener("DOMContentLoaded",(function(){addLoadingOverlayStyles(),setTimeout((()=>{enhanceFormSubmissionWithLoading()}),1e3)})),document.addEventListener("DOMContentLoaded",(function(){addCombinedIncentivesStyles()})),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeStableMarkerSystem):initializeStableMarkerSystem(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",detectAndFixSafari):detectAndFixSafari(),document.addEventListener("DOMContentLoaded",(function(){addTableCombinedIncentivesStyles()})),"undefined"!=typeof document&&addDualActionButtonStyles(),"undefined"!=typeof window&&(window.loadCombinedIncentivesForTableCell=loadCombinedIncentivesForTableCell,window.fetchCombinedBusinessIncentivesFixed=fetchCombinedBusinessIncentivesFixed,window.addTableCombinedIncentivesStyles=addTableCombinedIncentivesStyles,window.fetchCombinedBusinessIncentives=fetchCombinedBusinessIncentivesFixed,window.fetchBusinessIncentives=fetchCombinedBusinessIncentivesFixed,window.fetchBusinessIncentivesFixed=fetchCombinedBusinessIncentivesFixed,window.buildInfoWindowContentWithCombinedIncentives=buildInfoWindowContentWithCombinedIncentives,window.showEnhancedInfoWindowWithCombinedIncentives=showEnhancedInfoWindowWithCombinedIncentives,window.testCombinedIncentives=testCombinedIncentives,window.buildCategoryAwareInfoWindowContent=buildInfoWindowContentWithCombinedIncentives,window.buildCategoryAwareInfoWindowContentEnhanced=buildInfoWindowContentWithCombinedIncentives,window.buildEnhancedInfoWindowContent=buildInfoWindowContentWithCombinedIncentives,window.showEnhancedInfoWindow=showEnhancedInfoWindowWithCombinedIncentives,window.showEnhancedInfoWindowWithCategory=showEnhancedInfoWindowWithCombinedIncentives,window.showEnhancedInfoWindowFixed2=showEnhancedInfoWindowWithCombinedIncentives,window.loadCombinedIncentivesForDatabaseBusiness=loadCombinedIncentivesForDatabaseBusiness,window.loadCombinedIncentivesForInfoWindow=loadCombinedIncentivesForInfoWindow,window.addCombinedIncentivesStyles=addCombinedIncentivesStyles,window.addBusinessRowWithCombinedIncentives=addBusinessRowWithCombinedIncentives,window.addBusinessRow=addBusinessRowWithCombinedIncentives,window.addCategorizedBusinessRow=addBusinessRowWithCombinedIncentives,window.loadChainIncentivesForDatabaseBusinessFixed=loadCombinedIncentivesForInfoWindow,window.loadIncentivesForEnhancedWindowFixed=loadCombinedIncentivesForInfoWindow,window.searchDatabaseWithExpandedChainRadius=searchDatabaseWithExpandedChainRadius,window.calculateDistance=calculateDistance,window.performEnhancedBusinessSearchWithExpandedChainRadius=performEnhancedBusinessSearchWithExpandedChainRadius,window.testExpandedChainRadius=testExpandedChainRadius,window.performEnhancedBusinessSearchWithLoadingOverlay=performEnhancedBusinessSearchWithLoadingOverlay,window.enhanceFormSubmissionWithLoading=enhanceFormSubmissionWithLoading,window.testLoadingOverlay=testLoadingOverlay,window.searchDatabaseWithFuzzyMatching=searchDatabaseWithExpandedChainRadius,window.retrieveFromMongoDB=performEnhancedBusinessSearchWithLoadingOverlay,window.performEnhancedBusinessSearch=performEnhancedBusinessSearchWithLoadingOverlay,window.createEnhancedAddressKeyFixed=createEnhancedAddressKeyFixed,window.createBusinessNameKeyFixed=createBusinessNameKeyFixed,window.isChainVariationName=isChainVariationName,window.normalizeChainName=normalizeChainName,window.categorizeResultsWithImprovedChainDetection=categorizeResultsWithImprovedChainDetection,window.performEnhancedBusinessSearchWithImprovedChainDetection=performEnhancedBusinessSearchWithImprovedChainDetection,window.testImprovedChainDetection=testImprovedChainDetection,window.performEnhancedBusinessSearchWithNearbyFixed=performEnhancedBusinessSearchWithNearbyFixed,window.searchNearbyDatabaseBusinessesWithDebugging=searchNearbyDatabaseBusinessesWithDebugging,window.testNearbySearchFix=testNearbySearchFix,window.debugNearbySearchOnly=debugNearbySearchOnly,window.searchNearbyDatabaseBusinessesEnhanced=searchNearbyDatabaseBusinessesWithDebugging,window.performEnhancedBusinessSearchWithFixedDuplicates=performEnhancedBusinessSearchWithFixedDuplicates,window.testFixedOliveGardenSearch=testFixedOliveGardenSearch,window.searchGooglePlacesForBusinessEnhanced=searchGooglePlacesForBusinessEnhanced,window.processPlacesResults=processPlacesResults,window.debugLasVegasOliveGardenSearch=debugLasVegasOliveGardenSearch,window.testOliveGardenLasVegas=testOliveGardenLasVegas,window.searchGooglePlacesForBusiness=searchGooglePlacesForBusinessEnhanced,window.searchNearbyDatabaseBusinesses=searchNearbyDatabaseBusinessesEnhanced,window.categorizeResultsWithBetterPriority=categorizeResultsWithBetterPriority,window.displaySearchResultsWithBetterPriority=displaySearchResultsWithBetterPriority,window.displayBusinessesOnMapWithBetterPriority=displayBusinessesOnMapWithBetterPriority,window.showImprovedSearchSuccessMessage=showImprovedSearchSuccessMessage,window.searchGooglePlacesForBusinessWithRadius=searchGooglePlacesForBusinessWithRadius,window.displayBusinessesOnMap=displayBusinessesOnMapWithCategories,window.displaySearchResults=displaySearchResultsWithCategories,window.displayBusinessesOnMapFixed=displayBusinessesOnMapWithCategories,window.displaySearchResultsFixed=displaySearchResultsWithCategories,window.categorizeFinalResults=categorizeFinalResults,window.createAddressKey=createAddressKey,window.createEnhancedBusinessMarkerWithCategory=createEnhancedBusinessMarkerWithCategory,window.createCategorizedBusinessMarker=createCategorizedBusinessMarker,window.addTableSectionHeader=addTableSectionHeader,window.showEnhancedSearchSuccessMessage=showEnhancedSearchSuccessMessage,window.updateMapLegendWithCategories=updateMapLegendWithCategories,window.testCategorizedSearch=testCategorizedSearch,window.getApproximateLocation=getApproximateLocation,window.showUserFriendlyError=showUserFriendlyError,window.showSearchSuccessMessage=showSearchSuccessMessage,window.clearSearchForm=clearSearchForm,window.createDebugDashboard=createDebugDashboard,window.checkMapMarkers=checkMapMarkers,window.emergencyReset=emergencyReset,window.updateDebugStatus=updateDebugStatus,window.addEnhancedUserInterfaceCSS=addEnhancedUserInterfaceCSS,window.findMatchingChainForPlaceResult=findMatchingChainForPlaceResultFixed,window.findMatchingChainLocallyEnhanced=findMatchingChainLocallyEnhanced,window.tryServerSideChainMatchingOptimized=tryServerSideChainMatchingOptimized,window.clearChainMatchCache=clearChainMatchCache,window.getChainMatchCacheStatus=getChainMatchCacheStatus,window.loadChainIncentivesForEnhancedWindow=loadChainIncentivesForEnhancedWindowFixed,window.loadIncentivesForEnhancedWindow=loadIncentivesForEnhancedWindowFixed,window.loadChainIncentivesForDatabaseBusiness=loadChainIncentivesForDatabaseBusinessFixed,window.createBusinessMarker=createBusinessMarker,window.createEnhancedBusinessMarkerFixed=createEnhancedBusinessMarkerFixed,window.addBusinessRowFixed=addBusinessRowFixed,window.supplementWithGooglePlaces=supplementWithGooglePlaces,window.createBusinessMarker=createBusinessMarker,window.hasValidCoordinates=hasValidCoordinates,window.checkForNewlyAddedBusiness=checkForNewlyAddedBusiness,window.updateLoadingMessage=updateLoadingMessage,window.hideLoadingIndicator=hideLoadingIndicator,window.showNoResultsMessage=showNoResultsMessage,window.showErrorMessage=showErrorMessage,window.addEnhancedLoadingCSS=addEnhancedLoadingCSS,window.calculateSimilarity=calculateSimilarity,window.extractKeywords=extractKeywords,window.generateNameVariations=generateNameVariations,window.tryServerSideChainMatching=tryServerSideChainMatching,window.getChainFromDatabase=getChainFromDatabase,window.searchGooglePlacesForBusinessLegacy=searchGooglePlacesForBusinessLegacy,window.loadChainIncentivesInContainer=loadChainIncentivesInContainer,window.generateNameVariations=generateNameVariations,window.findMatchingChainLocally=findMatchingChainLocally,window.initGoogleMap=initGoogleMap,window.debugMapState=debugMapState,window.validateField=validateField,window.isNotEmpty=isNotEmpty,window.setupMapClickHandler=setupMapClickHandler,window.buildInfoWindowContent=buildInfoWindowContent,window.getPlaceTypeLabel=getPlaceTypeLabel,window.safeExtractCoordinates=safeExtractCoordinates,window.showInfoWindow=showInfoWindow,window.fixInfoWindowPositioning=fixInfoWindowPositioning,window.withErrorHandling=withErrorHandling,window.createEnhancedBusinessMarker=createEnhancedBusinessMarker,window.showEnhancedInfoWindow=showEnhancedInfoWindow,window.buildEnhancedInfoWindowContent=buildEnhancedInfoWindowContent,window.addEnhancedMarkerStyles=addEnhancedMarkerStyles,window.getBusinessTypeTextIcon=getBusinessTypeTextIcon,window.createEnhancedFallbackMarker=createEnhancedFallbackMarker,window.createEnhancedBusinessMarker=createEnhancedBusinessMarker,window.addEnhancedMarkerStyles=addEnhancedMarkerStyles,window.searchNearbyBusinesses=searchNearbyBusinesses,window.getSimilarBusinessTypes=getSimilarBusinessTypes,window.getBusinessLocation=getBusinessLocation,window.createSimilarBusinessMarker=createSimilarBusinessMarker,window.COMPREHENSIVE_CHAIN_DATABASE=COMPREHENSIVE_CHAIN_DATABASE_UPDATED,window.COMPREHENSIVE_CHAIN_DATABASE_UPDATED=COMPREHENSIVE_CHAIN_DATABASE_UPDATED,window.ENHANCED_CONFIG=ENHANCED_CONFIG,window.loadDatabaseStatistics=loadDatabaseStatistics,window.refreshDatabaseStatistics=refreshDatabaseStatistics,window.initializeDatabaseStatistics=initializeDatabaseStatistics,window.databaseStats=databaseStats,window.showLoadingOverlay=showLoadingOverlay,window.hideLoadingOverlay=hideLoadingOverlay,window.updateLoadingProgress=updateLoadingProgress,window.activateLoadingStep=activateLoadingStep,window.nextLoadingStep=nextLoadingStep,window.showLoadingWithSteps=showLoadingWithSteps,window.addLoadingOverlayStyles=addLoadingOverlayStyles,addEnhancedUserInterfaceCSS(),addEnhancedTableChainStyles());