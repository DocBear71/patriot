document.addEventListener("DOMContentLoaded",(function(){console.log("Profile manager loaded!");const e=document.getElementById("profile-form"),t=document.getElementById("profile-container"),o=document.getElementById("not-logged-in"),n=document.getElementById("change-password-btn"),s=document.getElementById("save-password-btn"),a=document.getElementById("cancel-btn"),l=document.getElementById("login-link"),d=document.getElementById("new-password"),i=document.getElementById("confirm-new-password"),c=document.getElementById("pwd-letter"),r=document.getElementById("pwd-capital"),u=document.getElementById("pwd-number"),m=document.getElementById("pwd-length"),v=document.getElementById("pwd-special"),g=document.getElementById("pwd-match");function f(){t&&(t.style.display="none"),o&&(o.style.display="block")}function p(){const e=d.value;e===i.value&&""!==e?(g.classList.remove("invalid"),g.classList.add("valid")):(g.classList.remove("valid"),g.classList.add("invalid"))}(function(){const e=localStorage.getItem("patriotThanksSession");if(e)try{const n=JSON.parse(e);if((new Date).getTime()<n.timestamp+n.expiresIn)return function(e){console.log("Loading user profile with data: ",e);const n=document.getElementById("fname");n?(console.log("Found fname element, setting to: ",e.fname||""),n.value=e.fname||""):console.error("Element with ID fname not found");const s=document.getElementById("lname");s?(console.log("Found lname element, setting to: ",e.lname||""),s.value=e.lname||""):console.error("Element with ID lname not found");const a=document.getElementById("address1");a?(console.log("Found address1 element, setting to: ",e.address1||""),a.value=e.address1||""):console.error("Element with ID address1 not found");const l=document.getElementById("address2");l?(console.log("Found address2 element, setting to: ",e.address2||""),l.value=e.address2||""):console.error("Element with ID address2 not found");const d=document.getElementById("city");d?(console.log("Found city element, setting to: ",e.city||""),d.value=e.city||""):console.error("Element with ID city not found");const i=document.getElementById("state");i?(console.log("Found state element, setting to: ",e.state||""),i.value=e.state||""):console.error("Element with ID state not found");const c=document.getElementById("zip");c?(console.log("Found zip element, setting to: ",e.zip||""),c.value=e.zip||""):console.error("Element with ID zip not found");const r=document.getElementById("status");r?(console.log("Found status element, setting to: ",e.status||""),r.value=e.status||""):console.error("Element with ID status not found");const u=document.getElementById("membership-level");u?(console.log("Found level element, setting to: ",e.level||""),u.value=e.level||""):console.error("Element with ID level not found");const m=document.getElementById("email");if(m?(console.log("Found email element, setting to: ",e.email||""),m.value=e.email||""):console.error("Element with ID email not found"),t&&(t.style.display="block"),o&&(o.style.display="none"),e){if(document.getElementById("fname").value=e.fname||"",document.getElementById("lname").value=e.lname||"",document.getElementById("address1").value=e.address1||"",document.getElementById("address2").value=e.address2||"",document.getElementById("city").value=e.city||"",document.getElementById("email").value=e.email||"",document.getElementById("zip").value=e.zip||"",e.state&&(document.getElementById("state").value=e.state),e.status){const t=document.getElementById("status");t.value=e.status,t.value!==e.status&&(console.log("Status not found in the options, default to first option"),t.selectedIndex=0)}if(e.level){const t=document.getElementById("membership-level");t.value=e.level,t.value!==e.level&&(console.log("Membership level not found in the options, default to first option"),t.selectedIndex=0)}}}(n.user),!0;f(),localStorage.removeItem("patriotThanksSession")}catch(e){console.error("Error parsing session data:",e),f(),localStorage.removeItem("patriotThanksSession")}else f();return!1})()&&(console.log("User is logged in, fetching profile data"),async function(){try{const t=localStorage.getItem("patriotThanksSession");if(!t)return void console.error("No session data found");const o=JSON.parse(t).user._id;console.log("Fetching profile data for user:",o);const n=`${window.location.origin}/api/user-donations/user.js?operation=profile${o}`,s=await fetch(n,{method:"GET",headers:{"Content-Type":"application/json"}});if(!s.ok)throw new Error(`Failed to fetch profile: ${s.status}`);const a=await s.json();console.log("Received profile data:",a),a.user&&(e=a.user,console.log("Populating form with data:",e),["_id","fname","lname","address1","address2","city","zip","email","status","level"].forEach((t=>{const o=document.getElementById(t);o?(o.value=e[t]||"",console.log(`Set ${t} to:`,o.value)):console.error(`Element with ID '${t}' not found`)})),["state","status","membership-level"].forEach((t=>{const o=document.getElementById(t);if(o){const n=e[{state:"state",status:"status","membership-level":"level"}[t]];n&&(o.value=n,console.log(`Tried to set ${t} to:`,n),console.log("Actual value after setting:",o.value),o.value!==n&&(console.log(`Value ${n} not found in options for ${t}`),o.selectedIndex=0))}else console.error(`Dropdown with ID '${t}' not found`)})))}catch(e){console.error("Error fetching user profile:",e)}var e}()),e&&e.addEventListener("submit",(function(e){e.preventDefault(),async function(){const e=localStorage.getItem("patriotThanksSession");if(!e)return void alert("You must be logged in to update your profile.");const t=JSON.parse(e),o=t.user,n={_id:o._id,fname:document.getElementById("fname").value,lname:document.getElementById("lname").value,address1:document.getElementById("address1").value,address2:document.getElementById("address2").value,city:document.getElementById("city").value,state:document.getElementById("state").value,zip:document.getElementById("zip").value,status:document.getElementById("status").value,email:o.email};try{const e=`${window.location.origin}/api/user-donations/user.js?operation=update`,s=await fetch(e,{method:"PUT",headers:{"Content-Type":"application/json; charset=UTF-8"},body:JSON.stringify(n)});if(!s.ok){const e=await s.text();throw new Error(`Profile update failed: ${s.status} ${e}`)}const a=await s.json();console.log("Profile update successful:",a),t.user={...o,...n},localStorage.setItem("patriotThanksSession",JSON.stringify(t)),alert("Your profile has been updated successfully!")}catch(e){console.error("Error:",e),alert("Profile update failed: "+e.message)}}()})),n&&n.addEventListener("click",(function(){document.getElementById("current-password").value="",d.value="",i.value="",c.classList.remove("valid"),c.classList.add("invalid"),r.classList.remove("valid"),r.classList.add("invalid"),u.classList.remove("valid"),u.classList.add("invalid"),m.classList.remove("valid"),m.classList.add("invalid"),v.classList.remove("valid"),v.classList.add("invalid"),g.classList.remove("valid"),g.classList.add("invalid"),$("#passwordModal").modal("show")})),s&&s.addEventListener("click",(function(){!async function(){if(!function(){const e=c.classList.contains("valid"),t=r.classList.contains("valid"),o=u.classList.contains("valid"),n=m.classList.contains("valid"),s=v.classList.contains("valid"),a=g.classList.contains("valid");return!!(e&&t&&o&&n&&s&&a)||(alert("Please ensure your password meets all the requirements."),!1)}())return;const e=localStorage.getItem("patriotThanksSession");if(!e)return void alert("You must be logged in to change your password.");const t=JSON.parse(e).user,o={userId:t._id,email:t.email,currentPassword:document.getElementById("current-password").value,newPassword:document.getElementById("new-password").value};try{const e=`${window.location.origin}/api/user-donations/user.js?operation=password`,t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(o)});if(!t.ok){const e=await t.text();throw new Error(`Password change failed: ${t.status} ${e}`)}const n=await t.json();console.log("Password change successful:",n),$("#passwordModal").modal("hide"),alert("Your password has been changed successfully!")}catch(e){console.error("Error:",e),alert("Password change failed: "+e.message)}}()})),a&&a.addEventListener("click",(function(){window.location.href="./index.html"})),l&&l.addEventListener("click",(function(e){e.preventDefault(),window.scrollTo(0,0);const t=document.querySelector(".btn-group.dropdown-menu-right .btn.dropdown-toggle");t&&t.click()})),d&&i&&(d.addEventListener("keyup",(function(){!function(){const e=d.value;e.match(/[a-z]/g)?(c.classList.remove("invalid"),c.classList.add("valid")):(c.classList.remove("valid"),c.classList.add("invalid"));e.match(/[A-Z]/g)?(r.classList.remove("invalid"),r.classList.add("valid")):(r.classList.remove("valid"),r.classList.add("invalid"));e.match(/[0-9]/g)?(u.classList.remove("invalid"),u.classList.add("valid")):(u.classList.remove("valid"),u.classList.add("invalid")),e.length>=8?(m.classList.remove("invalid"),m.classList.add("valid")):(m.classList.remove("valid"),m.classList.add("invalid")),/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/.test(e)?(v.classList.remove("invalid"),v.classList.add("valid")):(v.classList.remove("valid"),v.classList.add("invalid"))}(),p()})),i.addEventListener("keyup",(function(){p()})))}));