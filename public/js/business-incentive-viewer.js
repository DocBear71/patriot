function populateBusinessInfo(n){if(n){console.log("Populating business info with: ",n);try{const e=document.getElementById("bname");e?(console.log(`Setting bname to ${n.bname||""}`),e.value=n.bname||""):console.warn("Field bname not found in the DOM");const t=document.getElementById("address1");t?(console.log(`Setting address1 to ${n.address1||""}`),t.value=n.address1||""):console.warn("Field address1 not found in the DOM");const i=document.getElementById("address2");i?(console.log(`Setting address2 to ${n.address2||""}`),i.value=n.address2||""):console.warn("Field address2 not found in the DOM");const o=document.getElementById("city");o?(console.log(`Setting city to ${n.city||""}`),o.value=n.city||""):console.warn("Field city not found in the DOM");const s=document.getElementById("zip");s?(console.log(`Setting zip to ${n.zip||""}`),s.value=n.zip||""):console.warn("Field zip not found in the DOM");const c=document.getElementById("phone");c?(console.log(`Setting phone to ${n.phone||""}`),c.value=n.phone||""):console.warn("Field phone not found in the DOM");const a=document.getElementById("state");if(a){const e=n.state||"";console.log(`Setting state to ${e}`);for(let n=0;n<a.options.length;n++)if(a.options[n].value===e){a.selectedIndex=n;break}}else console.warn("Field state not found in the DOM");const d=document.getElementById("type");if(d){const e=n.type||"";console.log(`Setting type to ${e}`);for(let n=0;n<d.options.length;n++)if(d.options[n].value===e){d.selectedIndex=n;break}}else console.warn("Field type not found in the DOM");console.log("Business info populated successfully")}catch(n){console.error("Error in populateBusinessInfo",n)}}else console.error("No business data provided to populateBusinessInfo")}function fetchIncentives(n,e){let t=document.getElementById("incentives-container");if(!t){console.log("creating the incentives container"),t=document.createElement("div"),t.id="incentives-container";const n=document.getElementById("business-info-section");if(n&&n.parentNode)n.parentNode.insertBefore(t,n.nextSibling);else{const n=document.querySelector("main");n?n.appendChild(t):document.body.appendChild(t)}}t.innerHTML="<p>Loading incentives...</p>",console.log("Fetching incentives for business ID: ",n);const i=`${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:window.location.origin}/api/combined-api.js?operation=incentives&business_id=${n}`;console.log("Fetching from URL: ",i),fetch(i).then((n=>{if(!n.ok)throw new Error(`Failed to fetch incentives: ${n.status} ${n.statusText}`);return n.json()})).then((n=>{console.log("Incentives data received: ",n);let i=`\n                    <fieldset id="incentives-section">\n                        <legend>\n                            <h3 class="caveat">Step 3: View Incentives for ${e}</h3>\n                        </legend>\n                `;n.results&&0!==n.results.length?(i+='\n                        <table class="results-table">\n                            <thead>\n                                <tr>\n                                    <th>Available</th>\n                                    <th>Type</th>\n                                    <th>Amount (%)</th>\n                                    <th>Information</th>\n                                    <th>Date Added</th>\n                                </tr>\n                            </thead>\n                        <tbody>\n                    ',n.results.forEach((n=>{const e=new Date(n.created_at).toLocaleDateString(),t=n.is_available?"Yes":"No",o=getIncentiveTypeLabel(n.type),s=n.other_description?`<br><em>(${n.other_description})</em>`:"";i+=`\n                            <tr>\n                                <td>${t}</td>\n                                <td>${o}${s}</td>\n                                <td>${n.is_available?n.amount+"%":"N/A"}</td>\n                                <td>${n.information}</td>\n                                <td>${e}</td>\n                            </tr>\n                        `})),i+="\n                        </tbody>\n                    </table>\n                "):i+="<p>No incentives found for this business.</p>",i+="</fieldset>",t.innerHTML=i;const o=document.getElementById("incentives-section");o&&o.scrollIntoView({behavior:"smooth"})})).catch((n=>{console.error("Error in fetching incentives: ",n),t.innerHTML=`<p class="error">Error in fetching incentives: ${n.message}</p>`}))}function getIncentiveTypeLabel(n){return{VT:"Veteran",AD:"Active-Duty",FR:"First Responder",SP:"Spouse",OT:"Other"}[n]||n}function enhancedFetchIncentives(n,e,t){let i=document.getElementById("incentives-container");if(!i){console.log("Creating incentives container"),i=document.createElement("div"),i.id="incentives-container";const n=document.getElementById("business-info-section");if(n&&n.parentNode)n.parentNode.insertBefore(i,n.nextSibling);else{const n=document.querySelector("main");n?n.appendChild(i):document.body.appendChild(i)}}i.innerHTML="<p>Loading incentives...</p>",console.log(`Fetching incentives for business ID: ${n}`);const o=!(!t||!t.chain_id),s=o?t.chain_id:null;let c=`${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:window.location.origin}/api/combined-api.js?operation=incentives&business_id=${n}`;s&&(c+=`&chain_id=${s}`),console.log("Fetching incentives from URL:",c),fetch(c).then((n=>{if(!n.ok)throw new Error(`Failed to fetch incentives: ${n.status} ${n.statusText}`);return n.json()})).then((n=>{console.log("Incentives data received:",n);let s=`\n                <fieldset id="incentives-section">\n                    <legend>\n                        <h3 class="caveat">Step 3: View Incentives for ${e}</h3>\n                    </legend>\n            `;o&&(s+=`\n                    <div class="chain-incentive-warning">\n                        <p><strong>${e}</strong> is part of the <strong>${t.chain_name||"chain"}</strong> chain.</p>\n                        <p>This location may display both location-specific and chain-wide incentives.</p>\n                    </div>\n                `),n.results&&0!==n.results.length?(s+='\n                    <table class="results-table">\n                        <thead>\n                            <tr>\n                                <th>Available</th>\n                                <th>Type</th>\n                                <th>Amount</th>\n                                <th>Information</th>\n                                <th>Scope</th>\n                                <th>Date Added</th>\n                            </tr>\n                        </thead>\n                    <tbody>\n                ',n.results.forEach((n=>{const e=new Date(n.created_at).toLocaleDateString(),t=n.is_available?"Yes":"No",i=getIncentiveTypeLabel(n.type),o=n.other_description?`<br><em>(${n.other_description})</em>`:"";let c="N/A";n.is_available&&(c="dollar"===n.discount_type?`$${n.amount.toFixed(2)}`:`${n.amount}%`);const a=!0===n.is_chain_wide?'<span class="chain-badge">Chain-wide</span>':'<span class="location-badge">Location only</span>';s+=`\n                        <tr>\n                            <td>${t}</td>\n                            <td>${i}${o}</td>\n                            <td>${c}</td>\n                            <td>${n.information}</td>\n                            <td>${a}</td>\n                            <td>${e}</td>\n                        </tr>\n                    `})),s+="\n                    </tbody>\n                </table>\n            "):s+="<p>No incentives found for this business.</p>",s+="</fieldset>",i.innerHTML=s,addBadgeStyles();const c=document.getElementById("incentives-section");c&&c.scrollIntoView({behavior:"smooth"})})).catch((n=>{console.error("Error in fetching incentives:",n),i.innerHTML=`<p class="error">Error in fetching incentives: ${n.message}</p>`}))}function addBadgeStyles(){if(!document.getElementById("incentive-badge-styles")){const n=document.createElement("style");n.id="incentive-badge-styles",n.textContent="\n            .chain-badge {\n                background-color: #4285F4;\n                color: white;\n                border-radius: 4px;\n                padding: 3px 6px;\n                font-size: 12px;\n                display: inline-block;\n                font-weight: normal;\n            }\n            \n            .location-badge {\n                background-color: #34A853;\n                color: white;\n                border-radius: 4px;\n                padding: 3px 6px;\n                font-size: 12px;\n                display: inline-block;\n                font-weight: normal;\n            }\n            \n            .chain-incentive-warning {\n                background-color: #FFF3CD;\n                color: #856404;\n                border: 1px solid #FFEEBA;\n                padding: 10px;\n                margin-bottom: 15px;\n                border-radius: 4px;\n            }\n        ",document.head.appendChild(n)}}function overrideFetchIncentives(){"function"==typeof window.fetchIncentives&&(window.originalFetchIncentives=window.fetchIncentives,window.fetchIncentives=function(n,e){console.log("Enhanced fetchIncentives called"),document.getElementById("selected-business-id");let t=null;window.selectedBusinessData?t=window.selectedBusinessData:window.lastSelectedBusiness&&(t=window.lastSelectedBusiness),enhancedFetchIncentives(n,e,t)})}function overrideViewBusinessIncentives(){"function"==typeof window.viewBusinessIncentives&&(window.originalViewBusinessIncentives=window.viewBusinessIncentives,window.viewBusinessIncentives=function(n){console.log("Enhanced viewBusinessIncentives called"),window.selectedBusinessData=n,window.lastSelectedBusiness=n;const e=!0===n.is_chain,t=checkIfUserIsAdmin();!e||t?(window.originalViewBusinessIncentives(n),setTimeout((()=>{enhanceBusinessInfoDisplay(n),n&&n._id&&enhancedFetchIncentives(n._id,n.bname,n)}),100)):showChainParentWarning(n)})}function checkIfUserIsAdmin(){try{if(void 0!==window.chainHandler&&"function"==typeof window.chainHandler.checkIfUserIsAdmin)return window.chainHandler.checkIfUserIsAdmin();const n=localStorage.getItem("patriotThanksSession");if(!n)return!1;const e=JSON.parse(n);return e.user&&(!0===e.user.isAdmin||"Admin"===e.user.level)}catch(n){return console.error("Error checking admin status:",n),!1}}function showChainParentWarning(n){if(void 0!==window.chainHandler&&"function"==typeof window.chainHandler.showChainParentWarning)return window.chainHandler.showChainParentWarning(n);alert(`${n.bname} is a national chain business. Chain businesses can only be modified by administrators. Please select a specific location instead.`)}function enhanceBusinessInfoDisplay(n){if(void 0!==window.chainHandler&&"function"==typeof window.chainHandler.enhanceBusinessInfoDisplay)return window.chainHandler.enhanceBusinessInfoDisplay(n);const e=document.getElementById("business-info-section");if(e&&"true"!==e.getAttribute("data-enhanced")){if(e.setAttribute("data-enhanced","true"),n.is_chain||n.chain_id){const t=document.createElement("div");t.className="chain-business-warning",n.is_chain?t.innerHTML=`\n                <p><strong>${n.bname}</strong> is a national chain parent business.</p>\n                <p>Chain businesses can only be modified by administrators.</p>\n            `:n.chain_id&&(t.innerHTML=`\n                <p><strong>${n.bname}</strong> is part of the <strong>${n.chain_name||"chain"}</strong> chain.</p>\n                <p>This location may have chain-wide incentives that apply automatically.</p>\n            `),e.insertBefore(t,e.firstChild)}e.querySelectorAll("input, select, textarea").forEach((n=>{n.classList.add("view-only-field")}))}}window.viewBusinessIncentives=function(n){console.log("viewBusinessIncentives called with business: ",n);const e=document.getElementById("business-info-section");e?e.style.display="block":console.error("business-info-section not found in the DOM");const t=document.getElementById("selected-business-id");t&&(t.value=n._id||""),populateBusinessInfo(n),n&&n._id&&fetchIncentives(n._id,n.bname)},document.addEventListener("DOMContentLoaded",(function(){console.log("Business incentives viewer loaded!");const n=window.location.pathname;if(n.includes("incentive-view.html")||n.endsWith("business-search.html")){console.log("on incentive-view or business-search page, initializing viewer");const n=document.getElementById("business-info-section");n?n.style.display="none":console.warn("business-info-section not found in the DOM");let e=document.getElementById("incentives-container");if(!e)if(e=document.createElement("div"),e.id="incentives-container",n&&n.parentNode)n.parentNode.insertBefore(e,n.nextSibling);else{const n=document.querySelector("main");n?n.appendChild(e):(console.warn("Could not find the proper parent for incentives container"),document.body.appendChild(e))}}})),document.addEventListener("DOMContentLoaded",(function(){console.log("Enhanced incentive viewer initialized"),overrideFetchIncentives(),overrideViewBusinessIncentives(),addBadgeStyles()}));