document.addEventListener("DOMContentLoaded",(function(){console.log("Form validator loaded!");const e={businessName:document.getElementById("bname"),address1:document.getElementById("address1"),city:document.getElementById("city"),state:document.getElementById("state"),zip:document.getElementById("zip"),phone:document.getElementById("phone"),type:document.getElementById("type")};function t(e){return e&&""!==e.trim()}function n(e){return/^\d{5}(-\d{4})?$/.test(e.trim())}function s(e){const t=e.replace(/\D/g,"");if(10!==t.length)return!1;const n=document.getElementById("phone");return n&&(n.value=`${t.substring(0,3)}-${t.substring(3,6)}-${t.substring(6,10)}`),!0}function o(e,t){console.log(`Validating ${e.id} with value: ${e.value}`),t(e.value)?(e.classList.remove("invalid-field"),e.classList.add("valid-field"),e.setAttribute("data-valid","true"),console.log(`${e.id} is VALID`)):(e.classList.remove("valid-field"),e.classList.add("invalid-field"),e.setAttribute("data-valid","false"),console.log(`${e.id} is INVALID`))}document.getElementById("business-form").addEventListener("submit",(function(o){o.preventDefault();const a=[];if(t(e.businessName.value)||a.push("Business Name"),t(e.address1.value)||a.push("Address"),t(e.city.value)||a.push("City"),t(e.state.value)||a.push("State"),n(e.zip.value)||a.push("Zip Code"),s(e.phone.value)||a.push("Phone Number"),t(e.type.value)||a.push("Type"),console.log("Invalid fields:",a),a.length>0){let e="Please complete the following required fields:\n";e+=a.join("\n"),alert(e)}else{const t={bname:e.businessName.value,address1:e.address1.value,address2:document.getElementById("address2").value||"",city:e.city.value,state:e.state.value,zip:e.zip.value,phone:e.phone.value,type:e.type.value};let n=!1;const s=document.getElementById("hidden_lat"),o=document.getElementById("hidden_lng");if(s&&o&&s.value&&o.value){const e=parseFloat(s.value),a=parseFloat(o.value);isNaN(e)||isNaN(a)||0===e||0===a||(t.location={type:"Point",coordinates:[a,e]},n=!0,console.log("‚úÖ Using coordinates from hidden fields:",t.location))}if(!n){const e=document.getElementById("google_place_id");e&&e.value&&(console.log("üìç Google Place ID found, but no coordinates. Will geocode on server side."),t.google_place_id=e.value)}n||t.google_place_id||console.log("üó∫Ô∏è No coordinates available. Server will geocode from address.");const a=document.getElementById("chain-id"),i=document.getElementById("chain-name"),l=document.getElementById("is-chain-location");a&&a.value&&(t.chain_id=a.value,console.log("üîó Adding chain ID:",t.chain_id)),i&&i.value&&(t.chain_name=i.value,console.log("üè™ Adding chain name:",t.chain_name)),l&&l.checked&&(t.is_chain_location=!0,console.log("‚õìÔ∏è Marked as chain location")),console.log("üìã Final form data to submit:",t),async function(e){try{const t=localStorage.getItem("patriotThanksSession");if(console.log("üîê Session data from localStorage:",t?"Found":"Not found"),t)try{const n=JSON.parse(t);console.log("üë§ Parsed session data for user:",n?.user?.email),n&&n.user&&n.user._id?(e.created_by=n.user._id,console.log("‚úÖ Setting created_by to:",n.user._id)):(console.log("‚ö†Ô∏è User ID not found in expected location"),e.created_by=null)}catch(t){console.error("‚ùå Error parsing session data:",t),e.created_by=null}else console.log("‚ÑπÔ∏è No session data found in localStorage"),e.created_by=null;const n=`${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin}/api/business.js?operation=register`;console.log("üåê Submitting to API at:",n),console.log("üì§ Request payload:",JSON.stringify(e,null,2));const s=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(e)});if(console.log("üì• Response status:",s.status),!s.ok){const e=await s.text();console.error("‚ùå Error response:",e);let t=`Failed to submit data: ${s.status}`;try{const n=JSON.parse(e);n.message&&(t=n.message)}catch(n){t=e}throw new Error(t)}const o=await s.json();console.log("‚úÖ Success:",o),alert("‚úÖ Submission successful! The business is now available in our database.");const a=e.bname,i=sessionStorage.getItem("returnToSearch");if(i){console.log("üîÑ Returning to search page as requested"),sessionStorage.removeItem("returnToSearch"),sessionStorage.removeItem("newBusinessData"),sessionStorage.removeItem("autoChainLinking");const e=new URL(i);e.searchParams.set("business_added","true"),e.searchParams.set("business_name",a),e.searchParams.set("business_id",o.business_id||o._id||"unknown"),e.searchParams.set("timestamp",(new Date).getTime()),window.location.href=e.toString()}else!function(e){const t=new URL("business-search.html",window.location.origin);t.searchParams.append("business_added","true"),t.searchParams.append("business_name",e),t.searchParams.append("ts",(new Date).getTime()),window.location.href=t.toString()}(a)}catch(e){console.error("‚ùå Submission error:",e);let t="Registration failed: "+e.message;e.message.includes("geo keys")||e.message.includes("GeoJSON")?t+="\n\nThis appears to be a location/mapping error. Please try again or contact support.":(e.message.includes("duplicate")||e.message.includes("already exists"))&&(t+="\n\nThis business may already exist in our database."),alert(t)}}(t)}})),e.businessName.addEventListener("input",(function(){o(this,t)})),e.address1.addEventListener("input",(function(){o(this,t)})),e.city.addEventListener("input",(function(){o(this,t)})),e.state.addEventListener("change",(function(){o(this,t)})),e.zip.addEventListener("input",(function(){o(this,n)})),e.phone.addEventListener("input",(function(){o(this,s)})),e.type.addEventListener("input",(function(){o(this,t)})),function(){const o=[{element:e.businessName,validator:t},{element:e.address1,validator:t},{element:e.city,validator:t},{element:e.state,validator:t},{element:e.zip,validator:n},{element:e.phone,validator:s},{element:e.type,validator:t}];let a=!0;o.forEach((e=>{e.validator(e.element.value)?(e.element.classList.remove("invalid-field"),e.element.classList.add("valid-field")):(a=!1,e.element.classList.remove("valid-field"),e.element.classList.add("invalid-field"))}))}(),function(){["bname","address1","city","state","zip","phone","type"].forEach((e=>{if(document.getElementById(e)){const t=document.querySelector(`label[for="${e}"]`);if(t&&!t.innerHTML.includes("*")){const e=document.createElement("span");e.className="required-indicator",e.textContent="*",e.style.color="red",t.appendChild(e)}}}));const e=document.getElementById("business-form");if(e&&!e.querySelector(".form-explanation")){const t=document.createElement("div");t.className="form-explanation",t.innerHTML='<p style="color: #666; font-style: italic;">Fields marked with an asterisk (*) are required.</p>',e.insertBefore(t,e.firstChild)}}(),window.debugFormData=function(){const t=document.getElementById("hidden_lat"),n=document.getElementById("hidden_lng"),s=document.getElementById("google_place_id"),o=document.getElementById("chain-id");console.log("üîç FORM DEBUG:"),console.log("  - Hidden Lat:",t?t.value:"Not found"),console.log("  - Hidden Lng:",n?n.value:"Not found"),console.log("  - Place ID:",s?s.value:"Not found"),console.log("  - Chain ID:",o?o.value:"Not found"),console.log("  - Business Name:",e.businessName.value),console.log("  - Address:",`${e.address1.value}, ${e.city.value}, ${e.state.value} ${e.zip.value}`)},console.log("üìã Enhanced business validator loaded!")}));