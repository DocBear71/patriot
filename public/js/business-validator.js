document.addEventListener("DOMContentLoaded",(function(){console.log("Form validator loaded!");const e={businessName:document.getElementById("bname"),address1:document.getElementById("address1"),city:document.getElementById("city"),state:document.getElementById("state"),zip:document.getElementById("zip"),phone:document.getElementById("phone"),type:document.getElementById("type")};function t(e){return""!==e.trim()}function n(e){return/^\d{5}(-\d{4})?$/.test(e)}function s(e){const t=e.replace(/\D/g,"");return 10===t.length&&(document.getElementById("phone").value=`${t.substring(0,3)}-${t.substring(3,6)}-${t.substring(6,10)}`,!0)}function o(e,t){console.log(`Validating ${e.id} with value: ${e.value}`),t(e.value)?(e.classList.remove("invalid-field"),e.classList.add("valid-field"),e.setAttribute("data-valid","true"),console.log(`${e.id} is VALID`)):(e.classList.remove("valid-field"),e.classList.add("invalid-field"),e.setAttribute("data-valid","false"),console.log(`${e.id} is INVALID`))}document.getElementById("business-form").addEventListener("submit",(function(o){o.preventDefault();const a=[];if(t(e.businessName.value)||a.push("Business Name"),t(e.address1.value)||a.push("Address"),t(e.city.value)||a.push("City"),t(e.state.value)||a.push("State"),n(e.zip.value)||a.push("Zip Code"),s(e.phone.value)||a.push("Phone Number"),t(e.type.value)||a.push("Type"),console.log("Invalid fields:",a),a.length>0){let e="Please complete the following required fields:\n";e+=a.join("\n"),alert(e)}else{const t=document.getElementById("google_place_id"),n=t?t.value:null,s={bname:e.businessName.value,address1:e.address1.value,address2:document.getElementById("address2").value,city:e.city.value,state:e.state.value,zip:e.zip.value,phone:e.phone.value,type:e.type.value};n&&(s.location={type:"Point",coordinates:[-91.5769,42.0433]});const o=document.getElementById("hidden_lat"),a=document.getElementById("hidden_lng");if(o&&a){const e=parseFloat(o.value),t=parseFloat(a.value);isNaN(e)||isNaN(t)||(s.location={type:"Point",coordinates:[t,e]},console.log("Added location data:",s.location))}console.log("Form data to submit:",s),async function(e){try{const t=localStorage.getItem("patriotThanksSession");if(console.log("Session data from localStorage:",t),t)try{const n=JSON.parse(t);console.log("Parsed session data:",n),n&&n.user&&n.user._id?(e.created_by=n.user._id,console.log("Setting created_by to:",n.user._id)):(console.log("User ID not found in expected location"),e.created_by=null)}catch(t){console.error("Error parsing session data:",t),e.created_by=null}else console.log("No session data found in localStorage"),e.created_by=null;const n=`${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`https://${window.location.host}`:window.location.origin}/api/business.js?operation=register`;console.log("Submitting to API at:",n);const s=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(e)});if(console.log("Response status:",s.status),!s.ok){const e=await s.text();throw console.error("Error response:",e),new Error(`Failed to submit data to MongoDB: ${s.status} ${e}`)}const o=await s.json();console.log("Success:",o),alert("Submission successful! The business is now available in our database."),function(e){const t=new URL("business-search.html",window.location.origin);t.searchParams.append("business_added","true"),t.searchParams.append("business_name",e),t.searchParams.append("ts",(new Date).getTime()),window.location.href=t.toString()}(e.bname)}catch(e){console.error("Error:",e),alert("Registration failed: "+e.message)}}(s)}})),e.businessName.addEventListener("input",(function(){o(this,t)})),e.address1.addEventListener("input",(function(){o(this,t)})),e.city.addEventListener("input",(function(){o(this,t)})),e.state.addEventListener("change",(function(){o(this,t)})),e.zip.addEventListener("input",(function(){o(this,n)})),e.phone.addEventListener("input",(function(){o(this,s)})),e.type.addEventListener("input",(function(){o(this,t)})),function(){const o=[{element:e.businessName,validator:t},{element:e.address1,validator:t},{element:e.city,validator:t},{element:e.state,validator:t},{element:e.zip,validator:n},{element:e.phone,validator:s},{element:e.type,validator:t}];let a=!0;o.forEach((e=>{e.validator(e.element.value)?(e.element.classList.remove("invalid-field"),e.element.classList.add("valid-field")):(a=!1,e.element.classList.remove("valid-field"),e.element.classList.add("invalid-field"))}))}(),function(){["bname","address1","city","state","zip","phone","type"].forEach((e=>{if(document.getElementById(e)){const t=document.querySelector(`label[for="${e}"]`);if(t&&!t.innerHTML.includes("*")){const e=document.createElement("span");e.className="required-indicator",e.textContent="*",e.style.color="red",t.appendChild(e)}}}));const e=document.getElementById("business-form");if(e){const t=document.createElement("div");t.className="form-explanation",t.innerHTML="<p>Fields marked with an asterisk (*) are required.</p>",e.insertBefore(t,e.firstChild)}}()}));