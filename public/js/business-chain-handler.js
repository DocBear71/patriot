function checkIfUserIsAdmin(){try{const n=localStorage.getItem("patriotThanksSession");if(!n)return!1;const e=JSON.parse(n);return e.user&&(!0===e.user.isAdmin||"Admin"===e.user.level)}catch(n){return console.error("Error checking admin status:",n),!1}}function modifyBusinessSearchResults(n,e){const i=checkIfUserIsAdmin();console.log("User is admin:",i);let s='\n        <table class="results-table">\n            <thead>\n                <tr>\n                    <th>Business Name</th>\n                    <th>Address</th>\n                    <th>City</th>\n                    <th>State</th>\n                    <th>Zip</th>\n                    <th>Action</th>\n                </tr>\n            </thead>\n            <tbody>\n    ';n.forEach((n=>{const e=!0===n.is_chain,t=n.address1||(e?"<em>National Chain Headquarters</em>":""),o=n.address2?`<br>${n.address2}`:"";let a,c="";e?c='<span class="chain-badge">National Chain</span>':n.chain_id&&(c='<span class="chain-badge">Chain Location</span>'),a=e?i?`<button class="select-business admin-action-btn" data-business-id="${n._id}">Admin: Edit Chain</button>`:`<button class="view-chain-btn" onclick="viewChainDetails('${n._id}')">View Chain Info</button>`:`<button class="select-business" data-business-id="${n._id}">Select</button>`,s+=`\n            <tr ${e&&!i?'class="chain-parent-row"':""}>\n                <td data-title="Business Name">${n.bname} ${c}</td>\n                <td data-title="Address">${t}${o}</td>\n                <td data-title="City">${n.city||""}</td>\n                <td data-title="State">${n.state||""}</td>\n                <td data-title="Zip">${n.zip||""}</td>\n                <td data-title="Action">${a}</td>\n            </tr>\n        `})),s+="\n            </tbody>\n        </table>\n    ",e.innerHTML=s,setupBusinessSelectButtons(e,n)}function setupBusinessSelectButtons(n,e){n.querySelectorAll(".select-business").forEach((n=>{n.addEventListener("click",(function(){const n=this.getAttribute("data-business-id");if(!n)return void console.error("No business ID found on button");const i=e.find((e=>e._id===n));i?(console.log("Selected business:",i),handleBusinessSelectionByPage(window.location.pathname,i)):console.error("Could not find business with ID:",n)}))}))}function handleBusinessSelectionByPage(n,e){const i=!0===e.is_chain,s=checkIfUserIsAdmin();!i||s?n.includes("incentive-update.html")?(console.log("On incentive-update page"),"function"==typeof window.selectBusinessForIncentive?window.selectBusinessForIncentive(e):"function"==typeof window.selectBusinessForIncentives?window.selectBusinessForIncentives(e):(console.error("selectBusinessForIncentive(s) not found, falling back"),handleBusinessSelection(e))):n.includes("business-update.html")?(console.log("On business-update page"),"function"==typeof window.selectBusinessForUpdate?window.selectBusinessForUpdate(e):(console.error("selectBusinessForUpdate not found, falling back"),handleBusinessSelection(e))):n.includes("incentive-add.html")?(console.log("On incentive-add page"),"function"==typeof window.selectBusinessForIncentive?window.selectBusinessForIncentive(e):handleBusinessSelection(e)):n.includes("incentive-view.html")||n.endsWith("business-search.html")?(console.log("On incentive-view page"),"function"==typeof window.viewBusinessIncentives?window.viewBusinessIncentives(e):handleBusinessSelection(e)):(console.error("Using fallback business selection handler"),handleBusinessSelection(e)):showChainParentWarning(e)}function showChainParentWarning(n){const e=`\n        <div class="modal fade" id="chainWarningModal" tabindex="-1" role="dialog" aria-labelledby="chainWarningModalLabel">\n            <div class="modal-dialog" role="document">\n                <div class="modal-content">\n                    <div class="modal-header">\n                        <h5 class="modal-title" id="chainWarningModalLabel">Chain Business Information</h5>\n                        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">\n                            <span aria-hidden="true">&times;</span>\n                        </button>\n                    </div>\n                    <div class="modal-body">\n                        <div class="chain-business-warning">\n                            <p><strong>${n.bname}</strong> is a national chain business.</p>\n                            <p>Chain businesses can only be modified by administrators. Please select a specific location instead.</p>\n                        </div>\n                        <p>To add an incentive, please search for a specific location of this chain.</p>\n                    </div>\n                    <div class="modal-footer">\n                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;if(!document.getElementById("chainWarningModal")){const n=document.createElement("div");n.innerHTML=e,document.body.appendChild(n)}"undefined"!=typeof bootstrap?new bootstrap.Modal(document.getElementById("chainWarningModal")).show():$("#chainWarningModal").modal("show")}function displayChainIncentivesInfo(n,e){if(n&&e&&n.chain_id){const i=document.createElement("div");i.className="chain-business-warning",i.innerHTML=`\n            <p><strong>${n.bname}</strong> is part of the <strong>${n.chain_name||"chain"}</strong> chain.</p>\n            <p>This location may have chain-wide incentives applied automatically.</p>\n        `,e.insertBefore(i,e.firstChild)}}function enhanceBusinessInfoDisplay(n){const e=document.getElementById("business-info-section");if(!e)return;const i=!0===n.is_chain,s=!!n.chain_id;if(i||s){const t=document.createElement("div");t.className="chain-business-warning",i?t.innerHTML=`\n                <p><strong>${n.bname}</strong> is a national chain parent business.</p>\n                <p>Changes to chain-wide incentives can only be made by administrators.</p>\n            `:s&&(t.innerHTML=`\n                <p><strong>${n.bname}</strong> is part of the <strong>${n.chain_name||"chain"}</strong> chain.</p>\n                <p>This location may have chain-wide incentives that apply automatically.</p>\n            `),e.insertBefore(t,e.firstChild)}e.querySelectorAll("input, select").forEach((n=>{n.classList.add("view-only-field");const i=e.querySelector(`label[for="${n.id}"]`);if(i&&!i.querySelector(".view-only-indicator")){const n=document.createElement("span");n.className="view-only-indicator",n.textContent="(view only)",i.appendChild(n)}}))}function enhancedDisplayBusinessSearchResults(n,e){console.log("Enhanced business search display activated"),modifyBusinessSearchResults(n,e)}function addChainStylesIfNeeded(){if(!document.getElementById("chain-handling-styles")){const n=document.createElement("style");n.id="chain-handling-styles",n.textContent='\n            /* Chain Badge and permission styles */\n            .chain-badge {\n                background-color: #4285F4;\n                color: white;\n                border-radius: 4px;\n                padding: 3px 6px;\n                font-size: 12px;\n                display: inline-block;\n                margin-left: 5px;\n                font-weight: normal;\n            }\n            \n            .chain-badge.small {\n                font-size: 10px;\n                padding: 2px 4px;\n            }\n            \n            /* Styling for chain warning banners */\n            .chain-incentive-warning,\n            .chain-business-warning {\n                background-color: #FFF3CD;\n                color: #856404;\n                border: 1px solid #FFEEBA;\n                padding: 10px;\n                margin-bottom: 15px;\n                border-radius: 4px;\n            }\n            \n            /* Admin button styling */\n            .select-incentive.admin-chain,\n            .admin-action-btn {\n                background-color: #9C27B0;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n                font-weight: bold;\n            }\n            \n            .select-incentive.admin-chain:hover,\n            .admin-action-btn:hover {\n                background-color: #7B1FA2;\n            }\n            \n            /* View-only button for regular users */\n            .view-chain-btn {\n                background-color: #2196F3;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 4px;\n                cursor: pointer;\n            }\n            \n            .view-chain-btn:hover {\n                background-color: #0D8AED;\n            }\n            \n            /* Fix for form fields */\n            input:not([disabled]),\n            select:not([disabled]),\n            textarea:not([disabled]) {\n                opacity: 1 !important;\n                pointer-events: auto !important;\n            }\n            \n            /* Make sure buttons are always clickable */\n            #business-search-form input[type="submit"],\n            #reset-button,\n            .clear-button,\n            .select-business,\n            .select-incentive {\n                cursor: pointer !important;\n                opacity: 1 !important;\n                pointer-events: auto !important;\n            }\n            \n            /* Style for view-only indicators */\n            .view-only-indicator {\n                color: #6c757d;\n                font-style: italic;\n                font-size: 0.9em;\n                display: block;\n                margin-top: 2px;\n            }\n            \n            /* Apply consistent view-only styling */\n            .view-only-field {\n                background-color: #f8f9fa;\n                border-color: #ced4da;\n                color: #495057;\n                pointer-events: none;\n            }\n            \n            /* Highlight chain parent rows for clarity */\n            .chain-parent-row {\n                background-color: #f8f9fa !important;\n            }\n            \n            /* Chain incentive flag in results */\n            .chain-incentive-flag {\n                background-color: #4285F4;\n                color: white;\n                border-radius: 4px;\n                padding: 2px 5px;\n                font-size: 11px;\n                margin-left: 5px;\n            }\n        ',document.head.appendChild(n),console.log("Added chain handling styles")}}"function"==typeof window.displayBusinessSearchResults&&(console.log("Overriding displayBusinessSearchResults with enhanced version"),window.originalDisplayBusinessSearchResults=window.displayBusinessSearchResults,window.displayBusinessSearchResults=enhancedDisplayBusinessSearchResults),document.addEventListener("DOMContentLoaded",(function(){console.log("Chain business handler initialized"),addChainStylesIfNeeded();const n=window.location.pathname;if(n.includes("incentive-view.html")&&"function"==typeof window.viewBusinessIncentives){const n=window.viewBusinessIncentives;window.viewBusinessIncentives=function(e){n(e),setTimeout((()=>{enhanceBusinessInfoDisplay(e),displayChainIncentivesInfo(e,document.getElementById("incentives-container"))}),100)}}if(n.includes("incentive-add.html")&&"function"==typeof window.selectBusinessForIncentive){const n=window.selectBusinessForIncentive;window.selectBusinessForIncentive=function(e){const i=!0===e.is_chain,s=checkIfUserIsAdmin();!i||s?(n(e),setTimeout((()=>{enhanceBusinessInfoDisplay(e)}),100)):showChainParentWarning(e)}}if(n.includes("incentive-update.html")&&"function"==typeof window.selectBusinessForIncentives){const n=window.selectBusinessForIncentives;window.selectBusinessForIncentives=function(e){const i=!0===e.is_chain,s=checkIfUserIsAdmin();!i||s?(window.selectedBusinessData=e,n(e)):showChainParentWarning(e)}}})),window.chainHandler={checkIfUserIsAdmin,modifyBusinessSearchResults,setupBusinessSelectButtons,enhanceBusinessInfoDisplay,displayChainIncentivesInfo,showChainParentWarning};