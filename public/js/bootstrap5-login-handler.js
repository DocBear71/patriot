function handleLogin(){console.log("Handle login function called");const e=document.getElementById("DropdownFormEmail1").value.toLowerCase(),o=document.getElementById("DropdownFormPassword1").value,t=document.getElementById("dropdownCheck")?.checked||!1;if(console.log("Login attempt with:",e,"Remember me:",t),e&&o){console.log("Login successful");const t={email:e,password:o},n="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin;fetch(`${n}/api/auth.js?operation=login`,{method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8"},body:JSON.stringify(t)}).then((e=>{if(!e.ok)throw new Error("Login failed: "+e.statusText);return e.json()})).then((o=>{console.log("Login successful");const t={user:{_id:o.userId,email:o.email,fname:o.fname,lname:o.lname,address1:o.address1,address2:o.address2,city:o.city,state:o.state,zip:o.zip,status:o.status,level:o.level,isAdmin:o.isAdmin,created_at:o.created_at,updated_at:o.updated_at,termsAccepted:o.termsAccepted||!1,termsVersion:o.termsVersion||null,termsAcceptedDate:o.termsAcceptedDate||null},token:o.token||"no-token-provided",timestamp:(new Date).getTime(),expiresIn:864e5};localStorage.setItem("patriotThanksSession",JSON.stringify(t)),localStorage.setItem("isLoggedIn","true"),localStorage.setItem("userEmail",e),updateUIAfterLogin(t),updateLoginUI();const n=document.querySelector(".dropdown-menu");if(n)if("undefined"!=typeof bootstrap&&bootstrap.Dropdown){const e=bootstrap.Dropdown.getInstance(n.previousElementSibling);e&&e.hide()}else $(n).parent().removeClass("show"),$(n).removeClass("show")})).catch((e=>{console.error("Login error: ",e),alert("Login failed: "+e.message)}))}else console.error("Login failed: Missing email or password"),alert("Please enter both email and password.")}function generateTempId(){return"temp_"+Math.random().toString(36).substr(2,9)}function updateUIAfterLogin(e){console.log("Updating UI after login");const o=e.user,t=o.email,n=o.isAdmin||"Admin"===o.level,s=o.fname?`${o.fname} ${o.lname}`:t,l=document.getElementById("login-dropdown-button"),r=document.getElementById("user-dropdown-button"),d=document.getElementById("login-dropdown-menu"),a=document.getElementById("user-dropdown-menu");if(l&&(l.style.display="none"),r){r.style.display="inline-block";const e=document.getElementById("user-name");e?n?e.innerHTML=`${s} <span class="admin-badge">Admin</span>`:e.textContent=s:r.textContent=s}d&&(d.style.display="none"),a&&(a.style.display="block"),toggleAdminElements(n),enableRestrictedLinks(o),console.log("UI updated for logged in user:",s,"Admin:",n),setTimeout((function(){document.getElementById("termsUpdateModal")?checkTermsVersion(e):(console.log("Modal not found yet, will retry in 500ms"),setTimeout((function(){checkTermsVersion(e)}),500))}),500)}function checkTermsVersion(e){e&&e.user&&(e.user.termsAccepted&&"May 14, 2025"===e.user.termsVersion||(console.log("User needs to accept new terms - using SimpleTermsModal"),window.SimpleTermsModal?window.SimpleTermsModal.show():console.error("SimpleTermsModal not loaded yet")))}function updateTermsAcceptance(e){const o=e.user._id;e.user.termsAccepted=!0,e.user.termsAcceptedDate=(new Date).toISOString(),e.user.termsVersion="May 14, 2025",localStorage.setItem("patriotThanksSession",JSON.stringify(e)),console.log("Session updated locally with terms acceptance");const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin;fetch(`${t}/api/auth.js?operation=update-terms-acceptance`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e.token},body:JSON.stringify({userId:o,termsAccepted:!0,termsAcceptedDate:(new Date).toISOString(),termsVersion:"May 14, 2025"})}).then((e=>e.json())).then((e=>{e.success?console.log("Terms acceptance updated successfully on server"):console.error("Failed to update terms acceptance on server")})).catch((e=>{console.error("Error updating terms acceptance on server:",e)})).finally((()=>{document.getElementById("termsUpdateModal")&&hideModal()}))}function hideModal(){console.log("Hiding modal (Bootstrap 5 compatible)");try{const e=document.getElementById("termsUpdateModal");if("undefined"!=typeof bootstrap&&bootstrap.Modal){const o=bootstrap.Modal.getInstance(e);o?o.hide():$(e).modal("hide")}else $(e).modal("hide")}catch(e){console.error("Error hiding modal:",e),$(".modal-backdrop").remove(),$("body").removeClass("modal-open"),$("body").css("padding-right",""),$("body").css("overflow","");const o=document.getElementById("termsUpdateModal");o&&(o.classList.remove("show"),o.style.display="none",o.setAttribute("aria-hidden","true"),o.removeAttribute("aria-modal"))}}function showEmergencyButton(){console.log("Showing emergency button");let e=document.getElementById("emergencyResetBtn");e||(e=document.createElement("button"),e.id="emergencyResetBtn",e.innerHTML="Emergency Reset",e.style.position="fixed",e.style.bottom="10px",e.style.right="10px",e.style.zIndex="9999",e.style.backgroundColor="#dc3545",e.style.color="white",e.style.border="none",e.style.padding="8px 15px",e.style.borderRadius="4px",e.style.fontWeight="bold",e.style.cursor="pointer",e.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",e.addEventListener("click",(function(){console.log("Emergency reset button clicked"),emergencyModalReset(),this.style.display="none"})),document.body.appendChild(e)),e.style.display="block"}function toggleAdminElements(e){document.querySelectorAll(".admin-only").forEach((o=>{o.style.display=e?"":"none"})),console.log("Admin elements "+(e?"shown":"hidden"))}function enableRestrictedLinks(e){const o=document.querySelector('a[href="./business-add.html"]'),t=document.querySelector('a[href="./business-update.html"]'),n=document.querySelector('a[href="./incentive-add.html"]'),s=document.querySelector('a[href="./incentive-update.html"]');o&&o.classList.remove("disabled"),n&&n.classList.remove("disabled"),t&&t.classList.remove("disabled"),s&&s.classList.remove("disabled"),document.querySelectorAll(".dropdown-item.disabled").forEach((e=>{(e.href.includes("business-add.html")||e.href.includes("business-update.html")||e.href.includes("incentive-add.html")||e.href.includes("incentive-update.html"))&&(console.log("Enabling restricted link:",e.href),e.classList.remove("disabled"))}))}function logoutUser(){console.log("Logging out user"),localStorage.removeItem("patriotThanksSession"),localStorage.removeItem("isLoggedIn"),localStorage.removeItem("userEmail"),sessionStorage.removeItem("isLoggedIn"),sessionStorage.removeItem("userEmail");const e=document.getElementById("login-dropdown-button"),o=document.getElementById("user-dropdown-button"),t=document.getElementById("login-dropdown-menu"),n=document.getElementById("user-dropdown-menu");e&&(e.style.display="inline-block"),o&&(o.style.display="none"),t&&(t.style.display="block"),n&&(n.style.display="none"),toggleAdminElements(!1);const s=document.getElementById("DropdownFormEmail1"),l=document.getElementById("DropdownFormPassword1");s&&(s.value=""),l&&(l.value=""),document.querySelectorAll(".dropdown-item").forEach((e=>{(e.href.includes("business-add.html")||e.href.includes("business-update.html")||e.href.includes("incentive-add.html")||e.href.includes("incentive-update.html"))&&(e.classList.add("disabled"),console.log("Disabling link on logout:",e.href))})),attachLoginListeners();const r=window.location.pathname;(r.includes("profile.html")||r.includes("settings.html")||r.includes("admin-")||r.includes("business-add.html")||r.includes("business-update.html")||r.includes("incentive-add.html")||r.includes("incentive-update.html"))&&(window.location.href="/index.html"),updateLoginUI()}function attachLoginListeners(){console.log("Attaching login event listeners"),$(document).off("click","#login-button, button.btn-primary"),$(document).off("submit","#login-form, .dropdown-menu form"),$(document).off("keypress","#DropdownFormPassword1"),$(document).off("click","#logout-button, #logout-link"),$(document).on("click","#login-button, button.btn-primary",(function(e){("login-form"===$(this).closest("form").attr("id")||$(this).closest(".dropdown-menu").length>0)&&(console.log("Login button clicked"),e.preventDefault(),handleLogin())})),$(document).on("submit","#login-form, .dropdown-menu form",(function(e){return console.log("Login form submitted"),e.preventDefault(),handleLogin(),!1})),$(document).on("keypress","#DropdownFormPassword1",(function(e){13===e.which&&(e.preventDefault(),handleLogin())})),$(document).on("click","#logout-button, #logout-link",(function(e){e.preventDefault(),logoutUser()}))}function checkLoginStatus(){console.log("Checking login status");const e=localStorage.getItem("patriotThanksSession");if(e)try{const o=JSON.parse(e);if((new Date).getTime()<o.timestamp+o.expiresIn)return console.log("User is already logged in (session found)"),updateUIAfterLogin(o),!0}catch(e){console.error("Error parsing session data:",e)}if("true"===localStorage.getItem("isLoggedIn")||"true"===sessionStorage.getItem("isLoggedIn")){console.log("User is already logged in (old format)");const e=localStorage.getItem("userEmail")||sessionStorage.getItem("userEmail"),o={user:{_id:localStorage.getItem("userId")||sessionStorage.getItem("userId")||"temp_"+Math.random().toString(36).substr(2,9),email:e||"unknown@example.com",fname:localStorage.getItem("fname")||sessionStorage.getItem("fname")||"",lname:localStorage.getItem("lname")||sessionStorage.getItem("lname")||"",isAdmin:"true"===localStorage.getItem("isAdmin")||"true"===sessionStorage.getItem("isAdmin")},token:"simulated-token",timestamp:(new Date).getTime(),expiresIn:864e5};return localStorage.setItem("patriotThanksSession",JSON.stringify(o)),updateUIAfterLogin(o),!0}return console.log("User is not logged in"),!1}function fixLoginMenuIssue(){const e=localStorage.getItem("patriotThanksSession");if(e)try{const o=JSON.parse(e),t=document.getElementById("loginBtn");t&&(t.style.display="none");const n=document.getElementById("userDropdown");if(n){n.style.display="block";const e=document.getElementById("userDisplayName");e&&o.user&&(e.textContent=`${o.user.fname||""} ${o.user.lname||""}`)}console.log("User session active, displaying user dropdown")}catch(e){console.error("Error parsing session data:",e)}else console.log("No active session found")}function updateLoginUI(){const e=localStorage.getItem("patriotThanksSession"),o=document.querySelector(".navbar-nav.ms-auto li.dropdown:not(#user-dropdown)")||document.querySelector(".navbar-nav.ml-auto li.dropdown:not(#user-dropdown)"),t=document.getElementById("user-dropdown");if(e){const n=JSON.parse(e);if(o&&(o.style.display="none"),t){t.style.display="block";const e=document.getElementById("userDisplayName");e&&n.user&&(e.textContent=`${n.user.fname||""} ${n.user.lname||""}`)}toggleAdminElements(n.user&&(n.user.isAdmin||"Admin"===n.user.level))}else o&&(o.style.display="block"),t&&(t.style.display="none"),toggleAdminElements(!1)}function getAuthToken(){try{const e=localStorage.getItem("patriotThanksSession");return e&&JSON.parse(e).token||null}catch(e){return console.error("Error retrieving auth token:",e),null}}function setupTermsModalHandlers(){console.log("Setting up terms modal handlers"),document.getElementById("acceptUpdatedTerms"),document.getElementById("confirmUpdatedTerms"),document.getElementById("rejectUpdatedTerms"),document.getElementById("termsUpdateModal")?($(document).off("change","#acceptUpdatedTerms"),$(document).off("click","#confirmUpdatedTerms"),$(document).off("click","#rejectUpdatedTerms"),$(document).on("change","#acceptUpdatedTerms",(function(){const e=document.getElementById("confirmUpdatedTerms");e&&(e.disabled=!this.checked)})),$(document).on("click","#confirmUpdatedTerms",(function(e){e.preventDefault(),e.stopPropagation(),console.log("Terms acceptance confirmed");const o=localStorage.getItem("patriotThanksSession");if(!o)return console.error("No session found"),$("#termsUpdateModal").modal("hide"),void removeAllBackdrops();updateTermsAcceptance(JSON.parse(o))})),$(document).on("click","#rejectUpdatedTerms",(function(e){if(e.preventDefault(),e.stopPropagation(),console.log("Terms acceptance rejected"),confirm("If you do not accept the updated terms, you will be logged out and unable to use the service. Continue?")){logoutUser();try{$("#termsUpdateModal").modal("hide"),removeAllBackdrops()}catch(e){console.error("Error hiding modal:",e),emergencyModalReset()}}})),$(".modal .close").on("click",(function(){console.log("Close button clicked"),$("#termsUpdateModal").modal("hide"),removeAllBackdrops()})),$(document).on("keydown",(function(e){"Escape"===e.key&&$("#termsUpdateModal").hasClass("show")&&(console.log("Escape key pressed, attempting to close modal"),$("#termsUpdateModal").modal("hide"),removeAllBackdrops())}))):console.error("Terms modal not found in DOM")}function removeAllBackdrops(){console.log("Removing all modal backdrops"),$(".modal-backdrop").remove(),$("body").removeClass("modal-open"),$("body").css("padding-right","")}function setupTermsScrollTracking(){console.log("Setting up terms scroll tracking");const e=document.getElementById("termsSummary"),o=document.getElementById("acceptUpdatedTerms"),t=document.getElementById("confirmUpdatedTerms"),n=document.getElementById("scrollMessage");let s=!1,l=Date.now();const r=5e3;if(e){const o=e._scrollListener;o&&e.removeEventListener("scroll",o)}if(!e)return void console.error("Terms summary element not found");if(!o)return void console.error("Terms checkbox not found");if(!n)return void console.error("Scroll message element not found");const d=function(){const t=e.scrollTop+e.clientHeight,d=e.scrollHeight,a=Date.now()-l,i=t/d*100;if(console.log(`Scroll position: ${t}/${d} (${i.toFixed(2)}%)`),i>=80&&a>=r)console.log("User has scrolled to near bottom of terms"),s=!0,o&&(o.disabled=!1,console.log("Terms checkbox enabled")),n&&(n.style.display="block",n.innerHTML='<i class="fa fa-check-circle"></i> Thank you for reviewing the terms. Please check the box below to confirm your acceptance.',n.style.color="green");else if(i>=80&&a<r){const e=Math.ceil((r-a)/1e3);n&&(n.style.display="block",n.innerHTML=`Please continue reviewing for ${e} more seconds.`,n.style.color="#f57c00")}else i>=50&&n&&(n.style.display="block",n.innerHTML="Continue scrolling to review all terms.",n.style.color="#2196F3")};e._scrollListener=d,e.addEventListener("scroll",d),setTimeout(d,500),$(document).off("change","#acceptUpdatedTerms"),$(document).on("change","#acceptUpdatedTerms",(function(){if(!s&&this.checked)return alert("Please read the terms summary by scrolling to the bottom before accepting."),void(this.checked=!1);t&&(t.disabled=!this.checked,console.log("Terms confirm button "+(this.checked?"enabled":"disabled")))})),console.log("Terms summary height:",e.clientHeight),console.log("Terms summary scroll height:",e.scrollHeight)}function fixModalBackdropIssue(){console.log("Applying modal backdrop fixes"),$("#termsUpdateModal").off("show.bs.modal"),$("#termsUpdateModal").off("shown.bs.modal"),$("#termsUpdateModal").off("hidden.bs.modal"),$("#termsUpdateModal").on("show.bs.modal",(function(){console.log("Modal show event triggered"),$(".modal-backdrop").length>1&&(console.log("Multiple backdrops detected, cleaning up"),$(".modal-backdrop").not(":first").remove())})),$("#termsUpdateModal").on("shown.bs.modal",(function(){console.log("Modal shown event triggered");const e=$(this);e.css("z-index",1050),$(".modal-backdrop").css("z-index",1040),$(".modal-body").css("overflow-y","auto"),setTimeout((function(){e.find(".modal-body").one("click",(function(){console.log("Modal body click detected - modal is interactive")}))}),500)})),$("#termsUpdateModal").on("hidden.bs.modal",(function(){console.log("Modal hidden event triggered"),removeAllBackdrops()}))}function emergencyModalReset(){console.log("Emergency modal reset initiated"),hideModal(),$(".modal-backdrop").remove(),$("body").removeClass("modal-open"),$("body").css("padding-right",""),$("body").css("overflow","");const e=document.getElementById("termsUpdateModal");return e&&(e.classList.remove("show"),e.style.display="none",e.setAttribute("aria-hidden","true"),e.removeAttribute("aria-modal")),console.log("Emergency modal reset completed"),!0}console.log("Login handler script loaded"),document.addEventListener("DOMContentLoaded",(function(){setTimeout(fixLoginMenuIssue,500),setTimeout(updateLoginUI,500)})),document.addEventListener("termsModalReady",(function(){console.log("Received terms modal ready event"),"function"==typeof setupTermsModalHandlers&&setupTermsModalHandlers();const e=localStorage.getItem("patriotThanksSession");if(e)try{const o=JSON.parse(e);setTimeout((function(){checkTermsVersion(o)}),100)}catch(e){console.error("Error parsing session data:",e)}})),window.loginUser=handleLogin,window.logoutUser=logoutUser,window.checkLoginStatus=checkLoginStatus,window.getAuthToken=getAuthToken,window.toggleAdminElements=toggleAdminElements,window.updateTermsAcceptance=updateTermsAcceptance,window.hideModal=hideModal,window.emergencyModalReset=emergencyModalReset,window.showEmergencyButton=showEmergencyButton,$((function(){console.log("jQuery ready in bootstrap5-login-handler.js"),attachLoginListeners(),setTimeout(checkLoginStatus,500),setTimeout(updateLoginUI,500)}));