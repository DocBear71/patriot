let loadSpinner;function showSpinner(){loadSpinner=document.getElementById("spinner-container"),loadSpinner&&(loadSpinner.style.display="flex",loadSpinner.style.opacity=1)}function hideLoadingSpinner(){setTimeout((()=>{loadSpinner.style.opacity=0,loadSpinner.style.transition="opacity 0.5s",setTimeout((()=>{loadSpinner.style.display="none"}),500)}),500)}document.addEventListener("DOMContentLoaded",(function(){let t=[],e=[],n={};function o(t,e){if(console.error("API Error:",t),401===t.status)return console.error("Authentication Error -- Please log in again"),"function"==typeof e?void e():void setTimeout((()=>{window.location.href="/index.html?login=required&redirect="+encodeURIComponent(window.location.pathname)}),2e3);"function"==typeof e&&e()}async function s(){showSpinner();try{const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,e=m();if(!e)return console.error("No auth token found for loadDashboardStats"),void hideLoadingSpinner();console.log("Fetching dashboard stats...");const o=await fetch(`${t}/api/auth.js?operation=dashboard-stats`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Cache-Control":"no-cache"}});if(!o.ok)throw console.error("Error fetching dashboard stats:",o.status),o;const s=await o.json();console.log("Dashboard stats from API:",s),n=s,console.log("üîó Loading chain statistics...");try{const t=await c();t?(n.chainCount=t.totalChains,n.chainLocations=t.totalChainLocations,n.chainIncentives=t.totalChainIncentives,n.activeChainsWithIncentives=t.activeChainsWithIncentives,n.averageLocationsPerChain=t.averageLocationsPerChain,n.averageIncentivesPerChain=t.averageIncentivesPerChain,n.chainChange=t.chainGrowthPercentage,n.chainsThisMonth=t.chainsThisMonth,n.chainsAtStartOfMonth=t.chainsAtStartOfMonth,n.chainIncentiveChange=t.chainIncentiveGrowthPercentage,n.chainIncentivesThisMonth=t.chainIncentivesThisMonth,n.chainIncentivesAtStartOfMonth=t.chainIncentivesAtStartOfMonth,console.log(`‚úÖ Chain stats loaded: ${t.totalChains} chains, ${t.totalChainLocations} locations`),console.log(`üìà REAL GROWTH: ${t.chainGrowthPercentage}% (${t.chainsThisMonth} new this month vs ${t.chainsAtStartOfMonth} at start)`),console.log(`üéÅ INCENTIVE GROWTH: ${t.chainIncentiveGrowthPercentage}% (${t.chainIncentivesThisMonth} new incentives this month)`)):(console.log("‚ùå Chain stats failed to load"),n.chainCount=0,n.chainChange=0,n.chainIncentiveChange=0)}catch(t){console.error("Error loading chain stats:",t),n.chainCount=0,n.chainChange=0}n.regularBusinessCount=n.businessCount||0,n.userCount=n.userCount||0,n.userChange=n.userChange||0,n.businessChange=n.businessChange||0,n.incentiveCount=n.incentiveCount||0,n.incentiveChange=n.incentiveChange||0,console.log("üìä Final dashboard stats:",n),a(),hideLoadingSpinner()}catch(t){console.error("Error in loadDashboardStats:",t),o(t,(()=>{n={userCount:6,userChange:50,businessCount:22,regularBusinessCount:22,chainCount:0,businessChange:267,incentiveCount:14,incentiveChange:40,chainChange:0},c().then((t=>{t&&(n.chainCount=t.totalChains,n.chainChange=8,a())})),a(),hideLoadingSpinner()}))}}function a(){const t=n;console.log("üîó ENHANCED: Updating dashboard with enhanced stats (5 cards):",t);const e=t.userCount||0,o="number"==typeof t.userChange?t.userChange:0,s=t.businessCount||t.regularBusinessCount||0,a=t.chainCount||0,i="number"==typeof t.businessChange?t.businessChange:0,c="number"==typeof t.chainChange?t.chainChange:0,r=t.incentiveCount||0,l="number"==typeof t.incentiveChange?t.incentiveChange:0,d=t.chainIncentives||0,h="number"==typeof t.chainIncentiveChange?t.chainIncentiveChange:0,u=t.activeChainsWithIncentives||0;console.log(`üìä Values being used: Users=${e}, Businesses=${s}, Chains=${a}, Incentives=${r}, Chain Incentives=${d}`);const m=document.getElementById("dashboard-users-stat"),g=document.getElementById("dashboard-businesses-stat"),v=document.getElementById("dashboard-chains-stat"),C=document.getElementById("dashboard-incentives-stat"),b=document.getElementById("dashboard-chain-incentives-stat");m&&(m.textContent=e,console.log(`‚úÖ Updated users: ${e}`)),g&&(g.textContent=`${s} locations`,console.log(`‚úÖ Updated businesses: ${s} locations`)),v&&(v.textContent=a,console.log(`‚úÖ Updated chains: ${a}`)),C&&(C.textContent=r,console.log(`‚úÖ Updated incentives: ${r}`)),b&&(b.textContent=`${d} total`,console.log(`‚úÖ Updated chain incentives: ${d}`));const p=document.getElementById("dashboard-chain-incentives-breakdown");p&&(p.innerHTML=`${u} chains ‚Ä¢ ${t.averageIncentivesPerChain||0} avg per chain`);const f=document.getElementById("dashboard-users-change"),w=document.getElementById("dashboard-businesses-change"),y=document.getElementById("dashboard-chains-change"),E=document.getElementById("dashboard-incentives-change"),I=document.getElementById("dashboard-chain-incentives-change");f&&(f.textContent=`${o>=0?"‚Üë":"‚Üì"} ${Math.abs(o)}% from last month`),w&&(w.textContent=`${i>=0?"‚Üë":"‚Üì"} ${Math.abs(i)}% from last month`),y&&(y.textContent=`${c>=0?"‚Üë":"‚Üì"} ${Math.abs(c)}% from last month`),E&&(E.textContent=`${l>=0?"‚Üë":"‚Üì"} ${Math.abs(l)}% from last month`),I&&(I.textContent=`${h>=0?"‚Üë":"‚Üì"} ${Math.abs(h)}% from last month`),function(t){const e=document.getElementById("total-users-count");e&&(e.textContent=t.userCount||0);const n=document.getElementById("active-users-count");n&&(n.textContent=t.activeUserCount||Math.floor(.85*(t.userCount||0)));const o=document.getElementById("new-users-count");o&&(o.textContent=t.newUsersThisMonth||Math.ceil((t.userCount||0)*((t.userChange||0)/100)));const s=document.getElementById("total-businesses-count");s&&(void 0!==t.regularBusinessCount&&void 0!==t.chainCount?s.textContent=`${t.businessCount} (${t.regularBusinessCount} locations + ${t.chainCount} chains)`:s.textContent=t.businessCount||0);const a=document.getElementById("active-businesses-count");a&&(a.textContent=Math.floor(.95*(t.businessCount||0)));const i=document.getElementById("new-businesses-count");i&&(i.textContent=t.newBusinessesThisMonth||Math.ceil((t.businessCount||0)*((t.businessChange||0)/100)));const c=document.getElementById("total-incentives-count");c&&(c.textContent=t.incentiveCount||0);const r=document.getElementById("available-incentives-count");r&&(r.textContent=Math.floor(.9*(t.incentiveCount||0)));const l=document.getElementById("new-incentives-count");l&&(l.textContent=t.newIncentivesThisMonth||Math.ceil((t.incentiveCount||0)*((t.incentiveChange||0)/100)))}(t)}async function i(){try{const e=document.getElementById("dashboard-users-table");e&&(e.innerHTML='<tr><td colspan="6" class="text-center">Loading users...</td></tr>');const o="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,s=m();if(!s)return console.error("No auth token found for loadUsers"),void(e&&(e.innerHTML='<tr><td colspan="6" class="text-center text-danger">Authentication error. Please log in.</td></tr>'));console.log("Fetching users...");const i=await fetch(`${o}/api/auth.js?operation=dashboard-stats`,{method:"GET",headers:{Authorization:`Bearer ${s}`,"Cache-Control":"no-cache"}});if(i.ok){const t=await i.json();console.log("Dashboard stats from API:",t),n&&(n.userCount=t.userCount||0,n.activeUserCount=t.activeUserCount||0,n.newUsersThisMonth=t.newUsersThisMonth||0,n.userChange=t.userChange||0)}const c=await fetch(`${o}/api/auth.js?operation=list-users&page=1&limit=5`,{method:"GET",headers:{Authorization:`Bearer ${s}`,"Cache-Control":"no-cache"}});if(!c.ok)throw console.error("API error response:",c.status,c.statusText),c;const r=await c.json();console.log("Users data from API:",r),t=r.users||[],!n.userCount&&r.total&&(n.userCount=r.total,n.activeUserCount=Math.floor(.9*r.total),n.newUsersThisMonth=Math.max(1,Math.floor(.1*r.total))),function(){const e=document.getElementById("dashboard-users-table");if(e)if(0!==t.length){if(e.innerHTML="",t.forEach((t=>{let n="N/A";t.created_at&&(n=new Date(t.created_at).toLocaleDateString());let o="";switch(t.status){case"AD":o='<span class="badge badge-active">Active-Duty</span>';break;case"VT":o='<span class="badge badge-veteran">Veteran</span>';break;case"FR":o='<span class="badge badge-first-responder">First Responder</span>';break;case"SP":o='<span class="badge badge-spouse">Spouse</span>';break;case"BO":o='<span class="badge badge-business-owner">Business Owner</span>';break;case"SU":o='<span class="badge badge-supporter">Supporter</span>';break;default:o='<span class="badge badge-secondary">Unknown</span>'}let s="";switch(t.level){case"Free":s='<span class="badge badge-free">Free</span>';break;case"Basic":s='<span class="badge badge-basic">Basic</span>';break;case"Premium":s='<span class="badge badge-premium">Premium</span>';break;case"VIP":s='<span class="badge badge-vip">V.I.P.</span>';break;case"Admin":s='<span class="badge badge-admin">Admin</span>';break;default:s='<span class="badge badge-secondary">Unknown</span>'}const a=document.createElement("tr");a.innerHTML=`\n            <td>${t.fname||""} ${t.lname||""}</td>\n            <td>${t.email||"N/A"}</td>\n            <td>${o}</td>\n            <td>${s}</td>\n            <td>${n}</td>\n            <td>\n                <div class="action-buttons">\n                    <a href="admin-users.html?edit=${t._id}" class="btn btn-sm btn-info">Edit</a>\n                </div>\n            </td>\n        `,e.appendChild(a)})),n){const t=document.getElementById("total-users-count");t&&(t.textContent=n.userCount||"0");const e=document.getElementById("active-users-count");e&&(e.textContent=n.activeUserCount||"0");const o=document.getElementById("new-users-count");o&&(o.textContent=n.newUsersThisMonth||"0")}!function(){const t=document.getElementById("quick-user-search");t&&t.addEventListener("input",(function(){const t=this.value.toLowerCase();document.querySelectorAll("#dashboard-users-table tr").forEach((e=>{let n=!1;e.querySelectorAll("td").forEach((e=>{e.textContent.toLowerCase().includes(t)&&(n=!0)})),e.style.display=n?"":"none"}))}))}()}else e.innerHTML='<tr><td colspan="6" class="text-center">No users found</td></tr>';else console.error("User table body element not found")}(),a()}catch(t){console.error("Error loading users:",t),o(t,(()=>{const t=document.getElementById("dashboard-users-table");t&&(t.innerHTML='<tr><td colspan="6" class="text-center text-danger">Error loading users. Please try again later.</td></tr>'),n&&(n.userCount=n.userCount||4,n.activeUserCount=n.activeUserCount||3,n.newUsersThisMonth=n.newUsersThisMonth||1,n.userChange=n.userChange||25),a()}))}}async function c(){console.log("üîó Loading chain statistics for dashboard");try{const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,e=m();if(!e)return console.error("No auth token found for loadChainStats"),null;const n=await fetch(`${t}/api/chains.js?operation=summary`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Cache-Control":"no-cache"}});if(!n.ok)throw console.error("Error fetching chain stats:",n.status),n;const o=await n.json();console.log("üîó Chain stats from API:",o);const s=o.chain_growth_percentage||0,a=o.chain_incentive_growth_percentage||0;return console.log(`üìä REAL MONTHLY GROWTH: ${s}% (${o.chains_this_month} new chains this month)`),console.log(`üéÅ CHAIN INCENTIVE GROWTH: ${a}% (${o.chain_incentives_this_month} new incentives this month)`),{totalChains:o.total_chains||0,totalChainLocations:o.total_locations||0,totalChainIncentives:o.total_incentives||0,activeChainsWithIncentives:o.active_chains_with_incentives||0,averageLocationsPerChain:o.average_locations_per_chain||0,averageIncentivesPerChain:o.average_incentives_per_active_chain||0,chainGrowthPercentage:s,chainsThisMonth:o.chains_this_month||0,chainsAtStartOfMonth:o.chains_at_start_of_month||0,chainIncentiveGrowthPercentage:a,chainIncentivesThisMonth:o.chain_incentives_this_month||0,chainIncentivesAtStartOfMonth:o.chain_incentives_at_start_of_month||0}}catch(t){return console.error("‚ùå Error loading chain stats:",t),{totalChains:0,totalChainLocations:0,totalChainIncentives:0,activeChainsWithIncentives:0,averageLocationsPerChain:0,averageIncentivesPerChain:0,chainGrowthPercentage:0,chainsThisMonth:0,chainsAtStartOfMonth:0,chainIncentiveGrowthPercentage:0,chainIncentivesThisMonth:0,chainIncentivesAtStartOfMonth:0}}}function r(){const t=document.getElementById("dashboard-businesses-table");t&&(0!==e.length?(t.innerHTML="",e.forEach((e=>{let n="",o="";e.is_chain?(n=`Chain (${e.location_count||0} locations)`,o=`${e.type||"Chain"} üîó`):(n=e.city&&e.state?`${e.city}, ${e.state}`:"Location not specified",o=e.type||"Other",(e.chain_id||e.chain_name)&&(o+=" üè¢"));const s="active"===e.status?'<span class="badge badge-success">Active</span>':'<span class="badge badge-secondary">Inactive</span>',a=document.createElement("tr");a.innerHTML=`\n            <td>${e.bname||e.chain_name||"N/A"}</td>\n            <td>${n}</td>\n            <td>${o}</td>\n            <td>${s}</td>\n            <td>\n                <div class="action-btns">\n                    <a href="${e.is_chain?"admin-chains.html":"admin-business.html"}?edit=${e._id}" class="btn btn-sm btn-info">Edit</a>\n                </div>\n            </td>\n        `,t.appendChild(a)})),function(){const t=document.getElementById("total-businesses-count");t&&(t.textContent=n&&n.businessCount||"0");const e=document.getElementById("active-businesses-count");if(e&&n){const t=n.activeBusinessCount||Math.floor(.95*(n.businessCount||0));e.textContent=t.toString()}const o=document.getElementById("new-businesses-count");o&&n&&(o.textContent=(n.newBusinessesThisMonth||"0").toString())}(),function(){const t=document.getElementById("quick-business-search");t&&t.addEventListener("input",(function(){const t=this.value.toLowerCase();document.querySelectorAll("#dashboard-businesses-table tr").forEach((e=>{let n=!1;e.querySelectorAll("td").forEach((e=>{e.textContent.toLowerCase().includes(t)&&(n=!0)})),e.style.display=n?"":"none"}))}))}()):t.innerHTML='<tr><td colspan="5" class="text-center">No businesses found</td></tr>')}function l(t){const e=document.getElementById("dashboard-incentives-table");e&&(t&&0!==t.length?(e.innerHTML="",t.forEach((t=>{const n={VT:"Veteran",AD:"Active-Duty",FR:"First Responder",SP:"Spouse",OT:"Other"}[o=t.type]||o;var o;const s="OT"===t.type&&t.other_description?`<br><em>(${t.other_description})</em>`:"",a=t.is_available?"Yes":"No",i=t.is_available?"text-success":"text-danger",c=t.amount?`${t.amount}%`:"N/A",r=document.createElement("tr");r.innerHTML=`\n        <td>${t.businessName||"Unknown Business"}</td>\n        <td>${n}${s}</td>\n        <td class="${i}">${a}</td>\n        <td>${c}</td>\n        <td>${t.information||"No information available"}</td>\n        <td>\n            <div class="action-btns">\n                <a href="admin-incentives.html?edit=${t._id}" class="btn btn-sm btn-info">Edit</a>\n            </div>\n        </td>\n    `,e.appendChild(r)})),function(){const t=document.getElementById("quick-incentive-search");t&&t.addEventListener("input",(function(){const t=this.value.toLowerCase();document.querySelectorAll("#dashboard-incentives-table tr").forEach((e=>{let n=!1;e.querySelectorAll("td").forEach((e=>{e.textContent.toLowerCase().includes(t)&&(n=!0)})),e.style.display=n?"":"none"}))}))}()):e.innerHTML='<tr><td colspan="6" class="text-center">No incentives found</td></tr>')}const d=document.querySelectorAll(".menu-item"),h=document.querySelectorAll(".panel");d.forEach((t=>{t.addEventListener("click",(function(){if(this.querySelector("a"))return;d.forEach((t=>t.classList.remove("active"))),h.forEach((t=>t.classList.remove("active"))),this.classList.add("active");const t=this.getAttribute("data-section");document.getElementById(`${t}-panel`)?.classList.add("active"),document.querySelector(".header h1").textContent=this.querySelector("span:last-child").textContent,"users"===t?i():"businesses"===t?async function(){console.log("üè¢ FIXED: Loading businesses with separated chains support");try{const t=document.getElementById("dashboard-businesses-table");t&&(t.innerHTML='<tr><td colspan="6" class="text-center">Loading businesses...</td></tr>');const o="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,s=m();if(!s)return console.error("No auth token found"),void(t&&(t.innerHTML='<tr><td colspan="6" class="text-center text-danger">Authentication error. Please log in again.</td></tr>'));console.log("Using token for API request: ",s.substring(0,10)+"...");const a=await fetch(`${o}/api/business.js?operation=admin-list-businesses&page=1&limit=5&include_chains=true`,{method:"GET",headers:{Authorization:`Bearer ${s}`,"Cache-Control":"no-cache"}});if(!a.ok){if(console.error("API error response: ",a.status,a.statusText),401===a.status)return console.error("Unauthorized request -- token may be invalid"),void(t&&(t.innerHTML='<tr><td colspan="6" class="text-center text-danger">Authentication error. Please log in again.</td></tr>'));throw a}const i=await a.json();console.log("üè¢ FIXED: Businesses data from API:",i),e=i.businesses||[];const c=i.total||0,l=i.breakdown||{},d=l.businesses||0,h=l.chains||0;console.log(`üìä FIXED: Business breakdown - ${d} locations + ${h} chains = ${c} total`),n&&(n.businessCount=c,n.regularBusinessCount=d,n.chainCount=h);const u=e.filter((t=>"active"===t.status)).length;let g=u;if(c>e.length){const t=u/e.length;g=Math.round(t*c)}const v=(new Date).getMonth(),C=(new Date).getFullYear();let b=0;e.forEach((t=>{if(t.created_at){const e=new Date(t.created_at);e.getMonth()===v&&e.getFullYear()===C&&b++}})),c>e.length&&e.length>0&&(b=Math.round(b/e.length*c)),n&&(n.newBusinessesThisMonth=b),r();const p=document.getElementById("total-businesses-count");p&&(p.textContent=c.toString());const f=document.getElementById("active-businesses-count");f&&(f.textContent=g.toString());const w=document.getElementById("new-businesses-count");w&&(w.textContent=b.toString()),console.log("‚úÖ FIXED: Businesses loaded successfully")}catch(t){o(t,(()=>{const t=document.getElementById("dashboard-businesses-table");t&&(t.innerHTML='<tr><td colspan="6" class="text-center text-danger">Error loading businesses. Please try again later.</td></tr>'),console.warn("Using mock data for development"),e=[{_id:"1",bname:"Tech Solutions Inc.",city:"Cedar Rapids",state:"IA",type:"technology",status:"active"},{_id:"2",bname:"Hometown Diner",city:"Marion",state:"IA",type:"food",status:"active"},{_id:"3",bname:"Cedar Medical Center",city:"Cedar Rapids",state:"IA",type:"healthcare",status:"active"}],r()}))}}():"incentives"===t?async function(){try{const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,e=m();if(!e)return console.error("No auth token found"),void(incentiveTableBody&&(incentiveTableBody.innerHTML='<tr><td colspan="6" class="text-center text-danger">Authentication error. Please log in again.</td></tr>'));const o=await fetch(`${t}/api/combined-api.js?operation=admin-incentives&action=admin-list-incentives&page=1&limit=1`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Cache-Control":"no-cache"}});if(!o.ok)throw o;const s=await o.json();console.log("Total incentives data:",s);const a=s.total||0,i=await fetch(`${t}/api/combined-api.js?operation=admin-incentives&action=admin-list-incentives&is_available=true&page=1&limit=1`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Cache-Control":"no-cache"}});if(!i.ok)throw i;const c=await i.json();console.log("Available incentives data:",c);const r=c.total||0,d=await fetch(`${t}/api/combined-api.js?operation=admin-incentives&action=admin-list-incentives&page=1&limit=5`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Cache-Control":"no-cache"}});if(!d.ok){if(console.error("API error response: ",d.status,d.statusText),401===d.status)return console.error("Unauthorized request -- token may be invalid"),void(incentiveTableBody&&(incentiveTableBody.innerHTML='<tr><td colspan="6" class="text-center text-danger">Authentication error. Please log in again.</td></tr>'));throw d}const h=await d.json();console.log("Incentives sample data from API:",h),n&&(n.incentiveCount=a,n.availableIncentiveCount=r);const u=(new Date).getMonth()+1,g=(new Date).getFullYear();try{const o=`${g}-${u.toString().padStart(2,"0")}`,s=await fetch(`${t}/api/combined-api.js?operation=admin-incentives&action=admin-list-incentives&created_after=${o}-01&page=1&limit=1`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Cache-Control":"no-cache"}});if(s.ok){const t=await s.json();console.log("New incentives this month:",t);const e=t.total||0;n&&(n.newIncentivesThisMonth=e)}}catch(t){console.error("Error fetching new incentives:",t),n&&(n.newIncentivesThisMonth=Math.round(.1*a))}l(h.incentives||h.results||[]),function(t,e,n){const o=document.getElementById("total-incentives-count");o&&(o.textContent=t.toString());const s=document.getElementById("available-incentives-count");s&&(s.textContent=e.toString());const a=document.getElementById("new-incentives-count");a&&(a.textContent=n.toString())}(a,r,n.newIncentivesThisMonth||0)}catch(t){o(t,(()=>{const t=document.getElementById("dashboard-incentives-table");t&&(t.innerHTML='<tr><td colspan="6" class="text-center text-danger">Error loading incentives. Please try again later.</td></tr>'),l([{_id:"1",business_id:"1",businessName:"Tech Solutions Inc.",type:"VT",is_available:!0,amount:10,information:"Veterans get 10% off all services.",created_at:"2025-04-01T00:00:00.000Z"},{_id:"2",business_id:"2",businessName:"Hometown Diner",type:"AD",is_available:!0,amount:15,information:"Active-Duty military receive 15% discount.",created_at:"2025-04-05T00:00:00.000Z"},{_id:"3",business_id:"3",businessName:"Cedar Medical Center",type:"FR",is_available:!0,amount:20,information:"First responders receive 20% off select services.",created_at:"2025-04-10T00:00:00.000Z"}])}))}}():"dashboard"===t&&s()}))})),document.querySelectorAll(".tab").forEach((t=>{t.addEventListener("click",(function(){const t=this.closest(".panel");t.querySelectorAll(".tab").forEach((t=>t.classList.remove("active"))),this.classList.add("active"),t.querySelectorAll(".tab-content").forEach((t=>t.classList.remove("active")));const e=this.getAttribute("data-tab");t.querySelector(`#${e}`).classList.add("active")}))}));const u=document.querySelector(".search-container input");function m(){try{const t=localStorage.getItem("patriotThanksSession");if(!t)return console.error("No session data found"),null;const e=JSON.parse(t);return e.token?e.token:(console.error("No token found in session data"),null)}catch(t){return console.error("Error retrieving auth token:",t),null}}u?.addEventListener("input",(function(){const t=this.value.toLowerCase(),e=document.querySelector(".panel.active");e&&e.querySelectorAll("tbody tr").forEach((e=>{let n=!1;e.querySelectorAll("td").forEach((e=>{e.textContent.toLowerCase().includes(t)&&(n=!0)})),e.style.display=n?"":"none"}))})),showSpinner(),function(){const t=new URLSearchParams(window.location.search).get("section");if(t){const e=document.querySelector(`.menu-item[data-section="${t}"]`);e&&e.click()}else s()}(),async function(){try{const t=m();if(!t)return console.error("No auth token found"),window.location.href="/index.html?login=required&redirect="+encodeURIComponent(window.location.pathname),!1;const e="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin;try{const n=await fetch(`${e}/api/auth.js?operation=verify-token`,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Cache-Control":"no-cache"}});if(!n.ok)return 401===n.status&&(window.location.href="/index.html?login=required&redirect="+encodeURIComponent(window.location.pathname),!1);const o=await n.json();return!(!0!==o.isAdmin&&"Admin"!==o.level&&(document.querySelector(".container").innerHTML='\n        <div class="alert alert-danger" role="alert">\n            <h4 class="alert-heading">Access Denied</h4>\n            <p>You do not have permission to access this page. Only administrators can access the dashboard.</p>\n            <hr>\n            <p class="mb-0">Please <a href="/index.html">return to the homepage</a> or contact an administrator if you believe this is an error.</p>\n        </div>\n    ',1))}catch(t){return console.error("Error checking admin status:",t),console.warn("DEVELOPMENT MODE: Bypassing admin verification"),confirm("API error encountered. Would you like to bypass admin verification for development purposes?")}}catch(t){return console.error("Error in admin status check:",t),!1}}(),function(){if(s&&"function"==typeof s){const t=s;s=async function(){await t(),function(){if(!n)return;const t=document.querySelector('#dashboard-panel div[style*="grid-template-columns"]');if(t){const e=t.querySelector("div:nth-child(1)");if(e){const t=e.querySelector("p:nth-child(2)"),o=e.querySelector("p:nth-child(3)");if(t&&(t.textContent=n.userCount||"0"),o){const t=n.userChange||0;o.textContent=`${t>=0?"‚Üë":"‚Üì"} ${Math.abs(t)}% from last month`}}}const e=document.getElementById("total-users-count");e&&(e.textContent=n.userCount||"0");const o=document.getElementById("active-users-count");o&&(o.textContent=n.activeUserCount||"0");const s=document.getElementById("new-users-count");s&&(s.textContent=n.newUsersThisMonth||"0")}()}}document.querySelectorAll(".menu-item").forEach((t=>{t.addEventListener("click",(function(){"users"===this.getAttribute("data-section")&&i()}))}))}()}));