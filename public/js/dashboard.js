let loadSpinner;function showSpinner(){loadSpinner=document.getElementById("spinner-container"),loadSpinner&&(loadSpinner.style.display="flex",loadSpinner.style.opacity=1)}function hideLoadingSpinner(){setTimeout((()=>{loadSpinner.style.opacity=0,loadSpinner.style.transition="opacity 0.5s",setTimeout((()=>{loadSpinner.style.display="none"}),500)}),500)}document.addEventListener("DOMContentLoaded",(function(){let e=[],t=[],n={};function o(e,t){if(console.error("API Error:",e),401===e.status)return console.error("Authentication Error -- Please log in again"),"function"==typeof t?void t():void setTimeout((()=>{window.location.href="/index.html?login=required&redirect="+encodeURIComponent(window.location.pathname)}),2e3);"function"==typeof t&&t()}async function s(){showSpinner();try{const e="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,t=m();if(!t)return console.error("No auth token found for loadDashboardStats"),void hideLoadingSpinner();console.log("Fetching dashboard stats...");const o=await fetch(`${e}/api/auth.js?operation=dashboard-stats`,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Cache-Control":"no-cache"}});if(!o.ok)throw console.error("Error fetching dashboard stats:",o.status),o;const s=await o.json();if(console.log("Dashboard stats from API:",s),n=s,!n.userCount||!n.businessCount||!n.incentiveCount){console.log("Missing business or incentive counts, fetching them separately");try{const o=await fetch(`${e}/api/user.js?operation=admin-list-users&page=1&limit=1`,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Cache-Control":"no-cache"}});if(o.ok){const e=await o.json();console.log("Business data:",e),n.userCount=e.total||22,n.userChange=n.userChange||5}}catch(e){console.error("Error fetching business count:",e),n.userCount=22,n.userChange=5}try{const o=await fetch(`${e}/api/business.js?operation=admin-list-businesses&page=1&limit=1`,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Cache-Control":"no-cache"}});if(o.ok){const e=await o.json();console.log("Business data:",e),n.businessCount=e.total||22,n.businessChange=n.businessChange||5}}catch(e){console.error("Error fetching business count:",e),n.businessCount=22,n.businessChange=5}try{const o=await fetch(`${e}/api/admin-incentives.js?operation=admin-list-incentives&page=1&limit=1`,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Cache-Control":"no-cache"}});if(o.ok){const e=await o.json();console.log("Incentive data:",e),n.incentiveCount=e.total||16,n.incentiveChange=n.incentiveChange||8}}catch(e){console.error("Error fetching incentive count:",e),n.incentiveCount=16,n.incentiveChange=8}}n.userCount&&!n.userChange&&(n.userChange=10),a(),hideLoadingSpinner()}catch(e){console.error("Error in loadDashboardStats:",e),o(e,(()=>{n={userCount:4,userChange:25,businessCount:22,businessChange:5,incentiveCount:16,incentiveChange:8},a(),hideLoadingSpinner()}))}}function a(){const e=n;console.log("Updating dashboard with stats:",e);const t=e.userCount||0,o="number"==typeof e.userChange?e.userChange:0,s=e.businessCount||0,a="number"==typeof e.businessChange?e.businessChange:0,i=e.incentiveCount||0,r="number"==typeof e.incentiveChange?e.incentiveChange:0,c=document.querySelector('#dashboard-panel div[style*="grid-template-columns"]');c?c.innerHTML=`\n            <div style="background-color: #3498db; color: white; padding: 20px; border-radius: 5px;">\n                <h3>Total Users</h3>\n                <p style="font-size: 2rem; margin: 10px 0;">${t}</p>\n                <p>${o>=0?"↑":"↓"} ${Math.abs(o)}% from last month</p>\n            </div>\n            <div style="background-color: #2ecc71; color: white; padding: 20px; border-radius: 5px;">\n                <h3>Businesses</h3>\n                <p style="font-size: 2rem; margin: 10px 0;">${s}</p>\n                <p>${a>=0?"↑":"↓"} ${Math.abs(a)}% from last month</p>\n            </div>\n            <div style="background-color: #e74c3c; color: white; padding: 20px; border-radius: 5px;">\n                <h3>Incentives</h3>\n                <p style="font-size: 2rem; margin: 10px 0;">${i}</p>\n                <p>${r>=0?"↑":"↓"} ${Math.abs(r)}% from last month</p>\n            </div>\n        `:console.error("Could not find stats container element");const d=document.getElementById("total-users-count");d&&(d.textContent=t);const l=document.getElementById("active-users-count");l&&(l.textContent=e.activeUserCount||Math.floor(.85*t));const u=document.getElementById("new-users-count");u&&(u.textContent=e.newUsersThisMonth||Math.ceil(t*(o/100)))}async function i(){try{const t=document.getElementById("dashboard-users-table");t&&(t.innerHTML='<tr><td colspan="6" class="text-center">Loading users...</td></tr>');const o="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,s=m();if(!s)return console.error("No auth token found for loadUsers"),void(t&&(t.innerHTML='<tr><td colspan="6" class="text-center text-danger">Authentication error. Please log in.</td></tr>'));console.log("Fetching users...");const i=await fetch(`${o}/api/auth.js?operation=dashboard-stats`,{method:"GET",headers:{Authorization:`Bearer ${s}`,"Cache-Control":"no-cache"}});if(i.ok){const e=await i.json();console.log("Dashboard stats from API:",e),n&&(n.userCount=e.userCount||0,n.activeUserCount=e.activeUserCount||0,n.newUsersThisMonth=e.newUsersThisMonth||0,n.userChange=e.userChange||0)}const r=await fetch(`${o}/api/auth.js?operation=list-users&page=1&limit=5`,{method:"GET",headers:{Authorization:`Bearer ${s}`,"Cache-Control":"no-cache"}});if(!r.ok)throw console.error("API error response:",r.status,r.statusText),r;const c=await r.json();console.log("Users data from API:",c),e=c.users||[],!n.userCount&&c.total&&(n.userCount=c.total,n.activeUserCount=Math.floor(.9*c.total),n.newUsersThisMonth=Math.max(1,Math.floor(.1*c.total))),function(){const t=document.getElementById("dashboard-users-table");if(t)if(0!==e.length){if(t.innerHTML="",e.forEach((e=>{let n="N/A";e.created_at&&(n=new Date(e.created_at).toLocaleDateString());let o="";switch(e.status){case"AD":o='<span class="badge badge-active">Active Duty</span>';break;case"VT":o='<span class="badge badge-veteran">Veteran</span>';break;case"FR":o='<span class="badge badge-first-responder">First Responder</span>';break;case"SP":o='<span class="badge badge-spouse">Spouse</span>';break;case"BO":o='<span class="badge badge-business-owner">Business Owner</span>';break;case"SU":o='<span class="badge badge-supporter">Supporter</span>';break;default:o='<span class="badge badge-secondary">Unknown</span>'}let s="";switch(e.level){case"Free":s='<span class="badge badge-free">Free</span>';break;case"Basic":s='<span class="badge badge-basic">Basic</span>';break;case"Premium":s='<span class="badge badge-premium">Premium</span>';break;case"VIP":s='<span class="badge badge-vip">V.I.P.</span>';break;case"Admin":s='<span class="badge badge-admin">Admin</span>';break;default:s='<span class="badge badge-secondary">Unknown</span>'}const a=document.createElement("tr");a.innerHTML=`\n            <td>${e.fname||""} ${e.lname||""}</td>\n            <td>${e.email||"N/A"}</td>\n            <td>${o}</td>\n            <td>${s}</td>\n            <td>${n}</td>\n            <td>\n                <div class="action-buttons">\n                    <a href="admin-users.html?edit=${e._id}" class="btn btn-sm btn-info">Edit</a>\n                </div>\n            </td>\n        `,t.appendChild(a)})),n){const e=document.getElementById("total-users-count");e&&(e.textContent=n.userCount||"0");const t=document.getElementById("active-users-count");t&&(t.textContent=n.activeUserCount||"0");const o=document.getElementById("new-users-count");o&&(o.textContent=n.newUsersThisMonth||"0")}!function(){const e=document.getElementById("quick-user-search");e&&e.addEventListener("input",(function(){const e=this.value.toLowerCase();document.querySelectorAll("#dashboard-users-table tr").forEach((t=>{let n=!1;t.querySelectorAll("td").forEach((t=>{t.textContent.toLowerCase().includes(e)&&(n=!0)})),t.style.display=n?"":"none"}))}))}()}else t.innerHTML='<tr><td colspan="6" class="text-center">No users found</td></tr>';else console.error("User table body element not found")}(),a()}catch(e){console.error("Error loading users:",e),o(e,(()=>{const e=document.getElementById("dashboard-users-table");e&&(e.innerHTML='<tr><td colspan="6" class="text-center text-danger">Error loading users. Please try again later.</td></tr>'),n&&(n.userCount=n.userCount||4,n.activeUserCount=n.activeUserCount||3,n.newUsersThisMonth=n.newUsersThisMonth||1,n.userChange=n.userChange||25),a()}))}}function r(){const e=document.getElementById("dashboard-businesses-table");e&&(0!==t.length?(e.innerHTML="",t.forEach((t=>{const n=t.city&&t.state?`${t.city}, ${t.state}`:"Location not specified",o="active"===t.status?'<span class="badge badge-success">Active</span>':'<span class="badge badge-secondary">Inactive</span>',s=document.createElement("tr");s.innerHTML=`\n            <td>${t.bname||"N/A"}</td>\n            <td>${n}</td>\n            <td>${t.type||"Other"}</td>\n            <td>${o}</td>\n            <td>\n                <div class="action-btns">\n                    <a href="admin-business.html?edit=${t._id}" class="btn btn-sm btn-info">Edit</a>\n                </div>\n            </td>\n        `,e.appendChild(s)})),function(){const e=document.getElementById("total-businesses-count");e&&(e.textContent=n&&n.businessCount||"0");const t=document.getElementById("active-businesses-count");if(t&&n){const e=n.activeBusinessCount||Math.floor(.95*(n.businessCount||0));t.textContent=e.toString()}const o=document.getElementById("new-businesses-count");o&&n&&(o.textContent=(n.newBusinessesThisMonth||"0").toString())}(),function(){const e=document.getElementById("quick-business-search");e&&e.addEventListener("input",(function(){const e=this.value.toLowerCase();document.querySelectorAll("#dashboard-businesses-table tr").forEach((t=>{let n=!1;t.querySelectorAll("td").forEach((t=>{t.textContent.toLowerCase().includes(e)&&(n=!0)})),t.style.display=n?"":"none"}))}))}()):e.innerHTML='<tr><td colspan="5" class="text-center">No businesses found</td></tr>')}const c=document.getElementById("businesses-list");if(c){const e=c.querySelector('div[style*="display: flex"]');if(e){const t=e.querySelector("#add-business-btn");if(t){const n=document.createElement("a");n.href="admin-business.html",n.className="btn btn-info mr-2",n.textContent="Full Business Management",e.insertBefore(n,t)}else e.innerHTML+='\n                <a href="../admin-business.html" class="btn btn-info">Full Business Management</a>\n            '}}function d(e){const t=document.getElementById("dashboard-incentives-table");t&&(e&&0!==e.length?(t.innerHTML="",e.forEach((e=>{const n={VT:"Veteran",AD:"Active Duty",FR:"First Responder",SP:"Spouse",OT:"Other"}[o=e.type]||o;var o;const s="OT"===e.type&&e.other_description?`<br><em>(${e.other_description})</em>`:"",a=e.is_available?"Yes":"No",i=e.is_available?"text-success":"text-danger",r=e.amount?`${e.amount}%`:"N/A",c=document.createElement("tr");c.innerHTML=`\n        <td>${e.businessName||"Unknown Business"}</td>\n        <td>${n}${s}</td>\n        <td class="${i}">${a}</td>\n        <td>${r}</td>\n        <td>${e.information||"No information available"}</td>\n        <td>\n            <div class="action-btns">\n                <a href="admin-incentives.html?edit=${e._id}" class="btn btn-sm btn-info">Edit</a>\n            </div>\n        </td>\n    `,t.appendChild(c)})),function(){const e=document.getElementById("quick-incentive-search");e&&e.addEventListener("input",(function(){const e=this.value.toLowerCase();document.querySelectorAll("#dashboard-incentives-table tr").forEach((t=>{let n=!1;t.querySelectorAll("td").forEach((t=>{t.textContent.toLowerCase().includes(e)&&(n=!0)})),t.style.display=n?"":"none"}))}))}()):t.innerHTML='<tr><td colspan="6" class="text-center">No incentives found</td></tr>')}const l=document.querySelectorAll(".menu-item"),u=document.querySelectorAll(".panel");l.forEach((e=>{e.addEventListener("click",(function(){if(this.querySelector("a"))return;l.forEach((e=>e.classList.remove("active"))),u.forEach((e=>e.classList.remove("active"))),this.classList.add("active");const e=this.getAttribute("data-section");document.getElementById(`${e}-panel`)?.classList.add("active"),document.querySelector(".header h1").textContent=this.querySelector("span:last-child").textContent,"users"===e?i():"businesses"===e?async function(){try{const e=document.getElementById("dashboard-businesses-table");e&&(e.innerHTML='<tr><td colspan="6" class="text-center">Loading businesses...</td></tr>');const o="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,s=m();if(!s)return console.error("No auth token found"),void(e&&(e.innerHTML='<tr><td colspan="6" class="text-center text-danger">Authentication error. Please log in again.</td></tr>'));console.log("Using token for API request: ",s.substring(0,10)+"...");const a=await fetch(`${o}/api/business.js?operation=admin-list-businesses&page=1&limit=5`,{method:"GET",headers:{Authorization:`Bearer ${s}`,"Cache-Control":"no-cache"}});if(!a.ok){if(console.error("API error response: ",a.status,a.statusText),401===a.status)return console.error("Unauthorized request -- token may be invalid"),void(e&&(e.innerHTML='<tr><td colspan="6" class="text-center text-danger">Authentication error. Please log in again.</td></tr>'));throw a}const i=await a.json();console.log("Businesses data from API:",i),t=i.businesses||[];const c=i.total||0;n&&(n.businessCount=c);const d=t.filter((e=>"active"===e.status)).length;let l=d;if(c>t.length){const e=d/t.length;l=Math.round(e*c)}const u=(new Date).getMonth(),h=(new Date).getFullYear();let g=0;t.forEach((e=>{if(e.created_at){const t=new Date(e.created_at);t.getMonth()===u&&t.getFullYear()===h&&g++}})),c>t.length&&t.length>0&&(g=Math.round(g/t.length*c)),n&&(n.newBusinessesThisMonth=g),r();const p=document.getElementById("total-businesses-count");p&&(p.textContent=c.toString());const b=document.getElementById("active-businesses-count");b&&(b.textContent=l.toString());const f=document.getElementById("new-businesses-count");f&&(f.textContent=g.toString())}catch(e){o(e,(()=>{const e=document.getElementById("dashboard-businesses-table");e&&(e.innerHTML='<tr><td colspan="6" class="text-center text-danger">Error loading businesses. Please try again later.</td></tr>'),t=[{_id:"1",bname:"Tech Solutions Inc.",city:"Cedar Rapids",state:"IA",type:"technology",status:"active"},{_id:"2",bname:"Hometown Diner",city:"Marion",state:"IA",type:"food",status:"active"},{_id:"3",bname:"Cedar Medical Center",city:"Cedar Rapids",state:"IA",type:"healthcare",status:"active"}],r()}))}}():"incentives"===e?async function(){try{const e=document.getElementById("dashboard-incentives-table");e&&(e.innerHTML='<tr><td colspan="6" class="text-center">Loading incentives...</td></tr>');const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin,o=m();if(!o)return console.error("No auth token found"),void(e&&(e.innerHTML='<tr><td colspan="6" class="text-center text-danger">Authentication error. Please log in again.</td></tr>'));const s=await fetch(`${t}/api/admin-incentives.js?operation=admin-list-incentives&page=1&limit=1`,{method:"GET",headers:{Authorization:`Bearer ${o}`,"Cache-Control":"no-cache"}});if(!s.ok)throw s;const a=await s.json();console.log("Total incentives data:",a);const i=a.total||0,r=await fetch(`${t}/api/admin-incentives.js?operation=admin-list-incentives&is_available=true&page=1&limit=1`,{method:"GET",headers:{Authorization:`Bearer ${o}`,"Cache-Control":"no-cache"}});if(!r.ok)throw r;const c=await r.json();console.log("Available incentives data:",c);const l=c.total||0,u=await fetch(`${t}/api/admin-incentives.js?operation=admin-list-incentives&page=1&limit=5`,{method:"GET",headers:{Authorization:`Bearer ${o}`,"Cache-Control":"no-cache"}});if(!u.ok){if(console.error("API error response: ",u.status,u.statusText),401===u.status)return console.error("Unauthorized request -- token may be invalid"),void(e&&(e.innerHTML='<tr><td colspan="6" class="text-center text-danger">Authentication error. Please log in again.</td></tr>'));throw u}const h=await u.json();console.log("Incentives sample data from API:",h),n&&(n.incentiveCount=i,n.availableIncentiveCount=l);const g=(new Date).getMonth()+1,p=(new Date).getFullYear();try{const e=`${p}-${g.toString().padStart(2,"0")}`,s=await fetch(`${t}/api/admin-incentives.js?operation=admin-list-incentives&created_after=${e}-01&page=1&limit=1`,{method:"GET",headers:{Authorization:`Bearer ${o}`,"Cache-Control":"no-cache"}});if(s.ok){const e=await s.json();console.log("New incentives this month:",e);const t=e.total||0;n&&(n.newIncentivesThisMonth=t)}}catch(e){console.error("Error fetching new incentives:",e),n&&(n.newIncentivesThisMonth=Math.round(.1*i))}d(h.incentives||h.results||[]),function(e,t,n){const o=document.getElementById("total-incentives-count");o&&(o.textContent=e.toString());const s=document.getElementById("available-incentives-count");s&&(s.textContent=t.toString());const a=document.getElementById("new-incentives-count");a&&(a.textContent=n.toString())}(i,l,n.newIncentivesThisMonth||0)}catch(e){o(e,(()=>{const e=document.getElementById("dashboard-incentives-table");e&&(e.innerHTML='<tr><td colspan="6" class="text-center text-danger">Error loading incentives. Please try again later.</td></tr>'),d([{_id:"1",business_id:"1",businessName:"Tech Solutions Inc.",type:"VT",is_available:!0,amount:10,information:"Veterans get 10% off all services.",created_at:"2025-04-01T00:00:00.000Z"},{_id:"2",business_id:"2",businessName:"Hometown Diner",type:"AD",is_available:!0,amount:15,information:"Active duty military receive 15% discount.",created_at:"2025-04-05T00:00:00.000Z"},{_id:"3",business_id:"3",businessName:"Cedar Medical Center",type:"FR",is_available:!0,amount:20,information:"First responders receive 20% off select services.",created_at:"2025-04-10T00:00:00.000Z"}])}))}}():"dashboard"===e&&s()}))})),document.querySelectorAll(".tab").forEach((e=>{e.addEventListener("click",(function(){const e=this.closest(".panel");e.querySelectorAll(".tab").forEach((e=>e.classList.remove("active"))),this.classList.add("active"),e.querySelectorAll(".tab-content").forEach((e=>e.classList.remove("active")));const t=this.getAttribute("data-tab");e.querySelector(`#${t}`).classList.add("active")}))}));const h=document.querySelector(".search-container input");function m(){try{const e=localStorage.getItem("patriotThanksSession");if(!e)return console.error("No session data found"),null;const t=JSON.parse(e);return t.token?t.token:(console.error("No token found in session data"),null)}catch(e){return console.error("Error retrieving auth token:",e),null}}h?.addEventListener("input",(function(){const e=this.value.toLowerCase(),t=document.querySelector(".panel.active");t&&t.querySelectorAll("tbody tr").forEach((t=>{let n=!1;t.querySelectorAll("td").forEach((t=>{t.textContent.toLowerCase().includes(e)&&(n=!0)})),t.style.display=n?"":"none"}))})),showSpinner(),function(){const e=new URLSearchParams(window.location.search).get("section");if(e){const t=document.querySelector(`.menu-item[data-section="${e}"]`);t&&t.click()}else s()}(),async function(){try{const e=m();if(!e)return console.error("No auth token found"),window.location.href="/index.html?login=required&redirect="+encodeURIComponent(window.location.pathname),!1;const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin;try{const n=await fetch(`${t}/api/auth.js?operation=verify-token`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Cache-Control":"no-cache"}});if(!n.ok)return 401===n.status&&(window.location.href="/index.html?login=required&redirect="+encodeURIComponent(window.location.pathname),!1);const o=await n.json();return!(!0!==o.isAdmin&&"Admin"!==o.level&&(document.querySelector(".admin-container, .container").innerHTML='\n        <div class="alert alert-danger" role="alert">\n            <h4 class="alert-heading">Access Denied</h4>\n            <p>You do not have permission to access this page. Only administrators can access this section.</p>\n            <hr>\n            <p class="mb-0">Please <a href="/index.html">return to the homepage</a> or contact an administrator if you believe this is an error.</p>\n        </div>\n    ',1))}catch(e){return console.error("Error checking admin status:",e),console.warn("DEVELOPMENT MODE: Bypassing admin verification"),confirm("API error encountered. Would you like to bypass admin verification for development purposes?")}}catch(e){return console.error("Error in admin status check:",e),!1}}(),function(){if(s&&"function"==typeof s){const e=s;s=async function(){await e(),function(){if(!n)return;const e=document.querySelector('#dashboard-panel div[style*="grid-template-columns"]');if(e){const t=e.querySelector("div:nth-child(1)");if(t){const e=t.querySelector("p:nth-child(2)"),o=t.querySelector("p:nth-child(3)");if(e&&(e.textContent=n.userCount||"0"),o){const e=n.userChange||0;o.textContent=`${e>=0?"↑":"↓"} ${Math.abs(e)}% from last month`}}}const t=document.getElementById("total-users-count");t&&(t.textContent=n.userCount||"0");const o=document.getElementById("active-users-count");o&&(o.textContent=n.activeUserCount||"0");const s=document.getElementById("new-users-count");s&&(s.textContent=n.newUsersThisMonth||"0")}()}}document.querySelectorAll(".menu-item").forEach((e=>{e.addEventListener("click",(function(){"users"===this.getAttribute("data-section")&&i()}))}))}(),document.addEventListener("DOMContentLoaded",(function(){setTimeout((()=>{const e=document.getElementById("businesses-list");if(e){const t=e.querySelector('div[style*="display: flex"]');if(t){const e=t.querySelector("#add-business-btn");if(e){const n=document.createElement("a");n.href="admin-business.html",n.className="btn btn-info mr-2",n.textContent="Full Business Management",t.insertBefore(n,e)}else t.innerHTML+='\n                        <a href="../admin-business.html" class="btn btn-info">Full Business Management</a>\n                    '}}}),500)}))}));