function handleLogin(){console.log("Handle login function called");const e=document.getElementById("DropdownFormEmail1").value.toLowerCase(),t=document.getElementById("DropdownFormPassword1").value,o=document.getElementById("dropdownCheck")?.checked||!1;if(console.log("Login attempt with:",e,"Remember me:",o),e&&t){console.log("Login successful");const o={email:e,password:t},n="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin;fetch(`${n}/api/auth.js?operation=login`,{method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8"},body:JSON.stringify(o)}).then((e=>{if(!e.ok)throw new Error("Login failed: "+e.statusText);return e.json()})).then((t=>{console.log("Login successful");const o={user:{_id:t.userId,email:t.email,fname:t.fname,lname:t.lname,address1:t.address1,address2:t.address2,city:t.city,state:t.state,zip:t.zip,status:t.status,level:t.level,isAdmin:t.isAdmin,created_at:t.created_at,updated_at:t.updated_at},token:t.token||"no-token-provided",timestamp:(new Date).getTime(),expiresIn:864e5};localStorage.setItem("patriotThanksSession",JSON.stringify(o)),localStorage.setItem("isLoggedIn","true"),localStorage.setItem("userEmail",e),updateUIAfterLogin(o),updateLoginUI();const n=document.querySelector(".dropdown-menu");n&&($(n).parent().removeClass("show"),$(n).removeClass("show"))})).catch((e=>{console.error("Login error: ",e),alert("Login failed: "+e.message)}))}else console.error("Login failed: Missing email or password"),alert("Please enter both email and password.")}function generateTempId(){return"temp_"+Math.random().toString(36).substr(2,9)}function updateUIAfterLogin(e){console.log("Updating UI after login");const t=e.user,o=t.email,n=t.isAdmin||"Admin"===t.level,s=t.fname?`${t.fname} ${t.lname}`:o,a=document.getElementById("login-dropdown-button"),l=document.getElementById("user-dropdown-button"),i=document.getElementById("login-dropdown-menu"),r=document.getElementById("user-dropdown-menu");if(a&&(a.style.display="none"),l){l.style.display="inline-block";const e=document.getElementById("user-name");e?n?e.innerHTML=`${s} <span class="admin-badge">Admin</span>`:e.textContent=s:l.textContent=s}i&&(i.style.display="none"),r&&(r.style.display="block"),toggleAdminElements(n),enableRestrictedLinks(t),console.log("UI updated for logged in user:",s,"Admin:",n),checkTermsVersion(e)}function checkTermsVersion(e){e&&e.user&&(e.user.termsAccepted&&"May 14, 2025"===e.user.termsVersion||(console.log("User needs to accept new terms"),$("#termsUpdateModal").modal("show")))}function toggleAdminElements(e){document.querySelectorAll(".admin-only").forEach((t=>{t.style.display=e?"":"none"})),console.log("Admin elements "+(e?"shown":"hidden"))}function enableRestrictedLinks(e){const t=document.querySelector('a[href="./business-add.html"]'),o=document.querySelector('a[href="./business-update.html"]'),n=document.querySelector('a[href="./incentive-add.html"]'),s=document.querySelector('a[href="./incentive-update.html"]');t&&t.classList.remove("disabled"),n&&n.classList.remove("disabled"),(e.isAdmin||"Admin"===e.level)&&(o&&o.classList.remove("disabled"),s&&s.classList.remove("disabled")),document.querySelectorAll(".dropdown-item.disabled").forEach((e=>{(e.href.includes("business-add.html")||e.href.includes("incentive-add.html")||e.href.includes("business-update.html")||e.href.includes("incentive-update.html"))&&(console.log("Enabling restricted link:",e.href),e.classList.remove("disabled"))}))}function logoutUser(){console.log("Logging out user"),localStorage.removeItem("patriotThanksSession"),localStorage.removeItem("isLoggedIn"),localStorage.removeItem("userEmail"),sessionStorage.removeItem("isLoggedIn"),sessionStorage.removeItem("userEmail");const e=document.getElementById("login-dropdown-button"),t=document.getElementById("user-dropdown-button"),o=document.getElementById("login-dropdown-menu"),n=document.getElementById("user-dropdown-menu");e&&(e.style.display="inline-block"),t&&(t.style.display="none"),o&&(o.style.display="block"),n&&(n.style.display="none"),toggleAdminElements(!1);const s=document.getElementById("DropdownFormEmail1"),a=document.getElementById("DropdownFormPassword1");s&&(s.value=""),a&&(a.value=""),document.querySelectorAll(".dropdown-item").forEach((e=>{(e.href.includes("business-add.html")||e.href.includes("business-update.html")||e.href.includes("incentive-add.html")||e.href.includes("incentive-update.html"))&&(e.classList.add("disabled"),console.log("Disabling link on logout:",e.href))})),attachLoginListeners();const l=window.location.pathname;(l.includes("profile.html")||l.includes("settings.html")||l.includes("admin-")||l.includes("business-add.html")||l.includes("business-update.html")||l.includes("incentive-add.html")||l.includes("incentive-update.html"))&&(window.location.href="/index.html"),updateLoginUI()}function attachLoginListeners(){console.log("Attaching login event listeners"),$(document).on("click","#login-button, button.btn-primary",(function(e){("login-form"===$(this).closest("form").attr("id")||$(this).closest(".dropdown-menu").length>0)&&(console.log("Login button clicked"),e.preventDefault(),handleLogin())})),$(document).on("submit","#login-form",".dropdown-menu form",(function(e){return console.log("Login form submitted"),e.preventDefault(),handleLogin(),!1})),$(document).on("keypress","#DropdownFormPassword1",(function(e){13===e.which&&(e.preventDefault(),handleLogin())})),$(document).on("click","#logout-button, #logout-link",(function(e){e.preventDefault(),logoutUser()}))}function checkLoginStatus(){console.log("Checking login status");const e=localStorage.getItem("patriotThanksSession");if(e)try{const t=JSON.parse(e);if((new Date).getTime()<t.timestamp+t.expiresIn)return console.log("User is already logged in (session found)"),updateUIAfterLogin(t),!0}catch(e){console.error("Error parsing session data:",e)}if("true"===localStorage.getItem("isLoggedIn")||"true"===sessionStorage.getItem("isLoggedIn")){console.log("User is already logged in (old format)");const e=localStorage.getItem("userEmail")||sessionStorage.getItem("userEmail"),t=localStorage.getItem("userId")||sessionStorage.getItem("userId")||generateTempId(),o=localStorage.getItem("fname")||sessionStorage.getItem("fname")||"",n=localStorage.getItem("lname")||sessionStorage.getItem("lname")||"",s=localStorage.getItem("address1")||sessionStorage.getItem("address1")||"",a=localStorage.getItem("address2")||sessionStorage.getItem("address2")||"",l=localStorage.getItem("city")||sessionStorage.getItem("city")||"",i=localStorage.getItem("state")||sessionStorage.getItem("state")||"",r=localStorage.getItem("zip")||sessionStorage.getItem("zip")||"",d=localStorage.getItem("status")||sessionStorage.getItem("status")||"",c=localStorage.getItem("level")||sessionStorage.getItem("level")||"",m="true"===localStorage.getItem("isAdmin")||"true"===sessionStorage.getItem("isAdmin"),u=localStorage.getItem("created_at")||sessionStorage.getItem("created_at")||(new Date).toISOString(),g=localStorage.getItem("updated_at")||sessionStorage.getItem("updated_at")||(new Date).toISOString();if(e){const p={user:{_id:t,email:e,fname:o,lname:n,address1:s,address2:a,city:l,state:i,zip:r,status:d,level:c,isAdmin:m,created_at:u,updated_at:g},token:"simulated-token",timestamp:(new Date).getTime(),expiresIn:864e5};return localStorage.setItem("patriotThanksSession",JSON.stringify(p)),updateUIAfterLogin(p),!0}}return console.log("User is not logged in"),!1}function fixLoginMenuIssue(){const e=localStorage.getItem("patriotThanksSession");if(e)try{const t=JSON.parse(e),o=document.getElementById("loginBtn");o&&(o.style.display="none");const n=document.getElementById("userDropdown");if(n){n.style.display="block";const e=document.getElementById("userDisplayName");e&&t.user&&(e.textContent=`${t.user.fname||""} ${t.user.lname||""}`)}console.log("User session active, displaying user dropdown")}catch(e){console.error("Error parsing session data:",e)}else console.log("No active session found")}function updateLoginUI(){const e=localStorage.getItem("patriotThanksSession"),t=document.querySelector(".navbar-nav.ml-auto li.dropdown:not(#user-dropdown)"),o=document.getElementById("user-dropdown");if(e){const n=JSON.parse(e);if(t&&(t.style.display="none"),o){o.style.display="block";const e=document.getElementById("userDisplayName");e&&n.user&&(e.textContent=`${n.user.fname||""} ${n.user.lname||""}`)}toggleAdminElements(n.user&&(n.user.isAdmin||"Admin"===n.user.level))}else t&&(t.style.display="block"),o&&(o.style.display="none"),toggleAdminElements(!1)}function getAuthToken(){try{const e=localStorage.getItem("patriotThanksSession");return e&&JSON.parse(e).token||null}catch(e){return console.error("Error retrieving auth token:",e),null}}function setupTermsModalHandlers(){console.log("Setting up terms modal handlers"),$(document).on("change","#acceptUpdatedTerms",(function(){document.getElementById("confirmUpdatedTerms").disabled=!this.checked})),$(document).on("click","#confirmUpdatedTerms",(function(){console.log("Terms acceptance confirmed");const e=localStorage.getItem("patriotThanksSession");if(!e)return console.error("No session found"),void $("#termsUpdateModal").modal("hide");const t=JSON.parse(e),o=t.user._id,n="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin;fetch(`${n}/api/auth.js?operation=update-terms-acceptance`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+t.token},body:JSON.stringify({userId:o,termsAccepted:!0,termsAcceptedDate:(new Date).toISOString(),termsVersion:"May 14, 2025"})}).then((e=>e.json())).then((e=>{e.success?(console.log("Terms acceptance updated successfully"),t.user.termsAccepted=!0,t.user.termsAcceptedDate=(new Date).toISOString(),t.user.termsVersion="May 14, 2025",localStorage.setItem("patriotThanksSession",JSON.stringify(t)),$("#termsUpdateModal").modal("hide")):(console.error("Failed to update terms acceptance"),alert("Failed to update terms acceptance. Please try again."))})).catch((e=>{console.error("Error updating terms acceptance:",e),alert("An error occurred. Please try again.")}))})),$(document).on("click","#rejectUpdatedTerms",(function(){console.log("Terms acceptance rejected"),confirm("If you do not accept the updated terms, you will be logged out and unable to use the service. Continue?")&&(logoutUser(),$("#termsUpdateModal").modal("hide"))}))}console.log("Login handler script loaded"),document.addEventListener("DOMContentLoaded",(function(){setTimeout(fixLoginMenuIssue,500),setTimeout(updateLoginUI,500)})),window.loginUser=handleLogin,window.logoutUser=logoutUser,window.checkLoginStatus=checkLoginStatus,window.getAuthToken=getAuthToken,window.toggleAdminElements=toggleAdminElements,$((function(){console.log("jQuery ready in login-handler.js"),attachLoginListeners(),setupTermsModalHandlers(),setTimeout(checkLoginStatus,500),setTimeout(updateLoginUI,500)}));