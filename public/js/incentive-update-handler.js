function checkIfUserIsAdmin(){try{const e=localStorage.getItem("patriotThanksSession");if(!e)return!1;const n=JSON.parse(e);return n.user&&(!0===n.user.isAdmin||"Admin"===n.user.level)}catch(e){return console.error("Error checking admin status:",e),!1}}document.addEventListener("DOMContentLoaded",(function(){console.log("Enhanced Incentive Update Handler Loaded!");const e=document.getElementById("business-info-section"),n=document.getElementById("incentives-list-section"),t=document.getElementById("incentive-edit-section");e&&(e.style.display="none"),n&&(n.style.display="none"),t&&(t.style.display="none");let i="",o="";const s=document.getElementById("incentiveType"),c=document.getElementById("otherTypeContainer");s&&c&&s.addEventListener("change",(function(){"OT"===this.value?c.style.display="block":c.style.display="none"}));const d=document.getElementById("incentiveAvailable"),a=document.getElementById("incentiveNotAvailable"),l=[document.getElementById("incentiveType"),document.getElementById("incentiveAmount"),document.getElementById("incentiveInfo"),document.getElementById("discountTypePercentage"),document.getElementById("discountTypeDollar")];function r(){if(!d||!a)return;const e=d.checked;l.forEach((n=>{n&&(n.disabled=!e,e?n.classList.remove("disabled-field"):n.classList.add("disabled-field"))}));const n=document.getElementById("discountTypeContainer");if(n&&(e?n.classList.remove("disabled-container"):n.classList.add("disabled-container")),c&&document.getElementById("otherTypeDescription")){const n=document.getElementById("otherTypeDescription");n.disabled=!e,e?"OT"===document.getElementById("incentiveType").value&&(c.style.display="block",n.classList.remove("disabled-field")):(c.style.display="none",n.classList.add("disabled-field"))}e||(l.forEach((e=>{e&&("SELECT"===e.tagName?e.selectedIndex=0:"TEXTAREA"===e.tagName?e.value="No incentives available at this business.":"number"===e.type&&(e.value="0"))})),document.getElementById("otherTypeDescription")&&(document.getElementById("otherTypeDescription").value=""))}d&&d.addEventListener("change",r),a&&a.addEventListener("change",r);const u=document.getElementById("incentive-update-form");function m(s){if(s.is_chain&&!checkIfUserIsAdmin())return void v("error","Chain businesses can only be modified by administrators. Please select a regular business location instead.");window.selectedBusinessData=s,i=s._id||"",console.log("Setting selected business ID to:",i);const l=document.getElementById("selected-business-id");l&&(l.value=i,console.log("Business ID field value set to:",l.value)),function(n){if(!n)return void console.error("No business data provided to displayBusinessInfo");console.log("Displaying business info for:",n.bname),e&&(e.style.display="block",console.log("Business info section display set to:",e.style.display));const t=document.getElementById("business-name-display");t&&(t.textContent=n.bname||"");const i=document.getElementById("business-address-display");if(i){let e=n.address1||"";n.address2&&(e+=", "+n.address2),i.textContent=e}const o=document.getElementById("business-city-state-display");if(o){let e="";n.city&&(e+=n.city),n.state&&(e+=", "+n.state),n.zip&&(e+=" "+n.zip),o.textContent=e}const s=document.getElementById("business-phone-display");s&&(s.textContent=n.phone||"");const c=document.getElementById("business-type-display");var d;c&&(c.textContent={AUTO:"Automotive",BEAU:"Beauty",BOOK:"Bookstore",CLTH:"Clothing",CONV:"Convenience Store/Gas Station",DEPT:"Department Store",ELEC:"Electronics",ENTR:"Entertainment",FURN:"Furniture",FUEL:"Fuel Station/Truck Stop",GIFT:"Gift Shop",GROC:"Grocery",HARDW:"Hardware",HEAL:"Health",JEWL:"Jewelry",OTHER:"Other",RX:"Pharmacy",REST:"Restaurant",RETAIL:"Retail",SERV:"Service",SPEC:"Specialty",SPRT:"Sporting Goods",TECH:"Technology",TOYS:"Toys"}[d=n.type]||d||""),e.scrollIntoView({behavior:"smooth"})}(s),async function(e){if(e)try{const i=window.selectedBusinessData;if(i&&i.is_chain&&!checkIfUserIsAdmin())return console.error("Non-admin attempting to fetch chain incentives"),n&&(n.style.display="none"),void v("error","You don't have permission to view or modify chain incentives.");const s=document.getElementById("incentives-table-container");s&&(s.innerHTML="<p>Loading incentives...</p>"),n&&(n.style.display="block",console.log("Incentives list section display set to:",n.style.display));const l=`${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin}/api/combined-api.js?operation=incentives&business_id=${e}`;console.log("Fetching incentives from:",l);const u=await fetch(l);if(!u.ok)throw new Error(`Failed to fetch incentives: ${u.status} ${u.statusText}`);const m=await u.json();console.log("Incentives data:",m),function(e){const i=document.getElementById("incentives-table-container");if(!i)return;if(!e||0===e.length)return void(i.innerHTML="<p>No incentives found for this business.</p>");let s='\n            <table class="results-table">\n                <thead>\n                    <tr>\n                        <th>Available</th>\n                        <th>Type</th>\n                        <th>Amount</th>\n                        <th>Information</th>\n                        <th>Action</th>\n                    </tr>\n                </thead>\n                <tbody>\n        ';e.forEach((e=>{const n=e.is_available?"Yes":"No",t={VT:"Veteran",AD:"Active Duty",FR:"First Responder",SP:"Spouse",OT:"Other"}[i=e.type]||i;var i;const o="OT"===e.type&&e.other_description?`<br><em>(${e.other_description})</em>`:"";let c="N/A";e.is_available&&(c="dollar"===e.discount_type?`$${e.amount.toFixed(2)}`:`${e.amount}%`);const d=!0===e.is_chain_wide,a=checkIfUserIsAdmin();let l;l=d?a?`\n                        <button class="select-incentive admin-chain" data-incentive-id="${e._id}">\n                            Edit Chain Incentive\n                        </button>\n                    `:'<span class="chain-badge">Chain-wide (admin only)</span>':`\n                    <button class="select-incentive" data-incentive-id="${e._id}">\n                        Edit\n                    </button>\n                `,s+=`\n                <tr>\n                    <td>${n}</td>\n                    <td>${t}${o}</td>\n                    <td>${c} ${d?'<span class="chain-badge small">Chain-wide</span>':""}</td>\n                    <td>${e.information||""}</td>\n                    <td>${l}</td>\n                </tr>\n            `})),s+="\n                </tbody>\n            </table>\n        ",i.innerHTML=s,document.querySelectorAll(".select-incentive").forEach((n=>{n.addEventListener("click",(function(){const n=this.getAttribute("data-incentive-id");if(o=n,document.getElementById("selected-incentive-id").value=n,console.log("Selected incentive ID:",n),this.classList.contains("admin-chain")&&!checkIfUserIsAdmin())return void v("error","You don't have permission to edit chain-wide incentives.");const i=e.find((e=>e._id===n));i&&function(e){if(console.log("Loading incentive for editing:",e),e.is_chain_wide&&!checkIfUserIsAdmin())return void v("error","Only administrators can edit chain-wide incentives.");if(t&&(t.style.display="block",console.log("Incentive edit section display set to:",t.style.display)),e.is_chain_wide){const e=document.createElement("div");e.className="alert alert-warning chain-incentive-warning",e.innerHTML="\n                <strong>Warning:</strong> You are editing a chain-wide incentive. \n                Changes will affect all locations of this chain nationwide.\n            ",t.querySelector(".chain-incentive-warning")||t.insertBefore(e,t.firstChild)}else{const e=t.querySelector(".chain-incentive-warning");e&&e.remove()}d&&a&&(e.is_available?(d.checked=!0,a.checked=!1):(d.checked=!1,a.checked=!0),r());const n=document.getElementById("incentiveType");if(n){for(let t=0;t<n.options.length;t++)if(n.options[t].value===e.type){n.selectedIndex=t;break}if("OT"===e.type&&c){c.style.display="block";const n=document.getElementById("otherTypeDescription");n&&(n.value=e.other_description||"")}else c&&(c.style.display="none")}const i=document.getElementById("discountTypePercentage"),o=document.getElementById("discountTypeDollar");if(i&&o)if("dollar"===e.discount_type){o.checked=!0,i.checked=!1;const e=document.getElementById("amountLabel");e&&(e.textContent="Incentive Amount in $")}else{i.checked=!0,o.checked=!1;const e=document.getElementById("amountLabel");e&&(e.textContent="Incentive Amount as a %")}const s=document.getElementById("incentiveAmount");s&&(s.value=e.amount||0);const l=document.getElementById("incentiveInfo");l&&(l.value=e.information||""),t.scrollIntoView({behavior:"smooth"})}(i)}))})),n.scrollIntoView({behavior:"smooth"})}(m.results||[])}catch(e){console.error("Error fetching incentives:",e);const n=document.getElementById("incentives-table-container");n&&(n.innerHTML=`<p class="error">Error loading incentives: ${e.message}</p>`)}else console.error("No business ID provided for fetching incentives")}(i)}async function y(s){try{const l=window.selectedBusinessData;if(l&&l.is_chain&&!checkIfUserIsAdmin())return void v("error","You don't have permission to update chain incentives.");const r=localStorage.getItem("patriotThanksSession");if(r){const e=JSON.parse(r);e&&e.user&&e.user._id&&(s.updated_by=e.user._id)}const u=document.getElementById("update-submit"),m=u.value;u.value="Updating...",u.disabled=!0;const y=`${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:window.location.origin}/api/combined-api.js?operation=admin-incentives&action=update`;console.log("Submitting to API at:",y),console.log("Incentive data:",s);const p=function(){try{const e=localStorage.getItem("patriotThanksSession");return e&&JSON.parse(e).token||null}catch(e){return console.error("Error retrieving auth token:",e),null}}(),h={"Content-Type":"application/json; charset=utf-8"};p&&(h.Authorization=`Bearer ${p}`);const f=await fetch(y,{method:"PUT",headers:h,body:JSON.stringify(s)});if(console.log("Response status:",f.status),!f.ok){const e=await f.text();throw console.error("Error response:",e),new Error(`Failed to update incentive: ${f.status} ${e}`)}const g=await f.json();console.log("Success:",g),v("success","Incentive updated successfully!"),function(){if(console.log("Resetting form to initial state"),e&&(e.style.display="none"),n){n.style.display="none";const e=document.getElementById("incentives-table-container");e&&(e.innerHTML="")}if(t){t.style.display="none";const e=t.querySelector(".chain-incentive-warning");e&&e.remove()}const s=document.getElementById("business-name-display");s&&(s.textContent="");const l=document.getElementById("business-address-display");l&&(l.textContent="");const r=document.getElementById("business-city-state-display");r&&(r.textContent="");const u=document.getElementById("business-phone-display");u&&(u.textContent="");const m=document.getElementById("business-type-display");m&&(m.textContent="");const y=document.getElementById("selected-business-id");y&&(y.value="");const v=document.getElementById("selected-incentive-id");v&&(v.value="");const p=document.getElementById("incentiveType");p&&(p.selectedIndex=0,p.disabled=!1);const h=document.getElementById("otherTypeDescription");h&&(h.value="",h.disabled=!1);const f=document.getElementById("incentiveAmount");f&&(f.value="",f.disabled=!1);const g=document.getElementById("incentiveInfo");g&&(g.value="",g.disabled=!1);const I=document.getElementById("discountTypePercentage");I&&(I.checked=!0,I.disabled=!1);const b=document.getElementById("discountTypeDollar");b&&(b.checked=!1,b.disabled=!1);const E=document.getElementById("amountLabel");E&&(E.textContent="Incentive Amount as a %"),c&&(c.style.display="none"),d&&(d.checked=!1,d.disabled=!1),a&&(a.checked=!1,a.disabled=!1);const B=document.getElementById("business-name");B&&(B.value="",B.disabled=!1);const w=document.getElementById("address");w&&(w.value="",w.disabled=!1);const T=document.querySelector('#business-search-form input[type="submit"]');T&&(T.disabled=!1,T.style.cursor="pointer");const A=document.getElementById("business-search-results");A&&(A.innerHTML=""),i="",o="",window.selectedBusinessData=null,window.scrollTo(0,0),console.log("Form reset completed")}(),u.value=m,u.disabled=!1}catch(e){console.error("Error:",e),v("error","Update failed: "+e.message);const n=document.getElementById("update-submit");n&&(n.value="Update Incentive",n.disabled=!1)}}function v(e,n){const t=document.getElementById("status-message");t?(t.innerHTML=n,t.className="alert","error"===e?t.classList.add("alert-danger"):"success"===e&&t.classList.add("alert-success"),t.style.display="block",t.scrollIntoView({behavior:"smooth"}),setTimeout((()=>{t.style.display="none"}),5e3)):alert(n)}function p(e){return e&&""!==e.trim()}function h(e){return!isNaN(e)&&e>=0}function f(e,n){return console.log(`Validating ${e.id} with value: ${e.value}`),n(e.value)?(e.classList.remove("invalid-field"),e.classList.add("valid-field"),e.setAttribute("data-valid","true"),console.log(`${e.id} is VALID`),!0):(e.classList.remove("valid-field"),e.classList.add("invalid-field"),e.setAttribute("data-valid","false"),console.log(`${e.id} is INVALID`),!1)}u&&u.addEventListener("submit",(function(e){if(e.preventDefault(),(window.selectedBusinessData||{}).is_chain&&!checkIfUserIsAdmin())return void v("error","You don't have permission to update chain incentives.");const n=document.getElementById("selected-incentive-id").value;if(!n)return void v("error","Incentive ID is missing. Please select an incentive first.");const t=document.querySelector('input[name="incentiveAvailable"]:checked'),o=t?"true"===t.value:null;if(null===o)return void v("error","Please specify if the incentive is available.");const s={incentiveId:n,business_id:i,is_available:o};if(o){const e=document.getElementById("incentiveType").value;if(!e)return void v("error","Please select an incentive type.");const n=document.querySelector('input[name="discountType"]:checked'),t=n?n.value:"percentage";if(s.type=e,s.discount_type=t,s.amount=parseFloat(document.getElementById("incentiveAmount").value)||0,s.information=document.getElementById("incentiveInfo").value||"","OT"===e){const e=document.getElementById("otherTypeDescription").value;if(!e)return void v("error",'Please provide a description for the "Other" incentive type.');s.other_description=e}}y(s)})),window.selectBusinessForIncentives=function(e){console.log("selectBusinessForIncentives called with: ",e),m(e)},window.selectBusinessForIncentive=function(e){console.log("selectBusinessForIncentive called with: ",e),m(e)},window.handleBusinessSelection=function(e){console.log("handleBusinessSelection called with:",e),"function"==typeof window.selectBusinessForIncentive?window.selectBusinessForIncentive(e):"function"==typeof window.selectBusinessForIncentives?window.selectBusinessForIncentives(e):console.error("No incentive handler function found")};const g=document.getElementById("incentiveType"),I=document.getElementById("incentiveAmount"),b=document.getElementById("incentiveInfo"),E=document.getElementById("otherTypeDescription");if(g&&g.addEventListener("change",(function(){f(this,p)})),I&&I.addEventListener("input",(function(){f(this,h)})),b&&b.addEventListener("input",(function(){f(this,p)})),E&&E.addEventListener("input",(function(){g&&"OT"===g.value&&f(this,p)})),u){const e=u.cloneNode(!0);u.parentNode.replaceChild(e,u),e.addEventListener("submit",(function(e){if(e.preventDefault(),(window.selectedBusinessData||{}).is_chain&&!checkIfUserIsAdmin())return void v("error","You don't have permission to update chain incentives.");if(!function(){const e=document.getElementById("selected-business-id"),n=document.getElementById("selected-incentive-id");if(!e||!e.value)return v("error","Please select a business first"),!1;if(!n||!n.value)return v("error","Please select an incentive to update"),!1;if(!document.querySelector('input[name="incentiveAvailable"]:checked'))return v("error","Please specify if the incentive is available"),!1;let t=!0;if(document.getElementById("incentiveAvailable").checked){const e=document.getElementById("incentiveType"),n=document.getElementById("incentiveAmount"),i=document.getElementById("incentiveInfo");if(e&&!f(e,p)&&(t=!1,v("error","Please select an incentive type")),n&&!f(n,h)&&(t=!1,v("error","Please enter a valid amount (0 or greater)")),i&&!f(i,p)&&(t=!1,v("error","Please provide information about the incentive")),e&&"OT"===e.value){const e=document.getElementById("otherTypeDescription");e&&!f(e,p)&&(t=!1,v("error",'Please provide a description for the "Other" incentive type'))}}return t}())return;const n=document.getElementById("selected-incentive-id").value,t=document.getElementById("incentiveAvailable").checked,o={incentiveId:n,business_id:i,is_available:t};if(t){const e=document.getElementById("incentiveType").value,n=document.querySelector('input[name="discountType"]:checked'),t=n?n.value:"percentage";if(o.type=e,o.discount_type=t,o.amount=parseFloat(document.getElementById("incentiveAmount").value)||0,o.information=document.getElementById("incentiveInfo").value||"","OT"===e){const e=document.getElementById("otherTypeDescription").value;o.other_description=e}}y(o)}))}const B=document.createElement("style");B.textContent+="\n        .valid-field {\n            border: 1px solid green !important;\n            background-color: #f0fff0 !important;\n        }\n        \n        .invalid-field {\n            border: 1px solid red !important;\n            background-color: #fff0f0 !important;\n        }\n        \n        .required-indicator {\n            color: red;\n            font-weight: bold;\n        }\n        \n        .form-explanation {\n            margin-bottom: 15px;\n            font-style: italic;\n        }\n        \n        .disabled-container {\n            opacity: 0.5;\n            pointer-events: none;\n        }\n        \n        /* IMPROVED: Add styles for the chain badges */\n        .chain-badge {\n            background-color: #4285F4;\n            color: white;\n            border-radius: 4px;\n            padding: 3px 6px;\n            font-size: 12px;\n            display: inline-block;\n        }\n        \n        .chain-badge.small {\n            font-size: 10px;\n            padding: 2px 4px;\n        }\n        \n        /* IMPROVED: Add styles for admin chain buttons */\n        .select-incentive.admin-chain {\n            background-color: #9C27B0;\n            color: white;\n        }\n        \n        /* IMPROVED: Warning banner for chain incentives */\n        .chain-incentive-warning {\n            background-color: #FFF3CD;\n            color: #856404;\n            border: 1px solid #FFEEBA;\n            padding: 10px;\n            margin-bottom: 15px;\n            border-radius: 4px;\n        }\n    ",document.head.appendChild(B),function(){["incentiveType","incentiveAmount","incentiveInfo"].forEach((e=>{if(document.getElementById(e)){const n=document.querySelector(`label[for="${e}"]`);if(n&&!n.innerHTML.includes("*")){const e=document.createElement("span");e.className="required-indicator",e.textContent=" *",e.style.color="red",n.appendChild(e)}}})),document.querySelectorAll('label[for="incentiveAvailable"], label[for="incentiveNotAvailable"]').forEach((e=>{if(!e.innerHTML.includes("*")){const n=document.createElement("span");n.className="required-indicator",n.textContent=" *",n.style.color="red",e.appendChild(n)}}));const e=document.getElementById("incentive-update-form");if(e){const n=document.createElement("div");n.className="form-explanation",n.innerHTML="<p>Fields marked with an asterisk (*) are required.</p>",e.insertBefore(n,e.firstChild)}}()}));