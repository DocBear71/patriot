document.addEventListener("DOMContentLoaded",(function(){console.log("Incentive Update Handler Loaded!");const e=document.getElementById("business-info-section"),t=document.getElementById("incentives-list-section"),n=document.getElementById("incentive-edit-section");e&&(e.style.display="none"),t&&(t.style.display="none"),n&&(n.style.display="none");let i="",o="";const s=document.getElementById("incentiveType"),c=document.getElementById("otherTypeContainer");s&&c&&s.addEventListener("change",(function(){"OT"===this.value?c.style.display="block":c.style.display="none"}));const l=document.getElementById("incentiveAvailable"),d=document.getElementById("incentiveNotAvailable"),a=[document.getElementById("incentiveType"),document.getElementById("incentiveAmount"),document.getElementById("incentiveInfo")];function r(){if(!l||!d)return;const e=l.checked;if(a.forEach((t=>{t&&(t.disabled=!e,e?t.classList.remove("disabled-field"):t.classList.add("disabled-field"))})),c&&document.getElementById("otherTypeDescription")){const t=document.getElementById("otherTypeDescription");t.disabled=!e,e?"OT"===document.getElementById("incentiveType").value&&(c.style.display="block",t.classList.remove("disabled-field")):(c.style.display="none",t.classList.add("disabled-field"))}e||(a.forEach((e=>{e&&("SELECT"===e.tagName?e.selectedIndex=0:"TEXTAREA"===e.tagName?e.value="No incentives available at this business.":"number"===e.type&&(e.value="0"))})),document.getElementById("otherTypeDescription")&&(document.getElementById("otherTypeDescription").value=""))}l&&l.addEventListener("change",r),d&&d.addEventListener("change",r);const u=document.getElementById("incentive-update-form");function m(s){i=s._id||"",console.log("Setting selected business ID to:",i);const a=document.getElementById("selected-business-id");a&&(a.value=i,console.log("Business ID field value set to:",a.value)),function(t){if(!t)return void console.error("No business data provided to displayBusinessInfo");console.log("Displaying business info for:",t.bname),e&&(e.style.display="block",console.log("Business info section display set to:",e.style.display));const n=document.getElementById("business-name-display");n&&(n.textContent=t.bname||"");const i=document.getElementById("business-address-display");if(i){let e=t.address1||"";t.address2&&(e+=", "+t.address2),i.textContent=e}const o=document.getElementById("business-city-state-display");if(o){let e="";t.city&&(e+=t.city),t.state&&(e+=", "+t.state),t.zip&&(e+=" "+t.zip),o.textContent=e}const s=document.getElementById("business-phone-display");s&&(s.textContent=t.phone||"");const c=document.getElementById("business-type-display");var l;c&&(c.textContent={REST:"Restaurant",GROC:"Grocery",DEPT:"Department Store",CLTH:"Clothing",ELEC:"Electronics",HARDW:"Hardware",FURN:"Furniture",AUTO:"Automotive",SERV:"Service",ENTR:"Entertainment",SPRT:"Sporting Goods",TOYS:"Toys",HEAL:"Health",BEAU:"Beauty",JEWL:"Jewelry",BOOK:"Bookstore",GIFT:"Gift Shop",SPEC:"Specialty",RX:"Pharmacy",RETAIL:"Retail",TECH:"Technology",OTHER:"Other"}[l=t.type]||l||""),e.scrollIntoView({behavior:"smooth"})}(s),async function(e){if(e)try{const i=document.getElementById("incentives-table-container");i&&(i.innerHTML="<p>Loading incentives...</p>"),t&&(t.style.display="block",console.log("Incentives list section display set to:",t.style.display));const s=`${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:"https://patriotthanks.vercel.app"}/api/incentives.js?business_id=${e}`;console.log("Fetching incentives from:",s);const a=await fetch(s);if(!a.ok)throw new Error(`Failed to fetch incentives: ${a.status} ${a.statusText}`);const u=await a.json();console.log("Incentives data:",u),function(e){const i=document.getElementById("incentives-table-container");if(!i)return;if(!e||0===e.length)return void(i.innerHTML="<p>No incentives found for this business.</p>");let s='\n            <table class="results-table">\n                <thead>\n                    <tr>\n                        <th>Available</th>\n                        <th>Type</th>\n                        <th>Amount (%)</th>\n                        <th>Information</th>\n                        <th>Action</th>\n                    </tr>\n                </thead>\n                <tbody>\n        ';e.forEach((e=>{const t=e.is_available?"Yes":"No",n={VT:"Veteran",AD:"Active Duty",FR:"First Responder",SP:"Spouse",OT:"Other"}[i=e.type]||i;var i;const o="OT"===e.type&&e.other_description?`<br><em>(${e.other_description})</em>`:"",c=e.is_available?`${e.amount}%`:"N/A";s+=`\n                <tr>\n                    <td>${t}</td>\n                    <td>${n}${o}</td>\n                    <td>${c}</td>\n                    <td>${e.information||""}</td>\n                    <td>\n                        <button class="select-incentive" data-incentive-id="${e._id}">\n                            Edit\n                        </button>\n                    </td>\n                </tr>\n            `})),s+="\n                </tbody>\n            </table>\n        ",i.innerHTML=s,document.querySelectorAll(".select-incentive").forEach((t=>{t.addEventListener("click",(function(){const t=this.getAttribute("data-incentive-id");o=t,document.getElementById("selected-incentive-id").value=t,console.log("Selected incentive ID:",t);const i=e.find((e=>e._id===t));i&&function(e){console.log("Loading incentive for editing:",e),n&&(n.style.display="block",console.log("Incentive edit section display set to:",n.style.display)),l&&d&&(e.is_available?(l.checked=!0,d.checked=!1):(l.checked=!1,d.checked=!0),r());const t=document.getElementById("incentiveType");if(t){for(let n=0;n<t.options.length;n++)if(t.options[n].value===e.type){t.selectedIndex=n;break}if("OT"===e.type&&c){c.style.display="block";const t=document.getElementById("otherTypeDescription");t&&(t.value=e.other_description||"")}else c&&(c.style.display="none")}const i=document.getElementById("incentiveAmount");i&&(i.value=e.amount||0);const o=document.getElementById("incentiveInfo");o&&(o.value=e.information||""),n.scrollIntoView({behavior:"smooth"})}(i)}))})),t.scrollIntoView({behavior:"smooth"})}(u.results||[])}catch(e){console.error("Error fetching incentives:",e);const t=document.getElementById("incentives-table-container");t&&(t.innerHTML=`<p class="error">Error loading incentives: ${e.message}</p>`)}else console.error("No business ID provided for fetching incentives")}(i)}async function y(e){try{const t=localStorage.getItem("patriotThanksSession");if(t){const n=JSON.parse(t);n&&n.user&&n.user._id&&(e.updated_by=n.user._id)}const n=document.getElementById("update-submit"),s=n.value;n.value="Updating...",n.disabled=!0;const c=("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`http://${window.location.host}`:"https://patriotthanks.vercel.app")+"/api/admin-incentives.js?operation=update";console.log("Submitting to API at:",c);const l=function(){try{const e=localStorage.getItem("patriotThanksSession");return e&&JSON.parse(e).token||null}catch(e){return console.error("Error retrieving auth token:",e),null}}(),d={"Content-Type":"application/json; charset=utf-8"};l&&(d.Authorization=`Bearer ${l}`);const a=await fetch(c,{method:"PUT",headers:d,body:JSON.stringify(e)});if(console.log("Response status:",a.status),!a.ok){const e=await a.text();throw console.error("Error response:",e),new Error(`Failed to update incentive: ${a.status} ${e}`)}const r=await a.json();console.log("Success:",r),v("success","Incentive updated successfully!"),function(){console.log("Resetting form to initial state");const e=document.getElementById("business-info-section");e&&(e.style.display="none");const t=document.getElementById("incentives-list-section");if(t){t.style.display="none";const e=document.getElementById("incentives-table-container");e&&(e.innerHTML="")}const n=document.getElementById("incentive-edit-section");n&&(n.style.display="none");const s=document.getElementById("business-name-display");s&&(s.textContent="");const c=document.getElementById("business-address-display");c&&(c.textContent="");const l=document.getElementById("business-city-state-display");l&&(l.textContent="");const d=document.getElementById("business-phone-display");d&&(d.textContent="");const a=document.getElementById("business-type-display");a&&(a.textContent="");const r=document.getElementById("selected-business-id");r&&(r.value="");const u=document.getElementById("selected-incentive-id");u&&(u.value="");const m=document.getElementById("incentiveType");m&&(m.selectedIndex=0);const y=document.getElementById("otherTypeDescription");y&&(y.value="");const v=document.getElementById("incentiveAmount");v&&(v.value="");const p=document.getElementById("incentiveInfo");p&&(p.value="");const f=document.getElementById("otherTypeContainer");f&&(f.style.display="none");const g=document.getElementById("incentiveAvailable");g&&(g.checked=!1);const h=document.getElementById("incentiveNotAvailable");h&&(h.checked=!1);const E=document.getElementById("business-name");E&&(E.value="");const I=document.getElementById("address");I&&(I.value="");const b=document.getElementById("business-search-results");b&&(b.innerHTML=""),i="",o="",window.scrollTo(0,0),console.log("Form reset completed")}(),n.value=s,n.disabled=!1}catch(e){console.error("Error:",e),v("error","Update failed: "+e.message);const t=document.getElementById("update-submit");t&&(t.value="Update Incentive",t.disabled=!1)}}function v(e,t){const n=document.getElementById("status-message");n?(n.innerHTML=t,n.className="alert","error"===e?n.classList.add("alert-danger"):"success"===e&&n.classList.add("alert-success"),n.style.display="block",n.scrollIntoView({behavior:"smooth"}),setTimeout((()=>{n.style.display="none"}),5e3)):alert(t)}function p(e){return e&&""!==e.trim()}function f(e){return!isNaN(e)&&e>0}function g(e,t){return console.log(`Validating ${e.id} with value: ${e.value}`),t(e.value)?(e.classList.remove("invalid-field"),e.classList.add("valid-field"),e.setAttribute("data-valid","true"),console.log(`${e.id} is VALID`),!0):(e.classList.remove("valid-field"),e.classList.add("invalid-field"),e.setAttribute("data-valid","false"),console.log(`${e.id} is INVALID`),!1)}u&&u.addEventListener("submit",(function(e){e.preventDefault();const t=document.getElementById("selected-incentive-id").value;if(!t)return void v("error","Incentive ID is missing. Please select an incentive first.");const n=document.querySelector('input[name="incentiveAvailable"]:checked'),o=n?"true"===n.value:null;if(null===o)return void v("error","Please specify if the incentive is available.");const s={incentiveId:t,business_id:i,is_available:o};if(o){const e=document.getElementById("incentiveType").value;if(!e)return void v("error","Please select an incentive type.");if(s.type=e,s.amount=parseFloat(document.getElementById("incentiveAmount").value)||0,s.information=document.getElementById("incentiveInfo").value||"","OT"===e){const e=document.getElementById("otherTypeDescription").value;if(!e)return void v("error",'Please provide a description for the "Other" incentive type.');s.other_description=e}}y(s)})),window.selectBusinessForIncentives=function(e){console.log("selectBusinessForIncentives called with: ",e),m(e)},window.selectBusinessForIncentive=function(e){console.log("selectBusinessForIncentive called with: ",e),m(e)},window.handleBusinessSelection=function(e){console.log("handleBusinessSelection called with:",e),"function"==typeof window.selectBusinessForIncentive?window.selectBusinessForIncentive(e):"function"==typeof window.selectBusinessForIncentives?window.selectBusinessForIncentives(e):console.error("No incentive handler function found")};const h=document.getElementById("incentiveType"),E=document.getElementById("incentiveAmount"),I=document.getElementById("incentiveInfo"),b=document.getElementById("otherTypeDescription");if(h&&h.addEventListener("change",(function(){g(this,p)})),E&&E.addEventListener("input",(function(){g(this,f)})),I&&I.addEventListener("input",(function(){g(this,p)})),b&&b.addEventListener("input",(function(){h&&"OT"===h.value&&g(this,p)})),u){const e=u.cloneNode(!0);u.parentNode.replaceChild(e,u),e.addEventListener("submit",(function(e){if(e.preventDefault(),!function(){const e=document.getElementById("selected-business-id"),t=document.getElementById("selected-incentive-id");if(!e||!e.value)return v("error","Please select a business first"),!1;if(!t||!t.value)return v("error","Please select an incentive to update"),!1;if(!document.querySelector('input[name="incentiveAvailable"]:checked'))return v("error","Please specify if the incentive is available"),!1;let n=!0;if(document.getElementById("incentiveAvailable").checked){const e=document.getElementById("incentiveType"),t=document.getElementById("incentiveAmount"),i=document.getElementById("incentiveInfo");if(e&&!g(e,p)&&(n=!1,v("error","Please select an incentive type")),t&&!g(t,f)&&(n=!1,v("error","Please enter a valid amount greater than 0")),i&&!g(i,p)&&(n=!1,v("error","Please provide information about the incentive")),e&&"OT"===e.value){const e=document.getElementById("otherTypeDescription");e&&!g(e,p)&&(n=!1,v("error",'Please provide a description for the "Other" incentive type'))}}return n}())return;const t=document.getElementById("selected-incentive-id").value,n=document.getElementById("incentiveAvailable").checked,o={incentiveId:t,business_id:i,is_available:n};if(n){const e=document.getElementById("incentiveType").value;if(o.type=e,o.amount=parseFloat(document.getElementById("incentiveAmount").value)||0,o.information=document.getElementById("incentiveInfo").value||"","OT"===e){const e=document.getElementById("otherTypeDescription").value;o.other_description=e}}y(o)}))}const B=document.createElement("style");B.textContent+="\n            .valid-field {\n                border: 1px solid green !important;\n                background-color: #f0fff0 !important;\n            }\n            \n            .invalid-field {\n                border: 1px solid red !important;\n                background-color: #fff0f0 !important;\n            }\n            \n            .required-indicator {\n                color: red;\n                font-weight: bold;\n            }\n            \n            .form-explanation {\n                margin-bottom: 15px;\n                font-style: italic;\n            }\n        ",document.head.appendChild(B),function(){["incentiveType","incentiveAmount","incentiveInfo"].forEach((e=>{if(document.getElementById(e)){const t=document.querySelector(`label[for="${e}"]`);if(t&&!t.innerHTML.includes("*")){const e=document.createElement("span");e.className="required-indicator",e.textContent=" *",e.style.color="red",t.appendChild(e)}}})),document.querySelectorAll('label[for="incentiveAvailable"], label[for="incentiveNotAvailable"]').forEach((e=>{if(!e.innerHTML.includes("*")){const t=document.createElement("span");t.className="required-indicator",t.textContent=" *",t.style.color="red",e.appendChild(t)}}));const e=document.getElementById("incentive-update-form");if(e){const t=document.createElement("div");t.className="form-explanation",t.innerHTML="<p>Fields marked with an asterisk (*) are required.</p>",e.insertBefore(t,e.firstChild)}}()}));