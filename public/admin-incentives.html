<!DOCTYPE html>
<html lang="en">
<head>
    <title>Admin Dashboard - Incentives - Patriot Thanks</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="author" content="Edward G. McKeown">
    <meta name="date" content="2025/4/23">
    <meta name="description" content="Incentive Management for Patriot Thanks Admin Dashboard">
    <meta name="keywords" content="Incentive Management, Admin Dashboard, Patriot Thanks">
    <link href="./images/docbearlogov4.png" rel="icon" type="image/x-icon">
    <link href="./css/bootstrap-4.0.0.css" rel="stylesheet">
    <link href="./css/normalize.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">
    <link href="./css/forms.css" rel="stylesheet">
    <link href="./css/menu-auth.css" rel="stylesheet">
    <link href="./css/form-validation.css" rel="stylesheet">
    <link href="./css/dashboard.css" rel="stylesheet">
    <link href="./css/admin/admin-business.css" rel="stylesheet">
    <script src="./js/jquery-3.7.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <script src="./js/bootstrap-4.0.0.js"></script>
    <script src="./js/admin-incentives.js"></script>
</head>
<body style="padding-top: 70px" id="page_layout">
<!--Navigation bar-->
<div id="nav-placeholder">
</div>
<script>
    $(function(){
        $("#nav-placeholder").load("NavBar.html", function() {
            console.log("NavBar loaded");
            // Load the login handler after the navbar is loaded
            $.getScript("./js/login-handler.js")
                    .done(function() {
                        console.log("Login handler script loaded successfully");
                    })
                    .fail(function() {
                        console.error("Failed to load login-handler.js");
                    });
        });
    });
</script>

<header>
    <br>
    <div class="left-banner">
        <a href="./index.html">
            <img src="./images/docbearlogov4.png" alt="DocBear logo">
        </a>
    </div>
    <div class="right-banner">
        <h1>Patriot Thanks</h1>
        <hr>
        <h4>Admin Dashboard - Incentive Management</h4>
    </div>
    <div style="clear:left;"></div>
</header>

<main class="admin-container">
    <div class="admin-header">
        <h2>Incentive Management</h2>
        <div>
            <a href="admin-dashboard.html" class="btn btn-secondary mr-2">Return to Dashboard</a>
            <button class="btn btn-primary" id="add-incentive-btn" data-toggle="modal" data-target="#incentiveModal">Add New Incentive</button>
        </div>
    </div>

    <div class="filter-container">
        <input type="text" class="search-box" id="incentive-search" placeholder="Search incentives...">

        <div class="filter-item">
            <label for="business-filter">Business:</label>
            <select id="business-filter">
                <option value="">All Businesses</option>
                <!-- Business options will be populated dynamically -->
            </select>
        </div>

        <div class="filter-item">
            <label for="type-filter">Type:</label>
            <select id="type-filter">
                <option value="">All Types</option>
                <option value="VT">Veteran</option>
                <option value="AD">Active Duty</option>
                <option value="FR">First Responder</option>
                <option value="SP">Spouse</option>
                <option value="OT">Other</option>
            </select>
        </div>

        <div class="filter-item">
            <label for="availability-filter">Availability:</label>
            <select id="availability-filter">
                <option value="">All</option>
                <option value="true">Available</option>
                <option value="false">Not Available</option>
            </select>
        </div>

        <button id="reset-filters" class="btn btn-secondary">Reset Filters</button>
    </div>

    <div class="table-responsive">
        <table class="data-table">
            <thead>
            <tr>
                <th>Business</th>
                <th>Location</th>
                <th>Type</th>
                <th>Available</th>
                <th>Amount (%)</th>
                <th>Information</th>
                <th>Date Added</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="incentive-table-body">
            <!-- Incentive data will be populated here -->
            <tr>
                <td colspan="8" class="text-center">Loading incentives...</td>
            </tr>
            </tbody>
        </table>
    </div>

    <ul class="pagination" id="pagination-container">
        <!-- Pagination will be populated here -->
    </ul>

    <!-- Incentive Modal -->
    <div class="modal fade" id="incentiveModal" tabindex="-1" role="dialog" aria-labelledby="incentiveModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="incentiveModalLabel">Add/Edit Incentive</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="incentive-form" class="modal-form">
                        <input type="hidden" id="incentive-id" name="incentive-id">

                        <div class="form-group">
                            <label for="business-id">Business</label>
                            <select id="business-id" name="business-id" required>
                                <option value="">Select a Business</option>
                                <!-- Business options will be populated dynamically -->
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Incentive Availability</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="is_available" id="incentive-available" value="true">
                                <label class="form-check-label" for="incentive-available">
                                    Incentive Available
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="is_available" id="incentive-not-available" value="false">
                                <label class="form-check-label" for="incentive-not-available">
                                    Incentive NOT Available
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="type">Incentive Type</label>
                            <select id="type" name="type" required>
                                <option value="">Select an Incentive Type</option>
                                <option value="VT">Veteran</option>
                                <option value="AD">Active Duty</option>
                                <option value="FR">First Responder</option>
                                <option value="SP">Spouse</option>
                                <option value="OT">Other (please describe)</option>
                            </select>
                        </div>

                        <div class="form-group" id="other-type-container" style="display: none;">
                            <label for="other-description">Please Describe</label>
                            <input type="text" id="other-description" name="other-description" placeholder="Describe the incentive type...">
                        </div>

                        <div class="form-group">
                            <label for="amount">Incentive Amount as a %</label>
                            <input type="number" id="amount" name="amount" min="0" max="100" step="0.1">
                        </div>

                        <div class="form-group">
                            <label for="information">Incentive Information</label>
                            <textarea id="information" name="information" rows="4" cols="50" required placeholder="Please enter information about the discount/incentive."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-incentive-btn">Save Incentive</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">Confirm Action</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="confirmation-message">
                    Are you sure you want to delete this incentive?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-action-btn">Delete</button>
                </div>
            </div>
        </div>
    </div>
</main>

<footer class="footer_style"><br>
    <p>&copy; Copyright 2024 Edward G. McKeown</p>
    <address>
        <p>email to <a href='mailto:edward-mckeown@student.kirkwood.edu'>
            edward-mckeown@student.kirkwood.edu</a></p><br>
    </address>
</footer>

<style>
    /* Additional styles for the admin incentives page */
    .results-table {
        width: 100%;
        margin: 20px 0;
        border-collapse: collapse;
        text-align: left;
    }

    .results-table th, .results-table td {
        border: 1px solid #ddd;
        padding: 8px;
    }

    .results-table th {
        background-color: #f2f2f2;
        font-weight: bold;
        text-align: center;
    }

    .disabled-field {
        background-color: #f0f0f0;
        color: #888;
        cursor: not-allowed;
    }

    textarea.disabled-field {
        resize: none;
    }
</style>



<script>
    // Standard token validation approach
    function getAuthToken() {
        try {
            const sessionData = localStorage.getItem('patriotThanksSession');
            if (!sessionData) {
                console.error('No session data found');
                return null;
            }

            const session = JSON.parse(sessionData);
            if (!session.token) {
                console.error('No token found in session data');
                return null;
            }

            return session.token;
        } catch (error) {
            console.error('Error retrieving auth token:', error);
            return null;
        }
    }

    function showAccessDenied() {
        document.querySelector('.admin-container').innerHTML = `
            <div class="alert alert-danger" role="alert">
                <h4 class="alert-heading">Access Denied</h4>
                <p>You do not have permission to access this page. Only administrators can access the incentive management.</p>
                <hr>
                <p class="mb-0">Please <a href="/index.html">return to the homepage</a> or contact an administrator if you believe this is an error.</p>
            </div>
        `;
    }

    // Check for admin status on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkAdminStatus();
    });

    // Verify admin status
    async function checkAdminStatus() {
        try {
            // Get auth token
            const token = getAuthToken();
            if (!token) {
                console.error("No auth token found");
                window.location.href = '/index.html?login=required&redirect=' + encodeURIComponent(window.location.pathname);
                return false;
            }

            // Determine the base URL
            const baseURL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? `http://${window.location.host}`
                    : 'https://patriotthanks.vercel.app';

            try {
                // Try the verify-token endpoint
                const response = await fetch(`${baseURL}/api/auth.js?operation=verify-token`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/index.html?login=required&redirect=' + encodeURIComponent(window.location.pathname);
                        return false;
                    }

                    // For development - can be removed in production
                    const useDevMode = confirm('API error encountered. Would you like to bypass admin verification for development purposes?');
                    if (useDevMode) {
                        console.warn('DEVELOPMENT MODE: Bypassing admin verification');
                        return true;
                    }

                    showAccessDenied();
                    return false;
                }

                const data = await response.json();
                const isAdminUser = data.isAdmin === true || data.level === 'Admin';

                if (!isAdminUser) {
                    showAccessDenied();
                    return false;
                }

                return true;
            } catch (error) {
                console.error('Error checking admin status:', error);

                // For development - can be removed in production
                const useDevMode = confirm('API error encountered. Would you like to bypass admin verification for development purposes?');
                if (useDevMode) {
                    console.warn('DEVELOPMENT MODE: Bypassing admin verification');
                    return true;
                }

                showAccessDenied();
                return false;
            }
        } catch (error) {
            console.error('Error in admin status check:', error);
            showAccessDenied();
            return false;
        }
    }
</script>
</body>
</html>